"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[2324,7862],{81067:(e,t,n)=>{n.r(t),n.d(t,{default:()=>ze});const o=JSON.parse('{"UU":"@ohif/extension-cornerstone-dicom-seg"}').UU,a=`${o}.sopClassHandlerModule.dicom-seg`;var r=n(41766),i=n(55411),s=n(92136),l=n(39371),c=n(83342),m=n(31426);const d=["1.2.840.10008.5.1.4.1.1.66.4"];let p={};function g(e,t,n){const o=e[0],{StudyInstanceUID:r,SeriesInstanceUID:g,SOPInstanceUID:u,SeriesDescription:E,SeriesNumber:S,SeriesDate:f,SOPClassUID:v,wadoRoot:x,wadoUri:h,wadoUriRoot:I}=o,y={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:i.Wp.guid(),SeriesDescription:E,SeriesNumber:S,SeriesDate:f,SOPInstanceUID:u,SeriesInstanceUID:g,StudyInstanceUID:r,SOPClassHandlerId:a,SOPClassUID:v,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:d,instance:o,instances:[o],wadoRoot:x,wadoUriRoot:I,wadoUri:h,isOverlayDisplaySet:!0},w=o.ReferencedSeriesSequence;if(!w)return void console.error("ReferencedSeriesSequence is missing for the SEG");const N=w[0]||w;return y.referencedImages=o.ReferencedSeriesSequence.ReferencedInstanceSequence,y.referencedSeriesInstanceUID=N.SeriesInstanceUID,y.getReferenceDisplaySet=()=>{const{displaySetService:e}=t.services,n=e.getDisplaySetsForSeries(y.referencedSeriesInstanceUID);if(!n||0===n.length)throw new Error("Referenced DisplaySet is missing for the SEG");const o=n[0];y.referencedDisplaySetInstanceUID=o.displaySetInstanceUID,y.referencedVolumeURI=o.displaySetInstanceUID;const a=`cornerstoneStreamingImageVolume:${y.referencedVolumeURI}`;return y.referencedVolumeId=a,o},y.load=async({headers:e})=>await function(e,t,n,o){const{SOPInstanceUID:a}=e,{segmentationService:r}=t.services;if((e.loading||e.isLoaded)&&p[a]&&function(e,t){return t.getSegmentation(e.displaySetInstanceUID)}(e,r))return p[a];return e.loading=!0,p[a]=new Promise((async(a,i)=>{e.segments&&0!==Object.keys(e.segments).length||await async function({extensionManager:e,servicesManager:t,segDisplaySet:n,headers:o}){const a=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{segmentationService:r,uiNotificationService:i}=t.services,{dicomLoaderService:d}=a.exports,p=await d.findDicomDataPromise(n,null,o),g=s.cache.getVolume(n.referencedVolumeId);if(!g)throw new Error("Referenced Volume is missing for the SEG, and stack viewport SEG is not supported yet");const{imageIds:u}=g,E=.001,S=!0;s.eventTarget.addEventListener(c.fX.Events.SEGMENTATION_LOAD_PROGRESS,(e=>{const{percentComplete:t}=e.detail;r._broadcastEvent(r.EVENTS.SEGMENT_LOADING_COMPLETE,{percentComplete:t})}));const f=await c.ql.Cornerstone3D.Segmentation.generateToolState(u,p,s.metaData,{skipOverlapping:S,tolerance:E,eventTarget:s.eventTarget,triggerEvent:s.triggerEvent});let v=!0;f.segMetadata.data.forEach(((e,t)=>{var n;t>0&&(e.rgba=e.RecommendedDisplayCIELabValue,e.rgba?e.rgba=(n=e.rgba,m.Ay.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)))):(v=!1,e.rgba=l.CONSTANTS.COLOR_LUT[t%l.CONSTANTS.COLOR_LUT.length]))})),f.overlappingSegments&&i.show({title:"Overlapping Segments",message:"Unsupported overlapping segments detected, segmentation rendering results may be incorrect.",type:"warning"});v||i.show({title:"DICOM SEG import",message:"RecommendedDisplayCIELabValue not found for one or more segments. The default color was used instead.",type:"warning",duration:5e3});Object.assign(n,f)}({extensionManager:n,servicesManager:t,segDisplaySet:e,headers:o});const d=!0;r.createSegmentationForSEGDisplaySet(e,null,d).then((()=>{e.loading=!1,a()})).catch((t=>{e.loading=!1,i(t)}))})),p[a]}(y,t,n,e),[y]}const u=function({servicesManager:e,extensionManager:t}){return[{name:"dicom-seg",sopClassUids:d,getDisplaySetsFromSeries:n=>g(n,e,t)}]},E={id:"@ohif/seg",name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId"}]}]}]};const S=function(){return[{name:E.id,protocol:E}]};var f=n(15575),v=n(97490),x=n(84039),h=n(11374),I=n.n(h);let y=function(e){return e.Expanded="expanded",e.Dropdown="dropdown",e}({});const w=function(e,t,n){const o="enter-segment-label",a=({action:t,value:a})=>{switch(t.id){case"save":n(a.label,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:o})};e&&e.create({id:o,centralize:!0,isDraggable:!1,showOverlay:!0,content:v.lG,contentProps:{title:"Segment",value:{label:t},noCloseButton:!0,onClose:()=>e.dismiss({id:o}),actions:[{id:"cancel",text:"Cancel",type:v.Ny.NW.secondary},{id:"save",text:"Confirm",type:v.Ny.NW.primary}],onSubmit:a,body:({value:e,setValue:t})=>r.createElement(v.pd,{label:"Enter the segment label",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,className:"border-primary-main bg-black",type:"text",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&a({value:e,action:{id:"save"}})}})}})};var N=n(13726);const b=function(e,t,n){const o="pick-color",a=({action:t,value:a})=>{switch(t.id){case"save":n(a.rgbaColor,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:o})};e&&e.create({id:o,centralize:!0,isDraggable:!1,showOverlay:!0,content:v.lG,contentProps:{title:"Segment Color",value:{rgbaColor:t},noCloseButton:!0,onClose:()=>e.dismiss({id:o}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:a,body:({value:e,setValue:t})=>r.createElement(N.xk,{color:e.rgbaColor,onChange:e=>{t({rgbaColor:e.rgb})},presetColors:[],width:300})}})};var T=n(61466),C=n.n(T),D=n(1675),R=n(92309),V=n(64597);const A=({value1:e,value2:t,onChange:n,minValue:o,maxValue:a,step:i=1,unit:s="",containerClassName:l,inputClassName:c,labelClassName:m,labelVariant:d,showLabel:p=!0,labelPosition:g="",trackColor:u})=>{const[E,S]=(0,r.useState)(e),[f,x]=(0,r.useState)(t);(0,r.useEffect)((()=>{e<o||(S(e),t>a||x(t))}),[e,t]);const h=e=>{const t=Number(e.target.value);t<o||(S(t),n(t,f))},I=e=>{const t=Number(e.target.value);t>a||(x(t),n(E,t))},y=i>=1?E.toFixed(0):E.toFixed(1),w=i>=1?f.toFixed(0):f.toFixed(1);return r.createElement("div",{style:{flexDirection:"column"},className:`flex items-center cursor-pointer space-x-1 ${l||""}`},p&&"left"===g&&r.createElement(r.Fragment,null,r.createElement(V.A,{variant:d??"subtitle",component:"p",className:C()("w-8",m??"text-white")},y,s),r.createElement(V.A,{variant:d??"subtitle",component:"p",className:C()("w-8",m??"text-white")},w,s)),r.createElement("div",{style:{flexDirection:"row"},className:"flex pb-[5px]"},r.createElement("input",{type:"range",min:o,max:a,value:E,className:`appearance-none h-[3px] rounded-lg input-range-thumb-design ${c||""}`,style:{background:"#3a3f99"},onChange:h,id:"myRange1",step:i}),r.createElement("input",{type:"range",min:o,max:a,value:f,className:`appearance-none h-[3px] rounded-lg input-range-thumb-design ${c||""}`,style:{background:"#3a3f99"},onChange:I,id:"myRange2",step:i})),p&&(!g||"right"===g)&&r.createElement("div",{style:{flexDirection:"row",width:"100%"},className:"flex pb-[5px]"},r.createElement(V.A,{variant:d??"subtitle",component:"p",className:C()("w-1/2",m??"text-white","flex","justify-center")},"Min : ",y,s),r.createElement(V.A,{variant:d??"subtitle",component:"p",className:C()("w-1/2",m??"text-white","flex","justify-center")},"Max : ",w,s)),r.createElement("div",{className:"flex",style:{width:"100%"}},r.createElement("div",{className:"flex w-1/2 justify-center"},r.createElement(v.$n,{size:"small",color:"black",onClick:()=>{h({target:{value:E-10}})}},"--"),r.createElement(v.$n,{size:"small",color:"black",onClick:()=>{h({target:{value:E-1}})}},"-"),r.createElement(v.$n,{size:"small",color:"black",onClick:()=>{h({target:{value:E+1}})}},"+"),r.createElement(v.$n,{size:"small",color:"black",onClick:()=>{h({target:{value:E+10}})}},"++")),r.createElement("div",{className:"flex w-1/2 justify-center"},r.createElement(v.$n,{size:"small",color:"black",onClick:()=>{I({target:{value:f-10}})}},"--"),r.createElement(v.$n,{size:"small",color:"black",onClick:()=>{I({target:{value:f-1}})}},"-"),r.createElement(v.$n,{size:"small",color:"black",onClick:()=>{I({target:{value:f+1}})}},"+"),r.createElement(v.$n,{size:"small",color:"black",onClick:()=>{I({target:{value:f+10}})}},"++"))))};var M=n(80619);const{Enums:O}=l,{MouseBindings:k,Events:L}=O,_=({label:e,t,eraseFocus:n})=>{const o=e===n;return r.createElement("div",{className:C()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var F=function(e){return e.FILL_INSIDE_CIRCLE="FILL_INSIDE_CIRCLE",e.THRESHOLD_INSIDE_CIRCLE="THRESHOLD_INSIDE_CIRCLE",e.THRESHOLD_INSIDE_SPHERE="THRESHOLD_INSIDE_SPHERE",e.ERASE_INSIDE_CIRCLE="ERASE_INSIDE_CIRCLE",e.FILL_INSIDE_SPHERE="FILL_INSIDE_SPHERE",e.ERASE_INSIDE_SPHERE="ERASE_INSIDE_SPHERE",e}(F||{});const G=[];function P({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,M.Bd)("Buttons"),[o,a]=(0,r.useState)(!1),[i,c]=(0,r.useState)(!0),[m,d]=(0,r.useState)("All"),[p,g]=(0,r.useState)({active:!1,minimum:!0}),[{activeViewportId:u,viewports:E},S]=(0,v.ih)(),[f,x]=(0,r.useState)(F.FILL_INSIDE_CIRCLE),[h,I]=(0,r.useState)(25),[y,w]=(0,r.useState)([-1e3,5e3]),[N,b]=(0,r.useState)([]);(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(u).id,e.getCornerstoneViewport(u).renderingEngineId),o=n.getToolInstance("Brush");x(o.configuration.activeStrategy),I(o.configuration.brushSize),w(o.configuration.strategySpecificConfiguration.THRESHOLD.threshold);const a=t.getSegmentations().filter((e=>e.isActive))[0];b([{label:"All",segmentIndex:0},...a.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:n}=e;d(t),o.setConfiguration({eraseFocusIndex:n})}})))),n.setToolActive("Undo",{bindings:[{mouseButton:k.Primary}]})}),[]),(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(u).id,e.getCornerstoneViewport(u).renderingEngineId).getToolInstance("Brush"),o=t.EVENTS.SEGMENTATION_ADDED,a=t.EVENTS.SEGMENTATION_UPDATED,r=t.EVENTS.SEGMENTATION_REMOVED,i=[];return[o,a,r].forEach((e=>{t.subscribe(e,(()=>{const e=t.getSegmentations().filter((e=>e.isActive))[0];b([{label:"All",segmentIndex:0},...e.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;n.setConfiguration({eraseFocusIndex:o}),d(t)}}))))}))})),()=>{i.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(u).id,e.getCornerstoneViewport(u).renderingEngineId).getToolInstance("Brush"),o=t.EVENTS.SEGMENTATION_ADDED,a=t.EVENTS.SEGMENTATION_UPDATED,r=t.EVENTS.SEGMENTATION_REMOVED,i=[];return[o,a,r].forEach((e=>{t.subscribe(e,(()=>{const e=t.getSegmentations().filter((e=>e.isActive))[0];b([{label:"All",segmentIndex:0},...e.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;n.setConfiguration({eraseFocusIndex:o}),d(t)}}))))}))})),()=>{i.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(u).id,e.getCornerstoneViewport(u).renderingEngineId).getToolInstance("Brush").setConfiguration({brushSize:h,activeStrategy:f,strategySpecificConfiguration:{THRESHOLD:{threshold:y}}})}),[h,f,y]);return(0,r.useEffect)((()=>{const t=e.getCornerstoneViewport(u),n=l.ToolGroupManager.getToolGroupForViewport(t.id,t.renderingEngineId),o=t.element;o.addEvent=(e,t)=>{G[e]&&(o.removeEventListener(e,G[e]),G[e]=null),G[e]=t,o.addEventListener(e,t)},o.removeEvent=e=>{o.removeEventListener(e,G[e]),G[e]=null},p.active?(n.setToolPassive("Brush"),n.setToolActive("DragProbe",{bindings:[{mouseButton:k.Primary}]}),o.addEvent(L.MOUSE_DRAG,(t=>{((t,n)=>{if(1===t.detail.mouseButton){const o=e.getCornerstoneViewport(u),a=t.detail.currentPoints.world,r=o.getImageData(),i=r.imageData.worldToIndex(a).map(Math.round);i[0]=Math.round(i[0]),i[1]=Math.round(i[1]),i[2]=Math.round(i[2]);const{scalarData:l,dimensions:c}=r;if(s.utilities.indexWithinDimensions(i,c)){const e=c[0],t=c[0]*c[1],o=l[i[2]*t+i[1]*e+i[0]];w(n?[o,y[1]]:[y[0],o])}}})(t,p.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("Brush",{bindings:[{mouseButton:k.Primary}]}),o.removeEvent(L.MOUSE_DRAG))}),[p.active,p.minimum]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(D.A,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Paint Brush Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Filling mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.$n,{fullWidth:!0,size:"small",color:f===F.FILL_INSIDE_CIRCLE?"primary":"secondary",onClick:()=>{x(F.FILL_INSIDE_CIRCLE)}},"Circle"),r.createElement(v.$n,{fullWidth:!0,size:"small",color:f===F.THRESHOLD_INSIDE_CIRCLE?"primary":"secondary",onClick:()=>{x(F.THRESHOLD_INSIDE_CIRCLE)}},"Circle Threshold")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.$n,{fullWidth:!0,size:"small",color:f===F.FILL_INSIDE_SPHERE?"primary":"secondary",onClick:()=>{x(F.FILL_INSIDE_SPHERE)}},"Sphere"),r.createElement(v.$n,{fullWidth:!0,size:"small",color:f===F.THRESHOLD_INSIDE_SPHERE?"primary":"secondary",onClick:()=>{x(F.THRESHOLD_INSIDE_SPHERE)}},"Sphere Threshold")),r.createElement("div",{className:"h-[1px] bg-[#212456] mb-[8px] mx-1"}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Erase mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.$n,{fullWidth:!0,size:"small",color:f===F.ERASE_INSIDE_CIRCLE?"primary":"secondary",onClick:()=>{x(F.ERASE_INSIDE_CIRCLE)}},"Circle"),r.createElement(v.$n,{fullWidth:!0,size:"small",color:f===F.ERASE_INSIDE_SPHERE?"primary":"secondary",onClick:()=>{x(F.ERASE_INSIDE_SPHERE)}},"Sphere")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),c(!i)}},r.createElement(D.A,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!i})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!i&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on :"),r.createElement(v.r_,{items:N,renderer:e=>_({...e,t:n,eraseFocus:m})})))),r.createElement("div",{className:"h-[1px] bg-[#212456] mb-[8px] mx-1 mt-[8px]"}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Attributes"),r.createElement("div",{className:"flex items-center col-span-2"},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]"},"Radius"),r.createElement(R.A,{minValue:0,maxValue:100,value:h,onChange:e=>{I(e)},step:1,containerClassName:"mt-[4px] mb-[4px]",inputClassName:"w-[64px]",labelClassName:"text-white text-[12px]",unit:"px"})),(f===F.THRESHOLD_INSIDE_CIRCLE||f===F.THRESHOLD_INSIDE_SPHERE)&&r.createElement("div",{className:"flex items-center col-span-2",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Threshold values"),r.createElement(A,{minValue:-1e3,maxValue:5e3,value1:y[0],value2:y[1],onChange:(e,t)=>{w([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:"HU"}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{g({active:!0,minimum:!0})}},"Minimum"),r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{g({active:!0,minimum:!1})}},"Maximum")),p.active&&r.createElement(v.$n,{size:"small",color:"secondary",onClick:()=>{g({active:!1,minimum:!0})}},"Back to annotation"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const U=({label:e,t,eraseFocus:n})=>{const o=e===n;return r.createElement("div",{className:C()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var B=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(B||{});function H({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,M.Bd)("Buttons"),[o,a]=(0,r.useState)(!1),[i,s]=(0,r.useState)(B.FILL_INSIDE),[{activeViewportId:c,viewports:m},d]=(0,v.ih)(),[p,g]=(0,r.useState)([]),[u,E]=(0,r.useState)(!0),[S,f]=(0,r.useState)("All");return(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("CircleScissor"),o=t.EVENTS.SEGMENTATION_ADDED,a=t.EVENTS.SEGMENTATION_UPDATED,r=t.EVENTS.SEGMENTATION_REMOVED,i=[];return[o,a,r].forEach((e=>{t.subscribe(e,(()=>{const e=t.getSegmentations().filter((e=>e.isActive))[0];g([{label:"All",segmentIndex:0},...e.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;n.setConfiguration({eraseFocusIndex:o}),f(t)}}))))}))})),()=>{i.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("CircleScissor");s(n.configuration.activeStrategy);const o=t.getSegmentations().filter((e=>e.isActive))[0];g([{label:"All",segmentIndex:0},...o.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;f(t),n.setConfiguration({eraseFocusIndex:o})}}))))}),[]),(0,r.useEffect)((()=>{l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("CircleScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(D.A,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Circle Segmentation Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.$n,{fullWidth:!0,size:"small",color:i===B.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(B.FILL_INSIDE)}},"Fill"),r.createElement(v.$n,{fullWidth:!0,size:"small",color:i===B.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(B.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),E(!u)}},r.createElement(D.A,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!u})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!u&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on :"),r.createElement(v.r_,{items:p,renderer:e=>U({...e,t:n,eraseFocus:S})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}function $({}){const[e,t]=(0,r.useState)(!1);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>t(!e)},r.createElement(D.A,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!e})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Fill Holes Tool Edit")),!e&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"No configurations for this tool")),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:z}=l,{MouseBindings:W,Events:j}=z,q=[];function J({segmentationService:e,cornerstoneViewportService:t,commandsManager:n}){const[o,a]=(0,r.useState)(!1),[{activeViewportId:i,viewports:c},m]=(0,v.ih)(),[d,p]=(0,r.useState)([-1e3,5e3]),[g,u]=(0,r.useState)(0),[E,S]=(0,r.useState)({active:!1,minimum:!0});(0,r.useEffect)((()=>{const e=l.ToolGroupManager.getToolGroupForViewport(t.getCornerstoneViewport(i).id,t.getCornerstoneViewport(i).renderingEngineId).getToolInstance("RectangleROIStartEndThreshold");u(e.configuration.numSlicesToPropagate)}),[]),(0,r.useEffect)((()=>{l.ToolGroupManager.getToolGroupForViewport(t.getCornerstoneViewport(i).id,t.getCornerstoneViewport(i).renderingEngineId).getToolInstance("RectangleROIStartEndThreshold").setConfiguration({numSlicesToPropagate:g}),console.log("SET CONFIGURATION",g)}),[g]);(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(i),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId),o=e.element;o.addEvent=(e,t)=>{q[e]&&(o.removeEventListener(e,q[e]),q[e]=null),q[e]=t,o.addEventListener(e,t)},o.removeEvent=e=>{o.removeEventListener(e,q[e]),q[e]=null},E.active?(n.setToolPassive("RectangleROIStartEndThreshold"),n.setToolActive("DragProbe",{bindings:[{mouseButton:W.Primary}]}),o.addEvent(j.MOUSE_DRAG,(e=>{((e,n)=>{if(1===e.detail.mouseButton){const o=t.getCornerstoneViewport(i),a=e.detail.currentPoints.world,r=o.getImageData(),l=r.imageData.worldToIndex(a).map(Math.round);l[0]=Math.round(l[0]),l[1]=Math.round(l[1]),l[2]=Math.round(l[2]);const{scalarData:c,dimensions:m}=r;if(s.utilities.indexWithinDimensions(l,m)){const e=m[0],t=m[0]*m[1],o=c[l[2]*t+l[1]*e+l[0]];p(n?[o,d[1]]:[d[0],o])}}})(e,E.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("RectangleROIStartEndThreshold",{bindings:[{mouseButton:W.Primary}]}),o.removeEvent(j.MOUSE_DRAG))}),[E.active,E.minimum]);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(D.A,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"3D Rectangle Threshold Segmentation Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"flex items-center col-span-2",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Threshold values"),r.createElement(A,{minValue:-1e3,maxValue:5e3,value1:d[0],value2:d[1],onChange:(e,t)=>{p([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:""}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{S({active:!0,minimum:!0})}},"Minimum"),r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{S({active:!0,minimum:!1})}},"Maximum")),E.active&&r.createElement(v.$n,{size:"small",color:"secondary",onClick:()=>{S({active:!1,minimum:!0})}},"Back to annotation")),r.createElement("div",{className:"flex items-center col-span-2",style:{width:"100%",flexDirection:"column"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Slices Propagation"),r.createElement(R.A,{minValue:0,maxValue:200,value:g,onChange:e=>{u(e)},step:1,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:""})),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const n=t.getCornerstoneViewport(i).getActors().map((e=>{const t=e.referenceId??e.uid;return s.cache.getVolume(t)})).filter((e=>!!e)),o=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIStartEndThreshold");if(!o)throw new Error("No annotation selected ");const a=o[0];if(!l.annotation.state.getAnnotation(a))return;const r=n.filter((e=>e.imageIds.length))[0],c=n.filter((e=>!e.imageIds.length))[0],m=e.getSegmentations();l.utilities.segmentation.rectangleROIThresholdVolumeByRange(o,c,[{volume:r,lower:d[0],upper:d[1]}],{numSlicesToProject:0,overwrite:!1,overlapType:1,segmentIndex:m[0].activeSegmentIndex})})()}},"Compute Threshold")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const e=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIStartEndThreshold");if(!e)throw new Error("No annotation selected ");console.log("selected annotation uid",e);const n=e[0];console.log("CSTOOLS STATE",l.annotation.state),l.annotation.state.removeAnnotation(n),t.getCornerstoneViewport(i).render()})()}},"Delete selected region"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:Q}=l,{MouseBindings:K,Events:X}=Q,Y=[];function Z({segmentationService:e,cornerstoneViewportService:t,commandsManager:n}){const[o,a]=(0,r.useState)(!1),[{activeViewportId:i,viewports:c},m]=(0,v.ih)(),[d,p]=(0,r.useState)([-1e3,5e3]),[g,u]=(0,r.useState)({active:!1,minimum:!0});(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(i),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId),o=e.element;o.addEvent=(e,t)=>{Y[e]&&(o.removeEventListener(e,Y[e]),Y[e]=null),Y[e]=t,o.addEventListener(e,t)},o.removeEvent=e=>{o.removeEventListener(e,Y[e]),Y[e]=null},g.active?(n.setToolPassive("RectangleROIThreshold"),n.setToolActive("DragProbe",{bindings:[{mouseButton:K.Primary}]}),o.addEvent(X.MOUSE_DRAG,(e=>{((e,n)=>{if(1===e.detail.mouseButton){const o=t.getCornerstoneViewport(i),a=e.detail.currentPoints.world,r=o.getImageData(),l=r.imageData.worldToIndex(a).map(Math.round);l[0]=Math.round(l[0]),l[1]=Math.round(l[1]),l[2]=Math.round(l[2]);const{scalarData:c,dimensions:m}=r;if(s.utilities.indexWithinDimensions(l,m)){const e=m[0],t=m[0]*m[1],o=c[l[2]*t+l[1]*e+l[0]];p(n?[o,d[1]]:[d[0],o])}}})(e,g.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("RectangleROIThreshold",{bindings:[{mouseButton:K.Primary}]}),o.removeEvent(X.MOUSE_DRAG))}),[g.active,g.minimum]);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(D.A,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Rectangle Threshold Segmentation Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"flex items-center col-span-2 pb-[9px]",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pb-[3px]",style:{width:"100%"}},"Threshold values"),r.createElement(A,{minValue:-1e3,maxValue:5e3,value1:d[0],value2:d[1],onChange:(e,t)=>{p([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full pb-[3px]",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:"HU"}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{u({active:!0,minimum:!0})}},"Minimum"),r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{u({active:!0,minimum:!1})}},"Maximum")),g.active&&r.createElement(v.$n,{size:"small",color:"secondary",onClick:()=>{u({active:!1,minimum:!0})}},"Back to annotation")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const n=t.getCornerstoneViewport(i).getActors().map((e=>{const t=e.referenceId??e.uid;return s.cache.getVolume(t)})).filter((e=>!!e)),o=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIThreshold");if(!o)throw new Error("No annotation selected ");const a=o[0];if(!l.annotation.state.getAnnotation(a))return;const r=n.filter((e=>e.imageIds.length))[0],c=n.filter((e=>!e.imageIds.length))[0],m=e.getSegmentations();console.log("SEGMENTATION",m),l.utilities.segmentation.rectangleROIThresholdVolumeByRange(o,c,[{volume:r,lower:d[0],upper:d[1]}],{numSlicesToProject:0,overwrite:!1,overlapType:1,segmentIndex:m[0].activeSegmentIndex})})()}},"Compute Threshold")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const e=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIThreshold");if(!e)throw new Error("No annotation selected ");console.log("selected annotation uid",e);const n=e[0];console.log("CSTOOLS STATE",l.annotation.state),l.annotation.state.removeAnnotation(n),t.getCornerstoneViewport(i).render()})()}},"Delete selected region"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const ee=({label:e,t,eraseFocus:n})=>{const o=e===n;return r.createElement("div",{className:C()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var te=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(te||{});function ne({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,M.Bd)("Buttons"),[o,a]=(0,r.useState)(!1),[i,s]=(0,r.useState)(te.FILL_INSIDE),[{activeViewportId:c,viewports:m},d]=(0,v.ih)(),[p,g]=(0,r.useState)([]),[u,E]=(0,r.useState)(!0),[S,f]=(0,r.useState)("All");return(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("RectangleScissor"),o=t.EVENTS.SEGMENTATION_ADDED,a=t.EVENTS.SEGMENTATION_UPDATED,r=t.EVENTS.SEGMENTATION_REMOVED,i=[];return[o,a,r].forEach((e=>{t.subscribe(e,(()=>{const e=t.getSegmentations().filter((e=>e.isActive))[0];g([{label:"All",segmentIndex:0},...e.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;n.setConfiguration({eraseFocusIndex:o}),f(t)}}))))}))})),()=>{i.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("RectangleScissor");s(n.configuration.activeStrategy);const o=t.getSegmentations().filter((e=>e.isActive))[0];g([{label:"All",segmentIndex:0},...o.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;f(t),n.setConfiguration({eraseFocusIndex:o})}}))))}),[]),(0,r.useEffect)((()=>{l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("RectangleScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(D.A,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Rectangle Scissors Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.$n,{fullWidth:!0,size:"small",color:i===te.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(te.FILL_INSIDE)}},"Fill"),r.createElement(v.$n,{fullWidth:!0,size:"small",color:i===te.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(te.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),E(!u)}},r.createElement(D.A,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!u})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!u&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on :"),r.createElement(v.r_,{items:p,renderer:e=>ee({...e,t:n,eraseFocus:S})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}const oe=({label:e,t,eraseFocus:n})=>{const o=e===n;return r.createElement("div",{className:C()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var ae=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(ae||{});function re({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,M.Bd)("Buttons"),[o,a]=(0,r.useState)(!1),[i,s]=(0,r.useState)(ae.FILL_INSIDE),[{activeViewportId:c,viewports:m},d]=(0,v.ih)(),[p,g]=(0,r.useState)([]),[u,E]=(0,r.useState)(!0),[S,f]=(0,r.useState)("All");return(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("RectangleScissor"),o=t.EVENTS.SEGMENTATION_ADDED,a=t.EVENTS.SEGMENTATION_UPDATED,r=t.EVENTS.SEGMENTATION_REMOVED,i=[];return[o,a,r].forEach((e=>{t.subscribe(e,(()=>{const e=t.getSegmentations().filter((e=>e.isActive))[0];g([{label:"All",segmentIndex:0},...e.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;n.setConfiguration({eraseFocusIndex:o}),f(t)}}))))}))})),()=>{i.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("SphereScissor");s(n.configuration.activeStrategy);const o=t.getSegmentations().filter((e=>e.isActive))[0];g([{label:"All",segmentIndex:0},...o.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;f(t),n.setConfiguration({eraseFocusIndex:o})}}))))}),[]),(0,r.useEffect)((()=>{l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("SphereScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(D.A,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Sphere Scissors Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.$n,{fullWidth:!0,size:"small",color:i===ae.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(ae.FILL_INSIDE)}},"Fill"),r.createElement(v.$n,{fullWidth:!0,size:"small",color:i===ae.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(ae.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),E(!u)}},r.createElement(D.A,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!u})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!u&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on :"),r.createElement(v.r_,{items:p,renderer:e=>oe({...e,t:n,eraseFocus:S})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:ie}=l,{Events:se}=ie;const le=10,ce=new class extends Array{constructor(e){super(),this.maxLength=void 0,this.maxLength=e}push(...e){const t=super.push(...e);if(this.length>this.maxLength){const e=this.length-this.maxLength;this.splice(0,e)}return t}}(le);function me({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,M.Bd)("Buttons"),[o,a]=(0,r.useState)(!1),[{activeViewportId:i,viewports:s},l]=(0,v.ih)(),[c,m]=(0,r.useState)(ce.length);(0,r.useEffect)((()=>{e.getCornerstoneViewport(i).element.addEventListener(se.MOUSE_DOWN,(e=>{const n=t.getSegmentations()[0],o=new Uint8ClampedArray(t.getLabelmapVolume(n.id).getScalarData());ce.push(o),m(ce.length)}))}),[]);const d=t=>{const n=e.getCornerstoneViewport(i).element,o=ce[t];if(!o)return;const a=new CustomEvent("UNDO_REDO_TOOL",{detail:{element:n,oldScalarData:o}});window.dispatchEvent(a),m(t)};return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),a(!o)}},r.createElement(D.A,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Undo / Redo Segmentation")),!o&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{0!==c&&d(c-1)}},"Undo"),r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{c!==le&&d(c+1)}},"Redo"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:de}=l,{Events:pe}=de,{state:ge}=l,ue=["Brush","CircleScissor","PaintFill","RectangleROIStartEndThreshold","RectangleROIThreshold","RectangleScissor","SphereScissor"];function Ee({segmentationService:e,toolbarService:t,toolGroupService:n,cornerstoneViewportService:o,commandsManager:a}){const[{activeViewportId:i,viewports:s},l]=(0,v.ih)(),[c,m]=(0,r.useState)(null),d=()=>{const e=n.getToolGroupForViewport(i).toolOptions,t=Object.keys(e).map((function(t){return[t,e[t]]}));let o=!1;t.forEach((e=>{if(ue.includes(e[0])&&"Active"===e[1].mode)return o=!0,void m(e[0])})),o||m(null)};(0,r.useEffect)((()=>{d()}),[]),(0,r.useEffect)((()=>{const{unsubscribe:e}=t.subscribe(t.EVENTS.TOOL_BAR_MODIFIED,d);return()=>{e()}}),[t]);return r.createElement("div",null,c&&r.createElement(me,{cornerstoneViewportService:o,segmentationService:e}),(()=>{switch(c){case"Brush":return r.createElement(P,{cornerstoneViewportService:o,segmentationService:e});case"CircleScissor":return r.createElement(H,{cornerstoneViewportService:o,segmentationService:e});case"PaintFill":return r.createElement($,null);case"RectangleROIStartEndThreshold":return r.createElement(J,{segmentationService:e,cornerstoneViewportService:o,commandsManager:a});case"RectangleROIThreshold":return r.createElement(Z,{segmentationService:e,cornerstoneViewportService:o,commandsManager:a});case"RectangleScissor":return r.createElement(ne,{cornerstoneViewportService:o,segmentationService:e});case"SphereScissor":return r.createElement(re,{cornerstoneViewportService:o,segmentationService:e});default:return null}})())}var Se=n(59435);function fe({segmentationService:e,segmentations:t}){const[n,o]=(0,r.useState)(!1),[{activeViewportId:a,viewports:i},s]=(0,v.ih)();return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),o(!n)}},r.createElement(v.In,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!n})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Segments Configuration I/O")),!n&&r.createElement("div",{className:"pl-2 pb-[9px] pt-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly flex"},r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{console.log("SEGS AT IMPORT",t);const n=document.createElement("input");n.type="file",n.accept="application/json",n.onchange=o=>{const r=Array.from(n.files)[0],s=new FileReader;s.onload=function(n){try{if("string"==typeof n.target.result){for(let n=1;n<t[0].segments.length;n++)e.removeSegment(t[0].id,n);JSON.parse(n.target.result).forEach((n=>{if(n){const{segmentIndex:o}=n;e.addSegment(t[0].id,o,i.get(a).viewportOptions.toolGroupId,n,!0)}}))}else console.error("ERROR::JSON_READING::CORRUPTED_CONTENT")}catch(e){console.error("ERROR::JSON_READING",e)}},s.readAsText(r)},n.click()}},"Import File"),r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{const e=JSON.stringify(t[0].segments),n=new Blob([e],{type:"text/plain;charset=utf-8"});(0,Se.saveAs)(n,"segments_configuration.json")}},"Export File"))),r.createElement("div",{className:"h-[6px] bg-black "})))}fe.propTypes={segmentations:I().array.isRequired};const ve=fe;var xe=n(87424),he=n.n(xe),Ie=n(67927);function ye({segmentationService:e,segmentations:t,cornerstoneViewportService:n}){const[o,a]=(0,r.useState)(!1),[i,c]=(0,r.useState)(0),[m,d]=(0,r.useState)(!1),[{activeViewportIndex:p,viewports:g},u]=(0,v.ih)();(0,r.useEffect)((()=>{o&&(c(0),setTimeout(E,500))}),[o]);const E=()=>{const n=e.getLabelmapVolume(t[0].id),{dimensions:o,direction:r,scalarData:i}=n,s=t[0].segments,l=s.map(((e,t)=>{if(e)return t})).filter((e=>e)),m=new Uint32Array(i);console.log("START COMPUTING INDEX ARRAY...");const d=new Array(o[2]-1);for(let e=0;e<m.length;e+=o[0]*o[1]){const t=e/(o[0]*o[1]),n=new Uint8ClampedArray(o[0]*o[1]*4).fill(0).map(((e,t)=>(t-3)%4==0?255:e)),a=m.slice(e,e+o[0]*o[1]);Promise.allSettled(l.map((e=>(e=>a.map(((t,n)=>{if(0!==t&&t===e)return n})).filter((e=>0!==e)))(e)))).then((e=>{e.forEach(((e,t)=>{const o=e.value;if(0!==o.length){const e=l[t],a=[...s[e].color,255];o.forEach((e=>{n[4*e]=a[0],n[4*e+1]=a[1],n[4*e+2]=a[2]}))}}));new Promise(((e,a)=>{const r=document.createElement("canvas"),i=r.getContext("2d");r.width=o[0],r.height=o[1];const s=new ImageData(n,o[0],o[1]);i.putImageData(s,0,0),r.toBlob((n=>{n&&(d[t]=n,e())}),"image/png")})).then((()=>{const e=d.filter((e=>e)).length;c(~~(100*e/o[2]))}))}))}new Promise(((e,t)=>{!function t(){if(d.filter((e=>e)).length===o[2])return e();setTimeout(t,500)}()})).then((()=>{const n=new(he());d.forEach(((e,t)=>{n.file(`layer_${t}.png`,e)}));const o=JSON.stringify(t[0].segments,null,"\t"),r=new Blob([o],{type:"text/plain;charset=utf-8"});n.file("segmentation_informations.json",r);const i=e.getLabelmapVolume(t[0].id),s=new Uint8Array(i.scalarData),l=new Blob([s],{type:"application/octet-stream"});n.file("scalarData.bin",l),n.generateAsync({type:"blob"}).then((e=>{(0,Se.saveAs)(e,"segmentation.zip"),a(!1)}))}))};return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),d(!m)}},r.createElement(v.In,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!m})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Segmentations I/O")),!m&&r.createElement("div",{className:"pl-2 pb-[9px] pt-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly flex"},r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:async()=>{console.log("SEGS AT IMPORT",t);let e=g[p];"volume"!==e.viewportOptions.viewportType&&(e=g.find((e=>"volume"===e.viewportOptions.viewportType)),console.assert(e,'ImportSegmentation: Could not find "volume" viewport'),u.setActiveViewportIndex(e.viewportIndex));const o=n.getCornerstoneViewport(e.id).getActors();console.assert(o&&o.length,"ImportSegmentation: No actors on volume viewport");const a=o.map((e=>{const t=e.referenceId??e.uid;return s.cache.getVolume(t)})).filter((e=>!e.imageIds))[0],r=a.volumeId,i=a.getScalarData(),c=document.createElement("input");c.type="file",c.accept="application/octet-stream",c.onchange=async e=>{const t=Array.from(c.files)[0],n=new FileReader;n.onload=async function(e){const t=new Uint8Array(e.target.result);for(let e=0;e<i.length;e++)i[e]=t[e];l.segmentation.triggerSegmentationEvents.triggerSegmentationDataModified(r)},n.readAsArrayBuffer(t)},c.click()}},"Import Segmentation"),r.createElement(v.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{a(!0)}},"Export Segmentation")),o&&r.createElement("div",{className:"w-full mt-[9px]"},r.createElement("p",{style:{color:"white"}},"Processing layers..."),r.createElement(Ie.A,{className:"w-full mt-[3px]",bgColor:i<100?"#5ACCE6":"#50C878",completed:i,transitionDuration:"0.05s",transitionTimingFunction:"linear"}))),r.createElement("div",{className:"h-[6px] bg-black "})))}ye.propTypes={segmentations:I().array.isRequired};const we=ye,Ne=l.Enums.SegmentationRepresentations.Labelmap,be={[y.Expanded]:v.fO,[y.Dropdown]:v.QQ};function Te({servicesManager:e,commandsManager:t,extensionManager:n,configuration:o}){const[{activeViewportId:a,viewports:i}]=(0,v.ih)(),{segmentationService:s,viewportGridService:l,uiDialogService:c,displaySetService:m,cornerstoneViewportService:d,toolGroupService:p,toolbarService:g,uiNotificationService:u}=e.services,{t:E}=(0,M.Bd)("PanelSegmentation"),[S,f]=(0,r.useState)(null),[h,I]=(0,r.useState)(""),[y,N]=(0,r.useState)(s.getConfiguration()),[T,C]=(0,r.useState)((()=>s.getSegmentations()));(0,r.useEffect)((()=>{const e=s.EVENTS.SEGMENTATION_ADDED,t=s.EVENTS.SEGMENTATION_UPDATED,n=s.EVENTS.SEGMENTATION_REMOVED,o=[];return[e,t,n].forEach((e=>{const{unsubscribe:t}=s.subscribe(e,(()=>{const e=s.getSegmentations();C(e),N(s.getConfiguration())}));o.push(t)})),()=>{o.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const e=e=>{const t=l.getDisplaySetsUIDsForViewport(e||l.getActiveViewportId());if(!t)return;const n=t?.some((e=>{const t=m.getDisplaySetByUID(e);return t?.isReconstructable}))||!1;I(n?"":"ohif-disabled")};e();const t=l.EVENTS.ACTIVE_VIEWPORT_ID_CHANGED,n=l.EVENTS.VIEWPORTS_READY,o=[];[n,t].forEach((t=>{const{unsubscribe:n}=l.subscribe(t,(({viewportId:t})=>{e(t)}));o.push(n)}));const a=d.EVENTS.VIEWPORT_DATA_CHANGED,r=[];return[a].forEach((t=>{const{unsubscribe:n}=d.subscribe(t,(()=>{e()}));r.push(n)})),()=>{o.forEach((e=>e())),r.forEach((e=>e()))}}),[]);const D=e=>s.getToolGroupIdsWithSegmentation(e),R=(0,r.useCallback)(((e,t,n)=>{s.setConfiguration({segmentationId:e,[t]:n})}),[s]),V=be[o?.segmentationPanelMode]||v.QQ,A=o?.addSegment,O=o?.onSegmentationAdd&&"function"==typeof o?.onSegmentationAdd?o?.onSegmentationAdd:async()=>{t.runCommand("createEmptySegmentationForViewport",{viewportId:l.getActiveViewportId()})},k=()=>{const e=i.get(a)?.displaySetInstanceUIDs[0];return T.filter((t=>t.displaySetInstanceUID===e)).length>0};return r.createElement("div",{className:"flex flex-col flex-auto min-h-0F mt-1"},r.createElement(Ee,{segmentationService:s,cornerstoneViewportService:d,toolGroupService:p,toolbarService:g,commandsManager:t}),k()&&r.createElement(ve,{segmentationService:s,segmentations:T}),r.createElement(V,{title:E("Segmentations"),segmentations:T,disableEditing:o.disableEditing,activeSegmentationId:S||"",onSegmentationAdd:O,addSegmentationClassName:h,showAddSegment:A,onSegmentationClick:e=>{s.setActiveSegmentationForToolGroup(e)},onSegmentationDelete:e=>{s.remove(e)},onSegmentationDownload:e=>{t.runCommand("downloadSegmentation",{segmentationId:e})},onSegmentationDownloadRTSS:e=>{t.runCommand("downloadRTSS",{segmentationId:e})},storeSegmentation:async o=>{const a=n.getActiveDataSource(),r=await(0,x.createReportAsync)({servicesManager:e,getReport:()=>t.runCommand("storeSegmentation",{segmentationId:o,dataSource:a[0]}),reportType:"Segmentation"});r&&(s.remove(o),l.setDisplaySetsForViewport({viewportId:l.getActiveViewportId(),displaySetInstanceUIDs:r}))},onSegmentationEdit:e=>{const t=s.getSegmentation(e),{label:n}=t;w(c,n,((t,n)=>{""!==t&&s.addOrUpdateSegmentation({id:e,label:t},!1,!0)}))},onSegmentClick:(e,t)=>{s.setActiveSegment(e,t);D(e).forEach((n=>{s.setActiveSegmentationForToolGroup(e,n),s.jumpToSegmentCenter(e,t,n)}))},onSegmentEdit:(e,t)=>{const n=s.getSegmentation(e).segments[t],{label:o}=n;w(c,o,((n,o)=>{""!==n&&s.setSegmentLabel(e,t,n)}))},onSegmentAdd:e=>{const t=s.getSegmentation(e);s.addSegment(e,{segmentIndex:t.segments.length,toolGroupId:i.get(a).viewportOptions.toolGroupId,properties:{label:`Segment ${t.segmentCount+1}`,color:[Math.floor(256*Math.random()),Math.floor(256*Math.random()),Math.floor(256*Math.random())],opacity:255,visibility:!0,isLocked:!1,active:!0}})},onSegmentColorClick:(e,t)=>{const n=s.getSegmentation(e).segments[t],{color:o,opacity:a}=n,r={r:o[0],g:o[1],b:o[2],a:a/255};b(c,r,((n,o)=>{"cancel"!==o&&s.setSegmentRGBAColor(e,t,[n.r,n.g,n.b,255*n.a])}))},onSegmentDelete:(e,t)=>{s.removeSegment(e,t)},onToggleSegmentVisibility:(e,t)=>{const n=!s.getSegmentation(e).segments[t].isVisible;D(e).forEach((o=>{s.setSegmentVisibility(e,t,n,o)}))},onToggleSegmentLock:(e,t)=>{s.toggleSegmentLocked(e,t)},onToggleSegmentationVisibility:e=>{s.toggleSegmentationVisibility(e);const t=s.getSegmentation(e),n=t.isVisible,o=t.segments;D(e).forEach((t=>{o.forEach(((o,a)=>{s.setSegmentVisibility(e,a,n,t)}))}))},showDeleteSegment:!0,segmentationConfig:{initialConfig:y},setRenderOutline:e=>R(S,"renderOutline",e),setOutlineOpacityActive:e=>R(S,"outlineOpacity",e),setRenderFill:e=>R(S,"renderFill",e),setRenderInactiveSegmentations:e=>R(S,"renderInactiveSegmentations",e),setOutlineWidthActive:e=>R(S,"outlineWidthActive",e),setFillAlpha:e=>R(S,"fillAlpha",e),setFillAlphaInactive:e=>R(S,"fillAlphaInactive",e)}),k?r.createElement(we,{segmentationService:s,segmentations:T,cornerstoneViewportService:d}):r.createElement(v.$n,{className:"pt-1/10 pb-1/10",onClick:()=>{i.forEach((e=>{if(e.viewportId===a){if("volume3d"===e.viewportOptions.viewportType)return void u.show({title:"Create Segmentation",message:"Can't create segmentation in viewport 3D, select a 2D viewport",type:"error"});console.log("SEG VP",e),s.createSegmentationForDisplaySet(e.displaySetInstanceUIDs[0],{label:`Segmentation ${T.length+1}`}).then((t=>{const n=s.getSegmentation(t);console.log("CREATED SEGMENTATION",n),s.addSegmentationRepresentationToToolGroup(e.viewportOptions.toolGroupId,t,!0,Ne).then((()=>{s.setActiveSegmentationForToolGroup(t,e.viewportOptions.toolGroupId),s.addSegment(t,1,e.viewportOptions.toolGroupId,{label:"Segmentation 1",color:[255,0,0],opacity:255,visibility:!0,isLocked:!1,active:!0}),console.log("MTOOLS",g.getButtonSection("MeasurementTools",{})),g.createButtonSection("primary",["MeasurementTools","Zoom","WindowLevel","Pan","Capture","Crosshairs","MoreTools","SegmentationTools"])}))}))}}))},style:{marginTop:"10%"}},"Create Segmentation For Selected Viewport"))}Te.propTypes={commandsManager:I().shape({runCommand:I().func.isRequired}),servicesManager:I().shape({services:I().shape({segmentationService:I().shape({getSegmentation:I().func.isRequired,getSegmentations:I().func.isRequired,toggleSegmentationVisibility:I().func.isRequired,subscribe:I().func.isRequired,EVENTS:I().object.isRequired}).isRequired}).isRequired}).isRequired};const Ce=({commandsManager:e,servicesManager:t,extensionManager:n,configuration:o,title:a})=>{const{customizationService:i}=t.services;return[{name:"panelSegmentation",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:o=>{const[a]=(0,f.r)();return r.createElement(Te,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...o,disableEditing:a.disableEditing,...i.get("segmentation.panel")}})}},{name:"panelSegmentationWithTools",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:o=>{const[a]=(0,f.r)();return r.createElement(r.Fragment,null,r.createElement(v.OO,{commandsManager:e,servicesManager:t,extensionManager:n,buttonSectionId:"segmentationToolbox",title:"Segmentation Tools",configuration:{...o}}),r.createElement(Te,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...o,disableEditing:a.disableEditing,...i.get("segmentation.panel")}}))}}]};var De=n(52754),Re=n(45128),Ve=n(51250);async function Ae({viewportId:e,loadFn:t,servicesManager:n,referencedDisplaySetInstanceUID:o}){const{cornerstoneViewportService:a,segmentationService:r,viewportGridService:i}=n.services,l=Me({viewportId:e,viewportGridService:i}),c=l.viewportOptions.viewportId,m=Oe({servicesManager:n,viewportId:e,referencedDisplaySetInstanceUID:o=o||l?.displaySetInstanceUIDs[0]}),d=async()=>{const e=await t();r.hydrateSegmentation(e)},p=Array.from(s.cache._volumeCache.keys()).some((e=>e.includes(o)));return m.forEach((async e=>{e.viewportOptions={...e.viewportOptions,viewportType:"volume",needsRerendering:!0};const t=e.viewportId,n=a.getCornerstoneViewport(t),r=n.getCamera();if(p&&t===c)return void await d();const i=async e=>{const n=e.detail.volumeActors?.find((e=>e.uid.includes(o))),l=a.getCornerstoneViewport(t);l.setCamera(r),l.element.removeEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,i),n&&t===c&&await d()};n.element.addEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,i)})),i.setDisplaySetsForViewports(m),!0}const Me=({viewportId:e,viewportGridService:t})=>{const{viewports:n,activeViewportId:o}=t.getState(),a=e||o;return n.get(a)};function Oe({viewportId:e,servicesManager:t,referencedDisplaySetInstanceUID:n}){const{hangingProtocolService:o,displaySetService:a,segmentationService:r,viewportGridService:i}=t.services,{viewports:s,isHangingProtocolLayout:l}=i.getState(),c=Me({viewportId:e,viewportGridService:i}).viewportOptions.viewportId,m=s.get(c).displaySetInstanceUIDs,d=n||m[0],p=a.getDisplaySetByUID(d).instances[0].FrameOfReferenceUID,g=o.getViewportsRequireUpdate(c,d,l);return s.forEach(((e,t)=>{if(c===t||g.find((e=>e.viewportId===t)))return;r.shouldRenderSegmentation(e.displaySetInstanceUIDs,p)&&g.push({viewportId:t,displaySetInstanceUIDs:e.displaySetInstanceUIDs,viewportOptions:{viewportType:"volume",needsRerendering:!0}})})),g.filter((e=>"volume3d"!==e.viewportOptions?.viewportType))}const{segmentation:ke}=l.utilities,{datasetToBlob:Le}=m.Ay.data,{Cornerstone3D:{Segmentation:{generateLabelMaps2DFrom3D:_e,generateSegmentation:Fe}}}=c.ql,{Cornerstone3D:{RTSS:{generateRTSSFromSegmentations:Ge}}}=c.f_,{downloadDICOMData:Pe}=c._$,Ue=({servicesManager:e,extensionManager:t})=>{const{uiNotificationService:n,segmentationService:o,uiDialogService:a,displaySetService:r,viewportGridService:c,toolGroupService:d}=e.services,p={getUpdatedViewportsForSegmentation:Oe,createEmptySegmentationForViewport:async({viewportId:t})=>{const a=Me({viewportId:t,viewportGridService:c}),i=a.displaySetInstanceUIDs[0];r.getDisplaySetByUID(i).isReconstructable?Ae({viewportId:t,servicesManager:e,loadFn:async()=>{const e=o.getSegmentations(),t=await o.createSegmentationForDisplaySet(i,{label:`Segmentation ${e.length+1}`}),n=a.viewportOptions.toolGroupId;return await o.addSegmentationRepresentationToToolGroup(n,t),o.addSegment(t,{toolGroupId:n,segmentIndex:1,properties:{label:"Segment 1"}}),t}}):n.show({title:"Segmentation",message:"Segmentation is not supported for non-reconstructible displaysets yet",type:"error"})},loadSegmentationsForViewport:async({segmentations:t,viewportId:n})=>{Ae({viewportId:n,servicesManager:e,loadFn:async()=>{const e=Me({viewportId:n,viewportGridService:c}),a=e.displaySetInstanceUIDs[0],r=t[0],i=r.id,s=r.label,l=r.segments;if(delete r.segments,await o.createSegmentationForDisplaySet(a,{segmentationId:i,label:s}),r.scalarData){o.getLabelmapVolume(i).scalarData.set(r.scalarData)}o.addOrUpdateSegmentation(r);const m=e.viewportOptions.toolGroupId;return await o.addSegmentationRepresentationToToolGroup(m,i),l.forEach((e=>{null!==e&&o.addSegment(i,{segmentIndex:e.segmentIndex,toolGroupId:m,properties:{color:e.color,label:e.label,opacity:e.opacity,isLocked:e.isLocked,visibility:e.isVisible,active:r.activeSegmentIndex===e.segmentIndex}})})),r.centroidsIJK&&o.setCentroids(r.id,r.centroidsIJK),i}})},loadSegmentationDisplaySetsForViewport:async({viewportId:t,displaySets:n})=>{const a=n[0],i=r.getDisplaySetByUID(a.referencedDisplaySetInstanceUID);Ae({viewportId:t,servicesManager:e,referencedDisplaySetInstanceUID:a.referencedDisplaySetInstanceUID,loadFn:async()=>{const e=a,t="SEG"===e.Modality?"createSegmentationForSEGDisplaySet":"createSegmentationForRTDisplaySet",n=o[t].bind(o),r=await n(e,null,!1);return o.getSegmentation(r).description=`S${i.SeriesNumber}: ${i.SeriesDescription}`,r}})},generateSegmentation:({segmentationId:e,options:t={}})=>{const n=l.segmentation.state.getSegmentation(e),{referencedVolumeId:a}=n.representationData.LABELMAP,r=s.cache.getVolume(e),i=s.cache.getVolume(a).getCornerstoneImages(),c=_e(r);c.metadata=[];const d=o.getSegmentation(e);c.segmentsOnLabelmap.forEach((e=>{const t=d?.segments[e],{label:n,color:o}=t,a=m.Ay.data.Colors.rgb2DICOMLAB(o.slice(0,3).map((e=>e/255))).map((e=>Math.round(e))),r={SegmentNumber:e.toString(),SegmentLabel:n,SegmentAlgorithmType:"MANUAL",SegmentAlgorithmName:"OHIF Brush",RecommendedDisplayCIELabValue:a,SegmentedPropertyCategoryCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"},SegmentedPropertyTypeCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"}};c.metadata[e]=r}));return Fe(i,c,s.metaData,t)},downloadSegmentation:({segmentationId:e})=>{const t=o.getSegmentation(e),n=p.generateSegmentation({segmentationId:e});Pe(n.dataset,`${t.label}`)},storeSegmentation:async({segmentationId:e,dataSource:n})=>{const r=await(0,x.createReportDialogPrompt)(a,{extensionManager:t});if(1!==r.action&&r.value)return;const s=o.getSegmentation(e);if(!s)throw new Error("No segmentation found");const{label:l}=s,c=r.value||l||"Research Derived Series",m=p.generateSegmentation({segmentationId:e,options:{SeriesDescription:c}});if(!m||!m.dataset)throw new Error("Error during segmentation generation");const{dataset:d}=m;return await n.store.dicom(d),d.wadoRoot=n.getConfig().wadoRoot,i.H8.addInstances([d],!0),d},downloadRTSS:({segmentationId:e})=>{const t=o.getSegmentation(e),n={vtkImageMarchingSquares:De.Ay,vtkDataArray:Re.Ay,vtkImageData:Ve.Ay},a=Ge(t,i.Ly.MetadataProvider,i.H8,s.cache,l.Enums,n);try{const e=Le(a),t=URL.createObjectURL(e);window.location.assign(t)}catch(e){console.warn(e)}},setBrushSize:({value:e,toolNames:t})=>{const n=Number(e);d.getToolGroupIds()?.forEach((e=>{0===t?.length?ke.setBrushSizeForToolGroup(e,n):t?.forEach((t=>{ke.setBrushSizeForToolGroup(e,n,t)}))}))},setThresholdRange:({value:e,toolNames:t=["ThresholdCircularBrush","ThresholdSphereBrush"]})=>{d.getToolGroupIds()?.forEach((n=>{const o=d.getToolGroup(n);t?.forEach((t=>{o.setToolConfiguration(t,{strategySpecificConfiguration:{THRESHOLD:{threshold:e}}})}))}))}},g={getUpdatedViewportsForSegmentation:{commandFn:p.getUpdatedViewportsForSegmentation},loadSegmentationDisplaySetsForViewport:{commandFn:p.loadSegmentationDisplaySetsForViewport},loadSegmentationsForViewport:{commandFn:p.loadSegmentationsForViewport},createEmptySegmentationForViewport:{commandFn:p.createEmptySegmentationForViewport},generateSegmentation:{commandFn:p.generateSegmentation},downloadSegmentation:{commandFn:p.downloadSegmentation},storeSegmentation:{commandFn:p.storeSegmentation},downloadRTSS:{commandFn:p.downloadRTSS},setBrushSize:{commandFn:p.setBrushSize},setThresholdRange:{commandFn:p.setThresholdRange}};return{actions:p,definitions:g,defaultContext:"SEGMENTATION"}};function Be(){return Be=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)({}).hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},Be.apply(null,arguments)}const He=r.lazy((()=>n.e(8295).then(n.bind(n,58295)))),$e=e=>r.createElement(r.Suspense,{fallback:r.createElement("div",null,"Loading...")},r.createElement(He,e)),ze={id:o,getPanelModule:Ce,getCommandsModule:Ue,getToolbarModule:function({servicesManager:e}){const{segmentationService:t,toolbarService:n,toolGroupService:o}=e.services;return[{name:"evaluate.cornerstone.segmentation",evaluate:({viewportId:e,button:a,toolNames:r,disabledText:i})=>{const s=t.getSegmentations();if(!s?.length)return{disabled:!0,className:"!text-common-bright !bg-black opacity-50",disabledText:i??"No segmentations available"};const l=o.getToolGroupForViewport(e);if(!l)return{disabled:!0,className:"!text-common-bright ohif-disabled",disabledText:i??"Not available on the current viewport"};const c=n.getToolNameForButton(a);if(!l.hasTool(c)&&!r)return{disabled:!0,className:"!text-common-bright ohif-disabled",disabledText:i??"Not available on the current viewport"};const m=r?r.includes(l.getActivePrimaryMouseButtonTool()):l.getActivePrimaryMouseButtonTool()===c;return{disabled:!1,className:m?"!text-black !bg-primary-light hover:bg-primary-light hover-text-black hover:cursor-pointer":"!text-common-bright !bg-black hover:bg-primary-light hover:cursor-pointer hover:text-black",isActive:m}}}]},getViewportModule:({servicesManager:e,extensionManager:t,commandsManager:n})=>[{name:"dicom-seg",component:o=>r.createElement($e,Be({servicesManager:e,extensionManager:t,commandsManager:n},o))}],getSopClassHandlerModule:u,getHangingProtocolModule:S}}}]);
//# sourceMappingURL=2324.bundle.e69d8586613c4cea8f12.js.map