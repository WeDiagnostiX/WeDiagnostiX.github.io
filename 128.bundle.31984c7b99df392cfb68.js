(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[128],{56297:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>De});const o=JSON.parse('{"UU":"@ohif/extension-cornerstone-dicom-seg"}').UU,a=`${o}.sopClassHandlerModule.dicom-seg`;var r=n(86326),i=n(84607),s=n(53562),l=n(5842);const{DicomMessage:c,DicomMetaDictionary:m}=l.Ay.data,d=["1.2.840.10008.5.1.4.1.1.66.4"];let p={};function u(e,t,n){const o=e[0],{StudyInstanceUID:r,SeriesInstanceUID:u,SOPInstanceUID:g,SeriesDescription:f,SeriesNumber:E,SeriesDate:x,SOPClassUID:S,wadoRoot:v,wadoUri:h,wadoUriRoot:I}=o,y={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:s.utils.guid(),SeriesDescription:f,SeriesNumber:E,SeriesDate:x,SOPInstanceUID:g,SeriesInstanceUID:u,StudyInstanceUID:r,SOPClassHandlerId:a,SOPClassUID:S,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:d,instance:o,instances:[o],wadoRoot:v,wadoUriRoot:I,wadoUri:h,isOverlayDisplaySet:!0},N=o.ReferencedSeriesSequence;if(!N)throw new Error("ReferencedSeriesSequence is missing for the SEG");const w=N[0];return y.referencedImages=o.ReferencedSeriesSequence.ReferencedInstanceSequence,y.referencedSeriesInstanceUID=w.SeriesInstanceUID,y.getReferenceDisplaySet=()=>{const{displaySetService:e}=t.services,n=e.getDisplaySetsForSeries(y.referencedSeriesInstanceUID);if(!n||0===n.length)throw new Error("Referenced DisplaySet is missing for the SEG");const o=n[0];y.referencedDisplaySetInstanceUID=o.displaySetInstanceUID,y.referencedVolumeURI=o.displaySetInstanceUID;const a=`cornerstoneStreamingImageVolume:${y.referencedVolumeURI}`;return y.referencedVolumeId=a,o},y.load=async({headers:e})=>await function(e,t,n,o){const{SOPInstanceUID:a}=e,{segmentationService:r}=t.services;if((e.loading||e.isLoaded)&&p[a]&&function(e,t){return t.getSegmentation(e.displaySetInstanceUID)}(e,r))return p[a];return e.loading=!0,p[a]=new Promise((async(t,a)=>{if(!e.segments||0===Object.keys(e.segments).length){const t=await async function(e,t,n){const o=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{dicomLoaderService:a}=o.exports,r=await a.findDicomDataPromise(t,null,n),s=c.readFile(r),d=m.naturalizeDataset(s.dict);d._meta=m.namifyDataset(s.meta),Array.isArray(d.SegmentSequence)||(d.SegmentSequence=[d.SegmentSequence]);const p=function(e){const t={};return e.SegmentSequence.forEach((e=>{const n=e.RecommendedDisplayCIELabValue,o=l.Ay.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)));o.push(255);const a=e.SegmentNumber;t[a]={color:o,functionalGroups:[],offset:null,size:null,pixelData:null,label:e.SegmentLabel}})),e.PerFrameFunctionalGroupsSequence.forEach((e=>{const n=e.SegmentIdentificationSequence.ReferencedSegmentNumber;t[n].functionalGroups.push(e)})),function(e,t){let n=Math.ceil(e.Rows*e.Columns/8),o=0;return Object.keys(t).forEach((a=>{const r=t[a];r.numberOfFrames=r.functionalGroups.length,r.size=r.numberOfFrames*n,r.offset=o,o=r.offset+r.size;const s=e.PixelData[0].slice(r.offset,o);r.pixelData=l.Ay.data.BitArray.unpack(s),r.geometry=function(e,t){let n=e.SharedFunctionalGroupsSequence.PixelMeasuresSequence,o=e.SharedFunctionalGroupsSequence.PlaneOrientationSequence,a=t[0].PlanePositionSequence;const r={};let s=n.SpacingBetweenSlices;s||n.SliceThickness&&(console.log("Using SliceThickness as SpacingBetweenSlices"),s=n.SliceThickness);r.spacing=[n.PixelSpacing[1],n.PixelSpacing[0],s].map(Number),r.dimensions=[e.Columns,e.Rows,t.length].map(Number);let l=o.ImageOrientationPatient.map(Number);const c=l.slice(0,3),m=l.slice(3,6);r.planeNormal=[],i.Ay.cross(c,m,r.planeNormal);let d=t[0].PlanePositionSequence.ImagePositionPatient.map(Number),p=t[t.length-1].PlanePositionSequence.ImagePositionPatient.map(Number);return r.sliceStep=[],i.Ay.subtract(p,d,r.sliceStep),i.Ay.normalize(r.sliceStep),r.direction=c.concat(m).concat(r.sliceStep),r.origin=a.ImagePositionPatient.map(Number),r}(e,r.functionalGroups)})),t}(e,t)}(d);return p}(n,e,o);e.segments=t}const s=!0;r.createSegmentationForSEGDisplaySet(e,null,s).then((()=>{e.loading=!1,t()})).catch((t=>{e.loading=!1,a(t)}))})),p[a]}(y,t,n,e),[y]}const g=function({servicesManager:e,extensionManager:t}){return[{name:"dicom-seg",sopClassUids:d,getDisplaySetsFromSeries:n=>u(n,e,t)}]};var f=n(97598),E=n.n(f),x=n(7800);const S=function(e,t,n){const o="enter-segment-label",a=({action:t,value:a})=>{switch(t.id){case"save":n(a.label,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:o})};e&&e.create({id:o,centralize:!0,isDraggable:!1,showOverlay:!0,content:x.lG,contentProps:{title:"Segment",value:{label:t},noCloseButton:!0,onClose:()=>e.dismiss({id:o}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Confirm",type:"secondary"}],onSubmit:a,body:({value:e,setValue:t})=>r.createElement(x.pd,{label:"Enter the segment label",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,className:"bg-black border-primary-main",type:"text",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&a({value:e,action:{id:"save"}})}})}})};var v=n(27153),h=n(55530),I=n.n(h),y=n(32865),N=n(34927),w=n(60860);const b=({value1:e,value2:t,onChange:n,minValue:o,maxValue:a,step:i=1,unit:s="",containerClassName:l,inputClassName:c,labelClassName:m,labelVariant:d,showLabel:p=!0,labelPosition:u="",trackColor:g})=>{const[f,E]=(0,r.useState)(e),[S,v]=(0,r.useState)(t);(0,r.useEffect)((()=>{e<o||(E(e),t>a||v(t))}),[e,t]);const h=e=>{const t=Number(e.target.value);t<o||(E(t),n(t,S))},y=e=>{const t=Number(e.target.value);t>a||(v(t),n(f,t))},N=i>=1?f.toFixed(0):f.toFixed(1),b=i>=1?S.toFixed(0):S.toFixed(1);return r.createElement("div",{style:{flexDirection:"column"},className:`flex items-center cursor-pointer space-x-1 ${l||""}`},p&&"left"===u&&r.createElement(r.Fragment,null,r.createElement(w.A,{variant:d??"subtitle",component:"p",className:I()("w-8",m??"text-white")},N,s),r.createElement(w.A,{variant:d??"subtitle",component:"p",className:I()("w-8",m??"text-white")},b,s)),r.createElement("div",{style:{flexDirection:"row"},className:"flex pb-[5px]"},r.createElement("input",{type:"range",min:o,max:a,value:f,className:`appearance-none h-[3px] rounded-lg input-range-thumb-design ${c||""}`,style:{background:"#3a3f99"},onChange:h,id:"myRange1",step:i}),r.createElement("input",{type:"range",min:o,max:a,value:S,className:`appearance-none h-[3px] rounded-lg input-range-thumb-design ${c||""}`,style:{background:"#3a3f99"},onChange:y,id:"myRange2",step:i})),p&&(!u||"right"===u)&&r.createElement("div",{style:{flexDirection:"row",width:"100%"},className:"flex pb-[5px]"},r.createElement(w.A,{variant:d??"subtitle",component:"p",className:I()("w-1/2",m??"text-white","flex","justify-center")},"Min : ",N,s),r.createElement(w.A,{variant:d??"subtitle",component:"p",className:I()("w-1/2",m??"text-white","flex","justify-center")},"Max : ",b,s)),r.createElement("div",{className:"flex",style:{width:"100%"}},r.createElement("div",{className:"flex w-1/2 justify-center"},r.createElement(x.$n,{size:"small",color:"black",onClick:()=>{h({target:{value:f-10}})}},"--"),r.createElement(x.$n,{size:"small",color:"black",onClick:()=>{h({target:{value:f-1}})}},"-"),r.createElement(x.$n,{size:"small",color:"black",onClick:()=>{h({target:{value:f+1}})}},"+"),r.createElement(x.$n,{size:"small",color:"black",onClick:()=>{h({target:{value:f+10}})}},"++")),r.createElement("div",{className:"flex w-1/2 justify-center"},r.createElement(x.$n,{size:"small",color:"black",onClick:()=>{y({target:{value:S-10}})}},"--"),r.createElement(x.$n,{size:"small",color:"black",onClick:()=>{y({target:{value:S-1}})}},"-"),r.createElement(x.$n,{size:"small",color:"black",onClick:()=>{y({target:{value:S+1}})}},"+"),r.createElement(x.$n,{size:"small",color:"black",onClick:()=>{y({target:{value:S+10}})}},"++"))))};var C=n(99993),T=n(11855);const{Enums:D}=v,{MouseBindings:A,Events:R}=D,V=({label:e,activeMode:t,eraseReplaceFocus:n})=>{const o=e===n;return"All"===e&&t===M.REPLACE&&(e="Background"),r.createElement("div",{className:I()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var k=function(e){return e.CIRCLE="CIRCLE",e.SPHERE="SPHERE",e}(k||{}),M=function(e){return e.FILL="FILL",e.THRESHOLD="THRESHOLD",e.ERASE="ERASE",e.REPLACE="REPLACE",e}(M||{});const O=(e,t)=>t+"_INSIDE_"+e,P=[];function L({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,C.Bd)("Buttons"),[o,a]=(0,r.useState)(!1),[i,s]=(0,r.useState)(!0),[l,c]=(0,r.useState)("All"),[m,d]=(0,r.useState)({active:!1,minimum:!0}),[{activeViewportIndex:p,viewports:u},g]=(0,x.ih)(),[f,E]=(0,r.useState)(M.FILL),[S,h]=(0,r.useState)(k.CIRCLE),[w,D]=(0,r.useState)(25),[L,F]=(0,r.useState)([-1e3,5e3]),[B,G]=(0,r.useState)(0),[_,U]=(0,r.useState)([]);(0,r.useEffect)((()=>{const n=v.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewportByIndex(p).id,e.getCornerstoneViewportByIndex(p).renderingEngineId),o=n.getToolInstance("Brush");E(M.FILL),h(k.CIRCLE),D(o.configuration.brushSize),F(o.configuration.strategySpecificConfiguration.THRESHOLD_INSIDE_CIRCLE.threshold),G(o.configuration.strategySpecificConfiguration.REPLACE_INSIDE_CIRCLE.targetSegmentIndex);const a=t.getSegmentations().filter((e=>e.isActive))[0];U([{label:"All",segmentIndex:0},...a.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:n}=e,a=o.configuration.strategySpecificConfiguration;a.REPLACE_INSIDE_CIRCLE.targetSegmentIndex=n,o.setConfiguration({eraseFocusIndex:n,strategySpecificConfiguration:a}),c(t)}})))),n.setToolActive("Undo",{bindings:[{mouseButton:A.Primary}]})}),[]),(0,r.useEffect)((()=>{const n=v.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewportByIndex(p).id,e.getCornerstoneViewportByIndex(p).renderingEngineId).getToolInstance("Brush"),o=t.EVENTS.SEGMENTATION_ADDED,a=t.EVENTS.SEGMENTATION_UPDATED,r=t.EVENTS.SEGMENTATION_REMOVED,i=[];return[o,a,r].forEach((e=>{t.subscribe(e,(()=>{const e=t.getSegmentations().filter((e=>e.isActive))[0];U([{label:"All",segmentIndex:0},...e.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e,a=n.configuration.strategySpecificConfiguration;a.REPLACE_INSIDE_CIRCLE.targetSegmentIndex=o,n.setConfiguration({eraseFocusIndex:o,strategySpecificConfiguration:a}),c(t)}}))))}))})),()=>{i.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{v.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewportByIndex(p).id,e.getCornerstoneViewportByIndex(p).renderingEngineId).getToolInstance("Brush").setConfiguration({brushSize:w,activeStrategy:O(S,f),strategySpecificConfiguration:{THRESHOLD_INSIDE_CIRCLE:{threshold:L},REPLACE_INSIDE_CIRCLE:{targetSegmentIndex:B}}})}),[w,S,f,L]);return(0,r.useEffect)((()=>{const t=e.getCornerstoneViewportByIndex(p),n=v.ToolGroupManager.getToolGroupForViewport(t.id,t.renderingEngineId),o=t.element;o.addEvent=(e,t)=>{P[e]&&(o.removeEventListener(e,P[e]),P[e]=null),P[e]=t,o.addEventListener(e,t)},o.removeEvent=e=>{o.removeEventListener(e,P[e]),P[e]=null},m.active?(n.setToolPassive("Brush"),n.setToolActive("DragProbe",{bindings:[{mouseButton:A.Primary}]}),o.addEvent(R.MOUSE_DRAG,(t=>{((t,n)=>{if(1===t.detail.mouseButton){const o=e.getCornerstoneViewportByIndex(p),a=t.detail.currentPoints.world,r=o.getImageData(),i=r.imageData.worldToIndex(a).map(Math.round);i[0]=Math.round(i[0]),i[1]=Math.round(i[1]),i[2]=Math.round(i[2]);const{scalarData:s,dimensions:l}=r;if(T.utilities.indexWithinDimensions(i,l)){const e=l[0],t=l[0]*l[1],o=s[i[2]*t+i[1]*e+i[0]];F(n?[o,L[1]]:[L[0],o])}}})(t,m.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("Brush",{bindings:[{mouseButton:A.Primary}]}),o.removeEvent(R.MOUSE_DRAG))}),[m.active,m.minimum]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),a(!o)}},r.createElement(y.A,{name:"panel-group-open-close",className:I()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Paint Brush Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Tool and mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(x.$n,{fullWidth:!0,size:"small",color:S===k.CIRCLE?"primary":"secondary",onClick:()=>{h(k.CIRCLE)}},"Circle"),r.createElement(x.$n,{fullWidth:!0,size:"small",color:S===k.SPHERE?"primary":"secondary",onClick:()=>{h(k.SPHERE)}},"Sphere")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(x.$n,{fullWidth:!0,size:"small",color:f===M.FILL?"primary":"secondary",onClick:()=>{E(M.FILL)}},"Fill"),r.createElement(x.$n,{fullWidth:!0,size:"small",color:f===M.THRESHOLD?"primary":"secondary",onClick:()=>{E(M.THRESHOLD)}},"Threshold"),r.createElement(x.$n,{fullWidth:!0,size:"small",color:f===M.ERASE?"primary":"secondary",onClick:()=>{E(M.ERASE)}},"Erase"),r.createElement(x.$n,{fullWidth:!0,size:"small",color:f===M.REPLACE?"primary":"secondary",onClick:()=>{E(M.REPLACE)}},"Replace")),r.createElement("div",{className:"flex items-center col-span-2"},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]"},"Radius"),r.createElement(N.A,{minValue:0,maxValue:100,value:w,onChange:e=>{D(e)},step:1,containerClassName:"mt-[4px] mb-[4px]",inputClassName:"w-[64px]",labelClassName:"text-white text-[12px]",unit:"px"})),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),s(!i)}},r.createElement(y.A,{name:"panel-group-open-close",className:I()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!i})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase/replace options")),!i&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase/replace focus on:"),r.createElement(x.Kv,{items:_,renderer:e=>V({...e,activeMode:f,eraseReplaceFocus:l})})))),f===M.THRESHOLD&&r.createElement("div",{className:"flex items-center col-span-2",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"h-[1px] bg-[#212456] mb-[8px] mx-1",style:{width:"100%"}}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Threshold values"),r.createElement(b,{minValue:-1e3,maxValue:5e3,value1:L[0],value2:L[1],onChange:(e,t)=>{F([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:"HU"}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{d({active:!0,minimum:!0})}},"Minimum"),r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{d({active:!0,minimum:!1})}},"Maximum")),m.active&&r.createElement(x.$n,{size:"small",color:"secondary",onClick:()=>{d({active:!1,minimum:!0})}},"Back to annotation"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const F=({label:e,t,eraseFocus:n})=>{const o=e===n;return r.createElement("div",{className:I()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var B=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(B||{});function G({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,C.Bd)("Buttons"),[o,a]=(0,r.useState)(!1),[i,s]=(0,r.useState)(B.FILL_INSIDE),[{activeViewportIndex:l,viewports:c},m]=(0,x.ih)(),[d,p]=(0,r.useState)([]),[u,g]=(0,r.useState)(!0),[f,E]=(0,r.useState)("All");return(0,r.useEffect)((()=>{const n=v.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewportByIndex(l).id,e.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("CircleScissor"),o=t.EVENTS.SEGMENTATION_ADDED,a=t.EVENTS.SEGMENTATION_UPDATED,r=t.EVENTS.SEGMENTATION_REMOVED,i=[];return[o,a,r].forEach((e=>{t.subscribe(e,(()=>{const e=t.getSegmentations().filter((e=>e.isActive))[0];p([{label:"All",segmentIndex:0},...e.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;n.setConfiguration({eraseFocusIndex:o}),E(t)}}))))}))})),()=>{i.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const n=v.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewportByIndex(l).id,e.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("CircleScissor");s(n.configuration.activeStrategy);const o=t.getSegmentations().filter((e=>e.isActive))[0];p([{label:"All",segmentIndex:0},...o.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;E(t),n.setConfiguration({eraseFocusIndex:o})}}))))}),[]),(0,r.useEffect)((()=>{v.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewportByIndex(l).id,e.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("CircleScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),a(!o)}},r.createElement(y.A,{name:"panel-group-open-close",className:I()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Circle Segmentation Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(x.$n,{fullWidth:!0,size:"small",color:i===B.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(B.FILL_INSIDE)}},"Fill"),r.createElement(x.$n,{fullWidth:!0,size:"small",color:i===B.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(B.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),g(!u)}},r.createElement(y.A,{name:"panel-group-open-close",className:I()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!u})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!u&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on:"),r.createElement(x.Kv,{items:d,renderer:e=>F({...e,t:n,eraseFocus:f})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}function _({}){const[e,t]=(0,r.useState)(!1);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:n=>{n.stopPropagation(),t(!e)}},r.createElement(y.A,{name:"panel-group-open-close",className:I()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!e})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Fill Holes Tool Edit")),!e&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"No configurations for this tool")),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:U}=v,{MouseBindings:z,Events:$}=U,W=[];function j({segmentationService:e,cornerstoneViewportService:t,commandsManager:n}){const[o,a]=(0,r.useState)(!1),[{activeViewportIndex:i,viewports:s},l]=(0,x.ih)(),[c,m]=(0,r.useState)([-1e3,5e3]),[d,p]=(0,r.useState)(0),[u,g]=(0,r.useState)({active:!1,minimum:!0});(0,r.useEffect)((()=>{const e=v.ToolGroupManager.getToolGroupForViewport(t.getCornerstoneViewportByIndex(i).id,t.getCornerstoneViewportByIndex(i).renderingEngineId).getToolInstance("RectangleROIStartEndThreshold");p(e.configuration.numSlicesToPropagate)}),[]),(0,r.useEffect)((()=>{v.ToolGroupManager.getToolGroupForViewport(t.getCornerstoneViewportByIndex(i).id,t.getCornerstoneViewportByIndex(i).renderingEngineId).getToolInstance("RectangleROIStartEndThreshold").setConfiguration({numSlicesToPropagate:d}),console.log("SET CONFIGURATION",d)}),[d]);(0,r.useEffect)((()=>{const e=t.getCornerstoneViewportByIndex(i),n=v.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId),o=e.element;o.addEvent=(e,t)=>{W[e]&&(o.removeEventListener(e,W[e]),W[e]=null),W[e]=t,o.addEventListener(e,t)},o.removeEvent=e=>{o.removeEventListener(e,W[e]),W[e]=null},u.active?(n.setToolPassive("RectangleROIStartEndThreshold"),n.setToolActive("DragProbe",{bindings:[{mouseButton:z.Primary}]}),o.addEvent($.MOUSE_DRAG,(e=>{((e,n)=>{if(1===e.detail.mouseButton){const o=t.getCornerstoneViewportByIndex(i),a=e.detail.currentPoints.world,r=o.getImageData(),s=r.imageData.worldToIndex(a).map(Math.round);s[0]=Math.round(s[0]),s[1]=Math.round(s[1]),s[2]=Math.round(s[2]);const{scalarData:l,dimensions:d}=r;if(T.utilities.indexWithinDimensions(s,d)){const e=d[0],t=d[0]*d[1],o=l[s[2]*t+s[1]*e+s[0]];m(n?[o,c[1]]:[c[0],o])}}})(e,u.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("RectangleROIStartEndThreshold",{bindings:[{mouseButton:z.Primary}]}),o.removeEvent($.MOUSE_DRAG))}),[u.active,u.minimum]);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),a(!o)}},r.createElement(y.A,{name:"panel-group-open-close",className:I()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"3D Rectangle Threshold Segmentation Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"flex items-center col-span-2",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Threshold values"),r.createElement(b,{minValue:-1e3,maxValue:5e3,value1:c[0],value2:c[1],onChange:(e,t)=>{m([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:""}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{g({active:!0,minimum:!0})}},"Minimum"),r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{g({active:!0,minimum:!1})}},"Maximum")),u.active&&r.createElement(x.$n,{size:"small",color:"secondary",onClick:()=>{g({active:!1,minimum:!0})}},"Back to annotation")),r.createElement("div",{className:"flex items-center col-span-2",style:{width:"100%",flexDirection:"column"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Slices Propagation"),r.createElement(N.A,{minValue:0,maxValue:200,value:d,onChange:e=>{p(e)},step:1,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:""})),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const n=t.getCornerstoneViewportByIndex(i).getActors().map((e=>{const t=e.referenceId??e.uid;return T.cache.getVolume(t)})).filter((e=>!!e)),o=v.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIStartEndThreshold");if(!o)throw new Error("No annotation selected ");const a=o[0];if(!v.annotation.state.getAnnotation(a))return;const r=n.filter((e=>e.imageIds))[0],s=n.filter((e=>!e.imageIds))[0],l=e.getSegmentations();v.utilities.segmentation.rectangleROIThresholdVolumeByRange(o,s,[{volume:r,lower:c[0],upper:c[1]}],{numSlicesToProject:0,overwrite:!1,overlapType:1,segmentIndex:l[0].activeSegmentIndex})})()}},"Compute Threshold")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const e=v.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIStartEndThreshold");if(!e)throw new Error("No annotation selected ");console.log("selected annotation uid",e);const n=e[0];console.log("CSTOOLS STATE",v.annotation.state),v.annotation.state.removeAnnotation(n),t.getCornerstoneViewportByIndex(i).render()})()}},"Delete selected region"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:q}=v,{MouseBindings:H,Events:J}=q,K=[];function Q({segmentationService:e,cornerstoneViewportService:t,commandsManager:n}){const[o,a]=(0,r.useState)(!1),[{activeViewportIndex:i,viewports:s},l]=(0,x.ih)(),[c,m]=(0,r.useState)([-1e3,5e3]),[d,p]=(0,r.useState)({active:!1,minimum:!0});(0,r.useEffect)((()=>{const e=t.getCornerstoneViewportByIndex(i),n=v.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId),o=e.element;o.addEvent=(e,t)=>{K[e]&&(o.removeEventListener(e,K[e]),K[e]=null),K[e]=t,o.addEventListener(e,t)},o.removeEvent=e=>{o.removeEventListener(e,K[e]),K[e]=null},d.active?(n.setToolPassive("RectangleROIThreshold"),n.setToolActive("DragProbe",{bindings:[{mouseButton:H.Primary}]}),o.addEvent(J.MOUSE_DRAG,(e=>{((e,n)=>{if(1===e.detail.mouseButton){const o=t.getCornerstoneViewportByIndex(i),a=e.detail.currentPoints.world,r=o.getImageData(),s=r.imageData.worldToIndex(a).map(Math.round);s[0]=Math.round(s[0]),s[1]=Math.round(s[1]),s[2]=Math.round(s[2]);const{scalarData:l,dimensions:d}=r;if(T.utilities.indexWithinDimensions(s,d)){const e=d[0],t=d[0]*d[1],o=l[s[2]*t+s[1]*e+s[0]];m(n?[o,c[1]]:[c[0],o])}}})(e,d.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("RectangleROIThreshold",{bindings:[{mouseButton:H.Primary}]}),o.removeEvent(J.MOUSE_DRAG))}),[d.active,d.minimum]);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),a(!o)}},r.createElement(y.A,{name:"panel-group-open-close",className:I()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Rectangle Threshold Segmentation Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"flex items-center col-span-2 pb-[9px]",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pb-[3px]",style:{width:"100%"}},"Threshold values"),r.createElement(b,{minValue:-1e3,maxValue:5e3,value1:c[0],value2:c[1],onChange:(e,t)=>{m([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full pb-[3px]",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:"HU"}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{p({active:!0,minimum:!0})}},"Minimum"),r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{p({active:!0,minimum:!1})}},"Maximum")),d.active&&r.createElement(x.$n,{size:"small",color:"secondary",onClick:()=>{p({active:!1,minimum:!0})}},"Back to annotation")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const n=t.getCornerstoneViewportByIndex(i).getActors().map((e=>{const t=e.referenceId??e.uid;return T.cache.getVolume(t)})).filter((e=>!!e)),o=v.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIThreshold");if(!o)throw new Error("No annotation selected ");const a=o[0];if(!v.annotation.state.getAnnotation(a))return;const r=n.filter((e=>e.imageIds))[0],s=n.filter((e=>!e.imageIds))[0],l=e.getSegmentations();console.log("SEGMENTATION",l),v.utilities.segmentation.rectangleROIThresholdVolumeByRange(o,s,[{volume:r,lower:c[0],upper:c[1]}],{numSlicesToProject:0,overwrite:!1,overlapType:1,segmentIndex:l[0].activeSegmentIndex})})()}},"Compute Threshold")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const e=v.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIThreshold");if(!e)throw new Error("No annotation selected ");console.log("selected annotation uid",e);const n=e[0];console.log("CSTOOLS STATE",v.annotation.state),v.annotation.state.removeAnnotation(n),t.getCornerstoneViewportByIndex(i).render()})()}},"Delete selected region"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const X=({label:e,t,eraseFocus:n})=>{const o=e===n;return r.createElement("div",{className:I()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var Y=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(Y||{});function Z({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,C.Bd)("Buttons"),[o,a]=(0,r.useState)(!1),[i,s]=(0,r.useState)(Y.FILL_INSIDE),[{activeViewportIndex:l,viewports:c},m]=(0,x.ih)(),[d,p]=(0,r.useState)([]),[u,g]=(0,r.useState)(!0),[f,E]=(0,r.useState)("All");return(0,r.useEffect)((()=>{const n=v.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewportByIndex(l).id,e.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("RectangleScissor"),o=t.EVENTS.SEGMENTATION_ADDED,a=t.EVENTS.SEGMENTATION_UPDATED,r=t.EVENTS.SEGMENTATION_REMOVED,i=[];return[o,a,r].forEach((e=>{t.subscribe(e,(()=>{const e=t.getSegmentations().filter((e=>e.isActive))[0];p([{label:"All",segmentIndex:0},...e.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;n.setConfiguration({eraseFocusIndex:o}),E(t)}}))))}))})),()=>{i.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const n=v.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewportByIndex(l).id,e.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("RectangleScissor");s(n.configuration.activeStrategy);const o=t.getSegmentations().filter((e=>e.isActive))[0];p([{label:"All",segmentIndex:0},...o.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;E(t),n.setConfiguration({eraseFocusIndex:o})}}))))}),[]),(0,r.useEffect)((()=>{v.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewportByIndex(l).id,e.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("RectangleScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),a(!o)}},r.createElement(y.A,{name:"panel-group-open-close",className:I()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Rectangle Scissors Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(x.$n,{fullWidth:!0,size:"small",color:i===Y.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(Y.FILL_INSIDE)}},"Fill"),r.createElement(x.$n,{fullWidth:!0,size:"small",color:i===Y.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(Y.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),g(!u)}},r.createElement(y.A,{name:"panel-group-open-close",className:I()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!u})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!u&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on:"),r.createElement(x.Kv,{items:d,renderer:e=>X({...e,t:n,eraseFocus:f})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}const ee=({label:e,t,eraseFocus:n})=>{const o=e===n;return r.createElement("div",{className:I()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var te=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(te||{});function ne({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,C.Bd)("Buttons"),[o,a]=(0,r.useState)(!1),[i,s]=(0,r.useState)(te.FILL_INSIDE),[{activeViewportIndex:l,viewports:c},m]=(0,x.ih)(),[d,p]=(0,r.useState)([]),[u,g]=(0,r.useState)(!0),[f,E]=(0,r.useState)("All");return(0,r.useEffect)((()=>{const n=v.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewportByIndex(l).id,e.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("RectangleScissor"),o=t.EVENTS.SEGMENTATION_ADDED,a=t.EVENTS.SEGMENTATION_UPDATED,r=t.EVENTS.SEGMENTATION_REMOVED,i=[];return[o,a,r].forEach((e=>{t.subscribe(e,(()=>{const e=t.getSegmentations().filter((e=>e.isActive))[0];p([{label:"All",segmentIndex:0},...e.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;n.setConfiguration({eraseFocusIndex:o}),E(t)}}))))}))})),()=>{i.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const n=v.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewportByIndex(l).id,e.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("SphereScissor");s(n.configuration.activeStrategy);const o=t.getSegmentations().filter((e=>e.isActive))[0];p([{label:"All",segmentIndex:0},...o.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;E(t),n.setConfiguration({eraseFocusIndex:o})}}))))}),[]),(0,r.useEffect)((()=>{v.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewportByIndex(l).id,e.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("SphereScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),a(!o)}},r.createElement(y.A,{name:"panel-group-open-close",className:I()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Sphere Scissors Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(x.$n,{fullWidth:!0,size:"small",color:i===te.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(te.FILL_INSIDE)}},"Fill"),r.createElement(x.$n,{fullWidth:!0,size:"small",color:i===te.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(te.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),g(!u)}},r.createElement(y.A,{name:"panel-group-open-close",className:I()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!u})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!u&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on:"),r.createElement(x.Kv,{items:d,renderer:e=>ee({...e,t:n,eraseFocus:f})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:oe}=v,{Events:ae}=oe;const re=10,ie=new class extends Array{constructor(e){super(),this.maxLength=void 0,this.maxLength=e}push(...e){const t=super.push(...e);if(this.length>this.maxLength){const e=this.length-this.maxLength;this.splice(0,e)}return t}}(re);function se({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,C.Bd)("Buttons"),[o,a]=(0,r.useState)(!1),[{activeViewportIndex:i,viewports:s},l]=(0,x.ih)(),[c,m]=(0,r.useState)(ie.length);(0,r.useEffect)((()=>{e.getCornerstoneViewportByIndex(i).element.addEventListener(ae.MOUSE_DOWN,(e=>{const n=t.getSegmentations()[0],o=new Uint8ClampedArray(t.getLabelmapVolume(n.id).getScalarData());ie.length===re&&ie.shift(),ie.push(o),m(ie.length)}))}),[]);const d=t=>{const n=e.getCornerstoneViewportByIndex(i).element,o=ie[t];if(!o)return;const a=new CustomEvent("UNDO_REDO_TOOL",{detail:{element:n,oldScalarData:o}});window.dispatchEvent(a),m(t)};return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),a(!o)}},r.createElement(y.A,{name:"panel-group-open-close",className:I()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Undo/redo Segmentation")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px] pt-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly inline-flex"},r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{0!==c&&d(c-1)}},"Undo"),r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{c!==re&&d(c+1)}},"Redo"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:le}=v,{Events:ce}=le,{state:me}=v,de=["Brush","CircleScissor","PaintFill","RectangleROIStartEndThreshold","RectangleROIThreshold","RectangleScissor","SphereScissor"];function pe({segmentationService:e,toolbarService:t,toolGroupService:n,cornerstoneViewportService:o,commandsManager:a}){const[{activeViewportIndex:i,viewports:s},l]=(0,x.ih)(),[c,m]=(0,r.useState)(null),d=()=>{const e=me.toolGroups.filter((e=>"mpr"===e.id))[0]?.toolOptions;e||m(null);const t=Object.keys(e).map((function(t){return[t,e[t]]}));let n=!1;t.forEach((e=>{if(de.includes(e[0])&&"Active"===e[1].mode)return n=!0,void m(e[0])})),n||m(null)};(0,r.useEffect)((()=>{d()}),[]),(0,r.useEffect)((()=>{const{unsubscribe:e}=t.subscribe(t.EVENTS.TOOL_BAR_STATE_MODIFIED,d);return()=>{e()}}),[t]);return r.createElement(r.Fragment,null,c&&r.createElement(se,{cornerstoneViewportService:o,segmentationService:e}),(()=>{switch(c){case"Brush":return r.createElement(L,{cornerstoneViewportService:o,segmentationService:e});case"CircleScissor":return r.createElement(G,{cornerstoneViewportService:o,segmentationService:e});case"PaintFill":return r.createElement(_,null);case"RectangleROIStartEndThreshold":return r.createElement(j,{segmentationService:e,cornerstoneViewportService:o,commandsManager:a});case"RectangleROIThreshold":return r.createElement(Q,{segmentationService:e,cornerstoneViewportService:o,commandsManager:a});case"RectangleScissor":return r.createElement(Z,{cornerstoneViewportService:o,segmentationService:e});case"SphereScissor":return r.createElement(ne,{cornerstoneViewportService:o,segmentationService:e});default:return null}})())}var ue=n(24571);function ge({segmentationService:e,segmentations:t}){const[n,o]=(0,r.useState)(!1),[{activeViewportIndex:a,viewports:i},s]=(0,x.ih)();return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),o(!n)}},r.createElement(x.In,{name:"panel-group-open-close",className:I()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!n})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Segments Configuration I/O")),!n&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px] pt-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly inline-flex"},r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{console.log("SEGS AT IMPORT",t);const n=document.createElement("input");n.type="file",n.accept="application/json",n.onchange=o=>{const r=Array.from(n.files)[0],s=new FileReader;s.onload=function(n){try{if("string"==typeof n.target.result){for(let n=1;n<t[0].segments.length;n++)e.removeSegment(t[0].id,n);JSON.parse(n.target.result).forEach((n=>{if(n){const{segmentIndex:o}=n;e.addSegment(t[0].id,o,i[a].viewportOptions.toolGroupId,n,!0)}}))}else console.error("ERROR::JSON_READING::CORRUPTED_CONTENT")}catch(e){console.error("ERROR::JSON_READING",e)}},s.readAsText(r)},n.click()}},"Import File"),r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{const e=JSON.stringify(t[0].segments),n=new Blob([e],{type:"text/plain;charset=utf-8"});(0,ue.saveAs)(n,"segments_configuration.json")}},"Export File"))),r.createElement("div",{className:"h-[6px] bg-black "})))}ge.propTypes={segmentations:E().array.isRequired};const fe=ge;var Ee=n(62672),xe=n.n(Ee),Se=n(85639);function ve({segmentationService:e,segmentations:t,cornerstoneViewportService:n}){const[o,a]=(0,r.useState)(!1),[i,s]=(0,r.useState)(0),[l,c]=(0,r.useState)(!1),[{activeViewportIndex:m,viewports:d},p]=(0,x.ih)();(0,r.useEffect)((()=>{o&&(s(0),setTimeout(u,500))}),[o]);const u=()=>{const n=e.getLabelmapVolume(t[0].id),{dimensions:o,direction:r,scalarData:i}=n,l=t[0].segments,c=l.map(((e,t)=>{if(e)return t})).filter((e=>e)),m=new Uint32Array(i);console.log("START COMPUTING INDEX ARRAY...");const d=new Array(o[2]-1);for(let e=0;e<m.length;e+=o[0]*o[1]){const t=e/(o[0]*o[1]),n=new Uint8ClampedArray(o[0]*o[1]*4).fill(0).map(((e,t)=>(t-3)%4==0?255:e)),a=m.slice(e,e+o[0]*o[1]);Promise.allSettled(c.map((e=>(e=>a.map(((t,n)=>{if(0!==t&&t===e)return n})).filter((e=>0!==e)))(e)))).then((e=>{e.forEach(((e,t)=>{const o=e.value;if(0!==o.length){const e=c[t],a=[...l[e].color,255];o.forEach((e=>{n[4*e]=a[0],n[4*e+1]=a[1],n[4*e+2]=a[2]}))}}));new Promise(((e,a)=>{const r=document.createElement("canvas"),i=r.getContext("2d");r.width=o[0],r.height=o[1];const s=new ImageData(n,o[0],o[1],{colorSpace:"srgb"});i.putImageData(s,0,0),r.toBlob((n=>{n&&(d[t]=n,e())}),"image/png")})).then((()=>{const e=d.filter((e=>e)).length;s(~~(100*e/o[2]))}))}))}new Promise(((e,t)=>{!function t(){if(d.filter((e=>e)).length===o[2])return e();setTimeout(t,500)}()})).then((()=>{const n=new(xe());d.forEach(((e,t)=>{n.file(`layer_${t}.png`,e)}));const o=JSON.stringify(t[0].segments,null,"\t"),r=new Blob([o],{type:"text/plain;charset=utf-8"});n.file("segmentation_informations.json",r);const i=e.getLabelmapVolume(t[0].id),s=new Uint8Array(i.scalarData),l=new Blob([s],{type:"application/octet-stream"});n.file("scalarData.bin",l),n.generateAsync({type:"blob"}).then((e=>{(0,ue.saveAs)(e,"segmentation.zip"),a(!1)}))}))};return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),c(!l)}},r.createElement(x.In,{name:"panel-group-open-close",className:I()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!l})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Segmentations I/O")),!l&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px] pt-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly flex"},r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{console.log("SEGS AT IMPORT",t);let e=d[m];"volume"!==e.viewportOptions.viewportType&&(e=d.find((e=>"volume"===e.viewportOptions.viewportType)),console.assert(e,'ImportSegmentation: Could not find "volume" viewport'),p.setActiveViewportIndex(e.viewportIndex));const o=n.getCornerstoneViewport(e.id).getActors();console.assert(o&&o.length,"ImportSegmentation: No actors on volume viewport");const a=o.map((e=>{const t=e.referenceId??e.uid;return T.cache.getVolume(t)})).filter((e=>!e.imageIds))[0],r=a.volumeId,i=a.getScalarData(),s=document.createElement("input");s.type="file",s.accept="application/octet-stream",s.onchange=async e=>{const t=Array.from(s.files)[0],n=new FileReader;n.onload=async function(e){const t=new Uint8Array(e.target.result);for(let e=0;e<i.length;e++)i[e]=t[e];v.segmentation.triggerSegmentationEvents.triggerSegmentationDataModified(r)},n.readAsArrayBuffer(t)},s.click()}},"Import Segmentation"),r.createElement(x.$n,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{a(!0)}},"Export Segmentation")),o&&r.createElement("div",{className:"w-full mt-[9px]"},r.createElement("p",{style:{color:"white"}},"Processing layers..."),r.createElement(Se.A,{className:"w-full mt-[3px]",bgColor:i<100?"#5ACCE6":"#50C878",completed:i,transitionDuration:"0.05s",transitionTimingFunction:"linear"}))),r.createElement("div",{className:"h-[6px] bg-black "})))}ve.propTypes={segmentations:E().array.isRequired};const he=ve,Ie=v.Enums.SegmentationRepresentations.Labelmap;function ye({servicesManager:e,commandsManager:t}){const[{activeViewportIndex:n,viewports:o},a]=(0,x.ih)(),{segmentationService:i,uiDialogService:s,cornerstoneViewportService:l,hangingProtocolService:c,toolGroupService:m,toolbarService:d,uiNotificationService:p}=e.services,{t:u}=(0,C.Bd)("PanelSegmentation"),[g,f]=(0,r.useState)(null),[E,v]=(0,r.useState)(i.getConfiguration()),[h,I]=(0,r.useState)((()=>i.getSegmentations())),[y,N]=(0,r.useState)({}),w=(0,r.useCallback)((e=>{N((t=>({...t,[e]:!t[e]})))}),[N]);(0,r.useEffect)((()=>{const e=h[h.length-1]?.id;e&&N((t=>({...t,[e]:!1})))}),[h,N]),(0,r.useEffect)((()=>{const e=a.getState();console.log("STATE",e),console.log("HP",c.getActiveProtocol()),"mprAnd3DVolumeViewport"!==c.getActiveProtocol().protocol.id&&t.runCommand("toggleHangingProtocol",{protocolId:"mprAnd3DVolumeViewport",stageIndex:0});const n=i.EVENTS.SEGMENTATION_ADDED,o=i.EVENTS.SEGMENTATION_UPDATED,r=i.EVENTS.SEGMENTATION_REMOVED,s=[];return[n,o,r].forEach((e=>{const{unsubscribe:t}=i.subscribe(e,(()=>{const e=i.getSegmentations();I(e),v(i.getConfiguration())}));s.push(t)})),()=>{s.forEach((e=>{e()}))}}),[]);const b=e=>i.getToolGroupIdsWithSegmentation(e),T=(0,r.useCallback)(((e,t,n)=>{i.setConfiguration({segmentationId:e,[t]:n})}),[i]),D=()=>{const e=o.filter((e=>e.viewportIndex===n))[0]?.displaySetInstanceUIDs[0];return h.filter((t=>t.displaySetInstanceUID===e)).length>0};return r.createElement(r.Fragment,null,!("volume3d"===o[n].viewportOptions.viewportType&&(p.show({title:"Segmentation Panel",message:"Can't use segmentation panel in viewport 3D, select a 2D viewport",type:"info"}),1))&&r.createElement("div",{className:"flex flex-col flex-auto mt-1"},r.createElement(pe,{segmentationService:i,cornerstoneViewportService:l,toolGroupService:m,toolbarService:d,commandsManager:t}),D()&&r.createElement(fe,{segmentationService:i,segmentations:h}),D()?r.createElement(x.QQ,{title:u("Segmentations"),showAddSegment:!0,segmentations:h,isMinimized:y,activeSegmentationId:g||"",onSegmentationClick:e=>{i.setActiveSegmentationForToolGroup(e)},onSegmentationDelete:e=>{i.remove(e)},onSegmentationEdit:e=>{const t=i.getSegmentation(e),{label:n}=t;S(s,n,((t,n)=>{""!==t&&i.addOrUpdateSegmentation({id:e,label:t},!1,!0)}))},onSegmentClick:(e,t)=>{i.setActiveSegmentForSegmentation(e,t);b(e).forEach((n=>{i.setActiveSegmentationForToolGroup(e,n),i.jumpToSegmentCenter(e,t,n)}))},onSegmentEdit:(e,t)=>{const n=i.getSegmentation(e).segments[t],{label:o}=n;S(s,o,((n,o)=>{""!==n&&i.setSegmentLabelForSegmentation(e,t,n)}))},onSegmentAdd:e=>{const t=i.getSegmentation(e);i.addSegment(e,t.segments.length,o[n].viewportOptions.toolGroupId,{label:`Segmentation ${t.segmentCount+1}`,color:[Math.floor(256*Math.random()),Math.floor(256*Math.random()),Math.floor(256*Math.random())],opacity:255,visibility:!0,isLocked:!1,active:!0})},onSegmentColorChange:(e,t,a)=>{i.setSegmentColor(e,t,a,o[n].viewportOptions.toolGroupId)},onSegmentDelete:(e,t)=>{i.removeSegment(e,t)},onToggleSegmentVisibility:(e,t)=>{const n=!i.getSegmentation(e).segments[t].isVisible;b(e).forEach((o=>{i.setSegmentVisibility(e,t,n,o)}))},onToggleSegmentationVisibility:e=>{i.toggleSegmentationVisibility(e)},onToggleMinimizeSegmentation:w,segmentationConfig:{initialConfig:E},setRenderOutline:e=>T(g,"renderOutline",e),setOutlineOpacityActive:e=>T(g,"outlineOpacity",e),setRenderFill:e=>T(g,"renderFill",e),setRenderInactiveSegmentations:e=>T(g,"renderInactiveSegmentations",e),setOutlineWidthActive:e=>T(g,"outlineWidthActive",e),setFillAlpha:e=>T(g,"fillAlpha",e),setFillAlphaInactive:e=>T(g,"fillAlphaInactive",e)}):null,D()?r.createElement(he,{segmentationService:i,segmentations:h,cornerstoneViewportService:l}):0===h.length&&r.createElement(x.$n,{className:"pt-1/10 pb-1/10",onClick:()=>{o.forEach((e=>{if(e.viewportIndex===n){if("volume3d"===e.viewportOptions.viewportType)return void p.show({title:"Create Segmentation",message:"Can't create segmentation in viewport 3D, select a 2D viewport",type:"error"});console.log("SEG VP",e),i.createSegmentationForDisplaySet(e.displaySetInstanceUIDs[0]).then((t=>{const a=i.getSegmentation(t);console.log("CREATED SEGMENTATION",a),i.addSegmentationRepresentationToToolGroup(e.viewportOptions.toolGroupId,t,!0,Ie).then((()=>{i.setActiveSegmentationForToolGroup(t,e.viewportOptions.toolGroupId),i.addSegment(t,1,o[n].viewportOptions.toolGroupId,{label:"Segmentation 1",color:[255,0,0],opacity:255,visibility:!0,isLocked:!1,active:!0}),console.log("MTOOLS",d.getButtonSection("MeasurementTools",{})),d.createButtonSection("primary",["MeasurementTools","Zoom","WindowLevel","Pan","Capture","Crosshairs","MoreTools","SegmentationTools"])}))}))}}))}},"Create Segmentation For Selected Viewport")))}ye.propTypes={commandsManager:E().shape({runCommand:E().func.isRequired}),servicesManager:E().shape({services:E().shape({segmentationService:E().shape({getSegmentation:E().func.isRequired,getSegmentations:E().func.isRequired,toggleSegmentationVisibility:E().func.isRequired,subscribe:E().func.isRequired,EVENTS:E().object.isRequired}).isRequired}).isRequired}).isRequired};const Ne={id:"@ohif/seg",hasUpdatedPriorsInformation:!1,name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId"}]}]}]};const we=function(){return[{name:Ne.id,protocol:Ne}]};function be(){return be=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)({}).hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},be.apply(null,arguments)}const Ce=r.lazy((()=>n.e(965).then(n.bind(n,43965)))),Te=e=>r.createElement(r.Suspense,{fallback:r.createElement("div",null,"Loading...")},r.createElement(Ce,e)),De={id:o,getPanelModule:({servicesManager:e,commandsManager:t,extensionManager:n})=>[{name:"panelSegmentation",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:()=>r.createElement(ye,{commandsManager:t,servicesManager:e,extensionManager:n})}],getViewportModule:({servicesManager:e,extensionManager:t})=>[{name:"dicom-seg",component:n=>r.createElement(Te,be({servicesManager:e,extensionManager:t},n))}],getSopClassHandlerModule:g,getHangingProtocolModule:we}},89288:()=>{}}]);
//# sourceMappingURL=128.bundle.31984c7b99df392cfb68.js.map