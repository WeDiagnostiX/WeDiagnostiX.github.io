"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[206,757],{80477:(e,t,n)=>{n.r(t),n.d(t,{default:()=>je});const o=JSON.parse('{"u2":"@ohif/extension-cornerstone-dicom-seg"}').u2,a=`${o}.sopClassHandlerModule.dicom-seg`;var r=n(43001),i=n(84793),s=n(62709),l=n(93725),c=n(91202),m=n(67540);const d=["1.2.840.10008.5.1.4.1.1.66.4"],p={};function g(e,t,n){const o=e[0],{StudyInstanceUID:r,SeriesInstanceUID:g,SOPInstanceUID:u,SeriesDescription:E,SeriesNumber:f,SeriesDate:S,SOPClassUID:v,wadoRoot:x,wadoUri:h,wadoUriRoot:I}=o,w={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:i.utils.guid(),SeriesDescription:E,SeriesNumber:f,SeriesDate:S,SOPInstanceUID:u,SeriesInstanceUID:g,StudyInstanceUID:r,SOPClassHandlerId:a,SOPClassUID:v,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:d,instance:o,instances:[o],wadoRoot:x,wadoUriRoot:I,wadoUri:h,isOverlayDisplaySet:!0},y=o.ReferencedSeriesSequence;if(!y)return void console.error("ReferencedSeriesSequence is missing for the SEG");const b=y[0]||y;return w.referencedImages=o.ReferencedSeriesSequence.ReferencedInstanceSequence,w.referencedSeriesInstanceUID=b.SeriesInstanceUID,w.getReferenceDisplaySet=()=>{const{displaySetService:e}=t.services,n=e.getDisplaySetsForSeries(w.referencedSeriesInstanceUID);if(!n||0===n.length)throw new Error("Referenced DisplaySet is missing for the SEG");const o=n[0];w.referencedDisplaySetInstanceUID=o.displaySetInstanceUID,w.referencedVolumeURI=o.displaySetInstanceUID;const a=`cornerstoneStreamingImageVolume:${w.referencedVolumeURI}`;return w.referencedVolumeId=a,o},w.load=async({headers:e})=>await function(e,t,n,o){const{SOPInstanceUID:a}=e,{segmentationService:r}=t.services;if((e.loading||e.isLoaded)&&p[a]&&function(e,t){return t.getSegmentation(e.displaySetInstanceUID)}(e,r))return p[a];return e.loading=!0,p[a]=new Promise((async(a,i)=>{e.segments&&0!==Object.keys(e.segments).length||await async function({extensionManager:e,servicesManager:t,segDisplaySet:n,headers:o}){const a=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{segmentationService:r,uiNotificationService:i}=t.services,{dicomLoaderService:d}=a.exports,p=await d.findDicomDataPromise(n,null,o),g=s.cache.getVolume(n.referencedVolumeId);if(!g)throw new Error("Referenced Volume is missing for the SEG, and stack viewport SEG is not supported yet");const{imageIds:u}=g,E=.001,f=!0;s.eventTarget.addEventListener(c.Y.Events.SEGMENTATION_LOAD_PROGRESS,(e=>{const{percentComplete:t}=e.detail;r._broadcastEvent(r.EVENTS.SEGMENT_LOADING_COMPLETE,{percentComplete:t})}));const S=await c.adaptersSEG.Cornerstone3D.Segmentation.generateToolState(u,p,s.metaData,{skipOverlapping:f,tolerance:E,eventTarget:s.eventTarget,triggerEvent:s.triggerEvent});let v=!0;S.segMetadata.data.forEach(((e,t)=>{var n;t>0&&(e.rgba=e.RecommendedDisplayCIELabValue,e.rgba?e.rgba=(n=e.rgba,m.default.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)))):(v=!1,e.rgba=l.CONSTANTS.COLOR_LUT[t%l.CONSTANTS.COLOR_LUT.length]))})),S.overlappingSegments&&i.show({title:"Overlapping Segments",message:"Unsupported overlapping segments detected, segmentation rendering results may be incorrect.",type:"warning"});v||i.show({title:"DICOM SEG import",message:"RecommendedDisplayCIELabValue not found for one or more segments. The default color was used instead.",type:"warning",duration:5e3});Object.assign(n,S)}({extensionManager:n,servicesManager:t,segDisplaySet:e,headers:o});const d=!0;r.createSegmentationForSEGDisplaySet(e,null,d).then((()=>{e.loading=!1,a()})).catch((t=>{e.loading=!1,i(t)}))})),p[a]}(w,t,n,e),[w]}const u=function({servicesManager:e,extensionManager:t}){return[{name:"dicom-seg",sopClassUids:d,getDisplaySetsFromSeries:n=>g(n,e,t)}]},E={id:"@ohif/seg",name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId"}]}]}]};const f=function(){return[{name:E.id,protocol:E}]};var S=n(52490),v=n(47316),x=n(58949),h=n(3827),I=n.n(h);let w=function(e){return e.Expanded="expanded",e.Dropdown="dropdown",e}({});const y=function(e,t,n){const o="enter-segment-label",a=({action:t,value:a})=>{switch(t.id){case"save":n(a.label,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:o})};e&&e.create({id:o,centralize:!0,isDraggable:!1,showOverlay:!0,content:v.Vq,contentProps:{title:"Segment",value:{label:t},noCloseButton:!0,onClose:()=>e.dismiss({id:o}),actions:[{id:"cancel",text:"Cancel",type:v.LZ.dt.secondary},{id:"save",text:"Confirm",type:v.LZ.dt.primary}],onSubmit:a,body:({value:e,setValue:t})=>r.createElement(v.II,{label:"Enter the segment label",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,className:"border-primary-main bg-black",type:"text",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&a({value:e,action:{id:"save"}})}})}})};var b=n(22831);const N=function(e,t,n){const o="pick-color",a=({action:t,value:a})=>{switch(t.id){case"save":n(a.rgbaColor,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:o})};e&&e.create({id:o,centralize:!0,isDraggable:!1,showOverlay:!0,content:v.Vq,contentProps:{title:"Segment Color",value:{rgbaColor:t},noCloseButton:!0,onClose:()=>e.dismiss({id:o}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:a,body:({value:e,setValue:t})=>r.createElement(b.AI,{color:e.rgbaColor,onChange:e=>{t({rgbaColor:e.rgb})},presetColors:[],width:300})}})};var T=n(33901),C=n.n(T),D=n(58682),V=n(20779),R=n(24738);const M=({value1:e,value2:t,onChange:n,minValue:o,maxValue:a,step:i=1,unit:s="",containerClassName:l,inputClassName:c,labelClassName:m,labelVariant:d,showLabel:p=!0,labelPosition:g="",trackColor:u})=>{const[E,f]=(0,r.useState)(e),[S,x]=(0,r.useState)(t);(0,r.useEffect)((()=>{e<o||(f(e),t>a||x(t))}),[e,t]);const h=e=>{const t=Number(e.target.value);t<o||(f(t),n(t,S))},I=e=>{const t=Number(e.target.value);t>a||(x(t),n(E,t))},w=i>=1?E.toFixed(0):E.toFixed(1),y=i>=1?S.toFixed(0):S.toFixed(1);return r.createElement("div",{style:{flexDirection:"column"},className:`flex items-center cursor-pointer space-x-1 ${l||""}`},p&&"left"===g&&r.createElement(r.Fragment,null,r.createElement(R.Z,{variant:d??"subtitle",component:"p",className:C()("w-8",m??"text-white")},w,s),r.createElement(R.Z,{variant:d??"subtitle",component:"p",className:C()("w-8",m??"text-white")},y,s)),r.createElement("div",{style:{flexDirection:"row"},className:"flex pb-[5px]"},r.createElement("input",{type:"range",min:o,max:a,value:E,className:`appearance-none h-[3px] rounded-lg input-range-thumb-design ${c||""}`,style:{background:"#3a3f99"},onChange:h,id:"myRange1",step:i}),r.createElement("input",{type:"range",min:o,max:a,value:S,className:`appearance-none h-[3px] rounded-lg input-range-thumb-design ${c||""}`,style:{background:"#3a3f99"},onChange:I,id:"myRange2",step:i})),p&&(!g||"right"===g)&&r.createElement("div",{style:{flexDirection:"row",width:"100%"},className:"flex pb-[5px]"},r.createElement(R.Z,{variant:d??"subtitle",component:"p",className:C()("w-1/2",m??"text-white","flex","justify-center")},"Min : ",w,s),r.createElement(R.Z,{variant:d??"subtitle",component:"p",className:C()("w-1/2",m??"text-white","flex","justify-center")},"Max : ",y,s)),r.createElement("div",{className:"flex",style:{width:"100%"}},r.createElement("div",{className:"flex w-1/2 justify-center"},r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{h({target:{value:E-10}})}},"--"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{h({target:{value:E-1}})}},"-"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{h({target:{value:E+1}})}},"+"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{h({target:{value:E+10}})}},"++")),r.createElement("div",{className:"flex w-1/2 justify-center"},r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{I({target:{value:S-10}})}},"--"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{I({target:{value:S-1}})}},"-"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{I({target:{value:S+1}})}},"+"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{I({target:{value:S+10}})}},"++"))))};var A=n(69190);const{Enums:O}=l,{MouseBindings:k,Events:G}=O,F=({label:e,activeMode:t,eraseReplaceFocus:n})=>{const o=e===n;return"All"===e&&t===P.REPLACE&&(e="Background"),r.createElement("div",{className:C()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var L=function(e){return e.CIRCLE="CIRCLE",e.SPHERE="SPHERE",e}(L||{}),P=function(e){return e.FILL="FILL",e.THRESHOLD="THRESHOLD",e.ERASE="ERASE",e.REPLACE="REPLACE",e}(P||{});const _=[];function U({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,A.$G)("Buttons"),[o,a]=(0,r.useState)(!1),[i,c]=(0,r.useState)(!0),[m,d]=(0,r.useState)("All"),[p,g]=(0,r.useState)({active:!1,minimum:!0}),[{activeViewportId:u,viewports:E},f]=(0,v.O_)(),[S,x]=(0,r.useState)(P.FILL),[h,I]=(0,r.useState)(L.CIRCLE),[w,y]=(0,r.useState)(25),[b,N]=(0,r.useState)([-1e3,5e3]),[T,R]=(0,r.useState)(0),[O,U]=(0,r.useState)([]);(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(u).id,e.getCornerstoneViewport(u).renderingEngineId),o=n.getToolInstance("Brush");x(P.FILL),I(L.CIRCLE),y(o.configuration.brushSize),N(o.configuration.strategySpecificConfiguration.THRESHOLD.threshold),R(o.configuration.strategySpecificConfiguration.REPLACE.targetSegmentIndex);const a=t.getSegmentations().filter((e=>e.isActive))[0];U([{label:"All",segmentIndex:0},...a.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:n}=e,a=o.configuration.strategySpecificConfiguration;a.REPLACE.targetSegmentIndex=n,o.setConfiguration({eraseFocusIndex:n,strategySpecificConfiguration:a}),d(t)}})))),n.setToolActive("Undo",{bindings:[{mouseButton:k.Primary}]})}),[]),(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(u).id,e.getCornerstoneViewport(u).renderingEngineId).getToolInstance("Brush"),o=t.EVENTS.SEGMENTATION_ADDED,a=t.EVENTS.SEGMENTATION_UPDATED,r=t.EVENTS.SEGMENTATION_REMOVED,i=[];return[o,a,r].forEach((e=>{t.subscribe(e,(()=>{const e=t.getSegmentations().filter((e=>e.isActive))[0];U([{label:"All",segmentIndex:0},...e.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e,a=n.configuration.strategySpecificConfiguration;a.REPLACE.targetSegmentIndex=o,n.setConfiguration({eraseFocusIndex:o,strategySpecificConfiguration:a}),d(t)}}))))}))})),()=>{i.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(u).id,e.getCornerstoneViewport(u).renderingEngineId).getToolInstance("Brush"),o=t.EVENTS.SEGMENTATION_ADDED,a=t.EVENTS.SEGMENTATION_UPDATED,r=t.EVENTS.SEGMENTATION_REMOVED,i=[];return[o,a,r].forEach((e=>{t.subscribe(e,(()=>{const e=t.getSegmentations().filter((e=>e.isActive))[0];U([{label:"All",segmentIndex:0},...e.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e,a=n.configuration.strategySpecificConfiguration;a.REPLACE.targetSegmentIndex=o,n.setConfiguration({eraseFocusIndex:o,strategySpecificConfiguration:a}),d(t)}}))))}))})),()=>{i.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{var t,n;l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(u).id,e.getCornerstoneViewport(u).renderingEngineId).getToolInstance("Brush").setConfiguration({brushSize:w,activeStrategy:(t=h,n=S,n+"_INSIDE_"+t),strategySpecificConfiguration:{THRESHOLD:{threshold:b},REPLACE:{targetSegmentIndex:T}}})}),[w,h,S,b]);return(0,r.useEffect)((()=>{const t=e.getCornerstoneViewport(u),n=l.ToolGroupManager.getToolGroupForViewport(t.id,t.renderingEngineId),o=t.element;o.addEvent=(e,t)=>{_[e]&&(o.removeEventListener(e,_[e]),_[e]=null),_[e]=t,o.addEventListener(e,t)},o.removeEvent=e=>{o.removeEventListener(e,_[e]),_[e]=null},p.active?(n.setToolPassive("Brush"),n.setToolActive("DragProbe",{bindings:[{mouseButton:k.Primary}]}),o.addEvent(G.MOUSE_DRAG,(t=>{((t,n)=>{if(1===t.detail.mouseButton){const o=e.getCornerstoneViewport(u),a=t.detail.currentPoints.world,r=o.getImageData(),i=r.imageData.worldToIndex(a).map(Math.round);i[0]=Math.round(i[0]),i[1]=Math.round(i[1]),i[2]=Math.round(i[2]);const{scalarData:l,dimensions:c}=r;if(s.utilities.indexWithinDimensions(i,c)){const e=c[0],t=c[0]*c[1],o=l[i[2]*t+i[1]*e+i[0]];N(n?[o,b[1]]:[b[0],o])}}})(t,p.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("Brush",{bindings:[{mouseButton:k.Primary}]}),o.removeEvent(G.MOUSE_DRAG))}),[p.active,p.minimum]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Paint Brush Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Tool and mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:h===L.CIRCLE?"primary":"secondary",onClick:()=>{I(L.CIRCLE)}},"Circle"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:h===L.SPHERE?"primary":"secondary",onClick:()=>{I(L.SPHERE)}},"Sphere")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:S===P.FILL?"primary":"secondary",onClick:()=>{x(P.FILL)}},"Fill"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:S===P.THRESHOLD?"primary":"secondary",onClick:()=>{x(P.THRESHOLD)}},"Threshold"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:S===P.ERASE?"primary":"secondary",onClick:()=>{x(P.ERASE)}},"Erase"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:S===P.REPLACE?"primary":"secondary",onClick:()=>{x(P.REPLACE)}},"Replace")),r.createElement("div",{className:"flex items-center col-span-2"},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]"},"Radius"),r.createElement(V.Z,{minValue:0,maxValue:100,value:w,onChange:e=>{y(e)},step:1,containerClassName:"mt-[4px] mb-[4px]",inputClassName:"w-[64px]",labelClassName:"text-white text-[12px]",unit:"px"})),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),c(!i)}},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!i})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase/replace options")),!i&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase/replace focus on:"),r.createElement(v.QE,{items:O,renderer:e=>F({...e,activeMode:S,eraseReplaceFocus:m})})))),S===P.THRESHOLD&&r.createElement("div",{className:"flex items-center col-span-2",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"h-[1px] bg-[#212456] mb-[8px] mx-1",style:{width:"100%"}}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Threshold values"),r.createElement(M,{minValue:-1e3,maxValue:5e3,value1:b[0],value2:b[1],onChange:(e,t)=>{N([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:"HU"}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{g({active:!0,minimum:!0})}},"Minimum"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{g({active:!0,minimum:!1})}},"Maximum")),p.active&&r.createElement(v.zx,{size:"small",color:"secondary",onClick:()=>{g({active:!1,minimum:!0})}},"Back to annotation"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const z=({label:e,t,eraseFocus:n})=>{const o=e===n;return r.createElement("div",{className:C()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var B=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(B||{});function W({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,A.$G)("Buttons"),[o,a]=(0,r.useState)(!1),[i,s]=(0,r.useState)(B.FILL_INSIDE),[{activeViewportId:c,viewports:m},d]=(0,v.O_)(),[p,g]=(0,r.useState)([]),[u,E]=(0,r.useState)(!0),[f,S]=(0,r.useState)("All");return(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("CircleScissor"),o=t.EVENTS.SEGMENTATION_ADDED,a=t.EVENTS.SEGMENTATION_UPDATED,r=t.EVENTS.SEGMENTATION_REMOVED,i=[];return[o,a,r].forEach((e=>{t.subscribe(e,(()=>{const e=t.getSegmentations().filter((e=>e.isActive))[0];g([{label:"All",segmentIndex:0},...e.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;n.setConfiguration({eraseFocusIndex:o}),S(t)}}))))}))})),()=>{i.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("CircleScissor");s(n.configuration.activeStrategy);const o=t.getSegmentations().filter((e=>e.isActive))[0];g([{label:"All",segmentIndex:0},...o.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;S(t),n.setConfiguration({eraseFocusIndex:o})}}))))}),[]),(0,r.useEffect)((()=>{l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("CircleScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Circle Segmentation Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===B.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(B.FILL_INSIDE)}},"Fill"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===B.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(B.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),E(!u)}},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!u})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!u&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on:"),r.createElement(v.QE,{items:p,renderer:e=>z({...e,t:n,eraseFocus:f})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}function j({}){const[e,t]=(0,r.useState)(!1);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>t(!e)},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!e})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Fill Holes Tool Edit")),!e&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"No configurations for this tool")),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:H}=l,{MouseBindings:Z,Events:q}=H,$=[];function J({segmentationService:e,cornerstoneViewportService:t,commandsManager:n}){const[o,a]=(0,r.useState)(!1),[{activeViewportId:i,viewports:c},m]=(0,v.O_)(),[d,p]=(0,r.useState)([-1e3,5e3]),[g,u]=(0,r.useState)(0),[E,f]=(0,r.useState)({active:!1,minimum:!0});(0,r.useEffect)((()=>{const e=l.ToolGroupManager.getToolGroupForViewport(t.getCornerstoneViewport(i).id,t.getCornerstoneViewport(i).renderingEngineId).getToolInstance("RectangleROIStartEndThreshold");u(e.configuration.numSlicesToPropagate)}),[]),(0,r.useEffect)((()=>{l.ToolGroupManager.getToolGroupForViewport(t.getCornerstoneViewport(i).id,t.getCornerstoneViewport(i).renderingEngineId).getToolInstance("RectangleROIStartEndThreshold").setConfiguration({numSlicesToPropagate:g}),console.log("SET CONFIGURATION",g)}),[g]);(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(i),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId),o=e.element;o.addEvent=(e,t)=>{$[e]&&(o.removeEventListener(e,$[e]),$[e]=null),$[e]=t,o.addEventListener(e,t)},o.removeEvent=e=>{o.removeEventListener(e,$[e]),$[e]=null},E.active?(n.setToolPassive("RectangleROIStartEndThreshold"),n.setToolActive("DragProbe",{bindings:[{mouseButton:Z.Primary}]}),o.addEvent(q.MOUSE_DRAG,(e=>{((e,n)=>{if(1===e.detail.mouseButton){const o=t.getCornerstoneViewport(i),a=e.detail.currentPoints.world,r=o.getImageData(),l=r.imageData.worldToIndex(a).map(Math.round);l[0]=Math.round(l[0]),l[1]=Math.round(l[1]),l[2]=Math.round(l[2]);const{scalarData:c,dimensions:m}=r;if(s.utilities.indexWithinDimensions(l,m)){const e=m[0],t=m[0]*m[1],o=c[l[2]*t+l[1]*e+l[0]];p(n?[o,d[1]]:[d[0],o])}}})(e,E.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("RectangleROIStartEndThreshold",{bindings:[{mouseButton:Z.Primary}]}),o.removeEvent(q.MOUSE_DRAG))}),[E.active,E.minimum]);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"3D Rectangle Threshold Segmentation Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"flex items-center col-span-2",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Threshold values"),r.createElement(M,{minValue:-1e3,maxValue:5e3,value1:d[0],value2:d[1],onChange:(e,t)=>{p([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:""}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{f({active:!0,minimum:!0})}},"Minimum"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{f({active:!0,minimum:!1})}},"Maximum")),E.active&&r.createElement(v.zx,{size:"small",color:"secondary",onClick:()=>{f({active:!1,minimum:!0})}},"Back to annotation")),r.createElement("div",{className:"flex items-center col-span-2",style:{width:"100%",flexDirection:"column"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Slices Propagation"),r.createElement(V.Z,{minValue:0,maxValue:200,value:g,onChange:e=>{u(e)},step:1,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:""})),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const n=t.getCornerstoneViewport(i).getActors().map((e=>{const t=e.referenceId??e.uid;return s.cache.getVolume(t)})).filter((e=>!!e)),o=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIStartEndThreshold");if(!o)throw new Error("No annotation selected ");const a=o[0];if(!l.annotation.state.getAnnotation(a))return;const r=n.filter((e=>e.imageIds.length))[0],c=n.filter((e=>!e.imageIds.length))[0],m=e.getSegmentations();l.utilities.segmentation.rectangleROIThresholdVolumeByRange(o,c,[{volume:r,lower:d[0],upper:d[1]}],{numSlicesToProject:0,overwrite:!1,overlapType:1,segmentIndex:m[0].activeSegmentIndex})})()}},"Compute Threshold")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const e=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIStartEndThreshold");if(!e)throw new Error("No annotation selected ");console.log("selected annotation uid",e);const n=e[0];console.log("CSTOOLS STATE",l.annotation.state),l.annotation.state.removeAnnotation(n),t.getCornerstoneViewport(i).render()})()}},"Delete selected region"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:Q}=l,{MouseBindings:K,Events:X}=Q,Y=[];function ee({segmentationService:e,cornerstoneViewportService:t,commandsManager:n}){const[o,a]=(0,r.useState)(!1),[{activeViewportId:i,viewports:c},m]=(0,v.O_)(),[d,p]=(0,r.useState)([-1e3,5e3]),[g,u]=(0,r.useState)({active:!1,minimum:!0});(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(i),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId),o=e.element;o.addEvent=(e,t)=>{Y[e]&&(o.removeEventListener(e,Y[e]),Y[e]=null),Y[e]=t,o.addEventListener(e,t)},o.removeEvent=e=>{o.removeEventListener(e,Y[e]),Y[e]=null},g.active?(n.setToolPassive("RectangleROIThreshold"),n.setToolActive("DragProbe",{bindings:[{mouseButton:K.Primary}]}),o.addEvent(X.MOUSE_DRAG,(e=>{((e,n)=>{if(1===e.detail.mouseButton){const o=t.getCornerstoneViewport(i),a=e.detail.currentPoints.world,r=o.getImageData(),l=r.imageData.worldToIndex(a).map(Math.round);l[0]=Math.round(l[0]),l[1]=Math.round(l[1]),l[2]=Math.round(l[2]);const{scalarData:c,dimensions:m}=r;if(s.utilities.indexWithinDimensions(l,m)){const e=m[0],t=m[0]*m[1],o=c[l[2]*t+l[1]*e+l[0]];p(n?[o,d[1]]:[d[0],o])}}})(e,g.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("RectangleROIThreshold",{bindings:[{mouseButton:K.Primary}]}),o.removeEvent(X.MOUSE_DRAG))}),[g.active,g.minimum]);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Rectangle Threshold Segmentation Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"flex items-center col-span-2 pb-[9px]",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pb-[3px]",style:{width:"100%"}},"Threshold values"),r.createElement(M,{minValue:-1e3,maxValue:5e3,value1:d[0],value2:d[1],onChange:(e,t)=>{p([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full pb-[3px]",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:"HU"}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{u({active:!0,minimum:!0})}},"Minimum"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{u({active:!0,minimum:!1})}},"Maximum")),g.active&&r.createElement(v.zx,{size:"small",color:"secondary",onClick:()=>{u({active:!1,minimum:!0})}},"Back to annotation")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const n=t.getCornerstoneViewport(i).getActors().map((e=>{const t=e.referenceId??e.uid;return s.cache.getVolume(t)})).filter((e=>!!e)),o=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIThreshold");if(!o)throw new Error("No annotation selected ");const a=o[0];if(!l.annotation.state.getAnnotation(a))return;const r=n.filter((e=>e.imageIds.length))[0],c=n.filter((e=>!e.imageIds.length))[0],m=e.getSegmentations();console.log("SEGMENTATION",m),l.utilities.segmentation.rectangleROIThresholdVolumeByRange(o,c,[{volume:r,lower:d[0],upper:d[1]}],{numSlicesToProject:0,overwrite:!1,overlapType:1,segmentIndex:m[0].activeSegmentIndex})})()}},"Compute Threshold")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const e=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIThreshold");if(!e)throw new Error("No annotation selected ");console.log("selected annotation uid",e);const n=e[0];console.log("CSTOOLS STATE",l.annotation.state),l.annotation.state.removeAnnotation(n),t.getCornerstoneViewport(i).render()})()}},"Delete selected region"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const te=({label:e,t,eraseFocus:n})=>{const o=e===n;return r.createElement("div",{className:C()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var ne=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(ne||{});function oe({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,A.$G)("Buttons"),[o,a]=(0,r.useState)(!1),[i,s]=(0,r.useState)(ne.FILL_INSIDE),[{activeViewportId:c,viewports:m},d]=(0,v.O_)(),[p,g]=(0,r.useState)([]),[u,E]=(0,r.useState)(!0),[f,S]=(0,r.useState)("All");return(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("RectangleScissor"),o=t.EVENTS.SEGMENTATION_ADDED,a=t.EVENTS.SEGMENTATION_UPDATED,r=t.EVENTS.SEGMENTATION_REMOVED,i=[];return[o,a,r].forEach((e=>{t.subscribe(e,(()=>{const e=t.getSegmentations().filter((e=>e.isActive))[0];g([{label:"All",segmentIndex:0},...e.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;n.setConfiguration({eraseFocusIndex:o}),S(t)}}))))}))})),()=>{i.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("RectangleScissor");s(n.configuration.activeStrategy);const o=t.getSegmentations().filter((e=>e.isActive))[0];g([{label:"All",segmentIndex:0},...o.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;S(t),n.setConfiguration({eraseFocusIndex:o})}}))))}),[]),(0,r.useEffect)((()=>{l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("RectangleScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Rectangle Scissors Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===ne.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(ne.FILL_INSIDE)}},"Fill"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===ne.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(ne.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),E(!u)}},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!u})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!u&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on:"),r.createElement(v.QE,{items:p,renderer:e=>te({...e,t:n,eraseFocus:f})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}const ae=({label:e,t,eraseFocus:n})=>{const o=e===n;return r.createElement("div",{className:C()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var re=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(re||{});function ie({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,A.$G)("Buttons"),[o,a]=(0,r.useState)(!1),[i,s]=(0,r.useState)(re.FILL_INSIDE),[{activeViewportId:c,viewports:m},d]=(0,v.O_)(),[p,g]=(0,r.useState)([]),[u,E]=(0,r.useState)(!0),[f,S]=(0,r.useState)("All");return(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("RectangleScissor"),o=t.EVENTS.SEGMENTATION_ADDED,a=t.EVENTS.SEGMENTATION_UPDATED,r=t.EVENTS.SEGMENTATION_REMOVED,i=[];return[o,a,r].forEach((e=>{t.subscribe(e,(()=>{const e=t.getSegmentations().filter((e=>e.isActive))[0];g([{label:"All",segmentIndex:0},...e.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;n.setConfiguration({eraseFocusIndex:o}),S(t)}}))))}))})),()=>{i.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const n=l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("SphereScissor");s(n.configuration.activeStrategy);const o=t.getSegmentations().filter((e=>e.isActive))[0];g([{label:"All",segmentIndex:0},...o.segments.filter((e=>e))].map((e=>({...e,onClick:e=>{const{label:t,segmentIndex:o}=e;S(t),n.setConfiguration({eraseFocusIndex:o})}}))))}),[]),(0,r.useEffect)((()=>{l.ToolGroupManager.getToolGroupForViewport(e.getCornerstoneViewport(c).id,e.getCornerstoneViewport(c).renderingEngineId).getToolInstance("SphereScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Sphere Scissors Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===re.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(re.FILL_INSIDE)}},"Fill"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===re.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(re.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),E(!u)}},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!u})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!u&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on:"),r.createElement(v.QE,{items:p,renderer:e=>ae({...e,t:n,eraseFocus:f})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:se}=l,{Events:le}=se;const ce=new class extends Array{constructor(e){super(),this.maxLength=void 0,this.maxLength=e}push(...e){const t=super.push(...e);if(this.length>this.maxLength){const e=this.length-this.maxLength;this.splice(0,e)}return t}}(10);function me({cornerstoneViewportService:e,segmentationService:t}){const{t:n}=(0,A.$G)("Buttons"),[o,a]=(0,r.useState)(!1),[{activeViewportId:i,viewports:s},l]=(0,v.O_)(),[c,m]=(0,r.useState)(ce.length);(0,r.useEffect)((()=>{e.getCornerstoneViewport(i).element.addEventListener(le.MOUSE_DOWN,(e=>{const n=t.getSegmentations()[0],o=new Uint8ClampedArray(t.getLabelmapVolume(n.id).getScalarData());10===ce.length&&ce.shift(),ce.push(o),m(ce.length)}))}),[]);const d=t=>{const n=e.getCornerstoneViewport(i).element,o=ce[t];if(!o)return;const a=new CustomEvent("UNDO_REDO_TOOL",{detail:{element:n,oldScalarData:o}});window.dispatchEvent(a),m(t)};return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),a(!o)}},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Undo/redo Segmentation")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px] pt-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly inline-flex"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{0!==c&&d(c-1)}},"Undo"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{10!==c&&d(c+1)}},"Redo"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:de}=l,{Events:pe}=de,{state:ge}=l,ue=["Brush","CircleScissor","PaintFill","RectangleROIStartEndThreshold","RectangleROIThreshold","RectangleScissor","SphereScissor"];function Ee({segmentationService:e,toolbarService:t,toolGroupService:n,cornerstoneViewportService:o,commandsManager:a}){const[{activeViewportId:i,viewports:s},l]=(0,v.O_)(),[c,m]=(0,r.useState)(null),d=()=>{const e=ge.toolGroups.filter((e=>"mpr"===e.id))[0]?.toolOptions;e||m(null);const t=Object.keys(e).map((function(t){return[t,e[t]]}));let n=!1;t.forEach((e=>{if(ue.includes(e[0])&&"Active"===e[1].mode)return n=!0,void m(e[0])})),n||m(null)};(0,r.useEffect)((()=>{d()}),[]),(0,r.useEffect)((()=>{const{unsubscribe:e}=t.subscribe(t.EVENTS.TOOL_BAR_MODIFIED,d);return()=>{e()}}),[t]);return r.createElement(r.Fragment,null,c&&r.createElement(me,{cornerstoneViewportService:o,segmentationService:e}),(()=>{switch(c){case"Brush":return r.createElement(U,{cornerstoneViewportService:o,segmentationService:e});case"CircleScissor":return r.createElement(W,{cornerstoneViewportService:o,segmentationService:e});case"PaintFill":return r.createElement(j,null);case"RectangleROIStartEndThreshold":return r.createElement(J,{segmentationService:e,cornerstoneViewportService:o,commandsManager:a});case"RectangleROIThreshold":return r.createElement(ee,{segmentationService:e,cornerstoneViewportService:o,commandsManager:a});case"RectangleScissor":return r.createElement(oe,{cornerstoneViewportService:o,segmentationService:e});case"SphereScissor":return r.createElement(ie,{cornerstoneViewportService:o,segmentationService:e});default:return null}})())}var fe=n(74208);function Se({segmentationService:e,segmentations:t}){const[n,o]=(0,r.useState)(!1),[{activeViewportId:a,viewports:i},s]=(0,v.O_)();return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),o(!n)}},r.createElement(v.JO,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!n})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Segments Configuration I/O")),!n&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px] pt-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly inline-flex"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{console.log("SEGS AT IMPORT",t);const n=document.createElement("input");n.type="file",n.accept="application/json",n.onchange=o=>{const r=Array.from(n.files)[0],s=new FileReader;s.onload=function(n){try{if("string"==typeof n.target.result){for(let n=1;n<t[0].segments.length;n++)e.removeSegment(t[0].id,n);JSON.parse(n.target.result).forEach((n=>{if(n){const{segmentIndex:o}=n;e.addSegment(t[0].id,{segmentIndex:o,toolGroupId:i.get(a).viewportOptions.toolGroupId,properties:n,override:!0})}}))}else console.error("ERROR::JSON_READING::CORRUPTED_CONTENT")}catch(e){console.error("ERROR::JSON_READING",e)}},s.readAsText(r)},n.click()}},"Import File"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{const e=JSON.stringify(t[0].segments),n=new Blob([e],{type:"text/plain;charset=utf-8"});(0,fe.saveAs)(n,"segments_configuration.json")}},"Export File"))),r.createElement("div",{className:"h-[6px] bg-black "})))}Se.propTypes={segmentations:I().array.isRequired};const ve=Se;var xe=n(17816),he=n.n(xe),Ie=n(3820);n(17854);function we({segmentationService:e,segmentations:t,cornerstoneViewportService:n}){const[o,a]=(0,r.useState)(!1),[i,c]=(0,r.useState)(0),[m,d]=(0,r.useState)(!1),[{activeViewportId:p,viewports:g},u]=(0,v.O_)();(0,r.useEffect)((()=>{o&&(c(0),setTimeout(E,500))}),[o]);const E=()=>{const n=e.getLabelmapVolume(t[0].id),{dimensions:o,direction:r,scalarData:i}=n,s=t[0].segments,l=s.map(((e,t)=>{if(e)return t})).filter((e=>e)),m=new Uint32Array(i);console.log("START COMPUTING INDEX ARRAY...");const d=new Array(o[2]-1);for(let e=0;e<m.length;e+=o[0]*o[1]){const t=e/(o[0]*o[1]),n=new Uint8ClampedArray(o[0]*o[1]*4).fill(0).map(((e,t)=>(t-3)%4==0?255:e)),a=m.slice(e,e+o[0]*o[1]);Promise.allSettled(l.map((e=>(e=>a.map(((t,n)=>{if(0!==t&&t===e)return n})).filter((e=>0!==e)))(e)))).then((e=>{e.forEach(((e,t)=>{const o=e.value;if(0!==o.length){const e=l[t],a=[...s[e].color,255];o.forEach((e=>{n[4*e]=a[0],n[4*e+1]=a[1],n[4*e+2]=a[2]}))}}));new Promise(((e,a)=>{const r=document.createElement("canvas"),i=r.getContext("2d");r.width=o[0],r.height=o[1];const s=new ImageData(n,o[0],o[1],{colorSpace:"srgb"});i.putImageData(s,0,0),r.toBlob((n=>{n&&(d[t]=n,e())}),"image/png")})).then((()=>{const e=d.filter((e=>e)).length;c(~~(100*e/o[2]))}))}))}new Promise(((e,t)=>{!function t(){if(d.filter((e=>e)).length===o[2])return e();setTimeout(t,500)}()})).then((()=>{const e=new(he());d.forEach(((t,n)=>{e.file(`layer_${n}.png`,t)}));const n=JSON.stringify(t[0].segments,null,"\t"),o=new Blob([n],{type:"text/plain;charset=utf-8"});e.file("segmentation_informations.json",o);const r=new Blob([i],{type:"application/octet-stream"});e.file("scalarData.bin",r),e.generateAsync({type:"blob"}).then((e=>{(0,fe.saveAs)(e,"segmentation.zip"),a(!1)}))}))};return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),d(!m)}},r.createElement(v.JO,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!m})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Segmentations I/O")),!m&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px] pt-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly flex"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{console.log("SEGS AT IMPORT",t);let e=g.get(p);"volume"!==e.viewportOptions.viewportType&&(e=Array.from(g.values()).find((e=>"volume"===e.viewportOptions.viewportType)),console.assert(e,'ImportSegmentation: Could not find "volume" viewport'),u.setActiveViewportId(e.viewportId));const o=n.getCornerstoneViewport(e.viewportId).getActors();console.assert(o&&o.length,"ImportSegmentation: No actors on volume viewport");const a=o.map((e=>{const t=e.referenceId??e.uid;return s.cache.getVolume(t)})).filter((e=>!e.imageIds.length))[0],r=a.volumeId,i=a.getScalarData(),c=document.createElement("input");c.type="file",c.accept="application/octet-stream",c.onchange=async e=>{const t=Array.from(c.files)[0],n=new FileReader;n.onload=async function(e){const t=new Uint8Array(e.target.result);for(let e=0;e<i.length;e++)i[e]=t[e];l.segmentation.triggerSegmentationEvents.triggerSegmentationDataModified(r)},n.readAsArrayBuffer(t)},c.click()}},"Import Segmentation"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{a(!0)}},"Export Segmentation")),o&&r.createElement("div",{className:"w-full mt-[9px]"},r.createElement("p",{style:{color:"white"}},"Processing layers..."),r.createElement(Ie.Z,{className:"w-full mt-[3px]",bgColor:i<100?"#5ACCE6":"#50C878",completed:i,transitionDuration:"0.05s",transitionTimingFunction:"linear"}))),r.createElement("div",{className:"h-[6px] bg-black "})))}we.propTypes={segmentations:I().array.isRequired};const ye=we,be=l.Enums.SegmentationRepresentations.Labelmap,Ne={[w.Expanded]:v.s_,[w.Dropdown]:v.cX};function Te({servicesManager:e,commandsManager:t,extensionManager:n,configuration:o}){const[{activeViewportId:a,viewports:i}]=(0,v.O_)(),{segmentationService:s,viewportGridService:l,uiDialogService:c,displaySetService:m,cornerstoneViewportService:d,hangingProtocolService:p,toolGroupService:g,toolbarService:u,uiNotificationService:E}=e.services,{t:f}=(0,A.$G)("PanelSegmentation"),[S,h]=(0,r.useState)(null),[I,w]=(0,r.useState)(""),[b,T]=(0,r.useState)(s.getConfiguration()),[C,D]=(0,r.useState)((()=>s.getSegmentations())),[V,R]=(0,r.useState)({});(0,r.useCallback)((e=>{R((t=>({...t,[e]:!t[e]})))}),[R]);(0,r.useEffect)((()=>{const e=C[C.length-1]?.id;e&&R((t=>({...t,[e]:!1})))}),[C,R]),(0,r.useEffect)((()=>{const e=s.EVENTS.SEGMENTATION_ADDED,t=s.EVENTS.SEGMENTATION_UPDATED,n=s.EVENTS.SEGMENTATION_REMOVED,o=[];return[e,t,n].forEach((e=>{const{unsubscribe:t}=s.subscribe(e,(()=>{const e=s.getSegmentations();D(e),T(s.getConfiguration())}));o.push(t)})),()=>{o.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const e=e=>{const t=l.getDisplaySetsUIDsForViewport(e||l.getActiveViewportId());if(!t)return;const n=t?.some((e=>{const t=m.getDisplaySetByUID(e);return t?.isReconstructable}))||!1;w(n?"":"ohif-disabled")};e();const t=l.EVENTS.ACTIVE_VIEWPORT_ID_CHANGED,n=l.EVENTS.VIEWPORTS_READY,o=[];[n,t].forEach((t=>{const{unsubscribe:n}=l.subscribe(t,(({viewportId:t})=>{e(t)}));o.push(n)}));const a=d.EVENTS.VIEWPORT_DATA_CHANGED,r=[];return[a].forEach((t=>{const{unsubscribe:n}=d.subscribe(t,(()=>{e()}));r.push(n)})),()=>{o.forEach((e=>e())),r.forEach((e=>e()))}}),[]);const M=e=>s.getToolGroupIdsWithSegmentation(e),O=(0,r.useCallback)(((e,t,n)=>{s.setConfiguration({segmentationId:e,[t]:n})}),[s]),k=Ne[o?.segmentationPanelMode]||v.cX,G=o?.addSegment,F=o?.onSegmentationAdd&&"function"==typeof o?.onSegmentationAdd?o?.onSegmentationAdd:async()=>{t.runCommand("createEmptySegmentationForViewport",{viewportId:l.getActiveViewportId()})},L=()=>{const e=i.get(a)?.displaySetInstanceUIDs[0];return C.filter((t=>t.displaySetInstanceUID===e)).length>0};return r.createElement(r.Fragment,null,!("volume3d"===i.get(a).viewportOptions.viewportType&&(E.show({title:"Segmentation Panel",message:"Can't use segmentation panel in viewport 3D, select a 2D viewport",type:"info"}),1))&&r.createElement("div",{className:"flex flex-col flex-auto min-h-0F mt-1"},r.createElement(Ee,{segmentationService:s,cornerstoneViewportService:d,toolGroupService:g,toolbarService:u,commandsManager:t}),L()&&r.createElement(ve,{segmentationService:s,segmentations:C}),r.createElement(k,{title:f("Segmentations"),segmentations:C,disableEditing:o.disableEditing,activeSegmentationId:S||"",onSegmentationAdd:F,addSegmentationClassName:I,showAddSegment:G,onSegmentationClick:e=>{s.setActiveSegmentationForToolGroup(e,i.get(a).viewportOptions.toolGroupId)},onSegmentationDelete:e=>{s.remove(e)},onSegmentationDownload:e=>{t.runCommand("downloadSegmentation",{segmentationId:e})},onSegmentationDownloadRTSS:e=>{t.runCommand("downloadRTSS",{segmentationId:e})},storeSegmentation:async o=>{const a=n.getActiveDataSource(),r=await(0,x.createReportAsync)({servicesManager:e,getReport:()=>t.runCommand("storeSegmentation",{segmentationId:o,dataSource:a[0]}),reportType:"Segmentation"});r&&(s.remove(o),l.setDisplaySetsForViewport({viewportId:l.getActiveViewportId(),displaySetInstanceUIDs:r}))},onSegmentationEdit:e=>{const t=s.getSegmentation(e),{label:n}=t;y(c,n,((t,n)=>{""!==t&&s.addOrUpdateSegmentation({id:e,label:t},!1,!0)}))},onSegmentClick:(e,t)=>{s.setActiveSegment(e,t);M(e).forEach((n=>{s.setActiveSegmentationForToolGroup(e,n),s.jumpToSegmentCenter(e,t,n)}))},onSegmentEdit:(e,t)=>{const n=s.getSegmentation(e).segments[t],{label:o}=n;y(c,o,((n,o)=>{""!==n&&s.setSegmentLabel(e,t,n)}))},onSegmentAdd:e=>{const t=s.getSegmentation(e);s.addSegment(e,{segmentIndex:t.segments.length,toolGroupId:i.get(a).viewportOptions.toolGroupId,properties:{label:`Segmentation ${t.segmentCount+1}`,color:[Math.floor(256*Math.random()),Math.floor(256*Math.random()),Math.floor(256*Math.random())],opacity:255,visibility:!0,isLocked:!1,active:!0}})},onSegmentColorClick:(e,t)=>{const n=s.getSegmentation(e).segments[t],{color:o,opacity:a}=n,r={r:o[0],g:o[1],b:o[2],a:a/255};N(c,r,((n,o)=>{"cancel"!==o&&s.setSegmentRGBAColor(e,t,[n.r,n.g,n.b,255*n.a])}))},onSegmentDelete:(e,t)=>{s.removeSegment(e,t)},onToggleSegmentVisibility:(e,t)=>{const n=!s.getSegmentation(e).segments[t].isVisible;M(e).forEach((o=>{s.setSegmentVisibility(e,t,n,o)}))},onToggleSegmentLock:(e,t)=>{s.toggleSegmentLocked(e,t)},onToggleSegmentationVisibility:e=>{s.toggleSegmentationVisibility(e);const t=s.getSegmentation(e),n=t.isVisible,o=t.segments;M(e).forEach((t=>{o.forEach(((o,a)=>{s.setSegmentVisibility(e,a,n,t)}))}))},showDeleteSegment:!0,segmentationConfig:{initialConfig:b},setRenderOutline:e=>O(S,"renderOutline",e),setOutlineOpacityActive:e=>O(S,"outlineOpacity",e),setRenderFill:e=>O(S,"renderFill",e),setRenderInactiveSegmentations:e=>O(S,"renderInactiveSegmentations",e),setOutlineWidthActive:e=>O(S,"outlineWidthActive",e),setFillAlpha:e=>O(S,"fillAlpha",e),setFillAlphaInactive:e=>O(S,"fillAlphaInactive",e)}),L()&&r.createElement(ye,{segmentationService:s,segmentations:C,cornerstoneViewportService:d}),r.createElement(v.zx,{className:"pt-1/10 pb-1/10",onClick:()=>{i.forEach((e=>{if(e.viewportId===a){if("volume3d"===e.viewportOptions.viewportType)return void E.show({title:"Create Segmentation",message:"Can't create segmentation in viewport 3D, select a 2D viewport",type:"error"});console.log("SEG VP",e),s.createSegmentationForDisplaySet(e.displaySetInstanceUIDs[0],{label:`Segmentation ${C.length+1}`}).then((t=>{const n=s.getSegmentation(t);console.log("CREATED SEGMENTATION",n),s.addSegmentationRepresentationToToolGroup(e.viewportOptions.toolGroupId,t,!0,be).then((()=>{s.setActiveSegmentationForToolGroup(t,e.viewportOptions.toolGroupId),s.addSegment(t,{segmentIndex:1,toolGroupId:e.viewportOptions.toolGroupId,properties:{label:"Segmentation 1",color:[255,0,0],opacity:255,visibility:!0,isLocked:!1,active:!0}}),console.log("MTOOLS",u.getButtonSection("MeasurementTools",{})),u.createButtonSection("primary",["MeasurementTools","Zoom","WindowLevel","Pan","Capture","Crosshairs","Panoramic","MoreTools","SegmentationTools"])}))}))}}))},style:{marginTop:"10%"}},"Create Segmentation For Selected Viewport")))}Te.propTypes={commandsManager:I().shape({runCommand:I().func.isRequired}),servicesManager:I().shape({services:I().shape({segmentationService:I().shape({getSegmentation:I().func.isRequired,getSegmentations:I().func.isRequired,toggleSegmentationVisibility:I().func.isRequired,subscribe:I().func.isRequired,EVENTS:I().object.isRequired}).isRequired}).isRequired}).isRequired};const Ce=({commandsManager:e,servicesManager:t,extensionManager:n,configuration:o,title:a})=>{const{customizationService:i}=t.services;return[{name:"panelSegmentation",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:o=>{const[a]=(0,S.M)();return r.createElement(Te,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...o,disableEditing:a.disableEditing,...i.get("segmentation.panel")}})}},{name:"panelSegmentationWithTools",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:o=>{const[a]=(0,S.M)();return r.createElement(r.Fragment,null,r.createElement(v.vb,{commandsManager:e,servicesManager:t,extensionManager:n,buttonSectionId:"segmentationToolbox",title:"Segmentation Tools",configuration:{...o}}),r.createElement(Te,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...o,disableEditing:a.disableEditing,...i.get("segmentation.panel")}}))}}]};var De=n(60318),Ve=n(54131),Re=n(8455);async function Me({viewportId:e,loadFn:t,servicesManager:n,displaySet:o,initialSliceIndex:a=null}){const{cornerstoneViewportService:r,segmentationService:i,viewportGridService:l}=n.services,c=Ae({viewportId:e,viewportGridService:l}),m=c.viewportOptions.viewportId,d=o?.referencedDisplaySetInstanceUID||c?.displaySetInstanceUIDs[0],p=Oe({viewportId:e,servicesManager:n,displaySet:o}),g=async()=>{const e=await t();i.hydrateSegmentation(e)},u=Array.from(s.cache._volumeCache.keys()).some((e=>e.includes(d)));return p.forEach((async e=>{e.viewportOptions={...e.viewportOptions,viewportType:"RTSTRUCT"===o?.Modality?"stack":"volume",needsRerendering:!0};const t=e.viewportId;t===m&&(e.viewportOptions.initialImageOptions={index:a,useOnce:!0});const n=r.getCornerstoneViewport(t),i=n.getCamera();if((u||"RTSTRUCT"===o.Modality)&&t===m)return void await g();const l=async e=>{const n=e.detail.volumeActors?.find((e=>e.uid.includes(d))),o=r.getCornerstoneViewport(t);o.setCamera(i),o.element.removeEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,l),n&&t===m&&await g()};n.element.addEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,l)})),l.setDisplaySetsForViewports(p),!0}const Ae=({viewportId:e,viewportGridService:t})=>{const{viewports:n,activeViewportId:o}=t.getState(),a=e||o;return n.get(a)};function Oe({viewportId:e,servicesManager:t,displaySet:n}){const{hangingProtocolService:o,displaySetService:a,segmentationService:r,viewportGridService:i}=t.services,{viewports:s,isHangingProtocolLayout:l}=i.getState(),c=Ae({viewportId:e,viewportGridService:i}).viewportOptions.viewportId,m=s.get(c).displaySetInstanceUIDs,d=n?.referencedDisplaySetInstanceUID||m[0],p=a.getDisplaySetByUID(d).instances[0].FrameOfReferenceUID,g=o.getViewportsRequireUpdate(c,d,l);return s.forEach(((e,t)=>{if(c===t||g.find((e=>e.viewportId===t)))return;r.shouldRenderSegmentation(e.displaySetInstanceUIDs,p)&&g.push({viewportId:t,displaySetInstanceUIDs:e.displaySetInstanceUIDs,viewportOptions:{viewportType:"RTSTRUCT"===n?.Modality?"stack":"volume",needsRerendering:!0}})})),g.filter((e=>"volume3d"!==e.viewportOptions?.viewportType))}const{segmentation:ke}=l.utilities,{datasetToBlob:Ge}=m.default.data,{Cornerstone3D:{Segmentation:{generateLabelMaps2DFrom3D:Fe,generateSegmentation:Le}}}=c.adaptersSEG,{Cornerstone3D:{RTSS:{generateRTSSFromSegmentations:Pe}}}=c.adaptersRT,{downloadDICOMData:_e}=c.helpers,Ue=({servicesManager:e,extensionManager:t})=>{const{uiNotificationService:n,segmentationService:o,uiDialogService:a,displaySetService:r,viewportGridService:c,toolGroupService:d,cornerstoneViewportService:p}=e.services,g={getUpdatedViewportsForSegmentation:Oe,createEmptySegmentationForViewport:async({viewportId:t})=>{const a=Ae({viewportId:t,viewportGridService:c}),i=a.displaySetInstanceUIDs[0],s=r.getDisplaySetByUID(i);s.isReconstructable?Me({viewportId:t,servicesManager:e,displaySet:s,loadFn:async()=>{const e=o.getSegmentations(),t=await o.createSegmentationForDisplaySet(i,{label:`Segmentation ${e.length+1}`}),n=a.viewportOptions.toolGroupId;return await o.addSegmentationRepresentationToToolGroup(n,t),o.addSegment(t,{toolGroupId:n,segmentIndex:1,properties:{label:"Segment 1"}}),t}}):n.show({title:"Segmentation",message:"Segmentation is not supported for non-reconstructible displaysets yet",type:"error"})},loadSegmentationsForViewport:async({segmentations:t,viewportId:n})=>{Me({viewportId:n,servicesManager:e,loadFn:async()=>{const e=Ae({viewportId:n,viewportGridService:c}),a=e.displaySetInstanceUIDs[0],r=t[0],i=r.id,s=r.label,l=r.segments;if(delete r.segments,await o.createSegmentationForDisplaySet(a,{segmentationId:i,label:s}),r.scalarData){o.getLabelmapVolume(i).scalarData.set(r.scalarData)}o.addOrUpdateSegmentation(r);const m=e.viewportOptions.toolGroupId;return await o.addSegmentationRepresentationToToolGroup(m,i),l.forEach((e=>{null!==e&&o.addSegment(i,{segmentIndex:e.segmentIndex,toolGroupId:m,properties:{color:e.color,label:e.label,opacity:e.opacity,isLocked:e.isLocked,visibility:e.isVisible,active:r.activeSegmentIndex===e.segmentIndex}})})),r.centroidsIJK&&o.setCentroids(r.id,r.centroidsIJK),i}})},loadSegmentationDisplaySetsForViewport:async({viewportId:t,displaySets:n})=>{const a=n[0],i=r.getDisplaySetByUID(a.referencedDisplaySetInstanceUID),s=p.getCornerstoneViewport(t).getSliceIndex();Me({viewportId:t,servicesManager:e,displaySet:a,loadFn:async()=>{const e=a,t="SEG"===e.Modality?"createSegmentationForSEGDisplaySet":"createSegmentationForRTDisplaySet",n=o[t].bind(o),r=await n(e,null,!1);return o.getSegmentation(r).description=`S${i.SeriesNumber}: ${i.SeriesDescription}`,r},initialSliceIndex:s})},generateSegmentation:({segmentationId:e,options:t={}})=>{const n=l.segmentation.state.getSegmentation(e),{referencedVolumeId:a}=n.representationData.LABELMAP,r=s.cache.getVolume(e),i=s.cache.getVolume(a).getCornerstoneImages(),c=Fe(r);c.metadata=[];o.getSegmentation(e).segments.forEach((e=>{if(!e)return;const t=e.segmentIndex,{label:n,color:o}=e,a=m.default.data.Colors.rgb2DICOMLAB(o.slice(0,3).map((e=>e/255))).map((e=>Math.round(e))),r={SegmentNumber:t.toString(),SegmentLabel:n,SegmentAlgorithmType:e?.algorithmType||"MANUAL",SegmentAlgorithmName:e?.algorithmName||"OHIF Brush",RecommendedDisplayCIELabValue:a,SegmentedPropertyCategoryCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"},SegmentedPropertyTypeCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"}};c.metadata[t]=r}));return Le(i,c,s.metaData,t)},downloadSegmentation:({segmentationId:e})=>{const t=o.getSegmentation(e),n=g.generateSegmentation({segmentationId:e});_e(n.dataset,`${t.label}`)},storeSegmentation:async({segmentationId:e,dataSource:n})=>{const r=await(0,x.createReportDialogPrompt)(a,{extensionManager:t});if(1!==r.action&&r.value)return;const s=o.getSegmentation(e);if(!s)throw new Error("No segmentation found");const{label:l}=s,c=r.value||l||"Research Derived Series",m=g.generateSegmentation({segmentationId:e,options:{SeriesDescription:c}});if(!m||!m.dataset)throw new Error("Error during segmentation generation");const{dataset:d}=m;return await n.store.dicom(d),d.wadoRoot=n.getConfig().wadoRoot,i.DicomMetadataStore.addInstances([d],!0),d},downloadRTSS:({segmentationId:e})=>{const t=o.getSegmentation(e),n={vtkImageMarchingSquares:De.ZP,vtkDataArray:Ve.default,vtkImageData:Re.ZP},a=Pe(t,i.classes.MetadataProvider,i.DicomMetadataStore,s.cache,l.Enums,n);try{const e=Ge(a),t=URL.createObjectURL(e);window.location.assign(t)}catch(e){console.warn(e)}},setBrushSize:({value:e,toolNames:t})=>{const n=Number(e);d.getToolGroupIds()?.forEach((e=>{0===t?.length?ke.setBrushSizeForToolGroup(e,n):t?.forEach((t=>{ke.setBrushSizeForToolGroup(e,n,t)}))}))},setThresholdRange:({value:e,toolNames:t=["ThresholdCircularBrush","ThresholdSphereBrush"]})=>{d.getToolGroupIds()?.forEach((n=>{const o=d.getToolGroup(n);t?.forEach((t=>{o.setToolConfiguration(t,{strategySpecificConfiguration:{THRESHOLD:{threshold:e}}})}))}))}},u={getUpdatedViewportsForSegmentation:{commandFn:g.getUpdatedViewportsForSegmentation},loadSegmentationDisplaySetsForViewport:{commandFn:g.loadSegmentationDisplaySetsForViewport},loadSegmentationsForViewport:{commandFn:g.loadSegmentationsForViewport},createEmptySegmentationForViewport:{commandFn:g.createEmptySegmentationForViewport},generateSegmentation:{commandFn:g.generateSegmentation},downloadSegmentation:{commandFn:g.downloadSegmentation},storeSegmentation:{commandFn:g.storeSegmentation},downloadRTSS:{commandFn:g.downloadRTSS},setBrushSize:{commandFn:g.setBrushSize},setThresholdRange:{commandFn:g.setThresholdRange}};return{actions:g,definitions:u,defaultContext:"SEGMENTATION"}};function ze(){return ze=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)({}).hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},ze.apply(null,arguments)}const Be=r.lazy((()=>n.e(315).then(n.bind(n,88315)))),We=e=>r.createElement(r.Suspense,{fallback:r.createElement("div",null,"Loading...")},r.createElement(Be,e)),je={id:o,getPanelModule:Ce,getCommandsModule:Ue,getToolbarModule:function({servicesManager:e}){const{segmentationService:t,toolbarService:n,toolGroupService:o}=e.services;return[{name:"evaluate.cornerstone.segmentation",evaluate:({viewportId:e,button:a,toolNames:r,disabledText:i})=>{const s=t.getSegmentations();if(!s?.length)return{disabled:!0,className:"!text-common-bright !bg-black opacity-50",disabledText:i??"No segmentations available"};const l=o.getToolGroupForViewport(e);if(!l)return{disabled:!0,className:"!text-common-bright ohif-disabled",disabledText:i??"Not available on the current viewport"};const c=n.getToolNameForButton(a);if(!l.hasTool(c)&&!r)return{disabled:!0,className:"!text-common-bright ohif-disabled",disabledText:i??"Not available on the current viewport"};const m=r?r.includes(l.getActivePrimaryMouseButtonTool()):l.getActivePrimaryMouseButtonTool()===c;return{disabled:!1,className:m?"!text-black !bg-primary-light hover:bg-primary-light hover-text-black hover:cursor-pointer":"!text-common-bright !bg-black hover:bg-primary-light hover:cursor-pointer hover:text-black",isActive:m}}}]},getViewportModule:({servicesManager:e,extensionManager:t,commandsManager:n})=>[{name:"dicom-seg",component:o=>r.createElement(We,ze({servicesManager:e,extensionManager:t,commandsManager:n},o))}],getSopClassHandlerModule:u,getHangingProtocolModule:f}}}]);
//# sourceMappingURL=206.bundle.326eeead9e8a028b961f.js.map