"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[8206,4757],{80477:(e,t,n)=>{n.r(t),n.d(t,{default:()=>je});const o=JSON.parse('{"u2":"@ohif/extension-cornerstone-dicom-seg"}').u2,a=`${o}.sopClassHandlerModule.dicom-seg`;var r=n(43001),i=n(84793),s=n(62709),l=n(93725),c=n(91202),m=n(67540);const d=["1.2.840.10008.5.1.4.1.1.66.4"],p={};function g(e,t,n){const o=e[0],{StudyInstanceUID:r,SeriesInstanceUID:g,SOPInstanceUID:u,SeriesDescription:S,SeriesNumber:f,SeriesDate:E,SOPClassUID:v,wadoRoot:x,wadoUri:h,wadoUriRoot:y}=o,I={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:i.utils.guid(),SeriesDescription:S,SeriesNumber:f,SeriesDate:E,SOPInstanceUID:u,SeriesInstanceUID:g,StudyInstanceUID:r,SOPClassHandlerId:a,SOPClassUID:v,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:d,instance:o,instances:[o],wadoRoot:x,wadoUriRoot:y,wadoUri:h,isOverlayDisplaySet:!0},w=o.ReferencedSeriesSequence;if(!w)return void console.error("ReferencedSeriesSequence is missing for the SEG");const b=w[0]||w;return I.referencedImages=o.ReferencedSeriesSequence.ReferencedInstanceSequence,I.referencedSeriesInstanceUID=b.SeriesInstanceUID,I.getReferenceDisplaySet=()=>{const{displaySetService:e}=t.services,n=e.getDisplaySetsForSeries(I.referencedSeriesInstanceUID);if(!n||0===n.length)throw new Error("Referenced DisplaySet is missing for the SEG");const o=n[0];I.referencedDisplaySetInstanceUID=o.displaySetInstanceUID,I.referencedVolumeURI=o.displaySetInstanceUID;const a=`cornerstoneStreamingImageVolume:${I.referencedVolumeURI}`;return I.referencedVolumeId=a,o},I.load=async({headers:e})=>await function(e,t,n,o){const{SOPInstanceUID:a}=e,{segmentationService:r}=t.services;if((e.loading||e.isLoaded)&&p[a]&&function(e,t){return t.getSegmentation(e.displaySetInstanceUID)}(e,r))return p[a];return e.loading=!0,p[a]=new Promise((async(a,i)=>{e.segments&&0!==Object.keys(e.segments).length||await async function({extensionManager:e,servicesManager:t,segDisplaySet:n,headers:o}){const a=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{segmentationService:r,uiNotificationService:i}=t.services,{dicomLoaderService:d}=a.exports,p=await d.findDicomDataPromise(n,null,o),g=s.cache.getVolume(n.referencedVolumeId);if(!g)throw new Error("Referenced Volume is missing for the SEG, and stack viewport SEG is not supported yet");const{imageIds:u}=g,S=.001,f=!0;s.eventTarget.addEventListener(c.Y.Events.SEGMENTATION_LOAD_PROGRESS,(e=>{const{percentComplete:t}=e.detail;r._broadcastEvent(r.EVENTS.SEGMENT_LOADING_COMPLETE,{percentComplete:t})}));const E=await c.adaptersSEG.Cornerstone3D.Segmentation.generateToolState(u,p,s.metaData,{skipOverlapping:f,tolerance:S,eventTarget:s.eventTarget,triggerEvent:s.triggerEvent});let v=!0;E.segMetadata.data.forEach(((e,t)=>{var n;t>0&&(e.rgba=e.RecommendedDisplayCIELabValue,e.rgba?e.rgba=(n=e.rgba,m.default.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)))):(v=!1,e.rgba=l.CONSTANTS.COLOR_LUT[t%l.CONSTANTS.COLOR_LUT.length]))})),E.overlappingSegments&&i.show({title:"Overlapping Segments",message:"Unsupported overlapping segments detected, segmentation rendering results may be incorrect.",type:"warning"});v||i.show({title:"DICOM SEG import",message:"RecommendedDisplayCIELabValue not found for one or more segments. The default color was used instead.",type:"warning",duration:5e3});Object.assign(n,E)}({extensionManager:n,servicesManager:t,segDisplaySet:e,headers:o});const d=!0;r.createSegmentationForSEGDisplaySet(e,null,d).then((()=>{e.loading=!1,a()})).catch((t=>{e.loading=!1,i(t)}))})),p[a]}(I,t,n,e),[I]}const u=function({servicesManager:e,extensionManager:t}){return[{name:"dicom-seg",sopClassUids:d,getDisplaySetsFromSeries:n=>g(n,e,t)}]},S={id:"@ohif/seg",name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId"}]}]}]};const f=function(){return[{name:S.id,protocol:S}]};var E=n(52490),v=n(47316),x=n(68968),h=n(3827),y=n.n(h);let I=function(e){return e.Expanded="expanded",e.Dropdown="dropdown",e}({});const w=function(e,t,n){const o="enter-segment-label",a=({action:t,value:a})=>{switch(t.id){case"save":n(a.label,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:o})};e&&e.create({id:o,centralize:!0,isDraggable:!1,showOverlay:!0,content:v.Vq,contentProps:{title:"Segment",value:{label:t},noCloseButton:!0,onClose:()=>e.dismiss({id:o}),actions:[{id:"cancel",text:"Cancel",type:v.LZ.dt.secondary},{id:"save",text:"Confirm",type:v.LZ.dt.primary}],onSubmit:a,body:({value:e,setValue:t})=>r.createElement(v.II,{label:"Enter the segment label",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,className:"border-primary-main bg-black",type:"text",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&a({value:e,action:{id:"save"}})}})}})};var b=n(22831);const N=function(e,t,n){const o="pick-color",a=({action:t,value:a})=>{switch(t.id){case"save":n(a.rgbaColor,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:o})};e&&e.create({id:o,centralize:!0,isDraggable:!1,showOverlay:!0,content:v.Vq,contentProps:{title:"Segment Color",value:{rgbaColor:t},noCloseButton:!0,onClose:()=>e.dismiss({id:o}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:a,body:({value:e,setValue:t})=>r.createElement(b.AI,{color:e.rgbaColor,onChange:e=>{t({rgbaColor:e.rgb})},presetColors:[],width:300})}})};var T=n(33901),D=n.n(T),C=n(58682),R=n(20779),V=n(24738);const A=({value1:e,value2:t,onChange:n,minValue:o,maxValue:a,step:i=1,unit:s="",containerClassName:l,inputClassName:c,labelClassName:m,labelVariant:d,showLabel:p=!0,labelPosition:g="",trackColor:u})=>{const[S,f]=(0,r.useState)(e),[E,x]=(0,r.useState)(t);(0,r.useEffect)((()=>{e<o||(f(e),t>a||x(t))}),[e,t]);const h=e=>{const t=Number(e.target.value);t<o||(f(t),n(t,E))},y=e=>{const t=Number(e.target.value);t>a||(x(t),n(S,t))},I=i>=1?S.toFixed(0):S.toFixed(1),w=i>=1?E.toFixed(0):E.toFixed(1);return r.createElement("div",{style:{flexDirection:"column"},className:`flex items-center cursor-pointer space-x-1 ${l||""}`},p&&"left"===g&&r.createElement(r.Fragment,null,r.createElement(V.Z,{variant:d??"subtitle",component:"p",className:D()("w-8",m??"text-white")},I,s),r.createElement(V.Z,{variant:d??"subtitle",component:"p",className:D()("w-8",m??"text-white")},w,s)),r.createElement("div",{style:{flexDirection:"row"},className:"flex pb-[5px]"},r.createElement("input",{type:"range",min:o,max:a,value:S,className:`appearance-none h-[3px] rounded-lg input-range-thumb-design ${c||""}`,style:{background:"#3a3f99"},onChange:h,id:"myRange1",step:i}),r.createElement("input",{type:"range",min:o,max:a,value:E,className:`appearance-none h-[3px] rounded-lg input-range-thumb-design ${c||""}`,style:{background:"#3a3f99"},onChange:y,id:"myRange2",step:i})),p&&(!g||"right"===g)&&r.createElement("div",{style:{flexDirection:"row",width:"100%"},className:"flex pb-[5px]"},r.createElement(V.Z,{variant:d??"subtitle",component:"p",className:D()("w-1/2",m??"text-white","flex","justify-center")},"Min : ",I,s),r.createElement(V.Z,{variant:d??"subtitle",component:"p",className:D()("w-1/2",m??"text-white","flex","justify-center")},"Max : ",w,s)),r.createElement("div",{className:"flex",style:{width:"100%"}},r.createElement("div",{className:"flex w-1/2 justify-center"},r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{h({target:{value:S-10}})}},"--"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{h({target:{value:S-1}})}},"-"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{h({target:{value:S+1}})}},"+"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{h({target:{value:S+10}})}},"++")),r.createElement("div",{className:"flex w-1/2 justify-center"},r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{y({target:{value:E-10}})}},"--"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{y({target:{value:E-1}})}},"-"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{y({target:{value:E+1}})}},"+"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{y({target:{value:E+10}})}},"++"))))};var M=n(69190);const{Enums:O}=l,{MouseBindings:k,Events:L}=O,F=({label:e,activeMode:t,eraseReplaceFocus:n})=>{const o=e===n;return"All"===e&&t===U.REPLACE&&(e="Background"),r.createElement("div",{className:D()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var G=function(e){return e.CIRCLE="CIRCLE",e.SPHERE="SPHERE",e}(G||{}),U=function(e){return e.FILL="FILL",e.THRESHOLD="THRESHOLD",e.ERASE="ERASE",e.REPLACE="REPLACE",e}(U||{});const P=[];function _({segmentationService:e,cornerstoneViewportService:t}){const{t:n}=(0,M.$G)("Buttons"),[o,a]=(0,r.useState)(!1),[i,c]=(0,r.useState)(!0),[m,d]=(0,r.useState)("All"),[p,g]=(0,r.useState)({active:!1,minimum:!0}),[{activeViewportId:u},S]=(0,v.O_)(),[f,E]=(0,r.useState)(U.FILL),[x,h]=(0,r.useState)(G.CIRCLE),[y,I]=(0,r.useState)(10),[w,b]=(0,r.useState)(35),[N,T]=(0,r.useState)(.4),[V,O]=(0,r.useState)([-1e3,3095]),[_,z]=(0,r.useState)(0),[B,W]=(0,r.useState)([]),j=t=>{let n=[{label:"All",segmentIndex:0},...e.getSegmentations().filter((e=>e.isActive))[0].segments.filter((e=>e))];n=n.map((e=>({...e,onClick:e=>((e,t)=>{const{label:n,segmentIndex:o}=e,a=t.configuration.strategySpecificConfiguration;a.REPLACE.targetSegmentIndex=o,t.setConfiguration({eraseFocusIndex:o,strategySpecificConfiguration:a}),d(n)})(e,t)}))),W(n)};(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(u),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId),o=n.getToolInstance("Brush");E(U.FILL),h(G.CIRCLE);const a=t.getViewportInfo(u).viewportData.data[0].volume,r=Math.min(...a.spacing),i=Math.floor(o.configuration.brushSize/r),s=Math.min(Math.floor(Math.min(...a.dimensions)/2),35);T(r),I(i),b(s),O(o.configuration.strategySpecificConfiguration.THRESHOLD.threshold),z(o.configuration.strategySpecificConfiguration.REPLACE.targetSegmentIndex),j(o),n.setToolActive("Undo",{bindings:[{mouseButton:k.Primary}]})}),[]),(0,r.useEffect)((()=>{const n=t.getCornerstoneViewport(u),o=l.ToolGroupManager.getToolGroupForViewport(n.id,n.renderingEngineId).getToolInstance("Brush"),a=e.EVENTS.SEGMENTATION_ADDED,r=e.EVENTS.SEGMENTATION_UPDATED,i=e.EVENTS.SEGMENTATION_REMOVED,s=[];return[a,r,i].forEach((t=>{const{unsubscribe:n}=e.subscribe(t,(()=>{j(o)}));s.push(n)})),()=>{s.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(u);var n,o;l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("Brush").setConfiguration({brushSize:y*N,activeStrategy:(n=x,o=f,o+"_INSIDE_"+n),strategySpecificConfiguration:{THRESHOLD:{threshold:V},REPLACE:{targetSegmentIndex:_}}})}),[y,x,f,V]);return(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(u),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId),o=e.element;o.addEvent=(e,t)=>{P[e]&&(o.removeEventListener(e,P[e]),P[e]=null),P[e]=t,o.addEventListener(e,t)},o.removeEvent=e=>{o.removeEventListener(e,P[e]),P[e]=null},p.active?(n.setToolPassive("Brush"),n.setToolActive("DragProbe",{bindings:[{mouseButton:k.Primary}]}),o.addEvent(L.MOUSE_DRAG,(e=>{((e,n)=>{if(1===e.detail.mouseButton){const o=t.getCornerstoneViewport(u),a=e.detail.currentPoints.world,r=o.getImageData(),i=r.imageData.worldToIndex(a).map(Math.round),{scalarData:l,dimensions:c}=r;if(s.utilities.indexWithinDimensions(i,c)){const e=c[0],t=c[0]*c[1],o=l[i[2]*t+i[1]*e+i[0]];O(n?[o,V[1]]:[V[0],o])}}})(e,p.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("Brush",{bindings:[{mouseButton:k.Primary}]}),o.removeEvent(L.MOUSE_DRAG))}),[p.active,p.minimum]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(C.Z,{name:"panel-group-open-close",className:D()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Paint Brush Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Tool and mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:x===G.CIRCLE?"primary":"secondary",onClick:()=>{h(G.CIRCLE)}},"Circle"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:x===G.SPHERE?"primary":"secondary",onClick:()=>{h(G.SPHERE)}},"Sphere")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:f===U.FILL?"primary":"secondary",onClick:()=>{E(U.FILL)}},"Fill"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:f===U.THRESHOLD?"primary":"secondary",onClick:()=>{E(U.THRESHOLD)}},"Threshold"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:f===U.ERASE?"primary":"secondary",onClick:()=>{E(U.ERASE)}},"Erase"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:f===U.REPLACE?"primary":"secondary",onClick:()=>{E(U.REPLACE)}},"Replace")),r.createElement("div",{className:"flex items-center col-span-2"},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Radius"),r.createElement(R.Z,{minValue:0,maxValue:w,value:y,onChange:e=>{I(e)},step:1,containerClassName:"mt-[4px] mb-[4px]",inputClassName:"w-[64px]",labelClassName:"text-white text-[12px]",unit:"px"})),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),c(!i)}},r.createElement(C.Z,{name:"panel-group-open-close",className:D()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!i})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase/replace options")),!i&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase/replace focus on:"),r.createElement(v.QE,{items:B,renderer:e=>F({...e,activeMode:f,eraseReplaceFocus:m})})))),f===U.THRESHOLD&&r.createElement("div",{className:"flex items-center col-span-2",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"h-[1px] bg-[#212456] mb-[8px] mx-1",style:{width:"100%"}}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Threshold values"),r.createElement(A,{minValue:-1e3,maxValue:3095,value1:V[0],value2:V[1],onChange:(e,t)=>{O([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:"HU"}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{g({active:!0,minimum:!0})}},"Minimum"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{g({active:!0,minimum:!1})}},"Maximum")),p.active&&r.createElement(v.zx,{size:"small",color:"secondary",onClick:()=>{g({active:!1,minimum:!0})}},"Back to annotation"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const z=({label:e,t,eraseFocus:n})=>{const o=e===n;return r.createElement("div",{className:D()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var B=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(B||{});function W({segmentationService:e,cornerstoneViewportService:t}){const{t:n}=(0,M.$G)("Buttons"),[o,a]=(0,r.useState)(!1),[i,s]=(0,r.useState)(B.FILL_INSIDE),[{activeViewportId:c},m]=(0,v.O_)(),[d,p]=(0,r.useState)([]),[g,u]=(0,r.useState)(!0),[S,f]=(0,r.useState)("All"),E=t=>{let n=[{label:"All",segmentIndex:0},...e.getSegmentations().filter((e=>e.isActive))[0].segments.filter((e=>e))];n=n.map((e=>({...e,onClick:e=>((e,t)=>{const{label:n,segmentIndex:o}=e;t.setConfiguration({eraseFocusIndex:o}),f(n)})(e,t)}))),p(n)};return(0,r.useEffect)((()=>{const n=t.getCornerstoneViewport(c),o=l.ToolGroupManager.getToolGroupForViewport(n.id,n.renderingEngineId).getToolInstance("CircleScissor"),a=e.EVENTS.SEGMENTATION_ADDED,r=e.EVENTS.SEGMENTATION_UPDATED,i=e.EVENTS.SEGMENTATION_REMOVED,s=[];return[a,r,i].forEach((t=>{e.subscribe(t,(()=>{E(o)}))})),()=>{s.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(c),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("CircleScissor");s(n.configuration.activeStrategy),E(n)}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(c);l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("CircleScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(C.Z,{name:"panel-group-open-close",className:D()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Circle Segmentation Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===B.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(B.FILL_INSIDE)}},"Fill"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===B.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(B.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),u(!g)}},r.createElement(C.Z,{name:"panel-group-open-close",className:D()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!g})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!g&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on:"),r.createElement(v.QE,{items:d,renderer:e=>z({...e,t:n,eraseFocus:S})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}function j({}){const[e,t]=(0,r.useState)(!1);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>t(!e)},r.createElement(C.Z,{name:"panel-group-open-close",className:D()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!e})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Fill Holes Tool Edit")),!e&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"No configurations for this tool")),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:H}=l,{MouseBindings:Z,Events:q}=H,$=[];function J({segmentationService:e,cornerstoneViewportService:t}){const[n,o]=(0,r.useState)(!1),[{activeViewportId:a},i]=(0,v.O_)(),[c,m]=(0,r.useState)([-1e3,3095]),[d,p]=(0,r.useState)(0),[g,u]=(0,r.useState)({active:!1,minimum:!0});(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(a),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("RectangleROIStartEndThreshold");p(n.configuration.numSlicesToPropagate)}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(a);l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("RectangleROIStartEndThreshold").setConfiguration({numSlicesToPropagate:d}),console.log("SET CONFIGURATION",d)}),[d]);(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(a),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId),o=e.element;o.addEvent=(e,t)=>{$[e]&&(o.removeEventListener(e,$[e]),$[e]=null),$[e]=t,o.addEventListener(e,t)},o.removeEvent=e=>{o.removeEventListener(e,$[e]),$[e]=null},g.active?(n.setToolPassive("RectangleROIStartEndThreshold"),n.setToolActive("DragProbe",{bindings:[{mouseButton:Z.Primary}]}),o.addEvent(q.MOUSE_DRAG,(e=>{((e,n)=>{if(1===e.detail.mouseButton){const o=t.getCornerstoneViewport(a),r=e.detail.currentPoints.world,i=o.getImageData(),l=i.imageData.worldToIndex(r).map(Math.round),{scalarData:d,dimensions:p}=i;if(s.utilities.indexWithinDimensions(l,p)){const e=p[0],t=p[0]*p[1],o=d[l[2]*t+l[1]*e+l[0]];m(n?[o,c[1]]:[c[0],o])}}})(e,g.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("RectangleROIStartEndThreshold",{bindings:[{mouseButton:Z.Primary}]}),o.removeEvent(q.MOUSE_DRAG))}),[g.active,g.minimum]);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>o(!n)},r.createElement(C.Z,{name:"panel-group-open-close",className:D()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!n})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"3D Rectangle Threshold Segmentation Tool Edit")),!n&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"flex items-center col-span-2",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Threshold values"),r.createElement(A,{minValue:-1e3,maxValue:5e3,value1:c[0],value2:c[1],onChange:(e,t)=>{m([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:""}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{u({active:!0,minimum:!0})}},"Minimum"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{u({active:!0,minimum:!1})}},"Maximum")),g.active&&r.createElement(v.zx,{size:"small",color:"secondary",onClick:()=>{u({active:!1,minimum:!0})}},"Back to annotation")),r.createElement("div",{className:"flex items-center col-span-2",style:{width:"100%",flexDirection:"column"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Slices Propagation"),r.createElement(R.Z,{minValue:0,maxValue:200,value:d,onChange:e=>{p(e)},step:1,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:""})),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const n=t.getCornerstoneViewport(a).getActors().map((e=>{const t=e.referenceId??e.uid;return s.cache.getVolume(t)})).filter((e=>!!e)),o=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIStartEndThreshold");if(!o)throw new Error("No annotation selected ");const r=o[0];if(!l.annotation.state.getAnnotation(r))return;const i=n.filter((e=>e.imageIds.length))[0],m=n.filter((e=>!e.imageIds.length))[0],d=e.getSegmentations();l.utilities.segmentation.rectangleROIThresholdVolumeByRange(o,m,[{volume:i,lower:c[0],upper:c[1]}],{numSlicesToProject:0,overwrite:!1,overlapType:1,segmentIndex:d[0].activeSegmentIndex})})()}},"Compute Threshold")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const e=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIStartEndThreshold");if(!e)throw new Error("No annotation selected ");console.log("selected annotation uid",e);const n=e[0];console.log("CSTOOLS STATE",l.annotation.state),l.annotation.state.removeAnnotation(n),t.getCornerstoneViewport(a).render()})()}},"Delete selected region"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:Q}=l,{MouseBindings:K,Events:X}=Q,Y=[];function ee({segmentationService:e,cornerstoneViewportService:t}){const[n,o]=(0,r.useState)(!1),[{activeViewportId:a},i]=(0,v.O_)(),[c,m]=(0,r.useState)([-1e3,3095]),[d,p]=(0,r.useState)({active:!1,minimum:!0});(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(a),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId),o=e.element;o.addEvent=(e,t)=>{Y[e]&&(o.removeEventListener(e,Y[e]),Y[e]=null),Y[e]=t,o.addEventListener(e,t)},o.removeEvent=e=>{o.removeEventListener(e,Y[e]),Y[e]=null},d.active?(n.setToolPassive("RectangleROIThreshold"),n.setToolActive("DragProbe",{bindings:[{mouseButton:K.Primary}]}),o.addEvent(X.MOUSE_DRAG,(e=>{((e,n)=>{if(1===e.detail.mouseButton){const o=t.getCornerstoneViewport(a),r=e.detail.currentPoints.world,i=o.getImageData(),l=i.imageData.worldToIndex(r).map(Math.round),{scalarData:d,dimensions:p}=i;if(s.utilities.indexWithinDimensions(l,p)){const e=p[0],t=p[0]*p[1],o=d[l[2]*t+l[1]*e+l[0]];m(n?[o,c[1]]:[c[0],o])}}})(e,d.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("RectangleROIThreshold",{bindings:[{mouseButton:K.Primary}]}),o.removeEvent(X.MOUSE_DRAG))}),[d.active,d.minimum]);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>o(!n)},r.createElement(C.Z,{name:"panel-group-open-close",className:D()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!n})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Rectangle Threshold Segmentation Tool Edit")),!n&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"flex items-center col-span-2 pb-[9px]",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pb-[3px]",style:{width:"100%"}},"Threshold values"),r.createElement(A,{minValue:-1e3,maxValue:5e3,value1:c[0],value2:c[1],onChange:(e,t)=>{m([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full pb-[3px]",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:"HU"}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{p({active:!0,minimum:!0})}},"Minimum"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{p({active:!0,minimum:!1})}},"Maximum")),d.active&&r.createElement(v.zx,{size:"small",color:"secondary",onClick:()=>{p({active:!1,minimum:!0})}},"Back to annotation")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const n=t.getCornerstoneViewport(a).getActors().map((e=>{const t=e.referenceId??e.uid;return s.cache.getVolume(t)})).filter((e=>!!e)),o=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIThreshold");if(!o)throw new Error("No annotation selected ");const r=o[0];if(!l.annotation.state.getAnnotation(r))return;const i=n.filter((e=>e.imageIds.length))[0],m=n.filter((e=>!e.imageIds.length))[0],d=e.getSegmentations();l.utilities.segmentation.rectangleROIThresholdVolumeByRange(o,m,[{volume:i,lower:c[0],upper:c[1]}],{numSlicesToProject:0,overwrite:!1,overlapType:1,segmentIndex:d[0].activeSegmentIndex})})()}},"Compute Threshold")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const e=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIThreshold");if(!e)throw new Error("No annotation selected ");console.log("selected annotation uid",e);const n=e[0];console.log("CSTOOLS STATE",l.annotation.state),l.annotation.state.removeAnnotation(n),t.getCornerstoneViewport(a).render()})()}},"Delete selected region"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const te=({label:e,t,eraseFocus:n})=>{const o=e===n;return r.createElement("div",{className:D()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var ne=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(ne||{});function oe({segmentationService:e,cornerstoneViewportService:t}){const{t:n}=(0,M.$G)("Buttons"),[o,a]=(0,r.useState)(!1),[i,s]=(0,r.useState)(ne.FILL_INSIDE),[{activeViewportId:c},m]=(0,v.O_)(),[d,p]=(0,r.useState)([]),[g,u]=(0,r.useState)(!0),[S,f]=(0,r.useState)("All"),E=t=>{let n=[{label:"All",segmentIndex:0},...e.getSegmentations().filter((e=>e.isActive))[0].segments.filter((e=>e))];n=n.map((e=>({...e,onClick:e=>((e,t)=>{const{label:n,segmentIndex:o}=e;t.setConfiguration({eraseFocusIndex:o}),f(n)})(e,t)}))),p(n)};return(0,r.useEffect)((()=>{const n=t.getCornerstoneViewport(c),o=l.ToolGroupManager.getToolGroupForViewport(n.id,n.renderingEngineId).getToolInstance("RectangleScissor"),a=e.EVENTS.SEGMENTATION_ADDED,r=e.EVENTS.SEGMENTATION_UPDATED,i=e.EVENTS.SEGMENTATION_REMOVED,s=[];return[a,r,i].forEach((t=>{e.subscribe(t,(()=>{E(o)}))})),()=>{s.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(c),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("RectangleScissor");s(n.configuration.activeStrategy),E(n)}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(c);l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("RectangleScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(C.Z,{name:"panel-group-open-close",className:D()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Rectangle Scissors Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===ne.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(ne.FILL_INSIDE)}},"Fill"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===ne.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(ne.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),u(!g)}},r.createElement(C.Z,{name:"panel-group-open-close",className:D()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!g})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!g&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on:"),r.createElement(v.QE,{items:d,renderer:e=>te({...e,t:n,eraseFocus:S})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}const ae=({label:e,t,eraseFocus:n})=>{const o=e===n;return r.createElement("div",{className:D()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",o&&"bg-primary-dark",o?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var re=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(re||{});function ie({segmentationService:e,cornerstoneViewportService:t}){const{t:n}=(0,M.$G)("Buttons"),[o,a]=(0,r.useState)(!1),[i,s]=(0,r.useState)(re.FILL_INSIDE),[{activeViewportId:c},m]=(0,v.O_)(),[d,p]=(0,r.useState)([]),[g,u]=(0,r.useState)(!0),[S,f]=(0,r.useState)("All"),E=t=>{let n=[{label:"All",segmentIndex:0},...e.getSegmentations().filter((e=>e.isActive))[0].segments.filter((e=>e))];n=n.map((e=>({...e,onClick:e=>((e,t)=>{const{label:n,segmentIndex:o}=e;t.setConfiguration({eraseFocusIndex:o}),f(n)})(e,t)}))),p(n)};return(0,r.useEffect)((()=>{const n=t.getCornerstoneViewport(c),o=l.ToolGroupManager.getToolGroupForViewport(n.id,n.renderingEngineId).getToolInstance("SphereScissor"),a=e.EVENTS.SEGMENTATION_ADDED,r=e.EVENTS.SEGMENTATION_UPDATED,i=e.EVENTS.SEGMENTATION_REMOVED,s=[];return[a,r,i].forEach((t=>{e.subscribe(t,(()=>{E(o)}))})),()=>{s.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(c),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("SphereScissor");s(n.configuration.activeStrategy),E(n)}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(c);l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("SphereScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!o)},r.createElement(C.Z,{name:"panel-group-open-close",className:D()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Sphere Scissors Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===re.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(re.FILL_INSIDE)}},"Fill"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===re.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(re.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),u(!g)}},r.createElement(C.Z,{name:"panel-group-open-close",className:D()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!g})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!g&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on:"),r.createElement(v.QE,{items:d,renderer:e=>ae({...e,t:n,eraseFocus:S})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:se}=l,{Events:le}=se;const ce=new class extends Array{constructor(e){super(),this.maxLength=void 0,this.maxLength=e}push(...e){const t=super.push(...e);if(this.length>this.maxLength){const e=this.length-this.maxLength;this.splice(0,e)}return t}}(10);function me({segmentationService:e,cornerstoneViewportService:t}){const{t:n}=(0,M.$G)("Buttons"),[o,a]=(0,r.useState)(!1),[{activeViewportId:i},s]=(0,v.O_)(),[l,c]=(0,r.useState)(ce.length);(0,r.useEffect)((()=>{t.getCornerstoneViewport(i).element.addEventListener(le.MOUSE_DOWN,(t=>{const n=e.getSegmentations()[0],o=new Uint8ClampedArray(e.getLabelmapVolume(n.id).getScalarData());10===ce.length&&ce.shift(),ce.push(o),c(ce.length)}))}),[]);const m=e=>{const n=t.getCornerstoneViewport(i).element,o=ce[e];if(!o)return;const a=new CustomEvent("UNDO_REDO_TOOL",{detail:{element:n,oldScalarData:o}});window.dispatchEvent(a),c(e)};return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),a(!o)}},r.createElement(C.Z,{name:"panel-group-open-close",className:D()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Undo/redo Segmentation")),!o&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px] pt-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly inline-flex"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{l>0&&m(l-1)}},"Undo"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{l<10&&m(l+1)}},"Redo"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:de}=l,{Events:pe}=de,{state:ge}=l,ue=["Brush","CircleScissor","PaintFill","RectangleROIStartEndThreshold","RectangleROIThreshold","RectangleScissor","SphereScissor"];function Se({segmentationService:e,cornerstoneViewportService:t,toolbarService:n}){const[o,a]=(0,r.useState)(null),i=()=>{const e=ge.toolGroups.filter((e=>"mpr"===e.id))[0]?.toolOptions;e||a(null);const t=Object.entries(e).find((([e,t])=>ue.includes(e)&&"Active"===t.mode));a(t?t[0]:null)};(0,r.useEffect)((()=>{i()}),[]),(0,r.useEffect)((()=>{const{unsubscribe:e}=n.subscribe(n.EVENTS.TOOL_BAR_MODIFIED,i);return()=>{e()}}),[n]);return r.createElement(r.Fragment,null,o&&r.createElement(me,{cornerstoneViewportService:t,segmentationService:e}),(()=>{switch(o){case"Brush":return r.createElement(_,{cornerstoneViewportService:t,segmentationService:e});case"CircleScissor":return r.createElement(W,{cornerstoneViewportService:t,segmentationService:e});case"PaintFill":return r.createElement(j,null);case"RectangleROIStartEndThreshold":return r.createElement(J,{cornerstoneViewportService:t,segmentationService:e});case"RectangleROIThreshold":return r.createElement(ee,{cornerstoneViewportService:t,segmentationService:e});case"RectangleScissor":return r.createElement(oe,{cornerstoneViewportService:t,segmentationService:e});case"SphereScissor":return r.createElement(ie,{cornerstoneViewportService:t,segmentationService:e});default:return null}})())}var fe=n(74208);function Ee({segmentations:e,segmentationService:t}){const[n,o]=(0,r.useState)(!1),[{activeViewportId:a,viewports:i},s]=(0,v.O_)();return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark pt-[6px] pb-[6px]"},r.createElement("p",{className:"text-[#d8d8d8] text-[12px] font-[300] pl-[9px] pr-[9px] pb-[6px] flex"},"Configuration"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly flex"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{console.log("SEGS AT IMPORT",e);const n=document.createElement("input");n.type="file",n.accept="application/json",n.onchange=o=>{const r=Array.from(n.files)[0],s=new FileReader;s.onload=function(n){try{if("string"==typeof n.target.result){for(let n=1;n<e[0].segments.length;n++)t.removeSegment(e[0].id,n);const o=JSON.parse(n.target.result);for(const n of o)if(n){const{segmentIndex:o}=n;t.addSegment(e[0].id,{segmentIndex:o,toolGroupId:i.get(a).viewportOptions.toolGroupId,properties:n,override:!0})}}else console.error("ERROR::JSON_READING::CORRUPTED_CONTENT")}catch(e){console.error("ERROR::JSON_READING",e)}},s.readAsText(r)},n.click()}},"Import"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{const t=JSON.stringify(e[0].segments),n=new Blob([t],{type:"text/plain;charset=utf-8"});(0,fe.saveAs)(n,"segments_configuration.json")}},"Export"))),r.createElement("div",{className:"h-[6px] bg-black "}))}Ee.propTypes={segmentations:y().array.isRequired};const ve=Ee;var xe=n(17816),he=n.n(xe);n(17854);function ye({segmentations:e,segmentationService:t,cornerstoneViewportService:n,panoramicService:o}){const[a,i]=(0,r.useState)(!1),[c,m]=(0,r.useState)(0),[d,p]=(0,r.useState)(!1),[{activeViewportId:g,viewports:u},S]=(0,v.O_)();(0,r.useEffect)((()=>{}),[a]);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark pt-[6px] pb-[6px]"},r.createElement("p",{className:"text-[#d8d8d8] text-[12px] font-[300] pl-[9px] pr-[9px] pb-[6px] flex"},"Segmentation"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly flex"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:async()=>{console.log("SEGS AT IMPORT",e);let o=u.get(g);"volume"!==o.viewportOptions.viewportType&&(o=Array.from(u.values()).find((e=>"volume"===e.viewportOptions.viewportType)),console.assert(o,'ImportSegmentation: Could not find "volume" viewport'),S.setActiveViewportId(o.viewportId));const a=n.getCornerstoneViewport(o.viewportId).getActors();console.assert(a&&a.length,"ImportSegmentation: No actors on volume viewport");const r=a.map((e=>s.cache.getVolume(e.referenceId??e.uid))).filter((e=>!e.imageIds.length))[0];if(!r){const n={label:`Segmentation ${e.length+1}`},a=await t.createSegmentationForDisplaySet(o.displaySetInstanceUIDs[0],n),r=t.getSegmentation(a);console.log("CREATED SEGMENTATION",r);const i=l.Enums.SegmentationRepresentations.Labelmap;await t.addSegmentationRepresentationToToolGroup("mpr",a,!0,i),t.setActiveSegmentationForToolGroup(a,"mpr")}const i=r.volumeId,c=r.getScalarData(),m=document.createElement("input");m.type="file",m.accept="application/octet-stream",m.onchange=async e=>{const t=Array.from(m.files)[0],n=new FileReader;n.onload=async function(e){const t=new Uint8Array(e.target.result);for(let e=0;e<c.length;e++)c[e]=t[e];l.segmentation.triggerSegmentationEvents.triggerSegmentationDataModified(i)},n.readAsArrayBuffer(t)},m.click()}},"Import"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{i(!0),(async()=>{const n=t.getLabelmapVolume(e[0].id),{dimensions:o,direction:a,scalarData:r}=n,s=e[0].segments,l=s.map(((e,t)=>e?t:0)).filter((e=>0!==e)),c=new Uint32Array(r);console.log("START COMPUTING INDEX ARRAY...");const d=new Array(o[2]-1),p=o[0]*o[1];for(let e=0;e<c.length;e+=p){const t=e/p,n=new Uint8ClampedArray(4*p).fill(0).map(((e,t)=>(t-3)%4==0?255:e)),a=c.slice(e,e+p);(await Promise.allSettled(l.map((e=>a.map(((t,n)=>0!==t&&t===e?n:0)).filter((e=>0!==e)))))).forEach(((e,t)=>{const o=e.value;if(0!==o.length){const e=l[t],a=[...s[e].color,255];for(const e of o)n[4*e]=a[0],n[4*e+1]=a[1],n[4*e+2]=a[2]}}));const r=()=>new Promise(((e,a)=>{const r=document.createElement("canvas"),i=r.getContext("2d");r.width=o[0],r.height=o[1];const s=new ImageData(n,o[0],o[1],{colorSpace:"srgb"});i.putImageData(s,0,0),r.toBlob((n=>{n&&(d[t]=n,e())}),"image/png")}));await r();const i=d.filter((e=>e)).length;m(~~(100*i/o[2]))}await new Promise(((e,t)=>{!function t(){if(d.filter((e=>e)).length===o[2])return e();setTimeout(t,500)}()}));const g=new(he());d.forEach(((e,t)=>{g.file(`layer_${t}.png`,e)}));const u=JSON.stringify(e[0].segments,null,"\t"),S=new Blob([u],{type:"text/plain;charset=utf-8"});g.file("segmentation_informations.json",S);const f=new Blob([r],{type:"application/octet-stream"});g.file("scalarData.bin",f);const E=await g.generateAsync({type:"blob"});(0,fe.saveAs)(E,"segmentation.zip"),i(!1)})()}},"Export"))),r.createElement("div",{className:"h-[6px] bg-black "}))}ye.propTypes={segmentations:y().array.isRequired};const Ie=ye,we=l.Enums.SegmentationRepresentations.Labelmap,be={[I.Expanded]:v.s_,[I.Dropdown]:v.cX},Ne=(e=>{let t=e%2147483647;return()=>(t=16807*t%2147483647,t/2147483647)})(42);function Te({servicesManager:e,commandsManager:t,extensionManager:n,configuration:o}){const{segmentationService:a,viewportGridService:i,uiDialogService:s,displaySetService:l,cornerstoneViewportService:c,hangingProtocolService:m,toolGroupService:d,toolbarService:p,uiNotificationService:g,panoramicService:u}=e.services,{t:S}=(0,M.$G)("PanelSegmentation"),[f,E]=(0,r.useState)(""),[h,y]=(0,r.useState)(a.getConfiguration()),I=()=>{const e=c.getViewportInfo("default").getViewportData().data[0].displaySetInstanceUID;return a.getSegmentations().filter((t=>t.displaySetInstanceUID===e))},b=()=>{const e=l.getActiveDisplaySets().find((e=>e.SeriesInstanceUID.includes("dentascan")));if(!e)return;return a.getSegmentations().filter((t=>t.displaySetInstanceUID===e.displaySetInstanceUID))},T=e=>{const t=c.getViewportInfo(e).getViewportData().data[0];return t.volume?.metadata.SeriesInstanceUID.includes("dentascan")},D=T(i.getActiveViewportId()),[C,R]=(0,r.useState)((()=>D?b():I())),[V,A]=(0,r.useState)((()=>D?I():b())),[O,k]=(0,r.useState)({});(0,r.useCallback)((e=>{k((t=>({...t,[e]:!t[e]})))}),[k]);(0,r.useEffect)((()=>{const e=C[C.length-1]?.id;e&&k((t=>({...t,[e]:!1})))}),[C,k]),(0,r.useEffect)((()=>{const e=a.EVENTS.SEGMENTATION_ADDED,t=a.EVENTS.SEGMENTATION_UPDATED,n=a.EVENTS.SEGMENTATION_REMOVED,o=[];return[e,t,n].forEach((e=>{const{unsubscribe:t}=a.subscribe(e,(()=>{const e=T(i.getActiveViewportId());R(e?b():I()),A(e?I():b()),y(a.getConfiguration())}));o.push(t)})),()=>{o.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const e=u.EVENTS.PANORAMIC_CREATED,{unsubscribe:t}=u.subscribe(e,(async({displaySetUID:e})=>{const t=b(),n=a.getActiveSegmentation();if(t?.length||!n)return;const o=u.getPanoramicState(e).dentascanViewportData.data[0].displaySetInstanceUID,r="mpr";for(const e of I()){const t=await a.createSegmentationForDisplaySet(o,{label:e.label});await a.addSegmentationRepresentationToToolGroup(r,t,!0,we);for(const n of e.segments)if(n){const o={segmentIndex:n.segmentIndex,toolGroupId:r,properties:{label:n.label,color:n.color,opacity:n.opacity,visibility:n.isVisible,isLocked:n.isLocked,active:e.activeSegmentIndex===n.segmentIndex}};a.addSegment(t,o)}}a.setActiveSegmentationForToolGroup(n.id,r)}));return()=>{t()}}),[]),(0,r.useEffect)((()=>{const e=e=>{const t=i.getDisplaySetsUIDsForViewport(e||i.getActiveViewportId());if(!t)return;const n=t?.some((e=>{const t=l.getDisplaySetByUID(e);return t?.isReconstructable}))||!1;if(E(n?"":"ohif-disabled"),e){const n=a.getActiveSegmentation(),o=L(n?.id);if(o&&t.includes(o.displaySetInstanceUID)){for(const e of F(o.id))a.setActiveSegmentationForToolGroup(o.id,e);a.setActiveSegment(o.id,n.activeSegmentIndex);const t=T(e);R(t?b():I()),A(t?I():b())}}};e();const t=i.EVENTS.ACTIVE_VIEWPORT_ID_CHANGED,n=i.EVENTS.VIEWPORTS_READY,o=[];[n,t].forEach((t=>{const{unsubscribe:n}=i.subscribe(t,(({viewportId:t})=>{e(t)}));o.push(n)}));const r=c.EVENTS.VIEWPORT_DATA_CHANGED,s=[];return[r].forEach((t=>{const{unsubscribe:n}=c.subscribe(t,(()=>{e()}));s.push(n)})),()=>{o.forEach((e=>e())),s.forEach((e=>e()))}}),[]);const L=e=>{var t;return T(i.getActiveViewportId())?(t=e,I()[b().findIndex((e=>e.id===t))]):(e=>{const t=b();if(!t)return;return t[I().findIndex((t=>t.id===e))]})(e)},F=e=>a.getToolGroupIdsWithSegmentation(e),G=(0,r.useCallback)(((e,t)=>{a.setConfiguration({[e]:t})}),[a]),U=be[o?.segmentationPanelMode]||v.cX,P=o?.addSegment,_=o?.onSegmentationAdd&&"function"==typeof o?.onSegmentationAdd?o?.onSegmentationAdd:async()=>{t.runCommand("createEmptySegmentationForViewport",{viewportId:i.getActiveViewportId()})};return r.createElement("div",{className:"flex flex-col flex-auto min-h-0F mt-1"},r.createElement(Se,{segmentationService:a,cornerstoneViewportService:c,toolbarService:p}),r.createElement(U,{title:S("Segmentations"),segmentations:C,hiddenSegmentations:V,segmentationConfig:{initialConfig:h},disableEditing:o.disableEditing,showAddSegment:P,showDeleteSegment:!0,onSegmentationAdd:_,onSegmentationEdit:e=>{const t=a.getSegmentation(e),{label:n}=t;w(s,n,((t,n)=>{if(""===t)return;a.addOrUpdateSegmentation({id:e,label:t},!1,!0);const o=L(e);o&&a.addOrUpdateSegmentation({id:o.id,label:t},!1,!0)}))},onSegmentationClick:e=>{for(const t of F(e))a.setActiveSegmentationForToolGroup(e,t)},onSegmentationDelete:e=>{const t=L(e);t&&a.remove(t.id),a.remove(e)},onSegmentationDownload:e=>{t.runCommand("downloadSegmentation",{segmentationId:e})},onSegmentationDownloadRTSS:e=>{t.runCommand("downloadRTSS",{segmentationId:e})},storeSegmentation:async o=>{const r=n.getActiveDataSource(),s=await(0,x.createReportAsync)({servicesManager:e,getReport:()=>t.runCommand("storeSegmentation",{segmentationId:o,dataSource:r[0]}),reportType:"Segmentation"});s&&(a.remove(o),i.setDisplaySetsForViewport({viewportId:i.getActiveViewportId(),displaySetInstanceUIDs:s}))},onSegmentClick:(e,t)=>{a.setActiveSegment(e,t);for(const n of F(e))a.setActiveSegmentationForToolGroup(e,n),a.jumpToSegmentCenter(e,t,n);const n=L(e);if(n)for(const e of F(n.id))a.jumpToSegmentCenter(n.id,t,e)},onSegmentAdd:e=>{const t=a.getSegmentation(e).segments.length,n={segmentIndex:t,properties:{label:`Segment ${t}`,color:[Math.floor(256*Ne()),Math.floor(256*Ne()),Math.floor(256*Ne())],opacity:255,visibility:!0,isLocked:!1,active:!0}};a.addSegment(e,n);const o=L(e);o&&a.addSegment(o.id,n)},onSegmentDelete:(e,t)=>{a.removeSegment(e,t);const n=L(e);n&&a.removeSegment(n.id,t)},onSegmentEdit:(e,t)=>{const n=a.getSegmentation(e).segments[t],{label:o}=n;w(s,o,((n,o)=>{if(""===n)return;a.setSegmentLabel(e,t,n);const r=L(e);r&&a.setSegmentLabel(r.id,t,n)}))},onToggleSegmentationVisibility:e=>{a.toggleSegmentationVisibility(e);const t=a.getSegmentation(e),n=t.isVisible,o=t.segments;F(e).forEach((t=>{o.forEach(((o,r)=>{a.setSegmentVisibility(e,r,n,t)}))}))},onToggleSegmentVisibility:(e,t)=>{const n=!a.getSegmentation(e).segments[t].isVisible;for(const o of F(e))a.setSegmentVisibility(e,t,n,o);const o=L(e);if(o)for(const e of F(o.id))a.setSegmentVisibility(o.id,t,n,e)},onToggleSegmentLock:(e,t)=>{a.toggleSegmentLocked(e,t);const n=L(e);n&&a.toggleSegmentLocked(n.id,t)},onSegmentColorClick:(e,t)=>{const n=a.getSegmentation(e).segments[t],{color:o,opacity:r}=n,i={r:o[0],g:o[1],b:o[2],a:r/255};N(s,i,((n,o)=>{if("cancel"===o)return;a.setSegmentRGBAColor(e,t,[n.r,n.g,n.b,255*n.a]);const r=L(e);r&&a.setSegmentRGBAColor(r.id,t,[n.r,n.g,n.b,255*n.a])}))},setFillAlpha:e=>G("fillAlpha",e),setFillAlphaInactive:e=>G("fillAlphaInactive",e),setOutlineWidthActive:e=>G("outlineWidthActive",e),setOutlineOpacityActive:e=>G("outlineOpacity",e),setRenderFill:e=>G("renderFill",e),setRenderInactiveSegmentations:e=>G("renderInactiveSegmentations",e),setRenderOutline:e=>G("renderOutline",e),addSegmentationClassName:f}),r.createElement("div",{className:"h-[6px] bg-black "}),r.createElement(v.zx,{className:"pt-1/10 pb-1/10",onClick:async()=>{const e="mpr",t=l.getActiveDisplaySets(),n={label:`Segmentation ${C.length+1}`},o={segmentIndex:1,toolGroupId:e,properties:{label:"Segment 1",color:[255,0,0],opacity:255,visibility:!0,isLocked:!1,active:!0}},r=t.find((e=>"CT"===e.Modality)).displaySetInstanceUID,s=await a.createSegmentationForDisplaySet(r,n),c=a.getSegmentation(s);console.log("CREATED SEGMENTATION",c),await a.addSegmentationRepresentationToToolGroup(e,s,!0,we),a.addSegment(s,o);const m=t.find((e=>e.SeriesInstanceUID.includes("dentascan")));if(m){const t=m.displaySetInstanceUID,r=await a.createSegmentationForDisplaySet(t,n);await a.addSegmentationRepresentationToToolGroup(e,r,!0,we),a.addSegment(r,o);const l=T(i.getActiveViewportId())?r:s;a.setActiveSegmentationForToolGroup(l,e)}console.log("MTOOLS",p.getButtonSection("MeasurementTools",{})),p.createButtonSection("primary",["MeasurementTools","Zoom","Pan","TrackballRotate","WindowLevel","Capture","Layout","MPR","Panoramic","Crosshairs","MoreTools","SegmentationTools"])},style:{marginTop:"10%"}},"Create segmentation"),r.createElement("div",{className:"h-[6px] bg-black "}),r.createElement(ve,{segmentations:C,segmentationService:a}),r.createElement(Ie,{segmentations:C,segmentationService:a,cornerstoneViewportService:c,panoramicService:u}))}Te.propTypes={commandsManager:y().shape({runCommand:y().func.isRequired}),servicesManager:y().shape({services:y().shape({segmentationService:y().shape({getSegmentation:y().func.isRequired,getSegmentations:y().func.isRequired,toggleSegmentationVisibility:y().func.isRequired,subscribe:y().func.isRequired,EVENTS:y().object.isRequired}).isRequired}).isRequired}).isRequired};const De=({commandsManager:e,servicesManager:t,extensionManager:n,configuration:o,title:a})=>{const{customizationService:i}=t.services;return[{name:"panelSegmentation",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:o=>{const[a]=(0,E.M)();return r.createElement(Te,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...o,disableEditing:a.disableEditing,...i.get("segmentation.panel")}})}},{name:"panelSegmentationWithTools",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:o=>{const[a]=(0,E.M)();return r.createElement(r.Fragment,null,r.createElement(v.vb,{commandsManager:e,servicesManager:t,extensionManager:n,buttonSectionId:"segmentationToolbox",title:"Segmentation Tools",configuration:{...o}}),r.createElement(Te,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...o,disableEditing:a.disableEditing,...i.get("segmentation.panel")}}))}}]};var Ce=n(60318),Re=n(54131),Ve=n(8455);async function Ae({viewportId:e,loadFn:t,servicesManager:n,displaySet:o,initialSliceIndex:a=null}){const{cornerstoneViewportService:r,segmentationService:i,viewportGridService:l}=n.services,c=Me({viewportId:e,viewportGridService:l}),m=c.viewportOptions.viewportId,d=o?.referencedDisplaySetInstanceUID||c?.displaySetInstanceUIDs[0],p=Oe({viewportId:e,servicesManager:n,displaySet:o}),g=async()=>{const e=await t();i.hydrateSegmentation(e)},u=Array.from(s.cache._volumeCache.keys()).some((e=>e.includes(d)));return p.forEach((async e=>{e.viewportOptions={...e.viewportOptions,viewportType:"RTSTRUCT"===o?.Modality?"stack":"volume",needsRerendering:!0};const t=e.viewportId;t===m&&(e.viewportOptions.initialImageOptions={index:a,useOnce:!0});const n=r.getCornerstoneViewport(t),i=n.getCamera();if((u||"RTSTRUCT"===o.Modality)&&t===m)return void await g();const l=async e=>{const n=e.detail.volumeActors?.find((e=>e.uid.includes(d))),o=r.getCornerstoneViewport(t);o.setCamera(i),o.element.removeEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,l),n&&t===m&&await g()};n.element.addEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,l)})),l.setDisplaySetsForViewports(p),!0}const Me=({viewportId:e,viewportGridService:t})=>{const{viewports:n,activeViewportId:o}=t.getState(),a=e||o;return n.get(a)};function Oe({viewportId:e,servicesManager:t,displaySet:n}){const{hangingProtocolService:o,displaySetService:a,segmentationService:r,viewportGridService:i}=t.services,{viewports:s,isHangingProtocolLayout:l}=i.getState(),c=Me({viewportId:e,viewportGridService:i}).viewportOptions.viewportId,m=s.get(c).displaySetInstanceUIDs,d=n?.referencedDisplaySetInstanceUID||m[0],p=a.getDisplaySetByUID(d).instances[0].FrameOfReferenceUID,g=o.getViewportsRequireUpdate(c,d,l);return s.forEach(((e,t)=>{if(c===t||g.find((e=>e.viewportId===t)))return;r.shouldRenderSegmentation(e.displaySetInstanceUIDs,p)&&g.push({viewportId:t,displaySetInstanceUIDs:e.displaySetInstanceUIDs,viewportOptions:{viewportType:"RTSTRUCT"===n?.Modality?"stack":"volume",needsRerendering:!0}})})),g.filter((e=>"volume3d"!==e.viewportOptions?.viewportType))}const{segmentation:ke}=l.utilities,{datasetToBlob:Le}=m.default.data,{Cornerstone3D:{Segmentation:{generateLabelMaps2DFrom3D:Fe,generateSegmentation:Ge}}}=c.adaptersSEG,{Cornerstone3D:{RTSS:{generateRTSSFromSegmentations:Ue}}}=c.adaptersRT,{downloadDICOMData:Pe}=c.helpers,_e=({servicesManager:e,extensionManager:t})=>{const{uiNotificationService:n,segmentationService:o,uiDialogService:a,displaySetService:r,viewportGridService:c,toolGroupService:d,cornerstoneViewportService:p}=e.services,g={getUpdatedViewportsForSegmentation:Oe,createEmptySegmentationForViewport:async({viewportId:t})=>{const a=Me({viewportId:t,viewportGridService:c}),i=a.displaySetInstanceUIDs[0],s=r.getDisplaySetByUID(i);s.isReconstructable?Ae({viewportId:t,servicesManager:e,displaySet:s,loadFn:async()=>{const e=o.getSegmentations(),t=await o.createSegmentationForDisplaySet(i,{label:`Segmentation ${e.length+1}`}),n=a.viewportOptions.toolGroupId;return await o.addSegmentationRepresentationToToolGroup(n,t),o.addSegment(t,{toolGroupId:n,segmentIndex:1,properties:{label:"Segment 1"}}),t}}):n.show({title:"Segmentation",message:"Segmentation is not supported for non-reconstructible displaysets yet",type:"error"})},loadSegmentationsForViewport:async({segmentations:t,viewportId:n})=>{Ae({viewportId:n,servicesManager:e,loadFn:async()=>{const e=Me({viewportId:n,viewportGridService:c}),a=e.displaySetInstanceUIDs[0],r=t[0],i=r.id,s=r.label,l=r.segments;if(delete r.segments,await o.createSegmentationForDisplaySet(a,{segmentationId:i,label:s}),r.scalarData){o.getLabelmapVolume(i).scalarData.set(r.scalarData)}o.addOrUpdateSegmentation(r);const m=e.viewportOptions.toolGroupId;return await o.addSegmentationRepresentationToToolGroup(m,i),l.forEach((e=>{null!==e&&o.addSegment(i,{segmentIndex:e.segmentIndex,toolGroupId:m,properties:{color:e.color,label:e.label,opacity:e.opacity,isLocked:e.isLocked,visibility:e.isVisible,active:r.activeSegmentIndex===e.segmentIndex}})})),r.centroidsIJK&&o.setCentroids(r.id,r.centroidsIJK),i}})},loadSegmentationDisplaySetsForViewport:async({viewportId:t,displaySets:n})=>{const a=n[0],i=r.getDisplaySetByUID(a.referencedDisplaySetInstanceUID),s=p.getCornerstoneViewport(t).getSliceIndex();Ae({viewportId:t,servicesManager:e,displaySet:a,loadFn:async()=>{const e=a,t="SEG"===e.Modality?"createSegmentationForSEGDisplaySet":"createSegmentationForRTDisplaySet",n=o[t].bind(o),r=await n(e,null,!1);return o.getSegmentation(r).description=`S${i.SeriesNumber}: ${i.SeriesDescription}`,r},initialSliceIndex:s})},generateSegmentation:({segmentationId:e,options:t={}})=>{const n=l.segmentation.state.getSegmentation(e),{referencedVolumeId:a}=n.representationData.LABELMAP,r=s.cache.getVolume(e),i=s.cache.getVolume(a).getCornerstoneImages(),c=Fe(r);c.metadata=[];o.getSegmentation(e).segments.forEach((e=>{if(!e)return;const t=e.segmentIndex,{label:n,color:o}=e,a=m.default.data.Colors.rgb2DICOMLAB(o.slice(0,3).map((e=>e/255))).map((e=>Math.round(e))),r={SegmentNumber:t.toString(),SegmentLabel:n,SegmentAlgorithmType:e?.algorithmType||"MANUAL",SegmentAlgorithmName:e?.algorithmName||"OHIF Brush",RecommendedDisplayCIELabValue:a,SegmentedPropertyCategoryCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"},SegmentedPropertyTypeCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"}};c.metadata[t]=r}));return Ge(i,c,s.metaData,t)},downloadSegmentation:({segmentationId:e})=>{const t=o.getSegmentation(e),n=g.generateSegmentation({segmentationId:e});Pe(n.dataset,`${t.label}`)},storeSegmentation:async({segmentationId:e,dataSource:n})=>{const r=await(0,x.createReportDialogPrompt)(a,{extensionManager:t});if(1!==r.action&&r.value)return;const s=o.getSegmentation(e);if(!s)throw new Error("No segmentation found");const{label:l}=s,c=r.value||l||"Research Derived Series",m=g.generateSegmentation({segmentationId:e,options:{SeriesDescription:c}});if(!m||!m.dataset)throw new Error("Error during segmentation generation");const{dataset:d}=m;return await n.store.dicom(d),d.wadoRoot=n.getConfig().wadoRoot,i.DicomMetadataStore.addInstances([d],!0),d},downloadRTSS:({segmentationId:e})=>{const t=o.getSegmentation(e),n={vtkImageMarchingSquares:Ce.ZP,vtkDataArray:Re.default,vtkImageData:Ve.ZP},a=Ue(t,i.classes.MetadataProvider,i.DicomMetadataStore,s.cache,l.Enums,n);try{const e=Le(a),t=URL.createObjectURL(e);window.location.assign(t)}catch(e){console.warn(e)}},setBrushSize:({value:e,toolNames:t})=>{const n=Number(e);d.getToolGroupIds()?.forEach((e=>{0===t?.length?ke.setBrushSizeForToolGroup(e,n):t?.forEach((t=>{ke.setBrushSizeForToolGroup(e,n,t)}))}))},setThresholdRange:({value:e,toolNames:t=["ThresholdCircularBrush","ThresholdSphereBrush"]})=>{d.getToolGroupIds()?.forEach((n=>{const o=d.getToolGroup(n);t?.forEach((t=>{o.setToolConfiguration(t,{strategySpecificConfiguration:{THRESHOLD:{threshold:e}}})}))}))}},u={getUpdatedViewportsForSegmentation:{commandFn:g.getUpdatedViewportsForSegmentation},loadSegmentationDisplaySetsForViewport:{commandFn:g.loadSegmentationDisplaySetsForViewport},loadSegmentationsForViewport:{commandFn:g.loadSegmentationsForViewport},createEmptySegmentationForViewport:{commandFn:g.createEmptySegmentationForViewport},generateSegmentation:{commandFn:g.generateSegmentation},downloadSegmentation:{commandFn:g.downloadSegmentation},storeSegmentation:{commandFn:g.storeSegmentation},downloadRTSS:{commandFn:g.downloadRTSS},setBrushSize:{commandFn:g.setBrushSize},setThresholdRange:{commandFn:g.setThresholdRange}};return{actions:g,definitions:u,defaultContext:"SEGMENTATION"}};function ze(){return ze=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)({}).hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},ze.apply(null,arguments)}const Be=r.lazy((()=>n.e(8315).then(n.bind(n,88315)))),We=e=>r.createElement(r.Suspense,{fallback:r.createElement("div",null,"Loading...")},r.createElement(Be,e)),je={id:o,getPanelModule:De,getCommandsModule:_e,getToolbarModule:function({servicesManager:e}){const{segmentationService:t,toolbarService:n,toolGroupService:o}=e.services;return[{name:"evaluate.cornerstone.segmentation",evaluate:({viewportId:e,button:a,toolNames:r,disabledText:i})=>{const s=t.getSegmentations();if(!s?.length)return{disabled:!0,className:"!text-common-bright !bg-black opacity-50",disabledText:i??"No segmentations available"};const l=o.getToolGroupForViewport(e);if(!l)return{disabled:!0,className:"!text-common-bright ohif-disabled",disabledText:i??"Not available on the current viewport"};const c=n.getToolNameForButton(a);if(!l.hasTool(c)&&!r)return{disabled:!0,className:"!text-common-bright ohif-disabled",disabledText:i??"Not available on the current viewport"};const m=r?r.includes(l.getActivePrimaryMouseButtonTool()):l.getActivePrimaryMouseButtonTool()===c;return{disabled:!1,className:m?"!text-black !bg-primary-light hover:bg-primary-light hover-text-black hover:cursor-pointer":"!text-common-bright !bg-black hover:bg-primary-light hover:cursor-pointer hover:text-black",isActive:m}}}]},getViewportModule:({servicesManager:e,extensionManager:t,commandsManager:n})=>[{name:"dicom-seg",component:o=>r.createElement(We,ze({servicesManager:e,extensionManager:t,commandsManager:n},o))}],getSopClassHandlerModule:u,getHangingProtocolModule:f}}}]);
//# sourceMappingURL=8206.bundle.cc6cf1d0a803852acfa0.js.map