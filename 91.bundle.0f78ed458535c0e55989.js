"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[91],{52091:(e,t,n)=>{n.r(t),n.d(t,{ContextMenuController:()=>vt,CustomizableContextMenuTypes:()=>a,default:()=>en,dicomWebUtils:()=>o,getStudiesForPatientByMRN:()=>ve});var a={};n.r(a);var o={};n.r(o),n.d(o,{fixBulkDataURI:()=>M});var s=n(75935),r=n(48501),i=n(87853);const{getString:c,getName:l,getModalities:d}=r.DICOMWeb;function u(e){if(!e||!e.length)return[];const t=[];return e.forEach((e=>t.push({studyInstanceUid:c(e["0020000D"]),date:c(e["00080020"]),time:c(e["00080030"]),accession:c(e["00080050"])||"",mrn:c(e["00100020"])||"",patientName:r.utils.formatPN(l(e["00100010"]))||"",instances:Number(c(e["00201208"]))||0,description:c(e["00081030"])||"",modalities:c(d(e["00080060"],e["00080061"]))||""}))),t}async function m(e,t,n,a){return await e.searchForStudies({studyInstanceUid:void 0,queryParams:a})}function p(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return;const n=["00081030","00080060"].join(","),{supportsWildcard:a}=t,o=e=>a&&e?`*${e}*`:e,s={PatientName:o(e.patientName),"00100020":o(e.patientId),AccessionNumber:o(e.accessionNumber),StudyDescription:o(e.studyDescription),ModalitiesInStudy:e.modalitiesInStudy,limit:e.limit||101,offset:e.offset||0,fuzzymatching:!0===t.supportsFuzzyMatching,includefield:n};if(e.startDate&&e.endDate)s.StudyDate=`${e.startDate}-${e.endDate}`;else if(e.startDate){const t=new Date,n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),o=`${t.getFullYear()}${a}${n}`;s.StudyDate=`${e.startDate}-${o}`}else if(e.endDate){const t="19700102";s.StudyDate=`${t}-${e.endDate}`}if(e.studyInstanceUid){let t=e.studyInstanceUid;t=Array.isArray(t)?t.join():t,t=t.replace(/[^0-9.]+/g,"\\"),s.StudyInstanceUID=t}const r={};return Object.keys(s).forEach((e=>{void 0!==s[e]&&""!==s[e]&&(r[e]=s[e])})),r}function g(e){let{instance:t,frame:n,config:a,thumbnail:o=!1}=e;if(!t)return;if(t.url)return t.url;const s=o?"thumbnailRendering":"imageRendering";if(a[s]&&"wadouri"!==a[s])return function(e,t,n){const a=function(e,t,n){const a=function(e,t){const{StudyInstanceUID:n,SeriesInstanceUID:a,SOPInstanceUID:o}=e;return`${t.wadoRoot}/studies/${n}/series/${a}/instances/${o}`}(e,t);return`${a}/frames/${n=n||1}`}(e,t,n);if(a)return`wadors:${a}`}(t,a,n);{const e=function(e,t){const{StudyInstanceUID:n,SeriesInstanceUID:a,SOPInstanceUID:o}=t,s=[];s.push("requestType=WADO"),s.push(`studyUID=${n}`),s.push(`seriesUID=${a}`),s.push(`objectUID=${o}`),s.push("contentType=application/dicom"),s.push("transferSyntax=*");const r=s.join("&");return`${e.wadoUriRoot}?${r}`}(a,t);let o="dicomweb:"+e;return void 0!==n&&(o+="&frame="+n),o}}var f=n(22737);class I{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;this.client=e,this.studyInstanceUID=t,this.filters=n,this.sortCriteria=a,this.sortFunction=o}async execLoad(){const e=await this.preLoad(),t=await this.load(e);return await this.posLoad(t)}async runLoaders(e){let t;for(const n of e)try{if(t=await n(),t&&t.length)break}catch(e){throw e}if(e.next().done&&!t)throw new Error("RetrieveMetadataLoader failed");return t}async configLoad(){}async preLoad(){}async load(e){}async posLoad(e){}}class y extends I{getOptions(){const{studyInstanceUID:e,filters:t}=this,n={studyInstanceUID:e},{seriesInstanceUID:a}=t;return a&&(n.seriesInstanceUID=a),n}*getLoaders(){const e=[],{studyInstanceUID:t,filters:{seriesInstanceUID:n}={},client:a}=this;n&&e.push(a.retrieveSeriesMetadata.bind(a,{studyInstanceUID:t,seriesInstanceUID:n})),e.push(a.retrieveStudyMetadata.bind(a,{studyInstanceUID:t})),yield*e}async load(e){const t=this.getLoaders();return this.runLoaders(t)}async posLoad(e){return e}}class h extends I{*getPreLoaders(){const e=[],{studyInstanceUID:t,filters:{seriesInstanceUID:n}={},client:a}=this;if(n){const o={studyInstanceUID:t,queryParams:{SeriesInstanceUID:n}};e.push(a.searchForSeries.bind(a,o))}e.push(a.searchForSeries.bind(a,{studyInstanceUID:t})),yield*e}async preLoad(){const e=this.getPreLoaders(),t=await this.runLoaders(e),n=this.sortCriteria,a=this.sortFunction,{naturalizeDataset:o}=f.default.data.DicomMetaDictionary,s=t.map(o);return(0,i.IO)(s,n||i.S1.seriesSortCriteria.seriesInfoSortingCriteria,a)}async load(e){const{client:t,studyInstanceUID:n}=this,a=function(e,t,n){return Object.freeze({hasNext:()=>n.length>0,async next(){const a=n.shift();return e.retrieveSeriesMetadata({studyInstanceUID:t,seriesInstanceUID:a})}})}(t,n,e.map((e=>e.SeriesInstanceUID))),o=[];for(;a.hasNext();)o.push(a.next());return{preLoadData:e,promises:o}}async posLoad(e){let{preLoadData:t,promises:n}=e;return{preLoadData:t,promises:n}}}const S=async function(e,t,n){const a=new(!1!==n?h:y)(e,t,arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},arguments.length>4?arguments[4]:void 0,arguments.length>5?arguments[5]:void 0);return await a.execLoad()},D="RetrieveStudyMetadata",v=new Map;function w(e,t,n,a,o,s){if(!e)throw new Error(`${D}: Required 'dicomWebClient' parameter not provided.`);if(!t)throw new Error(`${D}: Required 'StudyInstanceUID' parameter not provided.`);if(v.has(t))return v.get(t);const r=new Promise(((r,i)=>{S(e,t,n,a,o,s).then((function(e){r(e)}),i)}));return v.set(t,r),r}function b(e){v.has(e)&&v.delete(e)}class E extends s.api.DICOMwebClient{constructor(e){super(e),this.staticWado=e.staticWado}async searchForStudies(e){if(!this.staticWado)return super.searchForStudies(e);const t=await super.searchForStudies(e),{queryParams:n}=e;if(!n)return t;const a=this.toLowerParams(n);return t.filter((e=>{for(const t of Object.keys(E.studyFilterKeys))if(!this.filterItem(t,a,e,E.studyFilterKeys))return!1;return!0}))}async searchForSeries(e){if(!this.staticWado)return super.searchForSeries(e);const t=await super.searchForSeries(e),{queryParams:n}=e;if(!n)return t;const a=this.toLowerParams(n);return t.filter((e=>{for(const t of Object.keys(E.seriesFilterKeys))if(!this.filterItem(t,a,e,E.seriesFilterKeys))return!1;return!0}))}compareValues(e,t){if(Array.isArray(e))return e.find((e=>this.compareValues(e,t)));if(Array.isArray(t))return t.find((t=>this.compareValues(e,t)));if(t?.Alphabetic&&(t=t.Alphabetic),"string"==typeof t){if(0===t.length)return!0;if(0===e.length||"*"===e)return!0;if("*"===e[0]&&"*"===e[e.length-1])return-1!=t.indexOf(e.substring(1,e.length-1));if("*"===e[e.length-1])return-1!=t.indexOf(e.substring(0,e.length-1));if("*"===e[0])return t.indexOf(e.substring(1))===t.length-e.length+1}return e===t}compareDateRange(e,t){if(!t)return!0;const n=e.indexOf("-");if(-1===n)return this.compareValues(e,t);const a=e.substring(0,n),o=e.substring(n+1);return(!a||t>=a)&&(!o||t<=o)}filterItem(e,t,n,a){const o=a[e]||e;if(!t)return!0;const s=t[e]||t[o];if(!s)return!0;const r=n[e]||n[o];if(!r)return!1;if("DA"==r.vr)return this.compareDateRange(s,r.Value[0]);const i=r.Value;return this.compareValues(s,i)}toLowerParams(e){const t={};return Object.entries(e).forEach((e=>{let[n,a]=e;t[n.toLowerCase()]=a})),t}}E.studyFilterKeys={studyinstanceuid:"0020000D",patientname:"00100010","00100020":"mrn",studydescription:"00081030",studydate:"00080020",modalitiesinstudy:"00080061",accessionnumber:"00080050"},E.seriesFilterKeys={seriesinstanceuid:"0020000E",seriesnumber:"00200011",modality:"00080060"};const x=(e,t)=>{const{wadoRoot:n,singlepart:a}=e,{instance:o,tag:s="PixelData",defaultPath:i="/pixeldata",defaultType:c="video/mp4",singlepart:l="video"}=t,d=o[s];if(!d)return;if(d.DirectRetrieveURL)return d.DirectRetrieveURL;if(d.InlineBinary){const e=r.utils.b64toBlob(d.InlineBinary,c);return d.DirectRetrieveURL=URL.createObjectURL(e),d.DirectRetrieveURL}if(!a||!0!==a&&-1===a.indexOf(l))return d.retrieveBulkData?d.retrieveBulkData().then((e=>(d.DirectRetrieveURL=URL.createObjectURL(new Blob([e],{type:c})),d.DirectRetrieveURL))):void console.warn("Unable to retrieve",s,"from",o);const{StudyInstanceUID:u,SeriesInstanceUID:m,SOPInstanceUID:p}=o,g=d&&d.BulkDataURI||`series/${m}/instances/${p}${i}`,f=-1!==g.indexOf("?"),I=-1!==g.indexOf("accept=");return"PixelData"===s||"EncapsulatedDocument"===s?`${n}/studies/${u}/series/${m}/instances/${p}/rendered`:g+(I?"":(f?"&":"?")+`accept=${c}`)};function M(e,t,n){if(e.BulkDataURI.startsWith("http")||e.BulkDataURI.startsWith("/")){if("/"===e.BulkDataURI[0]&&n.wadoRoot.startsWith("http")){const t=new URL(n.wadoRoot);e.BulkDataURI=`${t.origin}${e.BulkDataURI}`}}else"studies"===n.bulkDataURI?.relativeResolution?e.BulkDataURI=`${n.wadoRoot}/studies/${t.StudyInstanceUID}/${e.BulkDataURI}`:"series"!==n.bulkDataURI?.relativeResolution&&n.bulkDataURI?.relativeResolution||(e.BulkDataURI=`${n.wadoRoot}/studies/${t.StudyInstanceUID}/series/${t.SeriesInstanceUID}/${e.BulkDataURI}`)}const{DicomMetaDictionary:C,DicomDict:U}=f.default.data,{naturalizeDataset:P,denaturalizeDataset:R}=C,N="2.25.270695996825855179949881587723571202391.2.0.0",O="OHIF-VIEWER-2.0.0",T="1.2.840.10008.1.2.1",A=r.classes.MetadataProvider;function V(e,t){const{qidoRoot:n,wadoRoot:a,enableStudyLazyLoad:o,supportsFuzzyMatching:l,supportsWildcard:d,supportsReject:f,staticWado:I,singlepart:y}=e,h=JSON.parse(JSON.stringify(e)),S={url:n,staticWado:I,singlepart:y,headers:t.getAuthorizationHeader(),errorInterceptor:r.Po.getHTTPErrorHandler()},D={url:a,staticWado:I,singlepart:y,headers:t.getAuthorizationHeader(),errorInterceptor:r.Po.getHTTPErrorHandler()},v=I?new E(S):new s.api.DICOMwebClient(S),C=I?new E(D):new s.api.DICOMwebClient(D),V={initialize:e=>{let{params:t,query:n}=e;const{StudyInstanceUIDs:a}=t,o=r.utils.splitComma(n.getAll("StudyInstanceUIDs")),s=o.length&&o||a;return s&&Array.isArray(s)?s:[s]},query:{studies:{mapParams:p.bind(),search:async function(e){const n=t.getAuthorizationHeader();n&&(v.headers=n);const{studyInstanceUid:a,seriesInstanceUid:o,...s}=p(e,{supportsFuzzyMatching:l,supportsWildcard:d})||{};return u(await m(v,0,0,s))},processResults:u.bind()},series:{search:async function(e){const n=t.getAuthorizationHeader();n&&(v.headers=n);return function(e){const t=[];return e&&e.length&&e.forEach((e=>t.push({studyInstanceUid:c(e["0020000D"]),seriesInstanceUid:c(e["0020000E"]),modality:c(e["00080060"]),seriesNumber:c(e["00200011"]),seriesDate:r.utils.formatDate(c(e["00080021"])),numSeriesInstances:Number(c(e["00201209"])),description:c(e["0008103E"])}))),(0,i.IO)(t),t}(await function(e,t){const n={includefield:["0008103E","00080021"].join(",")};return e.searchForSeries({studyInstanceUID:t,queryParams:n})}(v,e))}},instances:{search:(e,n)=>{const a=t.getAuthorizationHeader();a&&(v.headers=a),m.call(void 0,v,e,null,n)}}},retrieve:{directURL:e=>x({wadoRoot:a,singlepart:y},e),bulkDataURI:async e=>{let{StudyInstanceUID:t,BulkDataURI:n}=e;const a={multipart:!1,BulkDataURI:n,StudyInstanceUID:t};return v.retrieveBulkData(a).then((e=>e&&e[0]||void 0))},series:{metadata:async function(){let{StudyInstanceUID:e,filters:n,sortCriteria:a,sortFunction:s,madeInClient:r=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const i=t.getAuthorizationHeader();if(i&&(C.headers=i),!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");return o?V._retrieveSeriesMetadataAsync(e,n,a,s,r):V._retrieveSeriesMetadataSync(e,n,a,s,r)}}},store:{dicom:async(e,n)=>{const a=t.getAuthorizationHeader();if(a&&(C.headers=a),e instanceof ArrayBuffer){const t={datasets:[e],request:n};await C.storeInstances(t)}else{const t={FileMetaInformationVersion:e._meta.FileMetaInformationVersion.Value,MediaStorageSOPClassUID:e.SOPClassUID,MediaStorageSOPInstanceUID:e.SOPInstanceUID,TransferSyntaxUID:T,ImplementationClassUID:N,ImplementationVersionName:O},a=R(t),o=new U(a);o.dict=R(e);const s={datasets:[o.write()],request:n};await C.storeInstances(s)}}},_retrieveSeriesMetadataSync:async(e,t,n,a,o)=>{const s=(await w(C,e,!1,t,n,a)).map(P),i={},c={};s.forEach((t=>{i[t.SeriesInstanceUID]||(i[t.SeriesInstanceUID]={StudyInstanceUID:t.StudyInstanceUID,StudyDescription:t.StudyDescription,SeriesInstanceUID:t.SeriesInstanceUID,SeriesDescription:t.SeriesDescription,SeriesNumber:t.SeriesNumber,SeriesTime:t.SeriesTime,SOPClassUID:t.SOPClassUID,ProtocolName:t.ProtocolName,Modality:t.Modality}),c[t.SeriesInstanceUID]||(c[t.SeriesInstanceUID]=[]);const n=V.getImageIdsForInstance({instance:t});t.imageId=n,A.addImageIdToUIDs(n,{StudyInstanceUID:e,SeriesInstanceUID:t.SeriesInstanceUID,SOPInstanceUID:t.SOPInstanceUID}),c[t.SeriesInstanceUID].push(t)}));const l=Object.values(i);r.DicomMetadataStore.addSeriesMetadata(l,o),Object.keys(c).forEach((e=>r.DicomMetadataStore.addInstances(c[e],o)))},_retrieveSeriesMetadataAsync:async function(t,n,a,o){let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const{preLoadData:i,promises:c}=await w(C,t,!0,n,a,o),l=t=>{const n=P(t);return e.bulkDataURI?.enabled?(Object.keys(n).forEach((t=>{const a=n[t];a&&a.BulkDataURI&&!a.Value&&(a.retrieveBulkData=()=>{M(a,n,e);const t={multipart:!1,BulkDataURI:a.BulkDataURI,StudyInstanceUID:n.StudyInstanceUID};return v.retrieveBulkData(t).then((e=>{const t=e instanceof Array&&e.find((e=>e?.byteLength))||void 0;return a.Value=t,t}))})})),n):n};i.forEach((e=>{e.StudyInstanceUID=t})),r.DicomMetadataStore.addSeriesMetadata(i,s);const d=c.map((n=>n.then((n=>{!function(n){const a=n.map(l);a.forEach(((n,a)=>{n.wadoRoot=e.wadoRoot,n.wadoUri=e.wadoUri;const o=V.getImageIdsForInstance({instance:n});n.imageId=o,A.addImageIdToUIDs(o,{StudyInstanceUID:t,SeriesInstanceUID:n.SeriesInstanceUID,SOPInstanceUID:n.SOPInstanceUID})})),r.DicomMetadataStore.addInstances(a,s)}(n)}))));await Promise.all(d),r.DicomMetadataStore.getStudy(t,s).isLoaded=!0},deleteStudyMetadataPromise:b,getImageIdsForDisplaySet(e){const t=e.images,n=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let a=1;a<=t;a++){const t=this.getImageIdsForInstance({instance:e,frame:a});n.push(t)}else{const t=this.getImageIdsForInstance({instance:e});n.push(t)}})),n):n},getImageIdsForInstance(t){let{instance:n,frame:a}=t;return g({instance:n,frame:a,config:e})},getConfig:()=>h};return f&&(V.reject=function(e){return{series:(t,n)=>new Promise(((a,o)=>{const s=`${e}/studies/${t}/series/${n}/reject/113001%5EDCM`,r=new XMLHttpRequest;r.open("POST",s,!0),console.log(r),r.onreadystatechange=function(){if(4==r.readyState)switch(r.status){case 204:a(r.responseText);break;case 404:o("Your dataSource does not support reject functionality")}},r.send()}))}}(a)),r.Is.create(V)}const L=r.default.classes.MetadataProvider,k={studyInstanceUid:"StudyInstanceUID",patientId:"PatientID"};let F={urls:[]};const $=e=>F.urls.find((t=>t.url===e)),B=(e,t)=>{let n=[];return F.urls.map((a=>{a.studies.map((a=>{a[e]===t&&n.push(a)}))})),n};function q(e){const{name:t,wadoRoot:n}=e,a={initialize:async e=>{let{params:t,query:n,url:a}=e;a||(a=n.get("url"));let o=$(a);if(o)return o.studies.map((e=>e.StudyInstanceUID));const s=await fetch(a);let r=await s.json();const i=r.studies.map((e=>e.StudyInstanceUID));let c,l;return r.studies.forEach((e=>{c=e.StudyInstanceUID,e.series.forEach((e=>{l=e.SeriesInstanceUID,e.instances.forEach((e=>{const{url:t,metadata:n}=e;L.addImageIdToUIDs(t,{StudyInstanceUID:c,SeriesInstanceUID:l,SOPInstanceUID:n.SOPInstanceUID})}))}))})),F.urls.push({url:a,studies:[...r.studies]}),i},query:{studies:{mapParams:()=>{},search:async e=>{const[t,n]=Object.entries(e)[0],a=k[t];return B(a,n).map((e=>({accession:e.AccessionNumber,date:e.StudyDate,description:e.StudyDescription,instances:e.NumInstances,modalities:e.Modalities,mrn:e.PatientID,patientName:e.PatientName,studyInstanceUid:e.StudyInstanceUID,NumInstances:e.NumInstances,time:e.StudyTime})))},processResults:()=>{console.debug(" DICOMJson QUERY processResults")}},series:{search:()=>{console.debug(" DICOMJson QUERY SERIES SEARCH")}},instances:{search:()=>{console.debug(" DICOMJson QUERY instances SEARCH")}}},retrieve:{directURL:e=>x(n,e),series:{metadata:function(){let{StudyInstanceUID:e,madeInClient:t=!1,customSort:n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const a=B("StudyInstanceUID",e)[0];let o;o=n?n(a.series):a.series;const s=o.map((e=>{const t={StudyInstanceUID:a.StudyInstanceUID,...e};return delete t.instances,t}));r.DicomMetadataStore.addSeriesMetadata(s,t);const i=o.length;o.forEach(((n,o)=>{const s=n.instances.map((e=>{const t={...e.metadata,url:e.url,imageId:e.url,...n,...a};return delete t.instances,delete t.series,t}));var c;c=s,r.DicomMetadataStore.addInstances(c,t),o===i-1&&(r.DicomMetadataStore.getStudy(e,t).isLoaded=!0)}))}}},store:{dicom:()=>{console.debug(" DICOMJson store dicom")}},getImageIdsForDisplaySet(t){const n=t.images,a=[];return n?(t.images.forEach((t=>{const n=t.NumberOfFrames;if(n>1)for(let o=0;o<n;o++){const n=g({instance:t,frame:o,config:e});a.push(n)}else{const n=g({instance:t,config:e});a.push(n)}})),a):a},getImageIdsForInstance(e){let{instance:t,frame:n}=e;return g({instance:t,frame:n})}};return r.Is.create(a)}const H=r.default.classes.MetadataProvider,{EVENTS:G}=r.DicomMetadataStore,Z={SR:!0,SEG:!0,DOC:!0},j=function(e,t){return e===t?arguments.length>2&&void 0!==arguments[2]?arguments[2]:0:e<t?-1:1},z=(e,t)=>{const n=e.instances[0],a=t.instances[0],o=n.Modality,s=a.Modality,r=Z[o],i=Z[s];return r&&i?j(n.SeriesNumber,a.SeriesNumber):r||i?r?-1:1:j(a.SeriesNumber,n.SeriesNumber)};function _(e){const{name:t}=e,n={initialize:e=>{let{params:t,query:n}=e;const{StudyInstanceUIDs:a}=t,o=n.getAll("StudyInstanceUIDs")||a,s=o&&Array.isArray(o)?o:[o];return s.forEach((e=>{const t=r.DicomMetadataStore.getStudy(e);t.series=t.series.sort(z)})),s},query:{studies:{mapParams:()=>{},search:e=>r.DicomMetadataStore.getStudyInstanceUIDs().map((e=>{let t=0;const n=new Set,a=r.DicomMetadataStore.getStudy(e);a.series.forEach((e=>{t+=e.instances.length,n.add(e.instances[0].Modality)}));const o=a?.series[0]?.instances[0];if(o)return{accession:o.AccessionNumber,date:o.StudyDate,description:o.StudyDescription,mrn:o.PatientID,patientName:r.utils.formatPN(o.PatientName),studyInstanceUid:o.StudyInstanceUID,time:o.StudyTime,instances:t,modalities:Array.from(n).join("/"),NumInstances:t}})),processResults:()=>{console.debug(" DICOMLocal QUERY processResults")}},series:{search:e=>r.DicomMetadataStore.getStudy(e).series.map((t=>{const n=t?.instances[0];return{studyInstanceUid:e,seriesInstanceUid:n.SeriesInstanceUID,modality:n.Modality,seriesNumber:n.SeriesNumber,seriesDate:n.SeriesDate,numSeriesInstances:t.instances.length,description:n.SeriesDescription}}))},instances:{search:()=>{console.debug(" DICOMLocal QUERY instances SEARCH")}}},retrieve:{directURL:e=>{const{instance:t,tag:n,defaultType:a}=e,o=t[n];if(o instanceof Array&&o[0]instanceof ArrayBuffer)return URL.createObjectURL(new Blob([o[0]],{type:a}))},series:{metadata:async function(){let{StudyInstanceUID:e,madeInClient:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const n=r.DicomMetadataStore.getStudy(e,t);r.DicomMetadataStore._broadcastEvent(G.SERIES_ADDED,{StudyInstanceUID:e,madeInClient:t}),n.series.forEach((n=>{const{SeriesInstanceUID:a}=n,o=n.instances[0].NumberOfFrames>1;n.instances.forEach(((e,t)=>{const{url:n,StudyInstanceUID:a,SeriesInstanceUID:s,SOPInstanceUID:r}=e;e.imageId=n,H.addImageIdToUIDs(n,{StudyInstanceUID:a,SeriesInstanceUID:s,SOPInstanceUID:r,frameIndex:o?t:1})})),r.DicomMetadataStore._broadcastEvent(G.INSTANCES_ADDED,{StudyInstanceUID:e,SeriesInstanceUID:a,madeInClient:t})}))}}},store:{dicom:e=>{const t=f.default.data.datasetToBlob(e);var n=URL.createObjectURL(t);window.location.assign(n)}},getImageIdsForDisplaySet(e){const t=e.images,n=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let a=1;a<=t;a++){const t=this.getImageIdsForInstance({instance:e,frame:a});n.push(t)}else{const t=this.getImageIdsForInstance({instance:e});n.push(t)}})),n):n},getImageIdsForInstance(e){let{instance:t,frame:n}=e;const{StudyInstanceUID:a,SeriesInstanceUID:o,SOPInstanceUID:s}=t;let i=r.DicomMetadataStore.getInstance(a,o,s).url;return void 0!==n&&(i+=`&frame=${n}`),i},deleteStudyMetadataPromise(){console.log("deleteStudyMetadataPromise not implemented")}};return r.Is.create(n)}function W(e,t){const{name:n}=e;let a;const o={initialize:async e=>{let{params:o,query:s}=e,r=[];const i=s.get("studyInstanceUIDs")||s.get("studyInstanceUids");if(!i)throw new Error(`No studyInstanceUids in request for '${n}'`);const c=s.get("url");if(!c)throw new Error(`No url for '${n}'`);{const e=await fetch(c);let n=await e.json();if(!n.servers?.dicomWeb?.[0])throw new Error("Invalid configuration returned by url");a=V(n.servers.dicomWeb[0],t),r=i.split(";")}return r},query:{studies:{search:e=>a.query.studies.search(e)},series:{search:function(){return a.query.series.search(...arguments)}},instances:{search:(e,t)=>a.query.instances.search(e,t)}},retrieve:{directURL:function(){return a.retrieve.directURL(...arguments)},series:{metadata:function(){return a.retrieve.series.metadata(...arguments)}}},store:{dicom:function(){return a.store(...arguments)}},deleteStudyMetadataPromise:function(){return a.deleteStudyMetadataPromise(...arguments)},getImageIdsForDisplaySet:function(){return a.getImageIdsForDisplaySet(...arguments)},getImageIdsForInstance:function(){return a.getImageIdsForInstance(...arguments)}};return r.Is.create(o)}const X=function(){return[{name:"dicomweb",type:"webApi",createDataSource:V},{name:"dicomwebproxy",type:"webApi",createDataSource:W},{name:"dicomjson",type:"jsonApi",createDataSource:q},{name:"dicomlocal",type:"localApi",createDataSource:_}]};var Y=n(32735),J=n(60216),K=n.n(J),Q=n(65783),ee=n(21572),te=n(14935),ne=n(22605),ae=n(93058),oe=n(22896),se=n(40841),re=n.n(se);function ie(){return ie=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},ie.apply(this,arguments)}function ce(e){let{servicesManager:t}=e;const{toolbarService:n}=t.services,[a,o]=(0,Y.useState)([]),[s,r]=(0,Y.useState)({primaryToolId:"",toggles:{},groups:{}});return(0,Y.useEffect)((()=>{const{unsubscribe:e}=n.subscribe(n.EVENTS.TOOL_BAR_MODIFIED,(()=>o(n.getButtonSection("primary")))),{unsubscribe:t}=n.subscribe(n.EVENTS.TOOL_BAR_STATE_MODIFIED,(()=>r({...n.state})));return()=>{e(),t()}}),[n]),Y.createElement(Y.Fragment,null,a.map(((e,a)=>{const{id:o,Component:r,componentProps:i}=e;let c;return"toggle"===i.type&&(c=s.toggles[o]),Y.createElement("div",{key:o,className:re()("mr-1")},Y.createElement(r,ie({id:o},i,{bState:s,isActive:c,onInteraction:e=>n.recordInteraction(e),servicesManager:t})))})))}const{availableLanguages:le,defaultLanguage:de,currentLanguage:ue}=ae.default;function me(e){let{extensionManager:t,servicesManager:n,hotkeysManager:a,commandsManager:o,viewports:s,ViewportGridComp:i,leftPanels:c=[],rightPanels:l=[],leftPanelDefaultClosed:d=!1,rightPanelDefaultClosed:u=!1}=e;const[m]=(0,oe.M)(),p=(0,Q.s0)(),g=(0,te.TH)(),{t:f}=(0,ee.$G)(),{show:I,hide:y}=(0,ne.dd)(),[h,S]=(0,Y.useState)(m.showLoadingIndicator),{hangingProtocolService:D}=n.services,{hotkeyDefinitions:v,hotkeyDefaults:w}=a,b=[{title:f("Header:About"),icon:"info",onClick:()=>I({content:ne.tk,title:"About OHIF Viewer",contentProps:{versionNumber:"3.7.0-beta.3",commitHash:"cadb559619306a5900d7a2b92e43bdd161036bd4"}})},{title:f("Header:Preferences"),icon:"settings",onClick:()=>I({title:f("UserPreferencesModal:User Preferences"),content:ne.i1,contentProps:{hotkeyDefaults:a.getValidHotkeyDefinitions(w),hotkeyDefinitions:v,currentLanguage:ue(),availableLanguages:le,defaultLanguage:de,onCancel:()=>{r.dD.stopRecord(),r.dD.unpause(),y()},onSubmit:e=>{let{hotkeyDefinitions:t,language:n}=e;ae.default.changeLanguage(n.value),a.setHotkeys(t),y()},onReset:()=>a.restoreDefaultBindings(),hotkeysModule:r.dD}})}];m.oidc&&b.push({title:f("Header:Logout"),icon:"power-off",onClick:async()=>{p(`/logout?redirect_uri=${encodeURIComponent(window.location.href)}`)}}),(0,Y.useEffect)((()=>(document.body.classList.add("bg-black"),document.body.classList.add("overflow-hidden"),()=>{document.body.classList.remove("bg-black"),document.body.classList.remove("overflow-hidden")})),[]);const E=e=>{const n=t.getModuleEntry(e);if(!n)throw new Error(`${e} is not a valid entry for an extension module, please check your configuration or make sure the extension is registered.`);let a;if(!n||!n.component)throw new Error(`No component found from extension ${e}. Check the reference string to the extension in your Mode configuration`);return a=n.component,{entry:n,content:a}},x=e=>{const{content:t,entry:n}=E(e);return{id:n.id,iconName:n.iconName,iconLabel:n.iconLabel,label:n.label,name:n.name,content:t}};(0,Y.useEffect)((()=>{const{unsubscribe:e}=D.subscribe(r.hy.EVENTS.PROTOCOL_CHANGED,(()=>{S(!1)}));return()=>{e()}}),[D]);const M=c.map(x),C=l.map(x),U=s.map((e=>{const{entry:t}=E(e.namespace);return{component:t.component,displaySetsToDisplay:e.displaySetsToDisplay}}));return Y.createElement("div",null,Y.createElement(ne.h4,{menuOptions:b,isReturnEnabled:!!m.showStudyList,onClickReturnButton:()=>{const{pathname:e}=g,t=e.indexOf("/",1),n=new URLSearchParams(window.location.search).get("configUrl"),a=new URLSearchParams;-1!==t&&a.append("datasources",e.substring(t+1)),n&&a.append("configUrl",n),p({pathname:"/",search:decodeURIComponent(a.toString())})},WhiteLabeling:m.whiteLabeling},Y.createElement(ne.SV,{context:"Primary Toolbar"},Y.createElement("div",{className:"relative flex justify-center"},Y.createElement(ce,{servicesManager:n})))),Y.createElement("div",{className:"bg-black flex flex-row items-stretch w-full overflow-hidden flex-nowrap relative",style:{height:"calc(100vh - 52px"}},Y.createElement(Y.Fragment,null,h&&Y.createElement(ne.LE,{className:"h-full w-full bg-black"}),M.length?Y.createElement(ne.SV,{context:"Left Panel"},Y.createElement(ne.hs,{side:"left",activeTabIndex:d?null:0,tabs:M,servicesManager:n})):null,Y.createElement("div",{className:"flex flex-col flex-1 h-full"},Y.createElement("div",{className:"flex items-center justify-center flex-1 h-full overflow-hidden bg-black relative"},Y.createElement(ne.SV,{context:"Grid"},Y.createElement(i,{servicesManager:n,viewportComponents:U,commandsManager:o})))),C.length?Y.createElement(ne.SV,{context:"Right Panel"},Y.createElement(ne.hs,{side:"right",activeTabIndex:u?null:0,tabs:C,servicesManager:n})):null)))}me.propTypes={extensionManager:K().shape({getModuleEntry:K().func.isRequired}).isRequired,commandsManager:K().instanceOf(r.HQ),servicesManager:K().instanceOf(r.Xw),leftPanels:K().array,rightPanels:K().array,leftPanelDefaultClosed:K().bool.isRequired,rightPanelDefaultClosed:K().bool.isRequired,children:K().oneOfType([K().node,K().func]).isRequired};const pe=me;const{sortStudyInstances:ge,formatDate:fe}=r.utils;function Ie(e){let{servicesManager:t,getImageSrc:n,getStudiesForPatientByMRN:a,requestDisplaySetCreationForStudy:o,dataSource:s}=e;const{hangingProtocolService:r,displaySetService:i,uiNotificationService:c}=t.services,{StudyInstanceUIDs:l}=(0,ne.zG)(),[{activeViewportIndex:d,viewports:u},m]=(0,ne.O_)(),[p,g]=(0,Y.useState)("primary"),[f,I]=(0,Y.useState)([...l]),[y,h]=(0,Y.useState)([]),[S,D]=(0,Y.useState)([]),[v,w]=(0,Y.useState)({}),b=(0,Y.useRef)(!0);(0,Y.useEffect)((()=>{l.forEach((e=>async function(e){const t=await s.query.studies.search({studyInstanceUid:e});let n=t;try{n=await a(t)}catch(e){console.warn(e)}const o=n.map((e=>({AccessionNumber:e.accession,StudyDate:e.date,StudyDescription:e.description,NumInstances:e.instances,ModalitiesInStudy:e.modalities,PatientID:e.mrn,PatientName:e.patientName,StudyInstanceUID:e.studyInstanceUid,StudyTime:e.time}))).map((e=>({studyInstanceUid:e.StudyInstanceUID,date:fe(e.StudyDate),description:e.StudyDescription,modalities:e.ModalitiesInStudy,numInstances:e.NumInstances})));h((e=>{const t=[...e];for(const n of o)e.find((e=>e.studyInstanceUid===n.studyInstanceUid))||t.push(n);return t}))}(e)))}),[l,a]),(0,Y.useEffect)((()=>(i.activeDisplaySets.forEach((async e=>{const t={},a=i.getDisplaySetByUID(e.displaySetInstanceUID),o=s.getImageIdsForDisplaySet(a),r=o[Math.floor(o.length/2)];r&&(t[e.displaySetInstanceUID]=await n(r),b.current&&w((e=>({...e,...t}))))})),()=>{b.current=!1})),[]),(0,Y.useEffect)((()=>{const e=he(i.activeDisplaySets,v);ge(e),D(e)}),[v]),(0,Y.useEffect)((()=>{const e=i.subscribe(i.EVENTS.DISPLAY_SETS_ADDED,(e=>{const{displaySetsAdded:t}=e;t.forEach((async e=>{const t={},a=i.getDisplaySetByUID(e.displaySetInstanceUID),o=s.getImageIdsForDisplaySet(a),r=o[Math.floor(o.length/2)];r&&(t[e.displaySetInstanceUID]=await n(r,e.initialViewport),b.current&&w((e=>({...e,...t}))))}))})),t=i.subscribe(i.EVENTS.DISPLAY_SETS_CHANGED,(e=>{const t=he(e,v);D(t)}));return()=>{e.unsubscribe(),t.unsubscribe()}}),[]);const E=function(e,t,n){const a=[],o=[],s=[];t.forEach((t=>{const r=n.filter((e=>e.StudyInstanceUID===t.studyInstanceUid)),i=Object.assign({},t,{displaySets:r});e.includes(t.studyInstanceUid)?a.push(i):(o.push(i),s.push(i))}));const r=[{name:"primary",label:"Primary",studies:a},{name:"recent",label:"Recent",studies:o},{name:"all",label:"All",studies:s}];return r}(l,y,S);const x=u[d]?.displaySetInstanceUIDs;return Y.createElement(ne.eX,{tabs:E,servicesManager:t,activeTabName:p,onDoubleClickThumbnail:e=>{let t=[];const n=d;try{t=r.getViewportsRequireUpdate(n,e)}catch(e){console.warn(e),c.show({title:"Thumbnail Double Click",message:"The selected display sets could not be added to the viewport.",type:"info",duration:3e3})}m.setDisplaySetsForViewports(t)},activeDisplaySetInstanceUIDs:x,expandedStudyInstanceUIDs:f,onClickStudy:function(e){const t=f.includes(e),n=t?[...f.filter((t=>t!==e))]:[...f,e];if(I(n),!t){o(i,e,!0)}},onClickTab:e=>{g(e)}})}Ie.propTypes={servicesManager:K().object.isRequired,dataSource:K().shape({getImageIdsForDisplaySet:K().func.isRequired}).isRequired,getImageSrc:K().func.isRequired,getStudiesForPatientByMRN:K().func.isRequired,requestDisplaySetCreationForStudy:K().func.isRequired};const ye=Ie;function he(e,t){const n=[],a=[];return e.filter((e=>!e.excludeFromThumbnailBrowser)).forEach((e=>{const o=t[e.displaySetInstanceUID],s=function(e){if(Se.includes(e))return"thumbnailNoImage";return"thumbnail"}(e.Modality);("thumbnail"===s?n:a).push({displaySetInstanceUID:e.displaySetInstanceUID,description:e.SeriesDescription||"",seriesNumber:e.SeriesNumber,modality:e.Modality,seriesDate:e.SeriesDate,seriesTime:e.SeriesTime,numInstances:e.numImageFrames,countIcon:e.countIcon,StudyInstanceUID:e.StudyInstanceUID,componentType:s,imageSrc:o,dragData:{type:"displayset",displaySetInstanceUID:e.displaySetInstanceUID}})})),[...n,...a]}const Se=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"];const De=function(e,t){return new Promise(((n,a)=>{const o=document.createElement("canvas");e.utilities.loadImageToCanvas({canvas:o,imageId:t}).then((e=>{n(o.toDataURL())})).catch(a)}))};const ve=async function(e,t){return t&&t.length&&t[0].mrn?e.query.studies.search({patientId:t[0].mrn}):(console.log("No mrn found for",t),t)};const we=function(e,t,n,a){t.activeDisplaySets.some((e=>e.StudyInstanceUID===n))||e.retrieve.series.metadata({StudyInstanceUID:n,madeInClient:a})};function be(e){let{commandsManager:t,extensionManager:n,servicesManager:a}=e;const o=n.getDataSources()[0],s=ve.bind(null,o),r=function(e){const t=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common");try{const{cornerstone:e}=t.exports.getCornerstoneLibraries();return De.bind(null,e)}catch(e){throw new Error("Required command not found")}}(n),i=we.bind(null,o);return Y.createElement(ye,{servicesManager:a,dataSource:o,getImageSrc:r,getStudiesForPatientByMRN:s,requestDisplaySetCreationForStudy:i})}be.propTypes={commandsManager:K().object.isRequired,extensionManager:K().object.isRequired,servicesManager:K().object.isRequired};const Ee=be;function xe(e){let{onExportClick:t,onCreateReportClick:n}=e;const{t:a}=(0,ee.$G)("MeasurementTable");return Y.createElement(Y.Fragment,null,Y.createElement(ne.hE,{color:"black",size:"inherit"},Y.createElement(ne.zx,{className:"px-2 py-2 text-base",onClick:t},a("Export CSV")),Y.createElement(ne.zx,{className:"px-2 py-2 text-base",onClick:n},a("Create Report"))))}xe.propTypes={onExportClick:K().func,onCreateReportClick:K().func},xe.defaultProps={onExportClick:()=>alert("Export"),onCreateReportClick:()=>alert("Create Report")};const Me=xe;var Ce=n(40001),Ue=n.n(Ce);const Pe={CANCEL:0,CREATE_REPORT:1};function Re(){return Y.createElement("div",{className:"text-primary-active"},"Loading...")}const Ne=async function(e,t,n,a,o){const{displaySetService:s,uiNotificationService:i,uiDialogService:c}=e.services,l=c.create({showOverlay:!0,isDraggable:!1,centralize:!0,content:Re});try{const e=await t.runCommand("storeMeasurements",{measurementData:a,dataSource:n,additionalFindingTypes:["ArrowAnnotate"],options:o},"CORNERSTONE_STRUCTURED_REPORT");r.DicomMetadataStore.addInstances([e],!0);const c=s.getMostRecentDisplaySet();return i.show({title:"Create Report",message:"Measurements saved successfully",type:"success"}),[c]}catch(e){i.show({title:"Create Report",message:e.message||"Failed to store measurements",type:"error"})}finally{c.dismiss({id:l})}},Oe=4700;function Te(e,t){const n=t.getActiveDisplaySets().filter((e=>"SR"===e.Modality)).find((t=>t.SeriesDescription===e));if(n){console.log("Storing to same series",n);const{instance:e}=n,{SeriesInstanceUID:t,SeriesDescription:a,SeriesDate:o,SeriesTime:s,SeriesNumber:r,Modality:i}=e;return{SeriesInstanceUID:t,SeriesDescription:a,SeriesDate:o,SeriesTime:s,SeriesNumber:r,Modality:i,InstanceNumber:n.instances.length+1}}const a=function(e){const t=e.getActiveDisplaySets().filter((e=>"SR"===e.Modality)).map((e=>e.SeriesNumber));return Math.max(...t,Oe)+1}(t);return{SeriesDescription:e,SeriesNumber:a}}const{downloadCSVReport:Ae}=r.utils;function Ve(e){let{servicesManager:t,commandsManager:n,extensionManager:a}=e;const[o,s]=(0,ne.O_)(),{activeViewportIndex:r,viewports:i}=o,{measurementService:c,uiDialogService:l,uiNotificationService:d,displaySetService:u}=t.services,[m,p]=(0,Y.useState)([]);(0,Y.useEffect)((()=>{const e=Ue()(p,100);p(Le(c));const t=c.EVENTS.MEASUREMENT_ADDED,n=c.EVENTS.RAW_MEASUREMENT_ADDED,a=c.EVENTS.MEASUREMENT_UPDATED,o=c.EVENTS.MEASUREMENT_REMOVED,s=c.EVENTS.MEASUREMENTS_CLEARED,r=[];return[t,n,a,o,s].forEach((t=>{r.push(c.subscribe(t,(()=>{e(Le(c))})).unsubscribe)})),()=>{r.forEach((e=>{e()})),e.cancel()}}),[]);const g=e=>{let{uid:t,isActive:n}=e;if(!n){const e=[...m],n=e.find((e=>e.uid===t));e.forEach((e=>e.isActive=e.uid===t)),n.isActive=!0,p(e)}};return Y.createElement(Y.Fragment,null,Y.createElement("div",{className:"overflow-x-hidden overflow-y-auto ohif-scrollbar","data-cy":"measurements-panel"},Y.createElement(ne.wt,{title:"Measurements",servicesManager:t,data:m,onClick:e=>{let{uid:t,isActive:n}=e;c.jumpToMeasurement(o.activeViewportIndex,t),g({uid:t,isActive:n})},onEdit:e=>{let{uid:t,isActive:n}=e;const a=c.getMeasurement(t),o=e=>{let{action:n,value:o}=e;if("save"===n.id)c.update(t,{...a,...o},!0);l.dismiss({id:"enter-annotation"})};l.create({id:"enter-annotation",centralize:!0,isDraggable:!1,showOverlay:!0,content:ne.Vq,contentProps:{title:"Annotation",noCloseButton:!0,value:{label:a.label||""},body:e=>{let{value:t,setValue:n}=e;return Y.createElement(ne.II,{label:"Enter your annotation",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,id:"annotation",className:"bg-black border-primary-main",type:"text",value:t.label,onChange:e=>{e.persist(),n((t=>({...t,label:e.target.value})))},onKeyPress:e=>{"Enter"===e.key&&o({value:t,action:{id:"save"}})}})},actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:o}})}})),Y.createElement("div",{className:"flex justify-center p-4"},Y.createElement(Me,{onExportClick:async function(){const e=c.getMeasurements();Ae(e,c)},onClearMeasurementsClick:async function(){c.clearMeasurements()},onCreateReportClick:async function(){const e=i[r],o=c.getMeasurements(),s=u.getDisplaySetByUID(e.displaySetInstanceUIDs[0]),m=o.filter((e=>s.StudyInstanceUID===e.referenceStudyUID));if(m.length<=0)return void d.show({title:"No Measurements",message:"No Measurements are added to the current Study.",type:"info",duration:3e3});const p=await function(e,t){let{extensionManager:n}=t;return new Promise((function(t,a){let o;const s=Object.keys(n.dataSourceMap).filter((e=>{const t=n.dataSourceDefs[e]?.configuration;return t?.supportsStow??t?.wadoRoot})).map((e=>({value:e,label:e,placeHolder:e})));o=e.create({centralize:!0,isDraggable:!1,content:ne.Vq,useLastPosition:!1,showOverlay:!0,contentProps:{title:"Create Report",value:{label:"",dataSourceName:n.activeDataSource},noCloseButton:!0,onClose:()=>{e.dismiss({id:o}),t({action:Pe.CANCEL,value:void 0,dataSourceName:void 0})},actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:n=>{let{action:a,value:s}=n;switch(e.dismiss({id:o}),a.id){case"save":t({action:Pe.CREATE_REPORT,value:s.label,dataSourceName:s.dataSourceName});break;case"cancel":t({action:Pe.CANCEL,value:void 0,dataSourceName:void 0})}},body:n=>{let{value:a,setValue:r}=n;return Y.createElement(Y.Fragment,null,s.length>1&&Y.createElement(ne.Ph,{closeMenuOnSelect:!0,className:"mr-2 bg-black border-primary-main",options:s,placeholder:s.find((e=>e.value===a.dataSourceName)).placeHolder,value:a.dataSourceName,onChange:e=>{r((t=>({...t,dataSourceName:e.value})))},isClearable:!1}),Y.createElement(ne.II,{autoFocus:!0,label:"Enter the report name",labelClassName:"text-white text-[14px] leading-[1.2]",className:"bg-black border-primary-main",type:"text",value:a.label,onChange:e=>{e.persist(),r((t=>({...t,label:e.target.value})))},onKeyPress:n=>{"Enter"===n.key&&(e.dismiss({id:o}),t({action:Pe.CREATE_REPORT,value:a.label}))},required:!0}))}}})}))}(l,{extensionManager:a});if(p.action===Pe.CREATE_REPORT){const e=a.getDataSources(p.dataSourceName)[0],o=Te(void 0===p.value||""===p.value?"Research Derived Series":p.value,u);return Ne(t,n,e,m,o)}}})))}function Le(e){return e.getMeasurements().map(((t,n)=>function(e,t,n){const{displayText:a,uid:o,label:s,type:r,selected:i,findingSites:c,finding:l}=e,d=c?.[0],u=s||l?.text||d?.text||"(empty)";let m=a||[];if(c){const e=[];c.forEach((t=>{t?.text!==u&&e.push(t.text)})),m=[...e,...m]}l&&l?.text!==u&&(m=[l.text,...m]);return{uid:o,label:u,baseLabel:s,measurementType:r,displayText:m,baseDisplayText:a,isActive:i,finding:l,findingSites:c}}(t,0,e.VALUE_TYPES)))}Ve.propTypes={servicesManager:K().instanceOf(r.Xw).isRequired};var ke=n(84661),Fe=n(31954),$e=n(62962),Be=n(36791),qe=n(24156),He=n(29919),Ge=n(77370),Ze=n(52284),je=n(74462);const ze="cornerstoneStreamingImageVolume";function _e(e){let{commandsManager:t,extensionManager:n,servicesManager:a}=e;const[o,s]=(0,Y.useState)("0.3"),[r,i]=(0,Y.useState)("1"),[c,l]=(0,Y.useState)("1"),{StudyInstanceUIDs:d}=(0,ne.zG)(),[{activeViewportIndex:u,viewports:m},p]=(0,ne.O_)(),{displaySetService:g,cornerstoneViewportService:f,toolbarService:I,hangingProtocolService:y}=a.services;(0,Y.useEffect)((()=>{const e=p.getState();console.log("STATE",e),console.log("HP",y.getActiveProtocol()),"mprAnd3DVolumeViewport"!==y.getActiveProtocol().protocol.id&&t.runCommand("toggleHangingProtocol",{protocolId:"mprAnd3DVolumeViewport",stageIndex:0})}),[]),(0,Y.useEffect)((()=>{m.forEach((e=>{if("volume3d"===e.viewportOptions.viewportType){p.setActiveViewportIndex(e.viewportIndex);const t=f.getCornerstoneViewport(e.id);t.getActors().forEach((e=>{"bones"===e.uid&&e.actor.getProperty().setOpacity(parseFloat(r)),"skin"===e.uid&&e.actor.getProperty().setOpacity(parseFloat(o)),"outline"===e.uid&&e.actor.getProperty().setOpacity(parseFloat(c))})),(0,Be.getEnabledElement)(t.element).viewport.render()}}))}),[r,o,c]);return Y.createElement("div",{style:{width:"100%",display:"flex",flexDirection:"column",justifyContent:"space-evenly",height:"50%"}},Y.createElement("p",{style:{color:"#0941aa",fontSize:"larger"}},"Iso values : "),Y.createElement("div",{style:{display:"inline-flex",width:"100%",justifyContent:"flex-start"}},Y.createElement(ne.Jg,{checked:!1,onChange:()=>{},label:""}),Y.createElement("p",{style:{color:"white"}},"Aerial / Skin : ")),Y.createElement("input",{type:"range",min:"0",max:"1",value:o,className:"slider",id:"myRange",step:"0.01",onChange:e=>s(e.target.value)}),Y.createElement("div",{style:{display:"inline-flex",width:"100%",justifyContent:"flex-start"}},Y.createElement(ne.Jg,{checked:!1,onChange:()=>{},label:""}),Y.createElement("p",{style:{color:"white"}},"Bones :")),Y.createElement("input",{type:"range",min:"0",max:"1",value:r,className:"slider",id:"myRange",step:"0.01",onChange:e=>i(e.target.value)}),Y.createElement("div",{style:{display:"inline-flex",width:"100%",justifyContent:"flex-start"}},Y.createElement(ne.Jg,{checked:!1,onChange:()=>{},label:""}),Y.createElement("p",{style:{color:"white"}},"Outline :")),Y.createElement("input",{type:"range",min:"0",max:"1",value:c,className:"slider",id:"myRange",step:"0.01",onChange:e=>l(e.target.value)}),Y.createElement(ne.zx,{onClick:()=>{m.forEach((e=>{if("volume3d"===e.viewportOptions.viewportType){p.setActiveViewportIndex(e.viewportIndex);const t=f.getCornerstoneViewport(e.id),n=(e=>{const t=g.getDisplaySetByUID(e);return`${t.volumeLoaderSchema??ze}:${t.displaySetInstanceUID}`})(e.displaySetInstanceUIDs[0]),a=t.getActors();let s=t.getActor(n);s||(s=a[0]);const i=s.actor.getMapper().getInputData(),c=He.ZP.newInstance();c.shallowCopy(i);const l=Ge.ZP.newInstance();l.setCroppingPlanes([0,400,50,400,75,280]),l.setInputData(c);const d=$e.ZP.newInstance({contourValue:-400,computeNormals:!0,mergePoints:!0});d.setInputData(l.getOutputData());const u=d.getOutputData();u.buildLinks();const m=$e.ZP.newInstance({contourValue:-400,computeNormals:!0,mergePoints:!0});m.setInputData(i);const I=$e.ZP.newInstance({contourValue:500,computeNormals:!1,mergePoints:!1});I.setInputData(i);const y=ke.default.newInstance();y.setInputData(m.getOutputData());const h=ke.default.newInstance();h.setInputData(I.getOutputData());const S=Fe.default.newInstance();S.setMapper(y);const D=Fe.default.newInstance();D.setMapper(h),D.getProperty().setDiffuseColor(.9,.85,.77),D.getProperty().setOpacity(parseFloat(r)),D.getProperty().setBackfaceCulling(!1),S.getProperty().setDiffuseColor(.88,.55,.55),S.getProperty().setOpacity(parseFloat(o)),S.getProperty().setBackfaceCulling(!0);const v=function(e){const t=[],n=e.getNumberOfCells(),a=new Array(n).fill(!1),o=[];for(let t=0;t<n;t++)if(!a[t]){const n=[],s=[t];for(;s.length>0;){const t=s.pop();if(!a[t]){a[t]=!0,n.push(t);const o=e.getCellPoints(t).cellPointIds;for(let t=0;t<o.length;t++){const n=o[t],r=e.getPointCells(n);for(let e=0;e<r.length;e++){const t=r[e];a[t]||s.push(t)}}}}o.push(n)}console.log("CELLGROUPS",o,o.length);for(let n=0;n<o.length;n++){const a=o[n],s=Ze.default.newInstance(),r=je.default.newInstance();for(let t=0;t<a.length;t++){const n=a[t],o=e.getCellPoints(n).cellPointIds;r.insertNextCell(o)}s.shallowCopy(e),s.setPolys(r),t.push(s)}return t}(u);console.log("Divided polys from skin",v,v.length);const w=[];v.forEach(((e,t)=>{w.push({index:t,size:e.getNumberOfCells()})})),w.sort(((e,t)=>t.size-e.size));const b=[1,2,3].map((e=>w[e])).map((e=>v[e.index])),E=[];b.forEach(((e,t)=>{const n=ke.default.newInstance();n.setInputData(e);const a=Fe.default.newInstance();a.setMapper(n),a.getProperty().setColor(Math.random(),Math.random(),Math.random()),a.getProperty().setOpacity(1),a.getProperty().setBackfaceCulling(!1),E.push({uid:`aerial_${t}`,actor:a})}));const x=qe.ZP.newInstance();x.setInputData(m.getOutputData());const M=ke.default.newInstance();M.setInputConnection(x.getOutputPort());const C=Fe.default.newInstance();C.setMapper(M),C.getProperty().setColor(1,1,0),C.getProperty().setOpacity(1),t.getRenderer().getRenderWindow().setNumberOfLayers(2),t.getRenderer().setUseDepthPeeling(!0),t.getRenderer().setOcclusionRatio(.1),t.getRenderer().setMaximumNumberOfPeels(100),t.setActors([{uid:"bones",actor:D},{uid:"skin",actor:S},{uid:"outline",actor:C}].concat(E)),t.getRenderer().getActiveCamera().setParallelProjection(!0),t.getRenderer().resetCamera(),(0,Be.getEnabledElement)(t.element).viewport.render()}}))}},"Marching cubes"),Y.createElement(ne.zx,{onClick:()=>{var e;m.length>1?p.setActiveViewportIndex(1):p.setActiveViewportIndex(0),(e=100,new Promise((t=>setTimeout(t,e)))).then((()=>t.runCommand("toggleOneUpCustom",{})))}},"Volume Zoom In / Out"))}function We(e,t,n){const a=[];if(e.length<=1||t<0||t>=e.length)return a;const[o,s]=e[t];let[r,i]=[0,0];if(t>10){const[n,a]=e[t-10];r+=o-n,i+=s-a}if(t<e.length-10){const[n,a]=e[t+10];r+=n-o,i+=a-s}const c=Math.sqrt(r*r+i*i);if(0===c)return a;const l=-i/c,d=r/c;a.push([o,s]);const u=c/(n/2);let m=o-l*c,p=s-d*c;for(let e=0;e<n;e++)m+=l*u,p+=d*u,a.push([m,p]);return a}function Xe(e,t){const n=e.length;let a=0;if(t>=e[n-1][0])a=n-2;else for(;t>e[a+1][0];)a++;const o=e[a][0],s=e[Math.min(a+1,n-1)][0],r=e[Math.max(a-1,0)][1],i=e[a][1],c=e[Math.min(a+1,n-1)][1],l=e[Math.min(a+2,n-1)][1],d=(t-o)/(s-o),u=d*d;return[t,(-.5*r+1.5*i-1.5*c+.5*l)*(d*u)+(r-2.5*i+2*c-.5*l)*u+(-.5*r+.5*c)*d+i]}var Ye=n(29905),Je=n(43976);const Ke=n(7962),Qe=async e=>{var t=e.BitsAllocated,n=e.BitsStored,a=e.Rows,o=e.Columns,s=e.WindowCenter,r=e.WindowWidth;let i,c=e.PixelData;i=16===t?new Int16Array(c):new Int8Array(c);for(var l=Ke([a,o]),d=0;d<a;d++)for(var u=0;u<o;u++){let e=i[d*o+u];s&&r?e=e<=s-.5-(r-1)/2?0:e>s-.5+(r-1)/2?255:~~(255*((e-(s-.5))/(r-1)+.5)):16===t&&(e=256*e/2**n),l.set(d,u,e)}return{buffer:l,height:a,width:o,ext:"png"}};function et(e){let{commandsManager:t,extensionManager:n,servicesManager:a}=e;const{StudyInstanceUIDs:o}=(0,ne.zG)(),[{activeViewportIndex:s,viewports:i},c]=(0,ne.O_)(),{displaySetService:l,cornerstoneViewportService:d,hangingProtocolService:u,toolGroupService:m,measurementService:p,uiNotificationService:g,cornerstoneCacheService:f,customizationService:I}=a.services,{displaySetInstanceUIDs:y,displaySetOptions:h,viewportOptions:S}=i[s],[D,v]=(0,Y.useState)({fcwn:void 0,update:!1,dentascanViewportData:void 0,panoramicViewportData:void 0,panoramic:{width:0,height:0}});(0,Y.useEffect)((()=>{const e=()=>((e,t)=>{const n=new Map;return e.forEach(((e,a)=>{t(e,a)&&n.set(a,e)})),n})(l.getDisplaySetCache(),((e,t)=>e.instance?.imageId?.includes("pngfile")));var n;(n=300,new Promise((e=>setTimeout(e,n)))).then((()=>{const n=e();if(console.log("FDS",n,l.getDisplaySetCache()),n.size>=2){t.runCommand("toggleHangingProtocol",{protocolId:"panoramicViewport",stageIndex:1});const e=f.getPanoramicStateCache();console.log("GET PANORAMIC STATE",e),v({...e,update:!e.update})}else t.runCommand("toggleHangingProtocol",{protocolId:"panoramicViewport",stageIndex:0})}))}),[]),(0,Y.useEffect)((()=>{if(p.getMeasurements().filter((e=>"ArrowAnnotate"===e.toolName)).forEach((e=>{e.metadata.dentascan&&t.runCommand("deleteMeasurement",{uid:e.uid})})),!D.dentascanViewportData)return;const e=d.getCornerstoneViewportByIndex(1);if(!e)return;const n=e.getImageData(),a=n.imageData.indexToWorld([D.dentascanViewportData?.data.initialImageIndex,0,0]),o=n.imageData.indexToWorld([D.dentascanViewportData?.data.initialImageIndex,D.panoramic.height,0]);Ye.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("ArrowAnnotate").addNewDentascanAnnotation(e.element,[a,o],"rgb(255, 255, 255)"),Ye.utilities.jumpToSlice(d.getCornerstoneViewportByIndex(2).element,{imageIndex:D.dentascanViewportData.data.initialImageIndex-4,debounceLoading:!0}),Ye.utilities.jumpToSlice(d.getCornerstoneViewportByIndex(3).element,{imageIndex:D.dentascanViewportData.data.initialImageIndex-2,debounceLoading:!0}),Ye.utilities.jumpToSlice(d.getCornerstoneViewportByIndex(4).element,{imageIndex:D.dentascanViewportData.data.initialImageIndex,debounceLoading:!0}),Ye.utilities.jumpToSlice(d.getCornerstoneViewportByIndex(5).element,{imageIndex:D.dentascanViewportData.data.initialImageIndex+2,debounceLoading:!0}),Ye.utilities.jumpToSlice(d.getCornerstoneViewportByIndex(6).element,{imageIndex:D.dentascanViewportData.data.initialImageIndex+4,debounceLoading:!0}),0!==D.panoramic.width&&f.setPanoramicStateCache(D)}),[D.update]);return Y.createElement("div",{style:{width:"100%",height:"100%"}},Y.createElement("div",{style:{width:"100%",display:"flex",flexDirection:"column",justifyContent:"space-evenly",height:"22.5%"}},Y.createElement("p",{style:{color:"white",fontWeight:"bold"}},"Panoramic Generation"),Y.createElement(ne.zx,{onClick:()=>{t.runCommand("setToolActive",{toolName:"ArrowAnnotate"})}},"Draw Panoramic Line"),Y.createElement(ne.zx,{onClick:()=>{const e=p.getMeasurements().filter((e=>"ArrowAnnotate"===e.toolName&&e.metadata.handmade));if(0===e.length)return void g.show({title:"Panoramic Generation Error",message:"Make sure you have drawn panoramic line to generate panoramic.",type:"error",duration:3e3});const a=d.getCornerstoneViewportByIndex(0);if(!a)return void g.show({title:"Panoramic Generation Error",message:"No viewport detected.",type:"error",duration:3e3});const o=a.getImageData(),s=o.dimensions,i=e[0].points.map((e=>o.imageData.worldToIndex(e))).map((e=>[e[0],e[1]])),c=o.scalarData;let m=[];const I=Math.min(...i.map((e=>e[0]))),y=(Math.max(...i.map((e=>e[0])))-I)/19999;let h=[];h=[];for(let e=0;e<2e4;e++){const t=Xe(i,I+e*y);h.push(t)}let S=function(e){const t=[e[0]];for(let n=1;n<e.length;n++){const a=e[n],o=t[t.length-1],s=a[0]-o[0],r=a[1]-o[1],i=Math.sqrt(s*s+r*r);Math.abs(i-1)<.05&&t.push(a)}return t}(h);const w=S.map((e=>o.imageData.indexToWorld([e[0],e[1],0]))),b=Ye.ToolGroupManager.getToolGroupForViewport(a.id,a.renderingEngineId),E=b.getToolInstance("ArrowAnnotate");console.log("Tool Group",b,E),E.addNewAnnotationWithPoints(a.element,w,"rgb(255, 0, 0)");const x=[];for(let e=0;e<S.length;e++)x.push(We(S,e,50));const M=Math.round(x.length/21);for(let e=0;e<x.length;e+=M){const t=x[e].map((e=>o.imageData.indexToWorld([e[0],e[1],0])));console.log("DISPLAY NORMAL",t,e,x.length),E.addNewAnnotationWithPoints(a.element,t,"rgb(255, 0, 255)")}let C=0,U=0,P=s[0];const R=s[1]*s[2];for(let e=0;e<s[0];e++){let t=[];x.forEach((n=>{let a=0;n.forEach((t=>{const n=[Math.trunc(t[0]),Math.trunc(t[1])],o=[t[0]-n[0],t[1]-n[1]],r=c[R*(s[0]-1-e)+n[1]*s[1]+n[0]],i=c[R*(s[0]-1-e)+n[1]*s[1]+(n[0]+1)],l=c[R*(s[0]-1-e)+(n[1]+1)*s[1]+n[0]];a+=(r+i*o[0]+l*o[1])/(1+o[0]+o[1])})),t.push(a/n.length)})),t.every((e=>e>=-1100&&e<=-900))||(0===U&&(U=e),P=e+1,m=m.concat(t),C+=1)}console.log("MIX MAX LAYER",U,P);let N=new Int16Array(m);N=function(e,t,n){const a=e.slice(),o=[[0,-1,0],[-1,5,-1],[0,-1,0]];for(let s=1;s<n-1;s++)for(let n=1;n<t-1;n++){let r=0;for(let a=0;a<3;a++)for(let i=0;i<3;i++)r+=e[(s+a-1)*t+(n+i-1)]*o[a][i];r=Math.min(32767,Math.max(-32768,r)),a[s*t+n]=r}return a}(N,N.length/C,C);const O=[];var T;x.forEach((e=>{const t=[];for(let n=U;n<P;n++)e.forEach((e=>{{const a=[Math.trunc(e[0]),Math.trunc(e[1])],o=[e[0]-a[0],e[1]-a[1]],r=c[R*(s[0]-1-n)+a[1]*s[1]+a[0]],i=c[R*(s[0]-1-n)+a[1]*s[1]+(a[0]+1)],l=c[R*(s[0]-1-n)+(a[1]+1)*s[1]+a[0]],d=(r+i*o[0]+l*o[1])/(1+o[0]+o[1]);t.push(d)}}));O.push(t)})),(T=500,new Promise((e=>setTimeout(e,T)))).then((()=>{d.getViewportIds();const e={BitsAllocated:16,BitsStored:12,Rows:C,Columns:N.length/C,WindowCenter:440,WindowWidth:2496,PixelData:N};var a;(a=e,new Promise(((e,t)=>{Qe(a).then((t=>{const a=new Uint8ClampedArray(t.width*t.height*4),o=t.buffer.data;let s=0;o.forEach((e=>{a[s]=e,a[s+1]=e,a[s+2]=e,a[s+3]=255,s+=4}));const i=document.createElement("canvas");i.width=t.width,i.height=t.height;const c=new ImageData(new Uint8ClampedArray(a),t.width,t.height);i.getContext("2d").putImageData(c,0,0),i.toBlob((t=>{const a=new Je.Z(t),o=a.addFile(t);a.loadFile(t,o).then((t=>{console.log("FILE LOADED",t),a.getDataset(t,o).then((t=>{console.log("DATASET",t),r.DicomMetadataStore.addInstance(t);const a=l.makeDisplaySets([t]);console.log("DSADDED",a);const o=n.getDataSource()[0];f.createViewportData(a,{toolGroupId:"mpr",viewportType:"stack",initialImageOptions:{preset:"middle"}},o,void 0).then((t=>{u.refreshStudyList(),e(t)}))}))}))}))}))}))).then((a=>{(e=>{const t={SeriesInstanceUID:Math.random().toString(36).substring(2,10),SOPInstanceUID:Math.random().toString(36).substring(2,10),StudyInstanceUID:Math.random().toString(36).substring(2,10),FrameOfReferenceUID:Math.random().toString(36).substring(2,10)},a=e.PixelData;return new Promise(((o,s)=>{const i=new Promise(((n,o)=>{let s=[];for(let e=0;e<a.length;e++)s.push(null);a.forEach(((o,i)=>{e.PixelData=o,Qe(e).then((e=>{const o=new Uint8ClampedArray(e.width*e.height*4),c=e.buffer.data;let l=0;c.forEach((e=>{o[l]=e,o[l+1]=e,o[l+2]=e,o[l+3]=255,l+=4}));const d=document.createElement("canvas");d.width=e.width,d.height=e.height;const u=new ImageData(new Uint8ClampedArray(o),e.width,e.height);d.getContext("2d").putImageData(u,0,0),d.toBlob((e=>{const o=new Je.Z(e),c=o.addFile(e);o.loadFile(e,c).then((e=>{const l=`${t.SOPInstanceUID}.${i+1}`;o.getDataset(e,c,{prefilledValues:{...t,SOPInstanceUID:l,FrameNumber:i}}).then((e=>{r.DicomMetadataStore.addInstance(e),s[i]=e,s.length!==a.length||s.includes(null)||n(s)}))}))}))}))}))}));i.then((e=>{const t=l.makeDisplaySets(e),a=n.getDataSource()[0];f.createViewportData(t,{toolGroupId:"mpr",viewportType:"stack",initialImageOptions:{preset:"middle"}},a,~~(e.length/2)).then((e=>{o(e)}))}))}))})({BitsAllocated:16,BitsStored:12,Rows:P-U,Columns:O[0].length/(P-U),WindowCenter:440,WindowWidth:2496,PixelData:O}).then((n=>{u.refreshStudyList();1!==u.getState().stageIndex&&t.runCommand("toggleHangingProtocol",{protocolId:"panoramicViewport",stageIndex:1}),v({...D,fcwn:x,update:!D.update,dentascanViewportData:n,panoramicViewportData:a,panoramic:{width:O.length,height:e.Rows}}),f.setPanoramicStateCache({...D,fcwn:x,update:!D.update,dentascanViewportData:n,panoramicViewportData:a,panoramic:{width:O.length,height:e.Rows}})}))}))}))}},"Generate panoramic"),Y.createElement(ne.zx,{onClick:()=>{const e=p.getMeasurements().filter((e=>"ArrowAnnotate"===e.toolName));console.log("Measurements",e),e.forEach((e=>{e.metadata.handmade||t.runCommand("deleteMeasurement",{uid:e.uid})}))}},"Delete interpolated curve")),D.panoramic?.width&&Y.createElement("div",{style:{width:"100%",display:"flex",flexDirection:"column",justifyContent:"space-evenly",height:"22.5%"}},Y.createElement("p",{style:{color:"white",fontWeight:"bold"}},"Dentascan Editing"),Y.createElement("div",{style:{width:"90%",display:"flex",height:"10%",flexDirection:"row",justifyContent:"space-between"}},Y.createElement("p",{style:{color:"white",fontSize:"smaller"}},"Section :"),Y.createElement("input",{type:"range",id:"d_section",name:"d_section",value:""+~~D.dentascanViewportData.data.initialImageIndex,min:"0",max:""+(D.panoramic.width-1),style:{width:"70%"},onChange:e=>{v({...D,update:!D.update,dentascanViewportData:{...D.dentascanViewportData,data:{...D.dentascanViewportData.data,initialImageIndex:~~e.target.value}}})}}))),D.panoramic?.width&&Y.createElement("div",{style:{width:"100%",display:"flex",flexDirection:"column",justifyContent:"space-evenly",height:"20.5%"}},Y.createElement("p",{style:{color:"white",fontWeight:"bold"}},"View editing :"),Y.createElement("div",{style:{display:"inline-flex",width:"100%",justifyContent:"space-evenly"}},Y.createElement(ne.zx,{style:{width:"10%"},onClick:()=>{d.getCornerstoneViewportByIndex(0).setOrientation(Be.Enums.OrientationAxis.AXIAL)}},"Axial"),Y.createElement(ne.zx,{style:{width:"10%"},onClick:()=>{d.getCornerstoneViewportByIndex(0).setOrientation(Be.Enums.OrientationAxis.CORONAL)}},"Coronal"),Y.createElement(ne.zx,{style:{width:"10%"},onClick:()=>{d.getCornerstoneViewportByIndex(0).setOrientation(Be.Enums.OrientationAxis.SAGITTAL)}},"Sagittal"))))}const tt=function(e){let{commandsManager:t,extensionManager:n,servicesManager:a}=e;return[{name:"seriesList",iconName:"group-layers",iconLabel:"Studies",label:"Studies",component:Ee.bind(null,{commandsManager:t,extensionManager:n,servicesManager:a})},{name:"measure",iconName:"tab-linear",iconLabel:"Measure",label:"Measurements",secondaryLabel:"Measurements",component:()=>Y.createElement(Ve,{commandsManager:t,servicesManager:a,extensionManager:n})},{name:"volumeEditionPanel",iconName:"edition-3D",iconLabel:"3D Edition",label:"3D Edition",component:_e.bind(null,{commandsManager:t,extensionManager:n,servicesManager:a})},{name:"panoramicGenerationPanel",iconName:"panoramic",iconLabel:"Panoramic Generation",label:"Panoramic",component:et.bind(null,{commandsManager:t,extensionManager:n,servicesManager:a})}]};var nt=n(81596),at=n(32746),ot=n(4797),st=n(51227);const rt=JSON.parse('{"u2":"@ohif/extension-default"}').u2,it="stack",ct=e=>e.NumberOfFrames>1,lt=e=>{const t=e[0],n=new ot.Z(e),{value:a,averageSpacingBetweenFrames:o}=(0,st.Z)(e);n.setAttributes({displaySetInstanceUID:n.uid,SeriesDate:t.SeriesDate,SeriesTime:t.SeriesTime,SeriesInstanceUID:t.SeriesInstanceUID,StudyInstanceUID:t.StudyInstanceUID,SeriesNumber:t.SeriesNumber||0,FrameRate:t.FrameTime,SOPClassUID:t.SOPClassUID,SeriesDescription:t.SeriesDescription||"",Modality:t.Modality,isMultiFrame:ct(t),countIcon:a?"icon-mpr":void 0,numImageFrames:e.length,SOPClassHandlerId:`${rt}.sopClassHandlerModule.${it}`,isReconstructable:a,averageSpacingBetweenFrames:o||null});return n.sortBy(((e,t)=>(parseInt(e.InstanceNumber)||0)-(parseInt(t.InstanceNumber)||0))),n},dt=e=>"CR"===e||"MG"===e||"DX"===e;function ut(e){if(!e||!e.length)throw new Error("No instances were provided");const t=[],n=function(e){const t=new Set;return e.forEach((e=>{t.add(e.SOPClassUID)})),Array.from(t)}(e),a=[];if(e.forEach((e=>{if(!(0,nt.O)(e.SOPClassUID)&&!e.Rows)return;let o;ct(e)?(o=lt([e]),o.setAttributes({sopClassUids:n,isClip:!0,numImageFrames:e.NumberOfFrames,instanceNumber:e.InstanceNumber,acquisitionDatetime:e.AcquisitionDateTime}),t.push(o)):dt(e.Modality)?(o=lt([e]),o.setAttributes({sopClassUids:n,instanceNumber:e.InstanceNumber,acquisitionDatetime:e.AcquisitionDateTime}),t.push(o)):a.push(e)})),a.length){const o=lt(a);o.setAttribute("studyInstanceUid",e[0].StudyInstanceUID),o.setAttributes({sopClassUids:n}),t.push(o)}return t}const mt=[at.Z.ComputedRadiographyImageStorage,at.Z.DigitalXRayImageStorageForPresentation,at.Z.DigitalXRayImageStorageForProcessing,at.Z.DigitalMammographyXRayImageStorageForPresentation,at.Z.DigitalMammographyXRayImageStorageForProcessing,at.Z.DigitalIntraOralXRayImageStorageForPresentation,at.Z.DigitalIntraOralXRayImageStorageForProcessing,at.Z.CTImageStorage,at.Z.EnhancedCTImageStorage,at.Z.LegacyConvertedEnhancedCTImageStorage,at.Z.UltrasoundMultiframeImageStorage,at.Z.MRImageStorage,at.Z.EnhancedMRImageStorage,at.Z.EnhancedMRColorImageStorage,at.Z.LegacyConvertedEnhancedMRImageStorage,at.Z.UltrasoundImageStorage,at.Z.UltrasoundImageStorageRET,at.Z.SecondaryCaptureImageStorage,at.Z.MultiframeSingleBitSecondaryCaptureImageStorage,at.Z.MultiframeGrayscaleByteSecondaryCaptureImageStorage,at.Z.MultiframeGrayscaleWordSecondaryCaptureImageStorage,at.Z.MultiframeTrueColorSecondaryCaptureImageStorage,at.Z.XRayAngiographicImageStorage,at.Z.EnhancedXAImageStorage,at.Z.XRayRadiofluoroscopicImageStorage,at.Z.EnhancedXRFImageStorage,at.Z.XRay3DAngiographicImageStorage,at.Z.XRay3DCraniofacialImageStorage,at.Z.BreastTomosynthesisImageStorage,at.Z.BreastProjectionXRayImageStorageForPresentation,at.Z.BreastProjectionXRayImageStorageForProcessing,at.Z.IntravascularOpticalCoherenceTomographyImageStorageForPresentation,at.Z.IntravascularOpticalCoherenceTomographyImageStorageForProcessing,at.Z.NuclearMedicineImageStorage,at.Z.VLEndoscopicImageStorage,at.Z.VideoEndoscopicImageStorage,at.Z.VLMicroscopicImageStorage,at.Z.VideoMicroscopicImageStorage,at.Z.VLSlideCoordinatesMicroscopicImageStorage,at.Z.VLPhotographicImageStorage,at.Z.VideoPhotographicImageStorage,at.Z.OphthalmicPhotography8BitImageStorage,at.Z.OphthalmicPhotography16BitImageStorage,at.Z.OphthalmicTomographyImageStorage,at.Z.VLWholeSlideMicroscopyImageStorage,at.Z.PositronEmissionTomographyImageStorage,at.Z.EnhancedPETImageStorage,at.Z.LegacyConvertedEnhancedPETImageStorage,at.Z.RTImageStorage,at.Z.EnhancedUSVolumeStorage];const pt=function(){return[{name:it,sopClassUids:mt,getDisplaySetsFromSeries:ut}]};function gt(){return Y.createElement("span",{className:"self-center w-4 h-8 mx-2 border-l border-common-dark"})}function ft(e){let{rows:t,columns:n,className:a,servicesManager:o,...s}=e;const[r,i]=(0,Y.useState)(!1),{hangingProtocolService:c,toolbarService:l}=o.services,d=()=>{r&&i(!1)};(0,Y.useEffect)((()=>{const{unsubscribe:e}=c.subscribe(c.EVENTS.PROTOCOL_CHANGED,(e=>{const{protocol:t}=e}));return()=>{e()}}),[c]),(0,Y.useEffect)((()=>(window.addEventListener("click",d),()=>{window.removeEventListener("click",d)})),[r]);const u=r?ne.OF:null;return Y.createElement(ne.hA,{id:"Layout",label:"Grid Layout",icon:"tool-layout",onInteraction:()=>i(!r),className:a,rounded:s.rounded,dropdownContent:null!==u&&Y.createElement(u,{rows:t,columns:n,onSelection:e=>{l.recordInteraction({interactionType:"action",commands:[{commandName:"setViewportGridLayout",commandOptions:{...e},context:"DEFAULT"}]})}}),isActive:r,type:"toggle"})}ft.propTypes={rows:K().number,columns:K().number,onLayoutChange:K().func,servicesManager:K().instanceOf(r.Xw)},ft.defaultProps={rows:3,columns:3,onLayoutChange:()=>{}};const It=ft,yt=ne.aW;function ht(e,t,n,a){const o={selectorProps:e,event:t},s=function(e,t,n){const{subMenu:a}=t,o=function*(){yield function(e,t){if(t)return e.find((e=>e.id===t))}(e,n||a),yield function(e,t){return e?e.find((e=>!e.selector||e.selector(t.selectorProps))):null}(e,t)}();let s=o.next(),r=s.value;for(;!s.done;)r=s.value,r&&o.return(),s=o.next();return console.log("Menu chosen",r?.id||"NONE"),r}(n,o,a);if(!s)return;if(!s.items)return console.warn("Must define items in menu",s),[];let r=[];return s.items.forEach((a=>{const{delegating:s,selector:i,subMenu:c}=a;if(!i||i(e))if(s)r=[...r,...ht(e,t,n,c)];else{const e=function(e,t){const n={...e,value:t.selectorProps?.value};"ShowSubMenu"!==e.actionType||n.iconRight||(n.iconRight="chevron-menu");e.action||(n.action=(e,a)=>{const{event:o={}}=a,{detail:s={}}=o;n.element=s.element,a.onClose();const r=a[`on${e.actionType||"Default"}`];r?r.call(a,n,e,t):console.warn("No action defined for",e)});return n}(a,o);r.push(e)}})),r}var St,Dt=n(63021);class vt{constructor(e,t){this.commandsManager=void 0,this.services=void 0,this.menuItems=void 0,this.services=e.services,this.commandsManager=t}closeContextMenu(){this.services.uiDialogService.dismiss({id:"context-menu"})}showContextMenu(e,t,n){if(!this.services.uiDialogService)return void console.warn("Unable to show dialog; no UI Dialog Service available.");const{event:a,subMenu:o,menuId:s,menus:r,selectorProps:i}=e;console.log("Getting items from",r);const c=ht(i||e,a,r,s);this.services.uiDialogService.dismiss({id:"context-menu"}),this.services.uiDialogService.create({id:"context-menu",isDraggable:!1,preservePosition:!1,preventCutOf:!0,defaultPosition:vt._getDefaultPosition(n,a?.detail,t),event:a,content:Dt.Z,onClickOutside:()=>this.services.uiDialogService.dismiss({id:"context-menu"}),contentProps:{items:c,selectorProps:i,menus:r,event:a,subMenu:o,eventData:a?.detail,onClose:()=>{this.services.uiDialogService.dismiss({id:"context-menu"})},onShowSubMenu:(a,o,s)=>{o.subMenu?this.showContextMenu({...e,menuId:o.subMenu},t,n):console.warn("No submenu defined for",a,o,s)},onDefault:(e,t,n)=>{this.commandsManager.run(e,{...i,...t,subProps:n})}}})}}St=vt,vt.getDefaultPosition=()=>({x:0,y:0}),vt._getEventDefaultPosition=e=>({x:e&&e.currentPoints.client[0],y:e&&e.currentPoints.client[1]}),vt._getElementDefaultPosition=e=>{if(e){const t=e.getBoundingClientRect();return{x:t.x,y:t.y}}return{x:void 0,y:void 0}},vt._getCanvasPointsPosition=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0;const n=St._getElementDefaultPosition(t);for(let t=0;t<e.length;t++){const a={x:e[t][0]||e[t].x,y:e[t][1]||e[t].y};if(St._isValidPosition(a)&&St._isValidPosition(n))return{x:a.x+n.x,y:a.y+n.y}}},vt._isValidPosition=e=>e&&"number"==typeof e.x&&"number"==typeof e.y,vt._getDefaultPosition=(e,t,n)=>{const a=function*(){yield St._getCanvasPointsPosition(e,n),yield St._getEventDefaultPosition(t),yield St._getElementDefaultPosition(n),yield St.getDefaultPosition()}();let o=a.next(),s=o.value;for(;!o.done;)s=o.value,St._isValidPosition(s)&&a.return(),o=a.next();return s};const wt={id:"measurementsContextMenu",customizationType:"ohif.contextMenu",menus:[{id:"forExistingMeasurement",selector:e=>{let{nearbyToolData:t}=e;return!!t},items:[{label:"Delete curve",commands:[{commandName:"deleteMeasurement"}]},{label:"Add comment",commands:[{commandName:"setMeasurementLabel"}]},{label:"Validate curve",commands:[{commandName:"closeContextMenu"}]}]}]};var bt=n(53806),Et=n.n(bt),xt=n(21767);const Mt={padding:"10px 0"},Ct={borderBottomWidth:"1px",...Mt};function Ut(e){let{tagRef:t,vrRef:n,keywordRef:a,valueRef:o}=e;return Y.createElement("div",{className:re()("flex flex-row w-full bg-secondary-dark ohif-scrollbar overflow-y-scroll"),style:Mt},Y.createElement("div",{className:"px-3 w-4/24"},Y.createElement("label",{ref:t,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},Y.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Tag"))),Y.createElement("div",{className:"px-3 w-2/24"},Y.createElement("label",{ref:n,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},Y.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"VR"))),Y.createElement("div",{className:"px-3 w-6/24"},Y.createElement("label",{ref:a,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},Y.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Keyword"))),Y.createElement("div",{className:"px-3 w-5/24 grow"},Y.createElement("label",{ref:o,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},Y.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Value"))))}const Pt=function(e){let{rows:t}=e;const n=(0,Y.useRef)(),a=(0,Y.useRef)(),[o,s]=(0,Y.useState)(null),[r,i]=(0,Y.useState)(null),[c,l]=(0,Y.useState)(null),[d,u]=(0,Y.useState)(null);(0,Y.useEffect)((()=>{n?.current&&(n.current.scrollTo(0),n.current.resetAfterIndex(0))}),[t]),(0,Y.useEffect)((()=>{const e=Ue()((()=>n.current.resetAfterIndex(0)),100);return window.addEventListener("resize",e),()=>{e.cancel(),window.removeEventListener("resize",e)}}),[]);const m=(0,Y.useCallback)((e=>{let{index:n,style:a}=e;const o=t[n];return Y.createElement("div",{style:{...a,...Ct},className:re()("hover:bg-secondary-main transition duration-300 bg-black flex flex-row w-full border-secondary-light items-center text-base break-all","leading-[20px]"),key:`DICOMTagRow-${n}`},Y.createElement("div",{className:"px-3 w-4/24"},o[0]),Y.createElement("div",{className:"px-3 w-2/24"},o[1]),Y.createElement("div",{className:"px-3 w-6/24"},o[2]),Y.createElement("div",{className:"px-3 w-5/24 grow"},o[3]))}),[t]),p=(0,Y.useCallback)((()=>null!==o),[o]),g=(0,Y.useCallback)((e=>{const n=[o.offsetWidth,r.offsetWidth,c.offsetWidth,d.offsetWidth],s=a.current.getContext("2d");return s.font=getComputedStyle(a.current).font,t[e].map(((e,t)=>{const a=s.measureText(e).width;return 20*Math.ceil(a/n[t])+20+1})).reduce(((e,t)=>Math.max(e,t)))}),[t,c,o,d,r]);return Y.createElement("div",null,Y.createElement("canvas",{style:{visibility:"hidden",position:"absolute"},className:"text-base",ref:a}),Y.createElement(Ut,{tagRef:e=>{e&&s(e)},vrRef:e=>{e&&i(e)},keywordRef:e=>{e&&l(e)},valueRef:e=>{e&&u(e)}}),Y.createElement("div",{className:"m-auto relative border-2 border-black bg-black",style:{height:"32rem"}},p()&&Y.createElement(xt.S_,{ref:n,height:500,itemCount:t.length,itemSize:g,width:"100%",className:"ohif-scrollbar"},m)))},{ImageSet:Rt}=r.classes,{DicomMetaDictionary:Nt}=f.default.data,{nameMap:Ot}=Nt;function Tt(e,t){const n=[];return e.forEach((e=>{if("SQ"===e.vr){n.push([`${e.tagIndent}${e.tag}`,e.vr,e.keyword,""]);const{values:a}=e;a.forEach(((e,a)=>{const o=Tt(e,t);n.push([`${e[0].tagIndent}(FFFE,E000)`,"",`Item #${a}`,""]),n.push(...o)}))}else{if("xs"===e.vr)try{const n=f.default.data.Tag.fromPString(e.tag).toCleanString(),a=t[n];e.vr=a.vr}catch(t){console.error(`Failed to parse value representation for tag '${e.keyword}'`)}n.push([`${e.tagIndent}${e.tag}`,e.vr,e.keyword,e.value])}})),n}function At(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const n=Object.keys(e);let a="";for(let e=0;e<t;e++)a+=">";t>0&&(a+=" ");const o=[];for(let r=0;r<n.length;r++){let i=n[r];if("_vrMap"===i)continue;const c=Ot[i];let l=e[i];if(c&&"SQ"===c.vr){const e=(s=l,Array.isArray(s)?s:[s]),n={tag:c.tag,tagIndent:a,vr:c.vr,keyword:i,values:[]};if(o.push(n),null===l)continue;e.forEach((e=>{const a=At(e,t+1);a.length&&(Vt(a),n.values.push(a))}))}else if(Array.isArray(l)&&l.length>0&&"object"!=typeof l[0]&&(l=l.join("\\")),"number"==typeof l&&(l=l.toString()),"string"!=typeof l&&(null===l?l=" ":"object"==typeof l?l.InlineBinary?l="Inline Binary":l.BulkDataURI?l="Bulk Data URI":l.Alphabetic?l=l.Alphabetic:(console.warn(`Unrecognised Value: ${l} for ${i}:`),console.warn(l),l=" "):(console.warn(`Unrecognised Value: ${l} for ${i}:`),l=" ")),i=i.replace("RETIRED_",""),c)o.push({tag:c.tag,tagIndent:a,vr:c.vr,keyword:i,value:l});else{const e=/[0-9A-Fa-f]{6}/g;if(i.match(e)){const e=`(${i.substring(0,4)},${i.substring(4,8)})`;o.push({tag:e,tagIndent:a,vr:"",keyword:"Private Tag",value:l})}}}var s;return o}function Vt(e){e.sort(((e,t)=>e.tag<t.tag?-1:1))}const Lt=e=>{let{displaySets:t,displaySetInstanceUID:n}=e;const a=new Set([1]),[o,s]=(0,Y.useState)(n),[r,i]=(0,Y.useState)(1),[c,l]=(0,Y.useState)(""),d=(0,Y.useRef)(null),u=t.find((e=>e.displaySetInstanceUID===o)),m=u instanceof Rt;const p=m&&u.images.length>1,g=(0,Y.useMemo)((()=>(t.sort(((e,t)=>e.SeriesNumber-t.SeriesNumber)),t.map((e=>{const{displaySetInstanceUID:t,SeriesDate:n,SeriesTime:a,SeriesNumber:o,SeriesDescription:s,Modality:r}=e,i=`${n}:${a}`.split(".")[0];return{value:t,label:`${o} (${r}): ${s}`,description:Et()(i,"YYYYMMDD:HHmmss").format("ddd, MMM Do YYYY")}})))),[t]),f=(0,Y.useMemo)((()=>{let e;e=m?u.images[r-1]:u.instance||u;const t=function(e){const t=At(e);return Vt(t),t}(e);return Tt(t,e)}),[r,o]),I=(0,Y.useMemo)((()=>{if(!c)return f;const e=c.toLowerCase();return f.filter((t=>t.reduce(((t,n,o)=>t||(a.has(o)?t:t||n.toLowerCase().includes(e))),!1)))}),[f,c]),y=(0,Y.useMemo)((()=>Ue()(l,200)),[]);return(0,Y.useEffect)((()=>()=>{y?.cancel()}),[]),Y.createElement("div",{className:"dicom-tag-browser-content"},Y.createElement("div",{className:"flex flex-row mb-6 items-center pl-1"},Y.createElement("div",{className:"flex flex-row items-center w-1/2"},Y.createElement(ne.ZT,{variant:"subtitle",className:"mr-4"},"Series"),Y.createElement("div",{className:"grow mr-8"},Y.createElement(ne.Ph,{id:"display-set-selector",isClearable:!1,onChange:e=>{s(e.value),i(1)},options:g,value:g.find((e=>e.value===o)),className:"text-white"}))),Y.createElement("div",{className:"flex flex-row items-center w-1/2"},p&&Y.createElement(ne.ZT,{variant:"subtitle",className:"mr-4"},"Instance Number"),p&&Y.createElement("div",{className:"grow"},Y.createElement(ne.OX,{value:r,key:o,onChange:e=>{i(parseInt(e))},minValue:1,maxValue:u.images.length,step:1,inputClassName:"w-full",labelPosition:"left",trackColor:"#3a3f99"})))),Y.createElement("div",{className:"w-full h-1 bg-black"}),Y.createElement("div",{className:"flex flex-row my-3 w-1/2"},Y.createElement("label",{className:"relative block w-full mr-8"},Y.createElement("span",{className:"absolute inset-y-0 left-0 flex items-center pl-2"},Y.createElement(ne.JO,{name:"icon-search"})),Y.createElement("input",{ref:d,type:"text",className:"block bg-black w-full shadow transition duration-300 appearance-none border border-inputfield-main focus:border-inputfield-focus focus:outline-none disabled:border-inputfield-disabled rounded w-full py-2 px-9 text-base leading-tight placeholder:text-inputfield-placeholder",placeholder:"Search metadata...",onChange:e=>y(e.target.value),autoComplete:"off"}),Y.createElement("span",{className:"absolute inset-y-0 right-0 flex items-center pr-2"},Y.createElement(ne.JO,{name:"icon-clear-field",className:re()("cursor-pointer",c?"":"hidden"),onClick:()=>{d.current.value="",y("")}})))),Y.createElement(Pt,{rows:I}))},kt=(e,t,n)=>{console.log("HP - REUSE CACHED LAYOUT",e,t,n);const{activeViewportIndex:a,viewports:o,layout:s}=e,r=t.getState(),{protocolId:i,stageIndex:c,activeStudyUID:l}=r,{protocol:d}=t.getActiveProtocol(),u=d.stages[c],m=`${l}:${i}:${c}`,p=n.getState(),g=`${l}:${i}`,f={...p.viewportGridStore},I={...p.hangingProtocolStageIndexMap},y={...p.displaySetSelectorMap},{rows:h,columns:S}=u.viewportStructure.properties,D=u.viewports.length!==e.viewports.length||e.layout.numRows!==h||e.layout.numCols!==S;I[g]=r,m&&D&&(f[m]={...e});for(let t=0;t<e.viewports.length;t++){const n=e.viewports[t],{displaySetOptions:o,displaySetInstanceUIDs:s}=n;if(o)for(let e=0;e<o.length;e++){const n=s[e];n&&(t===a&&0===e&&(y[`${l}:activeDisplaySet:0`]=n),o[e]?.id&&(y[`${l}:${o[e].id}:${o[e].matchedDisplaySetsIndex||0}`]=n))}}return{hangingProtocolStageIndexMap:I,viewportGridStore:f,displaySetSelectorMap:y}},Ft=(e,t,n,a,o)=>{const s=t?.[a];if(s)return{...s};const{protocolId:r,stageIndex:i}=e.getState();o.inDisplay||(o.inDisplay=[...t.initialInDisplay]);const c=e.getMissingViewport(r,i,o);if(c){const e=c.displaySetsInfo.map((e=>e.displaySetInstanceUID));return o.inDisplay.push(...e),{displaySetInstanceUIDs:e,displaySetOptions:c.displaySetsInfo.map((e=>e.displaySetOptions)),viewportOptions:{...c.viewportOptions}}}return{}},$t=(e,t,n)=>{let{numRows:a,numCols:o}=t;const{viewports:s}=e,r={...n.getState().viewportsByPosition},i=[];for(const e of s)if(e.positionId){const t={...e,viewportOptions:{...e.viewportOptions}};r[e.positionId]=t,delete t.viewportId,delete t.viewportOptions.viewportId}for(let e=0;e<a;e++)for(let t=0;t<o;t++){const n=t+e*o,a=r[s?.[n]?.positionId||`${t}-${e}`];a?.displaySetInstanceUIDs&&i.push(...a.displaySetInstanceUIDs)}return r.initialInDisplay=i,{viewportsByPosition:r}};var Bt=n(53469);const{subscribeToNextViewportGridChange:qt}=r.utils,Ht=e=>e&&("setHangingProtocol"===e.commandName||"toggleHangingProtocol"===e.commandName),Gt=e=>{let{servicesManager:t,commandsManager:n}=e;const{customizationService:a,measurementService:o,hangingProtocolService:s,uiNotificationService:r,viewportGridService:i,displaySetService:c,stateSyncService:l,toolbarService:d}=t.services,u=new vt(t,n),m={showContextMenu:e=>{const{menuCustomizationId:t,element:n,event:o,selectorProps:r,defaultPointsPosition:i=[]}=e,c={...e};t&&Object.assign(c,a.get(t,wt));const{protocol:l,stage:d}=s.getActiveProtocol();c.selectorProps={event:o,protocol:l,stage:d,...r},u.showContextMenu(c,n,i)},closeContextMenu:()=>{u.closeContextMenu()},displayNotification:e=>{let{text:t,title:n,type:a}=e;r.show({title:n,message:t,type:a})},clearMeasurements:()=>{o.clear()},toggleHpTools:()=>{const{protocol:e,stageIndex:t,stage:n}=s.getActiveProtocol(),a=o=>{if(!o.id)return;const{commands:s,items:r}=o.props||o;r&&r.forEach(a);const i=s?.find?.(Ht);if(!i)return;const{protocolId:c,stageIndex:l,stageId:u}=i.commandOptions,m=!(c&&c!==e.id||void 0!==l&&l!==t||u&&u!==n.id);d.setActive(o.id,m)};Object.values(d.getButtons()).forEach(a)},setHangingProtocol:e=>{let{activeStudyUID:t="",protocolId:a,stageId:o,stageIndex:c,reset:d=!1}=e;try{const e=i.getState(),r=s.getState(),{protocol:u}=s.getActiveProtocol(),p=kt(e,s,l);console.log("HP - STATE SYNC REDUCE",p);const{hangingProtocolStageIndexMap:g,viewportGridStore:f,displaySetSelectorMap:I}=p;if(a){if(void 0===c&&void 0===o){const e=`${t||r.activeStudyUID}:${a}`;c=g[e]?.stageIndex}}else a=r.protocolId,void 0===o&&void 0===c&&(c=r.stageIndex);const y=c??s.getStageIndex(a,{stageId:o,stageIndex:c});t&&s.setActiveStudyUID(t);const h=`${s.getState().activeStudyUID}:${a}:${y||0}`,S=!d&&f[h];if(a!==r.protocolId||y!==r.stageIndex||t?(s.setProtocol(a,{displaySetSelectorMap:I,stageId:o,stageIndex:y,restoreProtocol:S}),S&&i.set(f[h])):s.setProtocol(a,{stageId:o,stageIndex:y}),delete I[`${t||r.activeStudyUID}:activeDisplaySet:0`],l.store(p),m.toggleHpTools(s.getActiveProtocol()),a!==r.protocolId){const{protocol:e}=s.getActiveProtocol();n.run(u.callbacks?.onProtocolExit),n.run(e.callbacks?.onProtocolEnter)}return!0}catch(e){return m.toggleHpTools(s.getActiveProtocol()),r.show({title:"Apply Hanging Protocol",message:"The hanging protocol could not be applied.",type:"error",duration:3e3}),!1}},toggleHangingProtocol:e=>{let{protocolId:t,stageIndex:n}=e;const{protocol:a,stageIndex:o,activeStudy:r}=s.getActiveProtocol(),{toggleHangingProtocol:i}=l.getState(),c=`${r.StudyInstanceUID}:${t}:${0|n}`;if(a.id!==t||void 0!==n&&n!==o)return l.store({toggleHangingProtocol:{...i,[c]:{protocolId:a.id,stageIndex:o}}}),m.setHangingProtocol({protocolId:t,stageIndex:n,reset:!0});{const e=i[c]||{protocolId:"default"};return m.setHangingProtocol(e)}},deltaStage:e=>{let{direction:t}=e;const{protocolId:n,stageIndex:a}=s.getState(),{protocol:o}=s.getActiveProtocol();for(let e=a+t;e>=0&&e<o.stages.length;e+=t)if("disabled"!==o.stages[e].status)return m.setHangingProtocol({protocolId:n,stageIndex:e});r.show({title:"Change Stage",message:"The hanging protocol has no more applicable stages",type:"info",duration:3e3})},setViewportGridLayout:e=>{let{numRows:t,numCols:a}=e;const{protocol:o}=s.getActiveProtocol(),r=o.callbacks?.onLayoutChange;if(!1===n.run(r,{numRows:t,numCols:a}))return void console.log("setViewportGridLayout running",r,t,a);window.setTimeout((()=>{const e=i.getState(),n=$t(e,{numRows:t,numCols:a},l),o=Ft.bind(null,s,n.viewportsByPosition);i.setLayout({numRows:t,numCols:a,findOrCreateViewport:o}),l.store(n)}),0)},toggleOneUpCustom(){const e=i.getState(),{activeViewportIndex:t,viewports:n,layout:a}=e,{displaySetInstanceUIDs:o,displaySetOptions:r,viewportOptions:c}=n[t];if(console.log("DoubleClick - TOGGLE ONE UP",c),1===a.numCols&&1===a.numRows){const{toggleOneUpViewportGridStore:e}=l.getState();if(!e.layout)return;const t=e.activeViewportIndex,n=o.length>1?[]:o.map((e=>s.getViewportsRequireUpdate(t,e))).flat(),a=t=>{const a=n.find((e=>e.viewportIndex===t));return a?{viewportOptions:c,displaySetOptions:r,...a}:e.viewports[t]},d=i.getLayoutOptionsFromState(e);i.setLayout({numRows:e.layout.numRows,numCols:e.layout.numCols,activeViewportIndex:t,layoutOptions:d,findOrCreateViewport:a})}else{l.store({toggleOneUpViewportGridStore:e});const t=()=>({displaySetInstanceUIDs:o,displaySetOptions:r,viewportOptions:c});i.setLayout({numRows:1,numCols:1,findOrCreateViewport:t})}},toggleOneUp(){const e=i.getState(),{activeViewportIndex:t,viewports:n,layout:a}=e,{displaySetInstanceUIDs:o,displaySetOptions:r,viewportOptions:c}=n[t];if(1===a.numCols&&1===a.numRows){const{toggleOneUpViewportGridStore:e}=l.getState();if(!e.layout)return;const t=e.activeViewportIndex,n=o.length>1?[]:o.map((e=>s.getViewportsRequireUpdate(t,e))).flat(),a=t=>{const a=n.find((e=>e.viewportIndex===t));return a?{viewportOptions:c,displaySetOptions:r,...a}:e.viewports[t]},d=i.getLayoutOptionsFromState(e);i.setLayout({numRows:e.layout.numRows,numCols:e.layout.numCols,activeViewportIndex:t,layoutOptions:d,findOrCreateViewport:a})}else{l.store({toggleOneUpViewportGridStore:e});const t=()=>({displaySetInstanceUIDs:o,displaySetOptions:r,viewportOptions:c});i.setLayout({numRows:1,numCols:1,findOrCreateViewport:t});qt(i,(()=>{l.store({toggleOneUpViewportGridStore:{}})}))}},navigateHistory(e){Bt.m.navigate(e.to,e.options)},openDICOMTagViewer(){const{activeViewportIndex:e,viewports:n}=i.getState(),a=n[e],{displaySetInstanceUIDs:o}=a,s=c.activeDisplaySets,{UIModalService:r}=t.services,l=o[0];r.show({content:Lt,contentProps:{displaySets:s,displaySetInstanceUID:l,onClose:r.hide},title:"DICOM Tag Browser"})},toggleOverlays:()=>{const e=document.getElementsByClassName("viewport-overlay");for(let t=0;t<e.length;t++)e.item(t).classList.toggle("hidden")},scrollActiveThumbnailIntoView:()=>{const{activeViewportIndex:e,viewports:t}=i.getState();if(!t||e<0||e>t.length-1)return;const n=t[e].displaySetInstanceUIDs[0],a=document.querySelector("#ohif-thumbnail-list");if(!a)return;const o=a.getBoundingClientRect(),s=document.querySelector(`#thumbnail-${n}`);if(!s)return;const r=s.getBoundingClientRect();r.top>=o.top&&r.top<=o.bottom||s.scrollIntoView({behavior:"smooth"})},updateViewportDisplaySet:e=>{let{direction:t,excludeNonImageModalities:n}=e;const a=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"],o=s.getDisplaySetSortFunction(),l=[...c.activeDisplaySets];l.sort(o);const{activeViewportIndex:d,viewports:u}=i.getState(),{displaySetInstanceUIDs:p}=u[d];let g;for(g=l.findIndex((e=>p.includes(e.displaySetInstanceUID)))+t;g>-1&&g<l.length&&(n&&a.includes(l[g].Modality));g+=t);if(g<0||g>=l.length)return;const{displaySetInstanceUID:f}=l[g];let I=[];try{I=s.getViewportsRequireUpdate(d,f)}catch(e){console.warn(e),r.show({title:"Navigate Viewport Display Set",message:"The requested display sets could not be added to the viewport due to a mismatch in the Hanging Protocol rules.",type:"info",duration:3e3})}i.setDisplaySetsForViewports(I),setTimeout((()=>m.scrollActiveThumbnailIntoView()),0)}},p={showContextMenu:{commandFn:m.showContextMenu},closeContextMenu:{commandFn:m.closeContextMenu},clearMeasurements:{commandFn:m.clearMeasurements,storeContexts:[],options:{}},displayNotification:{commandFn:m.displayNotification,storeContexts:[],options:{}},setHangingProtocol:{commandFn:m.setHangingProtocol,storeContexts:[],options:{}},toggleHangingProtocol:{commandFn:m.toggleHangingProtocol,storeContexts:[],options:{}},navigateHistory:{commandFn:m.navigateHistory,storeContexts:[],options:{}},nextStage:{commandFn:m.deltaStage,storeContexts:[],options:{direction:1}},previousStage:{commandFn:m.deltaStage,storeContexts:[],options:{direction:-1}},setViewportGridLayout:{commandFn:m.setViewportGridLayout,storeContexts:[],options:{}},toggleOneUp:{commandFn:m.toggleOneUp,storeContexts:[],options:{}},toggleOneUpCustom:{commandFn:m.toggleOneUpCustom,storeContexts:[],options:{}},openDICOMTagViewer:{commandFn:m.openDICOMTagViewer},updateViewportDisplaySet:{commandFn:m.updateViewportDisplaySet,storeContexts:[],options:{}}};return{actions:m,definitions:p,defaultContext:"DEFAULT"}},Zt={hasUpdatedPriorsInformation:!1,id:"@ohif/mnGrid",description:"Has various hanging protocol grid layouts",name:"2x2",protocolMatchingRules:[{id:"OneOrMoreSeries",weight:25,attribute:"numberOfDisplaySetsWithImages",constraint:{greaterThan:0}}],toolGroupIds:["default"],displaySetSelectors:{defaultDisplaySetId:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:10,constraint:{equals:!0}}]}},defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},stages:[{id:"2x2",stageActivation:{enabled:{minViewportsMatched:4}},viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:2,id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:3,id:"defaultDisplaySetId"}]}]},{id:"3x1",requiredViewports:1,preferredViewports:3,stageActivation:{enabled:{minViewportsMatched:3}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:3}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:1}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:2}]}]},{id:"2x1",requiredViewports:1,preferredViewports:2,stageActivation:{enabled:{minViewportsMatched:2}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:2}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]}]},{id:"1x1",requiredViewports:1,preferredViewports:1,stageActivation:{enabled:{minViewportsMatched:1}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]}]}],numberOfPriorsReferenced:-1},jt={id:"default",locked:!0,hasUpdatedPriorsInformation:!1,name:"Default",createdDate:"2021-02-23T19:22:08.894Z",modifiedDate:"2023-04-01",availableTo:{},editableBy:{},protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{defaultDisplaySetId:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:10,constraint:{equals:!0}}]}},stages:[{name:"default",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{viewportType:"stack",toolGroupId:"default",initialImageOptions:{custom:"sopInstanceLocation"}},displaySets:[{id:"defaultDisplaySetId"}]}],createdDate:"2021-02-23T18:32:42.850Z"}]};const zt=function(){return[{name:jt.id,protocol:jt},{name:Zt.id,protocol:Zt}]};const _t=function(){const[e]=(0,oe.M)(),t=(0,Q.s0)(),n=e.dataSources;return Y.createElement("div",{style:{width:"100%",height:"100%"}},Y.createElement("div",{className:"h-screen w-screen flex justify-center items-center "},Y.createElement("div",{className:"py-8 px-8 mx-auto bg-secondary-dark drop-shadow-md space-y-2 rounded-lg"},Y.createElement("img",{className:"block mx-auto h-14",src:"./ohif-logo.svg",alt:"OHIF"}),Y.createElement("div",{className:"text-center space-y-2 pt-4"},n.filter((e=>"dicomjson"!==e.sourceName&&"dicomlocal"!==e.sourceName)).map((e=>Y.createElement("div",{key:e.sourceName},Y.createElement("h1",{className:"text-white"},e.friendlyName),Y.createElement(ne.zx,{className:re()("font-bold","ml-2"),onClick:()=>{t({pathname:"/",search:`datasources=${e.sourceName}`})}},e.sourceName),Y.createElement("br",null))))))))};var Wt=n(71251);const Xt=r.default.classes.MetadataProvider;var Yt=n(74569);const{registerColormap:Jt}=Be.utilities.colormap,Kt=r.classes.MetadataProvider;const Qt=e=>{let{SeriesInstanceUID:t,StudyInstanceUID:n}=e;const{instances:a}=r.DicomMetadataStore.getSeries(n,t);if("PT"!==a[0].Modality)return;const o=a.map((e=>e.imageId)),s=[];if(o.forEach((e=>{const t=function(e){const t=Xt.get("instance",e);if(!t)throw new Error("dicom metadata are required");if(void 0===t.SeriesDate||void 0===t.SeriesTime||void 0===t.PatientWeight||void 0===t.CorrectedImage||void 0===t.Units||!t.RadiopharmaceuticalInformationSequence||void 0===t.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife||void 0===t.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose||void 0===t.DecayCorrection||void 0===t.AcquisitionDate||void 0===t.AcquisitionTime||void 0===t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime&&void 0===t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime)throw new Error("required metadata are missing");const n={CorrectedImage:t.CorrectedImage,Units:t.Units,RadionuclideHalfLife:t.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife,RadionuclideTotalDose:t.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose,RadiopharmaceuticalStartDateTime:t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime,RadiopharmaceuticalStartTime:t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime,DecayCorrection:t.DecayCorrection,PatientWeight:t.PatientWeight,SeriesDate:t.SeriesDate,SeriesTime:t.SeriesTime,AcquisitionDate:t.AcquisitionDate,AcquisitionTime:t.AcquisitionTime};if(t[70531e3]||void 0!==t[70531e3]||t[70531009]||void 0!==t[70531009]){const e={SUVScaleFactor:t[70531e3],ActivityConcentrationScaleFactor:t[70531009]};n.PhilipsPETPrivateGroup=e}return t["0009100d"]&&void 0!==t["0009100d"]&&(n.GEPrivatePostInjectionDateTime=t["0009100d"]),t.FrameReferenceTime&&void 0!==t.FrameReferenceTime&&(n.FrameReferenceTime=t.FrameReferenceTime),t.ActualFrameDuration&&void 0!==t.ActualFrameDuration&&(n.ActualFrameDuration=t.ActualFrameDuration),t.PatientSex&&void 0!==t.PatientSex&&(n.PatientSex=t.PatientSex),t.PatientSize&&void 0!==t.PatientSize&&(n.PatientSize=t.PatientSize),n}(e);t&&s.push(t)})),!s.length)return;let i;try{i=(0,Wt.d)(s)}catch(e){console.log(e)}i&&(s.forEach(((e,t)=>{Kt.addCustomMetadata(o[t],"scalingModule",i[t])})),Yt.Z.forEach(Jt))},en={id:rt,preRegistration:function(e){let{servicesManager:t,configuration:n={}}=e;const{stateSyncService:a}=t.services;r.DicomMetadataStore.subscribe(r.DicomMetadataStore.EVENTS.INSTANCES_ADDED,Qt),r.DicomMetadataStore.subscribe(r.DicomMetadataStore.EVENTS.SERIES_UPDATED,Qt),a.register("viewportGridStore",{clearOnModeExit:!0}),a.register("displaySetSelectorMap",{clearOnModeExit:!0}),a.register("hangingProtocolStageIndexMap",{clearOnModeExit:!0}),a.register("toggleHangingProtocol",{clearOnModeExit:!0}),a.register("viewportsByPosition",{clearOnModeExit:!0})},getDataSourcesModule:X,getLayoutTemplateModule:function(e){let{servicesManager:t,extensionManager:n,commandsManager:a,hotkeysManager:o}=e;return[{name:"viewerLayout",id:"viewerLayout",component:function(e){return pe({servicesManager:t,extensionManager:n,commandsManager:a,hotkeysManager:o,...e})}}]},getPanelModule:tt,getHangingProtocolModule:zt,getSopClassHandlerModule:pt,getToolbarModule:function(e){let{commandsManager:t,servicesManager:n}=e;return[{name:"ohif.divider",defaultComponent:gt,clickHandler:()=>{}},{name:"ohif.action",defaultComponent:ne.hA,clickHandler:()=>{}},{name:"ohif.radioGroup",defaultComponent:ne.hA,clickHandler:()=>{}},{name:"ohif.splitButton",defaultComponent:yt,clickHandler:()=>{}},{name:"ohif.layoutSelector",defaultComponent:It,clickHandler:(e,t,n)=>{}},{name:"ohif.toggle",defaultComponent:ne.hA,clickHandler:()=>{}}]},getCommandsModule:Gt,getUtilityModule(e){let{servicesManager:t}=e;return[{name:"common",exports:{getStudiesForPatientByMRN:ve}}]},getCustomizationModule:function(){return[{name:"helloPage",value:{id:"customRoutes",routes:[{path:"/custom",children:()=>Y.createElement("h1",{style:{color:"white"}},"Hello Custom Route")}]}},{name:"datasources",value:{id:"customRoutes",routes:[{path:"/datasources",children:_t}]}},{name:"default",value:[{id:"ohif.overlayItem",content:function(e){if(this.condition&&!this.condition(e))return null;const{instance:t}=e,n=t&&this.attribute?t[this.attribute]:this.contentF&&"function"==typeof this.contentF?this.contentF(e):null;return n?Y.createElement("span",{className:"overlay-item flex flex-row",style:{color:this.color||void 0},title:this.title||""},this.label&&Y.createElement("span",{className:"mr-1 shrink-0"},this.label),Y.createElement("span",{className:"font-light"},n)):null}},{id:"ohif.contextMenu",transform:function(e){const t={...this};t.menus=this.menus.map((e=>({...e})));for(const n of t.menus){const{items:t}=n;n.items=[];for(const a of t)n.items.push(e.transform(a))}return t}}]}]}}}}]);
//# sourceMappingURL=91.bundle.0f78ed458535c0e55989.js.map