"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[91],{52091:(e,t,a)=>{a.r(t),a.d(t,{ContextMenuController:()=>wt,CustomizableContextMenuTypes:()=>n,default:()=>ea,dicomWebUtils:()=>o,getStudiesForPatientByMRN:()=>we});var n={};a.r(n);var o={};a.r(o),a.d(o,{fixBulkDataURI:()=>U});var s=a(75935),r=a(48501),i=a(87853);const{getString:c,getName:l,getModalities:d}=r.DICOMWeb;function u(e){if(!e||!e.length)return[];const t=[];return e.forEach((e=>t.push({studyInstanceUid:c(e["0020000D"]),date:c(e["00080020"]),time:c(e["00080030"]),accession:c(e["00080050"])||"",mrn:c(e["00100020"])||"",patientName:r.utils.formatPN(l(e["00100010"]))||"",instances:Number(c(e["00201208"]))||0,description:c(e["00081030"])||"",modalities:c(d(e["00080060"],e["00080061"]))||""}))),t}async function m(e,t,a,n){return await e.searchForStudies({studyInstanceUid:void 0,queryParams:n})}function p(e,t={}){if(!e)return;const a=["00081030","00080060"].join(","),{supportsWildcard:n}=t,o=e=>n&&e?`*${e}*`:e,s={PatientName:o(e.patientName),"00100020":o(e.patientId),AccessionNumber:o(e.accessionNumber),StudyDescription:o(e.studyDescription),ModalitiesInStudy:e.modalitiesInStudy,limit:e.limit||101,offset:e.offset||0,fuzzymatching:!0===t.supportsFuzzyMatching,includefield:a};if(e.startDate&&e.endDate)s.StudyDate=`${e.startDate}-${e.endDate}`;else if(e.startDate){const t=new Date,a=String(t.getDate()).padStart(2,"0"),n=String(t.getMonth()+1).padStart(2,"0"),o=`${t.getFullYear()}${n}${a}`;s.StudyDate=`${e.startDate}-${o}`}else if(e.endDate){const t="19700102";s.StudyDate=`${t}-${e.endDate}`}if(e.studyInstanceUid){let t=e.studyInstanceUid;t=Array.isArray(t)?t.join():t,t=t.replace(/[^0-9.]+/g,"\\"),s.StudyInstanceUID=t}const r={};return Object.keys(s).forEach((e=>{void 0!==s[e]&&""!==s[e]&&(r[e]=s[e])})),r}function g({instance:e,frame:t,config:a,thumbnail:n=!1}){if(!e)return;if(e.url)return e.url;const o=n?"thumbnailRendering":"imageRendering";if(a[o]&&"wadouri"!==a[o])return function(e,t,a){const n=function(e,t,a){const n=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:o}=e;return`${t.wadoRoot}/studies/${a}/series/${n}/instances/${o}`}(e,t);return`${n}/frames/${a=a||1}`}(e,t,a);if(n)return`wadors:${n}`}(e,a,t);{const n=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:o}=t,s=[];s.push("requestType=WADO"),s.push(`studyUID=${a}`),s.push(`seriesUID=${n}`),s.push(`objectUID=${o}`),s.push("contentType=application/dicom"),s.push("transferSyntax=*");const r=s.join("&");return`${e.wadoUriRoot}?${r}`}(a,e);let o="dicomweb:"+n;return void 0!==t&&(o+="&frame="+t),o}}var I=a(22737);class f{constructor(e,t,a={},n,o){this.client=e,this.studyInstanceUID=t,this.filters=a,this.sortCriteria=n,this.sortFunction=o}async execLoad(){const e=await this.preLoad(),t=await this.load(e);return await this.posLoad(t)}async runLoaders(e){let t;for(const a of e)try{if(t=await a(),t&&t.length)break}catch(e){throw e}if(e.next().done&&!t)throw new Error("RetrieveMetadataLoader failed");return t}async configLoad(){}async preLoad(){}async load(e){}async posLoad(e){}}class y extends f{getOptions(){const{studyInstanceUID:e,filters:t}=this,a={studyInstanceUID:e},{seriesInstanceUID:n}=t;return n&&(a.seriesInstanceUID=n),a}*getLoaders(){const e=[],{studyInstanceUID:t,filters:{seriesInstanceUID:a}={},client:n}=this;a&&e.push(n.retrieveSeriesMetadata.bind(n,{studyInstanceUID:t,seriesInstanceUID:a})),e.push(n.retrieveStudyMetadata.bind(n,{studyInstanceUID:t})),yield*e}async load(e){const t=this.getLoaders();return this.runLoaders(t)}async posLoad(e){return e}}class S extends f{*getPreLoaders(){const e=[],{studyInstanceUID:t,filters:{seriesInstanceUID:a}={},client:n}=this;if(a){const o={studyInstanceUID:t,queryParams:{SeriesInstanceUID:a}};e.push(n.searchForSeries.bind(n,o))}e.push(n.searchForSeries.bind(n,{studyInstanceUID:t})),yield*e}async preLoad(){const e=this.getPreLoaders(),t=await this.runLoaders(e),a=this.sortCriteria,n=this.sortFunction,{naturalizeDataset:o}=I.default.data.DicomMetaDictionary,s=t.map(o);return(0,i.IO)(s,a||i.S1.seriesSortCriteria.seriesInfoSortingCriteria,n)}async load(e){const{client:t,studyInstanceUID:a}=this,n=function(e,t,a){return Object.freeze({hasNext:()=>a.length>0,async next(){const n=a.shift();return e.retrieveSeriesMetadata({studyInstanceUID:t,seriesInstanceUID:n})}})}(t,a,e.map((e=>e.SeriesInstanceUID))),o=[];for(;n.hasNext();)o.push(n.next());return{preLoadData:e,promises:o}}async posLoad({preLoadData:e,promises:t}){return{preLoadData:e,promises:t}}}const h=async function(e,t,a,n={},o,s){const r=new(!1!==a?S:y)(e,t,n,o,s);return await r.execLoad()},D="RetrieveStudyMetadata",w=new Map;function v(e,t,a,n,o,s){if(!e)throw new Error(`${D}: Required 'dicomWebClient' parameter not provided.`);if(!t)throw new Error(`${D}: Required 'StudyInstanceUID' parameter not provided.`);if(w.has(t))return w.get(t);const r=new Promise(((r,i)=>{h(e,t,a,n,o,s).then((function(e){r(e)}),i)}));return w.set(t,r),r}function b(e){w.has(e)&&w.delete(e)}class E extends s.api.DICOMwebClient{constructor(e){super(e),this.staticWado=e.staticWado}async searchForStudies(e){if(!this.staticWado)return super.searchForStudies(e);const t=await super.searchForStudies(e),{queryParams:a}=e;if(!a)return t;const n=this.toLowerParams(a);return t.filter((e=>{for(const t of Object.keys(E.studyFilterKeys))if(!this.filterItem(t,n,e,E.studyFilterKeys))return!1;return!0}))}async searchForSeries(e){if(!this.staticWado)return super.searchForSeries(e);const t=await super.searchForSeries(e),{queryParams:a}=e;if(!a)return t;const n=this.toLowerParams(a);return t.filter((e=>{for(const t of Object.keys(E.seriesFilterKeys))if(!this.filterItem(t,n,e,E.seriesFilterKeys))return!1;return!0}))}compareValues(e,t){if(Array.isArray(e))return e.find((e=>this.compareValues(e,t)));if(Array.isArray(t))return t.find((t=>this.compareValues(e,t)));if(t?.Alphabetic&&(t=t.Alphabetic),"string"==typeof t){if(0===t.length)return!0;if(0===e.length||"*"===e)return!0;if("*"===e[0]&&"*"===e[e.length-1])return-1!=t.indexOf(e.substring(1,e.length-1));if("*"===e[e.length-1])return-1!=t.indexOf(e.substring(0,e.length-1));if("*"===e[0])return t.indexOf(e.substring(1))===t.length-e.length+1}return e===t}compareDateRange(e,t){if(!t)return!0;const a=e.indexOf("-");if(-1===a)return this.compareValues(e,t);const n=e.substring(0,a),o=e.substring(a+1);return(!n||t>=n)&&(!o||t<=o)}filterItem(e,t,a,n){const o=n[e]||e;if(!t)return!0;const s=t[e]||t[o];if(!s)return!0;const r=a[e]||a[o];if(!r)return!1;if("DA"==r.vr)return this.compareDateRange(s,r.Value[0]);const i=r.Value;return this.compareValues(s,i)}toLowerParams(e){const t={};return Object.entries(e).forEach((([e,a])=>{t[e.toLowerCase()]=a})),t}}E.studyFilterKeys={studyinstanceuid:"0020000D",patientname:"00100010","00100020":"mrn",studydescription:"00081030",studydate:"00080020",modalitiesinstudy:"00080061",accessionnumber:"00080050"},E.seriesFilterKeys={seriesinstanceuid:"0020000E",seriesnumber:"00200011",modality:"00080060"};const x=(e,t)=>{const{wadoRoot:a,singlepart:n}=e,{instance:o,tag:s="PixelData",defaultPath:i="/pixeldata",defaultType:c="video/mp4",singlepart:l="video"}=t,d=o[s];if(!d)return;if(d.DirectRetrieveURL)return d.DirectRetrieveURL;if(d.InlineBinary){const e=r.utils.b64toBlob(d.InlineBinary,c);return d.DirectRetrieveURL=URL.createObjectURL(e),d.DirectRetrieveURL}if(!n||!0!==n&&-1===n.indexOf(l))return d.retrieveBulkData?d.retrieveBulkData().then((e=>(d.DirectRetrieveURL=URL.createObjectURL(new Blob([e],{type:c})),d.DirectRetrieveURL))):void console.warn("Unable to retrieve",s,"from",o);const{StudyInstanceUID:u,SeriesInstanceUID:m,SOPInstanceUID:p}=o,g=d&&d.BulkDataURI||`series/${m}/instances/${p}${i}`,I=-1!==g.indexOf("?"),f=-1!==g.indexOf("accept=");return"PixelData"===s||"EncapsulatedDocument"===s?`${a}/studies/${u}/series/${m}/instances/${p}/rendered`:g+(f?"":(I?"&":"?")+`accept=${c}`)};function U(e,t,a){if(e.BulkDataURI.startsWith("http")||e.BulkDataURI.startsWith("/")){if("/"===e.BulkDataURI[0]&&a.wadoRoot.startsWith("http")){const t=new URL(a.wadoRoot);e.BulkDataURI=`${t.origin}${e.BulkDataURI}`}}else"studies"===a.bulkDataURI?.relativeResolution?e.BulkDataURI=`${a.wadoRoot}/studies/${t.StudyInstanceUID}/${e.BulkDataURI}`:"series"!==a.bulkDataURI?.relativeResolution&&a.bulkDataURI?.relativeResolution||(e.BulkDataURI=`${a.wadoRoot}/studies/${t.StudyInstanceUID}/series/${t.SeriesInstanceUID}/${e.BulkDataURI}`)}const{DicomMetaDictionary:M,DicomDict:C}=I.default.data,{naturalizeDataset:P,denaturalizeDataset:R}=M,N="2.25.270695996825855179949881587723571202391.2.0.0",O="OHIF-VIEWER-2.0.0",T="1.2.840.10008.1.2.1",A=r.classes.MetadataProvider;function V(e,t){const{qidoRoot:a,wadoRoot:n,enableStudyLazyLoad:o,supportsFuzzyMatching:l,supportsWildcard:d,supportsReject:I,staticWado:f,singlepart:y}=e,S=JSON.parse(JSON.stringify(e)),h={url:a,staticWado:f,singlepart:y,headers:t.getAuthorizationHeader(),errorInterceptor:r.Po.getHTTPErrorHandler()},D={url:n,staticWado:f,singlepart:y,headers:t.getAuthorizationHeader(),errorInterceptor:r.Po.getHTTPErrorHandler()},w=f?new E(h):new s.api.DICOMwebClient(h),M=f?new E(D):new s.api.DICOMwebClient(D),V={initialize:({params:e,query:t})=>{const{StudyInstanceUIDs:a}=e,n=r.utils.splitComma(t.getAll("StudyInstanceUIDs")),o=n.length&&n||a;return o&&Array.isArray(o)?o:[o]},query:{studies:{mapParams:p.bind(),search:async function(e){const a=t.getAuthorizationHeader();a&&(w.headers=a);const{studyInstanceUid:n,seriesInstanceUid:o,...s}=p(e,{supportsFuzzyMatching:l,supportsWildcard:d})||{};return u(await m(w,0,0,s))},processResults:u.bind()},series:{search:async function(e){const a=t.getAuthorizationHeader();a&&(w.headers=a);return function(e){const t=[];return e&&e.length&&e.forEach((e=>t.push({studyInstanceUid:c(e["0020000D"]),seriesInstanceUid:c(e["0020000E"]),modality:c(e["00080060"]),seriesNumber:c(e["00200011"]),seriesDate:r.utils.formatDate(c(e["00080021"])),numSeriesInstances:Number(c(e["00201209"])),description:c(e["0008103E"])}))),(0,i.IO)(t),t}(await function(e,t){const a={includefield:["0008103E","00080021"].join(",")};return e.searchForSeries({studyInstanceUID:t,queryParams:a})}(w,e))}},instances:{search:(e,a)=>{const n=t.getAuthorizationHeader();n&&(w.headers=n),m.call(void 0,w,e,null,a)}}},retrieve:{directURL:e=>x({wadoRoot:n,singlepart:y},e),bulkDataURI:async({StudyInstanceUID:e,BulkDataURI:t})=>{const a={multipart:!1,BulkDataURI:t,StudyInstanceUID:e};return w.retrieveBulkData(a).then((e=>e&&e[0]||void 0))},series:{metadata:async({StudyInstanceUID:e,filters:a,sortCriteria:n,sortFunction:s,madeInClient:r=!1}={})=>{const i=t.getAuthorizationHeader();if(i&&(M.headers=i),!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");return o?V._retrieveSeriesMetadataAsync(e,a,n,s,r):V._retrieveSeriesMetadataSync(e,a,n,s,r)}}},store:{dicom:async(e,a)=>{const n=t.getAuthorizationHeader();if(n&&(M.headers=n),e instanceof ArrayBuffer){const t={datasets:[e],request:a};await M.storeInstances(t)}else{const t={FileMetaInformationVersion:e._meta.FileMetaInformationVersion.Value,MediaStorageSOPClassUID:e.SOPClassUID,MediaStorageSOPInstanceUID:e.SOPInstanceUID,TransferSyntaxUID:T,ImplementationClassUID:N,ImplementationVersionName:O},n=R(t),o=new C(n);o.dict=R(e);const s={datasets:[o.write()],request:a};await M.storeInstances(s)}}},_retrieveSeriesMetadataSync:async(e,t,a,n,o)=>{const s=(await v(M,e,!1,t,a,n)).map(P),i={},c={};s.forEach((t=>{i[t.SeriesInstanceUID]||(i[t.SeriesInstanceUID]={StudyInstanceUID:t.StudyInstanceUID,StudyDescription:t.StudyDescription,SeriesInstanceUID:t.SeriesInstanceUID,SeriesDescription:t.SeriesDescription,SeriesNumber:t.SeriesNumber,SeriesTime:t.SeriesTime,SOPClassUID:t.SOPClassUID,ProtocolName:t.ProtocolName,Modality:t.Modality}),c[t.SeriesInstanceUID]||(c[t.SeriesInstanceUID]=[]);const a=V.getImageIdsForInstance({instance:t});t.imageId=a,A.addImageIdToUIDs(a,{StudyInstanceUID:e,SeriesInstanceUID:t.SeriesInstanceUID,SOPInstanceUID:t.SOPInstanceUID}),c[t.SeriesInstanceUID].push(t)}));const l=Object.values(i);r.DicomMetadataStore.addSeriesMetadata(l,o),Object.keys(c).forEach((e=>r.DicomMetadataStore.addInstances(c[e],o)))},_retrieveSeriesMetadataAsync:async(t,a,n,o,s=!1)=>{const{preLoadData:i,promises:c}=await v(M,t,!0,a,n,o),l=t=>{const a=P(t);return e.bulkDataURI?.enabled?(Object.keys(a).forEach((t=>{const n=a[t];n&&n.BulkDataURI&&!n.Value&&(n.retrieveBulkData=()=>{U(n,a,e);const t={multipart:!1,BulkDataURI:n.BulkDataURI,StudyInstanceUID:a.StudyInstanceUID};return w.retrieveBulkData(t).then((e=>{const t=e instanceof Array&&e.find((e=>e?.byteLength))||void 0;return n.Value=t,t}))})})),a):a};i.forEach((e=>{e.StudyInstanceUID=t})),r.DicomMetadataStore.addSeriesMetadata(i,s);const d=c.map((a=>a.then((a=>{!function(a){const n=a.map(l);n.forEach(((a,n)=>{a.wadoRoot=e.wadoRoot,a.wadoUri=e.wadoUri;const o=V.getImageIdsForInstance({instance:a});a.imageId=o,A.addImageIdToUIDs(o,{StudyInstanceUID:t,SeriesInstanceUID:a.SeriesInstanceUID,SOPInstanceUID:a.SOPInstanceUID})})),r.DicomMetadataStore.addInstances(n,s)}(a)}))));await Promise.all(d),r.DicomMetadataStore.getStudy(t,s).isLoaded=!0},deleteStudyMetadataPromise:b,getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let n=1;n<=t;n++){const t=this.getImageIdsForInstance({instance:e,frame:n});a.push(t)}else{const t=this.getImageIdsForInstance({instance:e});a.push(t)}})),a):a},getImageIdsForInstance:({instance:t,frame:a})=>g({instance:t,frame:a,config:e}),getConfig:()=>S};return I&&(V.reject=function(e){return{series:(t,a)=>new Promise(((n,o)=>{const s=`${e}/studies/${t}/series/${a}/reject/113001%5EDCM`,r=new XMLHttpRequest;r.open("POST",s,!0),console.log(r),r.onreadystatechange=function(){if(4==r.readyState)switch(r.status){case 204:n(r.responseText);break;case 404:o("Your dataSource does not support reject functionality")}},r.send()}))}}(n)),r.Is.create(V)}const L=r.default.classes.MetadataProvider,k={studyInstanceUid:"StudyInstanceUID",patientId:"PatientID"};let F={urls:[]};const $=e=>F.urls.find((t=>t.url===e)),B=(e,t)=>{let a=[];return F.urls.map((n=>{n.studies.map((n=>{n[e]===t&&a.push(n)}))})),a};function q(e){const{name:t,wadoRoot:a}=e,n={initialize:async({params:e,query:t,url:a})=>{a||(a=t.get("url"));let n=$(a);if(n)return n.studies.map((e=>e.StudyInstanceUID));const o=await fetch(a);let s=await o.json();const r=s.studies.map((e=>e.StudyInstanceUID));let i,c;return s.studies.forEach((e=>{i=e.StudyInstanceUID,e.series.forEach((e=>{c=e.SeriesInstanceUID,e.instances.forEach((e=>{const{url:t,metadata:a}=e;L.addImageIdToUIDs(t,{StudyInstanceUID:i,SeriesInstanceUID:c,SOPInstanceUID:a.SOPInstanceUID})}))}))})),F.urls.push({url:a,studies:[...s.studies]}),r},query:{studies:{mapParams:()=>{},search:async e=>{const[t,a]=Object.entries(e)[0],n=k[t];return B(n,a).map((e=>({accession:e.AccessionNumber,date:e.StudyDate,description:e.StudyDescription,instances:e.NumInstances,modalities:e.Modalities,mrn:e.PatientID,patientName:e.PatientName,studyInstanceUid:e.StudyInstanceUID,NumInstances:e.NumInstances,time:e.StudyTime})))},processResults:()=>{console.debug(" DICOMJson QUERY processResults")}},series:{search:()=>{console.debug(" DICOMJson QUERY SERIES SEARCH")}},instances:{search:()=>{console.debug(" DICOMJson QUERY instances SEARCH")}}},retrieve:{directURL:e=>x(a,e),series:{metadata:({StudyInstanceUID:e,madeInClient:t=!1,customSort:a}={})=>{if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const n=B("StudyInstanceUID",e)[0];let o;o=a?a(n.series):n.series;const s=o.map((e=>{const t={StudyInstanceUID:n.StudyInstanceUID,...e};return delete t.instances,t}));r.DicomMetadataStore.addSeriesMetadata(s,t);const i=o.length;o.forEach(((a,o)=>{const s=a.instances.map((e=>{const t={...e.metadata,url:e.url,imageId:e.url,...a,...n};return delete t.instances,delete t.series,t}));var c;c=s,r.DicomMetadataStore.addInstances(c,t),o===i-1&&(r.DicomMetadataStore.getStudy(e,t).isLoaded=!0)}))}}},store:{dicom:()=>{console.debug(" DICOMJson store dicom")}},getImageIdsForDisplaySet(t){const a=t.images,n=[];return a?(t.images.forEach((t=>{const a=t.NumberOfFrames;if(a>1)for(let o=0;o<a;o++){const a=g({instance:t,frame:o,config:e});n.push(a)}else{const a=g({instance:t,config:e});n.push(a)}})),n):n},getImageIdsForInstance:({instance:e,frame:t})=>g({instance:e,frame:t})};return r.Is.create(n)}const H=r.default.classes.MetadataProvider,{EVENTS:G}=r.DicomMetadataStore,Z={SR:!0,SEG:!0,DOC:!0},j=(e,t,a=0)=>e===t?a:e<t?-1:1,z=(e,t)=>{const a=e.instances[0],n=t.instances[0],o=a.Modality,s=n.Modality,r=Z[o],i=Z[s];return r&&i?j(a.SeriesNumber,n.SeriesNumber):r||i?r?-1:1:j(n.SeriesNumber,a.SeriesNumber)};function _(e){const{name:t}=e,a={initialize:({params:e,query:t})=>{const{StudyInstanceUIDs:a}=e,n=t.getAll("StudyInstanceUIDs")||a,o=n&&Array.isArray(n)?n:[n];return o.forEach((e=>{const t=r.DicomMetadataStore.getStudy(e);t.series=t.series.sort(z)})),o},query:{studies:{mapParams:()=>{},search:e=>r.DicomMetadataStore.getStudyInstanceUIDs().map((e=>{let t=0;const a=new Set,n=r.DicomMetadataStore.getStudy(e);n.series.forEach((e=>{t+=e.instances.length,a.add(e.instances[0].Modality)}));const o=n?.series[0]?.instances[0];if(o)return{accession:o.AccessionNumber,date:o.StudyDate,description:o.StudyDescription,mrn:o.PatientID,patientName:r.utils.formatPN(o.PatientName),studyInstanceUid:o.StudyInstanceUID,time:o.StudyTime,instances:t,modalities:Array.from(a).join("/"),NumInstances:t}})),processResults:()=>{console.debug(" DICOMLocal QUERY processResults")}},series:{search:e=>r.DicomMetadataStore.getStudy(e).series.map((t=>{const a=t?.instances[0];return{studyInstanceUid:e,seriesInstanceUid:a.SeriesInstanceUID,modality:a.Modality,seriesNumber:a.SeriesNumber,seriesDate:a.SeriesDate,numSeriesInstances:t.instances.length,description:a.SeriesDescription}}))},instances:{search:()=>{console.debug(" DICOMLocal QUERY instances SEARCH")}}},retrieve:{directURL:e=>{const{instance:t,tag:a,defaultType:n}=e,o=t[a];if(o instanceof Array&&o[0]instanceof ArrayBuffer)return URL.createObjectURL(new Blob([o[0]],{type:n}))},series:{metadata:async({StudyInstanceUID:e,madeInClient:t=!1}={})=>{if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const a=r.DicomMetadataStore.getStudy(e,t);r.DicomMetadataStore._broadcastEvent(G.SERIES_ADDED,{StudyInstanceUID:e,madeInClient:t}),a.series.forEach((a=>{const{SeriesInstanceUID:n}=a,o=a.instances[0].NumberOfFrames>1;a.instances.forEach(((e,t)=>{const{url:a,StudyInstanceUID:n,SeriesInstanceUID:s,SOPInstanceUID:r}=e;e.imageId=a,H.addImageIdToUIDs(a,{StudyInstanceUID:n,SeriesInstanceUID:s,SOPInstanceUID:r,frameIndex:o?t:1})})),r.DicomMetadataStore._broadcastEvent(G.INSTANCES_ADDED,{StudyInstanceUID:e,SeriesInstanceUID:n,madeInClient:t})}))}}},store:{dicom:e=>{const t=I.default.data.datasetToBlob(e);var a=URL.createObjectURL(t);window.location.assign(a)}},getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let n=1;n<=t;n++){const t=this.getImageIdsForInstance({instance:e,frame:n});a.push(t)}else{const t=this.getImageIdsForInstance({instance:e});a.push(t)}})),a):a},getImageIdsForInstance({instance:e,frame:t}){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:o}=e;let s=r.DicomMetadataStore.getInstance(a,n,o).url;return void 0!==t&&(s+=`&frame=${t}`),s},deleteStudyMetadataPromise(){console.log("deleteStudyMetadataPromise not implemented")}};return r.Is.create(a)}function W(e,t){const{name:a}=e;let n;const o={initialize:async({params:e,query:o})=>{let s=[];const r=o.get("studyInstanceUIDs")||o.get("studyInstanceUids");if(!r)throw new Error(`No studyInstanceUids in request for '${a}'`);const i=o.get("url");if(!i)throw new Error(`No url for '${a}'`);{const e=await fetch(i);let a=await e.json();if(!a.servers?.dicomWeb?.[0])throw new Error("Invalid configuration returned by url");n=V(a.servers.dicomWeb[0],t),s=r.split(";")}return s},query:{studies:{search:e=>n.query.studies.search(e)},series:{search:(...e)=>n.query.series.search(...e)},instances:{search:(e,t)=>n.query.instances.search(e,t)}},retrieve:{directURL:(...e)=>n.retrieve.directURL(...e),series:{metadata:(...e)=>n.retrieve.series.metadata(...e)}},store:{dicom:(...e)=>n.store(...e)},deleteStudyMetadataPromise:(...e)=>n.deleteStudyMetadataPromise(...e),getImageIdsForDisplaySet:(...e)=>n.getImageIdsForDisplaySet(...e),getImageIdsForInstance:(...e)=>n.getImageIdsForInstance(...e)};return r.Is.create(o)}const X=function(){return[{name:"dicomweb",type:"webApi",createDataSource:V},{name:"dicomwebproxy",type:"webApi",createDataSource:W},{name:"dicomjson",type:"jsonApi",createDataSource:q},{name:"dicomlocal",type:"localApi",createDataSource:_}]};var Y=a(32735),J=a(60216),K=a.n(J),Q=a(65783),ee=a(21572),te=a(14935),ae=a(22605),ne=a(93058),oe=a(22896),se=a(40841),re=a.n(se);function ie(){return ie=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},ie.apply(this,arguments)}function ce({servicesManager:e}){const{toolbarService:t}=e.services,[a,n]=(0,Y.useState)([]),[o,s]=(0,Y.useState)({primaryToolId:"",toggles:{},groups:{}});return(0,Y.useEffect)((()=>{const{unsubscribe:e}=t.subscribe(t.EVENTS.TOOL_BAR_MODIFIED,(()=>n(t.getButtonSection("primary")))),{unsubscribe:a}=t.subscribe(t.EVENTS.TOOL_BAR_STATE_MODIFIED,(()=>s({...t.state})));return()=>{e(),a()}}),[t]),Y.createElement(Y.Fragment,null,a.map(((a,n)=>{const{id:s,Component:r,componentProps:i}=a;let c;return"toggle"===i.type&&(c=o.toggles[s]),Y.createElement("div",{key:s,className:re()("mr-1")},Y.createElement(r,ie({id:s},i,{bState:o,isActive:c,onInteraction:e=>t.recordInteraction(e),servicesManager:e})))})))}const{availableLanguages:le,defaultLanguage:de,currentLanguage:ue}=ne.default;function me({extensionManager:e,servicesManager:t,hotkeysManager:a,commandsManager:n,viewports:o,ViewportGridComp:s,leftPanels:i=[],rightPanels:c=[],leftPanelDefaultClosed:l=!1,rightPanelDefaultClosed:d=!1}){const[u]=(0,oe.M)(),m=(0,Q.s0)(),p=(0,te.TH)(),{t:g}=(0,ee.$G)(),{show:I,hide:f}=(0,ae.dd)(),[y,S]=(0,Y.useState)(u.showLoadingIndicator),{hangingProtocolService:h}=t.services,{hotkeyDefinitions:D,hotkeyDefaults:w}=a,v=[{title:g("Header:About"),icon:"info",onClick:()=>I({content:ae.tk,title:"About OHIF Viewer",contentProps:{versionNumber:"3.7.0-beta.3",commitHash:"cadb559619306a5900d7a2b92e43bdd161036bd4"}})},{title:g("Header:Preferences"),icon:"settings",onClick:()=>I({title:g("UserPreferencesModal:User Preferences"),content:ae.i1,contentProps:{hotkeyDefaults:a.getValidHotkeyDefinitions(w),hotkeyDefinitions:D,currentLanguage:ue(),availableLanguages:le,defaultLanguage:de,onCancel:()=>{r.dD.stopRecord(),r.dD.unpause(),f()},onSubmit:({hotkeyDefinitions:e,language:t})=>{ne.default.changeLanguage(t.value),a.setHotkeys(e),f()},onReset:()=>a.restoreDefaultBindings(),hotkeysModule:r.dD}})}];u.oidc&&v.push({title:g("Header:Logout"),icon:"power-off",onClick:async()=>{m(`/logout?redirect_uri=${encodeURIComponent(window.location.href)}`)}}),(0,Y.useEffect)((()=>(document.body.classList.add("bg-black"),document.body.classList.add("overflow-hidden"),()=>{document.body.classList.remove("bg-black"),document.body.classList.remove("overflow-hidden")})),[]);const b=t=>{const a=e.getModuleEntry(t);if(!a)throw new Error(`${t} is not a valid entry for an extension module, please check your configuration or make sure the extension is registered.`);let n;if(!a||!a.component)throw new Error(`No component found from extension ${t}. Check the reference string to the extension in your Mode configuration`);return n=a.component,{entry:a,content:n}},E=e=>{const{content:t,entry:a}=b(e);return{id:a.id,iconName:a.iconName,iconLabel:a.iconLabel,label:a.label,name:a.name,content:t}};(0,Y.useEffect)((()=>{const{unsubscribe:e}=h.subscribe(r.hy.EVENTS.PROTOCOL_CHANGED,(()=>{S(!1)}));return()=>{e()}}),[h]);const x=i.map(E),U=c.map(E),M=o.map((e=>{const{entry:t}=b(e.namespace);return{component:t.component,displaySetsToDisplay:e.displaySetsToDisplay}}));return Y.createElement("div",null,Y.createElement(ae.h4,{menuOptions:v,isReturnEnabled:!!u.showStudyList,onClickReturnButton:()=>{const{pathname:e}=p,t=e.indexOf("/",1),a=new URLSearchParams(window.location.search).get("configUrl"),n=new URLSearchParams;-1!==t&&n.append("datasources",e.substring(t+1)),a&&n.append("configUrl",a),m({pathname:"/",search:decodeURIComponent(n.toString())})},WhiteLabeling:u.whiteLabeling},Y.createElement(ae.SV,{context:"Primary Toolbar"},Y.createElement("div",{className:"relative flex justify-center"},Y.createElement(ce,{servicesManager:t})))),Y.createElement("div",{className:"bg-black flex flex-row items-stretch w-full overflow-hidden flex-nowrap relative",style:{height:"calc(100vh - 52px"}},Y.createElement(Y.Fragment,null,y&&Y.createElement(ae.LE,{className:"h-full w-full bg-black"}),x.length?Y.createElement(ae.SV,{context:"Left Panel"},Y.createElement(ae.hs,{side:"left",activeTabIndex:l?null:0,tabs:x,servicesManager:t})):null,Y.createElement("div",{className:"flex flex-col flex-1 h-full"},Y.createElement("div",{className:"flex items-center justify-center flex-1 h-full overflow-hidden bg-black relative"},Y.createElement(ae.SV,{context:"Grid"},Y.createElement(s,{servicesManager:t,viewportComponents:M,commandsManager:n})))),U.length?Y.createElement(ae.SV,{context:"Right Panel"},Y.createElement(ae.hs,{side:"right",activeTabIndex:d?null:0,tabs:U,servicesManager:t})):null)))}me.propTypes={extensionManager:K().shape({getModuleEntry:K().func.isRequired}).isRequired,commandsManager:K().instanceOf(r.HQ),servicesManager:K().instanceOf(r.Xw),leftPanels:K().array,rightPanels:K().array,leftPanelDefaultClosed:K().bool.isRequired,rightPanelDefaultClosed:K().bool.isRequired,children:K().oneOfType([K().node,K().func]).isRequired};const pe=me;const{sortStudyInstances:ge,formatDate:Ie}=r.utils;function fe({servicesManager:e,getImageSrc:t,getStudiesForPatientByMRN:a,requestDisplaySetCreationForStudy:n,dataSource:o}){const{hangingProtocolService:s,displaySetService:r,uiNotificationService:i}=e.services,{StudyInstanceUIDs:c}=(0,ae.zG)(),[{activeViewportIndex:l,viewports:d},u]=(0,ae.O_)(),[m,p]=(0,Y.useState)("primary"),[g,I]=(0,Y.useState)([...c]),[f,y]=(0,Y.useState)([]),[S,h]=(0,Y.useState)([]),[D,w]=(0,Y.useState)({}),v=(0,Y.useRef)(!0);(0,Y.useEffect)((()=>{c.forEach((e=>async function(e){const t=await o.query.studies.search({studyInstanceUid:e});let n=t;try{n=await a(t)}catch(e){console.warn(e)}const s=n.map((e=>({AccessionNumber:e.accession,StudyDate:e.date,StudyDescription:e.description,NumInstances:e.instances,ModalitiesInStudy:e.modalities,PatientID:e.mrn,PatientName:e.patientName,StudyInstanceUID:e.studyInstanceUid,StudyTime:e.time}))).map((e=>({studyInstanceUid:e.StudyInstanceUID,date:Ie(e.StudyDate),description:e.StudyDescription,modalities:e.ModalitiesInStudy,numInstances:e.NumInstances})));y((e=>{const t=[...e];for(const a of s)e.find((e=>e.studyInstanceUid===a.studyInstanceUid))||t.push(a);return t}))}(e)))}),[c,a]),(0,Y.useEffect)((()=>(r.activeDisplaySets.forEach((async e=>{const a={},n=r.getDisplaySetByUID(e.displaySetInstanceUID),s=o.getImageIdsForDisplaySet(n),i=s[Math.floor(s.length/2)];i&&(a[e.displaySetInstanceUID]=await t(i),v.current&&w((e=>({...e,...a}))))})),()=>{v.current=!1})),[]),(0,Y.useEffect)((()=>{const e=Se(r.activeDisplaySets,D);ge(e),h(e)}),[D]),(0,Y.useEffect)((()=>{const e=r.subscribe(r.EVENTS.DISPLAY_SETS_ADDED,(e=>{const{displaySetsAdded:a}=e;a.forEach((async e=>{const a={},n=r.getDisplaySetByUID(e.displaySetInstanceUID),s=o.getImageIdsForDisplaySet(n),i=s[Math.floor(s.length/2)];i&&(a[e.displaySetInstanceUID]=await t(i,e.initialViewport),v.current&&w((e=>({...e,...a}))))}))})),a=r.subscribe(r.EVENTS.DISPLAY_SETS_CHANGED,(e=>{const t=Se(e,D);h(t)}));return()=>{e.unsubscribe(),a.unsubscribe()}}),[]);const b=function(e,t,a){const n=[],o=[],s=[];t.forEach((t=>{const r=a.filter((e=>e.StudyInstanceUID===t.studyInstanceUid)),i=Object.assign({},t,{displaySets:r});e.includes(t.studyInstanceUid)?n.push(i):(o.push(i),s.push(i))}));const r=[{name:"primary",label:"Primary",studies:n},{name:"recent",label:"Recent",studies:o},{name:"all",label:"All",studies:s}];return r}(c,f,S);const E=d[l]?.displaySetInstanceUIDs;return Y.createElement(ae.eX,{tabs:b,servicesManager:e,activeTabName:m,onDoubleClickThumbnail:e=>{let t=[];const a=l;try{t=s.getViewportsRequireUpdate(a,e)}catch(e){console.warn(e),i.show({title:"Thumbnail Double Click",message:"The selected display sets could not be added to the viewport.",type:"info",duration:3e3})}u.setDisplaySetsForViewports(t)},activeDisplaySetInstanceUIDs:E,expandedStudyInstanceUIDs:g,onClickStudy:function(e){const t=g.includes(e),a=t?[...g.filter((t=>t!==e))]:[...g,e];if(I(a),!t){n(r,e,!0)}},onClickTab:e=>{p(e)}})}fe.propTypes={servicesManager:K().object.isRequired,dataSource:K().shape({getImageIdsForDisplaySet:K().func.isRequired}).isRequired,getImageSrc:K().func.isRequired,getStudiesForPatientByMRN:K().func.isRequired,requestDisplaySetCreationForStudy:K().func.isRequired};const ye=fe;function Se(e,t){const a=[],n=[];return e.filter((e=>!e.excludeFromThumbnailBrowser)).forEach((e=>{const o=t[e.displaySetInstanceUID],s=function(e){if(he.includes(e))return"thumbnailNoImage";return"thumbnail"}(e.Modality);("thumbnail"===s?a:n).push({displaySetInstanceUID:e.displaySetInstanceUID,description:e.SeriesDescription||"",seriesNumber:e.SeriesNumber,modality:e.Modality,seriesDate:e.SeriesDate,seriesTime:e.SeriesTime,numInstances:e.numImageFrames,countIcon:e.countIcon,StudyInstanceUID:e.StudyInstanceUID,componentType:s,imageSrc:o,dragData:{type:"displayset",displaySetInstanceUID:e.displaySetInstanceUID}})})),[...a,...n]}const he=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"];const De=function(e,t){return new Promise(((a,n)=>{const o=document.createElement("canvas");e.utilities.loadImageToCanvas({canvas:o,imageId:t}).then((e=>{a(o.toDataURL())})).catch(n)}))};const we=async function(e,t){return t&&t.length&&t[0].mrn?e.query.studies.search({patientId:t[0].mrn}):(console.log("No mrn found for",t),t)};const ve=function(e,t,a,n){t.activeDisplaySets.some((e=>e.StudyInstanceUID===a))||e.retrieve.series.metadata({StudyInstanceUID:a,madeInClient:n})};function be({commandsManager:e,extensionManager:t,servicesManager:a}){const n=t.getDataSources()[0],o=we.bind(null,n),s=function(e){const t=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common");try{const{cornerstone:e}=t.exports.getCornerstoneLibraries();return De.bind(null,e)}catch(e){throw new Error("Required command not found")}}(t),r=ve.bind(null,n);return Y.createElement(ye,{servicesManager:a,dataSource:n,getImageSrc:s,getStudiesForPatientByMRN:o,requestDisplaySetCreationForStudy:r})}be.propTypes={commandsManager:K().object.isRequired,extensionManager:K().object.isRequired,servicesManager:K().object.isRequired};const Ee=be;function xe({onExportClick:e,onCreateReportClick:t}){const{t:a}=(0,ee.$G)("MeasurementTable");return Y.createElement(Y.Fragment,null,Y.createElement(ae.hE,{color:"black",size:"inherit"},Y.createElement(ae.zx,{className:"px-2 py-2 text-base",onClick:e},a("Export CSV")),Y.createElement(ae.zx,{className:"px-2 py-2 text-base",onClick:t},a("Create Report"))))}xe.propTypes={onExportClick:K().func,onCreateReportClick:K().func},xe.defaultProps={onExportClick:()=>alert("Export"),onCreateReportClick:()=>alert("Create Report")};const Ue=xe;var Me=a(40001),Ce=a.n(Me);const Pe={CANCEL:0,CREATE_REPORT:1};function Re(){return Y.createElement("div",{className:"text-primary-active"},"Loading...")}const Ne=async function(e,t,a,n,o){const{displaySetService:s,uiNotificationService:i,uiDialogService:c}=e.services,l=c.create({showOverlay:!0,isDraggable:!1,centralize:!0,content:Re});try{const e=await t.runCommand("storeMeasurements",{measurementData:n,dataSource:a,additionalFindingTypes:["ArrowAnnotate"],options:o},"CORNERSTONE_STRUCTURED_REPORT");r.DicomMetadataStore.addInstances([e],!0);const c=s.getMostRecentDisplaySet();return i.show({title:"Create Report",message:"Measurements saved successfully",type:"success"}),[c]}catch(e){i.show({title:"Create Report",message:e.message||"Failed to store measurements",type:"error"})}finally{c.dismiss({id:l})}},Oe=4700;function Te(e,t){const a=t.getActiveDisplaySets().filter((e=>"SR"===e.Modality)).find((t=>t.SeriesDescription===e));if(a){console.log("Storing to same series",a);const{instance:e}=a,{SeriesInstanceUID:t,SeriesDescription:n,SeriesDate:o,SeriesTime:s,SeriesNumber:r,Modality:i}=e;return{SeriesInstanceUID:t,SeriesDescription:n,SeriesDate:o,SeriesTime:s,SeriesNumber:r,Modality:i,InstanceNumber:a.instances.length+1}}const n=function(e){const t=e.getActiveDisplaySets().filter((e=>"SR"===e.Modality)).map((e=>e.SeriesNumber));return Math.max(...t,Oe)+1}(t);return{SeriesDescription:e,SeriesNumber:n}}const{downloadCSVReport:Ae}=r.utils;function Ve({servicesManager:e,commandsManager:t,extensionManager:a}){const[n,o]=(0,ae.O_)(),{activeViewportIndex:s,viewports:r}=n,{measurementService:i,uiDialogService:c,uiNotificationService:l,displaySetService:d}=e.services,[u,m]=(0,Y.useState)([]);(0,Y.useEffect)((()=>{const e=Ce()(m,100);m(Le(i));const t=i.EVENTS.MEASUREMENT_ADDED,a=i.EVENTS.RAW_MEASUREMENT_ADDED,n=i.EVENTS.MEASUREMENT_UPDATED,o=i.EVENTS.MEASUREMENT_REMOVED,s=i.EVENTS.MEASUREMENTS_CLEARED,r=[];return[t,a,n,o,s].forEach((t=>{r.push(i.subscribe(t,(()=>{e(Le(i))})).unsubscribe)})),()=>{r.forEach((e=>{e()})),e.cancel()}}),[]);const p=({uid:e,isActive:t})=>{if(!t){const t=[...u],a=t.find((t=>t.uid===e));t.forEach((t=>t.isActive=t.uid===e)),a.isActive=!0,m(t)}};return Y.createElement(Y.Fragment,null,Y.createElement("div",{className:"overflow-x-hidden overflow-y-auto ohif-scrollbar","data-cy":"measurements-panel"},Y.createElement(ae.wt,{title:"Measurements",servicesManager:e,data:u,onClick:({uid:e,isActive:t})=>{i.jumpToMeasurement(n.activeViewportIndex,e),p({uid:e,isActive:t})},onEdit:({uid:e,isActive:t})=>{const a=i.getMeasurement(e),n=({action:t,value:n})=>{if("save"===t.id)i.update(e,{...a,...n},!0);c.dismiss({id:"enter-annotation"})};c.create({id:"enter-annotation",centralize:!0,isDraggable:!1,showOverlay:!0,content:ae.Vq,contentProps:{title:"Annotation",noCloseButton:!0,value:{label:a.label||""},body:({value:e,setValue:t})=>Y.createElement(ae.II,{label:"Enter your annotation",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,id:"annotation",className:"bg-black border-primary-main",type:"text",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&n({value:e,action:{id:"save"}})}}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:n}})}})),Y.createElement("div",{className:"flex justify-center p-4"},Y.createElement(Ue,{onExportClick:async function(){const e=i.getMeasurements();Ae(e,i)},onClearMeasurementsClick:async function(){i.clearMeasurements()},onCreateReportClick:async function(){const n=r[s],o=i.getMeasurements(),u=d.getDisplaySetByUID(n.displaySetInstanceUIDs[0]),m=o.filter((e=>u.StudyInstanceUID===e.referenceStudyUID));if(m.length<=0)return void l.show({title:"No Measurements",message:"No Measurements are added to the current Study.",type:"info",duration:3e3});const p=await function(e,{extensionManager:t}){return new Promise((function(a,n){let o;const s=Object.keys(t.dataSourceMap).filter((e=>{const a=t.dataSourceDefs[e]?.configuration;return a?.supportsStow??a?.wadoRoot})).map((e=>({value:e,label:e,placeHolder:e})));o=e.create({centralize:!0,isDraggable:!1,content:ae.Vq,useLastPosition:!1,showOverlay:!0,contentProps:{title:"Create Report",value:{label:"",dataSourceName:t.activeDataSource},noCloseButton:!0,onClose:()=>{e.dismiss({id:o}),a({action:Pe.CANCEL,value:void 0,dataSourceName:void 0})},actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:({action:t,value:n})=>{switch(e.dismiss({id:o}),t.id){case"save":a({action:Pe.CREATE_REPORT,value:n.label,dataSourceName:n.dataSourceName});break;case"cancel":a({action:Pe.CANCEL,value:void 0,dataSourceName:void 0})}},body:({value:t,setValue:n})=>Y.createElement(Y.Fragment,null,s.length>1&&Y.createElement(ae.Ph,{closeMenuOnSelect:!0,className:"mr-2 bg-black border-primary-main",options:s,placeholder:s.find((e=>e.value===t.dataSourceName)).placeHolder,value:t.dataSourceName,onChange:e=>{n((t=>({...t,dataSourceName:e.value})))},isClearable:!1}),Y.createElement(ae.II,{autoFocus:!0,label:"Enter the report name",labelClassName:"text-white text-[14px] leading-[1.2]",className:"bg-black border-primary-main",type:"text",value:t.label,onChange:e=>{e.persist(),n((t=>({...t,label:e.target.value})))},onKeyPress:n=>{"Enter"===n.key&&(e.dismiss({id:o}),a({action:Pe.CREATE_REPORT,value:t.label}))},required:!0}))}})}))}(c,{extensionManager:a});if(p.action===Pe.CREATE_REPORT){const n=a.getDataSources(p.dataSourceName)[0],o=Te(void 0===p.value||""===p.value?"Research Derived Series":p.value,d);return Ne(e,t,n,m,o)}}})))}function Le(e){return e.getMeasurements().map(((t,a)=>function(e,t,a){const{displayText:n,uid:o,label:s,type:r,selected:i,findingSites:c,finding:l}=e,d=c?.[0],u=s||l?.text||d?.text||"(empty)";let m=n||[];if(c){const e=[];c.forEach((t=>{t?.text!==u&&e.push(t.text)})),m=[...e,...m]}l&&l?.text!==u&&(m=[l.text,...m]);return{uid:o,label:u,baseLabel:s,measurementType:r,displayText:m,baseDisplayText:n,isActive:i,finding:l,findingSites:c}}(t,0,e.VALUE_TYPES)))}Ve.propTypes={servicesManager:K().instanceOf(r.Xw).isRequired};var ke=a(84661),Fe=a(31954),$e=a(62962),Be=a(36791),qe=a(24156),He=a(29919),Ge=a(77370),Ze=a(52284),je=a(74462);const ze="cornerstoneStreamingImageVolume";function _e({commandsManager:e,extensionManager:t,servicesManager:a}){const[n,o]=(0,Y.useState)("0.3"),[s,r]=(0,Y.useState)("1"),[i,c]=(0,Y.useState)("1"),{StudyInstanceUIDs:l}=(0,ae.zG)(),[{activeViewportIndex:d,viewports:u},m]=(0,ae.O_)(),{displaySetService:p,cornerstoneViewportService:g,toolbarService:I,hangingProtocolService:f}=a.services;(0,Y.useEffect)((()=>{const t=m.getState();console.log("STATE",t),console.log("HP",f.getActiveProtocol()),"mprAnd3DVolumeViewport"!==f.getActiveProtocol().protocol.id&&e.runCommand("toggleHangingProtocol",{protocolId:"mprAnd3DVolumeViewport",stageIndex:0})}),[]),(0,Y.useEffect)((()=>{u.forEach((e=>{if("volume3d"===e.viewportOptions.viewportType){m.setActiveViewportIndex(e.viewportIndex);const t=g.getCornerstoneViewport(e.id);t.getActors().forEach((e=>{"bones"===e.uid&&e.actor.getProperty().setOpacity(parseFloat(s)),"skin"===e.uid&&e.actor.getProperty().setOpacity(parseFloat(n)),"outline"===e.uid&&e.actor.getProperty().setOpacity(parseFloat(i))})),(0,Be.getEnabledElement)(t.element).viewport.render()}}))}),[s,n,i]);return Y.createElement("div",{style:{width:"100%",display:"flex",flexDirection:"column",justifyContent:"space-evenly",height:"50%"}},Y.createElement("p",{style:{color:"#0941aa",fontSize:"larger"}},"Iso values : "),Y.createElement("div",{style:{display:"inline-flex",width:"100%",justifyContent:"flex-start"}},Y.createElement(ae.Jg,{checked:!1,onChange:()=>{},label:""}),Y.createElement("p",{style:{color:"white"}},"Aerial / Skin : ")),Y.createElement("input",{type:"range",min:"0",max:"1",value:n,className:"slider",id:"myRange",step:"0.01",onChange:e=>o(e.target.value)}),Y.createElement("div",{style:{display:"inline-flex",width:"100%",justifyContent:"flex-start"}},Y.createElement(ae.Jg,{checked:!1,onChange:()=>{},label:""}),Y.createElement("p",{style:{color:"white"}},"Bones :")),Y.createElement("input",{type:"range",min:"0",max:"1",value:s,className:"slider",id:"myRange",step:"0.01",onChange:e=>r(e.target.value)}),Y.createElement("div",{style:{display:"inline-flex",width:"100%",justifyContent:"flex-start"}},Y.createElement(ae.Jg,{checked:!1,onChange:()=>{},label:""}),Y.createElement("p",{style:{color:"white"}},"Outline :")),Y.createElement("input",{type:"range",min:"0",max:"1",value:i,className:"slider",id:"myRange",step:"0.01",onChange:e=>c(e.target.value)}),Y.createElement(ae.zx,{onClick:()=>{u.forEach((e=>{if("volume3d"===e.viewportOptions.viewportType){m.setActiveViewportIndex(e.viewportIndex);const t=g.getCornerstoneViewport(e.id),a=(e=>{const t=p.getDisplaySetByUID(e);return`${t.volumeLoaderSchema??ze}:${t.displaySetInstanceUID}`})(e.displaySetInstanceUIDs[0]),o=t.getActors();let r=t.getActor(a);r||(r=o[0]);const i=r.actor.getMapper().getInputData(),c=He.ZP.newInstance();c.shallowCopy(i);const l=Ge.ZP.newInstance();l.setCroppingPlanes([0,400,50,400,75,280]),l.setInputData(c);const d=$e.ZP.newInstance({contourValue:-400,computeNormals:!0,mergePoints:!0});d.setInputData(l.getOutputData());const u=d.getOutputData();u.buildLinks();const I=$e.ZP.newInstance({contourValue:-400,computeNormals:!0,mergePoints:!0});I.setInputData(i);const f=$e.ZP.newInstance({contourValue:500,computeNormals:!1,mergePoints:!1});f.setInputData(i);const y=ke.default.newInstance();y.setInputData(I.getOutputData());const S=ke.default.newInstance();S.setInputData(f.getOutputData());const h=Fe.default.newInstance();h.setMapper(y);const D=Fe.default.newInstance();D.setMapper(S),D.getProperty().setDiffuseColor(.9,.85,.77),D.getProperty().setOpacity(parseFloat(s)),D.getProperty().setBackfaceCulling(!1),h.getProperty().setDiffuseColor(.88,.55,.55),h.getProperty().setOpacity(parseFloat(n)),h.getProperty().setBackfaceCulling(!0);const w=function(e){const t=[],a=e.getNumberOfCells(),n=new Array(a).fill(!1),o=[];for(let t=0;t<a;t++)if(!n[t]){const a=[],s=[t];for(;s.length>0;){const t=s.pop();if(!n[t]){n[t]=!0,a.push(t);const o=e.getCellPoints(t).cellPointIds;for(let t=0;t<o.length;t++){const a=o[t],r=e.getPointCells(a);for(let e=0;e<r.length;e++){const t=r[e];n[t]||s.push(t)}}}}o.push(a)}console.log("CELLGROUPS",o,o.length);for(let a=0;a<o.length;a++){const n=o[a],s=Ze.default.newInstance(),r=je.default.newInstance();for(let t=0;t<n.length;t++){const a=n[t],o=e.getCellPoints(a).cellPointIds;r.insertNextCell(o)}s.shallowCopy(e),s.setPolys(r),t.push(s)}return t}(u);console.log("Divided polys from skin",w,w.length);const v=[];w.forEach(((e,t)=>{v.push({index:t,size:e.getNumberOfCells()})})),v.sort(((e,t)=>t.size-e.size));const b=[1,2,3].map((e=>v[e])).map((e=>w[e.index])),E=[];b.forEach(((e,t)=>{const a=ke.default.newInstance();a.setInputData(e);const n=Fe.default.newInstance();n.setMapper(a),n.getProperty().setColor(Math.random(),Math.random(),Math.random()),n.getProperty().setOpacity(1),n.getProperty().setBackfaceCulling(!1),E.push({uid:`aerial_${t}`,actor:n})}));const x=qe.ZP.newInstance();x.setInputData(I.getOutputData());const U=ke.default.newInstance();U.setInputConnection(x.getOutputPort());const M=Fe.default.newInstance();M.setMapper(U),M.getProperty().setColor(1,1,0),M.getProperty().setOpacity(1),t.getRenderer().getRenderWindow().setNumberOfLayers(2),t.getRenderer().setUseDepthPeeling(!0),t.getRenderer().setOcclusionRatio(.1),t.getRenderer().setMaximumNumberOfPeels(100),t.setActors([{uid:"bones",actor:D},{uid:"skin",actor:h},{uid:"outline",actor:M}].concat(E)),t.getRenderer().getActiveCamera().setParallelProjection(!0),t.getRenderer().resetCamera(),(0,Be.getEnabledElement)(t.element).viewport.render()}}))}},"Marching cubes"),Y.createElement(ae.zx,{onClick:()=>{var t;u.length>1?m.setActiveViewportIndex(1):m.setActiveViewportIndex(0),(t=100,new Promise((e=>setTimeout(e,t)))).then((()=>e.runCommand("toggleOneUpCustom",{})))}},"Volume Zoom In / Out"))}function We(e,t,a){const n=[];if(e.length<=1||t<0||t>=e.length)return n;const[o,s]=e[t];let[r,i]=[0,0];if(t>10){const[a,n]=e[t-10];r+=o-a,i+=s-n}if(t<e.length-10){const[a,n]=e[t+10];r+=a-o,i+=n-s}const c=Math.sqrt(r*r+i*i);if(0===c)return n;const l=-i/c,d=r/c;n.push([o,s]);const u=c/(a/2);let m=o-l*c,p=s-d*c;for(let e=0;e<a;e++)m+=l*u,p+=d*u,n.push([m,p]);return n}function Xe(e,t){const a=e.length;let n=0;if(t>=e[a-1][0])n=a-2;else for(;t>e[n+1][0];)n++;const o=e[n][0],s=e[Math.min(n+1,a-1)][0],r=e[Math.max(n-1,0)][1],i=e[n][1],c=e[Math.min(n+1,a-1)][1],l=e[Math.min(n+2,a-1)][1],d=(t-o)/(s-o),u=d*d;return[t,(-.5*r+1.5*i-1.5*c+.5*l)*(d*u)+(r-2.5*i+2*c-.5*l)*u+(-.5*r+.5*c)*d+i]}var Ye=a(29905),Je=a(43976);const Ke=a(7962),Qe=async e=>{var t=e.BitsAllocated,a=e.BitsStored,n=e.Rows,o=e.Columns,s=e.WindowCenter,r=e.WindowWidth;let i,c=e.PixelData;i=16===t?new Int16Array(c):new Int8Array(c);for(var l=Ke([n,o]),d=0;d<n;d++)for(var u=0;u<o;u++){let e=i[d*o+u];s&&r?e=e<=s-.5-(r-1)/2?0:e>s-.5+(r-1)/2?255:~~(255*((e-(s-.5))/(r-1)+.5)):16===t&&(e=256*e/2**a),l.set(d,u,e)}return{buffer:l,height:n,width:o,ext:"png"}};function et({commandsManager:e,extensionManager:t,servicesManager:a}){const{StudyInstanceUIDs:n}=(0,ae.zG)(),[{activeViewportIndex:o,viewports:s},i]=(0,ae.O_)(),{displaySetService:c,cornerstoneViewportService:l,hangingProtocolService:d,toolGroupService:u,measurementService:m,uiNotificationService:p,cornerstoneCacheService:g,customizationService:I}=a.services,{displaySetInstanceUIDs:f,displaySetOptions:y,viewportOptions:S}=s[o],[h,D]=(0,Y.useState)({fcwn:void 0,update:!1,dentascanViewportData:void 0,panoramicViewportData:void 0,panoramic:{width:0,height:0}});(0,Y.useEffect)((()=>{const t=l.getCornerstoneViewportByIndex(0),a=Be.metaData.get("generalSeriesModule",t.getCurrentImageId()),n=()=>((e,t)=>{const a=new Map;return e.forEach(((e,n)=>{t(e,n)&&a.set(n,e)})),a})(c.getDisplaySetCache(),((e,t)=>e.SeriesInstanceUID===`${a.seriesInstanceUID}.panoramic`));var o;(o=300,new Promise((e=>setTimeout(e,o)))).then((()=>{const t=n();if(console.log("FDS",t,c.getDisplaySetCache()),t.size>=1){e.runCommand("toggleHangingProtocol",{protocolId:"panoramicViewport",stageIndex:1});const t=g.getPanoramicStateCache(a.seriesInstanceUID);D({...t,update:!t.update})}else e.runCommand("toggleHangingProtocol",{protocolId:"panoramicViewport",stageIndex:0})}))}),[]),(0,Y.useEffect)((()=>{if(m.getMeasurements().filter((e=>"ArrowAnnotate"===e.toolName)).forEach((t=>{t.metadata.dentascan&&e.runCommand("deleteMeasurement",{uid:t.uid})})),!h.dentascanViewportData)return;const t=l.getCornerstoneViewportByIndex(1);if(!t)return;const a=t.getImageData(),n=a.imageData.indexToWorld([h.dentascanViewportData?.data.initialImageIndex,0,0]),o=a.imageData.indexToWorld([h.dentascanViewportData?.data.initialImageIndex,h.panoramic.height,0]);Ye.ToolGroupManager.getToolGroupForViewport(t.id,t.renderingEngineId).getToolInstance("ArrowAnnotate").addNewDentascanAnnotation(t.element,[n,o],"rgb(255, 255, 255)"),Ye.utilities.jumpToSlice(l.getCornerstoneViewportByIndex(2).element,{imageIndex:h.dentascanViewportData.data.initialImageIndex-4,debounceLoading:!0}),Ye.utilities.jumpToSlice(l.getCornerstoneViewportByIndex(3).element,{imageIndex:h.dentascanViewportData.data.initialImageIndex-2,debounceLoading:!0}),Ye.utilities.jumpToSlice(l.getCornerstoneViewportByIndex(4).element,{imageIndex:h.dentascanViewportData.data.initialImageIndex,debounceLoading:!0}),Ye.utilities.jumpToSlice(l.getCornerstoneViewportByIndex(5).element,{imageIndex:h.dentascanViewportData.data.initialImageIndex+2,debounceLoading:!0}),Ye.utilities.jumpToSlice(l.getCornerstoneViewportByIndex(6).element,{imageIndex:h.dentascanViewportData.data.initialImageIndex+4,debounceLoading:!0});const s=Be.metaData.get("generalSeriesModule",t.getCurrentImageId());0!==h.panoramic.width&&g.setPanoramicStateCache(h,s.seriesInstanceUID)}),[h.update]);return Y.createElement("div",{style:{width:"100%",height:"100%"}},Y.createElement("div",{style:{width:"100%",display:"flex",flexDirection:"column",justifyContent:"space-evenly",height:"22.5%"}},Y.createElement("p",{style:{color:"white",fontWeight:"bold"}},"Panoramic Generation"),Y.createElement(ae.zx,{onClick:()=>{e.runCommand("setToolActive",{toolName:"ArrowAnnotate"})}},"Draw Panoramic Line"),Y.createElement(ae.zx,{onClick:()=>{const a=m.getMeasurements().filter((e=>"ArrowAnnotate"===e.toolName&&e.metadata.handmade));if(0===a.length)return void p.show({title:"Panoramic Generation Error",message:"Make sure you have drawn panoramic line to generate panoramic.",type:"error",duration:3e3});const n=l.getCornerstoneViewportByIndex(0),o=Be.metaData.get("voiLutModule",n.getCurrentImageId()),s=Be.metaData.get("imagePixelModule",n.getCurrentImageId()),i=Be.metaData.get("generalSeriesModule",n.getCurrentImageId());if(!n)return void p.show({title:"Panoramic Generation Error",message:"No viewport detected.",type:"error",duration:3e3});const u=n.getImageData(),I=u.dimensions,f=a[0].points.map((e=>u.imageData.worldToIndex(e))).map((e=>[e[0],e[1]])),y=u.scalarData;let S=[];const w=Math.min(...f.map((e=>e[0]))),v=(Math.max(...f.map((e=>e[0])))-w)/19999;let b=[];b=[];for(let e=0;e<2e4;e++){const t=Xe(f,w+e*v);b.push(t)}let E=function(e){const t=[e[0]];for(let a=1;a<e.length;a++){const n=e[a],o=t[t.length-1],s=n[0]-o[0],r=n[1]-o[1],i=Math.sqrt(s*s+r*r);Math.abs(i-1)<.05&&t.push(n)}return t}(b);const x=E.map((e=>u.imageData.indexToWorld([e[0],e[1],0]))),U=Ye.ToolGroupManager.getToolGroupForViewport(n.id,n.renderingEngineId),M=U.getToolInstance("ArrowAnnotate");console.log("Tool Group",U,M),M.addNewAnnotationWithPoints(n.element,x,"rgb(255, 0, 0)");const C=[];for(let e=0;e<E.length;e++)C.push(We(E,e,50));const P=Math.round(C.length/21);for(let e=0;e<C.length;e+=P){const t=C[e].map((e=>u.imageData.indexToWorld([e[0],e[1],0])));console.log("DISPLAY NORMAL",t,e,C.length),M.addNewAnnotationWithPoints(n.element,t,"rgb(255, 0, 255)")}let R=0,N=0,O=I[2];const T=I[0]*I[1];console.log("DIMENSIONS",I,C.length);for(let e=0;e<I[2];e++){let t=[];C.forEach((a=>{let n=0;a.forEach((t=>{const a=[Math.trunc(t[0]),Math.trunc(t[1])],o=[t[0]-a[0],t[1]-a[1]],s=y[T*(I[2]-1-e)+a[1]*I[1]+a[0]],r=y[T*(I[2]-1-e)+a[1]*I[1]+(a[0]+1)],i=y[T*(I[2]-1-e)+(a[1]+1)*I[1]+a[0]];n+=(s+r*o[0]+i*o[1])/(1+o[0]+o[1])})),t.push(n/a.length)})),t.every((e=>e>=-1100&&e<=-900))||(0===N&&(N=e),O=e+1,S=S.concat(t),R+=1)}let A=new Int16Array(S);A=function(e,t,a){const n=e.slice(),o=[[0,-1,0],[-1,5,-1],[0,-1,0]];for(let s=1;s<a-1;s++)for(let a=1;a<t-1;a++){let r=0;for(let n=0;n<3;n++)for(let i=0;i<3;i++)r+=e[(s+n-1)*t+(a+i-1)]*o[n][i];r=Math.min(32767,Math.max(-32768,r)),n[s*t+a]=r}return n}(A,A.length/R,R);const V=[];var L;C.forEach((e=>{const t=[];for(let a=N;a<O;a++)e.forEach((e=>{{const n=[Math.trunc(e[0]),Math.trunc(e[1])],o=[e[0]-n[0],e[1]-n[1]],s=y[T*(I[2]-1-a)+n[1]*I[1]+n[0]],r=y[T*(I[2]-1-a)+n[1]*I[1]+(n[0]+1)],i=y[T*(I[2]-1-a)+(n[1]+1)*I[1]+n[0]],c=(s+r*o[0]+i*o[1])/(1+o[0]+o[1]);t.push(c)}}));V.push(t)})),(L=500,new Promise((e=>setTimeout(e,L)))).then((()=>{const a={SeriesInstanceUID:i.seriesInstanceUID+".panoramic",StudyInstanceUID:i.studyInstanceUID,BitsAllocated:s.bitsAllocated,BitsStored:s.bitsStored,Rows:R,Columns:A.length/R,WindowCenter:o.windowCenter[0],WindowWidth:o.windowWidth[0],PixelData:A};var n;(n=a,new Promise(((e,a)=>{Qe(n).then((a=>{const o=new Uint8ClampedArray(a.width*a.height*4),s=a.buffer.data;let i=0;s.forEach((e=>{o[i]=e,o[i+1]=e,o[i+2]=e,o[i+3]=255,i+=4}));const l=document.createElement("canvas");l.width=a.width,l.height=a.height;const u=new ImageData(new Uint8ClampedArray(o),a.width,a.height);l.getContext("2d").putImageData(u,0,0),l.toBlob((a=>{const o=new Je.Z(a),s=o.addFile(a);o.loadFile(a,s).then((a=>{o.getDataset(a,s,{prefilledValues:{SeriesInstanceUID:n.SeriesInstanceUID,StudyInstanceUID:n.StudyInstanceUID}}).then((a=>{console.log("DATASET",a),r.DicomMetadataStore.addInstance(a);const n=c.makeDisplaySets([a]);console.log("DSADDED",n);const o=t.getDataSource()[0];g.createViewportData(n,{toolGroupId:"mpr",viewportType:"stack",initialImageOptions:{preset:"middle"}},o,void 0).then((t=>{document.body.appendChild(l),d.refreshStudyList(),e(t)}))}))}))}))}))}))).then((n=>{(e=>{const a={SeriesInstanceUID:e.SeriesInstanceUID,SOPInstanceUID:Math.random().toString(36).substring(2,10),StudyInstanceUID:e.StudyInstanceUID,FrameOfReferenceUID:Math.random().toString(36).substring(2,10)},n=e.PixelData;return new Promise(((o,s)=>{const i=new Promise(((t,o)=>{let s=[];for(let e=0;e<n.length;e++)s.push(null);n.forEach(((o,i)=>{e.PixelData=o,Qe(e).then((e=>{const o=new Uint8ClampedArray(e.width*e.height*4),c=e.buffer.data;let l=0;c.forEach((e=>{o[l]=e,o[l+1]=e,o[l+2]=e,o[l+3]=255,l+=4}));const d=document.createElement("canvas");d.width=e.width,d.height=e.height;const u=new ImageData(new Uint8ClampedArray(o),e.width,e.height);d.getContext("2d").putImageData(u,0,0),d.toBlob((e=>{const o=new Je.Z(e),c=o.addFile(e);o.loadFile(e,c).then((e=>{const l=`${a.SOPInstanceUID}.${i+1}`;o.getDataset(e,c,{prefilledValues:{...a,SOPInstanceUID:l,FrameNumber:i}}).then((e=>{r.DicomMetadataStore.addInstance(e),s[i]=e,s.length!==n.length||s.includes(null)||t(s)}))}))}))}))}))}));i.then((e=>{const a=c.makeDisplaySets(e),n=t.getDataSource()[0];g.createViewportData(a,{toolGroupId:"mpr",viewportType:"stack",initialImageOptions:{preset:"middle"}},n,~~(e.length/2)).then((e=>{o(e)}))}))}))})({SeriesInstanceUID:i.seriesInstanceUID+".dentascan",StudyInstanceUID:i.studyInstanceUID,BitsAllocated:s.bitsAllocated,BitsStored:s.bitsStored,Rows:O-N,Columns:V[0].length/(O-N),WindowCenter:o.windowCenter[0],WindowWidth:o.windowWidth[0],PixelData:V}).then((t=>{d.refreshStudyList();1!==d.getState().stageIndex&&e.runCommand("toggleHangingProtocol",{protocolId:"panoramicViewport",stageIndex:1}),D({...h,fcwn:C,update:!h.update,dentascanViewportData:t,panoramicViewportData:n,panoramic:{width:V.length,height:a.Rows}}),g.setPanoramicStateCache({...h,fcwn:C,update:!h.update,dentascanViewportData:t,panoramicViewportData:n,panoramic:{width:V.length,height:a.Rows}},i.seriesInstanceUID)}))}))}))}},"Generate panoramic"),Y.createElement(ae.zx,{onClick:()=>{const t=m.getMeasurements().filter((e=>"ArrowAnnotate"===e.toolName));console.log("Measurements",t),t.forEach((t=>{t.metadata.handmade||e.runCommand("deleteMeasurement",{uid:t.uid})}))}},"Delete interpolated curve")),h.panoramic?.width&&Y.createElement("div",{style:{width:"100%",display:"flex",flexDirection:"column",justifyContent:"space-evenly",height:"22.5%"}},Y.createElement("p",{style:{color:"white",fontWeight:"bold"}},"Dentascan Editing"),Y.createElement("div",{style:{width:"90%",display:"flex",height:"10%",flexDirection:"row",justifyContent:"space-between"}},Y.createElement("p",{style:{color:"white",fontSize:"smaller"}},"Section :"),Y.createElement("input",{type:"range",id:"d_section",name:"d_section",value:""+~~h.dentascanViewportData.data.initialImageIndex,min:"0",max:""+(h.panoramic.width-1),style:{width:"70%"},onChange:e=>{D({...h,update:!h.update,dentascanViewportData:{...h.dentascanViewportData,data:{...h.dentascanViewportData.data,initialImageIndex:~~e.target.value}}})}}))),h.panoramic?.width&&Y.createElement("div",{style:{width:"100%",display:"flex",flexDirection:"column",justifyContent:"space-evenly",height:"20.5%"}},Y.createElement("p",{style:{color:"white",fontWeight:"bold"}},"View editing :"),Y.createElement("div",{style:{display:"inline-flex",width:"100%",justifyContent:"space-evenly"}},Y.createElement(ae.zx,{style:{width:"10%"},onClick:()=>{l.getCornerstoneViewportByIndex(0).setOrientation(Be.Enums.OrientationAxis.AXIAL)}},"Axial"),Y.createElement(ae.zx,{style:{width:"10%"},onClick:()=>{l.getCornerstoneViewportByIndex(0).setOrientation(Be.Enums.OrientationAxis.CORONAL)}},"Coronal"),Y.createElement(ae.zx,{style:{width:"10%"},onClick:()=>{l.getCornerstoneViewportByIndex(0).setOrientation(Be.Enums.OrientationAxis.SAGITTAL)}},"Sagittal"))))}const tt=function({commandsManager:e,extensionManager:t,servicesManager:a}){return[{name:"seriesList",iconName:"group-layers",iconLabel:"Studies",label:"Studies",component:Ee.bind(null,{commandsManager:e,extensionManager:t,servicesManager:a})},{name:"measure",iconName:"tab-linear",iconLabel:"Measure",label:"Measurements",secondaryLabel:"Measurements",component:()=>Y.createElement(Ve,{commandsManager:e,servicesManager:a,extensionManager:t})},{name:"volumeEditionPanel",iconName:"edition-3D",iconLabel:"3D Edition",label:"3D Edition",component:_e.bind(null,{commandsManager:e,extensionManager:t,servicesManager:a})},{name:"panoramicGenerationPanel",iconName:"panoramic",iconLabel:"Panoramic Generation",label:"Panoramic",component:et.bind(null,{commandsManager:e,extensionManager:t,servicesManager:a})}]};var at=a(81596),nt=a(32746),ot=a(4797),st=a(51227);const rt=JSON.parse('{"u2":"@ohif/extension-default"}').u2,it="stack",ct=e=>e.NumberOfFrames>1,lt=e=>{const t=e[0],a=new ot.Z(e),{value:n,averageSpacingBetweenFrames:o}=(0,st.Z)(e);a.setAttributes({displaySetInstanceUID:a.uid,SeriesDate:t.SeriesDate,SeriesTime:t.SeriesTime,SeriesInstanceUID:t.SeriesInstanceUID,StudyInstanceUID:t.StudyInstanceUID,SeriesNumber:t.SeriesNumber||0,FrameRate:t.FrameTime,SOPClassUID:t.SOPClassUID,SeriesDescription:t.SeriesDescription||"",Modality:t.Modality,isMultiFrame:ct(t),countIcon:n?"icon-mpr":void 0,numImageFrames:e.length,SOPClassHandlerId:`${rt}.sopClassHandlerModule.${it}`,isReconstructable:n,averageSpacingBetweenFrames:o||null});return a.sortBy(((e,t)=>(parseInt(e.InstanceNumber)||0)-(parseInt(t.InstanceNumber)||0))),a},dt=e=>"CR"===e||"MG"===e||"DX"===e;function ut(e){if(!e||!e.length)throw new Error("No instances were provided");const t=[],a=function(e){const t=new Set;return e.forEach((e=>{t.add(e.SOPClassUID)})),Array.from(t)}(e),n=[];if(e.forEach((e=>{if(!(0,at.O)(e.SOPClassUID)&&!e.Rows)return;let o;ct(e)?(o=lt([e]),o.setAttributes({sopClassUids:a,isClip:!0,numImageFrames:e.NumberOfFrames,instanceNumber:e.InstanceNumber,acquisitionDatetime:e.AcquisitionDateTime}),t.push(o)):dt(e.Modality)?(o=lt([e]),o.setAttributes({sopClassUids:a,instanceNumber:e.InstanceNumber,acquisitionDatetime:e.AcquisitionDateTime}),t.push(o)):n.push(e)})),n.length){const o=lt(n);o.setAttribute("studyInstanceUid",e[0].StudyInstanceUID),o.setAttributes({sopClassUids:a}),t.push(o)}return t}const mt=[nt.Z.ComputedRadiographyImageStorage,nt.Z.DigitalXRayImageStorageForPresentation,nt.Z.DigitalXRayImageStorageForProcessing,nt.Z.DigitalMammographyXRayImageStorageForPresentation,nt.Z.DigitalMammographyXRayImageStorageForProcessing,nt.Z.DigitalIntraOralXRayImageStorageForPresentation,nt.Z.DigitalIntraOralXRayImageStorageForProcessing,nt.Z.CTImageStorage,nt.Z.EnhancedCTImageStorage,nt.Z.LegacyConvertedEnhancedCTImageStorage,nt.Z.UltrasoundMultiframeImageStorage,nt.Z.MRImageStorage,nt.Z.EnhancedMRImageStorage,nt.Z.EnhancedMRColorImageStorage,nt.Z.LegacyConvertedEnhancedMRImageStorage,nt.Z.UltrasoundImageStorage,nt.Z.UltrasoundImageStorageRET,nt.Z.SecondaryCaptureImageStorage,nt.Z.MultiframeSingleBitSecondaryCaptureImageStorage,nt.Z.MultiframeGrayscaleByteSecondaryCaptureImageStorage,nt.Z.MultiframeGrayscaleWordSecondaryCaptureImageStorage,nt.Z.MultiframeTrueColorSecondaryCaptureImageStorage,nt.Z.XRayAngiographicImageStorage,nt.Z.EnhancedXAImageStorage,nt.Z.XRayRadiofluoroscopicImageStorage,nt.Z.EnhancedXRFImageStorage,nt.Z.XRay3DAngiographicImageStorage,nt.Z.XRay3DCraniofacialImageStorage,nt.Z.BreastTomosynthesisImageStorage,nt.Z.BreastProjectionXRayImageStorageForPresentation,nt.Z.BreastProjectionXRayImageStorageForProcessing,nt.Z.IntravascularOpticalCoherenceTomographyImageStorageForPresentation,nt.Z.IntravascularOpticalCoherenceTomographyImageStorageForProcessing,nt.Z.NuclearMedicineImageStorage,nt.Z.VLEndoscopicImageStorage,nt.Z.VideoEndoscopicImageStorage,nt.Z.VLMicroscopicImageStorage,nt.Z.VideoMicroscopicImageStorage,nt.Z.VLSlideCoordinatesMicroscopicImageStorage,nt.Z.VLPhotographicImageStorage,nt.Z.VideoPhotographicImageStorage,nt.Z.OphthalmicPhotography8BitImageStorage,nt.Z.OphthalmicPhotography16BitImageStorage,nt.Z.OphthalmicTomographyImageStorage,nt.Z.VLWholeSlideMicroscopyImageStorage,nt.Z.PositronEmissionTomographyImageStorage,nt.Z.EnhancedPETImageStorage,nt.Z.LegacyConvertedEnhancedPETImageStorage,nt.Z.RTImageStorage,nt.Z.EnhancedUSVolumeStorage];const pt=function(){return[{name:it,sopClassUids:mt,getDisplaySetsFromSeries:ut}]};function gt(){return Y.createElement("span",{className:"self-center w-4 h-8 mx-2 border-l border-common-dark"})}function It({rows:e,columns:t,className:a,servicesManager:n,...o}){const[s,r]=(0,Y.useState)(!1),{hangingProtocolService:i,toolbarService:c}=n.services,l=()=>{s&&r(!1)};(0,Y.useEffect)((()=>{const{unsubscribe:e}=i.subscribe(i.EVENTS.PROTOCOL_CHANGED,(e=>{const{protocol:t}=e}));return()=>{e()}}),[i]),(0,Y.useEffect)((()=>(window.addEventListener("click",l),()=>{window.removeEventListener("click",l)})),[s]);const d=s?ae.OF:null;return Y.createElement(ae.hA,{id:"Layout",label:"Grid Layout",icon:"tool-layout",onInteraction:()=>r(!s),className:a,rounded:o.rounded,dropdownContent:null!==d&&Y.createElement(d,{rows:e,columns:t,onSelection:e=>{c.recordInteraction({interactionType:"action",commands:[{commandName:"setViewportGridLayout",commandOptions:{...e},context:"DEFAULT"}]})}}),isActive:s,type:"toggle"})}It.propTypes={rows:K().number,columns:K().number,onLayoutChange:K().func,servicesManager:K().instanceOf(r.Xw)},It.defaultProps={rows:3,columns:3,onLayoutChange:()=>{}};const ft=It,yt=ae.aW;function St(e,t,a,n){const o={selectorProps:e,event:t},s=function(e,t,a){const{subMenu:n}=t,o=function*(){yield function(e,t){if(t)return e.find((e=>e.id===t))}(e,a||n),yield function(e,t){return e?e.find((e=>!e.selector||e.selector(t.selectorProps))):null}(e,t)}();let s=o.next(),r=s.value;for(;!s.done;)r=s.value,r&&o.return(),s=o.next();return console.log("Menu chosen",r?.id||"NONE"),r}(a,o,n);if(!s)return;if(!s.items)return console.warn("Must define items in menu",s),[];let r=[];return s.items.forEach((n=>{const{delegating:s,selector:i,subMenu:c}=n;if(!i||i(e))if(s)r=[...r,...St(e,t,a,c)];else{const e=function(e,t){const a={...e,value:t.selectorProps?.value};"ShowSubMenu"!==e.actionType||a.iconRight||(a.iconRight="chevron-menu");e.action||(a.action=(e,n)=>{const{event:o={}}=n,{detail:s={}}=o;a.element=s.element,n.onClose();const r=n[`on${e.actionType||"Default"}`];r?r.call(n,a,e,t):console.warn("No action defined for",e)});return a}(n,o);r.push(e)}})),r}var ht,Dt=a(63021);class wt{constructor(e,t){this.commandsManager=void 0,this.services=void 0,this.menuItems=void 0,this.services=e.services,this.commandsManager=t}closeContextMenu(){this.services.uiDialogService.dismiss({id:"context-menu"})}showContextMenu(e,t,a){if(!this.services.uiDialogService)return void console.warn("Unable to show dialog; no UI Dialog Service available.");const{event:n,subMenu:o,menuId:s,menus:r,selectorProps:i}=e;console.log("Getting items from",r);const c=St(i||e,n,r,s);this.services.uiDialogService.dismiss({id:"context-menu"}),this.services.uiDialogService.create({id:"context-menu",isDraggable:!1,preservePosition:!1,preventCutOf:!0,defaultPosition:wt._getDefaultPosition(a,n?.detail,t),event:n,content:Dt.Z,onClickOutside:()=>this.services.uiDialogService.dismiss({id:"context-menu"}),contentProps:{items:c,selectorProps:i,menus:r,event:n,subMenu:o,eventData:n?.detail,onClose:()=>{this.services.uiDialogService.dismiss({id:"context-menu"})},onShowSubMenu:(n,o,s)=>{o.subMenu?this.showContextMenu({...e,menuId:o.subMenu},t,a):console.warn("No submenu defined for",n,o,s)},onDefault:(e,t,a)=>{this.commandsManager.run(e,{...i,...t,subProps:a})}}})}}ht=wt,wt.getDefaultPosition=()=>({x:0,y:0}),wt._getEventDefaultPosition=e=>({x:e&&e.currentPoints.client[0],y:e&&e.currentPoints.client[1]}),wt._getElementDefaultPosition=e=>{if(e){const t=e.getBoundingClientRect();return{x:t.x,y:t.y}}return{x:void 0,y:void 0}},wt._getCanvasPointsPosition=(e=[],t)=>{const a=ht._getElementDefaultPosition(t);for(let t=0;t<e.length;t++){const n={x:e[t][0]||e[t].x,y:e[t][1]||e[t].y};if(ht._isValidPosition(n)&&ht._isValidPosition(a))return{x:n.x+a.x,y:n.y+a.y}}},wt._isValidPosition=e=>e&&"number"==typeof e.x&&"number"==typeof e.y,wt._getDefaultPosition=(e,t,a)=>{const n=function*(){yield ht._getCanvasPointsPosition(e,a),yield ht._getEventDefaultPosition(t),yield ht._getElementDefaultPosition(a),yield ht.getDefaultPosition()}();let o=n.next(),s=o.value;for(;!o.done;)s=o.value,ht._isValidPosition(s)&&n.return(),o=n.next();return s};const vt={id:"measurementsContextMenu",customizationType:"ohif.contextMenu",menus:[{id:"forExistingMeasurement",selector:({nearbyToolData:e})=>!!e,items:[{label:"Delete curve",commands:[{commandName:"deleteMeasurement"}]},{label:"Add comment",commands:[{commandName:"setMeasurementLabel"}]},{label:"Validate curve",commands:[{commandName:"closeContextMenu"}]}]}]};var bt=a(53806),Et=a.n(bt),xt=a(21767);const Ut={padding:"10px 0"},Mt={borderBottomWidth:"1px",...Ut};function Ct({tagRef:e,vrRef:t,keywordRef:a,valueRef:n}){return Y.createElement("div",{className:re()("flex flex-row w-full bg-secondary-dark ohif-scrollbar overflow-y-scroll"),style:Ut},Y.createElement("div",{className:"px-3 w-4/24"},Y.createElement("label",{ref:e,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},Y.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Tag"))),Y.createElement("div",{className:"px-3 w-2/24"},Y.createElement("label",{ref:t,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},Y.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"VR"))),Y.createElement("div",{className:"px-3 w-6/24"},Y.createElement("label",{ref:a,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},Y.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Keyword"))),Y.createElement("div",{className:"px-3 w-5/24 grow"},Y.createElement("label",{ref:n,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},Y.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Value"))))}const Pt=function({rows:e}){const t=(0,Y.useRef)(),a=(0,Y.useRef)(),[n,o]=(0,Y.useState)(null),[s,r]=(0,Y.useState)(null),[i,c]=(0,Y.useState)(null),[l,d]=(0,Y.useState)(null);(0,Y.useEffect)((()=>{t?.current&&(t.current.scrollTo(0),t.current.resetAfterIndex(0))}),[e]),(0,Y.useEffect)((()=>{const e=Ce()((()=>t.current.resetAfterIndex(0)),100);return window.addEventListener("resize",e),()=>{e.cancel(),window.removeEventListener("resize",e)}}),[]);const u=(0,Y.useCallback)((({index:t,style:a})=>{const n=e[t];return Y.createElement("div",{style:{...a,...Mt},className:re()("hover:bg-secondary-main transition duration-300 bg-black flex flex-row w-full border-secondary-light items-center text-base break-all","leading-[20px]"),key:`DICOMTagRow-${t}`},Y.createElement("div",{className:"px-3 w-4/24"},n[0]),Y.createElement("div",{className:"px-3 w-2/24"},n[1]),Y.createElement("div",{className:"px-3 w-6/24"},n[2]),Y.createElement("div",{className:"px-3 w-5/24 grow"},n[3]))}),[e]),m=(0,Y.useCallback)((()=>null!==n),[n]),p=(0,Y.useCallback)((t=>{const o=[n.offsetWidth,s.offsetWidth,i.offsetWidth,l.offsetWidth],r=a.current.getContext("2d");return r.font=getComputedStyle(a.current).font,e[t].map(((e,t)=>{const a=r.measureText(e).width;return 20*Math.ceil(a/o[t])+20+1})).reduce(((e,t)=>Math.max(e,t)))}),[e,i,n,l,s]);return Y.createElement("div",null,Y.createElement("canvas",{style:{visibility:"hidden",position:"absolute"},className:"text-base",ref:a}),Y.createElement(Ct,{tagRef:e=>{e&&o(e)},vrRef:e=>{e&&r(e)},keywordRef:e=>{e&&c(e)},valueRef:e=>{e&&d(e)}}),Y.createElement("div",{className:"m-auto relative border-2 border-black bg-black",style:{height:"32rem"}},m()&&Y.createElement(xt.S_,{ref:t,height:500,itemCount:e.length,itemSize:p,width:"100%",className:"ohif-scrollbar"},u)))},{ImageSet:Rt}=r.classes,{DicomMetaDictionary:Nt}=I.default.data,{nameMap:Ot}=Nt;function Tt(e,t){const a=[];return e.forEach((e=>{if("SQ"===e.vr){a.push([`${e.tagIndent}${e.tag}`,e.vr,e.keyword,""]);const{values:n}=e;n.forEach(((e,n)=>{const o=Tt(e,t);a.push([`${e[0].tagIndent}(FFFE,E000)`,"",`Item #${n}`,""]),a.push(...o)}))}else{if("xs"===e.vr)try{const a=I.default.data.Tag.fromPString(e.tag).toCleanString(),n=t[a];e.vr=n.vr}catch(t){console.error(`Failed to parse value representation for tag '${e.keyword}'`)}a.push([`${e.tagIndent}${e.tag}`,e.vr,e.keyword,e.value])}})),a}function At(e,t=0){const a=Object.keys(e);let n="";for(let e=0;e<t;e++)n+=">";t>0&&(n+=" ");const o=[];for(let r=0;r<a.length;r++){let i=a[r];if("_vrMap"===i)continue;const c=Ot[i];let l=e[i];if(c&&"SQ"===c.vr){const e=(s=l,Array.isArray(s)?s:[s]),a={tag:c.tag,tagIndent:n,vr:c.vr,keyword:i,values:[]};if(o.push(a),null===l)continue;e.forEach((e=>{const n=At(e,t+1);n.length&&(Vt(n),a.values.push(n))}))}else if(Array.isArray(l)&&l.length>0&&"object"!=typeof l[0]&&(l=l.join("\\")),"number"==typeof l&&(l=l.toString()),"string"!=typeof l&&(null===l?l=" ":"object"==typeof l?l.InlineBinary?l="Inline Binary":l.BulkDataURI?l="Bulk Data URI":l.Alphabetic?l=l.Alphabetic:(console.warn(`Unrecognised Value: ${l} for ${i}:`),console.warn(l),l=" "):(console.warn(`Unrecognised Value: ${l} for ${i}:`),l=" ")),i=i.replace("RETIRED_",""),c)o.push({tag:c.tag,tagIndent:n,vr:c.vr,keyword:i,value:l});else{const e=/[0-9A-Fa-f]{6}/g;if(i.match(e)){const e=`(${i.substring(0,4)},${i.substring(4,8)})`;o.push({tag:e,tagIndent:n,vr:"",keyword:"Private Tag",value:l})}}}var s;return o}function Vt(e){e.sort(((e,t)=>e.tag<t.tag?-1:1))}const Lt=({displaySets:e,displaySetInstanceUID:t})=>{const a=new Set([1]),[n,o]=(0,Y.useState)(t),[s,r]=(0,Y.useState)(1),[i,c]=(0,Y.useState)(""),l=(0,Y.useRef)(null),d=e.find((e=>e.displaySetInstanceUID===n)),u=d instanceof Rt;const m=u&&d.images.length>1,p=(0,Y.useMemo)((()=>(e.sort(((e,t)=>e.SeriesNumber-t.SeriesNumber)),e.map((e=>{const{displaySetInstanceUID:t,SeriesDate:a,SeriesTime:n,SeriesNumber:o,SeriesDescription:s,Modality:r}=e,i=`${a}:${n}`.split(".")[0];return{value:t,label:`${o} (${r}): ${s}`,description:Et()(i,"YYYYMMDD:HHmmss").format("ddd, MMM Do YYYY")}})))),[e]),g=(0,Y.useMemo)((()=>{let e;e=u?d.images[s-1]:d.instance||d;const t=function(e){const t=At(e);return Vt(t),t}(e);return Tt(t,e)}),[s,n]),I=(0,Y.useMemo)((()=>{if(!i)return g;const e=i.toLowerCase();return g.filter((t=>t.reduce(((t,n,o)=>t||(a.has(o)?t:t||n.toLowerCase().includes(e))),!1)))}),[g,i]),f=(0,Y.useMemo)((()=>Ce()(c,200)),[]);return(0,Y.useEffect)((()=>()=>{f?.cancel()}),[]),Y.createElement("div",{className:"dicom-tag-browser-content"},Y.createElement("div",{className:"flex flex-row mb-6 items-center pl-1"},Y.createElement("div",{className:"flex flex-row items-center w-1/2"},Y.createElement(ae.ZT,{variant:"subtitle",className:"mr-4"},"Series"),Y.createElement("div",{className:"grow mr-8"},Y.createElement(ae.Ph,{id:"display-set-selector",isClearable:!1,onChange:e=>{o(e.value),r(1)},options:p,value:p.find((e=>e.value===n)),className:"text-white"}))),Y.createElement("div",{className:"flex flex-row items-center w-1/2"},m&&Y.createElement(ae.ZT,{variant:"subtitle",className:"mr-4"},"Instance Number"),m&&Y.createElement("div",{className:"grow"},Y.createElement(ae.OX,{value:s,key:n,onChange:e=>{r(parseInt(e))},minValue:1,maxValue:d.images.length,step:1,inputClassName:"w-full",labelPosition:"left",trackColor:"#3a3f99"})))),Y.createElement("div",{className:"w-full h-1 bg-black"}),Y.createElement("div",{className:"flex flex-row my-3 w-1/2"},Y.createElement("label",{className:"relative block w-full mr-8"},Y.createElement("span",{className:"absolute inset-y-0 left-0 flex items-center pl-2"},Y.createElement(ae.JO,{name:"icon-search"})),Y.createElement("input",{ref:l,type:"text",className:"block bg-black w-full shadow transition duration-300 appearance-none border border-inputfield-main focus:border-inputfield-focus focus:outline-none disabled:border-inputfield-disabled rounded w-full py-2 px-9 text-base leading-tight placeholder:text-inputfield-placeholder",placeholder:"Search metadata...",onChange:e=>f(e.target.value),autoComplete:"off"}),Y.createElement("span",{className:"absolute inset-y-0 right-0 flex items-center pr-2"},Y.createElement(ae.JO,{name:"icon-clear-field",className:re()("cursor-pointer",i?"":"hidden"),onClick:()=>{l.current.value="",f("")}})))),Y.createElement(Pt,{rows:I}))},kt=(e,t,a)=>{console.log("HP - REUSE CACHED LAYOUT",e,t,a);const{activeViewportIndex:n,viewports:o,layout:s}=e,r=t.getState(),{protocolId:i,stageIndex:c,activeStudyUID:l}=r,{protocol:d}=t.getActiveProtocol(),u=d.stages[c],m=`${l}:${i}:${c}`,p=a.getState(),g=`${l}:${i}`,I={...p.viewportGridStore},f={...p.hangingProtocolStageIndexMap},y={...p.displaySetSelectorMap},{rows:S,columns:h}=u.viewportStructure.properties,D=u.viewports.length!==e.viewports.length||e.layout.numRows!==S||e.layout.numCols!==h;f[g]=r,m&&D&&(I[m]={...e});for(let t=0;t<e.viewports.length;t++){const a=e.viewports[t],{displaySetOptions:o,displaySetInstanceUIDs:s}=a;if(o)for(let e=0;e<o.length;e++){const a=s[e];a&&(t===n&&0===e&&(y[`${l}:activeDisplaySet:0`]=a),o[e]?.id&&(y[`${l}:${o[e].id}:${o[e].matchedDisplaySetsIndex||0}`]=a))}}return{hangingProtocolStageIndexMap:f,viewportGridStore:I,displaySetSelectorMap:y}},Ft=(e,t,a,n,o)=>{const s=t?.[n];if(s)return{...s};const{protocolId:r,stageIndex:i}=e.getState();o.inDisplay||(o.inDisplay=[...t.initialInDisplay]);const c=e.getMissingViewport(r,i,o);if(c){const e=c.displaySetsInfo.map((e=>e.displaySetInstanceUID));return o.inDisplay.push(...e),{displaySetInstanceUIDs:e,displaySetOptions:c.displaySetsInfo.map((e=>e.displaySetOptions)),viewportOptions:{...c.viewportOptions}}}return{}},$t=(e,{numRows:t,numCols:a},n)=>{const{viewports:o}=e,s={...n.getState().viewportsByPosition},r=[];for(const e of o)if(e.positionId){const t={...e,viewportOptions:{...e.viewportOptions}};s[e.positionId]=t,delete t.viewportId,delete t.viewportOptions.viewportId}for(let e=0;e<t;e++)for(let t=0;t<a;t++){const n=t+e*a,i=s[o?.[n]?.positionId||`${t}-${e}`];i?.displaySetInstanceUIDs&&r.push(...i.displaySetInstanceUIDs)}return s.initialInDisplay=r,{viewportsByPosition:s}};var Bt=a(53469);const{subscribeToNextViewportGridChange:qt}=r.utils,Ht=e=>e&&("setHangingProtocol"===e.commandName||"toggleHangingProtocol"===e.commandName),Gt=({servicesManager:e,commandsManager:t})=>{const{customizationService:a,measurementService:n,hangingProtocolService:o,uiNotificationService:s,viewportGridService:r,displaySetService:i,stateSyncService:c,toolbarService:l}=e.services,d=new wt(e,t),u={showContextMenu:e=>{const{menuCustomizationId:t,element:n,event:s,selectorProps:r,defaultPointsPosition:i=[]}=e,c={...e};t&&Object.assign(c,a.get(t,vt));const{protocol:l,stage:u}=o.getActiveProtocol();c.selectorProps={event:s,protocol:l,stage:u,...r},d.showContextMenu(c,n,i)},closeContextMenu:()=>{d.closeContextMenu()},displayNotification:({text:e,title:t,type:a})=>{s.show({title:t,message:e,type:a})},clearMeasurements:()=>{n.clear()},toggleHpTools:()=>{const{protocol:e,stageIndex:t,stage:a}=o.getActiveProtocol(),n=o=>{if(!o.id)return;const{commands:s,items:r}=o.props||o;r&&r.forEach(n);const i=s?.find?.(Ht);if(!i)return;const{protocolId:c,stageIndex:d,stageId:u}=i.commandOptions,m=!(c&&c!==e.id||void 0!==d&&d!==t||u&&u!==a.id);l.setActive(o.id,m)};Object.values(l.getButtons()).forEach(n)},setHangingProtocol:({activeStudyUID:e="",protocolId:a,stageId:n,stageIndex:i,reset:l=!1})=>{try{const s=r.getState(),d=o.getState(),{protocol:m}=o.getActiveProtocol(),p=kt(s,o,c);console.log("HP - STATE SYNC REDUCE",p);const{hangingProtocolStageIndexMap:g,viewportGridStore:I,displaySetSelectorMap:f}=p;if(a){if(void 0===i&&void 0===n){const t=`${e||d.activeStudyUID}:${a}`;i=g[t]?.stageIndex}}else a=d.protocolId,void 0===n&&void 0===i&&(i=d.stageIndex);const y=i??o.getStageIndex(a,{stageId:n,stageIndex:i});e&&o.setActiveStudyUID(e);const S=`${o.getState().activeStudyUID}:${a}:${y||0}`,h=!l&&I[S];if(a!==d.protocolId||y!==d.stageIndex||e?(o.setProtocol(a,{displaySetSelectorMap:f,stageId:n,stageIndex:y,restoreProtocol:h}),h&&r.set(I[S])):o.setProtocol(a,{stageId:n,stageIndex:y}),delete f[`${e||d.activeStudyUID}:activeDisplaySet:0`],c.store(p),u.toggleHpTools(o.getActiveProtocol()),a!==d.protocolId){const{protocol:e}=o.getActiveProtocol();t.run(m.callbacks?.onProtocolExit),t.run(e.callbacks?.onProtocolEnter)}return!0}catch(e){return u.toggleHpTools(o.getActiveProtocol()),s.show({title:"Apply Hanging Protocol",message:"The hanging protocol could not be applied.",type:"error",duration:3e3}),!1}},toggleHangingProtocol:({protocolId:e,stageIndex:t})=>{const{protocol:a,stageIndex:n,activeStudy:s}=o.getActiveProtocol(),{toggleHangingProtocol:r}=c.getState(),i=`${s.StudyInstanceUID}:${e}:${0|t}`;if(a.id!==e||void 0!==t&&t!==n)return c.store({toggleHangingProtocol:{...r,[i]:{protocolId:a.id,stageIndex:n}}}),u.setHangingProtocol({protocolId:e,stageIndex:t,reset:!0});{const e=r[i]||{protocolId:"default"};return u.setHangingProtocol(e)}},deltaStage:({direction:e})=>{const{protocolId:t,stageIndex:a}=o.getState(),{protocol:n}=o.getActiveProtocol();for(let o=a+e;o>=0&&o<n.stages.length;o+=e)if("disabled"!==n.stages[o].status)return u.setHangingProtocol({protocolId:t,stageIndex:o});s.show({title:"Change Stage",message:"The hanging protocol has no more applicable stages",type:"info",duration:3e3})},setViewportGridLayout:({numRows:e,numCols:a})=>{const{protocol:n}=o.getActiveProtocol(),s=n.callbacks?.onLayoutChange;if(!1===t.run(s,{numRows:e,numCols:a}))return void console.log("setViewportGridLayout running",s,e,a);window.setTimeout((()=>{const t=r.getState(),n=$t(t,{numRows:e,numCols:a},c),s=Ft.bind(null,o,n.viewportsByPosition);r.setLayout({numRows:e,numCols:a,findOrCreateViewport:s}),c.store(n)}),0)},toggleOneUpCustom(){const e=r.getState(),{activeViewportIndex:t,viewports:a,layout:n}=e,{displaySetInstanceUIDs:s,displaySetOptions:i,viewportOptions:l}=a[t];if(console.log("DoubleClick - TOGGLE ONE UP",l),1===n.numCols&&1===n.numRows){const{toggleOneUpViewportGridStore:e}=c.getState();if(!e.layout)return;const t=e.activeViewportIndex,a=s.length>1?[]:s.map((e=>o.getViewportsRequireUpdate(t,e))).flat(),n=t=>{const n=a.find((e=>e.viewportIndex===t));return n?{viewportOptions:l,displaySetOptions:i,...n}:e.viewports[t]},d=r.getLayoutOptionsFromState(e);r.setLayout({numRows:e.layout.numRows,numCols:e.layout.numCols,activeViewportIndex:t,layoutOptions:d,findOrCreateViewport:n})}else{c.store({toggleOneUpViewportGridStore:e});const t=()=>({displaySetInstanceUIDs:s,displaySetOptions:i,viewportOptions:l});r.setLayout({numRows:1,numCols:1,findOrCreateViewport:t})}},toggleOneUp(){const e=r.getState(),{activeViewportIndex:t,viewports:a,layout:n}=e,{displaySetInstanceUIDs:s,displaySetOptions:i,viewportOptions:l}=a[t];if(1===n.numCols&&1===n.numRows){const{toggleOneUpViewportGridStore:e}=c.getState();if(!e.layout)return;const t=e.activeViewportIndex,a=s.length>1?[]:s.map((e=>o.getViewportsRequireUpdate(t,e))).flat(),n=t=>{const n=a.find((e=>e.viewportIndex===t));return n?{viewportOptions:l,displaySetOptions:i,...n}:e.viewports[t]},d=r.getLayoutOptionsFromState(e);r.setLayout({numRows:e.layout.numRows,numCols:e.layout.numCols,activeViewportIndex:t,layoutOptions:d,findOrCreateViewport:n})}else{c.store({toggleOneUpViewportGridStore:e});const t=()=>({displaySetInstanceUIDs:s,displaySetOptions:i,viewportOptions:l});r.setLayout({numRows:1,numCols:1,findOrCreateViewport:t});qt(r,(()=>{c.store({toggleOneUpViewportGridStore:{}})}))}},navigateHistory(e){Bt.m.navigate(e.to,e.options)},openDICOMTagViewer(){const{activeViewportIndex:t,viewports:a}=r.getState(),n=a[t],{displaySetInstanceUIDs:o}=n,s=i.activeDisplaySets,{UIModalService:c}=e.services,l=o[0];c.show({content:Lt,contentProps:{displaySets:s,displaySetInstanceUID:l,onClose:c.hide},title:"DICOM Tag Browser"})},toggleOverlays:()=>{const e=document.getElementsByClassName("viewport-overlay");for(let t=0;t<e.length;t++)e.item(t).classList.toggle("hidden")},scrollActiveThumbnailIntoView:()=>{const{activeViewportIndex:e,viewports:t}=r.getState();if(!t||e<0||e>t.length-1)return;const a=t[e].displaySetInstanceUIDs[0],n=document.querySelector("#ohif-thumbnail-list");if(!n)return;const o=n.getBoundingClientRect(),s=document.querySelector(`#thumbnail-${a}`);if(!s)return;const i=s.getBoundingClientRect();i.top>=o.top&&i.top<=o.bottom||s.scrollIntoView({behavior:"smooth"})},updateViewportDisplaySet:({direction:e,excludeNonImageModalities:t})=>{const a=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"],n=o.getDisplaySetSortFunction(),c=[...i.activeDisplaySets];c.sort(n);const{activeViewportIndex:l,viewports:d}=r.getState(),{displaySetInstanceUIDs:m}=d[l];let p;for(p=c.findIndex((e=>m.includes(e.displaySetInstanceUID)))+e;p>-1&&p<c.length&&(t&&a.includes(c[p].Modality));p+=e);if(p<0||p>=c.length)return;const{displaySetInstanceUID:g}=c[p];let I=[];try{I=o.getViewportsRequireUpdate(l,g)}catch(e){console.warn(e),s.show({title:"Navigate Viewport Display Set",message:"The requested display sets could not be added to the viewport due to a mismatch in the Hanging Protocol rules.",type:"info",duration:3e3})}r.setDisplaySetsForViewports(I),setTimeout((()=>u.scrollActiveThumbnailIntoView()),0)}},m={showContextMenu:{commandFn:u.showContextMenu},closeContextMenu:{commandFn:u.closeContextMenu},clearMeasurements:{commandFn:u.clearMeasurements,storeContexts:[],options:{}},displayNotification:{commandFn:u.displayNotification,storeContexts:[],options:{}},setHangingProtocol:{commandFn:u.setHangingProtocol,storeContexts:[],options:{}},toggleHangingProtocol:{commandFn:u.toggleHangingProtocol,storeContexts:[],options:{}},navigateHistory:{commandFn:u.navigateHistory,storeContexts:[],options:{}},nextStage:{commandFn:u.deltaStage,storeContexts:[],options:{direction:1}},previousStage:{commandFn:u.deltaStage,storeContexts:[],options:{direction:-1}},setViewportGridLayout:{commandFn:u.setViewportGridLayout,storeContexts:[],options:{}},toggleOneUp:{commandFn:u.toggleOneUp,storeContexts:[],options:{}},toggleOneUpCustom:{commandFn:u.toggleOneUpCustom,storeContexts:[],options:{}},openDICOMTagViewer:{commandFn:u.openDICOMTagViewer},updateViewportDisplaySet:{commandFn:u.updateViewportDisplaySet,storeContexts:[],options:{}}};return{actions:u,definitions:m,defaultContext:"DEFAULT"}},Zt={hasUpdatedPriorsInformation:!1,id:"@ohif/mnGrid",description:"Has various hanging protocol grid layouts",name:"2x2",protocolMatchingRules:[{id:"OneOrMoreSeries",weight:25,attribute:"numberOfDisplaySetsWithImages",constraint:{greaterThan:0}}],toolGroupIds:["default"],displaySetSelectors:{defaultDisplaySetId:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:10,constraint:{equals:!0}}]}},defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},stages:[{id:"2x2",stageActivation:{enabled:{minViewportsMatched:4}},viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:2,id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:3,id:"defaultDisplaySetId"}]}]},{id:"3x1",requiredViewports:1,preferredViewports:3,stageActivation:{enabled:{minViewportsMatched:3}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:3}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:1}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:2}]}]},{id:"2x1",requiredViewports:1,preferredViewports:2,stageActivation:{enabled:{minViewportsMatched:2}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:2}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]}]},{id:"1x1",requiredViewports:1,preferredViewports:1,stageActivation:{enabled:{minViewportsMatched:1}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]}]}],numberOfPriorsReferenced:-1},jt={id:"default",locked:!0,hasUpdatedPriorsInformation:!1,name:"Default",createdDate:"2021-02-23T19:22:08.894Z",modifiedDate:"2023-04-01",availableTo:{},editableBy:{},protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{defaultDisplaySetId:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isSeriesUIDFromURL",weight:10,constraint:{equals:!0}}]}},stages:[{name:"default",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{viewportType:"stack",toolGroupId:"default",initialImageOptions:{custom:"sopInstanceLocation"}},displaySets:[{id:"defaultDisplaySetId"}]}],createdDate:"2021-02-23T18:32:42.850Z"}]};const zt=function(){return[{name:jt.id,protocol:jt},{name:Zt.id,protocol:Zt}]};const _t=function(){const[e]=(0,oe.M)(),t=(0,Q.s0)(),a=e.dataSources;return Y.createElement("div",{style:{width:"100%",height:"100%"}},Y.createElement("div",{className:"h-screen w-screen flex justify-center items-center "},Y.createElement("div",{className:"py-8 px-8 mx-auto bg-secondary-dark drop-shadow-md space-y-2 rounded-lg"},Y.createElement("img",{className:"block mx-auto h-14",src:"./ohif-logo.svg",alt:"OHIF"}),Y.createElement("div",{className:"text-center space-y-2 pt-4"},a.filter((e=>"dicomjson"!==e.sourceName&&"dicomlocal"!==e.sourceName)).map((e=>Y.createElement("div",{key:e.sourceName},Y.createElement("h1",{className:"text-white"},e.friendlyName),Y.createElement(ae.zx,{className:re()("font-bold","ml-2"),onClick:()=>{t({pathname:"/",search:`datasources=${e.sourceName}`})}},e.sourceName),Y.createElement("br",null))))))))};var Wt=a(71251);const Xt=r.default.classes.MetadataProvider;var Yt=a(74569);const{registerColormap:Jt}=Be.utilities.colormap,Kt=r.classes.MetadataProvider;const Qt=({SeriesInstanceUID:e,StudyInstanceUID:t})=>{const{instances:a}=r.DicomMetadataStore.getSeries(t,e);if("PT"!==a[0].Modality)return;const n=a.map((e=>e.imageId)),o=[];if(n.forEach((e=>{const t=function(e){const t=Xt.get("instance",e);if(!t)throw new Error("dicom metadata are required");if(void 0===t.SeriesDate||void 0===t.SeriesTime||void 0===t.PatientWeight||void 0===t.CorrectedImage||void 0===t.Units||!t.RadiopharmaceuticalInformationSequence||void 0===t.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife||void 0===t.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose||void 0===t.DecayCorrection||void 0===t.AcquisitionDate||void 0===t.AcquisitionTime||void 0===t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime&&void 0===t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime)throw new Error("required metadata are missing");const a={CorrectedImage:t.CorrectedImage,Units:t.Units,RadionuclideHalfLife:t.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife,RadionuclideTotalDose:t.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose,RadiopharmaceuticalStartDateTime:t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime,RadiopharmaceuticalStartTime:t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime,DecayCorrection:t.DecayCorrection,PatientWeight:t.PatientWeight,SeriesDate:t.SeriesDate,SeriesTime:t.SeriesTime,AcquisitionDate:t.AcquisitionDate,AcquisitionTime:t.AcquisitionTime};if(t[70531e3]||void 0!==t[70531e3]||t[70531009]||void 0!==t[70531009]){const e={SUVScaleFactor:t[70531e3],ActivityConcentrationScaleFactor:t[70531009]};a.PhilipsPETPrivateGroup=e}return t["0009100d"]&&void 0!==t["0009100d"]&&(a.GEPrivatePostInjectionDateTime=t["0009100d"]),t.FrameReferenceTime&&void 0!==t.FrameReferenceTime&&(a.FrameReferenceTime=t.FrameReferenceTime),t.ActualFrameDuration&&void 0!==t.ActualFrameDuration&&(a.ActualFrameDuration=t.ActualFrameDuration),t.PatientSex&&void 0!==t.PatientSex&&(a.PatientSex=t.PatientSex),t.PatientSize&&void 0!==t.PatientSize&&(a.PatientSize=t.PatientSize),a}(e);t&&o.push(t)})),!o.length)return;let s;try{s=(0,Wt.d)(o)}catch(e){console.log(e)}s&&(o.forEach(((e,t)=>{Kt.addCustomMetadata(n[t],"scalingModule",s[t])})),Yt.Z.forEach(Jt))},ea={id:rt,preRegistration:function({servicesManager:e,configuration:t={}}){const{stateSyncService:a}=e.services;r.DicomMetadataStore.subscribe(r.DicomMetadataStore.EVENTS.INSTANCES_ADDED,Qt),r.DicomMetadataStore.subscribe(r.DicomMetadataStore.EVENTS.SERIES_UPDATED,Qt),a.register("viewportGridStore",{clearOnModeExit:!0}),a.register("displaySetSelectorMap",{clearOnModeExit:!0}),a.register("hangingProtocolStageIndexMap",{clearOnModeExit:!0}),a.register("toggleHangingProtocol",{clearOnModeExit:!0}),a.register("viewportsByPosition",{clearOnModeExit:!0})},getDataSourcesModule:X,getLayoutTemplateModule:function({servicesManager:e,extensionManager:t,commandsManager:a,hotkeysManager:n}){return[{name:"viewerLayout",id:"viewerLayout",component:function(o){return pe({servicesManager:e,extensionManager:t,commandsManager:a,hotkeysManager:n,...o})}}]},getPanelModule:tt,getHangingProtocolModule:zt,getSopClassHandlerModule:pt,getToolbarModule:function({commandsManager:e,servicesManager:t}){return[{name:"ohif.divider",defaultComponent:gt,clickHandler:()=>{}},{name:"ohif.action",defaultComponent:ae.hA,clickHandler:()=>{}},{name:"ohif.radioGroup",defaultComponent:ae.hA,clickHandler:()=>{}},{name:"ohif.splitButton",defaultComponent:yt,clickHandler:()=>{}},{name:"ohif.layoutSelector",defaultComponent:ft,clickHandler:(e,t,a)=>{}},{name:"ohif.toggle",defaultComponent:ae.hA,clickHandler:()=>{}}]},getCommandsModule:Gt,getUtilityModule:({servicesManager:e})=>[{name:"common",exports:{getStudiesForPatientByMRN:we}}],getCustomizationModule:function(){return[{name:"helloPage",value:{id:"customRoutes",routes:[{path:"/custom",children:()=>Y.createElement("h1",{style:{color:"white"}},"Hello Custom Route")}]}},{name:"datasources",value:{id:"customRoutes",routes:[{path:"/datasources",children:_t}]}},{name:"default",value:[{id:"ohif.overlayItem",content:function(e){if(this.condition&&!this.condition(e))return null;const{instance:t}=e,a=t&&this.attribute?t[this.attribute]:this.contentF&&"function"==typeof this.contentF?this.contentF(e):null;return a?Y.createElement("span",{className:"overlay-item flex flex-row",style:{color:this.color||void 0},title:this.title||""},this.label&&Y.createElement("span",{className:"mr-1 shrink-0"},this.label),Y.createElement("span",{className:"font-light"},a)):null}},{id:"ohif.contextMenu",transform:function(e){const t={...this};t.menus=this.menus.map((e=>({...e})));for(const a of t.menus){const{items:t}=a;a.items=[];for(const n of t)a.items.push(e.transform(n))}return t}}]}]}}}}]);
//# sourceMappingURL=91.bundle.3cd261b0e3df7f87025d.js.map