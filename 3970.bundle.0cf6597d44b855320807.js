/*! For license information please see 3970.bundle.0cf6597d44b855320807.js.LICENSE.txt */
"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[3970],{33970:(e,n,t)=>{t.d(n,{fX:()=>u,X6:()=>ba,f_:()=>Ma,ql:()=>xa,QX:()=>Ca,_$:()=>s});var a={};t.r(a),t.d(a,{fillSegmentation:()=>Cn,generateSegmentation:()=>Rn,generateToolState:()=>On});var r={};t.r(r),t.d(r,{generateLabelMaps2DFrom3D:()=>na,generateSegmentation:()=>ea,generateToolState:()=>ta});var i={};t.r(i),t.d(i,{generateToolState:()=>ra});var o={};t.r(o),t.d(o,{generateContourSetsFromLabelmap:()=>ha,generateRTSSFromAnnotations:()=>ma,generateRTSSFromSegmentations:()=>ga});var u={};t.r(u),t.d(u,{s:()=>He});var s={};function c(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,a=Array(n);t<n;t++)a[t]=e[t];return a}function l(e,n,t,a,r,i,o){try{var u=e[i](o),s=u.value}catch(e){return void t(e)}u.done?n(s):Promise.resolve(s).then(a,r)}function d(e){return function(){var n=this,t=arguments;return new Promise(function(a,r){var i=e.apply(n,t);function o(e){l(i,a,r,o,u,"next",e)}function u(e){l(i,a,r,o,u,"throw",e)}o(void 0)})}}function f(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function g(e,n){for(var t=0;t<n.length;t++){var a=n[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,R(a.key),a)}}function m(e,n,t){return n&&g(e.prototype,n),t&&g(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function p(e,n){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=O(e))||n&&e&&"number"==typeof e.length){t&&(e=t);var a=0,r=function(){};return{s:r,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,u=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return o=e.done,e},e:function(e){u=!0,i=e},f:function(){try{o||null==t.return||t.return()}finally{if(u)throw i}}}}function h(e,n,t){return(n=R(n))in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function v(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,a)}return t}function S(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?v(Object(t),!0).forEach(function(n){h(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):v(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}function I(){var e,n,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",r=t.toStringTag||"@@toStringTag";function i(t,a,r,i){var s=a&&a.prototype instanceof u?a:u,c=Object.create(s.prototype);return y(c,"_invoke",function(t,a,r){var i,u,s,c=0,l=r||[],d=!1,f={p:0,n:0,v:e,a:g,f:g.bind(e,4),d:function(n,t){return i=n,u=0,s=e,f.n=t,o}};function g(t,a){for(u=t,s=a,n=0;!d&&c&&!r&&n<l.length;n++){var r,i=l[n],g=f.p,m=i[2];t>3?(r=m===a)&&(s=i[(u=i[4])?5:(u=3,3)],i[4]=i[5]=e):i[0]<=g&&((r=t<2&&g<i[1])?(u=0,f.v=a,f.n=i[1]):g<m&&(r=t<3||i[0]>a||a>m)&&(i[4]=t,i[5]=a,f.n=m,u=0))}if(r||t>1)return o;throw d=!0,a}return function(r,l,m){if(c>1)throw TypeError("Generator is already running");for(d&&1===l&&g(l,m),u=l,s=m;(n=u<2?e:s)||!d;){i||(u?u<3?(u>1&&(f.n=-1),g(u,s)):f.n=s:f.v=s);try{if(c=2,i){if(u||(r="next"),n=i[r]){if(!(n=n.call(i,s)))throw TypeError("iterator result is not an object");if(!n.done)return n;s=n.value,u<2&&(u=0)}else 1===u&&(n=i.return)&&n.call(i),u<2&&(s=TypeError("The iterator does not provide a '"+r+"' method"),u=1);i=e}else if((n=(d=f.n<0)?s:t.call(a,f))!==o)break}catch(n){i=e,u=1,s=n}finally{c=1}}return{value:n,done:d}}}(t,r,i),!0),c}var o={};function u(){}function s(){}function c(){}n=Object.getPrototypeOf;var l=[][a]?n(n([][a]())):(y(n={},a,function(){return this}),n),d=c.prototype=u.prototype=Object.create(l);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,y(e,r,"GeneratorFunction")),e.prototype=Object.create(d),e}return s.prototype=c,y(d,"constructor",c),y(c,"constructor",s),s.displayName="GeneratorFunction",y(c,r,"GeneratorFunction"),y(d),y(d,r,"Generator"),y(d,a,function(){return this}),y(d,"toString",function(){return"[object Generator]"}),(I=function(){return{w:i,m:f}})()}function y(e,n,t,a){var r=Object.defineProperty;try{r({},"",{})}catch(e){r=0}y=function(e,n,t,a){function i(n,t){y(e,n,function(e){return this._invoke(n,t,e)})}n?r?r(e,n,{value:t,enumerable:!a,configurable:!a,writable:!a}):e[n]=t:(i("next",0),i("throw",1),i("return",2))},y(e,n,t,a)}function T(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var a,r,i,o,u=[],s=!0,c=!1;try{if(i=(t=t.call(e)).next,0===n){if(Object(t)!==t)return;s=!1}else for(;!(s=(a=i.call(t)).done)&&(u.push(a.value),u.length!==n);s=!0);}catch(e){c=!0,r=e}finally{try{if(!s&&null!=t.return&&(o=t.return(),Object(o)!==o))return}finally{if(c)throw r}}return u}}(e,n)||O(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function D(e){return function(e){if(Array.isArray(e))return c(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||O(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function R(e){var n=function(e,n){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var a=t.call(e,n||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}(e,"string");return"symbol"==typeof n?n:n+""}function O(e,n){if(e){if("string"==typeof e)return c(e,n);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?c(e,n):void 0}}t.r(s),t.d(s,{vk:()=>w});var C=t(5842),x=function(e){return Array.isArray(e)?e:[e]},b=function(e){return function(n){return n.ConceptNameCodeSequence.CodeMeaning===e}},M=t(81429),P=C.p.datasetToDict;function w(e,n){var t;if(e instanceof ArrayBuffer)t=new Blob([e],{type:"application/dicom"});else{if(!e._meta)throw new Error("Dataset must have a _meta property");var a=M.hp.from(P(e).write());t=new Blob([a],{type:"application/dicom"})}var r=document.createElement("a");r.href=window.URL.createObjectURL(t),r.download=n,r.click()}var E=C.BF.TID1500,A=C.BF.addAccessors,N=C.h4.StructuredReport,q=C.z8.Normalizer,U=E.TID1500MeasurementReport,F=E.TID1501MeasurementGroup,k=C.p.DicomMetaDictionary,V={CodingSchemeDesignator:"DCM",CodeValue:"121071"},B={CodingSchemeDesignator:"SCT",CodeValue:"363698007"},G={CodingSchemeDesignator:"SRT",CodeValue:"G-C0E3"},_=function(e,n,t){var a=e.ConceptNameCodeSequence;if(a){var r=a.CodingSchemeDesignator,i=a.CodeValue;return r==n.CodingSchemeDesignator&&i==n.CodeValue||t&&r==t.CodingSchemeDesignator&&i==t.CodeValue}};function L(e,n,t){var a=n[e],r=j.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[e];if(a&&a.data&&a.data.length&&r){var i=a.data.map(function(e){return function(e,n,t,a){var r=a.getTID300RepresentationArguments(e);return r.ReferencedSOPSequence=t,new a.TID300Representation(r)}(e,0,t,r)});return new F(i)}}var j=function(){function e(){f(this,e)}return m(e,null,[{key:"getSetupMeasurementData",value:function(e){var n=e.ContentSequence,t=x(n),a=t.find(function(e){return _(e,V)}),r=t.filter(function(e){return _(e,B,G)})||[],i=t.find(function(e){return"NUM"===e.ValueType}),o=x(i.ContentSequence).find(function(e){return"SCOORD"===e.ValueType}),u=o.ContentSequence.ReferencedSOPSequence,s=u.ReferencedSOPInstanceUID,c=u.ReferencedFrameNumber,l={sopInstanceUid:s,frameIndex:c||1,complete:!0,finding:a?A(a.ConceptCodeSequence):void 0,findingSites:r.map(function(e){return A(e.ConceptCodeSequence)})};l.finding&&(l.description=l.finding.CodeMeaning);var d=l.findingSites&&l.findingSites[0];return d&&(l.location=d[0]&&d[0].CodeMeaning||d.CodeMeaning),{defaultState:l,findingGroup:a,findingSiteGroups:r,NUMGroup:i,SCOORDGroup:o,ReferencedSOPSequence:u,ReferencedSOPInstanceUID:s,ReferencedFrameNumber:c}}},{key:"generateReport",value:function(e,n,t){var a=[],r=Object.keys(e)[0];if(!r)throw new Error("No measurements provided.");var i=n.get("generalSeriesModule",r),o=i.studyInstanceUID,u=i.seriesInstanceUID;Object.keys(e).forEach(function(t){var r=n.get("sopCommonModule",t),i=n.get("frameNumber",t),o=e[t],u=Object.keys(o),s={ReferencedSOPClassUID:r.sopClassUID,ReferencedSOPInstanceUID:r.sopInstanceUID};q.isMultiframeSOPClassUID(r.sopClassUID)&&(s.ReferencedFrameNumber=i);var c=[];u.forEach(function(e){var n=L(e,o,s);n&&c.push(n)}),a=a.concat(c)});var s=new U({TID1501MeasurementGroups:a},t),c=new Uint8Array(2);c[1]=1;var l={StudyInstanceUID:o,SeriesInstanceUID:u},d={FileMetaInformationVersion:{Value:[c.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[k.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}};l._meta=d,l._vrMap={PixelData:"OW"};var f=new N([l]),g=s.contentItem(l);return f.dataset=Object.assign(f.dataset,g),f.dataset._meta=d,f.dataset.SpecificCharacterSet="ISO_IR 192",f}},{key:"generateToolState",value:function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("1500"!==n.ContentTemplateSequence.TemplateIdentifier)throw new Error("This package can currently only interpret DICOM SR TID 1500");var a=x(n.ContentSequence).find(b("Imaging Measurements")),r=x(a.ContentSequence).filter(b("Measurement Group")),i={},o=e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,u=[];return Object.keys(o).forEach(function(e){u.push(o[e]),i[e]=[]}),r.forEach(function(e){var a=x(e.ContentSequence).find(function(e){return"Tracking Identifier"===e.ConceptNameCodeSequence.CodeMeaning}).TextValue,r=t.getToolClass?t.getToolClass(e,n,u):u.find(function(e){return e.isValidCornerstoneTrackingIdentifier(a)});if(r){var o=r.getMeasurementData(e);console.log("=== ".concat(r.toolType," ===")),console.log(o),i[r.toolType].push(o)}}),i}},{key:"registerTool",value:function(n){e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE[n.utilityToolType]=n,e.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[n.toolType]=n,e.MEASUREMENT_BY_TOOLTYPE[n.toolType]=n.utilityToolType}}])}();j.MEASUREMENT_BY_TOOLTYPE={},j.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE={},j.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE={};var Y="cornerstoneTools@^4.0.0",z=C.BF.TID300.Length,H="Length",X=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n){var t=j.getSetupMeasurementData(n),a=t.defaultState,r=t.NUMGroup,i=t.SCOORDGroup,o=S(S({},a),{},{length:r.MeasuredValueSequence.NumericValue,toolType:e.toolType,handles:{start:{},end:{},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}),u=T(i.GraphicData,4);return o.handles.start.x=u[0],o.handles.start.y=u[1],o.handles.end.x=u[2],o.handles.end.y=u[3],o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=e.finding,a=e.findingSites;return{point1:n.start,point2:n.end,distance:e.length,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Length",finding:t,findingSites:a||[]}}}])}();X.toolType=H,X.utilityToolType=H,X.TID300Representation=z,X.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===Y&&a===H},j.registerTool(X);var W=C.BF.TID300.Polyline,Q=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n){for(var t=j.getSetupMeasurementData(n),a=t.defaultState,r=t.SCOORDGroup,i=t.NUMGroup,o=S(S({},a),{},{toolType:e.toolType,handles:{points:[],textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},cachedStats:{area:i?i.MeasuredValueSequence.NumericValue:0},color:void 0,invalidated:!0}),u=r.GraphicData,s=0;s<u.length;s+=2)o.handles.points.push({x:u[s],y:u[s+1]});return o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=e.finding,a=e.findingSites,r=e.cachedStats,i=void 0===r?{}:r,o=n.points,u=i.area,s=void 0===u?0:u,c=i.perimeter;return{points:o,area:s,perimeter:void 0===c?0:c,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:FreehandRoi",finding:t,findingSites:a||[]}}}])}();Q.toolType="FreehandRoi",Q.utilityToolType="FreehandRoi",Q.TID300Representation=W,Q.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===Y&&a===Q.toolType},j.registerTool(Q);var $=C.BF.TID300.Bidirectional,J="Bidirectional",K=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n){var t=n.ContentSequence,a=x(t).find(function(e){return"121071"===e.ConceptNameCodeSequence.CodeValue}),r=x(t).filter(function(e){return"G-C0E3"===e.ConceptNameCodeSequence.CodeValue}),i=x(t).find(function(e){return"Long Axis"===e.ConceptNameCodeSequence.CodeMeaning}),o=x(i.ContentSequence).find(function(e){return"SCOORD"===e.ValueType}),u=x(t).find(function(e){return"Short Axis"===e.ConceptNameCodeSequence.CodeMeaning}),s=x(u.ContentSequence).find(function(e){return"SCOORD"===e.ValueType}),c=o.ContentSequence.ReferencedSOPSequence,l=c.ReferencedSOPInstanceUID,d=c.ReferencedFrameNumber,f=String(i.MeasuredValueSequence.NumericValue),g=String(u.MeasuredValueSequence.NumericValue),m=Math.max(o.GraphicData[0],o.GraphicData[2],s.GraphicData[0],s.GraphicData[2]),p=Math.max(o.GraphicData[1],o.GraphicData[3],s.GraphicData[1],s.GraphicData[3]);return{sopInstanceUid:l,frameIndex:d||1,toolType:e.toolType,active:!1,handles:{start:{x:o.GraphicData[0],y:o.GraphicData[1],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:0},end:{x:o.GraphicData[2],y:o.GraphicData[3],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:1},perpendicularStart:{x:s.GraphicData[0],y:s.GraphicData[1],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:2},perpendicularEnd:{x:s.GraphicData[2],y:s.GraphicData[3],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:3},textBox:{highlight:!1,hasMoved:!0,active:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0,x:m+10,y:p+10}},invalidated:!1,isCreating:!1,longestDiameter:f,shortestDiameter:g,toolName:"Bidirectional",visible:!0,finding:a?a.ConceptCodeSequence:void 0,findingSites:r.map(function(e){return e.ConceptCodeSequence})}}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=n.start,a=n.end,r=n.perpendicularStart,i=n.perpendicularEnd,o=e.shortestDiameter;return{longAxis:{point1:t,point2:a},shortAxis:{point1:r,point2:i},longAxisLength:e.longestDiameter,shortAxisLength:o,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Bidirectional",finding:e.finding,findingSites:e.findingSites||[]}}}])}();K.toolType=J,K.utilityToolType=J,K.TID300Representation=$,K.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===Y&&a===J},j.registerTool(K);var Z=C.BF.TID300.Ellipse,ee="EllipticalRoi",ne=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n){var t=j.getSetupMeasurementData(n),a=t.defaultState,r=t.NUMGroup,i=t.SCOORDGroup.GraphicData,o=[{x:i[0],y:i[1]},{x:i[2],y:i[3]}],u=[{x:i[4],y:i[5]},{x:i[6],y:i[7]}],s=Math.sqrt(Math.pow(u[0].x-u[1].x,2)+Math.pow(u[0].y-u[1].y,2)),c=(u[1].x-u[0].x)/s,l=(u[1].y-u[0].y)/s,d=s/2,f={x:o[0].x+c*d,y:o[0].y+l*d},g={x:o[1].x-c*d,y:o[1].y-l*d};return S(S({},a),{},{toolType:e.toolType,active:!1,cachedStats:{area:r?r.MeasuredValueSequence.NumericValue:0},handles:{end:{x:f.x,y:f.y,highlight:!1,active:!1},initialRotation:0,start:{x:g.x,y:g.y,highlight:!1,active:!1},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,visible:!0})}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.cachedStats,t=void 0===n?{}:n,a=e.handles,r=e.finding,i=e.findingSites,o=a.start,u=a.end,s=t.area,c=Math.abs(o.x-u.x)/2,l=Math.abs(o.y-u.y)/2,d=[],f={x:(o.x+u.x)/2,y:(o.y+u.y)/2};c>l?(d.push({x:f.x-c,y:f.y}),d.push({x:f.x+c,y:f.y}),d.push({x:f.x,y:f.y-l}),d.push({x:f.x,y:f.y+l})):(d.push({x:f.x,y:f.y-l}),d.push({x:f.x,y:f.y+l}),d.push({x:f.x-c,y:f.y}),d.push({x:f.x+c,y:f.y}));return{area:s,points:d,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:EllipticalRoi",finding:r,findingSites:i||[]}}}])}();ne.toolType=ee,ne.utilityToolType=ee,ne.TID300Representation=Z,ne.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===Y&&a===ee},j.registerTool(ne);var te=C.BF.TID300.Circle,ae="CircleRoi",re=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n){var t=j.getSetupMeasurementData(n),a=t.defaultState,r=t.NUMGroup,i=t.SCOORDGroup.GraphicData,o={x:i[0],y:i[1]},u={x:i[2],y:i[3]};return S(S({},a),{},{toolType:e.toolType,active:!1,cachedStats:{area:r?r.MeasuredValueSequence.NumericValue:0,radius:0,perimeter:0},handles:{end:S(S({},u),{},{highlight:!1,active:!1}),initialRotation:0,start:S(S({},o),{},{highlight:!1,active:!1}),textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,visible:!0})}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.cachedStats,t=void 0===n?{}:n,a=e.handles,r=e.finding,i=e.findingSites,o=a.start,u=a.end,s=t.area,c=t.radius,l=2*Math.PI*c,d=[];d.push(o),d.push(u);return{area:s,perimeter:l,radius:c,points:d,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:CircleRoi",finding:r,findingSites:i||[]}}}])}();re.toolType=ae,re.utilityToolType=ae,re.TID300Representation=te,re.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===Y&&a===ae},j.registerTool(re);var ie=C.BF.TID300.Point,oe="ArrowAnnotate",ue="CORNERSTONEFREETEXT",se=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n){var t=j.getSetupMeasurementData(n),a=t.defaultState,r=t.SCOORDGroup,i=t.findingGroup.ConceptCodeSequence.CodeMeaning,o=r.GraphicData;return S(S({},a),{},{toolType:e.toolType,active:!1,handles:{start:{x:o[0],y:o[1],highlight:!0,active:!1},end:{x:4==o.length?o[2]:o[0]+20,y:4==o.length?o[3]:o[1]+20,highlight:!0,active:!1},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,text:i,visible:!0})}},{key:"getTID300RepresentationArguments",value:function(e){var n=[e.handles.start,e.handles.end],t=e.finding,a={points:n,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:ArrowAnnotate",findingSites:e.findingSites||[]};return t&&t.CodeValue===ue||(t={CodeValue:ue,CodingSchemeDesignator:"CST4",CodeMeaning:e.text}),a.finding=t,a}}])}();se.toolType=oe,se.utilityToolType=oe,se.TID300Representation=ie,se.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===Y&&a===oe},j.registerTool(se);var ce=C.BF.TID300.CobbAngle,le="CobbAngle",de=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n){var t=j.getSetupMeasurementData(n),a=t.defaultState,r=t.NUMGroup,i=t.SCOORDGroup,o=S(S({},a),{},{rAngle:r.MeasuredValueSequence.NumericValue,toolType:e.toolType,handles:{start:{},end:{},start2:{highlight:!0,drawnIndependently:!0},end2:{highlight:!0,drawnIndependently:!0},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}),u=T(i.GraphicData,8);return o.handles.start.x=u[0],o.handles.start.y=u[1],o.handles.end.x=u[2],o.handles.end.y=u[3],o.handles.start2.x=u[4],o.handles.start2.y=u[5],o.handles.end2.x=u[6],o.handles.end2.y=u[7],o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=e.finding,a=e.findingSites;return{point1:n.start,point2:n.end,point3:n.start2,point4:n.end2,rAngle:e.rAngle,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:CobbAngle",finding:t,findingSites:a||[]}}}])}();de.toolType=le,de.utilityToolType=le,de.TID300Representation=ce,de.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===Y&&a===le},j.registerTool(de);var fe=C.BF.TID300.Angle,ge="Angle",me=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n){var t=j.getSetupMeasurementData(n),a=t.defaultState,r=t.NUMGroup,i=t.SCOORDGroup,o=S(S({},a),{},{rAngle:r.MeasuredValueSequence.NumericValue,toolType:e.toolType,handles:{start:{},middle:{},end:{},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}),u=T(i.GraphicData,8);return o.handles.start.x=u[0],o.handles.start.y=u[1],o.handles.middle.x=u[2],o.handles.middle.y=u[3],o.handles.middle.x=u[4],o.handles.middle.y=u[5],o.handles.end.x=u[6],o.handles.end.y=u[7],o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=e.finding,a=e.findingSites;return{point1:n.start,point2:n.middle,point3:n.middle,point4:n.end,rAngle:e.rAngle,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Angle",finding:t,findingSites:a||[]}}}])}();me.toolType=ge,me.utilityToolType=ge,me.TID300Representation=fe,me.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===Y&&a===ge},j.registerTool(me);var pe=C.BF.TID300.Polyline,he=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n){var t=j.getSetupMeasurementData(n),a=t.defaultState,r=t.SCOORDGroup,i=t.NUMGroup,o=S(S({},a),{},{toolType:e.toolType,handles:{start:{},end:{},textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0},initialRotation:0},cachedStats:{area:i?i.MeasuredValueSequence.NumericValue:0},color:void 0,invalidated:!0}),u=T(r.GraphicData,6);return o.handles.start.x=u[0],o.handles.start.y=u[1],u[2],u[3],o.handles.end.x=u[4],o.handles.end.y=u[5],o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.finding,t=e.findingSites,a=e.cachedStats,r=void 0===a?{}:a,i=e.handles,o=i.start,u=i.end;return{points:[o,{x:o.x,y:u.y},u,{x:u.x,y:o.y}],area:r.area,perimeter:r.perimeter,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:RectangleRoi",finding:n,findingSites:t||[]}}}])}();he.toolType="RectangleRoi",he.utilityToolType="RectangleRoi",he.TID300Representation=pe,he.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===Y&&a===he.toolType},j.registerTool(he);var ve=t(3293),Se=t.n(ve),Ie=C.p.DicomMessage,ye=C.p.DicomMetaDictionary,Te=C.z8.Normalizer;function De(e,n,t){var a=[];if(n){var r=e[0].data.byteArray.buffer,i=Ie.readFile(r),o=ye.naturalizeDataset(i.dict);o._meta=ye.namifyDataset(i.meta),a.push(o)}else for(var u=0;u<e.length;u++){var s=e[u].data.byteArray.buffer,c=Ie.readFile(s),l=ye.naturalizeDataset(c.dict);l._meta=ye.namifyDataset(c.meta),a.push(l)}return null!=t&&t.SpecificCharacterSet&&a.forEach(function(e){return e.SpecificCharacterSet=t.SpecificCharacterSet}),Te.normalizeToDataset(a)}var Re=C.BF.orientation,Oe=Re.rotateDirectionCosinesInPlane,Ce=Re.flipImageOrientationPatient,xe=Re.flipMatrix2D,be=Re.rotateMatrix902D,Me=C.BF.datasetToBlob,Pe=C.BF.BitArray,we=C.BF.DicomMessage,Ee=C.BF.DicomMetaDictionary,Ae=C.z8.Normalizer,Ne=C.h4.Segmentation,qe={generateSegmentation:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},a=n.toolState,r=n.segments,i=e[0],o={x:i.columns,y:i.rows,z:e.length};if(o.xy=o.x*o.y,!Fe(s,r))throw new Error("No segments to export!");for(var u=i.imageId.includes("?frame"),s=function(e,n,t){var a=De(e,n);return new Ne([a],t)}(e,u,t),c=function(e,n,t){for(var a=[],r=[],i=0;i<t.length;i++)t[i]&&(a.push(i),r.push([]));for(var o=0;o<n.length;o++)for(var u=e[n[o].imageId],s=0;s<a.length;s++){var c=a[s];u&&u.brush&&u.brush.data&&u.brush.data[c]&&u.brush.data[c].pixelData&&r[s].push(o)}return{referencedFramesPerSegment:r,segmentIndicies:a}}(a,e,r),l=c.referencedFramesPerSegment,d=c.segmentIndicies,f=0,g=0;g<l.length;g++)f+=l[g].length;s.setNumberOfFrames(f);for(var m=0;m<d.length;m++){var p=d[m],h=l[m],v=h.map(function(e){return e+1}),S=r[p];s.addSegment(S,Ue(p,h,a,e,o),v)}return s.bitPackPixelData(),Me(s.dataset)},generateToolState:function(e,n,t){var a=we.readFile(n),r=Ee.naturalizeDataset(a.dict);r._meta=Ee.namifyDataset(a.meta);var i=Ae.normalizeToDataset([r]),o=t.get("imagePlaneModule",e[0]);o||console.warn("Insufficient metadata, imagePlaneModule missing.");for(var u=function(e){var n=[];n[0]=e,n[1]=Ce.h(e),n[2]=Ce.v(e);var t=Oe(e,Math.PI/2);return n[3]=t,n[4]=Ce.h(t),n[5]=Ce.v(t),n[6]=Oe(e,Math.PI),n[7]=Oe(e,1.5*Math.PI),n}(Array.isArray(o.rowCosines)?[].concat(D(o.rowCosines),D(o.columnCosines)):[o.rowCosines.x,o.rowCosines.y,o.rowCosines.z,o.columnCosines.x,o.columnCosines.y,o.columnCosines.z]),s=i.SharedFunctionalGroupsSequence,c=s.PlaneOrientationSequence?s.PlaneOrientationSequence.ImageOrientationPatient:void 0,l=i.Columns*i.Rows,d=function(e){var n=[],t=e.SegmentSequence;if(Array.isArray(t))for(var a=0;a<t.length;a++)n.push(t[a]);else n.push(t);return{seriesInstanceUid:e.ReferencedSeriesSequence.SeriesInstanceUID,data:n}}(i),f=function(e){var n=e.SegmentationType;if("BINARY"===n)return Pe.unpack(e.PixelData);var t=new Uint8Array(e.PixelData),a=e.MaximumFractionalValue,r=void 0===t.find(function(e){return 0!==e&&e!==a});if(!r)return void C.Rm.warn("This is a fractional segmentation, which is not currently supported.");return C.Rm.warn("This segmentation object is actually binary... processing as such."),t}(i),g=i.PerFrameFunctionalGroupsSequence,m={},p=!0,h=0;h<g.length;h++){var v=g[h],S=c||v.PlaneOrientationSequence.ImageOrientationPatient,I=Be(Se()(new Uint8Array(f.buffer,h*l,l),[i.Rows,i.Columns]),S,u);if(!I){console.warn("This segmentation object is not in-plane with the source data. Bailing out of IO. It'd be better to render this with vtkjs. "),p=!1;break}var y=v.SegmentIdentificationSequence.ReferencedSegmentNumber-1;ke(m,Ve(s.DerivationImageSequence&&s.DerivationImageSequence.SourceImageSequence?s.DerivationImageSequence.SourceImageSequence[h]:v.DerivationImageSequence.SourceImageSequence,e,t),y,I)}if(!p)return;return{toolState:m,segMetadata:d}}};function Ue(e,n,t,a,r){for(var i=new Uint8Array(r.xy*n.length),o=0,u=0;u<n.length;u++)for(var s=t[a[n[u]].imageId].brush.data[e].pixelData,c=0;c<s.length;c++)i[o]=s[c],o++;return i}function Fe(e,n){for(var t=0,a=0;a<n.length;a++)n[a]&&t++;return t}function ke(e,n,t,a){e[n]?e[n].brush?e[n].brush.data||(e[n].brush.data=[]):(e[n].brush={},e[n].brush.data=[]):(e[n]={},e[n].brush={},e[n].brush.data=[]),e[n].brush.data[t]={};var r=e[n].brush.data[t];r.pixelData=new Uint8Array(a.data.length);for(var i=r.pixelData,o=0;o<i.length;o++)a.data[o]?i[o]=1:i[o]=0}function Ve(e,n,t){var a=e.ReferencedSOPInstanceUID,r=e.ReferencedFrameNumber;return r?function(e,n,t,a){var r=t.find(function(t){var r=a.get("sopCommonModule",t);if(r){var i=Number(t.split("frame=")[1]);return r.sopInstanceUID===e&&i===n-1}});return r}(a,r,n,t):function(e,n,t){return n.find(function(n){var a=t.get("sopCommonModule",n);if(a)return a.sopInstanceUID===e})}(a,n,t)}function Be(e,n,t){return _e(n,t[0])?e:_e(n,t[1])?xe.v(e):_e(n,t[2])?xe.h(e):_e(n,t[3])?be(e):_e(n,t[4])?xe.h(be(e)):_e(n,t[5])?xe.v(be(e)):_e(n,t[6])?be(be(e)):_e(n,t[7])?be(be(be(e))):void 0}var Ge=1e-5;function _e(e,n){return Math.abs(e[0]-n[0])<Ge&&Math.abs(e[1]-n[1])<Ge&&Math.abs(e[2]-n[2])<Ge&&Math.abs(e[3]-n[3])<Ge&&Math.abs(e[4]-n[4])<Ge&&Math.abs(e[5]-n[5])<Ge}var Le,je=C.BF.orientation.nearlyEqual;function Ye(e,n,t){if(e.length!==n.length)return!1;for(var a=0;a<e.length;++a)if(!je(e[a],n[a],t))return!1;return!0}function ze(e,n,t,a){var r=e.SharedFunctionalGroupsSequence,i=e.PerFrameFunctionalGroupsSequence,o=r.PlaneOrientationSequence?r.PlaneOrientationSequence.ImageOrientationPatient:void 0,u=i[0],s=o||u.PlaneOrientationSequence.ImageOrientationPatient;return n.some(function(e){return Ye(s,e,a)})?"Planar":function(e,n,t){var a=Math.abs(e[0]*n[0]+e[1]*n[1]+e[2]*n[2]),r=Math.abs(e[3]*n[3]+e[4]*n[4]+e[5]*n[5]);return(a<t||Math.abs(a-1)<t)&&(r<t||Math.abs(r-1)<t)}(s,n[0],a)&&t.includes(e.Rows)&&t.includes(e.Columns)?"Perpendicular":"Oblique"}!function(e){e.SEGMENTATION_LOAD_PROGRESS="CORNERSTONE_ADAPTER_SEGMENTATION_LOAD_PROGRESS"}(Le||(Le={}));var He=Le,Xe=C.BF.orientation,We=Xe.rotateDirectionCosinesInPlane,Qe=Xe.flipImageOrientationPatient,$e=Xe.flipMatrix2D,Je=Xe.rotateMatrix902D,Ke=C.p.BitArray,Ze=C.p.DicomMessage,en=C.p.DicomMetaDictionary,nn=C.z8.Normalizer,tn=C.h4.Segmentation,an=C.BF.compression,rn=an.encode,on=an.decode,un={includeSliceSpacing:!0,rleEncode:!1};function sn(e,n){for(var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=Object.assign({},un,t),r=Array.isArray(n)?n:[n],i=0,o=[],u=function(){for(var e=r[s],n=e.labelmaps2D,t=e.metadata,a=[],u=1;u<t.length;u++)t[u]&&(a[u]=[]);for(var c=function(e){var t=n[e];n[e]&&t.segmentsOnLabelmap.forEach(function(n){0!==n&&(a[n].push(e),i++)})},l=0;l<n.length;l++)c(l);o[s]=a},s=0;s<r.length;s++)u();e.setNumberOfFrames(i);for(var c=0;c<r.length;c++)for(var l=o[c],d=r[c],f=d.metadata,g=1;g<l.length;g++){var m=l[g];if(m){var p=m.map(function(e){return e+1}),h=f[g],v=cn(d,m);e.addSegmentFromLabelmap(h,v,g,p)}}if(a.rleEncode){var S=rn(e.dataset.PixelData,i,e.dataset.Rows,e.dataset.Columns);e.assignToDataset({BitsAllocated:"8",BitsStored:"8",HighBit:"7",SegmentationType:"FRACTIONAL",SegmentationFractionalType:"PROBABILITY",MaximumFractionalValue:"255"}),e.dataset._meta.TransferSyntaxUID={Value:["1.2.840.10008.1.2.5"],vr:"UI"},e.dataset.SpecificCharacterSet="ISO_IR 192",e.dataset._vrMap.PixelData="OB",e.dataset.PixelData=S}else e.bitPackPixelData();return e}function cn(e,n){for(var t=e.labelmaps2D,a=[],r=0;r<n.length;r++){var i=n[r];a.push(t[i].pixelData)}return a}function ln(){return(ln=d(I().m(function e(n,t,a,r){var i,o,u,s,c,l,d,f,g,m,p,h,v,S,y,T,R,O,C,x,b,M,P,w,E,A,N,q,U,F,k,V,B,G,_,L;return I().w(function(e){for(;;)switch(e.n){case 0:if(i=r.skipOverlapping,o=void 0!==i&&i,u=r.tolerance,s=void 0===u?.001:u,c=r.TypedArrayConstructor,l=void 0===c?Uint8Array:c,d=r.maxBytesPerChunk,f=void 0===d?199e6:d,g=r.eventTarget,m=r.triggerEvent,p=Ze.readFile(t),(h=en.naturalizeDataset(p.dict))._meta=en.namifyDataset(p.meta),v=nn.normalizeToDataset([h]),S=a.get("imagePlaneModule",n[0]),y=a.get("generalSeriesModule",n[0]),T=y.seriesInstanceUID,S||console.warn("Insufficient metadata, imagePlaneModule missing."),R=Array.isArray(S.rowCosines)?[].concat(D(S.rowCosines),D(S.columnCosines)):[S.rowCosines.x,S.rowCosines.y,S.rowCosines.z,S.columnCosines.x,S.columnCosines.y,S.columnCosines.z],O=vn(R),C=v.Columns*v.Rows,x=In(v,T),"1.2.840.10008.1.2.5"!==v._meta.TransferSyntaxUID.Value[0]){e.n=2;break}if(P=Array.isArray(v.PixelData)?v.PixelData:[v.PixelData],b=on(P,v.Rows,v.Columns),1!==v.BitsStored){e.n=1;break}return console.warn("No implementation for rle + bitbacking."),e.a(2);case 1:M=[b],e.n=3;break;case 2:if(M=hn(v,{maxBytesPerChunk:f})){e.n=3;break}throw new Error("Fractional segmentations are not yet supported");case 3:w=ze(v,O,[S.rows,S.columns,n.length],s),E=n.reduce(function(e,n){return e[a.get("generalImageModule",n).sopInstanceUID]=n,e},{}),A=!1,o||(A=fn(M,v,n,O,a,s,l,E)),L=w,e.n="Planar"===L?4:"Perpendicular"===L?5:"Oblique"===L?6:7;break;case 4:return N=A?gn:pn,e.a(3,7);case 5:throw new Error("Segmentations orthogonal to the acquisition plane of the source data are not yet supported.");case 6:throw new Error("Segmentations oblique to the acquisition plane of the source data are not yet supported.");case 7:return(q=[])[0]=[],U=[],F=C*n.length*l.BYTES_PER_ELEMENT,(k=[])[0]=new ArrayBuffer(F),V=n.reduce(function(e,n,t){return e.indices[n]=t,e.metadata[n]=a.get("instance",n),e},{indices:{},metadata:{}}),B=new Map,e.n=8,N(U,q,k,M,v,n,O,a,s,l,B,E,V,g,m);case 8:return G=e.v,_=new Map,B.forEach(function(e,t){var r=Tn(e,v,a,n);_.set(t,r)}),e.a(2,{labelmapBufferArray:k,segMetadata:x,segmentsOnFrame:U,segmentsOnFrameArray:q,centroids:_,overlappingSegments:G})}},e)}))).apply(this,arguments)}function dn(e,n,t,a,r,i){var o=void 0;if(!e)return o;var u=e.FrameOfReferenceUID,s=e.PerFrameFunctionalGroupsSequence,c=e.SourceImageSequence,l=e.ReferencedSeriesSequence;if(!s||0===s.length)return o;var d=s[n];if(!d)return o;var f=void 0;if(d.DerivationImageSequence){var g=d.DerivationImageSequence;Array.isArray(g)&&(g=0!==g.length?g[0]:void 0),g&&(f=g.SourceImageSequence,Array.isArray(f)&&(f=0!==f.length?f[0]:void 0))}else c&&0!==c.length&&(console.warn("DerivationImageSequence not present, using SourceImageSequence assuming SEG has the same geometry as the source image."),f=c[n]);(f&&(o=function(e,n){var t=e.ReferencedSOPInstanceUID,a=e.ReferencedFrameNumber;return a?function(e,n,t){var a=t[e];if(!a)return;var r=Number(a.split("frame=")[1]);return r===n-1?a:void 0}(t,a,n):n[t]}(f,i)),void 0===o&&l)&&(o=function(e,n,t,a,r,i){if(void 0===e||void 0===t.PlanePositionSequence||void 0===t.PlanePositionSequence[0]||void 0===t.PlanePositionSequence[0].ImagePositionPatient)return;for(var o=0;o<a.length;++o){var u=r.get("instance",a[o]);if(void 0!==u&&void 0!==u.ImagePositionPatient&&u.FrameOfReferenceUID===n&&u.SeriesInstanceUID===e&&Ye(t.PlanePositionSequence[0].ImagePositionPatient,u.ImagePositionPatient,i))return a[o]}}((Array.isArray(l)?l[0]:l).SeriesInstanceUID,u,d,t,a,r));return o}function fn(e,n,t,a,r,i,o,u){var s=n.SharedFunctionalGroupsSequence,c=n.PerFrameFunctionalGroupsSequence,l=n.SegmentSequence,d=n.Rows,f=n.Columns;if(l.length<2)return!1;for(var g=s.PlaneOrientationSequence?s.PlaneOrientationSequence.ImageOrientationPatient:void 0,m=f*d,h=c.length,v=new Map,S=function(){if(void 0===mn(n,I))return console.warn("Could not retrieve the segment index for frame segment "+I+", skipping this frame."),0;var e=dn(n,I,t,r,i,u);if(!e)return console.warn("Image not present in stack, can't import frame : "+I+"."),0;var a=t.findIndex(function(n){return n===e});if(v.has(a)){var o=v.get(a);o.includes(I)||(o.push(I),v.set(a,o))}else v.set(a,[I])},I=0;I<h;++I)S();var y,D=p(v.entries());try{for(D.s();!(y=D.n()).done;)for(var R=T(y.value,2)[1],O=new o(m).fill(0),C=0;C<R.length;++C){var x=R[C],b=c[x],M=g||b.PlaneOrientationSequence.ImageOrientationPatient,P=yn(e,x*m,m),w=Sn(Se()(P,[d,f]),M,a,i);if(w){for(var E=w.data,A=0,N=E.length;A<N;++A)if(0!==E[A]&&(O[A]++,O[A]>1))return!0}else console.warn("Individual SEG frames are out of plane with respect to the first SEG frame, this is not yet supported, skipping this frame.")}}catch(e){D.e(e)}finally{D.f()}return!1}function gn(e,n,t,a,r,i,o,u,s,c,l,d){for(var f=r.SharedFunctionalGroupsSequence,g=r.PerFrameFunctionalGroupsSequence,m=r.Rows,p=r.Columns,h=f.PlaneOrientationSequence?f.PlaneOrientationSequence.ImageOrientationPatient:void 0,v=p*m,S=v*i.length*c.BYTES_PER_ELEMENT,I=1,y=0,T=t[y].slice(0),D=structuredClone(n[y]),R=r.SegmentSequence.length,O=1;O<=R;++O){for(var C=function(l){var f=g[l],R=mn(r,l);if(void 0===R)throw new Error("Could not retrieve the segment index. Aborting segmentation loading.");if(R!==O)return x=l,0;var C=h||f.PlaneOrientationSequence.ImageOrientationPatient,b=yn(a,l*v,v),M=Sn(Se()(b,[m,p]),C,o,s);if(!M)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");var P=dn(r,l,i,u,s,d);if(!P)return console.warn("Image not present in stack, can't import frame : "+l+"."),x=l,0;var w=u.get("instance",P);if(m!==w.Rows||p!==w.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");for(var E=i.findIndex(function(e){return e===P}),A=v*E*c.BYTES_PER_ELEMENT,N=new c(T,A,v),q=M.data,U=!1,F=0,k=M.data.length;F<k;++F)if(q[F]){if(0!==N[F]){++y>=I&&(t[y]=new ArrayBuffer(S),n[y]=[],I++),T=t[y].slice(0),D=structuredClone(n[y]),l=0;break}N[F]=R,U=!0}U&&(D[E]||(D[E]=[]),D[E].push(R),e[E]||(e[E]=[]),e[E].push(R)),x=l},x=0,b=g.length;x<b;++x)C(x);t[y]=T.slice(0),n[y]=structuredClone(D),T=t[y=0].slice(0),D=structuredClone(n[y])}}var mn=function(e,n){var t=e.PerFrameFunctionalGroupsSequence,a=e.SharedFunctionalGroupsSequence,r=t[n];return r&&r.SegmentIdentificationSequence?r.SegmentIdentificationSequence.ReferencedSegmentNumber:a.SegmentIdentificationSequence?a.SegmentIdentificationSequence.ReferencedSegmentNumber:void 0};function pn(e,n,t,a,r,i,o,u,s,c,l,d,f,g,m){var p=r.SharedFunctionalGroupsSequence,h=r.PerFrameFunctionalGroupsSequence,v=r.Rows,S=r.Columns,I=p.PlaneOrientationSequence?p.PlaneOrientationSequence.ImageOrientationPatient:void 0,y=S*v,T=0,D=h.length,R=Math.ceil(D/10),O=m&&g,C=!1;return new Promise(function(n){!function p(){for(var x=Math.min(T+R,D);T<x;++T){var b=h[T],M=I||b.PlaneOrientationSequence.ImageOrientationPatient,P=yn(a,T*y,y),w=Sn(Se()(P,[v,S]),M,o,s);if(!w)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");var E=mn(r,T);if(void 0===E)throw new Error("Could not retrieve the segment index. Aborting segmentation loading.");l.has(E)||l.set(E,{});var A=dn(r,T,i,u,s,d);if(A){var N=f.metadata[A];if(v!==N.Rows||S!==N.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");for(var q=f.indices[A],U=y*q*c.BYTES_PER_ELEMENT,F=new c(t[0],U,y),k=w.data,V=[],B=0,G=w.data.length;B<G;++B)if(k[B]){for(var _=B;_<G;++_)k[_]&&(C||0===F[_]||(C=!0),F[_]=E,V.push(_));e[q]||(e[q]=[]),e[q].push(E);break}var L=l.get(E);L[q]=V,l.set(E,L)}else console.warn("Image not present in stack, can't import frame : "+T+".")}if(O){var j=Math.round(T/D*100);m(g,He.SEGMENTATION_LOAD_PROGRESS,{percentComplete:j})}T<D?setTimeout(p,0):n(C)}()})}function hn(e,n){var t,a=e.SegmentationType;if(void 0===(t=Array.isArray(e.PixelData)?e.PixelData[0]:e.PixelData)&&C.Rm.error("This segmentation pixelData is undefined."),"BINARY"===a)return function(e,n){for(var t=new Uint8Array(e),a=[],r=8*n,i=Math.ceil(8*t.length/r),o=0;o<i;o++){var u=o*r,s=Math.min(u+r,8*t.length),c=Math.floor(u/8),l=Math.ceil(s/8),d=t.slice(c,l),f=Ke.unpack(d);a.push(f)}return a}(t,n.maxBytesPerChunk);var r=new Uint8Array(t),i=e.MaximumFractionalValue;return void 0===r.find(function(e){return 0!==e&&e!==i})?(C.Rm.warn("This segmentation object is actually binary... processing as such."),r):void 0}function vn(e){var n=[];n[0]=e,n[1]=Qe.h(e),n[2]=Qe.v(e);var t=We(e,Math.PI/2);return n[3]=t,n[4]=Qe.h(t),n[5]=Qe.v(t),n[6]=We(e,Math.PI),n[7]=We(e,1.5*Math.PI),n}function Sn(e,n,t,a){return Ye(n,t[0],a)?e:Ye(n,t[1],a)?$e.v(e):Ye(n,t[2],a)?$e.h(e):Ye(n,t[3],a)?Je(e):Ye(n,t[4],a)?Je($e.h(e)):Ye(n,t[5],a)?Je($e.v(e)):Ye(n,t[6],a)?Je(Je(e)):Ye(n,t[7],a)?Je(Je(Je(e))):void 0}function In(e,n){var t=e.SegmentSequence;return{seriesInstanceUid:n,data:Array.isArray(t)?[void 0].concat(D(t)):[void 0,t]}}function yn(e,n,t){var a=function(e,n,t){var a=e.reduce(function(e,n){return e+n.length},0);if(n<0||n+t>a)throw new Error("Offset and length out of bounds");var r=0,i=n;for(;i>=e[r].length;)i-=e[r].length,r++;var o=r,u=i+t;for(;u>e[o].length;)u-=e[o].length,o++;return{start:{chunkIndex:r,offset:i},end:{chunkIndex:o,offset:u}}}(e,n,t);if(a.start.chunkIndex===a.end.chunkIndex)return new Uint8Array(e[a.start.chunkIndex].buffer,a.start.offset,t);for(var r=new Uint8Array(t),i=0,o=a.start.chunkIndex;o<=a.end.chunkIndex;o++){var u=o===a.start.chunkIndex?a.start.offset:0,s=o===a.end.chunkIndex?a.end.offset:e[o].length;r.set(new Uint8Array(e[o].buffer,u,s-u),i),i+=s-u}return r}function Tn(e,n,t,a){for(var r=0,i=0,o=0,u=0,s=0,c=0,l=0,d=0,f=Object.entries(e);d<f.length;d++){var g=T(f[d],2),m=g[0],h=g[1],v=Number(m);if(h&&0!==h.length){var S=a[v],I=t.get("imagePlaneModule",S);if(I){var y,D=I.imagePositionPatient,R=I.rowCosines,O=I.columnCosines,C=I.rowPixelSpacing,x=I.columnPixelSpacing,b=p(h);try{for(b.s();!(y=b.n()).done;){var M=y.value,P=Math.floor(M/n.Rows),w=M%n.Rows;r+=w,i+=P,o+=v;var E=D[0]+w*R[0]*x+P*O[0]*C,A=D[1]+w*R[1]*x+P*O[1]*C,N=D[2]+w*R[2]*x+P*O[2]*C;u+=E,s+=A,c+=N,l++}}catch(e){b.e(e)}finally{b.f()}}else console.debug("Missing imagePlaneModule metadata for centroid calculation")}}return{image:{x:Math.floor(r/l),y:Math.floor(i/l),z:Math.floor(o/l)},world:{x:u/l,y:s/l,z:c/l},count:l}}var Dn={generateSegmentation:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=e[0].imageId.includes("?frame");return sn(function(e,n,t){var a=De(e,n);return new tn([a],t)}(e,a,t),n,t)},generateToolState:function(e,n,t,a){return ln.apply(this,arguments)},fillSegmentation:sn};function Rn(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4;return 4===a?Dn.generateSegmentation(e,n,t):3===a?qe.generateSegmentation(e,n,t):void console.warn("No generateSegmentation adapter for cornerstone version ".concat(a,", exiting."))}function On(e,n,t){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:4;return 4===i?Dn.generateToolState(e,n,t,a,r):3===i?qe.generateToolState(e,n,t):void console.warn("No generateToolState adapter for cornerstone version ".concat(i,", exiting."))}function Cn(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4;if(4===a)return Dn.fillSegmentation(e,n,t);console.warn("No generateSegmentation adapter for cornerstone version ".concat(a,", exiting."))}var xn=C.p.DicomMessage,bn=C.p.DicomMetaDictionary,Mn=C.z8.Normalizer;function Pn(){return Pn=d(I().m(function e(n,t,a){var r,i,o,u,s,c,l,d,f,g,m,p=arguments;return I().w(function(e){for(;;)switch(e.n){case 0:if(r=p.length>3&&void 0!==p[3]?p[3]:.001,i=xn.readFile(t),(o=bn.naturalizeDataset(i.dict))._meta=bn.namifyDataset(i.meta),u=Mn.normalizeToDataset([o]),(s=a.get("imagePlaneModule",n[0]))||console.warn("Insufficient metadata, imagePlaneModule missing."),c=Array.isArray(s.rowCosines)?[].concat(D(s.rowCosines),D(s.columnCosines)):[s.rowCosines.x,s.rowCosines.y,s.rowCosines.z,s.columnCosines.x,s.columnCosines.y,s.columnCosines.z],l=[c],d=En(u),f=ze(u,l,[s.rows,s.columns,n.length],r),g=n.reduce(function(e,n){return e[a.get("generalImageModule",n).sopInstanceUID]=n,e},{}),"Planar"===f){e.n=1;break}throw new Error("Parametric maps ".concat({Perpendicular:"orthogonal",Oblique:"oblique"}[f]," to the acquisition plane of the source data are not yet supported."));case 1:return m=n.reduce(function(e,n,t){return e.indices[n]=t,e.metadata[n]=a.get("instance",n),e},{indices:{},metadata:{}}),e.n=2,wn(d,u,n,a,r,g,m);case 2:return e.a(2,{pixelData:d})}},e)})),Pn.apply(this,arguments)}function wn(e,n,t,a,r,i,o){for(var u=new e.constructor(e.length),s=n.PerFrameFunctionalGroupsSequence,c=n.Rows,l=n.Columns,d=l*c,f=s.length,g=0;g<f;g++){var m=new e.constructor(e.buffer,g*d,d),p=An(n,g,t,a,r,i);if(p){var h=o.metadata[p];if(c!==h.Rows||l!==h.Columns)throw new Error("Parametric map have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported.");var v=d*o.indices[p]*u.BYTES_PER_ELEMENT;new u.constructor(u.buffer,v,d).set(m)}else console.warn("Image not present in stack, can't import frame : "+g+".")}return u}function En(e){var n,t,a;e.PixelData?(n=(16===e.BitsAllocated?[Uint16Array,Int16Array]:[Uint32Array,Int32Array])[null!==(a=e.PixelRepresentation)&&void 0!==a?a:0],t=e.PixelData):e.FloatPixelData?(n=Float32Array,t=e.FloatPixelData):e.DoubleFloatPixelData&&(n=Float64Array,t=e.DoubleFloatPixelData);return void 0===t&&C.Rm.error("This parametric map pixel data is undefined."),Array.isArray(t)&&(t=t[0]),new n(t)}function An(e,n,t,a,r,i){var o=void 0;if(!e)return o;var u=e.FrameOfReferenceUID,s=e.PerFrameFunctionalGroupsSequence,c=e.SourceImageSequence,l=e.ReferencedSeriesSequence;if(!s||0===s.length)return o;var d=s[n];if(!d)return o;var f=void 0;if(d.DerivationImageSequence){var g=d.DerivationImageSequence;Array.isArray(g)&&(g=0!==g.length?g[0]:void 0),g&&(f=g.SourceImageSequence,Array.isArray(f)&&(f=0!==f.length?f[0]:void 0))}else c&&0!==c.length&&(console.warn("DerivationImageSequence not present, using SourceImageSequence assuming SEG has the same geometry as the source image."),f=c[n]);(f&&(o=function(e,n){var t=e.ReferencedSOPInstanceUID,a=e.ReferencedFrameNumber;return a?function(e,n,t){var a=t[e];if(!a)return;var r=Number(a.split("frame=")[1]);return r===n-1?a:void 0}(t,a,n):n[t]}(f,i)),void 0===o&&l)&&(o=function(e,n,t,a,r,i){if(void 0===e||void 0===t.PlanePositionSequence||void 0===t.PlanePositionSequence[0]||void 0===t.PlanePositionSequence[0].ImagePositionPatient)return;for(var o=0;o<a.length;++o){var u=r.get("instance",a[o]);if(void 0!==u&&void 0!==u.ImagePositionPatient&&u.FrameOfReferenceUID===n&&u.SeriesInstanceUID===e&&Ye(t.PlanePositionSequence[0].ImagePositionPatient,u.ImagePositionPatient,i))return a[o]}}((Array.isArray(l)?l[0]:l).SeriesInstanceUID,u,d,t,a,r));return o}var Nn,qn={Length:X,FreehandRoi:Q,Bidirectional:K,EllipticalRoi:ne,CircleRoi:re,ArrowAnnotate:se,MeasurementReport:j,CobbAngle:de,Angle:me,RectangleRoi:he},Un={Segmentation:a},Fn={ParametricMap:{generateToolState:function(e,n,t){return Pn.apply(this,arguments)}}},kn="Cornerstone3DTools@^0.1.0",Vn={CodingSchemeDesignator:"CORNERSTONEJS",codeValues:{CORNERSTONEFREETEXT:"CORNERSTONEFREETEXT"}},Bn=C.BF.TID1500,Gn=C.BF.addAccessors,_n=C.h4.StructuredReport,Ln=C.z8.Normalizer,jn=Bn.TID1500MeasurementReport,Yn=Bn.TID1501MeasurementGroup,zn=C.p.DicomMetaDictionary,Hn={CodingSchemeDesignator:"DCM",CodeValue:"121071"},Xn={CodingSchemeDesignator:"SCT",CodeValue:"363698007"},Wn={CodingSchemeDesignator:"SRT",CodeValue:"G-C0E3"},Qn=function(e,n,t){var a=e.ConceptNameCodeSequence;if(a){var r=a.CodingSchemeDesignator,i=a.CodeValue;return r==n.CodingSchemeDesignator&&i==n.CodeValue||t&&r==t.CodingSchemeDesignator&&i==t.CodeValue}};var $n=function(){function e(){f(this,e)}return m(e,null,[{key:"getCornerstoneLabelFromDefaultState",value:function(e){var n=e.findingSites,t=void 0===n?[]:n,a=e.finding,r=Vn.codeValues.CORNERSTONEFREETEXT,i=t.find(function(e){return e.CodeValue===r});return i?i.CodeMeaning:a&&a.CodeValue===r?a.CodeMeaning:void 0}},{key:"generateDatasetMeta",value:function(){var e=new Uint8Array(2);return e[1]=1,{FileMetaInformationVersion:{Value:[e.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[zn.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}}}},{key:"getSetupMeasurementData",value:function(n,t,a,r){var i=n.ContentSequence,o=x(i),u=o.find(function(e){return Qn(e,Hn)}),s=o.filter(function(e){return Qn(e,Xn,Wn)})||[],c=o.find(function(e){return"NUM"===e.ValueType}),l=x(c.ContentSequence).find(function(e){return"SCOORD"===e.ValueType}),d=l.ContentSequence.ReferencedSOPSequence,f=d.ReferencedSOPInstanceUID,g=d.ReferencedFrameNumber,m=t[f],p=a.get("imagePlaneModule",m),h=u?Gn(u.ConceptCodeSequence):void 0,v=s.map(function(e){return Gn(e.ConceptCodeSequence)}),S={description:void 0,sopInstanceUid:f,annotation:{annotationUID:zn.uid(),metadata:{toolName:r,referencedImageId:m,FrameOfReferenceUID:p.frameOfReferenceUID,label:""},data:void 0},finding:h,findingSites:v};return S.finding&&(S.description=S.finding.CodeMeaning),S.annotation.metadata.label=e.getCornerstoneLabelFromDefaultState(S),{defaultState:S,NUMGroup:c,SCOORDGroup:l,ReferencedSOPSequence:d,ReferencedSOPInstanceUID:f,ReferencedFrameNumber:g}}},{key:"generateReport",value:function(n,t,a,r){var i=[],o={},u=[],s=e.generateDatasetMeta();Object.keys(n).forEach(function(r){var s=t.get("sopCommonModule",r),c=t.get("instance",r),l=s.sopInstanceUID,d=s.sopClassUID,f=c.SeriesInstanceUID;if(o[l]=f,!u.find(function(e){return e.SeriesInstanceUID===f})){var g=e.generateDerivationSourceDataset(c);u.push(g)}var m=t.get("frameNumber",r),p=n[r],h=Object.keys(p),v={ReferencedSOPClassUID:d,ReferencedSOPInstanceUID:l,ReferencedFrameNumber:void 0};(c&&c.NumberOfFrames&&c.NumberOfFrames>1||Ln.isMultiframeSOPClassUID(d))&&(v.ReferencedFrameNumber=m);var S=[];h.forEach(function(e){var n=function(e,n,t,a){var r=n[e],i=$n.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[e];if(r&&r.data&&r.data.length&&i){var o=r.data.map(function(e){return function(e,n,t,a,r){var i=a.getTID300RepresentationArguments(e,r);return i.ReferencedSOPSequence=t,new a.TID300Representation(i)}(e,0,t,i,a)});return new Yn(o)}}(e,p,v,a);n&&S.push(n)}),i=i.concat(S)});var c=new jn({TID1501MeasurementGroups:i},r),l=new _n(u,r),d=c.contentItem(u,S(S({},r),{},{sopInstanceUIDsToSeriesInstanceUIDMap:o}));return l.dataset=Object.assign(l.dataset,d),l.dataset._meta=s,l.SpecificCharacterSet="ISO_IR 192",l}},{key:"generateToolState",value:function(n,t,a,r,i){if("1500"!==n.ContentTemplateSequence.TemplateIdentifier)throw new Error("This package can currently only interpret DICOM SR TID 1500");var o=x(n.ContentSequence).find(b("Imaging Measurements")),u=x(o.ContentSequence).filter(b("Measurement Group")),s={},c=e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,l=[];return Object.keys(c).forEach(function(e){l.push(c[e]),s[e]=[]}),u.forEach(function(e){try{var o,u=x(e.ContentSequence),c=u.find(function(e){return"Tracking Identifier"===e.ConceptNameCodeSequence.CodeMeaning}).TextValue,d=u.find(function(e){return"Tracking Unique Identifier"===e.ConceptNameCodeSequence.CodeMeaning}),f=null==d?void 0:d.UID,g=(null==i||null===(o=i.getToolClass)||void 0===o?void 0:o.call(i,e,n,l))||l.find(function(e){return e.isValidCornerstoneTrackingIdentifier(c)});if(g){var m=g.getMeasurementData(e,t,a,r);m.TrackingUniqueIdentifier=f,console.log("=== ".concat(g.toolType," ===")),console.log(m),s[g.toolType].push(m)}}catch(n){console.warn("Unable to generate tool state for",e,n)}}),s}},{key:"registerTool",value:function(n){e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE[n.utilityToolType]=n,e.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[n.toolType]=n,e.MEASUREMENT_BY_TOOLTYPE[n.toolType]=n.utilityToolType}}])}();(Nn=$n).CORNERSTONE_3D_TAG=kn,Nn.MEASUREMENT_BY_TOOLTYPE={},Nn.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE={},Nn.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE={},Nn.generateDerivationSourceDataset=function(e){var n=Nn.generateDatasetMeta();return S(S({},e),{},{_meta:n,_vrMap:{PixelData:"OW"}})};var Jn,Kn=C.BF.TID300.Point,Zn="ArrowAnnotate",et="".concat(kn,":").concat(Zn),nt=Vn.codeValues,tt=Vn.CodingSchemeDesignator,at=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n,t,a,r){for(var i=$n.getSetupMeasurementData(n,t,r,e.toolType),o=i.defaultState,u=i.SCOORDGroup,s=i.ReferencedFrameNumber,c=o.annotation.metadata.referencedImageId,l=o.annotation.metadata.label,d=u.GraphicData,f=[],g=0;g<d.length;g+=2){var m=a(c,[d[g],d[g+1]]);f.push(m)}if(1===f.length){var p=r.get("imagePixelModule",c),h=10,v=10;if(p)h=p.columns/10,v=p.rows/10;var S=a(c,[d[0]+h,d[1]+v]);f.push(S)}var I=o;return I.annotation.data={text:l,handles:{arrowFirst:!0,points:[f[0],f[1]],activeHandleIndex:0,textBox:{hasMoved:!1}},frameNumber:s},I}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,a=e.metadata,r=e.finding,i=e.findingSites,o=a.referencedImageId;if(!o)throw new Error("ArrowAnnotate.getTID300RepresentationArguments: referencedImageId is not defined");var u,s,c=t.handles,l=c.points;c.arrowFirst?(u=l[0],s=l[1]):(u=l[1],s=l[0]);var d=n(o,u),f=n(o,s),g={points:[{x:d[0],y:d[1]},{x:f[0],y:f[1]}],trackingIdentifierTextValue:et,findingSites:i||[]};return r&&r.CodeValue===nt.CORNERSTONEFREETEXT||(r={CodeValue:nt.CORNERSTONEFREETEXT,CodingSchemeDesignator:tt,CodeMeaning:t.text}),g.finding=r,g}}])}();at.toolType=Zn,at.utilityToolType=Zn,at.TID300Representation=Kn,at.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===kn&&a===Zn},$n.registerTool(at);var rt,it=C.BF.TID300.Bidirectional,ot="Bidirectional",ut="".concat(kn,":").concat(ot),st=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n,t,a,r){var i=$n.getSetupMeasurementData(n,t,r,e.toolType),o=i.defaultState,u=i.ReferencedFrameNumber,s=o.annotation.metadata.referencedImageId,c=n.ContentSequence,l=x(c).find(function(e){return"Long Axis"===e.ConceptNameCodeSequence.CodeMeaning}),d=x(l.ContentSequence).find(function(e){return"SCOORD"===e.ValueType}),f=x(c).find(function(e){return"Short Axis"===e.ConceptNameCodeSequence.CodeMeaning}),g=x(f.ContentSequence).find(function(e){return"SCOORD"===e.ValueType}),m=[];[d,g].forEach(function(e){for(var n=e.GraphicData,t=0;t<n.length;t+=2){var r=a(s,[n[t],n[t+1]]);m.push(r)}});var p=o;return p.annotation.data={handles:{points:[m[0],m[1],m[2],m[3]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(s),{length:l.MeasuredValueSequence.NumericValue,width:f.MeasuredValueSequence.NumericValue}),frameNumber:u},p}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,a=e.finding,r=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("Bidirectional.getTID300RepresentationArguments: referencedImageId is not defined");var l,d,f=u["imageId:".concat(c)]||{},g=f.length,m=f.width,p=s.points,h=[p[0],p[1]],v=[p[2],p[3]];Math.sqrt(Math.pow(h[0][0]-h[1][0],2)+Math.pow(h[0][1]-h[1][1],2)+Math.pow(h[0][2]-h[1][2],2))>Math.sqrt(Math.pow(v[0][0]-v[1][0],2)+Math.pow(v[0][1]-v[1][1],2)+Math.pow(v[0][2]-v[1][2],2))?(l=h,d=v):(l=v,d=h);var S=n(c,l[0]),I=n(c,l[1]),y=n(c,d[0]),T=n(c,d[1]);return{longAxis:{point1:{x:S[0],y:S[1]},point2:{x:I[0],y:I[1]}},shortAxis:{point1:{x:y[0],y:y[1]},point2:{x:T[0],y:T[1]}},longAxisLength:g,shortAxisLength:m,trackingIdentifierTextValue:ut,finding:a,findingSites:r||[]}}}])}();(Jn=st).toolType=ot,Jn.utilityToolType=ot,Jn.TID300Representation=it,Jn.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===kn&&a===ot},$n.registerTool(st);var ct,lt=C.BF.TID300.CobbAngle,dt="Angle",ft="".concat(kn,":").concat(dt),gt=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n,t,a,r){for(var i=$n.getSetupMeasurementData(n,t,r,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],g=0;g<d.length;g+=2){var m=a(l,[d[g],d[g+1]]);f.push(m)}var p=o;return p.annotation.data={handles:{points:[f[0],f[1],f[3]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(l),{angle:u?u.MeasuredValueSequence.NumericValue:null}),frameNumber:c},p}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,a=e.finding,r=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("Angle.getTID300RepresentationArguments: referencedImageId is not defined");var l=n(c,s.points[0]),d=n(c,s.points[1]),f=n(c,s.points[2]),g={x:l[0],y:l[1]},m={x:d[0],y:d[1]};return{point1:g,point2:m,point3:m,point4:{x:f[0],y:f[1]},rAngle:(u["imageId:".concat(c)]||{}).angle,trackingIdentifierTextValue:ft,finding:a,findingSites:r||[]}}}])}();(rt=gt).toolType=dt,rt.utilityToolType=dt,rt.TID300Representation=lt,rt.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===kn&&a===dt},$n.registerTool(gt);var mt,pt=C.BF.TID300.CobbAngle,ht="CobbAngle",vt="".concat(kn,":").concat(ht),St=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n,t,a,r){for(var i=$n.getSetupMeasurementData(n,t,r,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],g=0;g<d.length;g+=2){var m=a(l,[d[g],d[g+1]]);f.push(m)}var p=o;return p.annotation.data={handles:{points:[f[0],f[1],f[2],f[3]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(l),{angle:u?u.MeasuredValueSequence.NumericValue:null}),frameNumber:c},p}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,a=e.finding,r=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("CobbAngle.getTID300RepresentationArguments: referencedImageId is not defined");var l=n(c,s.points[0]),d=n(c,s.points[1]),f=n(c,s.points[2]),g=n(c,s.points[3]);return{point1:{x:l[0],y:l[1]},point2:{x:d[0],y:d[1]},point3:{x:f[0],y:f[1]},point4:{x:g[0],y:g[1]},rAngle:(u["imageId:".concat(c)]||{}).angle,trackingIdentifierTextValue:vt,finding:a,findingSites:r||[]}}}])}();function It(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===kn&&a.toLowerCase()===this.toolType.toLowerCase()}(ct=St).toolType=ht,ct.utilityToolType=ht,ct.TID300Representation=pt,ct.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===kn&&a===ht},$n.registerTool(St);var yt=C.BF.TID300.Circle,Tt="CircleROI",Dt=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n,t,a,r){for(var i=$n.getSetupMeasurementData(n,t,r,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],g=0;g<d.length;g+=2){var m=a(l,[d[g],d[g+1]]);f.push(m)}var p=o;return p.annotation.data={handles:{points:[].concat(f),activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(l),{area:u?u.MeasuredValueSequence.NumericValue:0,radius:0,perimeter:0}),frameNumber:c},p}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,a=e.finding,r=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("CircleROI.getTID300RepresentationArguments: referencedImageId is not defined");var l=n(c,s.points[0]),d=n(c,s.points[1]),f=[];f.push({x:l[0],y:l[1]}),f.push({x:d[0],y:d[1]});var g=u["imageId:".concat(c)]||{},m=g.area,p=g.radius;return{area:m,perimeter:2*Math.PI*p,radius:p,points:f,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[]}}}])}();(mt=Dt).trackingIdentifierTextValue="".concat(kn,":").concat(Tt),mt.toolType=Tt,mt.utilityToolType=Tt,mt.TID300Representation=yt,mt.isValidCornerstoneTrackingIdentifier=It,$n.registerTool(Dt);var Rt,Ot,Ct=t(3823),xt=C.BF.TID300.Ellipse,bt="EllipticalROI",Mt=1e-4,Pt=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n,t,a,r){for(var i=$n.getSetupMeasurementData(n,t,r,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],g=0;g<d.length;g+=2){var m=a(l,[d[g],d[g+1]]);f.push(m)}var p=Ct.eR.fromValues.apply(Ct.eR,D(f[0])),v=Ct.eR.fromValues.apply(Ct.eR,D(f[1])),S=Ct.eR.fromValues.apply(Ct.eR,D(f[2])),I=Ct.eR.fromValues.apply(Ct.eR,D(f[3])),y=Ct.eR.create();Ct.eR.sub(y,v,p),Ct.eR.normalize(y,y);var T=Ct.eR.create();Ct.eR.sub(T,I,S),Ct.eR.normalize(T,T);var R=r.get("imagePlaneModule",l);if(!R)throw new Error("imageId does not have imagePlaneModule metadata");var O=R.columnCosines,C=Ct.eR.fromValues(O[0],O[1],O[2]),x=Ct.eR.dot(C,y),b=Ct.eR.dot(C,T),M=Math.abs(x),P=Math.abs(b),w=[];Math.abs(M-1)<Mt?w=[f[0],f[1],f[2],f[3]]:Math.abs(P-1)<Mt?w=[f[2],f[3],f[0],f[1]]:console.warn("OBLIQUE ELLIPSE NOT YET SUPPORTED");var E=o;return E.annotation.data={handles:{points:D(w),activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(l),{area:u?u.MeasuredValueSequence.NumericValue:0}),frameNumber:c},E}},{key:"getTID300RepresentationArguments",value:function(e,n){var t,a,r,i,o=e.data,u=e.finding,s=e.findingSites,c=e.metadata,l=o.cachedStats,d=void 0===l?{}:l,f=o.handles,g=o.initialRotation||0,m=c.referencedImageId;if(!m)throw new Error("EllipticalROI.getTID300RepresentationArguments: referencedImageId is not defined");90==g||270==g?(a=n(m,f.points[2]),t=n(m,f.points[3]),r=n(m,f.points[0]),i=n(m,f.points[1])):(t=n(m,f.points[0]),a=n(m,f.points[1]),r=n(m,f.points[2]),i=n(m,f.points[3]));var p=[];return Math.abs(t[1]-a[1])>Math.abs(r[0]-i[0])?(p.push({x:t[0],y:t[1]}),p.push({x:a[0],y:a[1]}),p.push({x:r[0],y:r[1]}),p.push({x:i[0],y:i[1]})):(p.push({x:r[0],y:r[1]}),p.push({x:i[0],y:i[1]}),p.push({x:t[0],y:t[1]}),p.push({x:a[0],y:a[1]})),{area:(d["imageId:".concat(m)]||{}).area,points:p,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:u,findingSites:s||[]}}}])}();(Rt=Pt).trackingIdentifierTextValue="".concat(kn,":").concat(bt),Rt.toolType=bt,Rt.utilityToolType=bt,Rt.TID300Representation=xt,Rt.isValidCornerstoneTrackingIdentifier=It,$n.registerTool(Pt);var wt=C.BF.TID300.Polyline,Et="RectangleROI",At="".concat(kn,":").concat(Et),Nt=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n,t,a,r){for(var i=$n.getSetupMeasurementData(n,t,r,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],g=0;g<d.length;g+=2){var m=a(l,[d[g],d[g+1]]);f.push(m)}var p=o;return p.annotation.data={handles:{points:[f[0],f[1],f[3],f[2]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(l),{area:u?u.MeasuredValueSequence.NumericValue:null}),frameNumber:c},p}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,a=e.finding,r=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("CobbAngle.getTID300RepresentationArguments: referencedImageId is not defined");var l=s.points.map(function(e){return n(c,e)}),d=u.area,f=u.perimeter;return{points:[l[0],l[1],l[3],l[2],l[0]],area:d,perimeter:f,trackingIdentifierTextValue:At,finding:a,findingSites:r||[]}}}])}();(Ot=Nt).toolType=Et,Ot.utilityToolType=Et,Ot.TID300Representation=wt,Ot.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===kn&&a===Et},$n.registerTool(Nt);var qt,Ut=C.BF.TID300.Length,Ft="Length",kt="".concat(kn,":").concat(Ft),Vt=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n,t,a,r){for(var i=$n.getSetupMeasurementData(n,t,r,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],g=0;g<d.length;g+=2){var m=a(l,[d[g],d[g+1]]);f.push(m)}var p=o;return p.annotation.data={handles:{points:[f[0],f[1]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(l),{length:u?u.MeasuredValueSequence.NumericValue:0}),frameNumber:c},p}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,a=e.finding,r=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("Length.getTID300RepresentationArguments: referencedImageId is not defined");var l=n(c,s.points[0]),d=n(c,s.points[1]);return{point1:{x:l[0],y:l[1]},point2:{x:d[0],y:d[1]},distance:(u["imageId:".concat(c)]||{}).length,trackingIdentifierTextValue:kt,finding:a,findingSites:r||[]}}}])}();Vt.toolType=Ft,Vt.utilityToolType=Ft,Vt.TID300Representation=Ut,Vt.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===kn&&a===Ft},$n.registerTool(Vt);var Bt=C.BF.TID300.Polyline,Gt="PlanarFreehandROI",_t="".concat(kn,":").concat(Gt),Lt=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n,t,a,r){for(var i=$n.getSetupMeasurementData(n,t,r,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],g=0;g<d.length;g+=2){var m=a(l,[d[g],d[g+1]]);f.push(m)}var p=!0;Ct.eR.distance(f[f.length-1],f[0])<1e-5&&(f.pop(),p=!1);var v=[];p&&v.push(f[0],f[f.length-1]);var S=o;return S.annotation.data={contour:{polyline:f,closed:!p},handles:{points:v,activeHandleIndex:null,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(l),{area:u?u.MeasuredValueSequence.NumericValue:null}),frameNumber:c},S}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,a=e.finding,r=e.findingSites,i=e.metadata,o=t.contour,u=o.polyline,s=!0!==o.closed,c=i.referencedImageId;if(!c)throw new Error("PlanarFreehandROI.getTID300RepresentationArguments: referencedImageId is not defined");var l=u.map(function(e){return n(c,e)});if(!s){var d=l[0];l.push([d[0],d[1]])}var f=t.cachedStats["imageId:".concat(c)]||{},g=f.area,m=f.areaUnit,p=f.modalityUnit;return{points:l,area:g,areaUnit:m,perimeter:f.perimeter,modalityUnit:p,mean:f.mean,max:f.max,stdDev:f.stdDev,trackingIdentifierTextValue:_t,finding:a,findingSites:r||[]}}}])}();(qt=Lt).toolType=Gt,qt.utilityToolType=Gt,qt.TID300Representation=Bt,qt.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===kn&&a===Gt},$n.registerTool(Lt);var jt,Yt=C.BF.TID300.Point,zt="Probe",Ht="".concat(kn,":").concat(zt),Xt=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n,t,a,r){for(var i=$n.getSetupMeasurementData(n,t,r,e.toolType),o=i.defaultState,u=i.SCOORDGroup,s=i.ReferencedFrameNumber,c=o.annotation.metadata.referencedImageId,l=u.GraphicData,d=[],f=0;f<l.length;f+=2){var g=a(c,[l[f],l[f+1]]);d.push(g)}var m=o;return m.annotation.data={handles:{points:d,activeHandleIndex:null,textBox:{hasMoved:!1}},frameNumber:s},m}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,a=e.metadata,r=e.finding,i=e.findingSites,o=a.referencedImageId;if(!o)throw new Error("Probe.getTID300RepresentationArguments: referencedImageId is not defined");return{points:t.handles.points.map(function(e){var t=n(o,e);return{x:t[0],y:t[1]}}),trackingIdentifierTextValue:Ht,findingSites:i||[],finding:r}}}])}();Xt.toolType=zt,Xt.utilityToolType=zt,Xt.TID300Representation=Yt,Xt.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===kn&&a===zt},$n.registerTool(Xt);var Wt=C.BF.TID300.Length,Qt="UltrasoundDirectionalTool",$t="".concat(kn,":").concat(Qt),Jt=function(){function e(){f(this,e)}return m(e,null,[{key:"getMeasurementData",value:function(n,t,a,r){for(var i=$n.getSetupMeasurementData(n,t,r,e.toolType),o=i.defaultState,u=i.SCOORDGroup,s=i.ReferencedFrameNumber,c=o.annotation.metadata.referencedImageId,l=u.GraphicData,d=[],f=0;f<l.length;f+=2){var g=a(c,[l[f],l[f+1]]);d.push(g)}var m=o;return m.annotation.data={handles:{points:[d[0],d[1]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:{},frameNumber:s},m}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,a=e.finding,r=e.findingSites,i=e.metadata,o=t.handles,u=i.referencedImageId;if(!u)throw new Error("UltrasoundDirectionalTool.getTID300RepresentationArguments: referencedImageId is not defined");var s=n(u,o.points[0]),c=n(u,o.points[1]);return{point1:{x:s[0],y:s[1]},point2:{x:c[0],y:c[1]},trackingIdentifierTextValue:$t,finding:a,findingSites:r||[]}}}])}();(jt=Jt).toolType=Qt,jt.utilityToolType=Qt,jt.TID300Representation=Wt,jt.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=T(e.split(":"),2),t=n[0],a=n[1];return t===kn&&a===Qt},$n.registerTool(Jt);var Kt=C.z8.Normalizer,Zt=C.h4.Segmentation;function ea(e,n,t){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=function(e,n,t){var a=e.map(function(e){var t=n.get("instance",e.imageId);return S(S(S({},e),t),{},{SOPClassUID:t.SopClassUID||t.SOPClassUID,SOPInstanceUID:t.SopInstanceUID||t.SOPInstanceUID,PixelData:e.voxelManager.getScalarData(),_vrMap:{PixelData:"OW"},_meta:{}})}),r=Kt.normalizeToDataset(a);if(!r)throw new Error("Failed to normalize the multiframe dataset, the data is not multi-frame.");return new Zt([r],t)}(e,t,a);return sn(r,n,a)}function na(e){for(var n=e.scalarData,t=e.dimensions,a=[],r=new Set,i=0;i<t[2];i++){for(var o=n.slice(i*t[0]*t[1],(i+1)*t[0]*t[1]),u=[],s=0;s<o.length;s++){var c=o[s];u.includes(c)||0===c||u.push(c)}var l={segmentsOnLabelmap:u,pixelData:o,rows:t[1],columns:t[0]};0!==u.length&&(u.forEach(function(e){r.add(e)}),a[t[2]-1-i]=l)}return e.segmentsOnLabelmap=Array.from(r),e.labelmaps2D=a,e}function ta(e,n,t){return On(e,n,t,arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001)}var aa=Fn.ParametricMap.generateToolState;function ra(e,n,t){return aa(e,n,t,arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001)}var ia=t(90665);function oa(e,n,t){var a=e.referencedImageId,r=e.FrameOfReferenceUID,i=n.get("instance",a).SeriesInstanceUID,o=t.ReferencedSeriesSequence;return[{FrameOfReferenceUID:r,RTReferencedStudySequence:[{ReferencedSOPClassUID:t.SOPClassUID,ReferencedSOPInstanceUID:t.SOPInstanceUID,RTReferencedSeriesSequence:[{SeriesInstanceUID:i,ContourImageSequence:D(o[0].ReferencedInstanceSequence)}]}]}]}function ua(e,n,t,a){var r=e.referencedImageId,i=t.get("instance",r),o=i.SeriesInstanceUID,u=i.StudyInstanceUID,s=[];if(o){var c=a.getSeries(u,o),l={SeriesInstanceUID:o,ReferencedInstanceSequence:[]};c.instances.forEach(function(e){var n=e.SOPInstanceUID,t=e.SOPClassUID;l.ReferencedInstanceSequence.push({ReferencedSOPClassUID:t,ReferencedSOPInstanceUID:n})}),s.push(l)}return s}function sa(e,n){var t=e.metadata.FrameOfReferenceUID;return{ROINumber:n+1,ROIName:e.name||"Todo: name ".concat(n+1),ROIDescription:"Todo: description ".concat(n+1),ROIGenerationAlgorithm:"Todo: algorithm",ReferencedFrameOfReferenceUID:t}}var ca=ia.utilities.contours,la=ca.generateContourSetsFromLabelmap,da=ca.AnnotationToPointData,fa=C.Ay.data.DicomMetaDictionary;function ga(e,n,t){var a=[];la({segmentations:e}).forEach(function(e,t){if(e){var r=[];e.sliceContours.forEach(function(e){var t=n.get("sopCommonModule",e.referencedImageId),a=[{ReferencedSOPClassUID:t.sopClassUID,ReferencedSOPInstanceUID:t.sopInstanceUID}],i=e.polyData;e.contours.forEach(function(e,n){var t=e.type,o=e.contourPoints.length,u=[];e.contourPoints.forEach(function(e){var n=i.points[e];n[0]=+n[0].toFixed(2),n[1]=+n[1].toFixed(2),n[2]=+n[2].toFixed(2),u.push(n[0]),u.push(n[1]),u.push(n[2])}),r.push({ContourImageSequence:a,ContourGeometricType:t,NumberOfContourPoints:o,ContourNumber:n+1,ContourData:u})})});var i=e.label||"Segment ".concat(t+1),o={name:i,description:i,contourSequence:r,color:e.color,metadata:e.metadata};a.push(o)}});var r=pa({name:e.label,label:e.label},a[0].metadata,n);a.forEach(function(e,a){var i={ROIDisplayColor:e.color||[255,0,0],ContourSequence:e.contourSequence,ReferencedROINumber:a+1};r.StructureSetROISequence.push(sa(e,a)),r.ROIContourSequence.push(i),r.ReferencedSeriesSequence=ua(e.metadata,0,n,t),r.ReferencedFrameOfReferenceSequence=oa(e.metadata,n,r)});var i=new Uint8Array(2);i[1]=1;var o={FileMetaInformationVersion:{Value:[i.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[fa.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}};return r._meta=o,r.SpecificCharacterSet="ISO_IR 192",r}function ma(e,n,t){var a=pa({name:"RTSS from Annotations",label:"RTSS from Annotations"},e[0].metadata,n);e.forEach(function(e,r){var i=da.convert(e,r,n);a.StructureSetROISequence.push(sa(e,r)),a.ROIContourSequence.push(i),a.RTROIObservationsSequence.push(function(e,n){return{ObservationNumber:n+1,ReferencedROINumber:n+1,RTROIInterpretedType:"Todo: type",ROIInterpreter:"Todo: interpreter"}}(0,r)),a.ReferencedSeriesSequence=ua(e.metadata,0,n,t),a.ReferencedFrameOfReferenceSequence=oa(e.metadata,n,a)});var r=new Uint8Array(2);r[1]=1;var i={FileMetaInformationVersion:{Value:[r.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[fa.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}};return a._meta=i,a.SpecificCharacterSet="ISO_IR 192",a}function pa(e,n,t){var a=fa.uid(),r=n.referencedImageId,i=n.FrameOfReferenceUID,o=t.get("generalSeriesModule",r).studyInstanceUID,u=function(e,n){var t=n.get("generalSeriesModule",e),a=n.get("generalStudyModule",e),r=n.get("patientStudyModule",e),i=n.get("patientModule",e),o=n.get("patientDemographicModule",e);return{Modality:t.modality,PatientID:i.patientId,PatientName:i.patientName,PatientBirthDate:"",PatientAge:r.patientAge,PatientSex:o.patientSex,PatientWeight:r.patientWeight,StudyDate:a.studyDate,StudyTime:a.studyTime,StudyID:"ToDo",AccessionNumber:a.accessionNumber}}(r,t),s=function(e){return{SeriesInstanceUID:e.uid(),SeriesNumber:"99"}}(fa);return S(S(S({StructureSetROISequence:[],ROIContourSequence:[],RTROIObservationsSequence:[],ReferencedSeriesSequence:[],ReferencedFrameOfReferenceSequence:[]},u),s),{},{StudyInstanceUID:o,SOPClassUID:"1.2.840.10008.5.1.4.1.1.481.3",SOPInstanceUID:a,Manufacturer:"dcmjs",Modality:"RTSTRUCT",FrameOfReferenceUID:i,PositionReferenceIndicator:"",StructureSetLabel:e.label||"",StructureSetName:e.name||"",ReferringPhysicianName:"",OperatorsName:"",StructureSetDate:fa.date(),StructureSetTime:fa.time(),_meta:null})}var ha=ia.utilities.contours.generateContourSetsFromLabelmap,va={Bidirectional:st,CobbAngle:St,Angle:gt,Length:Vt,CircleROI:Dt,EllipticalROI:Pt,RectangleROI:Nt,ArrowAnnotate:at,Probe:Xt,PlanarFreehandROI:Lt,UltrasoundDirectional:Jt,MeasurementReport:$n,CodeScheme:Vn,CORNERSTONE_3D_TAG:kn},Sa={Segmentation:r},Ia={ParametricMap:i},ya={RTSS:o},Ta=C.p.Colors,Da=C.p.BitArray;function Ra(e){var n=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;switch(n){case 1:return Math.abs(e);case 2:return Math.sqrt(e[0]*e[0]+e[1]*e[1]);case 3:return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);default:for(var t=0,a=0;a<n;a++)t+=e[a]*e[a];return Math.sqrt(t)}}(e);return 0!==n&&(e[0]/=n,e[1]/=n,e[2]/=n),n}var Oa=function(){return m(function e(){f(this,e)},null,[{key:"generateSegments",value:function(e){"Array"!==e.SegmentSequence.constructor.name&&(e.SegmentSequence=[e.SegmentSequence]),e.SegmentSequence.forEach(function(e){var n,t,a=(n=e.RecommendedDisplayCIELabValue,(t=Ta.dicomlab2RGB(n).map(function(e){return Math.round(255*e)})).push(255),t);segments[e.SegmentNumber]={color:a,functionalGroups:[],offset:null,size:null,pixelData:null}}),e.PerFrameFunctionalGroupsSequence.forEach(function(e){var n=e.SegmentIdentificationSequence.ReferencedSegmentNumber;segments[n].functionalGroups.push(e)});var n=Math.ceil(e.Rows*e.Columns/8),t=0;return Object.keys(segments).forEach(function(a){var r=segments[a];r.numberOfFrames=r.functionalGroups.length,r.size=r.numberOfFrames*n,r.offset=t,t=r.offset+r.size;var i=e.PixelData.slice(r.offset,t);r.pixelData=Da.unpack(i);var o=function(e,n){var t={},a=e.SharedFunctionalGroupsSequence.PixelMeasuresSequence,r=e.SharedFunctionalGroupsSequence.PlaneOrientationSequence,i=n[0],o=n[n.length-1],u=i.PlanePositionSequence.ImagePositionPatient.map(Number),s=o.PlanePositionSequence.ImagePositionPatient.map(Number);t.origin=u,t.spacing=[a.PixelSpacing[1],a.PixelSpacing[0],a.SpacingBetweenSlices].map(Number),t.dimensions=[e.Columns,e.Rows,n.length].map(Number);var c,l,d,f,g,m,p=r.ImageOrientationPatient.map(Number),h=p.slice(0,3),v=p.slice(3,6);return t.planeNormal=[],c=h,l=v,d=t.planeNormal,f=c[1]*l[2]-c[2]*l[1],g=c[2]*l[0]-c[0]*l[2],m=c[0]*l[1]-c[1]*l[0],d[0]=f,d[1]=g,d[2]=m,t.sliceStep=[],function(e,n,t){t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2]}(s,u,t.sliceStep),Ra(t.sliceStep),t.direction=h.concat(v).concat(t.sliceStep),t}(e,r.functionalGroups);r.geometry=o}),segments}}])}(),Ca={Cornerstone:qn,Cornerstone3D:va},xa={Cornerstone:Un,Cornerstone3D:Sa,VTKjs:{Segmentation:Oa}},ba={Cornerstone:Fn,Cornerstone3D:Ia},Ma={Cornerstone3D:ya}}}]);
//# sourceMappingURL=3970.bundle.0cf6597d44b855320807.js.map