"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[8558],{78558:(e,n,t)=>{t.r(n),t.d(n,{default:()=>C});const r=JSON.parse('{"UU":"@ohif/extension-cornerstone-dicom-rt"}').UU,s=`${r}.sopClassHandlerModule.dicom-rt`;var a=t(86326),o=t(80818),c=t(5842);const{DicomMessage:i,DicomMetaDictionary:u}=c.Ay.data,d=c.Ay.data.Colors.dicomlab2RGB;async function l(e,n,t){const r=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),s=e.getActiveDataSource()[0],{bulkDataURI:a}=s.getConfig?.()||{},{dicomLoaderService:o}=r.exports;n.isLoaded=!0;let c=n.instance;if(a&&a.enabled)await async function(e,n){if(!e||!e.ROIContourSequence)return Promise.reject("Invalid instance object or ROIContourSequence");const t=new Map;for(const r of e.ROIContourSequence){const s=r.ReferencedROINumber;if(r&&r.ContourSequence)for(const a of r.ContourSequence){if(!a||!a.ContourData)return Promise.reject("Invalid Contour or ContourData");const r=a.ContourData;if(Array.isArray(r))t.has(s)?t.get(s).push(Promise.resolve(r)):t.set(s,[Promise.resolve(r)]);else{if(!r||!r.BulkDataURI)return Promise.reject(`Invalid ContourData: ${r}`);{const a=r.BulkDataURI;if(!n||!n.retrieve||!n.retrieve.bulkDataURI)return Promise.reject("Invalid datasource object or retrieve function");const o=n.retrieve.bulkDataURI({BulkDataURI:a,StudyInstanceUID:e.StudyInstanceUID,SeriesInstanceUID:e.SeriesInstanceUID,SOPInstanceUID:e.SOPInstanceUID});t.has(s)?t.get(s).push(o):t.set(s,[o])}}}else t.set(s,[Promise.resolve([])])}const r=new Map;for(const[e,n]of t.entries())r.set(e,await Promise.allSettled(n));e.ROIContourSequence.forEach(e=>{try{const n=e.ReferencedROINumber,t=r.get(n);e.ContourSequence&&e.ContourSequence.forEach((e,n)=>{const r=t[n];if("fulfilled"===r.status)if(Array.isArray(r.value)&&r.value.every(Number.isFinite))e.ContourData=r.value;else{const n=new Uint8Array(r.value),t=(new TextDecoder).decode(n);"string"==typeof t&&t.includes("\\")?e.ContourData=t.split("\\").map(parseFloat):e.ContourData=[]}else console.error(r.reason)})}catch(e){console.error(e)}})}(c,s);else{const e=await o.findDicomDataPromise(n,null,t),r=i.readFile(e),s=u.naturalizeDataset(r.dict);s._meta=u.namifyDataset(r.meta),c=s}const{StructureSetROISequence:d,ROIContourSequence:l,RTROIObservationsSequence:f}=c,D={StructureSetLabel:c.StructureSetLabel,SeriesInstanceUID:c.SeriesInstanceUID,ROIContours:[],visible:!0,ReferencedSOPInstanceUIDsSet:new Set};for(let e=0;e<l.length;e++){const n=l[e],{ContourSequence:t}=n;if(!t)continue;const r=!1,s=S(t),a=[];for(let e=0;e<s.length;e++){const{ContourData:n,NumberOfContourPoints:t,ContourGeometricType:r,ContourImageSequence:o}=s[e];let c=!1;const i=[];for(let e=0;e<3*t;e+=3)i.push({x:n[e],y:n[e+1],z:n[e+2]});switch(r){case"CLOSED_PLANAR":case"OPEN_PLANAR":case"POINT":c=!0;break;default:continue}a.push({numberOfPoints:t,points:i,type:r,isSupported:c}),o?.ReferencedSOPInstanceUID&&D.ReferencedSOPInstanceUIDsSet.add(o?.ReferencedSOPInstanceUID)}I(D,d,f,n,a,r)}return D}function I(e,n,t,r,s,a){const o=n.find(e=>e.ROINumber===r.ReferencedROINumber),c={ROINumber:o.ROINumber,ROIName:o.ROIName,ROIGenerationAlgorithm:o.ROIGenerationAlgorithm,ROIDescription:o.ROIDescription,isSupported:a,contourPoints:s,visible:!0};!function(e,n){let{ROIDisplayColor:t,RecommendedDisplayCIELabValue:r}=e;!t&&r&&(t=d(r));t&&(n.colorArray=[...t])}(r,c),t&&function(e,n,t){const r=n.find(e=>e.ReferencedROINumber===t);if(r){const{ObservationNumber:n,ROIObservationDescription:t,RTROIInterpretedType:s,ROIInterpreter:a}=r;e.RTROIObservations={ObservationNumber:n,ROIObservationDescription:t,RTROIInterpretedType:s,ROIInterpreter:a}}}(c,t,r.ReferencedROINumber),e.ROIContours.push(c)}function S(e){return Array.isArray(e)?e:[e]}const f=["1.2.840.10008.5.1.4.1.1.481.3"],D={};function R(e,n,t){const r=e[0],{StudyInstanceUID:a,SeriesInstanceUID:c,SOPInstanceUID:i,SeriesDescription:u,SeriesNumber:d,SeriesDate:I,SOPClassUID:S,wadoRoot:R,wadoUri:p,wadoUriRoot:m}=r,y={Modality:"RTSTRUCT",loading:!1,isReconstructable:!1,displaySetInstanceUID:o.Wp.guid(),SeriesDescription:u,SeriesNumber:d,SeriesDate:I,SOPInstanceUID:i,SeriesInstanceUID:c,StudyInstanceUID:a,SOPClassHandlerId:s,SOPClassUID:S,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,structureSet:null,sopClassUids:f,instance:r,wadoRoot:R,wadoUriRoot:m,wadoUri:p,isOverlayDisplaySet:!0};let U=r.ReferencedSeriesSequence;if(r.ReferencedFrameOfReferenceSequence&&!r.ReferencedSeriesSequence&&(r.ReferencedSeriesSequence=function(e){const n=[];return e.forEach(e=>{const{RTReferencedStudySequence:t}=e;t.forEach(e=>{const{RTReferencedSeriesSequence:t}=e;t.forEach(e=>{const t=[],{ContourImageSequence:r,SeriesInstanceUID:s}=e;r.forEach(e=>{t.push({ReferencedSOPInstanceUID:e.ReferencedSOPInstanceUID,ReferencedSOPClassUID:e.ReferencedSOPClassUID})});const a={SeriesInstanceUID:s,ReferencedInstanceSequence:t};n.push(a)})})}),n}(r.ReferencedFrameOfReferenceSequence),U=r.ReferencedSeriesSequence),!U)throw new Error("ReferencedSeriesSequence is missing for the RTSTRUCT");const O=U[0];y.referencedImages=r.ReferencedSeriesSequence.ReferencedInstanceSequence,y.referencedSeriesInstanceUID=O.SeriesInstanceUID;const{displaySetService:g}=n.services,C=g.getDisplaySetsForSeries(y.referencedSeriesInstanceUID);if(C&&0!==C.length){const e=C[0];y.referencedDisplaySetInstanceUID=e.displaySetInstanceUID}else{const{unsubscribe:e}=g.subscribe(g.EVENTS.DISPLAY_SETS_ADDED,({displaySetsAdded:n})=>{const t=n[0];t.SeriesInstanceUID===y.referencedSeriesInstanceUID&&(y.referencedDisplaySetInstanceUID=t.displaySetInstanceUID,e())})}return y.load=({headers:e})=>function(e,n,t,r){const{SOPInstanceUID:s}=e,{segmentationService:a}=n.services;(e.loading||e.isLoaded)&&D[s],0;return e.loading=!0,D[s]=new Promise(async(n,s)=>{if(!e.structureSet){const n=await l(t,e,r);e.structureSet=n}a.createSegmentationForRTDisplaySet(e).then(()=>{e.loading=!1,n()}).catch(n=>{e.loading=!1,s(n)})}),D[s]}(y,n,t,e),[y]}const p=function({servicesManager:e,extensionManager:n}){return[{name:"dicom-rt",sopClassUids:f,getDisplaySetsFromSeries:t=>R(t,e,n)}]};var m=t(99737);const y=({commandsManager:e,servicesManager:n})=>{const t=n.services,{displaySetService:r,viewportGridService:s}=t,a={hydrateRTSDisplaySet:({displaySet:n,viewportId:t})=>{if("RTSTRUCT"!==n.Modality)throw new Error("Display set is not an RTSTRUCT");const a=r.getDisplaySetByUID(n.referencedDisplaySetInstanceUID);e.runCommand("updateStoredSegmentationPresentation",{displaySet:n,type:m.SegmentationRepresentations.Contour}),e.runCommand("updateStoredPositionPresentation",{viewportId:t,displaySetInstanceUID:a.displaySetInstanceUID}),s.setDisplaySetsForViewport({viewportId:t,displaySetInstanceUIDs:[a.displaySetInstanceUID]})}};return{actions:a,definitions:{hydrateRTSDisplaySet:{commandFn:a.hydrateRTSDisplaySet,storeContexts:[],options:{}}},defaultContext:"cornerstone-dicom-rt"}};function U(){return U=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)({}).hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},U.apply(null,arguments)}const O=a.lazy(()=>Promise.all([t.e(6003),t.e(4378),t.e(8946),t.e(285),t.e(4438)]).then(t.bind(t,23121))),g=e=>a.createElement(a.Suspense,{fallback:a.createElement("div",null,"Loading...")},a.createElement(O,e)),C={id:r,getCommandsModule:y,getViewportModule:({servicesManager:e,extensionManager:n,commandsManager:t})=>[{name:"dicom-rt",component:r=>a.createElement(g,U({servicesManager:e,extensionManager:n,commandsManager:t},r))}],getSopClassHandlerModule:p}}}]);
//# sourceMappingURL=8558.bundle.8cbd8c2f812bb2e8275b.js.map