"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[8206,4757],{80477:(e,t,n)=>{n.r(t),n.d(t,{default:()=>Be});const a=JSON.parse('{"u2":"@ohif/extension-cornerstone-dicom-seg"}').u2,o=`${a}.sopClassHandlerModule.dicom-seg`;var r=n(43001),i=n(84793),s=n(62709),l=n(93725),c=n(91202),m=n(67540);const d=["1.2.840.10008.5.1.4.1.1.66.4"],p={};function g(e,t,n){const a=e[0],{StudyInstanceUID:r,SeriesInstanceUID:g,SOPInstanceUID:u,SeriesDescription:E,SeriesNumber:S,SeriesDate:f,SOPClassUID:v,wadoRoot:x,wadoUri:h,wadoUriRoot:y}=a,I={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:i.utils.guid(),SeriesDescription:E,SeriesNumber:S,SeriesDate:f,SOPInstanceUID:u,SeriesInstanceUID:g,StudyInstanceUID:r,SOPClassHandlerId:o,SOPClassUID:v,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:d,instance:a,instances:[a],wadoRoot:x,wadoUriRoot:y,wadoUri:h,isOverlayDisplaySet:!0},w=a.ReferencedSeriesSequence;if(!w)return void console.error("ReferencedSeriesSequence is missing for the SEG");const b=w[0]||w;return I.referencedImages=a.ReferencedSeriesSequence.ReferencedInstanceSequence,I.referencedSeriesInstanceUID=b.SeriesInstanceUID,I.getReferenceDisplaySet=()=>{const{displaySetService:e}=t.services,n=e.getDisplaySetsForSeries(I.referencedSeriesInstanceUID);if(!n||0===n.length)throw new Error("Referenced DisplaySet is missing for the SEG");const a=n[0];I.referencedDisplaySetInstanceUID=a.displaySetInstanceUID,I.referencedVolumeURI=a.displaySetInstanceUID;const o=`cornerstoneStreamingImageVolume:${I.referencedVolumeURI}`;return I.referencedVolumeId=o,a},I.load=async({headers:e})=>await function(e,t,n,a){const{SOPInstanceUID:o}=e,{segmentationService:r}=t.services;if((e.loading||e.isLoaded)&&p[o]&&function(e,t){return t.getSegmentation(e.displaySetInstanceUID)}(e,r))return p[o];return e.loading=!0,p[o]=new Promise((async(o,i)=>{e.segments&&0!==Object.keys(e.segments).length||await async function({extensionManager:e,servicesManager:t,segDisplaySet:n,headers:a}){const o=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{segmentationService:r,uiNotificationService:i}=t.services,{dicomLoaderService:d}=o.exports,p=await d.findDicomDataPromise(n,null,a),g=s.cache.getVolume(n.referencedVolumeId);if(!g)throw new Error("Referenced Volume is missing for the SEG, and stack viewport SEG is not supported yet");const{imageIds:u}=g,E=.001,S=!0;s.eventTarget.addEventListener(c.Y.Events.SEGMENTATION_LOAD_PROGRESS,(e=>{const{percentComplete:t}=e.detail;r._broadcastEvent(r.EVENTS.SEGMENT_LOADING_COMPLETE,{percentComplete:t})}));const f=await c.adaptersSEG.Cornerstone3D.Segmentation.generateToolState(u,p,s.metaData,{skipOverlapping:S,tolerance:E,eventTarget:s.eventTarget,triggerEvent:s.triggerEvent});let v=!0;f.segMetadata.data.forEach(((e,t)=>{var n;t>0&&(e.rgba=e.RecommendedDisplayCIELabValue,e.rgba?e.rgba=(n=e.rgba,m.default.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)))):(v=!1,e.rgba=l.CONSTANTS.COLOR_LUT[t%l.CONSTANTS.COLOR_LUT.length]))})),f.overlappingSegments&&i.show({title:"Overlapping Segments",message:"Unsupported overlapping segments detected, segmentation rendering results may be incorrect.",type:"warning"});v||i.show({title:"DICOM SEG import",message:"RecommendedDisplayCIELabValue not found for one or more segments. The default color was used instead.",type:"warning",duration:5e3});Object.assign(n,f)}({extensionManager:n,servicesManager:t,segDisplaySet:e,headers:a});const d=!0;r.createSegmentationForSEGDisplaySet(e,null,d).then((()=>{e.loading=!1,o()})).catch((t=>{e.loading=!1,i(t)}))})),p[o]}(I,t,n,e),[I]}const u=function({servicesManager:e,extensionManager:t}){return[{name:"dicom-seg",sopClassUids:d,getDisplaySetsFromSeries:n=>g(n,e,t)}]},E={id:"@ohif/seg",name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId"}]}]}]};const S=function(){return[{name:E.id,protocol:E}]};var f=n(52490),v=n(47316),x=n(68968),h=n(3827),y=n.n(h);let I=function(e){return e.Expanded="expanded",e.Dropdown="dropdown",e}({});const w=function(e,t,n){const a="enter-segment-label",o=({action:t,value:o})=>{switch(t.id){case"save":n(o.label,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:a})};e&&e.create({id:a,centralize:!0,isDraggable:!1,showOverlay:!0,content:v.Vq,contentProps:{title:"Segment",value:{label:t},noCloseButton:!0,onClose:()=>e.dismiss({id:a}),actions:[{id:"cancel",text:"Cancel",type:v.LZ.dt.secondary},{id:"save",text:"Confirm",type:v.LZ.dt.primary}],onSubmit:o,body:({value:e,setValue:t})=>r.createElement(v.II,{label:"Enter the segment label",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,className:"border-primary-main bg-black",type:"text",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&o({value:e,action:{id:"save"}})}})}})};var b=n(22831);const N=function(e,t,n){const a="pick-color",o=({action:t,value:o})=>{switch(t.id){case"save":n(o.rgbaColor,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:a})};e&&e.create({id:a,centralize:!0,isDraggable:!1,showOverlay:!0,content:v.Vq,contentProps:{title:"Segment Color",value:{rgbaColor:t},noCloseButton:!0,onClose:()=>e.dismiss({id:a}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:o,body:({value:e,setValue:t})=>r.createElement(b.AI,{color:e.rgbaColor,onChange:e=>{t({rgbaColor:e.rgb})},presetColors:[],width:300})}})};var T=n(33901),C=n.n(T),D=n(58682),R=n(20779),V=n(24738);const M=({value1:e,value2:t,onChange:n,minValue:a,maxValue:o,step:i=1,unit:s="",containerClassName:l,inputClassName:c,labelClassName:m,labelVariant:d,showLabel:p=!0,labelPosition:g="",trackColor:u})=>{const[E,S]=(0,r.useState)(e),[f,x]=(0,r.useState)(t);(0,r.useEffect)((()=>{e<a||(S(e),t>o||x(t))}),[e,t]);const h=e=>{const t=Number(e.target.value);t<a||(S(t),n(t,f))},y=e=>{const t=Number(e.target.value);t>o||(x(t),n(E,t))},I=i>=1?E.toFixed(0):E.toFixed(1),w=i>=1?f.toFixed(0):f.toFixed(1);return r.createElement("div",{style:{flexDirection:"column"},className:`flex items-center cursor-pointer space-x-1 ${l||""}`},p&&"left"===g&&r.createElement(r.Fragment,null,r.createElement(V.Z,{variant:d??"subtitle",component:"p",className:C()("w-8",m??"text-white")},I,s),r.createElement(V.Z,{variant:d??"subtitle",component:"p",className:C()("w-8",m??"text-white")},w,s)),r.createElement("div",{style:{flexDirection:"row"},className:"flex pb-[5px]"},r.createElement("input",{type:"range",min:a,max:o,value:E,className:`appearance-none h-[3px] rounded-lg input-range-thumb-design ${c||""}`,style:{background:"#3a3f99"},onChange:h,id:"myRange1",step:i}),r.createElement("input",{type:"range",min:a,max:o,value:f,className:`appearance-none h-[3px] rounded-lg input-range-thumb-design ${c||""}`,style:{background:"#3a3f99"},onChange:y,id:"myRange2",step:i})),p&&(!g||"right"===g)&&r.createElement("div",{style:{flexDirection:"row",width:"100%"},className:"flex pb-[5px]"},r.createElement(V.Z,{variant:d??"subtitle",component:"p",className:C()("w-1/2",m??"text-white","flex","justify-center")},"Min : ",I,s),r.createElement(V.Z,{variant:d??"subtitle",component:"p",className:C()("w-1/2",m??"text-white","flex","justify-center")},"Max : ",w,s)),r.createElement("div",{className:"flex",style:{width:"100%"}},r.createElement("div",{className:"flex w-1/2 justify-center"},r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{h({target:{value:E-10}})}},"--"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{h({target:{value:E-1}})}},"-"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{h({target:{value:E+1}})}},"+"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{h({target:{value:E+10}})}},"++")),r.createElement("div",{className:"flex w-1/2 justify-center"},r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{y({target:{value:f-10}})}},"--"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{y({target:{value:f-1}})}},"-"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{y({target:{value:f+1}})}},"+"),r.createElement(v.zx,{size:"small",color:"black",onClick:()=>{y({target:{value:f+10}})}},"++"))))};var A=n(69190);const{Enums:O}=l,{MouseBindings:k,Events:L}=O,G=({label:e,activeMode:t,eraseReplaceFocus:n})=>{const a=e===n;return"All"===e&&t===P.REPLACE&&(e="Background"),r.createElement("div",{className:C()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",a&&"bg-primary-dark",a?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var F=function(e){return e.CIRCLE="CIRCLE",e.SPHERE="SPHERE",e}(F||{}),P=function(e){return e.FILL="FILL",e.THRESHOLD="THRESHOLD",e.ERASE="ERASE",e.REPLACE="REPLACE",e}(P||{});const U=[];function z({segmentationService:e,cornerstoneViewportService:t}){const{t:n}=(0,A.$G)("Buttons"),[a,o]=(0,r.useState)(!1),[i,c]=(0,r.useState)(!0),[m,d]=(0,r.useState)("All"),[p,g]=(0,r.useState)({active:!1,minimum:!0}),[{activeViewportId:u},E]=(0,v.O_)(),[S,f]=(0,r.useState)(P.FILL),[x,h]=(0,r.useState)(F.CIRCLE),[y,I]=(0,r.useState)(10),[w,b]=(0,r.useState)(100),[N,T]=(0,r.useState)(.4),[V,O]=(0,r.useState)([-1e3,3095]),[z,_]=(0,r.useState)(0),[B,W]=(0,r.useState)([]),j=t=>{let n=[{label:"All",segmentIndex:0},...e.getSegmentations().filter((e=>e.isActive))[0].segments.filter((e=>e))];n=n.map((e=>({...e,onClick:e=>((e,t)=>{const{label:n,segmentIndex:a}=e,o=t.configuration.strategySpecificConfiguration;o.REPLACE.targetSegmentIndex=a,t.setConfiguration({eraseFocusIndex:a,strategySpecificConfiguration:o}),d(n)})(e,t)}))),W(n)};(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(u),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId),a=n.getToolInstance("Brush");f(P.FILL),h(F.CIRCLE);const o=t.getViewportInfo(u).viewportData.data[0].volume,r=Math.min(...o.spacing),i=Math.floor(a.configuration.brushSize/r),s=Math.floor(Math.min(...o.dimensions)/2);T(r),I(i),b(s),O(a.configuration.strategySpecificConfiguration.THRESHOLD.threshold),_(a.configuration.strategySpecificConfiguration.REPLACE.targetSegmentIndex),j(a),n.setToolActive("Undo",{bindings:[{mouseButton:k.Primary}]})}),[]),(0,r.useEffect)((()=>{const n=t.getCornerstoneViewport(u),a=l.ToolGroupManager.getToolGroupForViewport(n.id,n.renderingEngineId).getToolInstance("Brush"),o=e.EVENTS.SEGMENTATION_ADDED,r=e.EVENTS.SEGMENTATION_UPDATED,i=e.EVENTS.SEGMENTATION_REMOVED,s=[];return[o,r,i].forEach((t=>{const{unsubscribe:n}=e.subscribe(t,(()=>{j(a)}));s.push(n)})),()=>{s.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(u);var n,a;l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("Brush").setConfiguration({brushSize:y*N,activeStrategy:(n=x,a=S,a+"_INSIDE_"+n),strategySpecificConfiguration:{THRESHOLD:{threshold:V},REPLACE:{targetSegmentIndex:z}}})}),[y,x,S,V]);return(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(u),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId),a=e.element;a.addEvent=(e,t)=>{U[e]&&(a.removeEventListener(e,U[e]),U[e]=null),U[e]=t,a.addEventListener(e,t)},a.removeEvent=e=>{a.removeEventListener(e,U[e]),U[e]=null},p.active?(n.setToolPassive("Brush"),n.setToolActive("DragProbe",{bindings:[{mouseButton:k.Primary}]}),a.addEvent(L.MOUSE_DRAG,(e=>{((e,n)=>{if(1===e.detail.mouseButton){const a=t.getCornerstoneViewport(u),o=e.detail.currentPoints.world,r=a.getImageData(),i=r.imageData.worldToIndex(o).map(Math.round),{scalarData:l,dimensions:c}=r;if(s.utilities.indexWithinDimensions(i,c)){const e=c[0],t=c[0]*c[1],a=l[i[2]*t+i[1]*e+i[0]];O(n?[a,V[1]]:[V[0],a])}}})(e,p.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("Brush",{bindings:[{mouseButton:k.Primary}]}),a.removeEvent(L.MOUSE_DRAG))}),[p.active,p.minimum]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>o(!a)},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!a})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Paint Brush Tool Edit")),!a&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Tool and mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:x===F.CIRCLE?"primary":"secondary",onClick:()=>{h(F.CIRCLE)}},"Circle"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:x===F.SPHERE?"primary":"secondary",onClick:()=>{h(F.SPHERE)}},"Sphere")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:S===P.FILL?"primary":"secondary",onClick:()=>{f(P.FILL)}},"Fill"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:S===P.THRESHOLD?"primary":"secondary",onClick:()=>{f(P.THRESHOLD)}},"Threshold"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:S===P.ERASE?"primary":"secondary",onClick:()=>{f(P.ERASE)}},"Erase"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:S===P.REPLACE?"primary":"secondary",onClick:()=>{f(P.REPLACE)}},"Replace")),r.createElement("div",{className:"flex items-center col-span-2"},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Radius"),r.createElement(R.Z,{minValue:0,maxValue:w,value:y,onChange:e=>{I(e)},step:1,containerClassName:"mt-[4px] mb-[4px]",inputClassName:"w-[64px]",labelClassName:"text-white text-[12px]",unit:"px"})),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),c(!i)}},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!i})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase/replace options")),!i&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase/replace focus on:"),r.createElement(v.QE,{items:B,renderer:e=>G({...e,activeMode:S,eraseReplaceFocus:m})})))),S===P.THRESHOLD&&r.createElement("div",{className:"flex items-center col-span-2",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"h-[1px] bg-[#212456] mb-[8px] mx-1",style:{width:"100%"}}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Threshold values"),r.createElement(M,{minValue:-1e3,maxValue:3095,value1:V[0],value2:V[1],onChange:(e,t)=>{O([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:"HU"}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{g({active:!0,minimum:!0})}},"Minimum"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{g({active:!0,minimum:!1})}},"Maximum")),p.active&&r.createElement(v.zx,{size:"small",color:"secondary",onClick:()=>{g({active:!1,minimum:!0})}},"Back to annotation"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const _=({label:e,t,eraseFocus:n})=>{const a=e===n;return r.createElement("div",{className:C()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",a&&"bg-primary-dark",a?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var B=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(B||{});function W({segmentationService:e,cornerstoneViewportService:t}){const{t:n}=(0,A.$G)("Buttons"),[a,o]=(0,r.useState)(!1),[i,s]=(0,r.useState)(B.FILL_INSIDE),[{activeViewportId:c},m]=(0,v.O_)(),[d,p]=(0,r.useState)([]),[g,u]=(0,r.useState)(!0),[E,S]=(0,r.useState)("All"),f=t=>{let n=[{label:"All",segmentIndex:0},...e.getSegmentations().filter((e=>e.isActive))[0].segments.filter((e=>e))];n=n.map((e=>({...e,onClick:e=>((e,t)=>{const{label:n,segmentIndex:a}=e;t.setConfiguration({eraseFocusIndex:a}),S(n)})(e,t)}))),p(n)};return(0,r.useEffect)((()=>{const n=t.getCornerstoneViewport(c),a=l.ToolGroupManager.getToolGroupForViewport(n.id,n.renderingEngineId).getToolInstance("CircleScissor"),o=e.EVENTS.SEGMENTATION_ADDED,r=e.EVENTS.SEGMENTATION_UPDATED,i=e.EVENTS.SEGMENTATION_REMOVED,s=[];return[o,r,i].forEach((t=>{e.subscribe(t,(()=>{f(a)}))})),()=>{s.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(c),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("CircleScissor");s(n.configuration.activeStrategy),f(n)}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(c);l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("CircleScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>o(!a)},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!a})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Circle Segmentation Tool Edit")),!a&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===B.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(B.FILL_INSIDE)}},"Fill"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===B.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(B.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),u(!g)}},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!g})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!g&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on:"),r.createElement(v.QE,{items:d,renderer:e=>_({...e,t:n,eraseFocus:E})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}function j({}){const[e,t]=(0,r.useState)(!1);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>t(!e)},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!e})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Fill Holes Tool Edit")),!e&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"No configurations for this tool")),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:H}=l,{MouseBindings:Z,Events:q}=H,$=[];function J({segmentationService:e,cornerstoneViewportService:t}){const[n,a]=(0,r.useState)(!1),[{activeViewportId:o},i]=(0,v.O_)(),[c,m]=(0,r.useState)([-1e3,3095]),[d,p]=(0,r.useState)(0),[g,u]=(0,r.useState)({active:!1,minimum:!0});(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(o),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("RectangleROIStartEndThreshold");p(n.configuration.numSlicesToPropagate)}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(o);l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("RectangleROIStartEndThreshold").setConfiguration({numSlicesToPropagate:d}),console.log("SET CONFIGURATION",d)}),[d]);(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(o),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId),a=e.element;a.addEvent=(e,t)=>{$[e]&&(a.removeEventListener(e,$[e]),$[e]=null),$[e]=t,a.addEventListener(e,t)},a.removeEvent=e=>{a.removeEventListener(e,$[e]),$[e]=null},g.active?(n.setToolPassive("RectangleROIStartEndThreshold"),n.setToolActive("DragProbe",{bindings:[{mouseButton:Z.Primary}]}),a.addEvent(q.MOUSE_DRAG,(e=>{((e,n)=>{if(1===e.detail.mouseButton){const a=t.getCornerstoneViewport(o),r=e.detail.currentPoints.world,i=a.getImageData(),l=i.imageData.worldToIndex(r).map(Math.round),{scalarData:d,dimensions:p}=i;if(s.utilities.indexWithinDimensions(l,p)){const e=p[0],t=p[0]*p[1],a=d[l[2]*t+l[1]*e+l[0]];m(n?[a,c[1]]:[c[0],a])}}})(e,g.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("RectangleROIStartEndThreshold",{bindings:[{mouseButton:Z.Primary}]}),a.removeEvent(q.MOUSE_DRAG))}),[g.active,g.minimum]);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!n)},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!n})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"3D Rectangle Threshold Segmentation Tool Edit")),!n&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"flex items-center col-span-2",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Threshold values"),r.createElement(M,{minValue:-1e3,maxValue:5e3,value1:c[0],value2:c[1],onChange:(e,t)=>{m([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:""}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{u({active:!0,minimum:!0})}},"Minimum"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{u({active:!0,minimum:!1})}},"Maximum")),g.active&&r.createElement(v.zx,{size:"small",color:"secondary",onClick:()=>{u({active:!1,minimum:!0})}},"Back to annotation")),r.createElement("div",{className:"flex items-center col-span-2",style:{width:"100%",flexDirection:"column"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Slices Propagation"),r.createElement(R.Z,{minValue:0,maxValue:200,value:d,onChange:e=>{p(e)},step:1,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:""})),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const n=t.getCornerstoneViewport(o).getActors().map((e=>{const t=e.referenceId??e.uid;return s.cache.getVolume(t)})).filter((e=>!!e)),a=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIStartEndThreshold");if(!a)throw new Error("No annotation selected ");const r=a[0];if(!l.annotation.state.getAnnotation(r))return;const i=n.filter((e=>e.imageIds.length))[0],m=n.filter((e=>!e.imageIds.length))[0],d=e.getSegmentations();l.utilities.segmentation.rectangleROIThresholdVolumeByRange(a,m,[{volume:i,lower:c[0],upper:c[1]}],{numSlicesToProject:0,overwrite:!1,overlapType:1,segmentIndex:d[0].activeSegmentIndex})})()}},"Compute Threshold")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const e=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIStartEndThreshold");if(!e)throw new Error("No annotation selected ");console.log("selected annotation uid",e);const n=e[0];console.log("CSTOOLS STATE",l.annotation.state),l.annotation.state.removeAnnotation(n),t.getCornerstoneViewport(o).render()})()}},"Delete selected region"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:Q}=l,{MouseBindings:K,Events:X}=Q,Y=[];function ee({segmentationService:e,cornerstoneViewportService:t}){const[n,a]=(0,r.useState)(!1),[{activeViewportId:o},i]=(0,v.O_)(),[c,m]=(0,r.useState)([-1e3,3095]),[d,p]=(0,r.useState)({active:!1,minimum:!0});(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(o),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId),a=e.element;a.addEvent=(e,t)=>{Y[e]&&(a.removeEventListener(e,Y[e]),Y[e]=null),Y[e]=t,a.addEventListener(e,t)},a.removeEvent=e=>{a.removeEventListener(e,Y[e]),Y[e]=null},d.active?(n.setToolPassive("RectangleROIThreshold"),n.setToolActive("DragProbe",{bindings:[{mouseButton:K.Primary}]}),a.addEvent(X.MOUSE_DRAG,(e=>{((e,n)=>{if(1===e.detail.mouseButton){const a=t.getCornerstoneViewport(o),r=e.detail.currentPoints.world,i=a.getImageData(),l=i.imageData.worldToIndex(r).map(Math.round),{scalarData:d,dimensions:p}=i;if(s.utilities.indexWithinDimensions(l,p)){const e=p[0],t=p[0]*p[1],a=d[l[2]*t+l[1]*e+l[0]];m(n?[a,c[1]]:[c[0],a])}}})(e,d.minimum)}))):(n.setToolPassive("DragProbe"),n.setToolActive("RectangleROIThreshold",{bindings:[{mouseButton:K.Primary}]}),a.removeEvent(X.MOUSE_DRAG))}),[d.active,d.minimum]);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>a(!n)},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!n})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Rectangle Threshold Segmentation Tool Edit")),!n&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"flex items-center col-span-2 pb-[9px]",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pb-[3px]",style:{width:"100%"}},"Threshold values"),r.createElement(M,{minValue:-1e3,maxValue:5e3,value1:c[0],value2:c[1],onChange:(e,t)=>{m([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full pb-[3px]",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:"HU"}),r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pt-[9px] mb-[3px]",style:{width:"100%"}},"Select threshold value with pipette for :"),r.createElement("div",{className:"flex flex-row justify-evenly w-full mb-[8px]"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{p({active:!0,minimum:!0})}},"Minimum"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{p({active:!0,minimum:!1})}},"Maximum")),d.active&&r.createElement(v.zx,{size:"small",color:"secondary",onClick:()=>{p({active:!1,minimum:!0})}},"Back to annotation")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const n=t.getCornerstoneViewport(o).getActors().map((e=>{const t=e.referenceId??e.uid;return s.cache.getVolume(t)})).filter((e=>!!e)),a=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIThreshold");if(!a)throw new Error("No annotation selected ");const r=a[0];if(!l.annotation.state.getAnnotation(r))return;const i=n.filter((e=>e.imageIds.length))[0],m=n.filter((e=>!e.imageIds.length))[0],d=e.getSegmentations();l.utilities.segmentation.rectangleROIThresholdVolumeByRange(a,m,[{volume:i,lower:c[0],upper:c[1]}],{numSlicesToProject:0,overwrite:!1,overlapType:1,segmentIndex:d[0].activeSegmentIndex})})()}},"Compute Threshold")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const e=l.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIThreshold");if(!e)throw new Error("No annotation selected ");console.log("selected annotation uid",e);const n=e[0];console.log("CSTOOLS STATE",l.annotation.state),l.annotation.state.removeAnnotation(n),t.getCornerstoneViewport(o).render()})()}},"Delete selected region"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const te=({label:e,t,eraseFocus:n})=>{const a=e===n;return r.createElement("div",{className:C()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",a&&"bg-primary-dark",a?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var ne=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(ne||{});function ae({segmentationService:e,cornerstoneViewportService:t}){const{t:n}=(0,A.$G)("Buttons"),[a,o]=(0,r.useState)(!1),[i,s]=(0,r.useState)(ne.FILL_INSIDE),[{activeViewportId:c},m]=(0,v.O_)(),[d,p]=(0,r.useState)([]),[g,u]=(0,r.useState)(!0),[E,S]=(0,r.useState)("All"),f=t=>{let n=[{label:"All",segmentIndex:0},...e.getSegmentations().filter((e=>e.isActive))[0].segments.filter((e=>e))];n=n.map((e=>({...e,onClick:e=>((e,t)=>{const{label:n,segmentIndex:a}=e;t.setConfiguration({eraseFocusIndex:a}),S(n)})(e,t)}))),p(n)};return(0,r.useEffect)((()=>{const n=t.getCornerstoneViewport(c),a=l.ToolGroupManager.getToolGroupForViewport(n.id,n.renderingEngineId).getToolInstance("RectangleScissor"),o=e.EVENTS.SEGMENTATION_ADDED,r=e.EVENTS.SEGMENTATION_UPDATED,i=e.EVENTS.SEGMENTATION_REMOVED,s=[];return[o,r,i].forEach((t=>{e.subscribe(t,(()=>{f(a)}))})),()=>{s.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(c),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("RectangleScissor");s(n.configuration.activeStrategy),f(n)}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(c);l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("RectangleScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>o(!a)},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!a})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Rectangle Scissors Tool Edit")),!a&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===ne.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(ne.FILL_INSIDE)}},"Fill"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===ne.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(ne.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),u(!g)}},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!g})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!g&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on:"),r.createElement(v.QE,{items:d,renderer:e=>te({...e,t:n,eraseFocus:E})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}const oe=({label:e,t,eraseFocus:n})=>{const a=e===n;return r.createElement("div",{className:C()("flex flex-row items-center p-3 h-8 w-full hover:bg-primary-dark","text-base whitespace-pre",a&&"bg-primary-dark",a?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},r.createElement("span",{className:"mr-5"},e))};var re=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(re||{});function ie({segmentationService:e,cornerstoneViewportService:t}){const{t:n}=(0,A.$G)("Buttons"),[a,o]=(0,r.useState)(!1),[i,s]=(0,r.useState)(re.FILL_INSIDE),[{activeViewportId:c},m]=(0,v.O_)(),[d,p]=(0,r.useState)([]),[g,u]=(0,r.useState)(!0),[E,S]=(0,r.useState)("All"),f=t=>{let n=[{label:"All",segmentIndex:0},...e.getSegmentations().filter((e=>e.isActive))[0].segments.filter((e=>e))];n=n.map((e=>({...e,onClick:e=>((e,t)=>{const{label:n,segmentIndex:a}=e;t.setConfiguration({eraseFocusIndex:a}),S(n)})(e,t)}))),p(n)};return(0,r.useEffect)((()=>{const n=t.getCornerstoneViewport(c),a=l.ToolGroupManager.getToolGroupForViewport(n.id,n.renderingEngineId).getToolInstance("SphereScissor"),o=e.EVENTS.SEGMENTATION_ADDED,r=e.EVENTS.SEGMENTATION_UPDATED,i=e.EVENTS.SEGMENTATION_REMOVED,s=[];return[o,r,i].forEach((t=>{e.subscribe(t,(()=>{f(a)}))})),()=>{s.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(c),n=l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("SphereScissor");s(n.configuration.activeStrategy),f(n)}),[]),(0,r.useEffect)((()=>{const e=t.getCornerstoneViewport(c);l.ToolGroupManager.getToolGroupForViewport(e.id,e.renderingEngineId).getToolInstance("SphereScissor").setConfiguration({activeStrategy:i})}),[i]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:()=>o(!a)},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!a})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Sphere Scissors Tool Edit")),!a&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===re.FILL_INSIDE?"primary":"secondary",onClick:()=>{s(re.FILL_INSIDE)}},"Fill"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:i===re.ERASE_INSIDE?"primary":"secondary",onClick:()=>{s(re.ERASE_INSIDE)}},"Erase")),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),u(!g)}},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!g})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Erase Options")),!g&&r.createElement("div",{className:"pl-2 pr-2",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[6px]"},"Erase focus on:"),r.createElement(v.QE,{items:d,renderer:e=>oe({...e,t:n,eraseFocus:E})}))))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:se}=l,{Events:le}=se;const ce=new class extends Array{constructor(e){super(),this.maxLength=void 0,this.maxLength=e}push(...e){const t=super.push(...e);if(this.length>this.maxLength){const e=this.length-this.maxLength;this.splice(0,e)}return t}}(10);function me({segmentationService:e,cornerstoneViewportService:t}){const{t:n}=(0,A.$G)("Buttons"),[a,o]=(0,r.useState)(!1),[{activeViewportId:i},s]=(0,v.O_)(),[l,c]=(0,r.useState)(ce.length);(0,r.useEffect)((()=>{t.getCornerstoneViewport(i).element.addEventListener(le.MOUSE_DOWN,(t=>{const n=e.getSegmentations()[0],a=new Uint8ClampedArray(e.getLabelmapVolume(n.id).getScalarData());10===ce.length&&ce.shift(),ce.push(a),c(ce.length)}))}),[]);const m=e=>{const n=t.getCornerstoneViewport(i).element,a=ce[e];if(!a)return;const o=new CustomEvent("UNDO_REDO_TOOL",{detail:{element:n,oldScalarData:a}});window.dispatchEvent(o),c(e)};return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),o(!a)}},r.createElement(D.Z,{name:"panel-group-open-close",className:C()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!a})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Undo/redo Segmentation")),!a&&r.createElement("div",{className:"pl-2 pr-2 pb-[9px] pt-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly inline-flex"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{l>0&&m(l-1)}},"Undo"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{l<10&&m(l+1)}},"Redo"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const{Enums:de}=l,{Events:pe}=de,{state:ge}=l,ue=["Brush","CircleScissor","PaintFill","RectangleROIStartEndThreshold","RectangleROIThreshold","RectangleScissor","SphereScissor"];function Ee({segmentationService:e,cornerstoneViewportService:t,toolbarService:n}){const[a,o]=(0,r.useState)(null),i=()=>{const e=ge.toolGroups.filter((e=>"mpr"===e.id))[0]?.toolOptions;e||o(null);const t=Object.entries(e).find((([e,t])=>ue.includes(e)&&"Active"===t.mode));o(t?t[0]:null)};(0,r.useEffect)((()=>{i()}),[]),(0,r.useEffect)((()=>{const{unsubscribe:e}=n.subscribe(n.EVENTS.TOOL_BAR_MODIFIED,i);return()=>{e()}}),[n]);return r.createElement(r.Fragment,null,a&&r.createElement(me,{cornerstoneViewportService:t,segmentationService:e}),(()=>{switch(a){case"Brush":return r.createElement(z,{cornerstoneViewportService:t,segmentationService:e});case"CircleScissor":return r.createElement(W,{cornerstoneViewportService:t,segmentationService:e});case"PaintFill":return r.createElement(j,null);case"RectangleROIStartEndThreshold":return r.createElement(J,{cornerstoneViewportService:t,segmentationService:e});case"RectangleROIThreshold":return r.createElement(ee,{cornerstoneViewportService:t,segmentationService:e});case"RectangleScissor":return r.createElement(ae,{cornerstoneViewportService:t,segmentationService:e});case"SphereScissor":return r.createElement(ie,{cornerstoneViewportService:t,segmentationService:e});default:return null}})())}var Se=n(74208);function fe({segmentations:e,segmentationService:t}){const[n,a]=(0,r.useState)(!1),[{activeViewportId:o,viewports:i},s]=(0,v.O_)();return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark pt-[6px] pb-[6px]"},r.createElement("p",{className:"text-[#d8d8d8] text-[12px] font-[300] pl-[9px] pr-[9px] pb-[6px] flex"},"Configuration"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly flex"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{console.log("SEGS AT IMPORT",e);const n=document.createElement("input");n.type="file",n.accept="application/json",n.onchange=a=>{const r=Array.from(n.files)[0],s=new FileReader;s.onload=function(n){try{if("string"==typeof n.target.result){for(let n=1;n<e[0].segments.length;n++)t.removeSegment(e[0].id,n);const a=JSON.parse(n.target.result);for(const n of a)if(n){const{segmentIndex:a}=n;t.addSegment(e[0].id,{segmentIndex:a,toolGroupId:i.get(o).viewportOptions.toolGroupId,properties:n,override:!0})}}else console.error("ERROR::JSON_READING::CORRUPTED_CONTENT")}catch(e){console.error("ERROR::JSON_READING",e)}},s.readAsText(r)},n.click()}},"Import"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{const t=JSON.stringify(e[0].segments),n=new Blob([t],{type:"text/plain;charset=utf-8"});(0,Se.saveAs)(n,"segments_configuration.json")}},"Export"))),r.createElement("div",{className:"h-[6px] bg-black "}))}fe.propTypes={segmentations:y().array.isRequired};const ve=fe;n(17816),n(17854);function xe({segmentations:e,segmentationService:t,cornerstoneViewportService:n,panoramicService:a}){const[o,i]=(0,r.useState)(!1),[c,m]=(0,r.useState)(0),[d,p]=(0,r.useState)(!1),[{activeViewportId:g,viewports:u},E]=(0,v.O_)();(0,r.useEffect)((()=>{}),[o]);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark pt-[6px] pb-[6px]"},r.createElement("p",{className:"text-[#d8d8d8] text-[12px] font-[300] pl-[9px] pr-[9px] pb-[6px] flex"},"Segmentation"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly flex"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:async()=>{console.log("SEGS AT IMPORT",e);let a=u.get(g);"volume"!==a.viewportOptions.viewportType&&(a=Array.from(u.values()).find((e=>"volume"===e.viewportOptions.viewportType)),console.assert(a,'ImportSegmentation: Could not find "volume" viewport'),E.setActiveViewportId(a.viewportId));const o=n.getCornerstoneViewport(a.viewportId).getActors();console.assert(o&&o.length,"ImportSegmentation: No actors on volume viewport");const r=o.map((e=>s.cache.getVolume(e.referenceId??e.uid))).filter((e=>!e.imageIds.length))[0];if(!r){const n={label:`Segmentation ${e.length+1}`},o=await t.createSegmentationForDisplaySet(a.displaySetInstanceUIDs[0],n),r=t.getSegmentation(o);console.log("CREATED SEGMENTATION",r);const i=l.Enums.SegmentationRepresentations.Labelmap;await t.addSegmentationRepresentationToToolGroup("mpr",o,!0,i),t.setActiveSegmentationForToolGroup(o,"mpr")}const i=r.volumeId,c=r.getScalarData(),m=document.createElement("input");m.type="file",m.accept="application/octet-stream",m.onchange=async e=>{const t=Array.from(m.files)[0],n=new FileReader;n.onload=async function(e){const t=new Uint8Array(e.target.result);for(let e=0;e<c.length;e++)c[e]=t[e];l.segmentation.triggerSegmentationEvents.triggerSegmentationDataModified(i)},n.readAsArrayBuffer(t)},m.click()}},"Import"),r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{i(!0)}},"Export"))),r.createElement("div",{className:"h-[6px] bg-black "}),r.createElement("div",{className:"bg-primary-dark pt-[6px] pb-[6px]"},r.createElement("p",{className:"text-[#d8d8d8] text-[12px] font-[300] pl-[9px] pr-[9px] pb-[6px] flex"},"Dentascan segmentation"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly flex"},r.createElement(v.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(async()=>{const o=t.getLabelmapVolume(e[0].id),{scalarData:r}=o,i=n.getViewportInfo("default").getViewportData().data[0],c=i.displaySetInstanceUID,[m,d,p]=i.volume.dimensions,E=(u.get(g).viewportOptions.toolGroupId,a.getPanoramicState(c)),S={label:`Converted segmentation ${e.length+1}`},f=await t.createSegmentationForDisplaySet(c,S),v=l.Enums.SegmentationRepresentations.Labelmap;await t.addSegmentationRepresentationToToolGroup("mpr",f,!0,v),t.setActiveSegmentationForToolGroup(f,"mpr");for(const n of e[0].segments)if(n){const{segmentIndex:e}=n;t.addSegment(f,{segmentIndex:e,toolGroupId:"mpr",properties:n,override:!0})}const x=t.getSegmentation(f).representationData.LABELMAP.volumeId,h=s.cache.getVolume(x).getScalarData();E.dentascans.forEach(((e,t)=>{const[n,a]=e.interval,[o,i]=e.director;for(let a=0;a<e.height;a++)for(let s=0;s<e.width;s++){const l=Math.round(n[0]+s*o),c=Math.round(n[1]+s*i),p=(e.height+e.minLayer-a)*m*d+c*m+l,g=t*e.width*e.height+a*e.width+s;h[p]=r[g]}}));for(let e=0;e<h.length;e++)h[e]=h[e];l.segmentation.triggerSegmentationEvents.triggerSegmentationDataModified(x)})()}},"Convert dentascan"))),r.createElement("div",{className:"h-[6px] bg-black "}))}xe.propTypes={segmentations:y().array.isRequired};const he=xe,ye=l.Enums.SegmentationRepresentations.Labelmap,Ie={[I.Expanded]:v.s_,[I.Dropdown]:v.cX},we=(e=>{let t=e%2147483647;return()=>(t=16807*t%2147483647,t/2147483647)})(42);function be({servicesManager:e,commandsManager:t,extensionManager:n,configuration:a}){const[{activeViewportId:o,viewports:i}]=(0,v.O_)(),{segmentationService:s,viewportGridService:l,uiDialogService:c,displaySetService:m,cornerstoneViewportService:d,hangingProtocolService:p,toolGroupService:g,toolbarService:u,uiNotificationService:E,panoramicService:S}=e.services,{t:f}=(0,A.$G)("PanelSegmentation"),[h,y]=(0,r.useState)(null),[I,b]=(0,r.useState)(""),[T,C]=(0,r.useState)(s.getConfiguration()),D=()=>"panoramicViewport"===p.getActiveProtocol().protocol.id,R=()=>{const e=m.getActiveDisplaySets(),t=D()?e.find((e=>e.SeriesInstanceUID.includes("dentascan"))):e.find((e=>"CT"===e.Modality));return t?.displaySetInstanceUID},V=()=>{const e=R();return s.getSegmentations().filter((t=>t.displaySetInstanceUID===e))},[M,O]=(0,r.useState)((()=>V())),[k,L]=(0,r.useState)({});(0,r.useCallback)((e=>{L((t=>({...t,[e]:!t[e]})))}),[L]);(0,r.useEffect)((()=>{const e=M[M.length-1]?.id;e&&L((t=>({...t,[e]:!1})))}),[M,L]),(0,r.useEffect)((()=>{const e=s.EVENTS.SEGMENTATION_ADDED,t=s.EVENTS.SEGMENTATION_UPDATED,n=s.EVENTS.SEGMENTATION_REMOVED,a=[];return[e,t,n].forEach((e=>{const{unsubscribe:t}=s.subscribe(e,(()=>{const e=V();O(e),C(s.getConfiguration())}));a.push(t)})),()=>{a.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{const e=e=>{const t=l.getDisplaySetsUIDsForViewport(e||l.getActiveViewportId());if(!t)return;const n=t?.some((e=>{const t=m.getDisplaySetByUID(e);return t?.isReconstructable}))||!1;b(n?"":"ohif-disabled")};e();const t=l.EVENTS.ACTIVE_VIEWPORT_ID_CHANGED,n=l.EVENTS.VIEWPORTS_READY,a=[];[n,t].forEach((t=>{const{unsubscribe:n}=l.subscribe(t,(({viewportId:t})=>{e(t)}));a.push(n)}));const o=d.EVENTS.VIEWPORT_DATA_CHANGED,r=[];return[o].forEach((t=>{const{unsubscribe:n}=d.subscribe(t,(()=>{e()}));r.push(n)})),()=>{a.forEach((e=>e())),r.forEach((e=>e()))}}),[]);const G=e=>s.getToolGroupIdsWithSegmentation(e),F=(0,r.useCallback)(((e,t,n)=>{s.setConfiguration({segmentationId:e,[t]:n})}),[s]),P=Ie[a?.segmentationPanelMode]||v.cX,U=a?.addSegment,z=a?.onSegmentationAdd&&"function"==typeof a?.onSegmentationAdd?a?.onSegmentationAdd:async()=>{t.runCommand("createEmptySegmentationForViewport",{viewportId:l.getActiveViewportId()})};return r.createElement(r.Fragment,null,(()=>{const e=R(),t=i.get(o)?.displaySetInstanceUIDs[0];return e===t})()&&r.createElement("div",{className:"flex flex-col flex-auto min-h-0F mt-1"},r.createElement(Ee,{segmentationService:s,cornerstoneViewportService:d,toolbarService:u}),r.createElement(P,{title:f("Segmentations"),segmentations:M,disableEditing:a.disableEditing,activeSegmentationId:h||"",onSegmentationAdd:z,addSegmentationClassName:I,showAddSegment:U,onSegmentationClick:e=>{s.setActiveSegmentationForToolGroup(e,i.get(o).viewportOptions.toolGroupId)},onSegmentationDelete:e=>{s.remove(e)},onSegmentationDownload:e=>{t.runCommand("downloadSegmentation",{segmentationId:e})},onSegmentationDownloadRTSS:e=>{t.runCommand("downloadRTSS",{segmentationId:e})},storeSegmentation:async a=>{const o=n.getActiveDataSource(),r=await(0,x.createReportAsync)({servicesManager:e,getReport:()=>t.runCommand("storeSegmentation",{segmentationId:a,dataSource:o[0]}),reportType:"Segmentation"});r&&(s.remove(a),l.setDisplaySetsForViewport({viewportId:l.getActiveViewportId(),displaySetInstanceUIDs:r}))},onSegmentationEdit:e=>{const t=s.getSegmentation(e),{label:n}=t;w(c,n,((t,n)=>{""!==t&&s.addOrUpdateSegmentation({id:e,label:t},!1,!0)}))},onSegmentClick:(e,t)=>{s.setActiveSegment(e,t);G(e).forEach((n=>{s.setActiveSegmentationForToolGroup(e,n),s.jumpToSegmentCenter(e,t,n)}))},onSegmentEdit:(e,t)=>{const n=s.getSegmentation(e).segments[t],{label:a}=n;w(c,a,((n,a)=>{""!==n&&s.setSegmentLabel(e,t,n)}))},onSegmentAdd:e=>{const t=s.getSegmentation(e);s.addSegment(e,{segmentIndex:t.segments.length,toolGroupId:i.get(o).viewportOptions.toolGroupId,properties:{label:`Segment ${t.segmentCount+1}`,color:[Math.floor(256*we()),Math.floor(256*we()),Math.floor(256*we())],opacity:255,visibility:!0,isLocked:!1,active:!0}})},onSegmentColorClick:(e,t)=>{const n=s.getSegmentation(e).segments[t],{color:a,opacity:o}=n,r={r:a[0],g:a[1],b:a[2],a:o/255};N(c,r,((n,a)=>{"cancel"!==a&&s.setSegmentRGBAColor(e,t,[n.r,n.g,n.b,255*n.a])}))},onSegmentDelete:(e,t)=>{s.removeSegment(e,t)},onToggleSegmentVisibility:(e,t)=>{const n=!s.getSegmentation(e).segments[t].isVisible;G(e).forEach((a=>{s.setSegmentVisibility(e,t,n,a)}))},onToggleSegmentLock:(e,t)=>{s.toggleSegmentLocked(e,t)},onToggleSegmentationVisibility:e=>{s.toggleSegmentationVisibility(e);const t=s.getSegmentation(e),n=t.isVisible,a=t.segments;G(e).forEach((t=>{a.forEach(((a,o)=>{s.setSegmentVisibility(e,o,n,t)}))}))},showDeleteSegment:!0,segmentationConfig:{initialConfig:T},setRenderOutline:e=>F(h,"renderOutline",e),setOutlineOpacityActive:e=>F(h,"outlineOpacity",e),setRenderFill:e=>F(h,"renderFill",e),setRenderInactiveSegmentations:e=>F(h,"renderInactiveSegmentations",e),setOutlineWidthActive:e=>F(h,"outlineWidthActive",e),setFillAlpha:e=>F(h,"fillAlpha",e),setFillAlphaInactive:e=>F(h,"fillAlphaInactive",e)}),r.createElement("div",{className:"h-[6px] bg-black "}),r.createElement(v.zx,{className:"pt-1/10 pb-1/10",onClick:async()=>{const e=R(),t="mpr",n={label:`${D()?"Pathology":"Anatomy"} segmentation ${M.length+1}`},a=await s.createSegmentationForDisplaySet(e,n),o=s.getSegmentation(a);console.log("CREATED SEGMENTATION",o),await s.addSegmentationRepresentationToToolGroup(t,a,!0,ye),s.setActiveSegmentationForToolGroup(a,t),s.addSegment(a,{segmentIndex:1,toolGroupId:t,properties:{label:"Segment 1",color:[255,0,0],opacity:255,visibility:!0,isLocked:!1,active:!0}}),console.log("MTOOLS",u.getButtonSection("MeasurementTools",{})),u.createButtonSection("primary",["MeasurementTools","Zoom","Pan","TrackballRotate","WindowLevel","Capture","Layout","MPR","Panoramic","Crosshairs","MoreTools","SegmentationTools"])},style:{marginTop:"10%"}},`Create ${D()?"pathology":"anatomy"} segmentation`),r.createElement("div",{className:"h-[6px] bg-black "}),r.createElement(ve,{segmentations:M,segmentationService:s}),r.createElement(he,{segmentations:M,segmentationService:s,cornerstoneViewportService:d,panoramicService:S})))}be.propTypes={commandsManager:y().shape({runCommand:y().func.isRequired}),servicesManager:y().shape({services:y().shape({segmentationService:y().shape({getSegmentation:y().func.isRequired,getSegmentations:y().func.isRequired,toggleSegmentationVisibility:y().func.isRequired,subscribe:y().func.isRequired,EVENTS:y().object.isRequired}).isRequired}).isRequired}).isRequired};const Ne=({commandsManager:e,servicesManager:t,extensionManager:n,configuration:a,title:o})=>{const{customizationService:i}=t.services;return[{name:"panelSegmentation",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:a=>{const[o]=(0,f.M)();return r.createElement(be,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...a,disableEditing:o.disableEditing,...i.get("segmentation.panel")}})}},{name:"panelSegmentationWithTools",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:a=>{const[o]=(0,f.M)();return r.createElement(r.Fragment,null,r.createElement(v.vb,{commandsManager:e,servicesManager:t,extensionManager:n,buttonSectionId:"segmentationToolbox",title:"Segmentation Tools",configuration:{...a}}),r.createElement(be,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...a,disableEditing:o.disableEditing,...i.get("segmentation.panel")}}))}}]};var Te=n(60318),Ce=n(54131),De=n(8455);async function Re({viewportId:e,loadFn:t,servicesManager:n,displaySet:a,initialSliceIndex:o=null}){const{cornerstoneViewportService:r,segmentationService:i,viewportGridService:l}=n.services,c=Ve({viewportId:e,viewportGridService:l}),m=c.viewportOptions.viewportId,d=a?.referencedDisplaySetInstanceUID||c?.displaySetInstanceUIDs[0],p=Me({viewportId:e,servicesManager:n,displaySet:a}),g=async()=>{const e=await t();i.hydrateSegmentation(e)},u=Array.from(s.cache._volumeCache.keys()).some((e=>e.includes(d)));return p.forEach((async e=>{e.viewportOptions={...e.viewportOptions,viewportType:"RTSTRUCT"===a?.Modality?"stack":"volume",needsRerendering:!0};const t=e.viewportId;t===m&&(e.viewportOptions.initialImageOptions={index:o,useOnce:!0});const n=r.getCornerstoneViewport(t),i=n.getCamera();if((u||"RTSTRUCT"===a.Modality)&&t===m)return void await g();const l=async e=>{const n=e.detail.volumeActors?.find((e=>e.uid.includes(d))),a=r.getCornerstoneViewport(t);a.setCamera(i),a.element.removeEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,l),n&&t===m&&await g()};n.element.addEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,l)})),l.setDisplaySetsForViewports(p),!0}const Ve=({viewportId:e,viewportGridService:t})=>{const{viewports:n,activeViewportId:a}=t.getState(),o=e||a;return n.get(o)};function Me({viewportId:e,servicesManager:t,displaySet:n}){const{hangingProtocolService:a,displaySetService:o,segmentationService:r,viewportGridService:i}=t.services,{viewports:s,isHangingProtocolLayout:l}=i.getState(),c=Ve({viewportId:e,viewportGridService:i}).viewportOptions.viewportId,m=s.get(c).displaySetInstanceUIDs,d=n?.referencedDisplaySetInstanceUID||m[0],p=o.getDisplaySetByUID(d).instances[0].FrameOfReferenceUID,g=a.getViewportsRequireUpdate(c,d,l);return s.forEach(((e,t)=>{if(c===t||g.find((e=>e.viewportId===t)))return;r.shouldRenderSegmentation(e.displaySetInstanceUIDs,p)&&g.push({viewportId:t,displaySetInstanceUIDs:e.displaySetInstanceUIDs,viewportOptions:{viewportType:"RTSTRUCT"===n?.Modality?"stack":"volume",needsRerendering:!0}})})),g.filter((e=>"volume3d"!==e.viewportOptions?.viewportType))}const{segmentation:Ae}=l.utilities,{datasetToBlob:Oe}=m.default.data,{Cornerstone3D:{Segmentation:{generateLabelMaps2DFrom3D:ke,generateSegmentation:Le}}}=c.adaptersSEG,{Cornerstone3D:{RTSS:{generateRTSSFromSegmentations:Ge}}}=c.adaptersRT,{downloadDICOMData:Fe}=c.helpers,Pe=({servicesManager:e,extensionManager:t})=>{const{uiNotificationService:n,segmentationService:a,uiDialogService:o,displaySetService:r,viewportGridService:c,toolGroupService:d,cornerstoneViewportService:p}=e.services,g={getUpdatedViewportsForSegmentation:Me,createEmptySegmentationForViewport:async({viewportId:t})=>{const o=Ve({viewportId:t,viewportGridService:c}),i=o.displaySetInstanceUIDs[0],s=r.getDisplaySetByUID(i);s.isReconstructable?Re({viewportId:t,servicesManager:e,displaySet:s,loadFn:async()=>{const e=a.getSegmentations(),t=await a.createSegmentationForDisplaySet(i,{label:`Segmentation ${e.length+1}`}),n=o.viewportOptions.toolGroupId;return await a.addSegmentationRepresentationToToolGroup(n,t),a.addSegment(t,{toolGroupId:n,segmentIndex:1,properties:{label:"Segment 1"}}),t}}):n.show({title:"Segmentation",message:"Segmentation is not supported for non-reconstructible displaysets yet",type:"error"})},loadSegmentationsForViewport:async({segmentations:t,viewportId:n})=>{Re({viewportId:n,servicesManager:e,loadFn:async()=>{const e=Ve({viewportId:n,viewportGridService:c}),o=e.displaySetInstanceUIDs[0],r=t[0],i=r.id,s=r.label,l=r.segments;if(delete r.segments,await a.createSegmentationForDisplaySet(o,{segmentationId:i,label:s}),r.scalarData){a.getLabelmapVolume(i).scalarData.set(r.scalarData)}a.addOrUpdateSegmentation(r);const m=e.viewportOptions.toolGroupId;return await a.addSegmentationRepresentationToToolGroup(m,i),l.forEach((e=>{null!==e&&a.addSegment(i,{segmentIndex:e.segmentIndex,toolGroupId:m,properties:{color:e.color,label:e.label,opacity:e.opacity,isLocked:e.isLocked,visibility:e.isVisible,active:r.activeSegmentIndex===e.segmentIndex}})})),r.centroidsIJK&&a.setCentroids(r.id,r.centroidsIJK),i}})},loadSegmentationDisplaySetsForViewport:async({viewportId:t,displaySets:n})=>{const o=n[0],i=r.getDisplaySetByUID(o.referencedDisplaySetInstanceUID),s=p.getCornerstoneViewport(t).getSliceIndex();Re({viewportId:t,servicesManager:e,displaySet:o,loadFn:async()=>{const e=o,t="SEG"===e.Modality?"createSegmentationForSEGDisplaySet":"createSegmentationForRTDisplaySet",n=a[t].bind(a),r=await n(e,null,!1);return a.getSegmentation(r).description=`S${i.SeriesNumber}: ${i.SeriesDescription}`,r},initialSliceIndex:s})},generateSegmentation:({segmentationId:e,options:t={}})=>{const n=l.segmentation.state.getSegmentation(e),{referencedVolumeId:o}=n.representationData.LABELMAP,r=s.cache.getVolume(e),i=s.cache.getVolume(o).getCornerstoneImages(),c=ke(r);c.metadata=[];a.getSegmentation(e).segments.forEach((e=>{if(!e)return;const t=e.segmentIndex,{label:n,color:a}=e,o=m.default.data.Colors.rgb2DICOMLAB(a.slice(0,3).map((e=>e/255))).map((e=>Math.round(e))),r={SegmentNumber:t.toString(),SegmentLabel:n,SegmentAlgorithmType:e?.algorithmType||"MANUAL",SegmentAlgorithmName:e?.algorithmName||"OHIF Brush",RecommendedDisplayCIELabValue:o,SegmentedPropertyCategoryCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"},SegmentedPropertyTypeCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"}};c.metadata[t]=r}));return Le(i,c,s.metaData,t)},downloadSegmentation:({segmentationId:e})=>{const t=a.getSegmentation(e),n=g.generateSegmentation({segmentationId:e});Fe(n.dataset,`${t.label}`)},storeSegmentation:async({segmentationId:e,dataSource:n})=>{const r=await(0,x.createReportDialogPrompt)(o,{extensionManager:t});if(1!==r.action&&r.value)return;const s=a.getSegmentation(e);if(!s)throw new Error("No segmentation found");const{label:l}=s,c=r.value||l||"Research Derived Series",m=g.generateSegmentation({segmentationId:e,options:{SeriesDescription:c}});if(!m||!m.dataset)throw new Error("Error during segmentation generation");const{dataset:d}=m;return await n.store.dicom(d),d.wadoRoot=n.getConfig().wadoRoot,i.DicomMetadataStore.addInstances([d],!0),d},downloadRTSS:({segmentationId:e})=>{const t=a.getSegmentation(e),n={vtkImageMarchingSquares:Te.ZP,vtkDataArray:Ce.default,vtkImageData:De.ZP},o=Ge(t,i.classes.MetadataProvider,i.DicomMetadataStore,s.cache,l.Enums,n);try{const e=Oe(o),t=URL.createObjectURL(e);window.location.assign(t)}catch(e){console.warn(e)}},setBrushSize:({value:e,toolNames:t})=>{const n=Number(e);d.getToolGroupIds()?.forEach((e=>{0===t?.length?Ae.setBrushSizeForToolGroup(e,n):t?.forEach((t=>{Ae.setBrushSizeForToolGroup(e,n,t)}))}))},setThresholdRange:({value:e,toolNames:t=["ThresholdCircularBrush","ThresholdSphereBrush"]})=>{d.getToolGroupIds()?.forEach((n=>{const a=d.getToolGroup(n);t?.forEach((t=>{a.setToolConfiguration(t,{strategySpecificConfiguration:{THRESHOLD:{threshold:e}}})}))}))}},u={getUpdatedViewportsForSegmentation:{commandFn:g.getUpdatedViewportsForSegmentation},loadSegmentationDisplaySetsForViewport:{commandFn:g.loadSegmentationDisplaySetsForViewport},loadSegmentationsForViewport:{commandFn:g.loadSegmentationsForViewport},createEmptySegmentationForViewport:{commandFn:g.createEmptySegmentationForViewport},generateSegmentation:{commandFn:g.generateSegmentation},downloadSegmentation:{commandFn:g.downloadSegmentation},storeSegmentation:{commandFn:g.storeSegmentation},downloadRTSS:{commandFn:g.downloadRTSS},setBrushSize:{commandFn:g.setBrushSize},setThresholdRange:{commandFn:g.setThresholdRange}};return{actions:g,definitions:u,defaultContext:"SEGMENTATION"}};function Ue(){return Ue=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)({}).hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},Ue.apply(null,arguments)}const ze=r.lazy((()=>n.e(8315).then(n.bind(n,88315)))),_e=e=>r.createElement(r.Suspense,{fallback:r.createElement("div",null,"Loading...")},r.createElement(ze,e)),Be={id:a,getPanelModule:Ne,getCommandsModule:Pe,getToolbarModule:function({servicesManager:e}){const{segmentationService:t,toolbarService:n,toolGroupService:a}=e.services;return[{name:"evaluate.cornerstone.segmentation",evaluate:({viewportId:e,button:o,toolNames:r,disabledText:i})=>{const s=t.getSegmentations();if(!s?.length)return{disabled:!0,className:"!text-common-bright !bg-black opacity-50",disabledText:i??"No segmentations available"};const l=a.getToolGroupForViewport(e);if(!l)return{disabled:!0,className:"!text-common-bright ohif-disabled",disabledText:i??"Not available on the current viewport"};const c=n.getToolNameForButton(o);if(!l.hasTool(c)&&!r)return{disabled:!0,className:"!text-common-bright ohif-disabled",disabledText:i??"Not available on the current viewport"};const m=r?r.includes(l.getActivePrimaryMouseButtonTool()):l.getActivePrimaryMouseButtonTool()===c;return{disabled:!1,className:m?"!text-black !bg-primary-light hover:bg-primary-light hover-text-black hover:cursor-pointer":"!text-common-bright !bg-black hover:bg-primary-light hover:cursor-pointer hover:text-black",isActive:m}}}]},getViewportModule:({servicesManager:e,extensionManager:t,commandsManager:n})=>[{name:"dicom-seg",component:a=>r.createElement(_e,Ue({servicesManager:e,extensionManager:t,commandsManager:n},a))}],getSopClassHandlerModule:u,getHangingProtocolModule:S}}}]);
//# sourceMappingURL=8206.bundle.c168cb3a37d2a82e90e8.js.map