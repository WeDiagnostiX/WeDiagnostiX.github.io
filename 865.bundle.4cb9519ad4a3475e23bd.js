(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[865],{52403:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>ce});const o=JSON.parse('{"u2":"@ohif/extension-tmtv"}').u2,n={viewportOptions:{viewportId:"ctAXIAL",viewportType:"volume",orientation:"axial",toolGroupId:"ctToolGroup",initialImageOptions:{preset:"first"},syncGroups:[{type:"cameraPosition",id:"axialSync",source:!0,target:!0},{type:"voi",id:"ctWLSync",source:!0,target:!0}]},displaySets:[{id:"ctDisplaySet"}]},r={viewportOptions:{viewportId:"ctSAGITTAL",viewportType:"volume",orientation:"sagittal",toolGroupId:"ctToolGroup",syncGroups:[{type:"cameraPosition",id:"sagittalSync",source:!0,target:!0},{type:"voi",id:"ctWLSync",source:!0,target:!0}]},displaySets:[{id:"ctDisplaySet"}]},i={viewportOptions:{viewportId:"ctCORONAL",viewportType:"volume",orientation:"coronal",toolGroupId:"ctToolGroup",syncGroups:[{type:"cameraPosition",id:"coronalSync",source:!0,target:!0},{type:"voi",id:"ctWLSync",source:!0,target:!0}]},displaySets:[{id:"ctDisplaySet"}]},s={viewportOptions:{viewportId:"ptAXIAL",viewportType:"volume",background:[1,1,1],orientation:"axial",toolGroupId:"ptToolGroup",initialImageOptions:{preset:"first"},syncGroups:[{type:"cameraPosition",id:"axialSync",source:!0,target:!0},{type:"voi",id:"ptWLSync",source:!0,target:!0},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1}]},displaySets:[{options:{voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},c={viewportOptions:{viewportId:"ptSAGITTAL",viewportType:"volume",orientation:"sagittal",background:[1,1,1],toolGroupId:"ptToolGroup",syncGroups:[{type:"cameraPosition",id:"sagittalSync",source:!0,target:!0},{type:"voi",id:"ptWLSync",source:!0,target:!0},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1}]},displaySets:[{options:{voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},l={viewportOptions:{viewportId:"ptCORONAL",viewportType:"volume",orientation:"coronal",background:[1,1,1],toolGroupId:"ptToolGroup",syncGroups:[{type:"cameraPosition",id:"coronalSync",source:!0,target:!0},{type:"voi",id:"ptWLSync",source:!0,target:!0},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1}]},displaySets:[{options:{voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},u={viewportOptions:{viewportId:"fusionAXIAL",viewportType:"volume",orientation:"axial",toolGroupId:"fusionToolGroup",initialImageOptions:{preset:"first"},syncGroups:[{type:"cameraPosition",id:"axialSync",source:!0,target:!0},{type:"voi",id:"ctWLSync",source:!1,target:!0},{type:"voi",id:"fusionWLSync",source:!0,target:!0},{type:"voi",id:"ptFusionWLSync",source:!1,target:!0}]},displaySets:[{id:"ctDisplaySet"},{options:{colormap:{name:"hsv",opacityMapping:[{value:.1,opacity:.9}]},voi:{custom:"getPTVOIRange"}},id:"ptDisplaySet"}]},m={viewportOptions:{viewportId:"fusionSAGITTAL",viewportType:"volume",orientation:"sagittal",toolGroupId:"fusionToolGroup",syncGroups:[{type:"cameraPosition",id:"sagittalSync",source:!0,target:!0},{type:"voi",id:"ctWLSync",source:!1,target:!0},{type:"voi",id:"fusionWLSync",source:!0,target:!0},{type:"voi",id:"ptFusionWLSync",source:!1,target:!0}]},displaySets:[{id:"ctDisplaySet"},{options:{colormap:{name:"hsv",opacityMapping:[{value:.1,opacity:.9}]},voi:{custom:"getPTVOIRange"}},id:"ptDisplaySet"}]},d={viewportOptions:{viewportId:"fusionCoronal",viewportType:"volume",orientation:"coronal",toolGroupId:"fusionToolGroup",syncGroups:[{type:"cameraPosition",id:"coronalSync",source:!0,target:!0},{type:"voi",id:"ctWLSync",source:!1,target:!0},{type:"voi",id:"fusionWLSync",source:!0,target:!0},{type:"voi",id:"ptFusionWLSync",source:!1,target:!0}]},displaySets:[{id:"ctDisplaySet"},{options:{colormap:{name:"hsv",opacityMapping:[{value:.1,opacity:.9}]},voi:{custom:"getPTVOIRange"}},id:"ptDisplaySet"}]},p={viewportOptions:{viewportId:"mipSagittal",viewportType:"volume",orientation:"sagittal",background:[1,1,1],toolGroupId:"mipToolGroup",syncGroups:[{type:"voi",id:"ptWLSync",source:!0,target:!0},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1}],customViewportProps:{hideOverlays:!0}},displaySets:[{options:{blendMode:"MIP",slabThickness:"fullVolume",voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},g={id:"@ohif/extension-tmtv.hangingProtocolModule.ptCT",locked:!0,hasUpdatedPriorsInformation:!1,name:"Default",createdDate:"2021-02-23T19:22:08.894Z",modifiedDate:"2022-10-04T19:22:08.894Z",availableTo:{},editableBy:{},imageLoadStrategy:"interleaveTopToBottom",protocolMatchingRules:[{attribute:"ModalitiesInStudy",constraint:{contains:["CT","PT"]}},{attribute:"StudyDescription",constraint:{contains:"PETCT"}},{attribute:"StudyDescription",constraint:{contains:"PET/CT"}}],displaySetSelectors:{ctDisplaySet:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:{value:"CT"}},required:!0},{attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0},{attribute:"SeriesDescription",constraint:{contains:"CT"}},{attribute:"SeriesDescription",constraint:{contains:"CT WB"}}]},ptDisplaySet:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"PT"},required:!0},{attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0},{attribute:"SeriesDescription",constraint:{contains:"Corrected"}},{weight:2,attribute:"SeriesDescription",constraint:{doesNotContain:{value:"Uncorrected"}}}]}},stages:[{name:"default",viewportStructure:{layoutType:"grid",properties:{rows:3,columns:4,layoutOptions:[{x:0,y:0,width:1/4,height:1/3},{x:1/4,y:0,width:1/4,height:1/3},{x:.5,y:0,width:1/4,height:1/3},{x:0,y:1/3,width:1/4,height:1/3},{x:1/4,y:1/3,width:1/4,height:1/3},{x:.5,y:1/3,width:1/4,height:1/3},{x:0,y:2/3,width:1/4,height:1/3},{x:1/4,y:2/3,width:1/4,height:1/3},{x:.5,y:2/3,width:1/4,height:1/3},{x:3/4,y:0,width:1/4,height:1}]}},viewports:[n,r,i,s,c,l,u,m,d,p],createdDate:"2021-02-23T18:32:42.850Z"},{name:"Fusion 2x2",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[n,u,s,p]},{name:"2x3-layout",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:3}},viewports:[n,r,i,s,c,l]},{name:"2x4-layout",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:4,layoutOptions:[{x:0,y:0,width:1/4,height:.5},{x:1/4,y:0,width:1/4,height:.5},{x:.5,y:0,width:1/4,height:.5},{x:3/4,y:0,width:1/4,height:1},{x:0,y:.5,width:1/4,height:.5},{x:1/4,y:.5,width:1/4,height:.5},{x:.5,y:.5,width:1/4,height:.5}]}},viewports:[l,c,s,p,d,m,u]}],numberOfPriorsReferenced:-1};const S=function(){return[{name:g.id,protocol:g}]};var h=a(32735),y=a(60216),I=a.n(y),v=a(22605),f=a(48501),T=a(21572);const b={PatientWeight:null,PatientSex:null,SeriesTime:null,RadiopharmaceuticalInformationSequence:{RadionuclideTotalDose:null,RadionuclideHalfLife:null,RadiopharmaceuticalStartTime:null}};function R(e){let{servicesManager:t,commandsManager:a}=e;const{t:o}=(0,T.$G)("PanelSUV"),{displaySetService:n,toolGroupService:r,toolbarService:i,hangingProtocolService:s}=t.services,[c,l]=(0,h.useState)(b),[u,m]=(0,h.useState)(null),d=e=>{l((t=>{const a={...t};return Object.keys(e).forEach((o=>{"object"==typeof e[o]?a[o]={...t[o],...e[o]}:a[o]=e[o]})),a}))},p=e=>{const t=a.runCommand("getMatchingPTDisplaySet",{viewportMatchDetails:e});if(!t)return;return{ptDisplaySet:t,metadata:a.runCommand("getPTMetadata",{ptDisplaySet:t})}};return(0,h.useEffect)((()=>{const e=n.getActiveDisplaySets(),{viewportMatchDetails:t}=s.getMatchDetails();if(!e.length)return;const a=p(t);if(!a)return;const{ptDisplaySet:o,metadata:r}=a;m(o),l(r)}),[]),(0,h.useEffect)((()=>{const{unsubscribe:e}=s.subscribe(s.EVENTS.PROTOCOL_CHANGED,(e=>{let{viewportMatchDetails:t}=e;const a=p(t);if(!a)return;const{ptDisplaySet:o,metadata:n}=a;m(o),l(n)}));return()=>{e()}}),[]),h.createElement("div",{className:"overflow-x-hidden overflow-y-auto invisible-scrollbar"},h.createElement("div",{className:"flex flex-col"},h.createElement("div",{className:"flex flex-col p-4 space-y-4 bg-primary-dark"},h.createElement(v.II,{label:o("Patient Sex"),labelClassName:"text-white mb-2",className:"mt-1",value:c.PatientSex||"",onChange:e=>{d({PatientSex:e.target.value})}}),h.createElement(v.II,{label:o("Patient Weight (kg)"),labelClassName:"text-white mb-2",className:"mt-1",value:c.PatientWeight||"",onChange:e=>{d({PatientWeight:e.target.value})}}),h.createElement(v.II,{label:o("Total Dose (bq)"),labelClassName:"text-white mb-2",className:"mt-1",value:c.RadiopharmaceuticalInformationSequence.RadionuclideTotalDose||"",onChange:e=>{d({RadiopharmaceuticalInformationSequence:{RadionuclideTotalDose:e.target.value}})}}),h.createElement(v.II,{label:o("Half Life (s)"),labelClassName:"text-white mb-2",className:"mt-1",value:c.RadiopharmaceuticalInformationSequence.RadionuclideHalfLife||"",onChange:e=>{d({RadiopharmaceuticalInformationSequence:{RadionuclideHalfLife:e.target.value}})}}),h.createElement(v.II,{label:o("Injection Time (s)"),labelClassName:"text-white mb-2",className:"mt-1",value:c.RadiopharmaceuticalInformationSequence.RadiopharmaceuticalStartTime||"",onChange:e=>{d({RadiopharmaceuticalInformationSequence:{RadiopharmaceuticalStartTime:e.target.value}})}}),h.createElement(v.II,{label:o("Acquisition Time (s)"),labelClassName:"text-white mb-2",className:"mt-1 mb-2",value:c.SeriesTime||"",onChange:()=>{}}),h.createElement(v.zx,{color:"primary",onClick:function(){if(!u)throw new Error("No ptDisplaySet found");r.getToolGroupIds().forEach((e=>{a.runCommand("toggleCrosshairs",{toolGroupId:e,toggledState:!1})})),i.state.toggles.Crosshairs=!1,i._broadcastEvent(i.EVENTS.TOOL_BAR_STATE_MODIFIED),f.DicomMetadataStore.updateMetadataForSeries(u.StudyInstanceUID,u.SeriesInstanceUID,c),n.setDisplaySetMetadataInvalidated(u.displaySetInstanceUID)}},"Reload Data"))))}R.propTypes={servicesManager:I().shape({services:I().shape({measurementService:I().shape({getMeasurements:I().func.isRequired,subscribe:I().func.isRequired,EVENTS:I().object.isRequired,VALUE_TYPES:I().object.isRequired}).isRequired}).isRequired}).isRequired};const x=function(e){let{id:t,servicesManager:a}=e;const{segmentationService:o,uiDialogService:n}=a.services,r=o.getSegmentation(t),i=e=>{let{action:t,value:a}=e;if("save"===t.id)o.addOrUpdateSegmentation({...r,...a},!1,!0);n.dismiss({id:"enter-annotation"})};n.create({id:"enter-annotation",centralize:!0,isDraggable:!1,showOverlay:!0,content:v.Vq,contentProps:{title:"Enter your Segmentation",noCloseButton:!0,value:{label:r.label||""},body:e=>{let{value:t,setValue:a}=e;return h.createElement("div",{className:"p-4 bg-primary-dark"},h.createElement(v.II,{autoFocus:!0,className:"mt-2 bg-black border-primary-main",type:"text",containerClassName:"mr-2",value:t.label,onChange:e=>{e.persist(),a((t=>({...t,label:e.target.value})))},onKeyPress:e=>{"Enter"===e.key&&i({value:t,action:{id:"save"}})}}))},actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:i}})};const D=function(e){let{segmentations:t,tmtvValue:a,config:o,commandsManager:n}=e;const{t:r}=(0,T.$G)("PanelSUVExport");return h.createElement(h.Fragment,null,t?.length?h.createElement("div",{className:"flex justify-center mt-4 space-x-2"},h.createElement(v.hE,{color:"black",size:"inherit"},h.createElement(v.zx,{className:"px-2 py-2 text-base",disabled:null===a,onClick:()=>{n.runCommand("exportTMTVReportCSV",{segmentations:t,tmtv:a,config:o})}},r("Export CSV"))),h.createElement(v.hE,{color:"black",size:"inherit"},h.createElement(v.zx,{className:"px-2 py-2 text-base",onClick:()=>{n.runCommand("createTMTVRTReport")},disabled:null===a},r("Create RT Report")))):null)},w="roi_stat",E=[{value:w,label:"Max",placeHolder:"Max"},{value:"range",label:"Range",placeHolder:"Range"}];const M=function(e){let{config:t,dispatch:a,runCommand:o}=e;const{t:n}=(0,T.$G)("ROIThresholdConfiguration");return h.createElement("div",{className:"flex flex-col px-4 space-y-4 bg-primary-dark py-2"},h.createElement("div",{className:"flex items-end space-x-2"},h.createElement("div",{className:"flex flex-col w-1/2"},h.createElement(v.Ph,{label:n("Strategy"),closeMenuOnSelect:!0,className:"mr-2 bg-black border-primary-main text-white ",options:E,placeholder:E.find((e=>e.value===t.strategy)).placeHolder,value:t.strategy,onChange:e=>{let{value:t}=e;a({type:"setStrategy",payload:{strategy:t}})}})),h.createElement("div",{className:"w-1/2"},h.createElement(v.hE,null,h.createElement(v.zx,{size:"initial",className:"px-2 py-2 text-base text-white",color:"primaryLight",variant:"outlined",onClick:()=>o("setStartSliceForROIThresholdTool")},n("Start")),h.createElement(v.zx,{size:"initial",color:"primaryLight",variant:"outlined",className:"px-2 py-2 text-base text-white",onClick:()=>o("setEndSliceForROIThresholdTool")},n("End"))))),t.strategy===w&&h.createElement(v.II,{label:n("Percentage of Max SUV"),labelClassName:"text-white",className:"mt-2 bg-black border-primary-main",type:"text",containerClassName:"mr-2",value:t.weight,onChange:e=>{a({type:"setWeight",payload:{weight:e.target.value}})}}),t.strategy!==w&&h.createElement("div",{className:"text-sm mr-2"},h.createElement("table",null,h.createElement("tbody",null,h.createElement("tr",{className:"mt-2"},h.createElement("td",{className:"pr-4 pt-2",colSpan:"3"},h.createElement(v.__,{className:"text-white",text:"Lower & Upper Ranges"}))),h.createElement("tr",{className:"mt-2"},h.createElement("td",{className:"text-center pr-4 pt-2"},h.createElement(v.__,{className:"text-white",text:"CT"})),h.createElement("td",null,h.createElement("div",{className:"flex justify-between"},h.createElement(v.II,{label:n(""),labelClassName:"text-white",className:"mt-2 bg-black border-primary-main",type:"text",containerClassName:"mr-2",value:t.ctLower,onChange:e=>{a({type:"setThreshold",payload:{ctLower:e.target.value}})}}),h.createElement(v.II,{label:n(""),labelClassName:"text-white",className:"mt-2 bg-black border-primary-main",type:"text",containerClassName:"mr-2",value:t.ctUpper,onChange:e=>{a({type:"setThreshold",payload:{ctUpper:e.target.value}})}})))),h.createElement("tr",null,h.createElement("td",{className:"text-center pr-4 pt-2"},h.createElement(v.__,{className:"text-white",text:"PT"})),h.createElement("td",null,h.createElement("div",{className:"flex justify-between"},h.createElement(v.II,{label:n(""),labelClassName:"text-white",className:"mt-2 bg-black border-primary-main",type:"text",containerClassName:"mr-2",value:t.ptLower,onChange:e=>{a({type:"setThreshold",payload:{ptLower:e.target.value}})}}),h.createElement(v.II,{label:n(""),labelClassName:"text-white",className:"mt-2 bg-black border-primary-main",type:"text",containerClassName:"mr-2",value:t.ptUpper,onChange:e=>{a({type:"setThreshold",payload:{ptUpper:e.target.value}})}}))))))))},O=w;function C(e,t){const{payload:a}=t,{strategy:o,ctLower:n,ctUpper:r,ptLower:i,ptUpper:s,weight:c}=a;switch(t.type){case"setStrategy":return{...e,strategy:o};case"setThreshold":return{...e,ctLower:n||e.ctLower,ctUpper:r||e.ctUpper,ptLower:i||e.ptLower,ptUpper:s||e.ptUpper};case"setWeight":return{...e,weight:c};default:return e}}function N(e){let{servicesManager:t,commandsManager:a}=e;const{segmentationService:o}=t.services,{t:n}=(0,T.$G)("PanelSUV"),[r,i]=(0,h.useState)(!1),[s,c]=(0,h.useState)(!1),[l,u]=(0,h.useState)(null),[m,d]=(0,h.useState)((()=>o.getSegmentations())),[p,g]=(0,h.useReducer)(C,{strategy:O,ctLower:-1024,ctUpper:1024,ptLower:2.5,ptUpper:100,weight:.41}),[S,y]=(0,h.useState)(null),I=(0,h.useCallback)((function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return a.runCommand(e,t)}),[a]),f=(0,h.useCallback)((()=>{const e=I("calculateTMTV",{segmentations:m});void 0!==e&&y(e.toFixed(2))}),[m,I]),b=(0,h.useCallback)((()=>{const e=I("thresholdSegmentationByRectangleROITool",{segmentationId:l,config:p}),t=I("getLesionStats",{labelmap:e}),a=I("calculateSuvPeak",{labelmap:e}),n=t.volume*t.meanValue,r=o.getSegmentation(l),i={lesionStats:t,suvPeak:a,lesionGlyoclysisStats:n};o.addOrUpdateSegmentation({...r,...Object.assign(r.cachedStats,i),displayText:[`SUV Peak: ${a.suvPeak.toFixed(2)}`]},!0),f()}),[l,p]);return(0,h.useEffect)((()=>{const e=o.EVENTS.SEGMENTATION_ADDED,t=o.EVENTS.SEGMENTATION_UPDATED,a=[];return[e,t].forEach((e=>{const{unsubscribe:t}=o.subscribe(e,(()=>{const e=o.getSegmentations();d(e)}));a.push(t)})),()=>{a.forEach((e=>{e()}))}}),[]),(0,h.useEffect)((()=>{const{unsubscribe:e}=o.subscribe(o.EVENTS.SEGMENTATION_REMOVED,(()=>{const e=o.getSegmentations();d(e),e.length>0?(u(e[0].id),f()):(u(null),y(null))}));return()=>{e()}}),[]),(0,h.useEffect)((()=>{!l&&m.length>0&&u(m[0].id),f()}),[m,l]),h.createElement(h.Fragment,null,h.createElement("div",{className:"flex flex-col"},h.createElement("div",{className:"overflow-x-hidden overflow-y-auto invisible-scrollbar"},h.createElement("div",{className:"flex mx-4 my-4 mb-4 space-x-4"},h.createElement(v.zx,{color:"primary",onClick:()=>{c(!0),setTimeout((()=>{I("createNewLabelmapFromPT").then((e=>{c(!1),u(e)}))}))}},s?"loading ...":"New Label"),h.createElement(v.zx,{color:"primary",onClick:b},"Run")),h.createElement("div",{className:"flex items-center justify-around h-8 mb-2 border-t outline-none cursor-pointer select-none bg-secondary-dark first:border-0 border-secondary-light",onClick:()=>{i(!r)}},h.createElement("div",{className:"px-4 text-base text-white"},n("ROI Threshold Configuration"))),r&&h.createElement(M,{config:p,dispatch:g,runCommand:I}),h.createElement("div",{className:"mt-4"},m?.length?h.createElement(v.y1,{title:n("Segmentations"),segmentations:m,activeSegmentationId:l,onClick:e=>{I("setSegmentationActiveForToolGroups",{segmentationId:e}),u(e)},onToggleVisibility:e=>{o.toggleSegmentationVisibility(e)},onToggleVisibilityAll:e=>{e.map((e=>{o.toggleSegmentationVisibility(e)}))},onDelete:e=>{o.remove(e)},onEdit:e=>{x({id:e,servicesManager:t})}}):null),null!==S?h.createElement("div",{className:"flex items-baseline justify-between px-2 py-1 mt-4 bg-secondary-dark"},h.createElement("span",{className:"text-base font-bold tracking-widest text-white uppercase"},"TMTV:"),h.createElement("div",{className:"text-white"},`${S} mL`)):null,h.createElement(D,{segmentations:m,tmtvValue:S,config:p,commandsManager:a}))),h.createElement("div",{className:"opacity-50 hover:opacity-80 flex items-center justify-center text-blue-400 mt-auto cursor-pointer mb-4",onClick:()=>{window.open("https://github.com/OHIF/Viewers/blob/master/modes/tmtv/README.md","_blank")}},h.createElement(v.JO,{width:"15px",height:"15px",name:"info",className:"text-primary-active ml-4 mr-3"}),h.createElement("span",null,"User Guide")))}N.propTypes={commandsManager:I().shape({runCommand:I().func.isRequired}),servicesManager:I().shape({services:I().shape({segmentationService:I().shape({getSegmentation:I().func.isRequired,getSegmentations:I().func.isRequired,toggleSegmentationVisibility:I().func.isRequired,subscribe:I().func.isRequired,EVENTS:I().object.isRequired}).isRequired}).isRequired}).isRequired};const P=N;const L=function(e){let{commandsManager:t,extensionManager:a,servicesManager:o}=e;return[{name:"petSUV",iconName:"tab-patient-info",iconLabel:"PET SUV",label:"PET SUV",component:()=>h.createElement(R,{commandsManager:t,servicesManager:o,extensionManager:a})},{name:"ROIThresholdSeg",iconName:"tab-roi-threshold",iconLabel:"ROI Threshold",label:"ROI Threshold",component:()=>h.createElement(P,{commandsManager:t,servicesManager:o,extensionManager:a})}]};var U=a(29905),V=a(36791);const F=["RectangleROIStartEndThreshold"];function A(e){if(e)return function(e){const t=V.metaData.get("instance",e);return{SOPInstanceUID:t.SOPInstanceUID,SeriesInstanceUID:t.SeriesInstanceUID,StudyInstanceUID:t.StudyInstanceUID,frameNumber:t.frameNumber||1}}(e)}const G={toAnnotation:(e,t)=>{},toMeasurement:(e,t,a)=>{const{annotation:o,viewportId:n}=e,{metadata:r,data:i,annotationUID:s}=o;if(!r||!i)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:l,FrameOfReferenceUID:u}=r;if(!F.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:m,SeriesInstanceUID:d,StudyInstanceUID:p}=A(l);let g;g=m?t.getDisplaySetForSOPInstanceUID(m,d):t.getDisplaySetsForSeries(d);const{cachedStats:S}=i;return{uid:s,SOPInstanceUID:m,FrameOfReferenceUID:u,metadata:r,referenceSeriesUID:d,referenceStudyUID:p,toolName:r.toolName,displaySetInstanceUID:g.displaySetInstanceUID,label:r.label,data:i.cachedStats,type:"RectangleROIStartEndThreshold"}}},k=(e,t,a)=>({RectangleROIStartEndThreshold:{toAnnotation:G.toAnnotation,toMeasurement:e=>G.toMeasurement(e,t,a),matchingCriteria:[{valueType:e.VALUE_TYPES.ROI_THRESHOLD_MANUAL}]}});var q=a(74569);const{registerColormap:j}=V.utilities.colormap;var W=a(88256);function _(e,t){const{imageData:a}=e,o=a.getPointData().getScalars().getData(),{fn:n,baseValue:r}=function(e){const t=-1/0,a=(e,t)=>(e>t&&(t=e),t);return{fn:a,baseValue:t}}();let i=r;const s=U.utilities.rectangleROITool.getBoundsIJKFromRectangleAnnotations(t,e),[[c,l],[u,m],[d,p]]=s;for(let e=c;e<=l;e++)for(let t=u;t<=m;t++)for(let r=d;r<=p;r++){i=n(o[a.computeOffsetIndex([e,t,r])],i)}return i}const B=function(e,t,a){if("range"===a.strategy)return{ptLower:Number(a.ptLower),ptUpper:Number(a.ptUpper),ctLower:Number(a.ctLower),ctUpper:Number(a.ctUpper)};const{weight:o}=a,n=e.map((e=>U.annotation.state.getAnnotation(e)));return{ctLower:-1/0,ctUpper:1/0,ptLower:o*_(t[0],n),ptUpper:1/0}};const $=function(e,t,a){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;if("PT"!==t.metadata.Modality)return;if(e.scalarData.length!==t.scalarData.length)throw new Error("labelmap and referenceVolume must have the same number of pixels");const{scalarData:n,dimensions:r,imageData:i}=e,{scalarData:s,imageData:c}=t;let l;if(a&&a[0].data?.cachedStats){const{projectionPoints:e}=a[0].data.cachedStats,t=[].concat(...e).map((e=>{const t=W.vec3.fromValues(0,0,0);return c.worldToIndex(e,t),t}));l=U.utilities.boundingBox.getBoundingBoxAroundShape(t,r)}let u=0,m=[0,0,0],d=[0,0,0];U.utilities.pointInShapeCallback(i,(()=>!0),(e=>{let{pointIJK:t,pointLPS:a}=e;const r=c.computeOffsetIndex(t);if(n[r]!==o)return;const i=s[r];i>u&&(u=i,m=t,d=a)}),l);const p=i.getDirection().slice(0,3),g=2*(10*Math.pow(1/(4/3*Math.PI),1/3)),S=W.vec3.create(),h=W.vec3.create(),y=W.vec3.create();c.indexToWorld(m,S),W.vec3.scaleAndAdd(h,S,p,-g/2),W.vec3.scaleAndAdd(y,S,p,g/2);const I=[h,y];let v=0,f=0;return U.utilities.pointInSurroundingSphereCallback(c,I,(e=>{let{value:t}=e;f+=t,v+=1})),{max:u,maxIJK:m,maxLPS:d,mean:f/v}};const H=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const a=U.utilities.segmentation.createMergedLabelmapForIndex(e,t,"mergedLabelmap"),{imageData:o,spacing:n}=a;return.001*o.getPointData().getScalars().getData().reduce(((e,t)=>t>0?e+1:e),0)*n[0]*n[1]*n[2]};class z{constructor(){}static getContourSequence(e,t){const{data:a}=e,{projectionPoints:o,projectionPointsImageIds:n}=a.cachedStats;return o.map(((e,a)=>{const o=function(e){const t=[...e[0],...e[1],...e[3],...e[2]],a=t.flat().map((e=>e.toFixed(2)));return a}(e),r=function(e,t){const a=t.get("sopCommonModule",e);return{ReferencedSOPClassUID:a.sopClassUID,ReferencedSOPInstanceUID:a.sopInstanceUID}}(n[a],t);return{NumberOfContourPoints:o.length/3,ContourImageSequence:r,ContourGeometricType:"CLOSED_PLANAR",ContourData:o}}))}}z.toolName="RectangleROIStartEndThreshold";const J=z;class K{constructor(){}static convert(e,t,a){!function(e){if(!e?.data)throw new Error("Tool data is empty");if(!e.metadata||e.metadata.referenceImageId)throw new Error("Tool data is not associated with any imageId")}(e);const{toolName:o}=e.metadata,n=K.TOOL_NAMES[o];if(!n)throw new Error(`Unknown tool type: ${o}, cannot convert to RTSSReport`);const r=n.getContourSequence(e,a);return{ReferencedROINumber:t+1,ROIDisplayColor:[Math.floor(255*Math.random()),Math.floor(255*Math.random()),Math.floor(255*Math.random())],ContourSequence:r}}static register(e){K.TOOL_NAMES[e.toolName]=e}}K.TOOL_NAMES={},K.register(J);const Z=K;var X=a(22737);const{DicomMetaDictionary:Y}=X.default.data;class Q{constructor(){}static generateReport(e,t,a){let o=function(e,t){const a=Y.uid(),{referencedImageId:o,FrameOfReferenceUID:n}=e[0].metadata,{studyInstanceUID:r}=t.get("generalSeriesModule",o),i=function(e,t){const a=t.get("generalSeriesModule",e),o=t.get("generalStudyModule",e),n=t.get("patientStudyModule",e),r=t.get("patientModule",e),i=t.get("patientDemographicModule",e);return{Modality:a.modality,PatientID:r.patientId,PatientName:r.patientName,PatientBirthDate:"",PatientAge:n.patientAge,PatientSex:i.patientSex,PatientWeight:n.patientWeight,StudyDate:o.studyDate,StudyTime:o.studyTime,StudyID:"ToDo",AccessionNumber:o.accessionNumber}}(o,t),s={SeriesInstanceUID:Y.uid(),SeriesNumber:"99"};return{StructureSetROISequence:[],ROIContourSequence:[],RTROIObservationsSequence:[],ReferencedSeriesSequence:[],ReferencedFrameOfReferenceSequence:[],...i,...s,StudyInstanceUID:r,SOPClassUID:"1.2.840.10008.5.1.4.1.1.481.3",SOPInstanceUID:a,Manufacturer:"dcmjs",Modality:"RTSTRUCT",FrameOfReferenceUID:n,PositionReferenceIndicator:"",StructureSetLabel:"",StructureSetName:"",ReferringPhysicianName:"",OperatorsName:"",StructureSetDate:Y.date(),StructureSetTime:Y.time()}}(e,t);e.forEach(((e,n)=>{const r=Z.convert(e,n,t,a);o.StructureSetROISequence.push(function(e,t,a){const{FrameOfReferenceUID:o}=e.metadata;return{ROINumber:t+1,ROIName:`Todo: name ${t+1}`,ROIDescription:`Todo: description ${t+1}`,ROIGenerationAlgorithm:"Todo: algorithm",ReferencedFrameOfReferenceUID:o}}(e,n)),o.ROIContourSequence.push(r),o.RTROIObservationsSequence.push(function(e,t,a){return{ObservationNumber:t+1,ReferencedROINumber:t+1,RTROIInterpretedType:"Todo: type",ROIInterpreter:"Todo: interpreter"}}(0,n)),o.ReferencedSeriesSequence=function(e,t,a){const{referencedImageId:o}=e.metadata,n=a.get("instance",o),{SeriesInstanceUID:r,StudyInstanceUID:i}=n,s=[];if(r){const e=f.DicomMetadataStore.getSeries(i,r),t={SeriesInstanceUID:r,ReferencedInstanceSequence:[]};e.instances.forEach((e=>{const{SOPInstanceUID:a,SOPClassUID:o}=e;t.ReferencedInstanceSequence.push({ReferencedSOPClassUID:o,ReferencedSOPInstanceUID:a})})),s.push(t)}return s}(e,0,t),o.ReferencedFrameOfReferenceSequence=function(e,t,a){const{referencedImageId:o,FrameOfReferenceUID:n}=e.metadata,r=t.get("instance",o),{SeriesInstanceUID:i}=r,{ReferencedSeriesSequence:s}=a;return[{FrameOfReferenceUID:n,RTReferencedStudySequence:[{ReferencedSOPClassUID:a.SOPClassUID,ReferencedSOPInstanceUID:a.SOPInstanceUID,RTReferencedSeriesSequence:[{SeriesInstanceUID:i,ContourImageSequence:[...s[0].ReferencedInstanceSequence]}]}]}]}(e,t,o)}));const n=new Uint8Array(2);n[1]=1;const r={FileMetaInformationVersion:{Value:[n.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[Y.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}};return o._meta=r,o}static generateToolState(e){console.warn("RTSSReport.generateToolState not implemented")}}const{datasetToBlob:ee}=X.default.data,te=f.classes.MetadataProvider;const ae=function(e){const t=Q.generateReport(e,te),a=ee(t);var o=URL.createObjectURL(a);window.location.assign(o)},oe=f.classes.MetadataProvider,ne="RectangleROIStartEndThreshold",re=U.Enums.SegmentationRepresentations.Labelmap,ie=e=>{let{servicesManager:t,commandsManager:a,extensionManager:o}=e;const{viewportGridService:n,uiNotificationService:r,displaySetService:i,hangingProtocolService:s,toolGroupService:c,cornerstoneViewportService:l,segmentationService:u}=t.services,m=o.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{getEnabledElement:d}=m.exports;function p(){const{activeViewportIndex:e}=n.getState(),{element:t}=d(e)||{};return V.getEnabledElement(t)}function g(){const{viewportMatchDetails:e}=s.getMatchDetails(),t=[];return e.forEach(((e,a)=>{const{viewportOptions:o}=e,{toolGroupId:n}=o;-1===t.indexOf(n)&&t.push(n)})),t}const S={getMatchingPTDisplaySet:e=>{let{viewportMatchDetails:t}=e,a=null;for(const[e,o]of t){const{displaySetsInfo:e}=o,t=e.map((e=>{let{displaySetInstanceUID:t}=e;return i.getDisplaySetByUID(t)}));if(t&&0!==t.length&&(a=t.find((e=>"PT"===e.Modality)),a))break}return a},getPTMetadata:e=>{let{ptDisplaySet:t}=e;const a=o.getDataSources()[0].getImageIdsForDisplaySet(t)[0],n=oe.get("instance",a);if("PT"!==n.Modality)return;return{SeriesTime:n.SeriesTime,Modality:n.Modality,PatientSex:n.PatientSex,PatientWeight:n.PatientWeight,RadiopharmaceuticalInformationSequence:{RadionuclideTotalDose:n.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose,RadionuclideHalfLife:n.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife,RadiopharmaceuticalStartTime:n.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime,RadiopharmaceuticalStartDateTime:n.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime}}},createNewLabelmapFromPT:async()=>{const{viewportMatchDetails:e}=s.getMatchDetails(),t=S.getMatchingPTDisplaySet({viewportMatchDetails:e});if(!t)return void r.error("No matching PT display set found");const a=await u.createSegmentationForDisplaySet(t.displaySetInstanceUID),o=g(),n=re;for(const e of o){const t=!0;await u.addSegmentationRepresentationToToolGroup(e,a,t,n),u.setActiveSegmentationForToolGroup(a,e)}return a},setSegmentationActiveForToolGroups:e=>{let{segmentationId:t}=e;g().forEach((e=>{u.setActiveSegmentationForToolGroup(t,e)}))},thresholdSegmentationByRectangleROITool:e=>{let{segmentationId:t,config:a}=e;const o=U.segmentation.state.getSegmentation(t),{representationData:n}=o,{displaySetMatchDetails:i}=s.getMatchDetails(),c=`cornerstoneStreamingImageVolume:${i.get("ctDisplaySet").displaySetInstanceUID}`,{volumeId:l}=n[re],{referencedVolumeId:u}=V.cache.getVolume(l),m=V.cache.getVolume(t),d=V.cache.getVolume(u),p=V.cache.getVolume(c);if(!d)throw new Error("No Reference volume found");if(!m)throw new Error("No Reference labelmap found");const g=U.annotation.selection.getAnnotationsSelectedByToolName(ne);if(0===g.length)return void r.show({title:"Commands Module",message:"No ROIThreshold Tool is Selected",type:"error"});const{ptLower:S,ptUpper:h,ctLower:y,ctUpper:I}=B(g,[d,p],a);return U.utilities.segmentation.rectangleROIThresholdVolumeByRange(g,m,[{volume:d,lower:S,upper:h},{volume:p,lower:y,upper:I}],{overwrite:!0})},calculateSuvPeak:e=>{let{labelmap:t}=e;const{referencedVolumeId:a}=t,o=V.cache.getVolume(a),n=U.annotation.selection.getAnnotationsSelectedByToolName(ne).map((e=>U.annotation.state.getAnnotation(e))),r=$(t,o,n);return{suvPeak:r.mean,suvMax:r.max,suvMaxIJK:r.maxIJK,suvMaxLPS:r.maxLPS}},getLesionStats:e=>{let{labelmap:t,segmentIndex:a=1}=e;const{scalarData:o,spacing:n}=t,{scalarData:r}=V.cache.getVolume(t.referencedVolumeId);let i=-1/0,s=1/0,c=[],l=0;for(let e=0;e<o.length;e++)if(o[e]===a){const t=r[e];c.push(t),t>i&&(i=t),t<s&&(s=t),l++}return{minValue:s,maxValue:i,meanValue:c.reduce(((e,t)=>e+t),0)/l,stdValue:Math.sqrt(c.reduce(((e,t)=>e+t*t),0)/l-c.reduce(((e,t)=>e+t),0)/l**2),volume:l*n[0]*n[1]*n[2]*.001}},calculateLesionGlycolysis:e=>{let{lesionStats:t}=e;const{meanValue:a,volume:o}=t;return{lesionGlyoclysisStats:o*a}},calculateTMTV:e=>{let{segmentations:t}=e;const a=t.map((e=>u.getLabelmapVolume(e.id)));if(a.length)return H(a)},exportTMTVReportCSV:e=>{let{segmentations:t,tmtv:o,config:n}=e;!function(e,t){const a=e[Object.keys(e)[0]],o=Object.keys(a),n=[o.join(",")];Object.values(e).forEach((e=>{const t=[];o.forEach((a=>{t.push(Array.isArray(e[a])?e[a].join(" "):e[a])})),n.push(t.join(","))})),n.push(""),n.push(""),n.push(""),n.push(`Patient ID,${a.PatientID}`),n.push(`Study Date,${a.StudyDate}`),n.push(""),t.forEach((e=>{let{key:t,value:a}=e;const o=[];o.push(`${t}`),Object.keys(a).forEach((e=>{o.push(`${e}`),o.push(`${a[e]}`)})),n.push(o.join(","))}));const r=new Blob([n.join("\n")],{type:"text/csv;charset=utf-8"}),i=URL.createObjectURL(r),s=document.createElement("a");s.href=i,s.download=`${a.PatientID}_tmtv.csv`,s.click()}(a.runCommand("getSegmentationCSVReport",{segmentations:t}),[{key:"Total Metabolic Tumor Volume",value:{tmtv:o}},{key:"Total Lesion Glycolysis",value:{tlg:S.getTotalLesionGlycolysis({segmentations:t}).toFixed(4)}},{key:"Threshold Configuration",value:{...n}}])},getTotalLesionGlycolysis:e=>{let{segmentations:t}=e;const a=t.map((e=>u.getLabelmapVolume(e.id)));let o;try{o=U.utilities.segmentation.createMergedLabelmapForIndex(a)}catch(e){return void console.error("commandsModule::getTotalLesionGlycolysis",e)}const{referencedVolumeId:n,spacing:r}=a[0];n||console.error("commandsModule::getTotalLesionGlycolysis:No referencedVolumeId found");const i=V.cache.getVolume(n),s=o.scalarData;s.length!==i.scalarData.length&&console.error("commandsModule::getTotalLesionGlycolysis:Labelmap and ptVolume are not the same size");let c=0,l=0;for(let e=0;e<s.length;e++)0!==s[e]&&(c+=i.scalarData[e],l+=1);return c/l*l*r[0]*r[1]*r[2]*.001},setStartSliceForROIThresholdTool:()=>{const{viewport:e}=p(),{focalPoint:t,viewPlaneNormal:a}=e.getCamera(),o=U.annotation.selection.getAnnotationsSelectedByToolName(ne)[0],n=U.annotation.state.getAnnotation(o),{handles:r}=n.data,{points:i}=r,s=e.getCurrentImageIdIndex();n.data.startSlice=s;const c=i.map((e=>{const o=W.vec3.create();W.vec3.subtract(o,t,e);const n=W.vec3.dot(o,a),r=W.vec3.create();return W.vec3.scaleAndAdd(r,e,a,n),r}));r.points=c,n.invalidated=!0,e.render()},setEndSliceForROIThresholdTool:()=>{const{viewport:e}=p(),t=U.annotation.selection.getAnnotationsSelectedByToolName(ne)[0],a=U.annotation.state.getAnnotation(t),o=e.getCurrentImageIdIndex();a.data.endSlice=o,a.invalidated=!0,e.render()},createTMTVRTReport:()=>{const e=U.annotation.state.getAnnotationManager(),t=[];Object.keys(e.annotations).forEach((a=>{const o=e.annotations[a][ne];t.push(...o)})),a.runCommand("exportRTReportForAnnotations",{annotations:t})},getSegmentationCSVReport:e=>{let{segmentations:t}=e;t&&t.length||(t=u.getSegmentations());let a={};for(const e of t){const{id:t,label:o,cachedStats:n}=e,r={id:t,label:o};if(!n){a[t]=r;continue}Object.keys(n).forEach((e=>{"object"!=typeof n[e]?r[e]=n[e]:Object.keys(n[e]).forEach((t=>{r[`${e}_${t}`]=n[e][t]}))}));const i=u.getLabelmapVolume(t);if(!i){a[t]=r;continue}const s=i.referencedVolumeId;r.referencedVolumeId=s;const c=u.getLabelmapVolume(s);if(!c){a[t]=r;continue}if(!c.imageIds||!c.imageIds.length){a[t]=r;continue}const l=c.imageIds[0],m=f.default.classes.MetadataProvider.get("instance",l);m?a[t]={...r,PatientID:m.PatientID,PatientName:m.PatientName.Alphabetic,StudyInstanceUID:m.StudyInstanceUID,SeriesInstanceUID:m.SeriesInstanceUID,StudyDate:m.StudyDate}:a[t]=r}return a},exportRTReportForAnnotations:e=>{let{annotations:t}=e;ae(t)},setFusionPTColormap:e=>{let{toolGroupId:t,colormap:o}=e;const n=c.getToolGroup(t),{viewportMatchDetails:r}=s.getMatchDetails(),i=S.getMatchingPTDisplaySet({viewportMatchDetails:r});if(!i)return;const u=n.getViewportIds();let m=[];u.forEach((e=>{const t=l.getViewportInfo(e).getViewportIndex();a.runCommand("setViewportColormap",{viewportIndex:t,displaySetInstanceUID:i.displaySetInstanceUID,colormap:o}),m.push(l.getCornerstoneViewport(e))})),m.forEach((e=>{e.render()}))}},h={setEndSliceForROIThresholdTool:{commandFn:S.setEndSliceForROIThresholdTool,storeContexts:[],options:{}},setStartSliceForROIThresholdTool:{commandFn:S.setStartSliceForROIThresholdTool,storeContexts:[],options:{}},getMatchingPTDisplaySet:{commandFn:S.getMatchingPTDisplaySet,storeContexts:[],options:{}},getPTMetadata:{commandFn:S.getPTMetadata,storeContexts:[],options:{}},createNewLabelmapFromPT:{commandFn:S.createNewLabelmapFromPT,storeContexts:[],options:{}},setSegmentationActiveForToolGroups:{commandFn:S.setSegmentationActiveForToolGroups,storeContexts:[],options:{}},thresholdSegmentationByRectangleROITool:{commandFn:S.thresholdSegmentationByRectangleROITool,storeContexts:[],options:{}},getTotalLesionGlycolysis:{commandFn:S.getTotalLesionGlycolysis,storeContexts:[],options:{}},calculateSuvPeak:{commandFn:S.calculateSuvPeak,storeContexts:[],options:{}},getLesionStats:{commandFn:S.getLesionStats,storeContexts:[],options:{}},calculateTMTV:{commandFn:S.calculateTMTV,storeContexts:[],options:{}},exportTMTVReportCSV:{commandFn:S.exportTMTVReportCSV,storeContexts:[],options:{}},createTMTVRTReport:{commandFn:S.createTMTVRTReport,storeContexts:[],options:{}},getSegmentationCSVReport:{commandFn:S.getSegmentationCSVReport,storeContexts:[],options:{}},exportRTReportForAnnotations:{commandFn:S.exportRTReportForAnnotations,storeContexts:[],options:{}},setFusionPTColormap:{commandFn:S.setFusionPTColormap,storeContexts:[],options:{}}};return{actions:S,definitions:h,defaultContext:"TMTV:CORNERSTONE"}},se={id:o,preRegistration(e){let{servicesManager:t,commandsManager:a,extensionManager:o,configuration:n={}}=e;!function(e){let{servicesManager:t,extensionManager:a}=e;const{measurementService:o,displaySetService:n,cornerstoneViewportService:r}=t.services;(0,U.addTool)(U.RectangleROIStartEndThresholdTool);const{RectangleROIStartEndThreshold:i}=k(o,n,r),s=o.getSource("Cornerstone3DTools","0.1");o.addMapping(s,"RectangleROIStartEndThreshold",i.matchingCriteria,i.toAnnotation,i.toMeasurement),q.Z.forEach(j)}({servicesManager:t,commandsManager:a,extensionManager:o,configuration:n})},getPanelModule:L,getHangingProtocolModule:S,getCommandsModule(e){let{servicesManager:t,commandsManager:a,extensionManager:o}=e;return ie({servicesManager:t,commandsManager:a,extensionManager:o})}},ce=se},78753:()=>{}}]);
//# sourceMappingURL=865.bundle.4cb9519ad4a3475e23bd.js.map