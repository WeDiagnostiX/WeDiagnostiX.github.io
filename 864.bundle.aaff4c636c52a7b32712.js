"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[864],{28864:(e,t,n)=>{n.r(t),n.d(t,{ContextMenuController:()=>Wt,CustomizableContextMenuTypes:()=>a,default:()=>Mn,dicomWebUtils:()=>o,getStudiesForPatientByMRN:()=>we});var a={};n.r(a);var o={};n.r(o),n.d(o,{fixBulkDataURI:()=>E});var s=n(83562),i=n(53562),r=n(311);const{getString:c,getName:l,getModalities:d}=i.DICOMWeb;function u(e){if(!e||!e.length)return[];const t=[];return e.forEach((e=>t.push({studyInstanceUid:c(e["0020000D"]),date:c(e["00080020"]),time:c(e["00080030"]),accession:c(e["00080050"])||"",mrn:c(e["00100020"])||"",patientName:i.utils.formatPN(l(e["00100010"]))||"",instances:Number(c(e["00201208"]))||0,description:c(e["00081030"])||"",modalities:c(d(e["00080060"],e["00080061"]))||""}))),t}async function m(e,t,n,a){return await e.searchForStudies({studyInstanceUid:void 0,queryParams:a})}function p(e,t={}){if(!e)return;const n=["00081030","00080060"].join(","),{supportsWildcard:a}=t,o=e=>a&&e?`*${e}*`:e,s={PatientName:o(e.patientName),"00100020":o(e.patientId),AccessionNumber:o(e.accessionNumber),StudyDescription:o(e.studyDescription),ModalitiesInStudy:e.modalitiesInStudy,limit:e.limit||101,offset:e.offset||0,fuzzymatching:!0===t.supportsFuzzyMatching,includefield:n};if(e.startDate&&e.endDate)s.StudyDate=`${e.startDate}-${e.endDate}`;else if(e.startDate){const t=new Date,n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),o=`${t.getFullYear()}${a}${n}`;s.StudyDate=`${e.startDate}-${o}`}else if(e.endDate){const t="19700102";s.StudyDate=`${t}-${e.endDate}`}if(e.studyInstanceUid){let t=e.studyInstanceUid;t=Array.isArray(t)?t.join():t,t=t.replace(/[^0-9.]+/g,"\\"),s.StudyInstanceUID=t}const i={};return Object.keys(s).forEach((e=>{void 0!==s[e]&&""!==s[e]&&(i[e]=s[e])})),i}function g({instance:e,frame:t,config:n,thumbnail:a=!1}){if(!e)return;if(e.url)return e.url;const o=a?"thumbnailRendering":"imageRendering";if(n[o]&&"wadouri"!==n[o])return function(e,t,n){const a=function(e,t,n){const a=function(e,t){const{StudyInstanceUID:n,SeriesInstanceUID:a,SOPInstanceUID:o}=e;return`${t.wadoRoot}/studies/${n}/series/${a}/instances/${o}`}(e,t);return`${a}/frames/${n=n||1}`}(e,t,n);if(a)return`wadors:${a}`}(e,n,t);{const a=function(e,t){const{StudyInstanceUID:n,SeriesInstanceUID:a,SOPInstanceUID:o}=t,s=[];s.push("requestType=WADO"),s.push(`studyUID=${n}`),s.push(`seriesUID=${a}`),s.push(`objectUID=${o}`),s.push("contentType=application/dicom"),s.push("transferSyntax=*");const i=s.join("&");return`${e.wadoUriRoot}?${i}`}(n,e);let o="dicomweb:"+a;return void 0!==t&&(o+="&frame="+t),o}}var h=n(5842);class f{constructor(e,t,n={},a,o){this.client=e,this.studyInstanceUID=t,this.filters=n,this.sortCriteria=a,this.sortFunction=o}async execLoad(){const e=await this.preLoad(),t=await this.load(e);return await this.posLoad(t)}async runLoaders(e){let t;for(const n of e)try{if(t=await n(),t&&t.length)break}catch(e){throw e}if(e.next().done&&!t)throw new Error("RetrieveMetadataLoader failed");return t}async configLoad(){}async preLoad(){}async load(e){}async posLoad(e){}}class y extends f{getOptions(){const{studyInstanceUID:e,filters:t}=this,n={studyInstanceUID:e},{seriesInstanceUID:a}=t;return a&&(n.seriesInstanceUID=a),n}*getLoaders(){const e=[],{studyInstanceUID:t,filters:{seriesInstanceUID:n}={},client:a}=this;n&&e.push(a.retrieveSeriesMetadata.bind(a,{studyInstanceUID:t,seriesInstanceUID:n})),e.push(a.retrieveStudyMetadata.bind(a,{studyInstanceUID:t})),yield*e}async load(e){const t=this.getLoaders();return this.runLoaders(t)}async posLoad(e){return e}}class I extends f{*getPreLoaders(){const e=[],{studyInstanceUID:t,filters:{seriesInstanceUID:n}={},client:a}=this;if(n){const o={studyInstanceUID:t,queryParams:{SeriesInstanceUID:n}};e.push(a.searchForSeries.bind(a,o))}e.push(a.searchForSeries.bind(a,{studyInstanceUID:t})),yield*e}async preLoad(){const e=this.getPreLoaders(),t=await this.runLoaders(e),n=this.sortCriteria,a=this.sortFunction,{naturalizeDataset:o}=h.Ay.data.DicomMetaDictionary,s=t.map(o);return(0,r.LM)(s,n||r.y1.seriesSortCriteria.seriesInfoSortingCriteria,a)}async load(e){const{client:t,studyInstanceUID:n}=this,a=function(e,t,n){return Object.freeze({hasNext:()=>n.length>0,async next(){const a=n.shift();return e.retrieveSeriesMetadata({studyInstanceUID:t,seriesInstanceUID:a})}})}(t,n,e.map((e=>e.SeriesInstanceUID))),o=[];for(;a.hasNext();)o.push(a.next());return{preLoadData:e,promises:o}}async posLoad({preLoadData:e,promises:t}){return{preLoadData:e,promises:t}}}const S=async function(e,t,n,a={},o,s){const i=new(!1!==n?I:y)(e,t,a,o,s);return await i.execLoad()},D="RetrieveStudyMetadata",w=new Map;function v(e,t,n,a,o,s){if(!e)throw new Error(`${D}: Required 'dicomWebClient' parameter not provided.`);if(!t)throw new Error(`${D}: Required 'StudyInstanceUID' parameter not provided.`);if(w.has(t))return w.get(t);const i=new Promise(((i,r)=>{S(e,t,n,a,o,s).then((function(e){i(e)}),r)}));return w.set(t,i),i}function b(e){w.has(e)&&w.delete(e)}class x extends s.FH.DICOMwebClient{constructor(e){super(e),this.staticWado=e.staticWado}async searchForStudies(e){if(!this.staticWado)return super.searchForStudies(e);const t=await super.searchForStudies(e),{queryParams:n}=e;if(!n)return t;const a=this.toLowerParams(n);return t.filter((e=>{for(const t of Object.keys(x.studyFilterKeys))if(!this.filterItem(t,a,e,x.studyFilterKeys))return!1;return!0}))}async searchForSeries(e){if(!this.staticWado)return super.searchForSeries(e);const t=await super.searchForSeries(e),{queryParams:n}=e;if(!n)return t;const a=this.toLowerParams(n);return t.filter((e=>{for(const t of Object.keys(x.seriesFilterKeys))if(!this.filterItem(t,a,e,x.seriesFilterKeys))return!1;return!0}))}compareValues(e,t){if(Array.isArray(e))return e.find((e=>this.compareValues(e,t)));if(Array.isArray(t))return t.find((t=>this.compareValues(e,t)));if(t?.Alphabetic&&(t=t.Alphabetic),"string"==typeof t){if(0===t.length)return!0;if(0===e.length||"*"===e)return!0;if("*"===e[0]&&"*"===e[e.length-1])return-1!=t.indexOf(e.substring(1,e.length-1));if("*"===e[e.length-1])return-1!=t.indexOf(e.substring(0,e.length-1));if("*"===e[0])return t.indexOf(e.substring(1))===t.length-e.length+1}return e===t}compareDateRange(e,t){if(!t)return!0;const n=e.indexOf("-");if(-1===n)return this.compareValues(e,t);const a=e.substring(0,n),o=e.substring(n+1);return(!a||t>=a)&&(!o||t<=o)}filterItem(e,t,n,a){const o=a[e]||e;if(!t)return!0;const s=t[e]||t[o];if(!s)return!0;const i=n[e]||n[o];if(!i)return!1;if("DA"==i.vr)return this.compareDateRange(s,i.Value[0]);const r=i.Value;return this.compareValues(s,r)}toLowerParams(e){const t={};return Object.entries(e).forEach((([e,n])=>{t[e.toLowerCase()]=n})),t}}x.studyFilterKeys={studyinstanceuid:"0020000D",patientname:"00100010","00100020":"mrn",studydescription:"00081030",studydate:"00080020",modalitiesinstudy:"00080061",accessionnumber:"00080050"},x.seriesFilterKeys={seriesinstanceuid:"0020000E",seriesnumber:"00200011",modality:"00080060"};const C=(e,t)=>{const{wadoRoot:n,singlepart:a}=e,{instance:o,tag:s="PixelData",defaultPath:r="/pixeldata",defaultType:c="video/mp4",singlepart:l="video"}=t,d=o[s];if(!d)return;if(d.DirectRetrieveURL)return d.DirectRetrieveURL;if(d.InlineBinary){const e=i.utils.b64toBlob(d.InlineBinary,c);return d.DirectRetrieveURL=URL.createObjectURL(e),d.DirectRetrieveURL}if(!a||!0!==a&&-1===a.indexOf(l))return d.retrieveBulkData?d.retrieveBulkData().then((e=>(d.DirectRetrieveURL=URL.createObjectURL(new Blob([e],{type:c})),d.DirectRetrieveURL))):void console.warn("Unable to retrieve",s,"from",o);const{StudyInstanceUID:u,SeriesInstanceUID:m,SOPInstanceUID:p}=o,g=d&&d.BulkDataURI||`series/${m}/instances/${p}${r}`,h=-1!==g.indexOf("?"),f=-1!==g.indexOf("accept=");return"PixelData"===s||"EncapsulatedDocument"===s?`${n}/studies/${u}/series/${m}/instances/${p}/rendered`:g+(f?"":(h?"&":"?")+`accept=${c}`)};function E(e,t,n){if(e.BulkDataURI.startsWith("http")||e.BulkDataURI.startsWith("/")){if("/"===e.BulkDataURI[0]&&n.wadoRoot.startsWith("http")){const t=new URL(n.wadoRoot);e.BulkDataURI=`${t.origin}${e.BulkDataURI}`}}else"studies"===n.bulkDataURI?.relativeResolution?e.BulkDataURI=`${n.wadoRoot}/studies/${t.StudyInstanceUID}/${e.BulkDataURI}`:"series"!==n.bulkDataURI?.relativeResolution&&n.bulkDataURI?.relativeResolution||(e.BulkDataURI=`${n.wadoRoot}/studies/${t.StudyInstanceUID}/series/${t.SeriesInstanceUID}/${e.BulkDataURI}`)}const{DicomMetaDictionary:M,DicomDict:P}=h.Ay.data,{naturalizeDataset:A,denaturalizeDataset:U}=M,R="2.25.270695996825855179949881587723571202391.2.0.0",N="OHIF-VIEWER-2.0.0",T="1.2.840.10008.1.2.1",O=i.classes.MetadataProvider;function V(e,t){const{qidoRoot:n,wadoRoot:a,enableStudyLazyLoad:o,supportsFuzzyMatching:l,supportsWildcard:d,supportsReject:h,staticWado:f,singlepart:y}=e,I=JSON.parse(JSON.stringify(e)),S={url:n,staticWado:f,singlepart:y,headers:t.getAuthorizationHeader(),errorInterceptor:i.r_.getHTTPErrorHandler()},D={url:a,staticWado:f,singlepart:y,headers:t.getAuthorizationHeader(),errorInterceptor:i.r_.getHTTPErrorHandler()},w=f?new x(S):new s.FH.DICOMwebClient(S),M=f?new x(D):new s.FH.DICOMwebClient(D),V={initialize:({params:e,query:t})=>{const{StudyInstanceUIDs:n}=e,a=i.utils.splitComma(t.getAll("StudyInstanceUIDs")),o=a.length&&a||n;return o&&Array.isArray(o)?o:[o]},query:{studies:{mapParams:p.bind(),search:async function(e){const n=t.getAuthorizationHeader();n&&(w.headers=n);const{studyInstanceUid:a,seriesInstanceUid:o,...s}=p(e,{supportsFuzzyMatching:l,supportsWildcard:d})||{};return u(await m(w,0,0,s))},processResults:u.bind()},series:{search:async function(e){const n=t.getAuthorizationHeader();n&&(w.headers=n);return function(e){const t=[];return e&&e.length&&e.forEach((e=>t.push({studyInstanceUid:c(e["0020000D"]),seriesInstanceUid:c(e["0020000E"]),modality:c(e["00080060"]),seriesNumber:c(e["00200011"]),seriesDate:i.utils.formatDate(c(e["00080021"])),numSeriesInstances:Number(c(e["00201209"])),description:c(e["0008103E"])}))),(0,r.LM)(t),t}(await function(e,t){const n={includefield:["0008103E","00080021"].join(",")};return e.searchForSeries({studyInstanceUID:t,queryParams:n})}(w,e))}},instances:{search:(e,n)=>{const a=t.getAuthorizationHeader();a&&(w.headers=a),m.call(void 0,w,e,null,n)}}},retrieve:{directURL:e=>C({wadoRoot:a,singlepart:y},e),bulkDataURI:async({StudyInstanceUID:e,BulkDataURI:t})=>{const n={multipart:!1,BulkDataURI:t,StudyInstanceUID:e};return w.retrieveBulkData(n).then((e=>e&&e[0]||void 0))},series:{metadata:async({StudyInstanceUID:e,filters:n,sortCriteria:a,sortFunction:s,madeInClient:i=!1}={})=>{const r=t.getAuthorizationHeader();if(r&&(M.headers=r),!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");return o?V._retrieveSeriesMetadataAsync(e,n,a,s,i):V._retrieveSeriesMetadataSync(e,n,a,s,i)}}},store:{dicom:async(e,n)=>{const a=t.getAuthorizationHeader();if(a&&(M.headers=a),e instanceof ArrayBuffer){const t={datasets:[e],request:n};await M.storeInstances(t)}else{const t={FileMetaInformationVersion:e._meta.FileMetaInformationVersion.Value,MediaStorageSOPClassUID:e.SOPClassUID,MediaStorageSOPInstanceUID:e.SOPInstanceUID,TransferSyntaxUID:T,ImplementationClassUID:R,ImplementationVersionName:N},a=U(t),o=new P(a);o.dict=U(e);const s={datasets:[o.write()],request:n};await M.storeInstances(s)}}},_retrieveSeriesMetadataSync:async(e,t,n,a,o)=>{const s=(await v(M,e,!1,t,n,a)).map(A),r={},c={};s.forEach((t=>{r[t.SeriesInstanceUID]||(r[t.SeriesInstanceUID]={StudyInstanceUID:t.StudyInstanceUID,StudyDescription:t.StudyDescription,SeriesInstanceUID:t.SeriesInstanceUID,SeriesDescription:t.SeriesDescription,SeriesNumber:t.SeriesNumber,SeriesTime:t.SeriesTime,SOPClassUID:t.SOPClassUID,ProtocolName:t.ProtocolName,Modality:t.Modality}),c[t.SeriesInstanceUID]||(c[t.SeriesInstanceUID]=[]);const n=V.getImageIdsForInstance({instance:t});t.imageId=n,O.addImageIdToUIDs(n,{StudyInstanceUID:e,SeriesInstanceUID:t.SeriesInstanceUID,SOPInstanceUID:t.SOPInstanceUID}),c[t.SeriesInstanceUID].push(t)}));const l=Object.values(r);i.DicomMetadataStore.addSeriesMetadata(l,o),Object.keys(c).forEach((e=>i.DicomMetadataStore.addInstances(c[e],o)))},_retrieveSeriesMetadataAsync:async(t,n,a,o,s=!1)=>{const{preLoadData:r,promises:c}=await v(M,t,!0,n,a,o),l=t=>{const n=A(t);return e.bulkDataURI?.enabled?(Object.keys(n).forEach((t=>{const a=n[t];a&&a.BulkDataURI&&!a.Value&&(a.retrieveBulkData=()=>{E(a,n,e);const t={multipart:!1,BulkDataURI:a.BulkDataURI,StudyInstanceUID:n.StudyInstanceUID};return w.retrieveBulkData(t).then((e=>{const t=e instanceof Array&&e.find((e=>e?.byteLength))||void 0;return a.Value=t,t}))})})),n):n};r.forEach((e=>{e.StudyInstanceUID=t})),i.DicomMetadataStore.addSeriesMetadata(r,s);const d=c.map((n=>n.then((n=>{!function(n){const a=n.map(l);a.forEach(((n,a)=>{n.wadoRoot=e.wadoRoot,n.wadoUri=e.wadoUri;const o=V.getImageIdsForInstance({instance:n});n.imageId=o,O.addImageIdToUIDs(o,{StudyInstanceUID:t,SeriesInstanceUID:n.SeriesInstanceUID,SOPInstanceUID:n.SOPInstanceUID})})),i.DicomMetadataStore.addInstances(a,s)}(n)}))));await Promise.all(d),i.DicomMetadataStore.getStudy(t,s).isLoaded=!0},deleteStudyMetadataPromise:b,getImageIdsForDisplaySet(e){const t=e.images,n=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let a=1;a<=t;a++){const t=this.getImageIdsForInstance({instance:e,frame:a});n.push(t)}else{const t=this.getImageIdsForInstance({instance:e});n.push(t)}})),n):n},getImageIdsForInstance:({instance:t,frame:n})=>g({instance:t,frame:n,config:e}),getConfig:()=>I};return h&&(V.reject=function(e){return{series:(t,n)=>new Promise(((a,o)=>{const s=`${e}/studies/${t}/series/${n}/reject/113001%5EDCM`,i=new XMLHttpRequest;i.open("POST",s,!0),console.log(i),i.onreadystatechange=function(){if(4==i.readyState)switch(i.status){case 204:a(i.responseText);break;case 404:o("Your dataSource does not support reject functionality")}},i.send()}))}}(a)),i.pt.create(V)}const L=i.Ay.classes.MetadataProvider,k={studyInstanceUid:"StudyInstanceUID",patientId:"PatientID"};let F={urls:[]};const B=e=>F.urls.find((t=>t.url===e)),$=(e,t)=>{let n=[];return F.urls.map((a=>{a.studies.map((a=>{a[e]===t&&n.push(a)}))})),n};function z(e){const{name:t,wadoRoot:n}=e,a={initialize:async({params:e,query:t,url:n})=>{n||(n=t.get("url"));let a=B(n);if(a)return a.studies.map((e=>e.StudyInstanceUID));const o=await fetch(n);let s=await o.json();const i=s.studies.map((e=>e.StudyInstanceUID));let r,c;return s.studies.forEach((e=>{r=e.StudyInstanceUID,e.series.forEach((e=>{c=e.SeriesInstanceUID,e.instances.forEach((e=>{const{url:t,metadata:n}=e;L.addImageIdToUIDs(t,{StudyInstanceUID:r,SeriesInstanceUID:c,SOPInstanceUID:n.SOPInstanceUID})}))}))})),F.urls.push({url:n,studies:[...s.studies]}),i},query:{studies:{mapParams:()=>{},search:async e=>{const[t,n]=Object.entries(e)[0],a=k[t];return $(a,n).map((e=>({accession:e.AccessionNumber,date:e.StudyDate,description:e.StudyDescription,instances:e.NumInstances,modalities:e.Modalities,mrn:e.PatientID,patientName:e.PatientName,studyInstanceUid:e.StudyInstanceUID,NumInstances:e.NumInstances,time:e.StudyTime})))},processResults:()=>{console.debug(" DICOMJson QUERY processResults")}},series:{search:()=>{console.debug(" DICOMJson QUERY SERIES SEARCH")}},instances:{search:()=>{console.debug(" DICOMJson QUERY instances SEARCH")}}},retrieve:{directURL:e=>C(n,e),series:{metadata:({StudyInstanceUID:e,madeInClient:t=!1,customSort:n}={})=>{if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const a=$("StudyInstanceUID",e)[0];let o;o=n?n(a.series):a.series;const s=o.map((e=>{const t={StudyInstanceUID:a.StudyInstanceUID,...e};return delete t.instances,t}));i.DicomMetadataStore.addSeriesMetadata(s,t);const r=o.length;o.forEach(((n,o)=>{const s=n.instances.map((e=>{const t={...e.metadata,url:e.url,imageId:e.url,...n,...a};return delete t.instances,delete t.series,t}));var c;c=s,i.DicomMetadataStore.addInstances(c,t),o===r-1&&(i.DicomMetadataStore.getStudy(e,t).isLoaded=!0)}))}}},store:{dicom:()=>{console.debug(" DICOMJson store dicom")}},getImageIdsForDisplaySet(t){const n=t.images,a=[];return n?(t.images.forEach((t=>{const n=t.NumberOfFrames;if(n>1)for(let o=0;o<n;o++){const n=g({instance:t,frame:o,config:e});a.push(n)}else{const n=g({instance:t,config:e});a.push(n)}})),a):a},getImageIdsForInstance:({instance:e,frame:t})=>g({instance:e,frame:t})};return i.pt.create(a)}const q=i.Ay.classes.MetadataProvider,{EVENTS:G}=i.DicomMetadataStore,H={SR:!0,SEG:!0,DOC:!0},_=(e,t,n=0)=>e===t?n:e<t?-1:1,j=(e,t)=>{const n=e.instances[0],a=t.instances[0],o=n.Modality,s=a.Modality,i=H[o],r=H[s];return i&&r?_(n.SeriesNumber,a.SeriesNumber):i||r?i?-1:1:_(a.SeriesNumber,n.SeriesNumber)};function W(e){const{name:t}=e,n={initialize:({params:e,query:t})=>{const{StudyInstanceUIDs:n}=e,a=t.getAll("StudyInstanceUIDs")||n,o=a&&Array.isArray(a)?a:[a];return o.forEach((e=>{const t=i.DicomMetadataStore.getStudy(e);t.series=t.series.sort(j)})),o},query:{studies:{mapParams:()=>{},search:e=>i.DicomMetadataStore.getStudyInstanceUIDs().map((e=>{let t=0;const n=new Set,a=i.DicomMetadataStore.getStudy(e);a.series.forEach((e=>{t+=e.instances.length,n.add(e.instances[0].Modality)}));const o=a?.series[0]?.instances[0];if(o)return{accession:o.AccessionNumber,date:o.StudyDate,description:o.StudyDescription,mrn:o.PatientID,patientName:i.utils.formatPN(o.PatientName),studyInstanceUid:o.StudyInstanceUID,time:o.StudyTime,instances:t,modalities:Array.from(n).join("/"),NumInstances:t}})),processResults:()=>{console.debug(" DICOMLocal QUERY processResults")}},series:{search:e=>i.DicomMetadataStore.getStudy(e).series.map((t=>{const n=t?.instances[0];return{studyInstanceUid:e,seriesInstanceUid:n.SeriesInstanceUID,modality:n.Modality,seriesNumber:n.SeriesNumber,seriesDate:n.SeriesDate,numSeriesInstances:t.instances.length,description:n.SeriesDescription}}))},instances:{search:()=>{console.debug(" DICOMLocal QUERY instances SEARCH")}}},retrieve:{directURL:e=>{const{instance:t,tag:n,defaultType:a}=e,o=t[n];if(o instanceof Array&&o[0]instanceof ArrayBuffer)return URL.createObjectURL(new Blob([o[0]],{type:a}))},series:{metadata:async({StudyInstanceUID:e,madeInClient:t=!1}={})=>{if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const n=i.DicomMetadataStore.getStudy(e,t);i.DicomMetadataStore._broadcastEvent(G.SERIES_ADDED,{StudyInstanceUID:e,madeInClient:t}),n.series.forEach((n=>{const{SeriesInstanceUID:a}=n,o=n.instances[0].NumberOfFrames>1;n.instances.forEach(((e,t)=>{const{url:n,StudyInstanceUID:a,SeriesInstanceUID:s,SOPInstanceUID:i}=e;e.imageId=n,q.addImageIdToUIDs(n,{StudyInstanceUID:a,SeriesInstanceUID:s,SOPInstanceUID:i,frameIndex:o?t:1})})),i.DicomMetadataStore._broadcastEvent(G.INSTANCES_ADDED,{StudyInstanceUID:e,SeriesInstanceUID:a,madeInClient:t})}))}}},store:{dicom:e=>{const t=h.Ay.data.datasetToBlob(e);var n=URL.createObjectURL(t);window.location.assign(n)}},getImageIdsForDisplaySet(e){const t=e.images,n=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let a=1;a<=t;a++){const t=this.getImageIdsForInstance({instance:e,frame:a});n.push(t)}else{const t=this.getImageIdsForInstance({instance:e});n.push(t)}})),n):n},getImageIdsForInstance({instance:e,frame:t}){const{StudyInstanceUID:n,SeriesInstanceUID:a,SOPInstanceUID:o}=e;let s=i.DicomMetadataStore.getInstance(n,a,o).url;return void 0!==t&&(s+=`&frame=${t}`),s},deleteStudyMetadataPromise(){console.log("deleteStudyMetadataPromise not implemented")}};return i.pt.create(n)}function Q(e,t){const{name:n}=e;let a;const o={initialize:async({params:e,query:o})=>{let s=[];const i=o.get("studyInstanceUIDs")||o.get("studyInstanceUids");if(!i)throw new Error(`No studyInstanceUids in request for '${n}'`);const r=o.get("url");if(!r)throw new Error(`No url for '${n}'`);{const e=await fetch(r);let n=await e.json();if(!n.servers?.dicomWeb?.[0])throw new Error("Invalid configuration returned by url");a=V(n.servers.dicomWeb[0],t),s=i.split(";")}return s},query:{studies:{search:e=>a.query.studies.search(e)},series:{search:(...e)=>a.query.series.search(...e)},instances:{search:(e,t)=>a.query.instances.search(e,t)}},retrieve:{directURL:(...e)=>a.retrieve.directURL(...e),series:{metadata:(...e)=>a.retrieve.series.metadata(...e)}},store:{dicom:(...e)=>a.store(...e)},deleteStudyMetadataPromise:(...e)=>a.deleteStudyMetadataPromise(...e),getImageIdsForDisplaySet:(...e)=>a.getImageIdsForDisplaySet(...e),getImageIdsForInstance:(...e)=>a.getImageIdsForInstance(...e)};return i.pt.create(o)}const Y=function(){return[{name:"dicomweb",type:"webApi",createDataSource:V},{name:"dicomwebproxy",type:"webApi",createDataSource:Q},{name:"dicomjson",type:"jsonApi",createDataSource:z},{name:"dicomlocal",type:"localApi",createDataSource:W}]};var X=n(86326),K=n(97598),J=n.n(K),Z=n(49348),ee=n(99993),te=n(67435),ne=n(7800),ae=n(99418),oe=n(78697),se=n(55530),ie=n.n(se);function re(){return re=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},re.apply(this,arguments)}function ce({servicesManager:e}){const{toolbarService:t}=e.services,[n,a]=(0,X.useState)([]),[o,s]=(0,X.useState)({primaryToolId:"",toggles:{},groups:{}});return(0,X.useEffect)((()=>{const{unsubscribe:e}=t.subscribe(t.EVENTS.TOOL_BAR_MODIFIED,(()=>a(t.getButtonSection("primary")))),{unsubscribe:n}=t.subscribe(t.EVENTS.TOOL_BAR_STATE_MODIFIED,(()=>s({...t.state})));return()=>{e(),n()}}),[t]),X.createElement(X.Fragment,null,n.map(((n,a)=>{const{id:s,Component:i,componentProps:r}=n;let c;return"toggle"===r.type&&(c=o.toggles[s]),X.createElement("div",{key:s,className:ie()("mr-1")},X.createElement(i,re({id:s},r,{bState:o,isActive:c,onInteraction:e=>t.recordInteraction(e),servicesManager:e})))})))}const{availableLanguages:le,defaultLanguage:de,currentLanguage:ue}=ae.A;function me({extensionManager:e,servicesManager:t,hotkeysManager:n,commandsManager:a,viewports:o,ViewportGridComp:s,leftPanels:r=[],rightPanels:c=[],leftPanelDefaultClosed:l=!1,rightPanelDefaultClosed:d=!1}){const[u]=(0,oe.r)(),m=(0,Z.Zp)(),p=(0,te.zy)(),{t:g}=(0,ee.Bd)(),{show:h,hide:f}=(0,ne.hS)(),[y,I]=(0,X.useState)(u.showLoadingIndicator),{hangingProtocolService:S}=t.services,{hotkeyDefinitions:D,hotkeyDefaults:w}=n,v=[{title:g("Header:About"),icon:"info",onClick:()=>h({content:ne.VT,title:"About OHIF Viewer",contentProps:{versionNumber:"3.7.0-beta.3",commitHash:"cadb559619306a5900d7a2b92e43bdd161036bd4"}})},{title:g("Header:Preferences"),icon:"settings",onClick:()=>h({title:g("UserPreferencesModal:User Preferences"),content:ne.im,contentProps:{hotkeyDefaults:n.getValidHotkeyDefinitions(w),hotkeyDefinitions:D,currentLanguage:ue(),availableLanguages:le,defaultLanguage:de,onCancel:()=>{i.ot.stopRecord(),i.ot.unpause(),f()},onSubmit:({hotkeyDefinitions:e,language:t})=>{ae.A.changeLanguage(t.value),n.setHotkeys(e),f()},onReset:()=>n.restoreDefaultBindings(),hotkeysModule:i.ot}})}];u.oidc&&v.push({title:g("Header:Logout"),icon:"power-off",onClick:async()=>{m(`/logout?redirect_uri=${encodeURIComponent(window.location.href)}`)}}),(0,X.useEffect)((()=>(document.body.classList.add("bg-black"),document.body.classList.add("overflow-hidden"),()=>{document.body.classList.remove("bg-black"),document.body.classList.remove("overflow-hidden")})),[]);const b=t=>{const n=e.getModuleEntry(t);if(!n)throw new Error(`${t} is not a valid entry for an extension module, please check your configuration or make sure the extension is registered.`);let a;if(!n||!n.component)throw new Error(`No component found from extension ${t}. Check the reference string to the extension in your Mode configuration`);return a=n.component,{entry:n,content:a}},x=e=>{const{content:t,entry:n}=b(e);return{id:n.id,iconName:n.iconName,iconLabel:n.iconLabel,label:n.label,name:n.name,content:t}};(0,X.useEffect)((()=>{const{unsubscribe:e}=S.subscribe(i.Qe.EVENTS.PROTOCOL_CHANGED,(()=>{I(!1)}));return()=>{e()}}),[S]);const C=r.map(x),E=c.map(x),M=o.map((e=>{const{entry:t}=b(e.namespace);return{component:t.component,displaySetsToDisplay:e.displaySetsToDisplay}}));return X.createElement("div",null,X.createElement(ne.Y9,{menuOptions:v,isReturnEnabled:!!u.showStudyList,onClickReturnButton:()=>{const{pathname:e}=p,t=e.indexOf("/",1),n=new URLSearchParams(window.location.search).get("configUrl"),a=new URLSearchParams;-1!==t&&a.append("datasources",e.substring(t+1)),n&&a.append("configUrl",n),m({pathname:"/",search:decodeURIComponent(a.toString())})},WhiteLabeling:u.whiteLabeling},X.createElement(ne.tH,{context:"Primary Toolbar"},X.createElement("div",{className:"relative flex justify-center"},X.createElement(ce,{servicesManager:t})))),X.createElement("div",{className:"bg-black flex flex-row items-stretch w-full overflow-hidden flex-nowrap relative",style:{height:"calc(100vh - 52px"}},X.createElement(X.Fragment,null,y&&X.createElement(ne.Jx,{className:"h-full w-full bg-black"}),C.length?X.createElement(ne.tH,{context:"Left Panel"},X.createElement(ne.wv,{side:"left",activeTabIndex:l?null:0,tabs:C,servicesManager:t})):null,X.createElement("div",{className:"flex flex-col flex-1 h-full"},X.createElement("div",{className:"flex items-center justify-center flex-1 h-full overflow-hidden bg-black relative"},X.createElement(ne.tH,{context:"Grid"},X.createElement(s,{servicesManager:t,viewportComponents:M,commandsManager:a})))),E.length?X.createElement(ne.tH,{context:"Right Panel"},X.createElement(ne.wv,{side:"right",activeTabIndex:d?null:0,tabs:E,servicesManager:t})):null)))}me.propTypes={extensionManager:J().shape({getModuleEntry:J().func.isRequired}).isRequired,commandsManager:J().instanceOf(i.Sp),servicesManager:J().instanceOf(i.CS),leftPanels:J().array,rightPanels:J().array,leftPanelDefaultClosed:J().bool.isRequired,rightPanelDefaultClosed:J().bool.isRequired,children:J().oneOfType([J().node,J().func]).isRequired};const pe=me;const{sortStudyInstances:ge,formatDate:he}=i.utils;function fe({servicesManager:e,getImageSrc:t,getStudiesForPatientByMRN:n,requestDisplaySetCreationForStudy:a,dataSource:o}){const{hangingProtocolService:s,displaySetService:i,uiNotificationService:r}=e.services,{StudyInstanceUIDs:c}=(0,ne.Bz)(),[{activeViewportIndex:l,viewports:d},u]=(0,ne.ih)(),[m,p]=(0,X.useState)("primary"),[g,h]=(0,X.useState)([...c]),[f,y]=(0,X.useState)([]),[I,S]=(0,X.useState)([]),[D,w]=(0,X.useState)({}),v=(0,X.useRef)(!0);(0,X.useEffect)((()=>{c.forEach((e=>async function(e){const t=await o.query.studies.search({studyInstanceUid:e});let a=t;try{a=await n(t)}catch(e){console.warn(e)}const s=a.map((e=>({AccessionNumber:e.accession,StudyDate:e.date,StudyDescription:e.description,NumInstances:e.instances,ModalitiesInStudy:e.modalities,PatientID:e.mrn,PatientName:e.patientName,StudyInstanceUID:e.studyInstanceUid,StudyTime:e.time}))).map((e=>({studyInstanceUid:e.StudyInstanceUID,date:he(e.StudyDate),description:e.StudyDescription,modalities:e.ModalitiesInStudy,numInstances:e.NumInstances})));y((e=>{const t=[...e];for(const n of s)e.find((e=>e.studyInstanceUid===n.studyInstanceUid))||t.push(n);return t}))}(e)))}),[c,n]),(0,X.useEffect)((()=>(i.activeDisplaySets.forEach((async e=>{const n={},a=i.getDisplaySetByUID(e.displaySetInstanceUID),s=o.getImageIdsForDisplaySet(a),r=s[Math.floor(s.length/2)];r&&(n[e.displaySetInstanceUID]=await t(r),v.current&&w((e=>({...e,...n}))))})),()=>{v.current=!1})),[]),(0,X.useEffect)((()=>{const e=Ie(i.activeDisplaySets,D);ge(e),S(e)}),[D]),(0,X.useEffect)((()=>{const e=i.subscribe(i.EVENTS.DISPLAY_SETS_ADDED,(e=>{const{displaySetsAdded:n}=e;n.forEach((async e=>{const n={},a=i.getDisplaySetByUID(e.displaySetInstanceUID),s=o.getImageIdsForDisplaySet(a),r=s[Math.floor(s.length/2)];r&&(n[e.displaySetInstanceUID]=await t(r,e.initialViewport),v.current&&w((e=>({...e,...n}))))}))})),n=i.subscribe(i.EVENTS.DISPLAY_SETS_CHANGED,(e=>{const t=Ie(e,D);S(t)}));return()=>{e.unsubscribe(),n.unsubscribe()}}),[]);const b=function(e,t,n){const a=[],o=[],s=[];t.forEach((t=>{const i=n.filter((e=>e.StudyInstanceUID===t.studyInstanceUid)),r=Object.assign({},t,{displaySets:i});e.includes(t.studyInstanceUid)?a.push(r):(o.push(r),s.push(r))}));const i=[{name:"primary",label:"Primary",studies:a},{name:"recent",label:"Recent",studies:o},{name:"all",label:"All",studies:s}];return i}(c,f,I);const x=d[l]?.displaySetInstanceUIDs;return X.createElement(ne.M4,{tabs:b,servicesManager:e,activeTabName:m,onDoubleClickThumbnail:e=>{let t=[];const n=l;try{t=s.getViewportsRequireUpdate(n,e)}catch(e){console.warn(e),r.show({title:"Thumbnail Double Click",message:"The selected display sets could not be added to the viewport.",type:"info",duration:3e3})}u.setDisplaySetsForViewports(t)},activeDisplaySetInstanceUIDs:x,expandedStudyInstanceUIDs:g,onClickStudy:function(e){const t=g.includes(e),n=t?[...g.filter((t=>t!==e))]:[...g,e];if(h(n),!t){a(i,e,!0)}},onClickTab:e=>{p(e)}})}fe.propTypes={servicesManager:J().object.isRequired,dataSource:J().shape({getImageIdsForDisplaySet:J().func.isRequired}).isRequired,getImageSrc:J().func.isRequired,getStudiesForPatientByMRN:J().func.isRequired,requestDisplaySetCreationForStudy:J().func.isRequired};const ye=fe;function Ie(e,t){const n=[],a=[];return e.filter((e=>!e.excludeFromThumbnailBrowser)).forEach((e=>{const o=t[e.displaySetInstanceUID],s=function(e){if(Se.includes(e))return"thumbnailNoImage";return"thumbnail"}(e.Modality);("thumbnail"===s?n:a).push({displaySetInstanceUID:e.displaySetInstanceUID,description:e.SeriesDescription||"",seriesNumber:e.SeriesNumber,modality:e.Modality,seriesDate:e.SeriesDate,seriesTime:e.SeriesTime,numInstances:e.numImageFrames,countIcon:e.countIcon,StudyInstanceUID:e.StudyInstanceUID,componentType:s,imageSrc:o,dragData:{type:"displayset",displaySetInstanceUID:e.displaySetInstanceUID}})})),[...n,...a]}const Se=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"];const De=function(e,t){return new Promise(((n,a)=>{const o=document.createElement("canvas");e.utilities.loadImageToCanvas({canvas:o,imageId:t}).then((e=>{n(o.toDataURL())})).catch(a)}))};const we=async function(e,t){return t&&t.length&&t[0].mrn?e.query.studies.search({patientId:t[0].mrn}):(console.log("No mrn found for",t),t)};const ve=function(e,t,n,a){t.activeDisplaySets.some((e=>e.StudyInstanceUID===n))||e.retrieve.series.metadata({StudyInstanceUID:n,madeInClient:a})};function be({commandsManager:e,extensionManager:t,servicesManager:n}){const a=t.getDataSources()[0],o=we.bind(null,a),s=function(e){const t=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common");try{const{cornerstone:e}=t.exports.getCornerstoneLibraries();return De.bind(null,e)}catch(e){throw new Error("Required command not found")}}(t),i=ve.bind(null,a);return X.createElement(ye,{servicesManager:n,dataSource:a,getImageSrc:s,getStudiesForPatientByMRN:o,requestDisplaySetCreationForStudy:i})}be.propTypes={commandsManager:J().object.isRequired,extensionManager:J().object.isRequired,servicesManager:J().object.isRequired};const xe=be;function Ce({onExportClick:e,onCreateReportClick:t}){const{t:n}=(0,ee.Bd)("MeasurementTable");return X.createElement(X.Fragment,null,X.createElement(ne.e2,{color:"black",size:"inherit"},X.createElement(ne.$n,{className:"px-2 py-2 text-base",onClick:e},n("Export CSV")),X.createElement(ne.$n,{className:"px-2 py-2 text-base",onClick:t},n("Create Report"))))}Ce.propTypes={onExportClick:J().func,onCreateReportClick:J().func},Ce.defaultProps={onExportClick:()=>alert("Export"),onCreateReportClick:()=>alert("Create Report")};const Ee=Ce;var Me=n(62051),Pe=n.n(Me);const Ae={CANCEL:0,CREATE_REPORT:1};function Ue(){return X.createElement("div",{className:"text-primary-active"},"Loading...")}const Re=async function(e,t,n,a,o){const{displaySetService:s,uiNotificationService:r,uiDialogService:c}=e.services,l=c.create({showOverlay:!0,isDraggable:!1,centralize:!0,content:Ue});try{const e=await t.runCommand("storeMeasurements",{measurementData:a,dataSource:n,additionalFindingTypes:["ArrowAnnotate"],options:o},"CORNERSTONE_STRUCTURED_REPORT");i.DicomMetadataStore.addInstances([e],!0);const c=s.getMostRecentDisplaySet();return r.show({title:"Create Report",message:"Measurements saved successfully",type:"success"}),[c]}catch(e){r.show({title:"Create Report",message:e.message||"Failed to store measurements",type:"error"})}finally{c.dismiss({id:l})}},Ne=4700;function Te(e,t){const n=t.getActiveDisplaySets().filter((e=>"SR"===e.Modality)).find((t=>t.SeriesDescription===e));if(n){console.log("Storing to same series",n);const{instance:e}=n,{SeriesInstanceUID:t,SeriesDescription:a,SeriesDate:o,SeriesTime:s,SeriesNumber:i,Modality:r}=e;return{SeriesInstanceUID:t,SeriesDescription:a,SeriesDate:o,SeriesTime:s,SeriesNumber:i,Modality:r,InstanceNumber:n.instances.length+1}}const a=function(e){const t=e.getActiveDisplaySets().filter((e=>"SR"===e.Modality)).map((e=>e.SeriesNumber));return Math.max(...t,Ne)+1}(t);return{SeriesDescription:e,SeriesNumber:a}}const{downloadCSVReport:Oe}=i.utils;function Ve({servicesManager:e,commandsManager:t,extensionManager:n}){const[a,o]=(0,ne.ih)(),{activeViewportIndex:s,viewports:i}=a,{measurementService:r,uiDialogService:c,uiNotificationService:l,displaySetService:d}=e.services,[u,m]=(0,X.useState)([]);(0,X.useEffect)((()=>{const e=Pe()(m,100);m(Le(r));const t=r.EVENTS.MEASUREMENT_ADDED,n=r.EVENTS.RAW_MEASUREMENT_ADDED,a=r.EVENTS.MEASUREMENT_UPDATED,o=r.EVENTS.MEASUREMENT_REMOVED,s=r.EVENTS.MEASUREMENTS_CLEARED,i=[];return[t,n,a,o,s].forEach((t=>{i.push(r.subscribe(t,(()=>{e(Le(r))})).unsubscribe)})),()=>{i.forEach((e=>{e()})),e.cancel()}}),[]);const p=({uid:e,isActive:t})=>{if(!t){const t=[...u],n=t.find((t=>t.uid===e));t.forEach((t=>t.isActive=t.uid===e)),n.isActive=!0,m(t)}};return X.createElement(X.Fragment,null,X.createElement("div",{className:"overflow-x-hidden overflow-y-auto ohif-scrollbar","data-cy":"measurements-panel"},X.createElement(ne.V,{title:"Measurements",servicesManager:e,data:u,onClick:({uid:e,isActive:t})=>{r.jumpToMeasurement(a.activeViewportIndex,e),p({uid:e,isActive:t})},onEdit:({uid:e,isActive:t})=>{const n=r.getMeasurement(e),a=({action:t,value:a})=>{if("save"===t.id)r.update(e,{...n,...a},!0);c.dismiss({id:"enter-annotation"})};c.create({id:"enter-annotation",centralize:!0,isDraggable:!1,showOverlay:!0,content:ne.lG,contentProps:{title:"Annotation",noCloseButton:!0,value:{label:n.label||""},body:({value:e,setValue:t})=>X.createElement(ne.pd,{label:"Enter your annotation",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,id:"annotation",className:"bg-black border-primary-main",type:"text",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&a({value:e,action:{id:"save"}})}}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:a}})}})),X.createElement("div",{className:"flex justify-center p-4"},X.createElement(Ee,{onExportClick:async function(){const e=r.getMeasurements();Oe(e,r)},onClearMeasurementsClick:async function(){r.clearMeasurements()},onCreateReportClick:async function(){const a=i[s],o=r.getMeasurements(),u=d.getDisplaySetByUID(a.displaySetInstanceUIDs[0]),m=o.filter((e=>u.StudyInstanceUID===e.referenceStudyUID));if(m.length<=0)return void l.show({title:"No Measurements",message:"No Measurements are added to the current Study.",type:"info",duration:3e3});const p=await function(e,{extensionManager:t}){return new Promise((function(n,a){let o;const s=Object.keys(t.dataSourceMap).filter((e=>{const n=t.dataSourceDefs[e]?.configuration;return n?.supportsStow??n?.wadoRoot})).map((e=>({value:e,label:e,placeHolder:e})));o=e.create({centralize:!0,isDraggable:!1,content:ne.lG,useLastPosition:!1,showOverlay:!0,contentProps:{title:"Create Report",value:{label:"",dataSourceName:t.activeDataSource},noCloseButton:!0,onClose:()=>{e.dismiss({id:o}),n({action:Ae.CANCEL,value:void 0,dataSourceName:void 0})},actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:({action:t,value:a})=>{switch(e.dismiss({id:o}),t.id){case"save":n({action:Ae.CREATE_REPORT,value:a.label,dataSourceName:a.dataSourceName});break;case"cancel":n({action:Ae.CANCEL,value:void 0,dataSourceName:void 0})}},body:({value:t,setValue:a})=>X.createElement(X.Fragment,null,s.length>1&&X.createElement(ne.l6,{closeMenuOnSelect:!0,className:"mr-2 bg-black border-primary-main",options:s,placeholder:s.find((e=>e.value===t.dataSourceName)).placeHolder,value:t.dataSourceName,onChange:e=>{a((t=>({...t,dataSourceName:e.value})))},isClearable:!1}),X.createElement(ne.pd,{autoFocus:!0,label:"Enter the report name",labelClassName:"text-white text-[14px] leading-[1.2]",className:"bg-black border-primary-main",type:"text",value:t.label,onChange:e=>{e.persist(),a((t=>({...t,label:e.target.value})))},onKeyPress:a=>{"Enter"===a.key&&(e.dismiss({id:o}),n({action:Ae.CREATE_REPORT,value:t.label}))},required:!0}))}})}))}(c,{extensionManager:n});if(p.action===Ae.CREATE_REPORT){const a=n.getDataSources(p.dataSourceName)[0],o=Te(void 0===p.value||""===p.value?"Research Derived Series":p.value,d);return Re(e,t,a,m,o)}}})))}function Le(e){return e.getMeasurements().map(((t,n)=>function(e,t,n){const{displayText:a,uid:o,label:s,type:i,selected:r,findingSites:c,finding:l}=e,d=c?.[0],u=s||l?.text||d?.text||"(empty)";let m=a||[];if(c){const e=[];c.forEach((t=>{t?.text!==u&&e.push(t.text)})),m=[...e,...m]}l&&l?.text!==u&&(m=[l.text,...m]);return{uid:o,label:u,baseLabel:s,measurementType:i,displayText:m,baseDisplayText:a,isActive:r,finding:l,findingSites:c}}(t,0,e.VALUE_TYPES)))}Ve.propTypes={servicesManager:J().instanceOf(i.CS).isRequired};var ke=n(82409),Fe=n(7019),Be=n(11855),$e=n(9860),ze=n(92244),qe=n(71545),Ge=(n(34603),n(42008)),He=n(87275);const _e=class{constructor(e){this._extractGroup=e=>{const t=[],n=[];for(this.visitedCells[e[0]]=!0;e.length>0;){const a=e.shift();t.push(a);const o=this.polyData.getCellPoints(a).cellPointIds;for(const t of o)if(!this.visitedPoints[t]){this.visitedPoints[t]=!0,n.push(t);for(const n of this.polyData.getPointCells(t))this.visitedCells[n]||(this.visitedCells[n]=!0,e.push(n))}}return[t,n]},this._buildExtractedPolyData=(e,t)=>{const n=[],a=[],o={};t.forEach(((e,t)=>{o[e]=t;const a=this.polyData.getPoints().getPoint(e);n.push(...a)}));for(const t of e){const e=this.polyData.getCellPoints(t).cellPointIds.map((e=>o[e]));a.push(3),a.push(...e)}const s=He.Ay.newInstance();return s.getPoints().setData(new Float32Array(n),3),s.getPolys().setData(new Uint32Array(a)),s.getPolys().setNumberOfComponents(4),s},this.extractGroups=()=>{const e=[];for(let t=0;t<this.polyData.getNumberOfCells();t++)if(!this.visitedCells[t]){const[n,a]=this._extractGroup([t]),o=this._buildExtractedPolyData(n,a);e.push(o)}return e},console.assert(e.getLinks(),"PolyDataExtractor: No links built for polydata"),this.polyData=e,this.visitedCells=new Array(e.getNumberOfCells()).fill(!1),this.visitedPoints=new Array(e.getNumberOfPoints()).fill(!1)}};var je=n(84607);const We=n(37234);class Qe{constructor(e){this.add=e=>(this.Axx+=e.Axx,this.Axy+=e.Axy,this.Axz+=e.Axz,this.Ayy+=e.Ayy,this.Ayz+=e.Ayz,this.Azz+=e.Azz,this.bx+=e.bx,this.by+=e.by,this.bz+=e.bz,this.c+=e.c,this),this.getCentroid=e=>{const[t,n,a]=e;return[(t[0]+n[0]+a[0])/3,(t[1]+n[1]+a[1])/3,(t[2]+n[2]+a[2])/3]},this.getNormal=e=>{const[t,n,a]=e;let o=new Array(3),s=new Array(3),i=new Array(3);return je.Ay.subtract(n,t,o),je.Ay.subtract(a,t,s),je.Ay.cross(o,s,i),je.Ay.normalize(i),i},this.evaluate=e=>{const t=this.Axx*e[0]+this.Axy*e[1]+this.Axz*e[2],n=this.Axy*e[0]+this.Ayy*e[1]+this.Ayz*e[2],a=this.Axz*e[0]+this.Ayz*e[1]+this.Azz*e[2];return e[0]*t+e[1]*n+e[2]*a+2*(e[0]*this.bx+e[1]*this.by+e[2]*this.bz)+this.c},this.optimalPoint=e=>{let t=this.Azz*this.Ayy-this.Ayz*this.Ayz,n=this.Axz*this.Ayz-this.Azz*this.Axy,a=this.Axy*this.Ayz-this.Axz*this.Ayy,o=this.Azz*this.Axx-this.Axz*this.Axz,s=this.Axy*this.Axz-this.Axx*this.Ayz,i=this.Axx*this.Ayy-this.Axy*this.Axy,r=this.Axx*t+this.Axy*n+this.Axz*a;return We.abs(r)>1e-9&&(r=1/r,t*=r,n*=r,a*=r,o*=r,s*=r,i*=r,e[0]=-(t*this.bx+n*this.by+a*this.bz),e[1]=-(n*this.bx+o*this.by+s*this.bz),e[2]=-(a*this.bx+s*this.by+i*this.bz),!0)};const t=this.getNormal(e),n=this.getCentroid(e);this.Axx=t[0]*t[0],this.Axy=t[0]*t[1],this.Axz=t[0]*t[2],this.Ayy=t[1]*t[1],this.Ayz=t[1]*t[2],this.Azz=t[2]*t[2];const a=this.Axx*n[0]+this.Axy*n[1]+this.Axz*n[2],o=this.Axy*n[0]+this.Ayy*n[1]+this.Ayz*n[2],s=this.Axz*n[0]+this.Ayz*n[1]+this.Azz*n[2];this.bx=-a,this.by=-o,this.bz=-s,this.c=We.dot(n,[a,o,s])}}function Ye(e,t,n,a){this.v1Id=e,this.v2Id=t,this.cost=n,this.v_=a}const Xe=class{constructor(e,t=.5){this.copy=e=>{const t=He.Ay.newInstance();return t.getPoints().setData(e.getPoints().getTuples(),3),t.getPolys().setData(e.getPolys().getTuples()),t.getPolys().setNumberOfComponents(4),t},this.setTargetReduction=e=>{this.target_reduction=e},this.initLines=()=>{const e=new Set;for(let t=0;t<this.polyData.getNumberOfCells();t++){const n=this.polyData.getCellPoints(t).cellPointIds,[a,o,s]=n.sort(((e,t)=>e-t));e.add(`${a}-${o}`),e.add(`${a}-${s}`),e.add(`${o}-${s}`)}return Array.from(e).sort(((e,t)=>{const[n,a]=e.split("-").map(Number),[o,s]=t.split("-").map(Number);return n-o||a-s}))},this.initNeighbors=()=>{let e=Array.from({length:this.polyData.getNumberOfPoints()},(()=>new Set));for(const t of this.lines){const[n,a]=t.split("-").map(Number);e[n].add(a),e[a].add(n)}return e},this.initQuadricMatrices=()=>{let e=Array.from({length:this.polyData.getNumberOfPoints()});for(let t=0;t<this.polyData.getNumberOfCells();t++){const n=Array.from(this.polyData.getCellPoints(t).cellPointIds),a=n.map((e=>this.points.getPoint(e))),o=new Qe(a);for(const t of n)e[t]?e[t].add(o):e[t]=o}return e},this._computeQ_V_Cost=(e,t)=>{const n=this.qMatrices[e],a=this.qMatrices[t],o=n.add(a);let s,i=Array.from({length:3});if(o.optimalPoint(i))s=o.evaluate(i);else{const n=this.points.getPoint(e),a=this.points.getPoint(t),r=[(n[0]+a[0])/2,(n[1]+a[1])/2,(n[2]+a[2])/2],c=o.evaluate(n),l=o.evaluate(a),d=o.evaluate(r);c<l&&c<d?(i=n,s=c):l<d?(i=a,s=l):(i=r,s=d)}return[o,i,s]},this.initPairCosts=()=>{let e=Array.from({length:this.lines.length}).fill(!1);const t=this.lines.length;return console.log(`QuadricDecimation - vertex pairs: ${t}`),this.lines.forEach(((t,n)=>{const[a,o]=t.split("-").map(Number),[s,i,r]=this._computeQ_V_Cost(a,o),c=new Ye(Number(a),Number(o),r,i);e[n]=c})),e},this.buildMinHeap=()=>{const e=this.pairCosts.length;for(let t=~~(e/2)-1;t>=0;t--)this.heapify(t,e)},this.heapify=(e,t)=>{const n=this.pairCosts,a=2*e+1,o=2*e+2;let s=e;a<t&&n[a].cost<n[s].cost&&(s=a),o<t&&n[o].cost<n[s].cost&&(s=o),s!==e&&([n[e],n[s]]=[n[s],n[e]],this.heapify(s,t))},this.extractMin=()=>{if(0===this.pairCosts.length)return null;const e=this.pairCosts[0];return this.pairCosts[0]=this.pairCosts.pop(),this.heapify(0,this.pairCosts.length),e},this._updateCells=e=>{const t=e.v1Id,n=e.v2Id,a=this.polyData.getCellEdgeNeighbors(-1,t,n);for(const e of a){const t=this.polyData.getCellPoints(e).cellPointIds;for(const n of t)this.polyData.getLinks().removeCellReference(e,n);this.polyData.getCells().deleteCell(e),this.currentNumberOfCells--,this.deletedCells[e]=!0}for(const e of this.polyData.getPointCells(n))if(!this.deletedCells[e]){let o=this.polyData.getCellPoints(e).cellPointIds;o=o.map((e=>e===n?t:e)),this.polyData.getPolys().setTuple(e,[3,...o]),a.includes(e)||this.polyData.getLinks().insertNextCellReference(t,e)}},this._updatePoints=e=>{const t=e.v1Id,n=e.v2Id,a=e.v_;this.points.setPoint(t,a[0],a[1],a[2]),this.deletedPoints[n]=!0,this.polyData.getLinks().deletePoint(n),--this.currentNumberOfPoints},this._updatePairCosts=e=>{const t=e.v1Id,n=e.v2Id;for(let e=0;e<this.pairCosts.length;e++){const a=this.pairCosts[e].v1Id,o=this.pairCosts[e].v2Id;if(a===t||o===t){const[t,n,s]=this._computeQ_V_Cost(a,o);this.pairCosts[e]=new Ye(a,o,s,n)}else if(a===n||o===n){const s=a!==n?a:o,[i,r]=[t,s].sort(((e,t)=>e-t)),[c,l,d]=this._computeQ_V_Cost(i,r);if(this.pairCosts.some((e=>e.v1Id===i&&e.v2Id===r))){const t=this.pairCosts.length-1;[this.pairCosts[e],this.pairCosts[t]]=[this.pairCosts[t],this.pairCosts[e]],this.pairCosts.pop(),e--}else this.pairCosts[e]=new Ye(i,r,d,l)}}},this._removeDegenerate=e=>{if(this.deletedPoints[e])return;for(const t of this.polyData.getPointCells(e)){const e=this.polyData.getCellPoints(t).cellPointIds;for(const n of e)this.polyData.getLinks().removeCellReference(t,n);this.polyData.getCells().deleteCell(t),this.currentNumberOfCells--,this.deletedCells[t]=!0}this.deletedPoints[e]=!0,this.polyData.getLinks().deletePoint(e),--this.currentNumberOfPoints;for(let t=0;t<this.pairCosts.length;t++){let n=this.pairCosts[t];if(n.v1Id===e||n.v2Id===e){const e=this.pairCosts.length-1;[this.pairCosts[t],this.pairCosts[e]]=[this.pairCosts[e],this.pairCosts[t]],this.pairCosts.pop(),t--}}const t=Array.from(this.neighbors[e]);for(const n of t)this.neighbors[n].delete(e);this.neighbors[e].clear()},this._updateNeighbors=e=>{const t=e.v1Id,n=e.v2Id,a=Array.from(this.neighbors[n]);for(const e of a)this.neighbors[e].delete(n),e!==t&&(this.neighbors[e].add(t),this.neighbors[t].add(e));this.neighbors[n].clear()},this.decimate=()=>{if(this.targetReduction<=0||this.targetReduction>=1)return this.polyData;const e=this.polyData.getNumberOfCells(),t=this.polyData.getNumberOfPoints(),n=~~(this.targetReduction*e);for(this.deletedCells=Array.from({length:e}).fill(!1),this.deletedPoints=Array.from({length:t}).fill(!1),this.buildMinHeap();this.currentNumberOfCells>n;){(e-this.currentNumberOfCells)%100==0&&console.log("QuadricDecimation - cells destroyed: "+(e-this.currentNumberOfCells)+" / "+(e-n));const t=this.extractMin();this._updateCells(t),this._updatePoints(t),this._updatePairCosts(t),this.buildMinHeap()}let a=[],o=[],s=Array.from({length:t}).fill(-1),i=0;for(let e=0;e<t;e++)this.deletedPoints[e]||(a.push(...this.points.getPoint(e)),s[e]=i,i++);for(let t=0;t<e;t++)if(!this.deletedCells[t]){o.push(3);let e=this.polyData.getCellPoints(t).cellPointIds;e=e.map((e=>s[e])),o.push(...Array.from(e))}const r=He.Ay.newInstance();return r.getPoints().setData(new Float32Array(a),3),r.getPolys().setData(new Uint32Array(o)),r.getPolys().setNumberOfComponents(4),r},console.log("QuadricDecimation: Init QuadricDecimator"),this.polyData=this.copy(e),this.targetReduction=t,this.points=this.polyData.getPoints(),this.polyData.getLinks()||(console.log("QuadricDecimation: Build Links"),this.polyData.buildLinks()),console.log("QuadricDecimation: Init Lines"),this.lines=this.initLines(),console.log("QuadricDecimation: Init QMatrices"),this.qMatrices=this.initQuadricMatrices(),console.log("QuadricDecimation: Init PairCosts"),this.pairCosts=this.initPairCosts(),this.currentNumberOfCells=this.polyData.getNumberOfCells(),this.currentNumberOfPoints=this.polyData.getNumberOfPoints()}};var Ke=n(3219),Je=n(41857),Ze=n(33739),et=n(99341),tt=n(28906),nt=n(258),at=n(16632),ot=n(11200);const{vtkErrorMacro:st,vtkDebugMacro:it}=tt.m;const rt={contourValue:0,contourValueMax:4096,computeNormals:!1,mergePoints:!1};function ct(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,rt,n),tt.m.obj(e,t),tt.m.algo(e,t,1,1),tt.m.setGet(e,t,["contourValue","contourValueMax","computeNormals","mergePoints"]),tt.m.algo(e,t,1,1),function(e,t){t.classHierarchy.push("imageMarchingCubes");const n=[],a=[],o=[],s=[],i=nt.A.newInstance();e.getVoxelScalars=(e,t,o,s,i,r,c,l)=>{n[0]=o*s+t*i[0]+e,n[1]=n[0]+1,n[2]=n[0]+i[0],n[3]=n[2]+1,n[4]=n[0]+s,n[5]=n[4]+1,n[6]=n[4]+i[0],n[7]=n[6]+1;for(let e=0;e<8;++e)a[e]=l[n[e]]},e.getVoxelPoints=(e,t,n,a,o)=>{const i=a[0]+e*o[0],r=a[1]+t*o[1],c=a[2]+n*o[2];s[0]=[i,r,c],s[1]=[i+o[0],r,c],s[2]=[i,r+o[1],c],s[3]=[i+o[0],r+o[1],c],s[4]=[i,r,c+o[2]],s[5]=[i+o[0],r,c+o[2]],s[6]=[i,r+o[1],c+o[2]],s[7]=[i+o[0],r+o[1],c+o[2]]},e.getPointGradient=(e,t,n,a,o,s,i,r)=>{let c,l;0===e?(c=i[e+1+t*a[0]+n*o],l=i[e+t*a[0]+n*o],r[0]=(l-c)/s[0]):e===a[0]-1?(c=i[e+t*a[0]+n*o],l=i[e-1+t*a[0]+n*o],r[0]=(l-c)/s[0]):(c=i[e+1+t*a[0]+n*o],l=i[e-1+t*a[0]+n*o],r[0]=.5*(l-c)/s[0]),0===t?(c=i[e+(t+1)*a[0]+n*o],l=i[e+t*a[0]+n*o],r[1]=(l-c)/s[1]):t===a[1]-1?(c=i[e+t*a[0]+n*o],l=i[e+(t-1)*a[0]+n*o],r[1]=(l-c)/s[1]):(c=i[e+(t+1)*a[0]+n*o],l=i[e+(t-1)*a[0]+n*o],r[1]=.5*(l-c)/s[1]),0===n?(c=i[e+t*a[0]+(n+1)*o],l=i[e+t*a[0]+n*o],r[2]=(l-c)/s[2]):n===a[2]-1?(c=i[e+t*a[0]+n*o],l=i[e+t*a[0]+(n-1)*o],r[2]=(l-c)/s[2]):(c=i[e+t*a[0]+(n+1)*o],l=i[e+t*a[0]+(n-1)*o],r[2]=.5*(l-c)/s[2])},e.getVoxelGradients=(t,n,a,s,i,r,c)=>{const l=[];e.getPointGradient(t,n,a,s,i,r,c,l),o[0]=l,e.getPointGradient(t+1,n,a,s,i,r,c,l),o[1]=l,e.getPointGradient(t,n+1,a,s,i,r,c,l),o[2]=l,e.getPointGradient(t+1,n+1,a,s,i,r,c,l),o[3]=l,e.getPointGradient(t,n,a+1,s,i,r,c,l),o[4]=l,e.getPointGradient(t+1,n,a+1,s,i,r,c,l),o[5]=l,e.getPointGradient(t,n+1,a+1,s,i,r,c,l),o[6]=l,e.getPointGradient(t+1,n+1,a+1,s,i,r,c,l),o[7]=l},e.produceTriangles=(r,c,l,d,u,m,p,g,h,f,y,I,S,D)=>{const w=[1,2,4,8,16,32,64,128],v=[0,1,3,2,4,5,7,6],b=new Float32Array(3),x=new Float32Array(3);let C;e.getVoxelScalars(l,d,u,p,g,h,f,y);let E=0;for(let e=0;e<8;e++){const t=a[v[e]];t>r&&t<c&&(E|=w[e])}const M=ot.A.getCase(E);if(!(M[0]<0)){e.getVoxelPoints(l+m[0],d+m[2],u+m[4],h,f),t.computeNormals&&e.getVoxelGradients(l,d,u,g,p,f,y);for(let e=0;M[e]>=0;e+=3){S.push(3);for(let l=0;l<3;l++){const d=ot.A.getEdge(M[e+l]);if(C=void 0,t.mergePoints&&(C=i.isInsertedEdge(n[d[0]],n[d[1]])?.value),void 0===C){const e=((a[d[0]]<=r||a[d[1]]<=r?r:c)-a[d[0]])/(a[d[1]]-a[d[0]]),l=s[d[0]],u=s[d[1]];if(b[0]=l[0]+e*(u[0]-l[0]),b[1]=l[1]+e*(u[1]-l[1]),b[2]=l[2]+e*(u[2]-l[2]),C=I.length/3,I.push(b[0],b[1],b[2]),t.computeNormals){const t=o[d[0]],n=o[d[1]];x[0]=t[0]+e*(n[0]-t[0]),x[1]=t[1]+e*(n[1]-t[1]),x[2]=t[2]+e*(n[2]-t[2]),(0,at.l)(x),D.push(x[0],x[1],x[2])}t.mergePoints&&i.insertEdge(n[d[0]],n[d[1]],C)}S.push(C)}}}},e.requestData=(n,a)=>{const o=n[0];if(!o)return void st("Invalid or missing input");console.time("mcubes");const s=o.getOrigin(),r=o.getSpacing(),c=o.getDimensions(),l=o.getPointData().getScalars().getData(),d=[],u=[],m=[],p=o.getExtent(),g=c[0]*c[1];for(let n=0;n<c[2]-1;++n)for(let a=0;a<c[1]-1;++a)for(let o=0;o<c[0]-1;++o)e.produceTriangles(t.contourValue,t.contourValueMax,o,a,n,p,g,c,s,r,l,d,u,m);i.initialize();const h=He.Ay.newInstance();if(h.getPoints().setData(new Float32Array(d),3),h.getPolys().setData(new Uint32Array(u)),h.getPolys().setNumberOfComponents(4),t.computeNormals){const e=new Float32Array(m),t=Ge.Ay.newInstance({numberOfComponents:3,values:e,name:"Normals"});h.getPointData().setNormals(t)}a[0]=h,it("Produced output"),console.timeEnd("mcubes")}}(e,t)}var lt={newInstance:tt.m.newInstance(ct,"imageMarchingCubes"),extend:ct};n(637);function dt({commandsManager:e,extensionManager:t,servicesManager:n}){const[a,o]=(0,X.useState)(new Array(100).fill(0)),[s,i]=(0,X.useState)("50"),[r,c]=(0,X.useState)("0"),[l,d]=(0,X.useState)("50"),[u,m]=(0,X.useState)("20"),[p,g]=(0,X.useState)("450"),[h,f]=(0,X.useState)("1200"),y=(0,X.useRef)(!0),[{viewports:I},S]=(0,ne.ih)(),{cornerstoneViewportService:D,hangingProtocolService:w,uiNotificationService:v}=n.services,b=(e=>{let t=e%2147483647;return()=>(t=16807*t%2147483647,t/2147483647)})(42);(0,X.useEffect)((()=>{const t=S.getState();console.log("STATE",t),console.log("HP",w.getActiveProtocol()),"mprAnd3DVolumeViewport"!==w.getActiveProtocol().protocol.id&&e.runCommand("toggleHangingProtocol",{protocolId:"mprAnd3DVolumeViewport",stageIndex:0})}),[]),(0,X.useEffect)((()=>{if(y.current)return void(y.current=!1);const e=I.find((e=>"volume3d"===e.viewportOptions.viewportType));console.assert(e,'UseEffect Threshold: Could not find "volume3d" viewport'),S.setActiveViewportIndex(e.viewportIndex);const t=D.getCornerstoneViewport(e.id),n=t.getActors();if(!n||!n.length)return void v.show({title:"Edition 3D export",message:"No actor on 3d viewport",type:"error",duration:3e3});const a=Ze.Ay.newInstance();a.addRGBPoint(-1e3,0,0,0),a.addRGBPoint(+u,1,0,.031),a.addRGBPoint(+p,1,.458,.105),a.addRGBPoint(+h,1,.882,.207),a.addRGBPoint(3095,1,1,1);const o=et.Ay.newInstance();o.addPoint(-1e3,0),o.addPoint(+u,.05),o.addPoint(+p,.3),o.addPoint(+h,1),o.addPoint(3095,1),n.forEach((e=>{const t=e.actor;t.getProperty().setRGBTransferFunction(0,a),t.getProperty().setScalarOpacity(0,o)})),(0,Be.getEnabledElement)(t.element).viewport.render()}),[u,p,h]);return X.createElement("div",{style:{width:"100%",display:"flex",flexDirection:"column",justifyContent:"space-evenly",height:"50%"}},X.createElement(ne.$n,{onClick:async()=>{const t=I.findIndex((e=>"volume3d"===e.viewportOptions.viewportType));console.assert(-1!=t,'FocusOn: Could not find "volume3d" viewport');const n=I.length>1?t:0;await S.setActiveViewportIndex(n),e.runCommand("toggleOneUpCustom",{})}},"Volume Zoom In / Out"),X.createElement("p",{style:{color:"white",fontSize:"larger"}},"Volume rendering"),X.createElement("div",{style:{display:"inline-flex",width:"100%",justifyContent:"flex-start"}},X.createElement("p",{style:{color:"white"}},`Airway -> Skin threshold: ${u}`)),X.createElement("input",{type:"range",min:"-1000",max:p,value:u,className:"slider",id:"myRange",step:"1",onChange:e=>m(e.target.value)}),X.createElement("div",{style:{display:"inline-flex",width:"100%",justifyContent:"flex-start"}},X.createElement("p",{style:{color:"white"}},`Skin -> Bone threshold: ${p}`)),X.createElement("input",{type:"range",min:u,max:h,value:p,className:"slider",id:"myRange",step:"1",onChange:e=>g(e.target.value)}),X.createElement("div",{style:{display:"inline-flex",width:"100%",justifyContent:"flex-start"}},X.createElement("p",{style:{color:"white"}},`Bone -> Tooth threshold: ${h}`)),X.createElement("input",{type:"range",min:p,max:"3095",value:h,className:"slider",id:"myRange",step:"1",onChange:e=>f(e.target.value)}),X.createElement("p",{style:{color:"white",fontSize:"larger"}},"Mesh rendering"),X.createElement("div",{style:{display:"inline-flex",width:"100%",justifyContent:"flex-start"}},X.createElement("p",{style:{color:"white"}},`CT value for mesh: ${r}`)),X.createElement("input",{type:"range",min:"-1000",max:"3095",value:r,className:"slider",id:"myRange",step:"1",onChange:e=>c(e.target.value)}),X.createElement("div",{style:{display:"inline-flex",width:"100%",justifyContent:"flex-start"}},X.createElement("p",{style:{color:"white"}},`Target Reduction: ${l}%`)),X.createElement("input",{type:"range",min:"0",max:"100",value:l,className:"slider",id:"myRange",step:"1",onChange:e=>d(e.target.value)}),X.createElement(ne.$n,{onClick:()=>{let e=D.getCornerstoneViewportByIndex(0).getImageData().imageData;const t=I.find((e=>"volume3d"===e.viewportOptions.viewportType));console.assert(t,'MarchingCubes: Could not find "volume3d" viewport'),S.setActiveViewportIndex(t.viewportIndex),console.log("Marching cubes - Preprocessing");let n=[];const a=r,o=a<u?"airways":a<p?"skin":a<h?"bones":"teeth";if("airways"==o){const t=ze.Ay.newInstance();t.shallowCopy(e);const n=qe.Ay.newInstance();n.setCroppingPlanes([0,400,50,400,75,280]),n.setInputData(t),e=n.getOutputData()}console.log(`Marching cubes - Processing ${o}`);const s=lt.newInstance({contourValue:a,computeNormals:!1,mergePoints:!0});s.setInputData(e);const i=s.getOutputData();i.buildLinks();const c=ke.Ay.newInstance();c.setInputData(i);const d=Fe.Ay.newInstance();d.setMapper(c),"airways"==o?d.getProperty().setDiffuseColor(b(),b(),b()):"skin"==o?d.getProperty().setDiffuseColor(.88,.55,.55):"bones"==o?d.getProperty().setDiffuseColor(.9,.85,.77):"teeth"==o&&d.getProperty().setDiffuseColor(1,1,1),d.getProperty().setOpacity(1),d.getProperty().setBackfaceCulling(!0),console.log("Marching cubes - Separating airways");const m=new _e(i).extractGroups(),g=m.map(((e,t)=>({index:t,size:e.getNumberOfCells()})));g.sort(((e,t)=>t.size-e.size));const f=Array.from({length:10},((e,t)=>t)),y=f.map((e=>g[e])).map((e=>m[e.index])),w=Number(l)/100;y.map(((e,t)=>{let a=e;if(w>0&&w<1){a=new Xe(e,w).decimate()}const o=ke.Ay.newInstance();o.setInputData(a);const s=Fe.Ay.newInstance();s.setMapper(o),s.getProperty().setColor(b(),b(),b()),s.getProperty().setOpacity(1),s.getProperty().setBackfaceCulling(!1),n.push({uid:`airway_${t}`,actor:s})}));const v=$e.Ay.newInstance();v.setInputData(d);const x=ke.Ay.newInstance();x.setInputConnection(v.getOutputPort());const C=Fe.Ay.newInstance();C.setMapper(x),C.getProperty().setColor(1,1,0),C.getProperty().setOpacity(1),n.push({uid:"outline",actor:C}),console.log("Marching cubes - Display"),(e=>{const t=I.find((e=>"volume3d"===e.viewportOptions.viewportType));console.assert(t,'DisplayMarchingCubes: Could not find "volume3d" viewport'),S.setActiveViewportIndex(t.viewportIndex);const n=D.getCornerstoneViewport(t.id);n.setActors(e);const a=n.getRenderer();a.getRenderWindow().setNumberOfLayers(2),a.setUseDepthPeeling(!0),a.setOcclusionRatio(.1),a.setMaximumNumberOfPeels(100),a.getActiveCamera().setParallelProjection(!0),a.resetCamera(),(0,Be.getEnabledElement)(n.element).viewport.render()})(n)}},"Marching cubes"),X.createElement(ne.$n,{onClick:()=>{const e=I.find((e=>"volume3d"===e.viewportOptions.viewportType));console.assert(e,'Export STL: Could not find "volume3d" viewport');const t=D.getCornerstoneViewport(e.id).getActors();if(t&&t.length)for(const e of t){const{uid:t,actor:n}=e;if("outline"===t)continue;const a=n.getMapper().getInputData(),o=Ke.Ay.writeSTL(a,Je.$.BINARY),s=new Blob([o],{type:"text/plain;charset=utf-8"}),i=window.document.createElement("a");i.href=window.URL.createObjectURL(s),i.download=`${t}STL.stl`,i.text=`Download ${t} STL`,document.body.appendChild(i),i.click(),console.log(`${t} polygons successfully exported`)}else v.show({title:"Edition 3D export",message:"STL needs to be generated",type:"info",duration:3e3})}},"Export STL"))}var ut=n(98955),mt=n(92990);const pt=n(95725),gt=async(e,t=!1)=>{let n,a;var o=e.BitsAllocated,s=e.BitsStored,i=e.Rows,r=e.Columns,c=e.WindowCenter,l=e.WindowWidth;let d,u=e.PixelData;d=16===o?new Int16Array(u):new Int8Array(u);var m=pt([i,r]);if(t)for(a=1;a<=i;a++)for(n=0;n<r;n++){let e=d[a*r+n];c&&l?e=e<=c-.5-(l-1)/2?0:e>c-.5+(l-1)/2?255:~~(255*((e-(c-.5))/(l-1)+.5)):16===o&&(e=256*e/2**s),m.set(i-a,n,e)}else for(a=0;a<i;a++)for(n=0;n<r;n++){let e=d[a*r+n];c&&l?e=e<=c-.5-(l-1)/2?0:e>c-.5+(l-1)/2?255:~~(255*((e-(c-.5))/(l-1)+.5)):16===o&&(e=256*e/2**s),m.set(a,n,e)}return{buffer:m,height:i,width:r,ext:"png"}};function ht(e,t){const n=[],a=[];e.forEach(((e,o)=>{null!==e[1]&&(a.push(e),n.push(t[o]))}));const o=a.reduce(((e,t)=>e+t[1]),0)/a.length,s=a.reduce(((e,t)=>{const n=t[1]-o;return e+n*n}),0),i=a.reduce(((e,t,a)=>{const o=n[a],s=t[1]-o[1];return e+s*s}),0);return 1-i/s}function ft(e,t){const n=10**t;return Math.round(e*n)/n}const yt={polynomial(e,t){const n=[],a=[];let o=0,s=0;const i=e.length,r=t.order+1;for(let t=0;t<r;t++){for(let n=0;n<i;n++)null!==e[n].y&&(o+=e[n].x**t*e[n].y);n.push(o),o=0;const c=[];for(let n=0;n<r;n++){for(let a=0;a<i;a++)null!==e[a].y&&(s+=e[a].x**(t+n));c.push(s),s=0}a.push(c)}a.push(n);const c=function(e,t){const n=e,a=e.length-1,o=[t];for(let e=0;e<a;e++){let t=e;for(let o=e+1;o<a;o++)Math.abs(n[e][o])>Math.abs(n[e][t])&&(t=o);for(let o=e;o<a+1;o++){const a=n[o][e];n[o][e]=n[o][t],n[o][t]=a}for(let t=e+1;t<a;t++)for(let o=a;o>=e;o--)n[o][t]-=n[o][e]*n[e][t]/n[e][e]}for(let e=a-1;e>=0;e--){let t=0;for(let s=e+1;s<a;s++)t+=n[s][e]*o[s];o[e]=(n[a][e]-t)/n[e][e]}return o}(a,r).map((e=>ft(e,t.precision))),l=e=>[ft(e,t.precision),ft(c.reduce(((t,n,a)=>t+n*e**a),0),t.precision)],d=e.map((e=>l(e.x)));let u="y = ";for(let e=c.length-1;e>=0;e--)u+=e>1?`${c[e]}x^${e} + `:1===e?`${c[e]}x + `:c[e];return{string:u,points:d,predict:l,equation:[...c].reverse(),r2:ft(ht(e,d),t.precision)}}};var It=n(85639);const St=n(27038),Dt=7,wt=11,vt=70,bt=300,xt=30;function Ct(e){return new Promise((t=>setTimeout(t,e)))}function Et({commandsManager:e,extensionManager:t,servicesManager:n}){const{StudyInstanceUIDs:a}=(0,ne.Bz)(),[{activeViewportIndex:o,viewports:s},r]=(0,ne.ih)(),{displaySetService:c,cornerstoneViewportService:l,hangingProtocolService:d,toolGroupService:u,measurementService:m,uiNotificationService:p,cornerstoneCacheService:g,customizationService:h}=n.services,{displaySetInstanceUIDs:f,displaySetOptions:y,viewportOptions:I}=s[o],[S,D]=(0,X.useState)({update:!1,dentascanViewportData:void 0,panoramicViewportData:void 0,panoramic:{width:0,height:0}}),[w,v]=(0,X.useState)(!1),[b,x]=(0,X.useState)(0),[C,E]=(0,X.useState)(11);(0,X.useEffect)((()=>{const t=l.getCornerstoneViewportByIndex(0),n=Be.metaData.get("generalSeriesModule",t.getCurrentImageId()),a=(e,t)=>{const n=new Map;return e.forEach(((e,a)=>{t(e,a)&&n.set(a,e)})),n};var o;(o=300,new Promise((e=>setTimeout(e,o)))).then((()=>{const t=a(c.getDisplaySetCache(),((e,t)=>e.SeriesInstanceUID===`${n.seriesInstanceUID}.panoramic`)),o=a(c.getDisplaySetCache(),((e,t)=>e.SeriesInstanceUID===`${n.seriesInstanceUID}.contrasted`));if(t.size>=1){e.runCommand("toggleHangingProtocol",{protocolId:"panoramicViewport",stageIndex:2});const t=g.getPanoramicStateCache(n.seriesInstanceUID);D({...t,update:!t.update})}else o.size>=1?e.runCommand("toggleHangingProtocol",{protocolId:"panoramicViewport",stageIndex:1}):e.runCommand("toggleHangingProtocol",{protocolId:"panoramicViewport",stageIndex:0})}))}),[]),(0,X.useEffect)((()=>{v(!1);const t=m.getMeasurements().filter((e=>"ArrowAnnotate"===e.toolName));for(const n of t)n.metadata.dentascan&&e.runCommand("deleteMeasurement",{uid:n.uid});if(!S.dentascanViewportData)return;const n=l.getCornerstoneViewportByIndex(1);if(!n)return;const a=n.getImageData(),o=a.imageData.indexToWorld([S.dentascanViewportData?.data.initialImageIndex,0,0]),s=a.imageData.indexToWorld([S.dentascanViewportData?.data.initialImageIndex,S.panoramic.height,0]);ut.ToolGroupManager.getToolGroupForViewport(n.id,n.renderingEngineId).getToolInstance("ArrowAnnotate").addNewDentascanAnnotation(n.element,[o,s],"rgb(255, 255, 255)"),ut.utilities.jumpToSlice(l.getCornerstoneViewportByIndex(2).element,{imageIndex:S.dentascanViewportData.data.initialImageIndex-4,debounceLoading:!0}),ut.utilities.jumpToSlice(l.getCornerstoneViewportByIndex(3).element,{imageIndex:S.dentascanViewportData.data.initialImageIndex-2,debounceLoading:!0}),ut.utilities.jumpToSlice(l.getCornerstoneViewportByIndex(4).element,{imageIndex:S.dentascanViewportData.data.initialImageIndex,debounceLoading:!0}),ut.utilities.jumpToSlice(l.getCornerstoneViewportByIndex(5).element,{imageIndex:S.dentascanViewportData.data.initialImageIndex+2,debounceLoading:!0}),ut.utilities.jumpToSlice(l.getCornerstoneViewportByIndex(6).element,{imageIndex:S.dentascanViewportData.data.initialImageIndex+4,debounceLoading:!0});const i=Be.metaData.get("generalSeriesModule",n.getCurrentImageId());0!==S.panoramic.width&&g.setPanoramicStateCache(S,i.seriesInstanceUID)}),[S.update]);const M=e=>new Promise((async(n,a)=>{const o=await gt(e),s=new Uint8ClampedArray(o.width*o.height*4),r=o.buffer.data;let l=0;for(const e of r)s[l]=e,s[l+1]=e,s[l+2]=e,s[l+3]=255,l+=4;const u=document.createElement("canvas");u.width=o.width,u.height=o.height;const m=new ImageData(new Uint8ClampedArray(s),o.width,o.height);u.getContext("2d").putImageData(m,0,0),u.toBlob((async a=>{const o=new mt.A(a),s=o.addFile(a),r=await o.loadFile(a,s),l=await o.getDataset(r,s,{prefilledValues:{SeriesInstanceUID:e.SeriesInstanceUID,StudyInstanceUID:e.StudyInstanceUID}});console.log("DATASET",l),i.DicomMetadataStore.addInstance(l);const u=c.makeDisplaySets([l]);console.log("DSADDED",u);const m=t.getDataSource()[0],p=await g.createViewportData(u,{toolGroupId:"mpr",viewportType:"stack",initialImageOptions:{preset:"middle"}},m,void 0);console.log("VIEWPORT STACK DATA",p),d.refreshStudyList(),n(p)}))})),P=(e,t,n)=>new Promise((async(a,o)=>{const s=c.getDisplaySetByUID(l.getViewportInfoByIndex(0).viewportData.data.displaySetInstanceUID);let r;if(s?.SeriesInstanceUID.includes("contrasted")){const e=s.SeriesInstanceUID.replace(".contrasted","");r=i.DicomMetadataStore.getSeries(s.StudyInstanceUID,e).instances[0].imageId}else r=l.getCornerstoneViewportByIndex(0).getCurrentImageId();const d=Be.metaData.get("voiLutModule",r),u=Be.metaData.get("imagePixelModule",r),m={BitsAllocated:u.bitsAllocated,BitsStored:u.bitsStored,Rows:t,Columns:n,WindowCenter:d.windowCenter[0],WindowWidth:d.windowWidth[0],PixelData:e},p=await gt(m),g=new Uint8ClampedArray(p.width*p.height*4),h=p.buffer.data;let f=0;for(const e of h)g[f]=e,g[f+1]=e,g[f+2]=e,g[f+3]=255,f+=4;const y=document.createElement("canvas");y.width=p.width,y.height=p.height;const I=new ImageData(new Uint8ClampedArray(g),p.width,p.height);y.getContext("2d").putImageData(I,0,0),document.body.appendChild(y),console.info("[DEBUG] - Provided array displayed in document below main canvas !"),a(y)})),A=(e,t,n,a,o,s)=>{null==o&&(o="#000"),null==s&&(s=5);var i=.5*s,r=Math.round(t-i),c=Math.round(n-i);if(e.beginPath(),e.fillStyle=o,e.fillRect(r,c,s,s),e.fill(),a){var l=Math.round(t),d=Math.round(c-5);e.font="Italic 14px Arial",e.fillStyle=o,e.textAlign="center",e.fillText(a,l,d)}},U=(e,t)=>n=>-1/(2*t.equation[0]*e+t.equation[1])*(n-e)+(t.equation[0]*e*e+t.equation[1]*e+t.equation[2]);function R(e,t){const n=1e-5,a=-1/((t(e+n)-t(e-n))/(2*n));return n=>a*(n-e)+t(e)}const N=(e,t)=>{const n=[1,0],a=[t[0]-e[0],t[1]-e[1]];let o=180*(Math.atan2(a[1],a[0])-Math.atan2(n[1],n[0]))/Math.PI;return o=(o+360)%360,o},T=(e,t)=>{const n=Math.PI/180*t;return[e[0]*Math.cos(n)-e[1]*Math.sin(n),e[0]*Math.sin(n)+e[1]*Math.cos(n)]};function O(e,t,n){const a=[n[0]+2*t,e(n[0]+2*t)],o=(a[1]-n[1])/(a[0]-n[0]),s=Math.atan(o),i=t*Math.cos(s),r=n[0]+i;return[r,e(r)]}const V=(e,t,n)=>{const a=[];for(let o=0;o<t;o++)for(let s=0;s<n;s++)a.push(e[s*t+o]);return a},L=(e,t,n)=>({x:e%t,y:Math.floor(e/t)}),k=(e,t,n,a,o,s=!1)=>{const[i,r,c]=a,l=i*r,d=U(e,t),u=[e-n/2,d(e-n/2)],m=[e+n/2,d(e+n/2)],p=N(u,m),g=T([1,0],p),h=[],f=O(d,-n/2,[e,d(e)]),y=O(d,n/2,[e,d(e)]);for(let e=0;e<c;e++)for(let t=f[0];t<y[0];t+=g[0]){const n=d(t),a=o[Math.floor(n)*r+Math.floor(t)+l*e];h.push(a||-1e3)}const I=h.length/c,S=h.map(((e,t,n)=>e>bt?e:-1e3)),D=V(S,I,c),w=Math.floor(D.reduce(((e,t,n)=>n%c<e&&-1e3!=t?n%c:e),1/0)),v=Math.floor(D.reduce(((e,t,n)=>n%c>e&&-1e3!=t?n%c:e),-1/0)),b=D.map(((e,t,n)=>-1e3===e?null:L(t,c))).filter((e=>e)),x=yt.polynomial(b,{order:5,precision:50});return{dentascan:h,width:I,normal:d,lsf:x,longAxialCurve:e=>{const t=I/2,n=I/2,a=1/(1+Math.exp(-.1*(e-w))),o=1/(1+Math.exp(.1*(e-v)));return(x.equation[0]*e**5+x.equation[1]*e**4+x.equation[2]*e**3+x.equation[3]*e**2+x.equation[4]*e+x.equation[5])*a*o+t*(1-a)+n*(1-o)},interval:[f,y],director:g}},F=async(n,a=!1)=>{const o=l.getViewportInfoByIndex(0).viewportData.data.displaySetInstanceUID,s=m.getMeasurements().filter((e=>"ArrowAnnotate"===e.toolName&&e.metadata.handmade&&e.displaySetInstanceUID===o));if(0===s.length)return void p.show({title:"Panoramic Generation Error",message:"Generate control points first before initiating the computation of the panoramic.",type:"error",duration:3e3});d.refreshStudyList();let r=d.getState();if(2===r.stageIndex){const t=l.getViewportInfoByIndex(1),n=l.getViewportInfoByIndex(2);console.info("Deleting old panoramic display set...",t.viewportData.data.displaySetInstanceUID),console.info("Deleting old dentascan display set...",n.viewportData.data.displaySetInstanceUID),c.deleteDisplaySet(t.viewportData.data.displaySetInstanceUID),c.deleteDisplaySet(n.viewportData.data.displaySetInstanceUID),e.runCommand("toggleHangingProtocol",{protocolId:"panoramicViewport",stageIndex:1})}v(!0);const u=c.getDisplaySetByUID(l.getViewportInfoByIndex(0).viewportData.data.displaySetInstanceUID),h=u.SeriesInstanceUID.replace(".contrasted",""),f=i.DicomMetadataStore.getSeries(u.StudyInstanceUID,h).instances[0].imageId,y=Be.cache.getVolumeContainingImageId(f),I=y.volume.scalarData,w=y.volume.dimensions,[b,C,E]=w,L=b*C,F=l.getCornerstoneViewportByIndex(0).getImageData(),B=s[0].points.map((e=>F.imageData.worldToIndex(e))).map((e=>({x:e[0],y:e[1]}))).sort(((e,t)=>e.x-t.x)),$=yt.polynomial(B,{order:2,precision:5}),z=e=>e*e*$.equation[0]+e*$.equation[1]+$.equation[2],q=[],G=Math.min(...B.map((e=>e.x))),H=Math.max(...B.map((e=>e.x))),_=(H-G)/wt;for(let e=G;e+_<=H+10;e+=_){const t=[e,z(e)],n=[e+_,z(e+_)],a=N(t,n),o={pointA:t,pointB:n,vectorDirector:T([1,0],a),computeLongAxialCurve:!0};q.push(o)}if(a){const e=[];for(let t=0;t<L;t++){let n=t;const a=[];for(;n<I.length;)a.push(I[n]),n+=L;e.push(a)}const t=e.map((e=>Math.max(...e)));let a=[];for(const e of q)a.push(k(e.pointA[0],$,n,w,I,!0));let o=await P(t,b,C);const s=o.getContext("2d");for(const e of q){const t=e.pointA[0],n=U(t,$);A(s,e.pointA[0],z(e.pointA[0]),"","red",7),A(s,e.pointB[0],z(e.pointB[0]),"","red",7);const a=O(n,-40,[t,n(t)]),o=O(n,40,[t,n(t)]);for(let e=a[0];e<o[0];e+=1)A(s,e,n(e),"","purple",2)}for(let e=0;e<b;e++)A(s,e,z(e),"","green",2);for(const e of a){const t=V(e.dentascan.map(((e,t,n)=>e>bt?e:-1e3)),e.width,E);o=await P(t,e.width,E);const n=o.getContext("2d");for(let t=0;t<E;t++){for(let t=0;t<E;t+=20){const a=30,o=R(t,e.longAxialCurve),s=[t-a/2,o(t-a/2)],i=[t+a/2,o(t+a/2)],r=N(s,i),c=T([1,0],r),l=O(o,-a/2,[t,o(t)]),d=O(o,a/2,[t,o(t)]);for(let e=l[0];e<d[0];e+=c[0]){const t=o(e);A(n,e,t,"","purple",2)}}A(n,t,e.longAxialCurve(t),"","red",2)}}}let j=0,W=Array.from({length:q.length+1});W[0]=0,q.forEach(((e,t)=>{j+=Math.ceil((e.pointB[0]-e.pointA[0])/e.vectorDirector[0]),W[t+1]=j})),console.log("PANORAMIC WIDTH",j);let Q=new Array(j*E).fill(-1e3),Y=new Array(j).fill(null);const X=[];q.forEach(((e,t)=>{X.push((()=>{return a=e,o=W[t],new Promise(((e,t)=>{for(let e=a.pointA[0];e<a.pointB[0];e+=a.vectorDirector[0]){const t=k(e,$,n,w,I);Y[o]=t.dentascan;for(let e=0;e<E;e++){const n=R(e,t.longAxialCurve),a=T([1,0],N([e-xt/2,n(e-xt/2)],[e+xt/2,n(e+xt/2)])),s=O(n,-xt/2,[e,n(e)]),i=O(n,xt/2,[e,n(e)]),r=[];for(let o=s[0];o<i[0];o+=a[0]){const a=n(o),s=[t.interval[0][0]+a*t.director[0],t.interval[0][1]+a*t.director[1]],i=Math.floor(s[0]),c=Math.floor(s[1]),l=I[L*e+c*b+i];r.push(l)}const c=r.reduce(((e,t)=>e+t),0)/r.length;Q[j*(E-e)+o]=c}o+=1}e()}));var a,o}))}));const K=new Array(q.length).fill(!1),J=async(e,t=0)=>{if(!(t<e.length))return Promise.resolve();await e[t](),K[t]=!0,await Ct(100),J(e,t+1)};J(X);await new Promise(((e,t)=>{const n=()=>{const t=K.filter((e=>e)).length,a=~~(100*t/q.length);if(x(a),t===q.length)return e();setTimeout(n,50)};n()})),console.log("DONE");const Z=function(e,t,n){const a=e.slice(),o=[[0,-1,0],[-1,5,-1],[0,-1,0]];for(let s=1;s<n-1;s++)for(let n=1;n<t-1;n++){let i=0;for(let a=0;a<3;a++)for(let r=0;r<3;r++)i+=e[(s+a-1)*t+(n+r-1)]*o[a][r];i=Math.min(32767,Math.max(-32768,i)),a[s*t+n]=i}return a}(Q,j,E);a&&P(Z,E,j);const ee=Be.metaData.get("voiLutModule",f),te=Be.metaData.get("imagePixelModule",f),ne=Be.metaData.get("generalSeriesModule",f);if(!l.getCornerstoneViewportByIndex(0))return void p.show({title:"Panoramic Generation Error",message:"No viewport detected.",type:"error",duration:3e3});const ae={SeriesInstanceUID:ne.seriesInstanceUID+".panoramic",StudyInstanceUID:ne.studyInstanceUID,BitsAllocated:te.bitsAllocated,BitsStored:te.bitsStored,Rows:E,Columns:j,WindowCenter:ee.windowCenter[0],WindowWidth:ee.windowWidth[0],PixelData:Z},oe=await M(ae),se={SeriesInstanceUID:ne.seriesInstanceUID+".dentascan",StudyInstanceUID:ne.studyInstanceUID,BitsAllocated:te.bitsAllocated,BitsStored:te.bitsStored,Rows:E,Columns:-1,WindowCenter:ee.windowCenter[0],WindowWidth:ee.windowWidth[0],PixelData:Y},ie=await(e=>{const n={SeriesInstanceUID:e.SeriesInstanceUID,SOPInstanceUID:Math.random().toString(36).substring(2,10),StudyInstanceUID:e.StudyInstanceUID,FrameOfReferenceUID:Math.random().toString(36).substring(2,10)},a=e.PixelData;return new Promise((async(o,s)=>{const r=new Promise(((t,o)=>{let s=Array.from({length:a.length}).fill(null);a.forEach((async(o,r)=>{e.PixelData=o,e.Columns!==o.length/e.Rows&&(e.Columns=o.length/e.Rows);const c=await gt(e,!0),l=new Uint8ClampedArray(c.width*c.height*4),d=c.buffer.data;let u=0;for(const e of d)l[u]=e,l[u+1]=e,l[u+2]=e,l[u+3]=255,u+=4;const m=document.createElement("canvas");m.width=c.width,m.height=c.height;const p=new ImageData(new Uint8ClampedArray(l),c.width,c.height);m.getContext("2d").putImageData(p,0,0),m.toBlob((async e=>{const o=new mt.A(e),c=o.addFile(e),l=await o.loadFile(e,c),d=`${n.SOPInstanceUID}.${r+1}`,u=await o.getDataset(l,c,{prefilledValues:{...n,SOPInstanceUID:d,FrameNumber:r}});i.DicomMetadataStore.addInstance(u),s[r]=u,s.length!==a.length||s.includes(null)||t(s)}))}))})),l=await r,d=c.makeDisplaySets(l),u=t.getDataSource()[0];o(await g.createViewportData(d,{toolGroupId:"mpr",viewportType:"stack",initialImageOptions:{preset:"middle"}},u,~~(l.length/2)))}))})(se);d.refreshStudyList(),r=d.getState(),e.runCommand("toggleHangingProtocol",{protocolId:"panoramicViewport",stageIndex:2}),D({...S,update:!S.update,dentascanViewportData:ie,panoramicViewportData:oe,panoramic:{width:j,height:E}}),g.setPanoramicStateCache({...S,update:!S.update,dentascanViewportData:ie,panoramicViewportData:oe,panoramic:{width:j,height:E}},ne.seriesInstanceUID),console.log("DISPLAY SETS",c.getDisplaySetCache())};return X.createElement("div",{style:{width:"100%",height:"100%"}},X.createElement("div",{style:{width:"100%",display:"flex",flexDirection:"column",height:"100%"}},X.createElement("p",{style:{color:"white",fontWeight:"bold",marginBottom:"20px"}},"Panoramic Generation"),X.createElement("p",{style:{color:"white",fontSize:"small",marginBottom:"10px"}},"1 - Generate control points from where panoramic will be computed with"),X.createElement(ne.$n,{onClick:async()=>{const t=m.getMeasurements().filter((e=>"ArrowAnnotate"===e.toolName));console.log("MEASUREMENTS",t);let n=l.getViewportInfoByIndex(0).viewportData.data.displaySetInstanceUID;for(const a of t)a.metadata.handmade&&a.displaySetInstanceUID===n&&e.runCommand("deleteMeasurement",{uid:a.uid});const a=c.getDisplaySetByUID(l.getViewportInfoByIndex(0).viewportData.data.displaySetInstanceUID);let o,s,r,u;if(a?.SeriesInstanceUID.includes("contrasted")){u=!0;const e=a.SeriesInstanceUID.replace(".contrasted","");o=i.DicomMetadataStore.getSeries(a.StudyInstanceUID,e).instances[0].imageId;const t=Be.cache.getVolumeContainingImageId(o);r=t.volume.scalarData,s=t.volume.dimensions}else{u=!1;const e=l.getCornerstoneViewportByIndex(0).getImageData();o=l.getCornerstoneViewportByIndex(0).getCurrentImageId(),r=e.scalarData,s=e.dimensions}const[p,g,h]=s,f=p*g;let y=-1;for(let e=0;e<h;e++){const t=e*f,n=(e+1)*f;if(r.slice(t,n).some((e=>e>-1e3))){y=e*f;break}}let I=-1;for(let e=h-1;e>=0;e--){const t=e*f,n=(e-1)*f;if(r.slice(n,t).some((e=>e>-1e3))){I=e*f;break}}const S=Array.from({length:f});for(let e=0;e<f;e++){const t=[];for(let n=y+e;n<I;n+=f)t.push(r[n]);S[e]=t}const D=S.map((e=>e.reduce(((e,t)=>e+t),0)/e.length)),w=Math.floor(D.reduce(((e,t)=>t<e?t:e),D[0])),v=Math.floor(D.reduce(((e,t)=>t>e?t:e),D[0])),b=D.map((e=>{const t=(e-w)/(v-w),n=Math.pow(t,4),a=Math.min(1,Math.max(0,n));return Math.round(a*(v-w)+w)})),x=Be.metaData.get("voiLutModule",o),C=Be.metaData.get("imagePixelModule",o),E=Be.metaData.get("generalSeriesModule",o),P={SeriesInstanceUID:E.seriesInstanceUID+".contrasted",StudyInstanceUID:E.studyInstanceUID,BitsAllocated:C.bitsAllocated,BitsStored:C.bitsStored,Rows:p,Columns:g,WindowCenter:x.windowCenter[0],WindowWidth:x.windowWidth[0],PixelData:b};u||await M(P),d.refreshStudyList();d.getState().stageIndex<1&&e.runCommand("toggleHangingProtocol",{protocolId:"panoramicViewport",stageIndex:1}),await Ct(500);const A=l.getCornerstoneViewportByIndex(0),U=A.getImageData(),R=St(D,6),{centroids:N,idxs:T}=R,O=N.indexOf(Math.max(...N)),V=D.map(((e,t,n)=>T[t]===O?e:-1e3)),k=((e,t,n)=>{const a=[],o=new Array(t*n).fill(!1),s=e=>{const a=[],o=e%t,s=Math.floor(e/t);for(let e=Math.max(0,o-1);e<=Math.min(t-1,o+1);e++)for(let o=Math.max(0,s-1);o<=Math.min(n-1,s+1);o++){const n=o*t+e;a.push(n)}return a},i=(t,n)=>{const a=[t];for(;a.length>0;){const t=a.shift();if(!o[t]&&-1e3!==e[t]){o[t]=!0,n.push(t);const i=s(t);for(const t of i)o[t]||-1e3===e[t]||a.push(t)}}};for(let s=0;s<t*n;s++)if(!o[s]&&-1e3!==e[s]){const e=[];i(s,e),a.push(e)}return a})(V,p,g);let F;k.sort(((e,t)=>t.length-e.length));for(let e=0;;e++){const t=k[e],n=t.map((e=>L(e,p))),a=(V.map(((e,n,a)=>t.includes(n)?e:-1e3)),yt.polynomial(n,{order:2,precision:5}));if(console.log("LSF",a),a.equation[0]>0){F=e=>e*e*a.equation[0]+e*a.equation[1]+a.equation[2];break}}const B=Math.floor(V.reduce(((e,t,n)=>n%p<e&&-1e3!=t?n%p:e),1/0)),$=Math.floor(V.reduce(((e,t,n)=>n%p>e&&-1e3!=t?n%p:e),-1/0)),z=[],q=($-B)/(Dt-1);for(let e=B;e<=$+10;e+=q)z.push([e,F(e)]);const G=z.map((e=>U.imageData.indexToWorld([e[0],e[1],0]))),H=ut.ToolGroupManager.getToolGroupForViewport(A.id,A.renderingEngineId),_=H.getToolInstance("ArrowAnnotate");console.log("Tool Group",H,_),n=l.getViewportInfoByIndex(0).viewportData.data.displaySetInstanceUID;for(const e of t)e.metadata.handmade&&e.displaySetInstanceUID===n&&_.removeArrowAnnotation(e.uid);_.addNewAnnotationWithMovablePoints(A.element,G,"rgb(0, 255, 0)")},style:{marginBottom:"20px"}},"Generate Control Points"),X.createElement("p",{style:{color:"white",fontSize:"small",marginBottom:"20px"}},"2 - Adjust the points as needed so that the green line fits best around the white area of the image (along the dental curve). The points do not need to be evenly distributed. You can change brightness and contrast of the image to enlighten the white line with the Window Level tool in toolbar."),X.createElement("div",{style:{width:"90%",display:"flex",flexDirection:"column",marginBottom:"20px"}},X.createElement("p",{style:{color:"white",fontSize:"small",marginBottom:"10px"}},"3 - Once the points are well adjusted, you can modify some parameters but be careful : the lower the parameters are set, the faster the execution, but the quality of the panoramic view may be compromised."),X.createElement("p",{style:{color:"#5ACCE6",fontSize:"smaller",marginBottom:"5px"}},"Steps of computation :"),X.createElement("div",{style:{width:"100%",display:"flex"}},X.createElement("input",{type:"range",id:"dSection",name:"dSection",value:""+~~C,min:"5",max:"45",style:{width:"70%",marginRight:"5%"},onChange:e=>{E(parseInt(e.target.value))}}),X.createElement("p",{style:{color:"#5ACCE6",fontSize:"small",width:"25%"}},`${C}`))),X.createElement("p",{style:{color:"white",fontSize:"small",marginBottom:"10px"}},"4 - Once the chosen parameters are good, you can initiate the computation"),X.createElement(ne.$n,{onClick:()=>{F(vt,!1)},style:{marginBottom:"10px"}},"Compute Panoramic"),w&&X.createElement("div",{className:"w-full mt-[10px] mb-[20px]"},X.createElement("p",{style:{color:"white",fontSize:"small"}},"Creating panoramic..."),X.createElement(It.A,{className:"w-full mt-[3px]",bgColor:b<100?"#5ACCE6":"#50C878",completed:b,transitionDuration:"0.05s",transitionTimingFunction:"linear"})),S.panoramic?.width&&X.createElement("div",{style:{width:"100%",display:"flex",flexDirection:"column",justifyContent:"space-evenly",height:"18%"}},X.createElement("p",{style:{color:"white",fontWeight:"bold"}},"Dentascan Editing"),X.createElement("p",{style:{color:"white",fontSize:"small",marginBottom:"10px"}},"5 - Scroll through the dentascans using this slider. The central dentascan is represented by the white line on the panoramic view."),X.createElement("div",{style:{width:"90%",display:"flex",height:"10%",flexDirection:"row",justifyContent:"space-between"}},X.createElement("p",{style:{color:"white",fontSize:"smaller"}},"Section :"),X.createElement("input",{type:"range",id:"dSection",name:"dSection",value:""+~~S.dentascanViewportData.data.initialImageIndex,min:"0",max:""+(S.panoramic.width-1),style:{width:"70%"},onChange:e=>{D({...S,update:!S.update,dentascanViewportData:{...S.dentascanViewportData,data:{...S.dentascanViewportData.data,initialImageIndex:~~e.target.value}}})}})))))}const Mt=function({commandsManager:e,extensionManager:t,servicesManager:n}){return[{name:"seriesList",iconName:"group-layers",iconLabel:"Studies",label:"Studies",component:xe.bind(null,{commandsManager:e,extensionManager:t,servicesManager:n})},{name:"measure",iconName:"tab-linear",iconLabel:"Measure",label:"Measurements",secondaryLabel:"Measurements",component:()=>X.createElement(Ve,{commandsManager:e,servicesManager:n,extensionManager:t})},{name:"volumeEditionPanel",iconName:"edition-3D",iconLabel:"3D Edition",label:"3D Edition",component:dt.bind(null,{commandsManager:e,extensionManager:t,servicesManager:n})},{name:"panoramicGenerationPanel",iconName:"panoramic",iconLabel:"Panoramic Generation",label:"Panoramic",component:Et.bind(null,{commandsManager:e,extensionManager:t,servicesManager:n})}]};var Pt=n(40357),At=n(80012),Ut=n(1604),Rt=n(99460);const Nt=JSON.parse('{"UU":"@ohif/extension-default"}').UU,Tt="stack",Ot=e=>e.NumberOfFrames>1,Vt=e=>{const t=e[0],n=new Ut.A(e),{value:a,averageSpacingBetweenFrames:o}=(0,Rt.A)(e);n.setAttributes({displaySetInstanceUID:n.uid,SeriesDate:t.SeriesDate,SeriesTime:t.SeriesTime,SeriesInstanceUID:t.SeriesInstanceUID,StudyInstanceUID:t.StudyInstanceUID,SeriesNumber:t.SeriesNumber||0,FrameRate:t.FrameTime,SOPClassUID:t.SOPClassUID,SeriesDescription:t.SeriesDescription||"",Modality:t.Modality,isMultiFrame:Ot(t),countIcon:a?"icon-mpr":void 0,numImageFrames:e.length,SOPClassHandlerId:`${Nt}.sopClassHandlerModule.${Tt}`,isReconstructable:a,averageSpacingBetweenFrames:o||null});return n.sortBy(((e,t)=>(parseInt(e.InstanceNumber)||0)-(parseInt(t.InstanceNumber)||0))),n},Lt=e=>"CR"===e||"MG"===e||"DX"===e;function kt(e){if(!e||!e.length)throw new Error("No instances were provided");const t=[],n=function(e){const t=new Set;return e.forEach((e=>{t.add(e.SOPClassUID)})),Array.from(t)}(e),a=[];if(e.forEach((e=>{if(!(0,Pt.w)(e.SOPClassUID)&&!e.Rows)return;let o;Ot(e)?(o=Vt([e]),o.setAttributes({sopClassUids:n,isClip:!0,numImageFrames:e.NumberOfFrames,instanceNumber:e.InstanceNumber,acquisitionDatetime:e.AcquisitionDateTime}),t.push(o)):Lt(e.Modality)?(o=Vt([e]),o.setAttributes({sopClassUids:n,instanceNumber:e.InstanceNumber,acquisitionDatetime:e.AcquisitionDateTime}),t.push(o)):a.push(e)})),a.length){const o=Vt(a);o.setAttribute("studyInstanceUid",e[0].StudyInstanceUID),o.setAttributes({sopClassUids:n}),t.push(o)}return t}const Ft=[At.A.ComputedRadiographyImageStorage,At.A.DigitalXRayImageStorageForPresentation,At.A.DigitalXRayImageStorageForProcessing,At.A.DigitalMammographyXRayImageStorageForPresentation,At.A.DigitalMammographyXRayImageStorageForProcessing,At.A.DigitalIntraOralXRayImageStorageForPresentation,At.A.DigitalIntraOralXRayImageStorageForProcessing,At.A.CTImageStorage,At.A.EnhancedCTImageStorage,At.A.LegacyConvertedEnhancedCTImageStorage,At.A.UltrasoundMultiframeImageStorage,At.A.MRImageStorage,At.A.EnhancedMRImageStorage,At.A.EnhancedMRColorImageStorage,At.A.LegacyConvertedEnhancedMRImageStorage,At.A.UltrasoundImageStorage,At.A.UltrasoundImageStorageRET,At.A.SecondaryCaptureImageStorage,At.A.MultiframeSingleBitSecondaryCaptureImageStorage,At.A.MultiframeGrayscaleByteSecondaryCaptureImageStorage,At.A.MultiframeGrayscaleWordSecondaryCaptureImageStorage,At.A.MultiframeTrueColorSecondaryCaptureImageStorage,At.A.XRayAngiographicImageStorage,At.A.EnhancedXAImageStorage,At.A.XRayRadiofluoroscopicImageStorage,At.A.EnhancedXRFImageStorage,At.A.XRay3DAngiographicImageStorage,At.A.XRay3DCraniofacialImageStorage,At.A.BreastTomosynthesisImageStorage,At.A.BreastProjectionXRayImageStorageForPresentation,At.A.BreastProjectionXRayImageStorageForProcessing,At.A.IntravascularOpticalCoherenceTomographyImageStorageForPresentation,At.A.IntravascularOpticalCoherenceTomographyImageStorageForProcessing,At.A.NuclearMedicineImageStorage,At.A.VLEndoscopicImageStorage,At.A.VideoEndoscopicImageStorage,At.A.VLMicroscopicImageStorage,At.A.VideoMicroscopicImageStorage,At.A.VLSlideCoordinatesMicroscopicImageStorage,At.A.VLPhotographicImageStorage,At.A.VideoPhotographicImageStorage,At.A.OphthalmicPhotography8BitImageStorage,At.A.OphthalmicPhotography16BitImageStorage,At.A.OphthalmicTomographyImageStorage,At.A.VLWholeSlideMicroscopyImageStorage,At.A.PositronEmissionTomographyImageStorage,At.A.EnhancedPETImageStorage,At.A.LegacyConvertedEnhancedPETImageStorage,At.A.RTImageStorage,At.A.EnhancedUSVolumeStorage];const Bt=function(){return[{name:Tt,sopClassUids:Ft,getDisplaySetsFromSeries:kt}]};function $t(){return X.createElement("span",{className:"self-center w-4 h-8 mx-2 border-l border-common-dark"})}function zt({rows:e,columns:t,className:n,servicesManager:a,...o}){const[s,i]=(0,X.useState)(!1),{hangingProtocolService:r,toolbarService:c}=a.services,l=()=>{s&&i(!1)};(0,X.useEffect)((()=>{const{unsubscribe:e}=r.subscribe(r.EVENTS.PROTOCOL_CHANGED,(e=>{const{protocol:t}=e}));return()=>{e()}}),[r]),(0,X.useEffect)((()=>(window.addEventListener("click",l),()=>{window.removeEventListener("click",l)})),[s]);const d=s?ne.sG:null;return X.createElement(ne.IB,{id:"Layout",label:"Grid Layout",icon:"tool-layout",onInteraction:()=>i(!s),className:n,rounded:o.rounded,dropdownContent:null!==d&&X.createElement(d,{rows:e,columns:t,onSelection:e=>{c.recordInteraction({interactionType:"action",commands:[{commandName:"setViewportGridLayout",commandOptions:{...e},context:"DEFAULT"}]})}}),isActive:s,type:"toggle"})}zt.propTypes={rows:J().number,columns:J().number,onLayoutChange:J().func,servicesManager:J().instanceOf(i.CS)},zt.defaultProps={rows:3,columns:3,onLayoutChange:()=>{}};const qt=zt,Gt=ne.fk;function Ht(e,t,n,a){const o={selectorProps:e,event:t},s=function(e,t,n){const{subMenu:a}=t,o=function*(){yield function(e,t){if(t)return e.find((e=>e.id===t))}(e,n||a),yield function(e,t){return e?e.find((e=>!e.selector||e.selector(t.selectorProps))):null}(e,t)}();let s=o.next(),i=s.value;for(;!s.done;)i=s.value,i&&o.return(),s=o.next();return console.log("Menu chosen",i?.id||"NONE"),i}(n,o,a);if(!s)return;if(!s.items)return console.warn("Must define items in menu",s),[];let i=[];return s.items.forEach((a=>{const{delegating:s,selector:r,subMenu:c}=a;if(!r||r(e))if(s)i=[...i,...Ht(e,t,n,c)];else{const e=function(e,t){const n={...e,value:t.selectorProps?.value};"ShowSubMenu"!==e.actionType||n.iconRight||(n.iconRight="chevron-menu");e.action||(n.action=(e,a)=>{const{event:o={}}=a,{detail:s={}}=o;n.element=s.element,a.onClose();const i=a[`on${e.actionType||"Default"}`];i?i.call(a,n,e,t):console.warn("No action defined for",e)});return n}(a,o);i.push(e)}})),i}var _t,jt=n(42571);class Wt{constructor(e,t){this.commandsManager=void 0,this.services=void 0,this.menuItems=void 0,this.services=e.services,this.commandsManager=t}closeContextMenu(){this.services.uiDialogService.dismiss({id:"context-menu"})}showContextMenu(e,t,n){if(!this.services.uiDialogService)return void console.warn("Unable to show dialog; no UI Dialog Service available.");const{event:a,subMenu:o,menuId:s,menus:i,selectorProps:r}=e;console.log("Getting items from",i);const c=Ht(r||e,a,i,s);this.services.uiDialogService.dismiss({id:"context-menu"}),this.services.uiDialogService.create({id:"context-menu",isDraggable:!1,preservePosition:!1,preventCutOf:!0,defaultPosition:Wt._getDefaultPosition(n,a?.detail,t),event:a,content:jt.A,onClickOutside:()=>this.services.uiDialogService.dismiss({id:"context-menu"}),contentProps:{items:c,selectorProps:r,menus:i,event:a,subMenu:o,eventData:a?.detail,onClose:()=>{this.services.uiDialogService.dismiss({id:"context-menu"})},onShowSubMenu:(a,o,s)=>{o.subMenu?this.showContextMenu({...e,menuId:o.subMenu},t,n):console.warn("No submenu defined for",a,o,s)},onDefault:(e,t,n)=>{this.commandsManager.run(e,{...r,...t,subProps:n})}}})}}_t=Wt,Wt.getDefaultPosition=()=>({x:0,y:0}),Wt._getEventDefaultPosition=e=>({x:e&&e.currentPoints.client[0],y:e&&e.currentPoints.client[1]}),Wt._getElementDefaultPosition=e=>{if(e){const t=e.getBoundingClientRect();return{x:t.x,y:t.y}}return{x:void 0,y:void 0}},Wt._getCanvasPointsPosition=(e=[],t)=>{const n=_t._getElementDefaultPosition(t);for(let t=0;t<e.length;t++){const a={x:e[t][0]||e[t].x,y:e[t][1]||e[t].y};if(_t._isValidPosition(a)&&_t._isValidPosition(n))return{x:a.x+n.x,y:a.y+n.y}}},Wt._isValidPosition=e=>e&&"number"==typeof e.x&&"number"==typeof e.y,Wt._getDefaultPosition=(e,t,n)=>{const a=function*(){yield _t._getCanvasPointsPosition(e,n),yield _t._getEventDefaultPosition(t),yield _t._getElementDefaultPosition(n),yield _t.getDefaultPosition()}();let o=a.next(),s=o.value;for(;!o.done;)s=o.value,_t._isValidPosition(s)&&a.return(),o=a.next();return s};const Qt={id:"measurementsContextMenu",customizationType:"ohif.contextMenu",menus:[{id:"forExistingMeasurement",selector:({nearbyToolData:e})=>!!e,items:[{label:"Delete curve",commands:[{commandName:"deleteMeasurement"}]},{label:"Add comment",commands:[{commandName:"setMeasurementLabel"}]},{label:"Validate curve",commands:[{commandName:"closeContextMenu"}]}]}]};var Yt=n(14867),Xt=n.n(Yt),Kt=n(28271);const Jt={padding:"10px 0"},Zt={borderBottomWidth:"1px",...Jt};function en({tagRef:e,vrRef:t,keywordRef:n,valueRef:a}){return X.createElement("div",{className:ie()("flex flex-row w-full bg-secondary-dark ohif-scrollbar overflow-y-scroll"),style:Jt},X.createElement("div",{className:"px-3 w-4/24"},X.createElement("label",{ref:e,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},X.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Tag"))),X.createElement("div",{className:"px-3 w-2/24"},X.createElement("label",{ref:t,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},X.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"VR"))),X.createElement("div",{className:"px-3 w-6/24"},X.createElement("label",{ref:n,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},X.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Keyword"))),X.createElement("div",{className:"px-3 w-5/24 grow"},X.createElement("label",{ref:a,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},X.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Value"))))}const tn=function({rows:e}){const t=(0,X.useRef)(),n=(0,X.useRef)(),[a,o]=(0,X.useState)(null),[s,i]=(0,X.useState)(null),[r,c]=(0,X.useState)(null),[l,d]=(0,X.useState)(null);(0,X.useEffect)((()=>{t?.current&&(t.current.scrollTo(0),t.current.resetAfterIndex(0))}),[e]),(0,X.useEffect)((()=>{const e=Pe()((()=>t.current.resetAfterIndex(0)),100);return window.addEventListener("resize",e),()=>{e.cancel(),window.removeEventListener("resize",e)}}),[]);const u=(0,X.useCallback)((({index:t,style:n})=>{const a=e[t];return X.createElement("div",{style:{...n,...Zt},className:ie()("hover:bg-secondary-main transition duration-300 bg-black flex flex-row w-full border-secondary-light items-center text-base break-all","leading-[20px]"),key:`DICOMTagRow-${t}`},X.createElement("div",{className:"px-3 w-4/24"},a[0]),X.createElement("div",{className:"px-3 w-2/24"},a[1]),X.createElement("div",{className:"px-3 w-6/24"},a[2]),X.createElement("div",{className:"px-3 w-5/24 grow"},a[3]))}),[e]),m=(0,X.useCallback)((()=>null!==a),[a]),p=(0,X.useCallback)((t=>{const o=[a.offsetWidth,s.offsetWidth,r.offsetWidth,l.offsetWidth],i=n.current.getContext("2d");return i.font=getComputedStyle(n.current).font,e[t].map(((e,t)=>{const n=i.measureText(e).width;return 20*Math.ceil(n/o[t])+20+1})).reduce(((e,t)=>Math.max(e,t)))}),[e,r,a,l,s]);return X.createElement("div",null,X.createElement("canvas",{style:{visibility:"hidden",position:"absolute"},className:"text-base",ref:n}),X.createElement(en,{tagRef:e=>{e&&o(e)},vrRef:e=>{e&&i(e)},keywordRef:e=>{e&&c(e)},valueRef:e=>{e&&d(e)}}),X.createElement("div",{className:"m-auto relative border-2 border-black bg-black",style:{height:"32rem"}},m()&&X.createElement(Kt._m,{ref:t,height:500,itemCount:e.length,itemSize:p,width:"100%",className:"ohif-scrollbar"},u)))},{ImageSet:nn}=i.classes,{DicomMetaDictionary:an}=h.Ay.data,{nameMap:on}=an;function sn(e,t){const n=[];return e.forEach((e=>{if("SQ"===e.vr){n.push([`${e.tagIndent}${e.tag}`,e.vr,e.keyword,""]);const{values:a}=e;a.forEach(((e,a)=>{const o=sn(e,t);n.push([`${e[0].tagIndent}(FFFE,E000)`,"",`Item #${a}`,""]),n.push(...o)}))}else{if("xs"===e.vr)try{const n=h.Ay.data.Tag.fromPString(e.tag).toCleanString(),a=t[n];e.vr=a.vr}catch(t){console.error(`Failed to parse value representation for tag '${e.keyword}'`)}n.push([`${e.tagIndent}${e.tag}`,e.vr,e.keyword,e.value])}})),n}function rn(e,t=0){const n=Object.keys(e);let a="";for(let e=0;e<t;e++)a+=">";t>0&&(a+=" ");const o=[];for(let i=0;i<n.length;i++){let r=n[i];if("_vrMap"===r)continue;const c=on[r];let l=e[r];if(c&&"SQ"===c.vr){const e=(s=l,Array.isArray(s)?s:[s]),n={tag:c.tag,tagIndent:a,vr:c.vr,keyword:r,values:[]};if(o.push(n),null===l)continue;e.forEach((e=>{const a=rn(e,t+1);a.length&&(cn(a),n.values.push(a))}))}else if(Array.isArray(l)&&l.length>0&&"object"!=typeof l[0]&&(l=l.join("\\")),"number"==typeof l&&(l=l.toString()),"string"!=typeof l&&(null===l?l=" ":"object"==typeof l?l.InlineBinary?l="Inline Binary":l.BulkDataURI?l="Bulk Data URI":l.Alphabetic?l=l.Alphabetic:(console.warn(`Unrecognised Value: ${l} for ${r}:`),console.warn(l),l=" "):(console.warn(`Unrecognised Value: ${l} for ${r}:`),l=" ")),r=r.replace("RETIRED_",""),c)o.push({tag:c.tag,tagIndent:a,vr:c.vr,keyword:r,value:l});else{const e=/[0-9A-Fa-f]{6}/g;if(r.match(e)){const e=`(${r.substring(0,4)},${r.substring(4,8)})`;o.push({tag:e,tagIndent:a,vr:"",keyword:"Private Tag",value:l})}}}var s;return o}function cn(e){e.sort(((e,t)=>e.tag<t.tag?-1:1))}const ln=({displaySets:e,displaySetInstanceUID:t})=>{const n=new Set([1]),[a,o]=(0,X.useState)(t),[s,i]=(0,X.useState)(1),[r,c]=(0,X.useState)(""),l=(0,X.useRef)(null),d=e.find((e=>e.displaySetInstanceUID===a)),u=d instanceof nn;const m=u&&d.images.length>1,p=(0,X.useMemo)((()=>(e.sort(((e,t)=>e.SeriesNumber-t.SeriesNumber)),e.map((e=>{const{displaySetInstanceUID:t,SeriesDate:n,SeriesTime:a,SeriesNumber:o,SeriesDescription:s,Modality:i}=e,r=`${n}:${a}`.split(".")[0];return{value:t,label:`${o} (${i}): ${s}`,description:Xt()(r,"YYYYMMDD:HHmmss").format("ddd, MMM Do YYYY")}})))),[e]),g=(0,X.useMemo)((()=>{let e;e=u?d.images[s-1]:d.instance||d;const t=function(e){const t=rn(e);return cn(t),t}(e);return sn(t,e)}),[s,a]),h=(0,X.useMemo)((()=>{if(!r)return g;const e=r.toLowerCase();return g.filter((t=>t.reduce(((t,a,o)=>t||(n.has(o)?t:t||a.toLowerCase().includes(e))),!1)))}),[g,r]),f=(0,X.useMemo)((()=>Pe()(c,200)),[]);return(0,X.useEffect)((()=>()=>{f?.cancel()}),[]),X.createElement("div",{className:"dicom-tag-browser-content"},X.createElement("div",{className:"flex flex-row mb-6 items-center pl-1"},X.createElement("div",{className:"flex flex-row items-center w-1/2"},X.createElement(ne.o5,{variant:"subtitle",className:"mr-4"},"Series"),X.createElement("div",{className:"grow mr-8"},X.createElement(ne.l6,{id:"display-set-selector",isClearable:!1,onChange:e=>{o(e.value),i(1)},options:p,value:p.find((e=>e.value===a)),className:"text-white"}))),X.createElement("div",{className:"flex flex-row items-center w-1/2"},m&&X.createElement(ne.o5,{variant:"subtitle",className:"mr-4"},"Instance Number"),m&&X.createElement("div",{className:"grow"},X.createElement(ne.Qr,{value:s,key:a,onChange:e=>{i(parseInt(e))},minValue:1,maxValue:d.images.length,step:1,inputClassName:"w-full",labelPosition:"left",trackColor:"#3a3f99"})))),X.createElement("div",{className:"w-full h-1 bg-black"}),X.createElement("div",{className:"flex flex-row my-3 w-1/2"},X.createElement("label",{className:"relative block w-full mr-8"},X.createElement("span",{className:"absolute inset-y-0 left-0 flex items-center pl-2"},X.createElement(ne.In,{name:"icon-search"})),X.createElement("input",{ref:l,type:"text",className:"block bg-black w-full shadow transition duration-300 appearance-none border border-inputfield-main focus:border-inputfield-focus focus:outline-none disabled:border-inputfield-disabled rounded w-full py-2 px-9 text-base leading-tight placeholder:text-inputfield-placeholder",placeholder:"Search metadata...",onChange:e=>f(e.target.value),autoComplete:"off"}),X.createElement("span",{className:"absolute inset-y-0 right-0 flex items-center pr-2"},X.createElement(ne.In,{name:"icon-clear-field",className:ie()("cursor-pointer",r?"":"hidden"),onClick:()=>{l.current.value="",f("")}})))),X.createElement(tn,{rows:h}))},dn=(e,t,n,a)=>{console.log("HP - REUSE CACHED LAYOUT",e,t,n,a);const{activeViewportIndex:o,viewports:s,layout:i}=e,r=t.getState(),{protocolId:c,stageIndex:l,activeStudyUID:d}=r,{protocol:u}=t.getActiveProtocol(),m=u.stages[l],p=`${d}:${c}:${l}`,g=n.getState(),h=`${d}:${c}`,f={...g.viewportGridStore},y={...g.hangingProtocolStageIndexMap},I={...g.displaySetSelectorMap},{rows:S,columns:D}=m.viewportStructure.properties,w=m.viewports.length!==e.viewports.length||e.layout.numRows!==S||e.layout.numCols!==D;y[h]=r,p&&w&&(f[p]={...e});for(let t=0;t<e.viewports.length;t++){const n=e.viewports[t],{displaySetOptions:s,displaySetInstanceUIDs:i}=n;if(s)for(let e=0;e<s.length;e++){const n=i[e];n&&a.includes(n)&&(t===o&&0===e&&(I[`${d}:activeDisplaySet:0`]=n),s[e]?.id&&(I[`${d}:${s[e].id}:${s[e].matchedDisplaySetsIndex||0}`]=n))}}return{hangingProtocolStageIndexMap:y,viewportGridStore:f,displaySetSelectorMap:I}},un=(e,t,n,a,o)=>{const s=t?.[a];if(s)return{...s};const{protocolId:i,stageIndex:r}=e.getState();o.inDisplay||(o.inDisplay=[...t.initialInDisplay]);const c=e.getMissingViewport(i,r,o);if(c){const e=c.displaySetsInfo.map((e=>e.displaySetInstanceUID));return o.inDisplay.push(...e),{displaySetInstanceUIDs:e,displaySetOptions:c.displaySetsInfo.map((e=>e.displaySetOptions)),viewportOptions:{...c.viewportOptions}}}return{}},mn=(e,{numRows:t,numCols:n},a)=>{const{viewports:o}=e,s={...a.getState().viewportsByPosition},i=[];for(const e of o)if(e.positionId){const t={...e,viewportOptions:{...e.viewportOptions}};s[e.positionId]=t,delete t.viewportId,delete t.viewportOptions.viewportId}for(let e=0;e<t;e++)for(let t=0;t<n;t++){const a=t+e*n,r=s[o?.[a]?.positionId||`${t}-${e}`];r?.displaySetInstanceUIDs&&i.push(...r.displaySetInstanceUIDs)}return s.initialInDisplay=i,{viewportsByPosition:s}};var pn=n(85169);const{subscribeToNextViewportGridChange:gn}=i.utils,hn=e=>e&&("setHangingProtocol"===e.commandName||"toggleHangingProtocol"===e.commandName),fn=({servicesManager:e,commandsManager:t})=>{const{customizationService:n,measurementService:a,hangingProtocolService:o,uiNotificationService:s,viewportGridService:i,displaySetService:r,stateSyncService:c,toolbarService:l}=e.services,d=new Wt(e,t),u={showContextMenu:e=>{const{menuCustomizationId:t,element:a,event:s,selectorProps:i,defaultPointsPosition:r=[]}=e,c={...e};t&&Object.assign(c,n.get(t,Qt));const{protocol:l,stage:u}=o.getActiveProtocol();c.selectorProps={event:s,protocol:l,stage:u,...i},d.showContextMenu(c,a,r)},closeContextMenu:()=>{d.closeContextMenu()},displayNotification:({text:e,title:t,type:n})=>{s.show({title:t,message:e,type:n})},clearMeasurements:()=>{a.clear()},toggleHpTools:()=>{const{protocol:e,stageIndex:t,stage:n}=o.getActiveProtocol(),a=o=>{if(!o.id)return;const{commands:s,items:i}=o.props||o;i&&i.forEach(a);const r=s?.find?.(hn);if(!r)return;const{protocolId:c,stageIndex:d,stageId:u}=r.commandOptions,m=!(c&&c!==e.id||void 0!==d&&d!==t||u&&u!==n.id);l.setActive(o.id,m)};Object.values(l.getButtons()).forEach(a)},setHangingProtocol:({activeStudyUID:e="",protocolId:n,stageId:a,stageIndex:l,reset:d=!1})=>{try{const s=i.getState(),m=o.getState(),p=Array.from(r.getDisplaySetCache().entries()).map((e=>e[0])),{protocol:g}=o.getActiveProtocol(),h=dn(s,o,c,p);console.log("HP - STATE SYNC REDUCE",h);const{hangingProtocolStageIndexMap:f,viewportGridStore:y,displaySetSelectorMap:I}=h;if(n){if(void 0===l&&void 0===a){const t=`${e||m.activeStudyUID}:${n}`;l=f[t]?.stageIndex}}else n=m.protocolId,void 0===a&&void 0===l&&(l=m.stageIndex);const S=l??o.getStageIndex(n,{stageId:a,stageIndex:l});e&&o.setActiveStudyUID(e);const D=`${o.getState().activeStudyUID}:${n}:${S||0}`,w=!d&&y[D];if(n!==m.protocolId||S!==m.stageIndex||e?(o.setProtocol(n,{displaySetSelectorMap:I,stageId:a,stageIndex:S,restoreProtocol:w}),w&&i.set(y[D])):o.setProtocol(n,{stageId:a,stageIndex:S}),delete I[`${e||m.activeStudyUID}:activeDisplaySet:0`],c.store(h),u.toggleHpTools(o.getActiveProtocol()),n!==m.protocolId){const{protocol:e}=o.getActiveProtocol();t.run(g.callbacks?.onProtocolExit),t.run(e.callbacks?.onProtocolEnter)}return!0}catch(e){return u.toggleHpTools(o.getActiveProtocol()),s.show({title:"Apply Hanging Protocol",message:"The hanging protocol could not be applied.",type:"error",duration:3e3}),!1}},toggleHangingProtocol:({protocolId:e,stageIndex:t})=>{const{protocol:n,stageIndex:a,activeStudy:s}=o.getActiveProtocol(),{toggleHangingProtocol:i}=c.getState(),r=`${s.StudyInstanceUID}:${e}:${0|t}`;if(n.id!==e||void 0!==t&&t!==a)return c.store({toggleHangingProtocol:{...i,[r]:{protocolId:n.id,stageIndex:a}}}),u.setHangingProtocol({protocolId:e,stageIndex:t,reset:!0});{const e=i[r]||{protocolId:"default"};return u.setHangingProtocol(e)}},deltaStage:({direction:e})=>{const{protocolId:t,stageIndex:n}=o.getState(),{protocol:a}=o.getActiveProtocol();for(let o=n+e;o>=0&&o<a.stages.length;o+=e)if("disabled"!==a.stages[o].status)return u.setHangingProtocol({protocolId:t,stageIndex:o});s.show({title:"Change Stage",message:"The hanging protocol has no more applicable stages",type:"info",duration:3e3})},setViewportGridLayout:({numRows:e,numCols:n})=>{const{protocol:a}=o.getActiveProtocol(),s=a.callbacks?.onLayoutChange;if(!1===t.run(s,{numRows:e,numCols:n}))return void console.log("setViewportGridLayout running",s,e,n);window.setTimeout((()=>{const t=i.getState(),a=mn(t,{numRows:e,numCols:n},c),s=un.bind(null,o,a.viewportsByPosition);i.setLayout({numRows:e,numCols:n,findOrCreateViewport:s}),c.store(a)}),0)},toggleOneUpCustom(){const e=i.getState(),{activeViewportIndex:t,viewports:n,layout:a}=e,{displaySetInstanceUIDs:s,displaySetOptions:r,viewportOptions:l}=n[t];if(console.log("DoubleClick - TOGGLE ONE UP",l),1===a.numCols&&1===a.numRows){const{toggleOneUpViewportGridStore:e}=c.getState();if(!e.layout)return;const t=e.activeViewportIndex,n=s.length>1?[]:s.map((e=>o.getViewportsRequireUpdate(t,e))).flat(),a=t=>{const a=n.find((e=>e.viewportIndex===t));return a?{viewportOptions:l,displaySetOptions:r,...a}:e.viewports[t]},d=i.getLayoutOptionsFromState(e);i.setLayout({numRows:e.layout.numRows,numCols:e.layout.numCols,activeViewportIndex:t,layoutOptions:d,findOrCreateViewport:a})}else{c.store({toggleOneUpViewportGridStore:e});const t=()=>({displaySetInstanceUIDs:s,displaySetOptions:r,viewportOptions:l});i.setLayout({numRows:1,numCols:1,findOrCreateViewport:t})}},toggleOneUp(){const e=i.getState(),{activeViewportIndex:t,viewports:n,layout:a}=e,{displaySetInstanceUIDs:s,displaySetOptions:r,viewportOptions:l}=n[t];if(1===a.numCols&&1===a.numRows){const{toggleOneUpViewportGridStore:e}=c.getState();if(!e.layout)return;const t=e.activeViewportIndex,n=s.length>1?[]:s.map((e=>o.getViewportsRequireUpdate(t,e))).flat(),a=t=>{const a=n.find((e=>e.viewportIndex===t));return a?{viewportOptions:l,displaySetOptions:r,...a}:e.viewports[t]},d=i.getLayoutOptionsFromState(e);i.setLayout({numRows:e.layout.numRows,numCols:e.layout.numCols,activeViewportIndex:t,layoutOptions:d,findOrCreateViewport:a})}else{c.store({toggleOneUpViewportGridStore:e});const t=()=>({displaySetInstanceUIDs:s,displaySetOptions:r,viewportOptions:l});i.setLayout({numRows:1,numCols:1,findOrCreateViewport:t});gn(i,(()=>{c.store({toggleOneUpViewportGridStore:{}})}))}},navigateHistory(e){pn.b.navigate(e.to,e.options)},openDICOMTagViewer(){const{activeViewportIndex:t,viewports:n}=i.getState(),a=n[t],{displaySetInstanceUIDs:o}=a,s=r.activeDisplaySets,{UIModalService:c}=e.services,l=o[0];c.show({content:ln,contentProps:{displaySets:s,displaySetInstanceUID:l,onClose:c.hide},title:"DICOM Tag Browser"})},toggleOverlays:()=>{const e=document.getElementsByClassName("viewport-overlay");for(let t=0;t<e.length;t++)e.item(t).classList.toggle("hidden")},scrollActiveThumbnailIntoView:()=>{const{activeViewportIndex:e,viewports:t}=i.getState();if(!t||e<0||e>t.length-1)return;const n=t[e].displaySetInstanceUIDs[0],a=document.querySelector("#ohif-thumbnail-list");if(!a)return;const o=a.getBoundingClientRect(),s=document.querySelector(`#thumbnail-${n}`);if(!s)return;const r=s.getBoundingClientRect();r.top>=o.top&&r.top<=o.bottom||s.scrollIntoView({behavior:"smooth"})},updateViewportDisplaySet:({direction:e,excludeNonImageModalities:t})=>{const n=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"],a=o.getDisplaySetSortFunction(),c=[...r.activeDisplaySets];c.sort(a);const{activeViewportIndex:l,viewports:d}=i.getState(),{displaySetInstanceUIDs:m}=d[l];let p;for(p=c.findIndex((e=>m.includes(e.displaySetInstanceUID)))+e;p>-1&&p<c.length&&(t&&n.includes(c[p].Modality));p+=e);if(p<0||p>=c.length)return;const{displaySetInstanceUID:g}=c[p];let h=[];try{h=o.getViewportsRequireUpdate(l,g)}catch(e){console.warn(e),s.show({title:"Navigate Viewport Display Set",message:"The requested display sets could not be added to the viewport due to a mismatch in the Hanging Protocol rules.",type:"info",duration:3e3})}i.setDisplaySetsForViewports(h),setTimeout((()=>u.scrollActiveThumbnailIntoView()),0)}},m={showContextMenu:{commandFn:u.showContextMenu},closeContextMenu:{commandFn:u.closeContextMenu},clearMeasurements:{commandFn:u.clearMeasurements,storeContexts:[],options:{}},displayNotification:{commandFn:u.displayNotification,storeContexts:[],options:{}},setHangingProtocol:{commandFn:u.setHangingProtocol,storeContexts:[],options:{}},toggleHangingProtocol:{commandFn:u.toggleHangingProtocol,storeContexts:[],options:{}},navigateHistory:{commandFn:u.navigateHistory,storeContexts:[],options:{}},nextStage:{commandFn:u.deltaStage,storeContexts:[],options:{direction:1}},previousStage:{commandFn:u.deltaStage,storeContexts:[],options:{direction:-1}},setViewportGridLayout:{commandFn:u.setViewportGridLayout,storeContexts:[],options:{}},toggleOneUp:{commandFn:u.toggleOneUp,storeContexts:[],options:{}},toggleOneUpCustom:{commandFn:u.toggleOneUpCustom,storeContexts:[],options:{}},openDICOMTagViewer:{commandFn:u.openDICOMTagViewer},updateViewportDisplaySet:{commandFn:u.updateViewportDisplaySet,storeContexts:[],options:{}}};return{actions:u,definitions:m,defaultContext:"DEFAULT"}},yn={hasUpdatedPriorsInformation:!1,id:"@ohif/mnGrid",description:"Has various hanging protocol grid layouts",name:"2x2",protocolMatchingRules:[{id:"OneOrMoreSeries",weight:25,attribute:"numberOfDisplaySetsWithImages",constraint:{greaterThan:0}}],toolGroupIds:["default"],displaySetSelectors:{defaultDisplaySetId:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:10,constraint:{equals:!0}}]}},defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},stages:[{id:"2x2",stageActivation:{enabled:{minViewportsMatched:4}},viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:2,id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:3,id:"defaultDisplaySetId"}]}]},{id:"3x1",requiredViewports:1,preferredViewports:3,stageActivation:{enabled:{minViewportsMatched:3}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:3}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:1}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:2}]}]},{id:"2x1",requiredViewports:1,preferredViewports:2,stageActivation:{enabled:{minViewportsMatched:2}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:2}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]}]},{id:"1x1",requiredViewports:1,preferredViewports:1,stageActivation:{enabled:{minViewportsMatched:1}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]}]}],numberOfPriorsReferenced:-1},In={id:"default",locked:!0,hasUpdatedPriorsInformation:!1,name:"Default",createdDate:"2021-02-23T19:22:08.894Z",modifiedDate:"2023-04-01",availableTo:{},editableBy:{},protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{defaultDisplaySetId:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isSeriesUIDFromURL",weight:10,constraint:{equals:!0}}]}},stages:[{name:"default",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{viewportType:"stack",toolGroupId:"default",initialImageOptions:{custom:"sopInstanceLocation"}},displaySets:[{id:"defaultDisplaySetId"}]}],createdDate:"2021-02-23T18:32:42.850Z"}]};const Sn=function(){return[{name:In.id,protocol:In},{name:yn.id,protocol:yn}]};const Dn=function(){const[e]=(0,oe.r)(),t=(0,Z.Zp)(),n=e.dataSources;return X.createElement("div",{style:{width:"100%",height:"100%"}},X.createElement("div",{className:"h-screen w-screen flex justify-center items-center "},X.createElement("div",{className:"py-8 px-8 mx-auto bg-secondary-dark drop-shadow-md space-y-2 rounded-lg"},X.createElement("img",{className:"block mx-auto h-14",src:"./ohif-logo.svg",alt:"OHIF"}),X.createElement("div",{className:"text-center space-y-2 pt-4"},n.filter((e=>"dicomjson"!==e.sourceName&&"dicomlocal"!==e.sourceName)).map((e=>X.createElement("div",{key:e.sourceName},X.createElement("h1",{className:"text-white"},e.friendlyName),X.createElement(ne.$n,{className:ie()("font-bold","ml-2"),onClick:()=>{t({pathname:"/",search:`datasources=${e.sourceName}`})}},e.sourceName),X.createElement("br",null))))))))};var wn=n(48405);const vn=i.Ay.classes.MetadataProvider;var bn=n(36681);const{registerColormap:xn}=Be.utilities.colormap,Cn=i.classes.MetadataProvider;const En=({SeriesInstanceUID:e,StudyInstanceUID:t})=>{const{instances:n}=i.DicomMetadataStore.getSeries(t,e);if("PT"!==n[0].Modality)return;const a=n.map((e=>e.imageId)),o=[];if(a.forEach((e=>{const t=function(e){const t=vn.get("instance",e);if(!t)throw new Error("dicom metadata are required");if(void 0===t.SeriesDate||void 0===t.SeriesTime||void 0===t.PatientWeight||void 0===t.CorrectedImage||void 0===t.Units||!t.RadiopharmaceuticalInformationSequence||void 0===t.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife||void 0===t.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose||void 0===t.DecayCorrection||void 0===t.AcquisitionDate||void 0===t.AcquisitionTime||void 0===t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime&&void 0===t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime)throw new Error("required metadata are missing");const n={CorrectedImage:t.CorrectedImage,Units:t.Units,RadionuclideHalfLife:t.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife,RadionuclideTotalDose:t.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose,RadiopharmaceuticalStartDateTime:t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime,RadiopharmaceuticalStartTime:t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime,DecayCorrection:t.DecayCorrection,PatientWeight:t.PatientWeight,SeriesDate:t.SeriesDate,SeriesTime:t.SeriesTime,AcquisitionDate:t.AcquisitionDate,AcquisitionTime:t.AcquisitionTime};if(t[70531e3]||void 0!==t[70531e3]||t[70531009]||void 0!==t[70531009]){const e={SUVScaleFactor:t[70531e3],ActivityConcentrationScaleFactor:t[70531009]};n.PhilipsPETPrivateGroup=e}return t["0009100d"]&&void 0!==t["0009100d"]&&(n.GEPrivatePostInjectionDateTime=t["0009100d"]),t.FrameReferenceTime&&void 0!==t.FrameReferenceTime&&(n.FrameReferenceTime=t.FrameReferenceTime),t.ActualFrameDuration&&void 0!==t.ActualFrameDuration&&(n.ActualFrameDuration=t.ActualFrameDuration),t.PatientSex&&void 0!==t.PatientSex&&(n.PatientSex=t.PatientSex),t.PatientSize&&void 0!==t.PatientSize&&(n.PatientSize=t.PatientSize),n}(e);t&&o.push(t)})),!o.length)return;let s;try{s=(0,wn.C)(o)}catch(e){console.log(e)}s&&(o.forEach(((e,t)=>{Cn.addCustomMetadata(a[t],"scalingModule",s[t])})),bn.A.forEach(xn))},Mn={id:Nt,preRegistration:function({servicesManager:e,configuration:t={}}){const{stateSyncService:n}=e.services;i.DicomMetadataStore.subscribe(i.DicomMetadataStore.EVENTS.INSTANCES_ADDED,En),i.DicomMetadataStore.subscribe(i.DicomMetadataStore.EVENTS.SERIES_UPDATED,En),n.register("viewportGridStore",{clearOnModeExit:!0}),n.register("displaySetSelectorMap",{clearOnModeExit:!0}),n.register("hangingProtocolStageIndexMap",{clearOnModeExit:!0}),n.register("toggleHangingProtocol",{clearOnModeExit:!0}),n.register("viewportsByPosition",{clearOnModeExit:!0})},getDataSourcesModule:Y,getLayoutTemplateModule:function({servicesManager:e,extensionManager:t,commandsManager:n,hotkeysManager:a}){return[{name:"viewerLayout",id:"viewerLayout",component:function(o){return pe({servicesManager:e,extensionManager:t,commandsManager:n,hotkeysManager:a,...o})}}]},getPanelModule:Mt,getHangingProtocolModule:Sn,getSopClassHandlerModule:Bt,getToolbarModule:function({commandsManager:e,servicesManager:t}){return[{name:"ohif.divider",defaultComponent:$t,clickHandler:()=>{}},{name:"ohif.action",defaultComponent:ne.IB,clickHandler:()=>{}},{name:"ohif.radioGroup",defaultComponent:ne.IB,clickHandler:()=>{}},{name:"ohif.splitButton",defaultComponent:Gt,clickHandler:()=>{}},{name:"ohif.layoutSelector",defaultComponent:qt,clickHandler:(e,t,n)=>{}},{name:"ohif.toggle",defaultComponent:ne.IB,clickHandler:()=>{}}]},getCommandsModule:fn,getUtilityModule:({servicesManager:e})=>[{name:"common",exports:{getStudiesForPatientByMRN:we}}],getCustomizationModule:function(){return[{name:"helloPage",value:{id:"customRoutes",routes:[{path:"/custom",children:()=>X.createElement("h1",{style:{color:"white"}},"Hello Custom Route")}]}},{name:"datasources",value:{id:"customRoutes",routes:[{path:"/datasources",children:Dn}]}},{name:"default",value:[{id:"ohif.overlayItem",content:function(e){if(this.condition&&!this.condition(e))return null;const{instance:t}=e,n=t&&this.attribute?t[this.attribute]:this.contentF&&"function"==typeof this.contentF?this.contentF(e):null;return n?X.createElement("span",{className:"overlay-item flex flex-row",style:{color:this.color||void 0},title:this.title||""},this.label&&X.createElement("span",{className:"mr-1 shrink-0"},this.label),X.createElement("span",{className:"font-light"},n)):null}},{id:"ohif.contextMenu",transform:function(e){const t={...this};t.menus=this.menus.map((e=>({...e})));for(const n of t.menus){const{items:t}=n;n.items=[];for(const a of t)n.items.push(e.transform(a))}return t}}]}]}}}}]);
//# sourceMappingURL=864.bundle.aaff4c636c52a7b32712.js.map