(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[707],{31197:(e,t,n)=>{"use strict";n.r(t),n.d(t,{CornerstoneExtensionTypes:()=>o,default:()=>nn,getActiveViewportEnabledElement:()=>w,measurementMappingUtils:()=>i,toolNames:()=>b});var o={};n.r(o);var i={};n.r(i),n.d(i,{getFirstAnnotationSelected:()=>Ye,getHandlesFromPoints:()=>Xt,getModalityUnit:()=>U,getSOPInstanceAttributes:()=>N.Z,isAnnotationSelected:()=>He,setAnnotationSelected:()=>Ze});var r=n(32735),a=n(98386),s=n(72853),l=n(48501),c=n(28909),d=n(99605),m=n.n(d),u=n(43264),p=n.n(u);const{registerVolumeLoader:g}=a.volumeLoader;let h=!1;function I(e,t){m().external.cornerstone=a,m().external.dicomParser=p(),g("cornerstoneStreamingImageVolume",c.IU),m().configure({decodeConfig:{convertFloatPixelDataToInt:!1},beforeSend:function(n){const o=e.getAuthorizationHeader(),i={Accept:t.omitQuotationForMultipartRequest?"multipart/related; type=application/octet-stream":'multipart/related; type="application/octet-stream"'};return o&&Object.assign(i,o),i},errorInterceptor:e=>{l.Po.getHTTPErrorHandler(e)}}),function(e){const t={maxWebWorkers:Math.min(Math.max(navigator.hardwareConcurrency-1,1),e.maxNumberOfWebWorkers),startWebWorkersOnDemand:!0,taskConfiguration:{decodeTask:{initializeCodecsOnStartup:!1,usePDFJS:!1,strict:!1}}};h||(m().webWorkerManager.initialize(t),h=!0)}(t)}var S=n(22605);const f=function(e,t,n,o=!0,i={}){const a="dialog-enter-annotation",s=t?o?t.text:t.label:"",{dialogTitle:l="Annotation",inputLabel:c="Enter your annotation",validateFunc:d=(e=>!0)}=i,m=({action:t,value:o})=>{switch(t.id){case"save":if("function"==typeof d&&!d(o.label))return;n(o.label,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:a})};e&&e.create({id:a,centralize:!0,isDraggable:!1,showOverlay:!0,content:S.Vq,contentProps:{title:l,value:{label:s},noCloseButton:!0,onClose:()=>e.dismiss({id:a}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:m,body:({value:e,setValue:t})=>r.createElement(S.II,{autoFocus:!0,className:"bg-black border-primary-main",type:"text",id:"annotation",label:c,labelClassName:"text-white text-[14px] leading-[1.2]",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&m({value:e,action:{id:"save"}})}})}})};var v=n(21922);function w(e){const{activeViewportIndex:t}=e.getState(),{element:n}=(0,v.K8)(t)||{};return(0,a.getEnabledElement)(n)}const{calibrateImageSpacing:E}=s.utilities;class y extends s.LengthTool{constructor(...e){super(...e),this._renderingViewport=void 0,this._lengthToolRenderAnnotation=this.renderAnnotation,this.renderAnnotation=(e,t)=>{const{viewport:n}=e;return this._renderingViewport=n,this._lengthToolRenderAnnotation(e,t)}}_getTextLines(e,t){const[n,o]=e.handles.points.map((e=>this._renderingViewport.worldToCanvas(e)));return[`${Math.round(100*function(e,t){const n=e[0]-t[0],o=e[1]-t[1];return Math.sqrt(n*n+o*o)}(n,o))/100}px`]}}y.toolName="CalibrationLine";const T=y;function D(e,t){const{uiDialogService:n,viewportGridService:o}=e.services,i=t.detail,{annotation:{metadata:r,data:s}}=i,{referencedImageId:l}=r,c=w(o),{viewport:d}=c,m=Math.round(100*function(e,t){const n=e[0]-t[0],o=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+o*o+i*i)}(s.handles.points[0],s.handles.points[1]))/100,u=a.metaData.get("calibratedPixelSpacing",l),p=a.metaData.get("imagePlaneModule",l),g=u?.[0]||p?.rowPixelSpacing||1,h=u?.[1]||p?.columnPixelSpacing||1;return new Promise(((e,t)=>{n?f(n,{text:"",label:`${m}`},((n,o)=>{"save"===o?((e=>{const t=e/m,n=t*g,o=t*h;E(l,d.getRenderingEngine(),n,o)})(Number.parseFloat(n)),e(!0)):t("cancel")}),!1,{dialogTitle:"Calibration",inputLabel:"Actual Physical distance (mm)",validateFunc:e=>{try{const t=Number.parseFloat(e);return!isNaN(t)&&0!==t}catch{return!1}}}):t("UIDialogService is not initiated")}))}const b={Pan:s.PanTool.toolName,ArrowAnnotate:s.ArrowAnnotateTool.toolName,WindowLevel:s.WindowLevelTool.toolName,StackScroll:s.StackScrollTool.toolName,StackScrollMouseWheel:s.StackScrollMouseWheelTool.toolName,Zoom:s.ZoomTool.toolName,VolumeRotateMouseWheel:s.VolumeRotateMouseWheelTool.toolName,MipJumpToClick:s.MIPJumpToClickTool.toolName,Length:s.LengthTool.toolName,DragProbe:s.DragProbeTool.toolName,Probe:s.ProbeTool.toolName,RectangleROI:s.RectangleROITool.toolName,EllipticalROI:s.EllipticalROITool.toolName,CircleROI:s.CircleROITool.toolName,Bidirectional:s.BidirectionalTool.toolName,Angle:s.AngleTool.toolName,CobbAngle:s.CobbAngleTool.toolName,PlanarFreehandROI:s.PlanarFreehandROITool.toolName,Magnify:s.MagnifyTool.toolName,Crosshairs:s.CrosshairsTool.toolName,SegmentationDisplay:s.SegmentationDisplayTool.toolName,ReferenceLines:s.ReferenceLinesTool.toolName,CalibrationLine:T.toolName,TrackballRotateTool:s.TrackballRotateTool.toolName,BrushTool:s.BrushTool.toolName,CircleScissorsTool:s.CircleScissorsTool.toolName,PaintFillTool:s.PaintFillTool.toolName,RectangleROIStartEndThresholdTool:s.RectangleROIStartEndThresholdTool.toolName,RectangleROIThresholdTool:s.RectangleROIThresholdTool.toolName,RectangleScissorsTool:s.RectangleScissorsTool.toolName,SphereScissorsTool:s.SphereScissorsTool.toolName,UndoTool:s.UndoTool.toolName},O=["Length","EllipticalROI","CircleROI","Bidirectional","ArrowAnnotate","Angle","CobbAngle","Probe","RectangleROI","PlanarFreehandROI"];var N=n(63130);const M={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:i,viewportId:r}=e,{metadata:a,data:s,annotationUID:c}=i;if(!a||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:d,referencedImageId:m,FrameOfReferenceUID:u}=a;if(!O.includes(d))throw new Error("Tool not supported");const{SOPInstanceUID:p,SeriesInstanceUID:g,StudyInstanceUID:h}=(0,N.Z)(m,n,r);let I;I=p?t.getDisplaySetForSOPInstanceUID(p,g):t.getDisplaySetsForSeries(g);const{points:S}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{cachedStats:i}=o,{referencedImageId:r}=n;if(!Object.keys(i).length)return[];const a=[];return Object.keys(i).forEach((e=>{const n=i[e];if(!r)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,N.Z)(r),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{length:m}=n,u="mm";a.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,unit:u,length:m})})),a}(i,t),v=function(e,t){if(!e||!e.length)return"";const n=[],{length:o,SeriesNumber:i,SOPInstanceUID:r,frameNumber:a}=e[0],s=t.images.find((e=>e.SOPInstanceUID===r));let c;s&&(c=s.InstanceNumber);const d=c?` I: ${c}`:"",m=t.isMultiFrame?` F: ${a}`:"";if(null==o)return n;const u=l.utils.roundNumber(o,2);return n.push(`${u} mm (S: ${i}${d}${m})`),n}(f,I);return{uid:c,SOPInstanceUID:p,FrameOfReferenceUID:u,points:S,metadata:a,referenceSeriesUID:g,referenceStudyUID:h,frameNumber:f[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:I.displaySetInstanceUID,label:s.label,displayText:v,data:s.cachedStats,type:o(d),getReport:()=>function(e,t,n){const o=[],i=[];o.push("AnnotationType"),i.push("Cornerstone:Length"),e.forEach((e=>{const{length:t}=e;o.push("Length (mm)"),i.push(t)})),n&&(o.push("FrameOfReferenceUID"),i.push(n));t&&(o.push("points"),i.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:i}}(f,S,u)}}};const C={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:i,viewportId:r}=e,{metadata:a,data:s,annotationUID:c}=i;if(!a||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:d,referencedImageId:m,FrameOfReferenceUID:u}=a;if(!O.includes(d))throw new Error("Tool not supported");const{SOPInstanceUID:p,SeriesInstanceUID:g,StudyInstanceUID:h}=(0,N.Z)(m,n,r);let I;I=p?t.getDisplaySetForSOPInstanceUID(p,g):t.getDisplaySetsForSeries(g);const{points:S}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{cachedStats:i}=o,{referencedImageId:r,referencedSeriesInstanceUID:a}=n;if(!Object.keys(i).length)return[];const s=[];return Object.keys(i).forEach((e=>{const n=i[e];if(!r)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:a,frameNumber:l}=(0,N.Z)(r),c=t.getDisplaySetForSOPInstanceUID(o,a,l),{SeriesNumber:d}=c,{length:m,width:u}=n,p="mm";s.push({SeriesInstanceUID:a,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,unit:p,length:m,width:u})})),s}(i,t),v=function(e,t){if(!e||!e.length)return"";const n=[],{length:o,width:i,SeriesNumber:r,SOPInstanceUID:a,frameNumber:s}=e[0],c=l.utils.roundNumber(o,2),d=l.utils.roundNumber(i,2),m=t.images.find((e=>e.SOPInstanceUID===a));let u;m&&(u=m.InstanceNumber);const p=u?` I: ${u}`:"",g=t.isMultiFrame?` F: ${s}`:"";return n.push(`L: ${c} mm (S: ${r}${p}${g})`),n.push(`W: ${d} mm`),n}(f,I);return{uid:c,SOPInstanceUID:p,FrameOfReferenceUID:u,points:S,metadata:a,referenceSeriesUID:g,referenceStudyUID:h,frameNumber:f[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:I.displaySetInstanceUID,label:s.label,displayText:v,data:s.cachedStats,type:o(d),getReport:()=>function(e,t,n){const o=[],i=[];o.push("AnnotationType"),i.push("Cornerstone:Bidirectional"),e.forEach((e=>{const{length:t,width:n}=e;o.push("Length (mm)","Width (mm)"),i.push(t,n)})),n&&(o.push("FrameOfReferenceUID"),i.push(n));t&&(o.push("points"),i.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:i}}(f,S,u)}}};const U=function(e){return"CT"===e?"HU":"PT"===e?"SUV":""};const A={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:i,viewportId:r}=e,{metadata:a,data:s,annotationUID:c}=i;if(!a||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:d,referencedImageId:m,FrameOfReferenceUID:u}=a;if(!O.includes(d))throw new Error("Tool not supported");const{SOPInstanceUID:p,SeriesInstanceUID:g,StudyInstanceUID:h}=(0,N.Z)(m,n,r);let I;I=p?t.getDisplaySetForSOPInstanceUID(p,g):t.getDisplaySetsForSeries(g);const{points:S}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{cachedStats:i}=o,{referencedImageId:r}=n;if(!Object.keys(i).length)return[];const a=[];return Object.keys(i).forEach((e=>{const n=i[e];if(!r)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,N.Z)(r),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{mean:m,stdDev:u,max:p,area:g,Modality:h}=n,I=U(h);a.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,Modality:h,unit:I,mean:m,stdDev:u,max:p,area:g})})),a}(i,t),v=function(e,t){if(!e||!e.length)return"";const n=[],{area:o,SOPInstanceUID:i,frameNumber:r}=e[0],a=t.images.find((e=>e.SOPInstanceUID===i));let s;a&&(s=a.InstanceNumber);const c=s?` I: ${s}`:"",d=t.isMultiFrame?` F: ${r}`:"",m=l.utils.roundNumber(o||0,2);return n.push(`${m} mm<sup>2</sup>`),e.forEach((e=>{const{unit:t,max:o,SeriesNumber:i}=e;let r="";if(o){r=`Max: ${l.utils.roundNumber(o,2)} <small>${t}</small> `}const a=`${r}(S:${i}${c}${d})`;n.includes(a)||n.push(a)})),n}(f,I);return{uid:c,SOPInstanceUID:p,FrameOfReferenceUID:u,points:S,metadata:a,referenceSeriesUID:g,referenceStudyUID:h,frameNumber:f[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:I.displaySetInstanceUID,label:s.label,displayText:v,data:s.cachedStats,type:o(d),getReport:()=>function(e,t,n){const o=[],i=[];o.push("AnnotationType"),i.push("Cornerstone:EllipticalROI"),e.forEach((e=>{const{mean:t,stdDev:n,max:r,area:a,unit:s}=e;t&&s&&r&&a&&(o.push(`max (${s})`,`mean (${s})`,`std (${s})`,"area (mm2)"),i.push(r,t,n,a))})),n&&(o.push("FrameOfReferenceUID"),i.push(n));t&&(o.push("points"),i.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:i}}(f,S,u)}}},R={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:i,viewportId:r}=e,{metadata:a,data:s,annotationUID:c}=i;if(!a||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:d,referencedImageId:m,FrameOfReferenceUID:u}=a;if(!O.includes(d))throw new Error("Tool not supported");const{SOPInstanceUID:p,SeriesInstanceUID:g,StudyInstanceUID:h}=(0,N.Z)(m,n,r);let I;I=p?t.getDisplaySetForSOPInstanceUID(p,g):t.getDisplaySetsForSeries(g);const{points:S}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{cachedStats:i}=o,{referencedImageId:r}=n;if(!Object.keys(i).length)return[];const a=[];return Object.keys(i).forEach((e=>{const n=i[e];if(!r)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,N.Z)(r),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{mean:m,stdDev:u,max:p,area:g,Modality:h}=n,I=U(h);a.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,Modality:h,unit:I,mean:m,stdDev:u,max:p,area:g})})),a}(i,t),v=function(e,t){if(!e||!e.length)return"";const n=[],{area:o,SOPInstanceUID:i,frameNumber:r}=e[0],a=t.images.find((e=>e.SOPInstanceUID===i));let s;a&&(s=a.InstanceNumber);const c=s?` I: ${s}`:"",d=t.isMultiFrame?` F: ${r}`:"",m=l.utils.roundNumber(o||0,2);return n.push(`${m} mm<sup>2</sup>`),e.forEach((e=>{const{unit:t,max:o,SeriesNumber:i}=e;let r="";if(o){r=`Max: ${l.utils.roundNumber(o,2)} <small>${t}</small> `}const a=`${r}(S:${i}${c}${d})`;n.includes(a)||n.push(a)})),n}(f,I);return{uid:c,SOPInstanceUID:p,FrameOfReferenceUID:u,points:S,metadata:a,referenceSeriesUID:g,referenceStudyUID:h,frameNumber:f[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:I.displaySetInstanceUID,label:s.label,displayText:v,data:s.cachedStats,type:o(d),getReport:()=>function(e,t,n){const o=[],i=[];o.push("AnnotationType"),i.push("Cornerstone:CircleROI"),e.forEach((e=>{const{mean:t,stdDev:n,max:r,area:a,unit:s}=e;t&&s&&r&&a&&(o.push(`max (${s})`,`mean (${s})`,`std (${s})`,"area (mm2)"),i.push(r,t,n,a))})),n&&(o.push("FrameOfReferenceUID"),i.push(n));t&&(o.push("points"),i.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:i}}(f,S,u)}}};const V=R;const P={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:i,viewportId:r}=e,{metadata:a,data:s,annotationUID:l}=i;if(!a||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:d,FrameOfReferenceUID:m}=a;if(!O.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:u,SeriesInstanceUID:p,StudyInstanceUID:g}=(0,N.Z)(d,n,r);let h;h=u?t.getDisplaySetForSOPInstanceUID(u,p):t.getDisplaySetsForSeries(p);const{points:I}=s.handles,S=function(e,t){const{metadata:n,data:o}=e,{text:i}=o,{referencedImageId:r}=n,a=[],{SOPInstanceUID:s,SeriesInstanceUID:l,frameNumber:c}=(0,N.Z)(r),d=t.getDisplaySetForSOPInstanceUID(s,l,c),{SeriesNumber:m}=d;return a.push({SeriesInstanceUID:l,SOPInstanceUID:s,SeriesNumber:m,frameNumber:c,text:i}),a}(i,t),f=function(e,t){if(!e)return"";const n=[],{SeriesNumber:o,SOPInstanceUID:i,frameNumber:r}=e[0],a=t.images.find((e=>e.SOPInstanceUID===i));let s;a&&(s=a.InstanceNumber);const l=s?` I: ${s}`:"",c=t.isMultiFrame?` F: ${r}`:"";return n.push(`(S: ${o}${l}${c})`),n}(S,h);return{uid:l,SOPInstanceUID:u,FrameOfReferenceUID:m,points:I,metadata:a,referenceSeriesUID:p,referenceStudyUID:g,frameNumber:S[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:h.displaySetInstanceUID,label:s.text,text:s.text,displayText:f,data:s.cachedStats,type:o(c),getReport:()=>{throw new Error("Not implemented")}}}},_={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:i,viewportId:r}=e,{metadata:a,data:s,annotationUID:c}=i;if(!a||!s)return console.warn("Cobb Angle tool: Missing metadata or data"),null;const{toolName:d,referencedImageId:m,FrameOfReferenceUID:u}=a;if(!O.includes(d))throw new Error("Tool not supported");const{SOPInstanceUID:p,SeriesInstanceUID:g,StudyInstanceUID:h}=(0,N.Z)(m,n,r);let I;I=p?t.getDisplaySetForSOPInstanceUID(p,g):t.getDisplaySetsForSeries(g);const{points:S}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{cachedStats:i}=o,{referencedImageId:r}=n;if(!Object.keys(i).length)return;const a=[];return Object.keys(i).forEach((e=>{const n=i[e];if(!r)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,N.Z)(r),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{angle:m}=n,u="°";a.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,unit:u,angle:m})})),a}(i,t),v=function(e,t){if(!e||!e.length)return"";const n=[],{angle:o,unit:i,SeriesNumber:r,SOPInstanceUID:a,frameNumber:s}=e[0],c=t.images.find((e=>e.SOPInstanceUID===a));let d;c&&(d=c.InstanceNumber);const m=d?` I: ${d}`:"",u=t.isMultiFrame?` F: ${s}`:"";if(void 0===o)return n;const p=l.utils.roundNumber(o,2);return n.push(`${p} ${i} (S: ${r}${m}${u})`),n}(f,I);return{uid:c,SOPInstanceUID:p,FrameOfReferenceUID:u,points:S,metadata:a,referenceSeriesUID:g,referenceStudyUID:h,frameNumber:f?.[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:I.displaySetInstanceUID,label:s.label,displayText:v,data:s.cachedStats,type:o(d),getReport:()=>function(e,t,n){const o=[],i=[];o.push("AnnotationType"),i.push("Cornerstone:CobbAngle"),e.forEach((e=>{const{angle:t,unit:n}=e;o.push(`Angle (${n})`),i.push(t)})),n&&(o.push("FrameOfReferenceUID"),i.push(n));t&&(o.push("points"),i.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:i}}(f,S,u)}}};const F=_,x={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:i,viewportId:r}=e,{metadata:a,data:s,annotationUID:c}=i;if(!a||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:d,referencedImageId:m,FrameOfReferenceUID:u}=a;if(!O.includes(d))throw new Error("Tool not supported");const{SOPInstanceUID:p,SeriesInstanceUID:g,StudyInstanceUID:h}=(0,N.Z)(m,n,r);let I;I=p?t.getDisplaySetForSOPInstanceUID(p,g):t.getDisplaySetsForSeries(g);const{points:S}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{cachedStats:i}=o,{referencedImageId:r}=n;if(!Object.keys(i).length)return;const a=[];return Object.keys(i).forEach((e=>{const n=i[e];if(!r)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,N.Z)(r),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{angle:m}=n,u="°";a.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,unit:u,angle:m})})),a}(i,t),v=function(e,t){if(!e||!e.length)return"";const n=[],{angle:o,unit:i,SeriesNumber:r,SOPInstanceUID:a,frameNumber:s}=e[0],c=t.images.find((e=>e.SOPInstanceUID===a));let d;c&&(d=c.InstanceNumber);const m=d?` I: ${d}`:"",u=t.isMultiFrame?` F: ${s}`:"";if(void 0===o)return n;const p=l.utils.roundNumber(o,2);return n.push(`${p} ${i} (S: ${r}${m}${u})`),n}(f,I);return{uid:c,SOPInstanceUID:p,FrameOfReferenceUID:u,points:S,metadata:a,referenceSeriesUID:g,referenceStudyUID:h,frameNumber:f?.[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:I.displaySetInstanceUID,label:s.label,displayText:v,data:s.cachedStats,type:o(d),getReport:()=>function(e,t,n){const o=[],i=[];o.push("AnnotationType"),i.push("Cornerstone:Angle"),e.forEach((e=>{const{angle:t,unit:n}=e;o.push(`Angle (${n})`),i.push(t)})),n&&(o.push("FrameOfReferenceUID"),i.push(n));t&&(o.push("points"),i.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:i}}(f,S,u)}}};const L=x,G={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:i,viewportId:r}=e,{metadata:a,data:s,annotationUID:l}=i;if(!a||!s)return console.warn("PlanarFreehandROI tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:d,FrameOfReferenceUID:m}=a;if(!O.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:u,SeriesInstanceUID:p,StudyInstanceUID:g}=(0,N.Z)(d,n,r);let h;h=u?t.getDisplaySetForSOPInstanceUID(u,p):t.getDisplaySetsForSeries(p);const{points:I}=s.handles;!function(e,t){const{metadata:n,data:o}=e,{label:i}=o,{referencedImageId:r}=n,a=[],{SOPInstanceUID:s,SeriesInstanceUID:l}=(0,N.Z)(r)||{};if(!s||!l)return a;const c=t.getDisplaySetForSOPInstanceUID(s,l),{SeriesNumber:d,SeriesInstanceUID:m}=c;a.push({SeriesInstanceUID:m,SeriesNumber:d,label:i,data:o})}(i,t);return{uid:l,SOPInstanceUID:u,FrameOfReferenceUID:m,points:I,metadata:a,referenceSeriesUID:p,referenceStudyUID:g,toolName:a.toolName,displaySetInstanceUID:h.displaySetInstanceUID,label:s.label,displayText:"",data:{...s,...s.cachedStats},type:o(c),getReport:()=>({columns:[],values:[]})}}};const k=G,$={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:i,viewportId:r}=e,{metadata:a,data:s,annotationUID:c}=i;if(!a||!s)return console.warn("Rectangle ROI tool: Missing metadata or data"),null;const{toolName:d,referencedImageId:m,FrameOfReferenceUID:u}=a;if(!O.includes(d))throw new Error("Tool not supported");const{SOPInstanceUID:p,SeriesInstanceUID:g,StudyInstanceUID:h}=(0,N.Z)(m,n,r);let I;I=p?t.getDisplaySetForSOPInstanceUID(p,g):t.getDisplaySetsForSeries(g);const{points:S}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{cachedStats:i}=o,{referencedImageId:r}=n;if(!Object.keys(i).length)return[];const a=[];return Object.keys(i).forEach((e=>{const n=i[e];if(!r)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,N.Z)(r),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{mean:m,stdDev:u,max:p,area:g,Modality:h}=n,I=U(h);a.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,Modality:h,unit:I,mean:m,stdDev:u,max:p,area:g})})),a}(i,t),v=function(e,t){if(!e||!e.length)return"";const n=[],{area:o,SOPInstanceUID:i,frameNumber:r}=e[0],a=t.images.find((e=>e.SOPInstanceUID===i));let s;a&&(s=a.InstanceNumber);const c=s?` I: ${s}`:"",d=t.isMultiFrame?` F: ${r}`:"",m=l.utils.roundNumber(o||0,2);return n.push(`${m} mm<sup>2</sup>`),e.forEach((e=>{const{unit:t,max:o,SeriesNumber:i}=e;let r="";if(o){r=`Max: ${l.utils.roundNumber(o,2)} <small>${t}</small> `}const a=`${r}(S:${i}${c}${d})`;n.includes(a)||n.push(a)})),n}(f,I);return{uid:c,SOPInstanceUID:p,FrameOfReferenceUID:u,points:S,metadata:a,referenceSeriesUID:g,referenceStudyUID:h,frameNumber:f[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:I.displaySetInstanceUID,label:s.label,displayText:v,data:s.cachedStats,type:o(d),getReport:()=>function(e,t,n){const o=[],i=[];o.push("AnnotationType"),i.push("Cornerstone:RectangleROI"),e.forEach((e=>{const{mean:t,stdDev:n,max:r,area:a,unit:s}=e;t&&s&&r&&a&&(o.push(`max (${s})`,`mean (${s})`,`std (${s})`,"area (mm2)"),i.push(r,t,n,a))})),n&&(o.push("FrameOfReferenceUID"),i.push(n));t&&(o.push("points"),i.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:i}}(f,S,u)}}};const B=$,j=(e,t,n)=>{const o=e=>{const{POLYLINE:t,ELLIPSE:n,CIRCLE:o,RECTANGLE:i,BIDIRECTIONAL:r,POINT:a,ANGLE:s}=l.MeasurementService.VALUE_TYPES;return{Length:t,EllipticalROI:n,CircleROI:o,RectangleROI:i,PlanarFreehandROI:t,Bidirectional:r,ArrowAnnotate:a,CobbAngle:s,Angle:s}[e]};return{Length:{toAnnotation:M.toAnnotation,toMeasurement:e=>M.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.POLYLINE,points:2}]},Bidirectional:{toAnnotation:C.toAnnotation,toMeasurement:e=>C.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.POLYLINE,points:2},{valueType:l.MeasurementService.VALUE_TYPES.POLYLINE,points:2}]},EllipticalROI:{toAnnotation:A.toAnnotation,toMeasurement:e=>A.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.ELLIPSE}]},CircleROI:{toAnnotation:V.toAnnotation,toMeasurement:e=>V.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.CIRCLE}]},RectangleROI:{toAnnotation:B.toAnnotation,toMeasurement:e=>B.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.POLYLINE}]},PlanarFreehandROI:{toAnnotation:k.toAnnotation,toMeasurement:e=>k.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.POLYLINE}]},ArrowAnnotate:{toAnnotation:P.toAnnotation,toMeasurement:e=>P.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.POINT,points:1}]},CobbAngle:{toAnnotation:F.toAnnotation,toMeasurement:e=>F.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.ANGLE}]},Angle:{toAnnotation:L.toAnnotation,toMeasurement:e=>L.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.ANGLE}]}}},{removeAnnotation:z}=s.annotation.state,q=s.Enums.Events,W="Cornerstone3DTools",H=e=>{const{measurementService:t,displaySetService:n,cornerstoneViewportService:o}=e.services,i=((e,t,n)=>{const{Length:o,Bidirectional:i,EllipticalROI:r,CircleROI:a,ArrowAnnotate:s,Angle:l,CobbAngle:c,RectangleROI:d,PlanarFreehandROI:m}=j(e,t,n),u=e.createSource(W,"0.1");return e.addMapping(u,"Length",o.matchingCriteria,o.toAnnotation,o.toMeasurement),e.addMapping(u,"Bidirectional",i.matchingCriteria,i.toAnnotation,i.toMeasurement),e.addMapping(u,"EllipticalROI",r.matchingCriteria,r.toAnnotation,r.toMeasurement),e.addMapping(u,"CircleROI",a.matchingCriteria,a.toAnnotation,a.toMeasurement),e.addMapping(u,"ArrowAnnotate",s.matchingCriteria,s.toAnnotation,s.toMeasurement),e.addMapping(u,"CobbAngle",c.matchingCriteria,c.toAnnotation,c.toMeasurement),e.addMapping(u,"Angle",l.matchingCriteria,l.toAnnotation,l.toMeasurement),e.addMapping(u,"RectangleROI",d.matchingCriteria,d.toAnnotation,d.toMeasurement),e.addMapping(u,"PlanarFreehandROI",m.matchingCriteria,m.toAnnotation,m.toMeasurement),e.addMapping(u,"CalibrationLine",o.matchingCriteria,o.toAnnotation,o.toMeasurement),u})(t,n,o);Z(t,o,i);const{annotationToMeasurement:r,remove:s}=i;function l(t){try{const n=t.detail,{annotation:{metadata:i,annotationUID:a}}=n,{toolName:s}=i;t.type===m&&s===b.CalibrationLine?D(e,t).then((()=>{console.log("calibration applied")}),(()=>!0)).finally((()=>{z(a),c(t),o.resize()})):(n.uid=a,r(s,n))}catch(e){console.warn("Failed to update measurement:",e)}}function c(e){try{try{const n=e.detail,{annotation:{annotationUID:o}}=n;t.getMeasurement(o)&&(console.log("~~ removeEvt",e),s(o,n))}catch(e){console.warn("Failed to update measurement:",e)}}catch(e){console.warn("Failed to remove measurement:",e)}}const d=q.ANNOTATION_ADDED,m=q.ANNOTATION_COMPLETED,u=q.ANNOTATION_MODIFIED,p=q.ANNOTATION_REMOVED,g=q.ANNOTATION_SELECTION_CHANGE;return a.eventTarget.addEventListener(d,l),a.eventTarget.addEventListener(m,l),a.eventTarget.addEventListener(u,(function(e){try{const n=e.detail,{annotation:{metadata:o,annotationUID:i}}=n;if(!t.getMeasurement(i))return;const{toolName:a}=o;n.uid=i,r(a,n,!0)}catch(e){console.warn("Failed to update measurement:",e)}})),a.eventTarget.addEventListener(p,c),a.eventTarget.addEventListener(g,(function(e){try{const n=e.detail,{added:o,removed:i}=n;i&&i.forEach((e=>t.setMeasurementSelected(e,!1))),o&&o.forEach((e=>t.setMeasurementSelected(e,!0)))}catch(e){console.warn("Failed to select and unselect measurements:",e)}})),i},Z=(e,t,n)=>{const{MEASUREMENT_REMOVED:o,MEASUREMENTS_CLEARED:i,MEASUREMENT_UPDATED:r,RAW_MEASUREMENT_ADDED:a}=e.EVENTS;e.getSource(W,"0.1");e.subscribe(i,(({measurements:e})=>{if(Object.keys(e).length)for(const t of Object.values(e)){const{uid:e,source:n}=t;n.name===W&&z(e)}})),e.subscribe(r,(({source:e,measurement:t,notYetUpdatedAtSource:n})=>{if(e.name!==W)return;if(!1===n)return;const{uid:o,label:i}=t,r=s.annotation.state.getAnnotation(o),{data:a,metadata:l}=r;a&&(a.label!==i&&(a.label=i),"ArrowAnnotate"===l.toolName&&(a.text=i))})),e.subscribe(a,(({source:e,measurement:t,data:n,dataSource:o})=>{if(e.name!==W)return;const{referenceSeriesUID:i,referenceStudyUID:r,SOPInstanceUID:a}=t,c=l.DicomMetadataStore.getInstance(r,i,a);let d,m=1;t?.metadata?.referencedImageId?(d=t.metadata.referencedImageId,m=(0,N.Z)(t.metadata.referencedImageId).frameNumber):d=o.getImageIdsForInstance({instance:c});s.annotation.state.getAnnotationManager().addAnnotation({annotationUID:t.uid,highlighted:!1,isLocked:!1,invalidated:!1,metadata:{toolName:t.toolName,FrameOfReferenceUID:t.FrameOfReferenceUID,referencedImageId:d},data:{text:n.annotation.data.text,handles:{...n.annotation.data.handles},cachedStats:{...n.annotation.data.cachedStats},label:n.annotation.data.label,frameNumber:m}})})),e.subscribe(o,(({source:e,measurement:n})=>{if(e?.name&&e.name!==W)return;z(n);t.getRenderingEngine().render()}))};const Y=function(e){e.setServiceImplementation({playClip:(e,t)=>s.utilities.cine.playClip(e,t),stopClip:e=>s.utilities.cine.stopClip(e)})};var K=n(92891);const J=new Map,X=new Map;function Q({data:{viewportId:e,volumeInputArray:t},displaySetsMatchDetails:n,viewportMatchDetails:o}){X.set(e,t);for(const e of t){const{volumeId:t}=e,n=a.cache.getVolume(t);if(!n)return;if(!J.has(t)){const{metadata:e}=n;J.set(t,e.SeriesInstanceUID)}}if(o.size!==X.size)return;for(const[e,t]of n.entries()){const{SeriesInstanceUID:e}=t;if(!Array.from(J.values()).includes(e))return}const i=Array.from(J.keys()).slice().map((e=>a.cache.getVolume(e))),r=[];i.forEach((e=>{const t=e.getImageLoadRequests();if(!t.length||!t[0]||!t[0].imageId)return;const n=function(e){const t=e.length-1,n=Math.floor(e.length/2);let o=n,i=n;const r=[{imageId:e[n],imageIdIndex:n}],a={currentPositionDownToMinimum:!1,currentPositionUpToMaximum:!1};for(0===n?a.currentPositionDownToMinimum=!0:n===t&&(a.currentPositionUpToMaximum=!0);!a.currentPositionDownToMinimum||!a.currentPositionUpToMaximum;)a.currentPositionDownToMinimum||(o--,r.push({imageId:e[o],imageIdIndex:o}),0===o&&(a.currentPositionDownToMinimum=!0)),a.currentPositionUpToMaximum||(i++,r.push({imageId:e[i],imageIdIndex:i}),i===t&&(a.currentPositionUpToMaximum=!0));return r}(t.map((e=>e.imageId))).map((({imageId:e})=>t.find((t=>t.imageId===e))));r.push(n)}));const s=(0,K.compact)((0,K.flatten)((0,K.zip)(...r))),l=[];s.forEach((e=>{const{imageId:t}=e;r.forEach((e=>{const n=e.find((e=>e.imageId===t));n&&l.push(n)}))}));const c=a.Enums.RequestType.Prefetch;l.forEach((({callLoadImage:e,additionalDetails:t,imageId:n,imageIdIndex:o,options:i})=>{const r=e.bind(null,n,o,i);a.imageLoadPoolManager.addRequest(r,c,t,0)})),J.clear();const d=new Map(X);return X.clear(),d}const ee=new Map,te=new Map;function ne({data:{viewportId:e,volumeInputArray:t},displaySetsMatchDetails:n}){te.set(e,t);for(const e of t){const{volumeId:t}=e,n=a.cache.getVolume(t);if(!n)return void console.log("interleaveNthLoader::No volume, can't load it");if(!ee.has(t)){const{metadata:e}=n;ee.set(t,e.SeriesInstanceUID)}}const o=function(e){if(!e||!e.length)return[];if(1===e.length)return e[0];console.time("interleave");const t=[...e],n=[];for(let e=0;t.length>0;e++)for(const o of t)e>=o.length?t.splice(t.indexOf(o),1):n.push(o[e]);return console.timeEnd("interleave"),n}(Array.from(ee.keys()).slice().map((e=>a.cache.getVolume(e))).map((e=>e.getImageLoadRequests())).filter((e=>e?.[0]?.imageId)).map((e=>function(e){const t=[[],[],[],[],[]],n=e.length/2-3,o=n+6;for(let i=0;i<e.length;i++)i<2||i>e.length-4||i>n&&i<o?t[0].push(e[i]):i%7==2?t[1].push(e[i]):i%7==5?t[2].push(e[i]):t[i%2+3].push(e[i]);return[...t[0],...t[1],...t[2],...t[3],...t[4]]}(e)))),i=a.Enums.RequestType.Prefetch;o.forEach((({callLoadImage:e,additionalDetails:t,imageId:n,imageIdIndex:o,options:r})=>{const s=e.bind(null,n,o,r);a.imageLoadPoolManager.addRequest(s,i,t,0)})),ee.clear();const r=new Map(te);return te.clear(),r}const oe=new Map,ie=new Map;function re({data:{viewportId:e,volumeInputArray:t},displaySetsMatchDetails:n,viewportMatchDetails:o}){ie.set(e,t);for(const e of t){const{volumeId:t}=e,n=a.cache.getVolume(t);if(!n)return;if(!oe.has(t)){const{metadata:e}=n;oe.set(t,e.SeriesInstanceUID)}}if(o.size!==ie.size)return;for(const[e,t]of n.entries()){const{SeriesInstanceUID:e}=t;if(!Array.from(oe.values()).includes(e))return}const i=Array.from(oe.keys()).slice().map((e=>a.cache.getVolume(e))),r=[];i.forEach((e=>{const t=e.getImageLoadRequests();t.length&&t[0]&&t[0].imageId&&r.push(t.reverse())}));const s=(0,K.compact)((0,K.flatten)((0,K.zip)(...r))),l=[];s.forEach((e=>{const{imageId:t}=e;r.forEach((e=>{const n=e.find((e=>e.imageId===t));n&&l.push(n)}))}));const c=a.Enums.RequestType.Prefetch;l.forEach((({callLoadImage:e,additionalDetails:t,imageId:n,imageIdIndex:o,options:i})=>{const r=e.bind(null,n,o,i);a.imageLoadPoolManager.addRequest(r,c,t,0)})),oe.clear();const d=new Map(ie);return ie.clear(),d}const ae=(e,t)=>{if(!t?.detail)return;const{element:n,currentPoints:o}=t.detail;return e.runCommand("getNearbyAnnotation",{element:n,canvasCoordinates:o?.canvas},"CORNERSTONE")},se=s.Enums.Events,le={button1:{commands:[{commandName:"closeContextMenu"}]},button3:{commands:[{commandName:"showCornerstoneContextMenu",commandOptions:{menuId:"measurementsContextMenu"}}]}};const ce=function({cornerstoneViewportService:e,customizationService:t,commandsManager:n}){const o=e=>{const o=function(e){const t=e.detail.event.which,n=[];return e.detail.event.altKey&&n.push("alt"),e.detail.event.ctrlKey&&n.push("ctrl"),e.detail.event.shiftKey&&n.push("shift"),n.push("button"),n.push(t),n.join("")}(e);((e,o)=>{const i=(le||t.get("cornerstoneViewportClickCommands"))[e];console.log("initContextMenu::cornerstoneViewportHandleEvent",e,i);const r={nearbyToolData:ae(n,o),event:o};n.run(i,r)})(o,e)};a.eventTarget.addEventListener(a.EVENTS.ELEMENT_ENABLED,function(t){const{viewportId:n,element:i}=t.detail,r=e.getViewportInfo(n);if(!r)return;const a=r.getViewportIndex();(0,v.Yc)(a,i),i.addEventListener(se.MOUSE_CLICK,o)}.bind(null)),a.eventTarget.addEventListener(a.EVENTS.ELEMENT_DISABLED,function(e){const{element:t}=e.detail;t.removeEventListener(se.MOUSE_CLICK,o)}.bind(null))},de=s.Enums.Events,me={doubleClick:{commandName:"toggleOneUpCustom",commandOptions:{}}};const ue=function({customizationService:e,commandsManager:t}){const n=n=>{if(ae(t,n))return;const o=function(e){const t=[];return e.detail.event.altKey&&t.push("alt"),e.detail.event.ctrlKey&&t.push("ctrl"),e.detail.event.shiftKey&&t.push("shift"),t.push("doubleClick"),t.join("")}(n),i=e.get("cornerstoneViewportClickCommands")||me,r=i[o];console.log("toRun",r,i,o),r&&t.run(r)};a.eventTarget.addEventListener(a.EVENTS.ELEMENT_ENABLED,function(e){const{element:t}=e.detail;t.addEventListener(de.MOUSE_DOUBLE_CLICK,n)}.bind(null)),a.eventTarget.addEventListener(a.EVENTS.ELEMENT_DISABLED,function(e){const{element:t}=e.detail;t.removeEventListener(de.MOUSE_DOUBLE_CLICK,n)}.bind(null))};async function pe({servicesManager:e,commandsManager:t,extensionManager:n,configuration:o,appConfig:i}){await(0,a.init)(),a.setUseCPURendering(Boolean(i.useCPURendering)),a.setConfiguration({...a.getConfiguration(),rendering:{...a.getConfiguration().rendering,strictZSpacingForVolumeViewport:i.strictZSpacingForVolumeViewport}});const r=i.maxCacheSize;a.cache.setMaxCacheSize(r||1073741824),function(e={}){s.CrosshairsTool.isAnnotation=!1,s.ReferenceLinesTool.isAnnotation=!1,(0,s.init)(e),(0,s.addTool)(s.PanTool),(0,s.addTool)(s.WindowLevelTool),(0,s.addTool)(s.StackScrollMouseWheelTool),(0,s.addTool)(s.StackScrollTool),(0,s.addTool)(s.ZoomTool),(0,s.addTool)(s.ProbeTool),(0,s.addTool)(s.VolumeRotateMouseWheelTool),(0,s.addTool)(s.MIPJumpToClickTool),(0,s.addTool)(s.LengthTool),(0,s.addTool)(s.RectangleROITool),(0,s.addTool)(s.EllipticalROITool),(0,s.addTool)(s.CircleROITool),(0,s.addTool)(s.BidirectionalTool),(0,s.addTool)(s.ArrowAnnotateTool),(0,s.addTool)(s.DragProbeTool),(0,s.addTool)(s.AngleTool),(0,s.addTool)(s.CobbAngleTool),(0,s.addTool)(s.PlanarFreehandROITool),(0,s.addTool)(s.MagnifyTool),(0,s.addTool)(s.CrosshairsTool),(0,s.addTool)(s.SegmentationDisplayTool),(0,s.addTool)(s.ReferenceLinesTool),(0,s.addTool)(T),(0,s.addTool)(s.TrackballRotateTool),(0,s.addTool)(s.BrushTool),(0,s.addTool)(s.CircleScissorsTool),(0,s.addTool)(s.PaintFillTool),(0,s.addTool)(s.RectangleROIStartEndThresholdTool),(0,s.addTool)(s.RectangleROIThresholdTool),(0,s.addTool)(s.RectangleScissorsTool),(0,s.addTool)(s.SphereScissorsTool),(0,s.addTool)(s.UndoTool);const t=s.annotation.config.style.getDefaultToolStyles();s.annotation.config.style.setDefaultToolStyles({global:{...t.global,textBoxFontSize:"15px",lineWidth:"1.5"}})}(),a.Settings.getRuntimeSettings().set("useCursors",Boolean(i.useCursors));const{userAuthenticationService:d,measurementService:m,customizationService:u,displaySetService:p,uiDialogService:g,uiModalService:h,uiNotificationService:S,cineService:f,cornerstoneViewportService:v,hangingProtocolService:w,toolGroupService:E,viewportGridService:y,stateSyncService:D}=e.services;window.services=e.services,window.extensionManager=n,window.commandsManager=t,i.showWarningMessageForCrossOrigin&&!window.crossOriginIsolated&&S.show({title:"Cross Origin Isolation",message:"Cross Origin Isolation is not enabled, volume rendering will not work (e.g., MPR)",type:"warning"}),i.showCPUFallbackMessage&&a.getShouldUseCPURendering()&&function(e,t){const n=t=>{if(100===t)return e.show({content:ge,title:"OHIF Fell Back to CPU Rendering"}),!0},{unsubscribe:o}=t.subscribe(t.EVENTS.PROTOCOL_CHANGED,(()=>{n(100)&&o()}))}(h,w),D.register("lutPresentationStore",{clearOnModeExit:!0}),D.register("positionPresentationStore",{clearOnModeExit:!0}),D.register("toggleOneUpViewportGridStore",{clearOnModeExit:!0});const b=s.Enums.SegmentationRepresentations.Labelmap;s.segmentation.config.setGlobalRepresentationConfig(b,{fillAlpha:.3,fillAlphaInactive:.2,outlineOpacity:1,outlineOpacityInactive:.65});const O=l.default.classes.MetadataProvider;a.volumeLoader.registerVolumeLoader("cornerstoneStreamingImageVolume",c.IU),w.registerImageLoadStrategy("interleaveCenter",Q),w.registerImageLoadStrategy("interleaveTopToBottom",re),w.registerImageLoadStrategy("nth",ne),a.metaData.addProvider(a.utilities.calibratedPixelSpacingMetadataProvider.get.bind(a.utilities.calibratedPixelSpacingMetadataProvider)),a.metaData.addProvider(O.get.bind(O),9999),a.imageLoadPoolManager.maxNumRequests={interaction:i?.maxNumRequests?.interaction||100,thumbnail:i?.maxNumRequests?.thumbnail||75,prefetch:i?.maxNumRequests?.prefetch||10},I(d,i),this.measurementServiceSource=H(e),Y(f),w.subscribe(w.EVENTS.CUSTOM_IMAGE_LOAD_PERFORMED,(e=>{for(const t of e.entries()){const[e,n]=t,o=v.getCornerstoneViewport(e),i=v.getViewportInfo(e),{lutPresentationStore:r,positionPresentationStore:a}=D.getState(),{presentationIds:s}=i.getViewportOptions(),l={positionPresentation:a[s?.positionPresentationId],lutPresentation:r[s?.lutPresentationId]};v.setVolumesForViewport(o,n,l)}})),ce({cornerstoneViewportService:v,customizationService:u,commandsManager:t}),ue({customizationService:u,commandsManager:t});const N=e=>{const{element:t}=e.detail;s.utilities.stackPrefetch.enable(t)},M=e=>{const{element:t}=e.detail,{viewportId:n,renderingEngineId:o}=a.getEnabledElement(t),i=s.ToolGroupManager.getToolGroupForViewport(n,o);if(!i||!i._toolInstances?.Crosshairs)return;const r=i._toolInstances.Crosshairs.mode;r===s.Enums.ToolModes.Active?i.setToolActive("Crosshairs"):r===s.Enums.ToolModes.Passive?i.setToolPassive("Crosshairs"):r===s.Enums.ToolModes.Enabled&&i.setToolEnabled("Crosshairs")};a.eventTarget.addEventListener(a.EVENTS.ELEMENT_ENABLED,function(e){const{element:t}=e.detail;t.addEventListener(a.EVENTS.CAMERA_RESET,M),a.eventTarget.addEventListener(a.EVENTS.STACK_VIEWPORT_NEW_STACK,N)}.bind(null)),a.eventTarget.addEventListener(a.EVENTS.ELEMENT_DISABLED,function(e){const{element:t}=e.detail;t.removeEventListener(a.EVENTS.CAMERA_RESET,M)}.bind(null)),y.subscribe(y.EVENTS.ACTIVE_VIEWPORT_INDEX_CHANGED,(({viewportIndex:e,viewportId:t})=>{t=t||`viewport-${e}`;const n=E.getToolGroupForViewport(t);if(!n||!n._toolInstances?.ReferenceLines)return;n._toolInstances.ReferenceLines.mode===s.Enums.ToolModes.Enabled&&(n.setToolConfiguration(s.ReferenceLinesTool.toolName,{sourceViewportId:t},!0),n.setToolEnabled(s.ReferenceLinesTool.toolName))}))}function ge(){return r.createElement("div",null,r.createElement("p",null,"Your computer does not have enough GPU power to support the default GPU rendering mode. OHIF has switched to CPU rendering mode. Please note that CPU rendering does not support all features such as Volume Rendering, Multiplanar Reconstruction, and Segmentation Overlays."))}window.cornerstone=a,window.cornerstoneTools=s;var he=n(58591),Ie=n(60216),Se=n.n(Ie),fe=n(95685),ve=n.n(fe);const we={PROGRESS:"event:DicomFileUploader:progress"};let Ee=function(e){return e[e.NotStarted=0]="NotStarted",e[e.InProgress=1]="InProgress",e[e.Success=2]="Success",e[e.Failed=3]="Failed",e[e.Cancelled=4]="Cancelled",e}({});class ye{constructor(e,t){this.message=void 0,this.status=void 0,this.message=t,this.status=e}}class Te extends l.hC{constructor(e,t){super(we),this._file=void 0,this._fileId=void 0,this._dataSource=void 0,this._loadPromise=void 0,this._abortController=new AbortController,this._status=Ee.NotStarted,this._percentComplete=0,this._file=e,this._fileId=m().wadouri.fileManager.add(e),this._dataSource=t}getFileId(){return this._fileId}getFileName(){return this._file.name}getFileSize(){return this._file.size}cancel(){this._abortController.abort()}getStatus(){return this._status}getPercentComplete(){return this._percentComplete}async load(){return this._loadPromise||(this._loadPromise=new Promise(((e,t)=>{const n={progress:e=>{e.lengthComputable&&(this._status=Ee.InProgress,this._percentComplete=Math.round(100*e.loaded/e.total),this._broadcastEvent(we.PROGRESS,{fileId:this._fileId,percentComplete:this._percentComplete}))},timeout:()=>{this._reject(t,new ye(Ee.Failed,"The request timed out."))},abort:()=>{this._reject(t,new ye(Ee.Cancelled,"Cancelled"))},error:()=>{this._reject(t,new ye(Ee.Failed,"The request failed."))}};m().wadouri.loadFileRequest(this._fileId).then((o=>{if(this._abortController.signal.aborted)return void this._reject(t,new ye(Ee.Cancelled,"Cancelled"));if(!this._checkDicomFile(o))return void this._reject(t,new ye(Ee.Failed,"Not a valid DICOM file."));const i=new XMLHttpRequest;return this._addRequestCallbacks(i,n),this._dataSource.store.dicom(o,i).then((()=>{this._status=Ee.Success,e()})).catch((e=>{this._reject(t,e)}))})).catch((e=>{this._reject(t,e)}))}))),this._loadPromise}_isRejected(){return this._status===Ee.Failed||this._status===Ee.Cancelled}_reject(e,t){if(!this._isRejected()){if(t instanceof ye)return this._status=t.status,void e(t);this._status=Ee.Failed,t.message?e(new ye(Ee.Failed,t.message)):e(new ye(Ee.Failed,t))}}_addRequestCallbacks(e,t){const n=()=>e.abort();this._abortController.signal.addEventListener("abort",n);for(const[n,o]of Object.entries(t))e.upload.addEventListener(n,o);const o=()=>{this._abortController.signal.removeEventListener("abort",n);for(const[n,o]of Object.entries(t))e.upload.removeEventListener(n,o);e.removeEventListener("loadend",o)};e.addEventListener("loadend",o)}_checkDicomFile(e){if(e.length<=132)return!1;const t=new Uint8Array(e.slice(128,132));return Array.from("DICM").every(((e,n)=>e.charCodeAt(0)===t[n]))}}const De=(0,r.memo)((({dicomFileUploader:e})=>{const[t,n]=(0,r.useState)(e.getPercentComplete()),[o,i]=(0,r.useState)(""),[a,s]=(0,r.useState)(e.getStatus());console.info(`${e.getFileId()}`);const l=(0,r.useCallback)((()=>a===Ee.Failed||a===Ee.Cancelled||a===Ee.Success),[a]);(0,r.useEffect)((()=>{const t=e.subscribe(we.PROGRESS,(e=>{n(e.percentComplete)}));return e.load().catch((e=>{s(e.status),i(e.message??"")})).finally((()=>s(e.getStatus()))),()=>t.unsubscribe()}),[]);const c=(0,r.useCallback)((()=>{e.cancel()}),[]);return r.createElement("div",{className:"flex w-full p-2.5 text-lg min-h-14 items-center border-b border-secondary-light overflow-hidden"},r.createElement("div",{className:"flex flex-col gap-1 self-top w-0 grow shrink"},r.createElement("div",{className:"flex gap-4"},r.createElement("div",{className:"flex w-6 justify-center items-center shrink-0"},(()=>{switch(e.getStatus()){case Ee.Success:return r.createElement(S.JO,{name:"status-tracked",className:"text-primary-light"});case Ee.InProgress:return r.createElement(S.JO,{name:"icon-transferring"});case Ee.Failed:return r.createElement(S.JO,{name:"icon-alert-small"});case Ee.Cancelled:return r.createElement(S.JO,{name:"icon-alert-outline"});default:return r.createElement(r.Fragment,null)}})()),r.createElement("div",{className:"text-ellipsis whitespace-nowrap overflow-hidden"},e.getFileName())),o&&r.createElement("div",{className:"pl-10"},o)),r.createElement("div",{className:"w-24 flex items-center"},!l()&&r.createElement(r.Fragment,null,e.getStatus()===Ee.InProgress&&r.createElement("div",{className:"w-10 text-right"},t,"%"),r.createElement("div",{className:"flex cursor-pointer ml-auto"},r.createElement(S.JO,{className:"self-center text-primary-active",name:"close",onClick:c})))))}));De.propTypes={dicomFileUploader:Se().instanceOf(Te).isRequired};const be=De,Oe=1e3,Ne=6e4,Me=36e5,Ce=15e3,Ue="text-ellipsis whitespace-nowrap overflow-hidden";function Ae({dicomFileUploaderArr:e,onComplete:t}){const[n]=(0,r.useState)(e.reduce(((e,t)=>e+t.getFileSize()),0)),o=(0,r.useRef)(0),i=(0,r.useRef)(0),[a,s]=(0,r.useState)(null),[l,c]=(0,r.useState)(0),[d,m]=(0,r.useState)(0),[u,p]=(0,r.useState)(0),[g,h]=(0,r.useState)(!1),I=(0,r.useRef)();(0,r.useEffect)((()=>{let e,t=0,r=Date.now();const a=()=>{const s=o.current-t,l=Date.now(),c=l-r;i.current=s/c,t=o.current,r=l,n-o.current>0&&(e=i.current>=75?setTimeout(a,Ce):setTimeout(a,3e4))};return e=setTimeout(a,Ce),()=>{clearTimeout(e)}}),[]),(0,r.useEffect)((()=>{let t=null;const r=e.map((e=>{let r=0;const a=a=>{const l=r;if(r=Math.round(a/100*e.getFileSize()),o.current=Math.min(n,o.current-l+r),c(o.current/n*100),0!==i.current){const e=n-o.current,r=Math.round(e/i.current);if(null===t)return t=r,void s(t);if(r<Ne){const e=Math.ceil(t/Oe),n=Math.ceil(r/Oe)-e;return void((n<0||n>2)&&(t=r,s(t)))}if(r<Me){const e=Math.ceil(t/Ne),n=Math.ceil(r/Ne)-e;return void((n<0||n>2)&&(t=r,s(t)))}t=r,s(t)}};return e.load().catch((e=>{e.status===Ee.Failed&&p((e=>e+1))})).finally((()=>{a(100),m((e=>e+1))})),e.subscribe(we.PROGRESS,(e=>{a(e.percentComplete)}))}));return()=>{r.forEach((e=>e.unsubscribe()))}}),[]);const f=(0,r.useCallback)((async()=>{for(const t of e){new Promise(((e,n)=>{setTimeout((()=>{t.cancel(),e()}),0)}))}}),[]),v=(0,r.useCallback)((()=>{if(null==a)return"";if(a<Ne){const e=Math.ceil(a/Oe);return`${e} ${1===e?"second":"seconds"}`}if(a<Me){const e=Math.ceil(a/Ne);return`${e} ${1===e?"minute":"minutes"}`}const e=Math.ceil(a/Me);return`${e} ${1===e?"hour":"hours"}`}),[a]),w=(0,r.useCallback)((()=>Math.min(100,Math.round(l))),[l]),E=(0,r.useCallback)((()=>w()<1&&(I?.current?.offsetWidth??0)*(l/100)<1),[w,l]),y=(0,r.useCallback)((()=>({width:`${2*e.length.toString().length+4}ch`})),[]),T=()=>r.createElement("div",{className:"ml-auto flex justify-center w-6"},u>0&&r.createElement("div",{onClick:()=>h((e=>!e))},r.createElement(S.JO,{className:"cursor-pointer",name:"icon-status-alert"})));return r.createElement("div",{className:"flex flex-col grow"},r.createElement("div",{className:"text-lg px-1 pb-4 h-14 flex bg-primary-dark items-center"},d===e.length?r.createElement(r.Fragment,null,r.createElement("span",{className:Ue},`${e.length} ${e.length>1?"files":"file"} completed.`),r.createElement(S.zx,{variant:"contained",color:"primary",disabled:!1,className:"ml-auto",onClick:t},"Close")):r.createElement(r.Fragment,null,r.createElement("span",{style:y(),className:ve()(Ue,"text-end")},`${d} of ${e.length}`," "),r.createElement("span",{className:Ue}," files completed."," "),r.createElement("span",{className:Ue},a?`Less than ${v()} remaining. `:""),r.createElement("span",{className:ve()(Ue,"cursor-pointer text-primary-active hover:text-primary-light active:text-aqua-pale ml-auto"),onClick:f},"Cancel All Uploads"))),r.createElement("div",{className:"flex flex-col bg-black text-lg overflow-hidden grow"},r.createElement("div",{className:"overflow-y-scroll ohif-scrollbar px-2 border-b border-secondary-light"},r.createElement("div",{className:"flex w-full p-2.5 items-center min-h-14"},d===e.length?r.createElement(r.Fragment,null,r.createElement("div",{className:"text-xl text-primary-light"},u>0?`Completed with ${u} ${u>1?"errors":"error"}!`:"Completed!"),T()):r.createElement(r.Fragment,null,r.createElement("div",{ref:I,className:"flex-grow"},r.createElement(S.YE,{progress:E()?void 0:Math.min(100,l)})),r.createElement("div",{className:"w-24 ml-1 flex items-center"},r.createElement("div",{className:"w-10 text-right"},`${w()}%`),T())))),r.createElement("div",{className:"overflow-y-scroll ohif-scrollbar px-2 grow h-1"},e.filter((e=>!g||e.getStatus()===Ee.Failed)).map((e=>r.createElement(be,{key:e.getFileId(),dicomFileUploader:e}))))))}Ae.propTypes={dicomFileUploaderArr:Se().arrayOf(Se().instanceOf(Te)).isRequired,onComplete:Se().func.isRequired};const Re=Ae;function Ve(){return Ve=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},Ve.apply(this,arguments)}function Pe({dataSource:e,onComplete:t,onStarted:n}){const o="min-h-[480px] flex flex-col bg-black select-none",[i,a]=(0,r.useState)([]),s=(0,r.useCallback)((async t=>{n(),a(t.map((t=>new Te(t,e))))}),[]);return r.createElement(r.Fragment,null,i.length?r.createElement("div",{className:ve()("h-[calc(100vh-300px)]",o)},r.createElement(Re,{dicomFileUploaderArr:Array.from(i),onComplete:t})):r.createElement("div",{className:ve()("h-[480px]",o)},r.createElement(he.Z,{onDrop:e=>{s(e)},noClick:!0},(({getRootProps:e})=>r.createElement("div",Ve({},e(),{className:"m-5 dicom-upload-drop-area-border-dash flex flex-col items-center justify-center h-full"}),r.createElement("div",{className:"flex gap-3"},r.createElement(he.Z,{onDrop:s,noDrag:!0},(({getRootProps:e,getInputProps:t})=>r.createElement("div",e(),r.createElement(S.zx,{variant:"contained",color:"primary",disabled:!1,onClick:()=>{}},"Add files",r.createElement("input",t()))))),r.createElement(he.Z,{onDrop:s,noDrag:!0},(({getRootProps:e,getInputProps:t})=>r.createElement("div",e(),r.createElement(S.zx,{variant:"contained",color:"primaryDark",border:"primaryActive",disabled:!1,onClick:()=>{}},"Add folder",r.createElement("input",Ve({},t(),{webkitdirectory:"true",mozdirectory:"true"}))))))),r.createElement("div",{className:"pt-5"},"or drag images or folders here"),r.createElement("div",{className:"pt-3 text-aqua-pale text-lg"},"(DICOM files supported)"))))))}Pe.propTypes={dataSource:Se().object.isRequired,onComplete:Se().func.isRequired,onStarted:Se().func.isRequired};const _e=Pe,Fe={active:[{toolName:b.WindowLevel,bindings:[{mouseButton:s.Enums.MouseBindings.Primary}]},{toolName:b.Pan,bindings:[{mouseButton:s.Enums.MouseBindings.Auxiliary}]},{toolName:b.Zoom,bindings:[{mouseButton:s.Enums.MouseBindings.Secondary}]},{toolName:b.StackScrollMouseWheel,bindings:[]}],enabled:[{toolName:b.SegmentationDisplay}]};const xe=function(){return[{name:"cornerstoneDicomUploadComponent",value:{id:"dicomUploadComponent",component:_e}},{name:"default",value:[{id:"cornerstone.overlayViewportTools",tools:Fe}]}]};var Le=n(63691);const Ge=512,ke=1e4,$e="cornerstone-viewport-download-form",Be=({onClose:e,activeViewportIndex:t,cornerstoneViewportService:n})=>{const o=(0,v.K8)(t),i=o?.element,l=(0,a.getEnabledElement)(i),{viewportId:c,renderingEngineId:d}=l,m=s.ToolGroupManager.getToolGroupForViewport(c,d),u=Object.keys(m.toolOptions).reduce(((e,t)=>{const n=m.toolOptions[t],{mode:o,bindings:i}=n;return{...e,[t]:{mode:o,bindings:i}}}),{});(0,r.useEffect)((()=>()=>{Object.keys(u).forEach((e=>{const{mode:t,bindings:n}=u[e];m.setToolMode(e,t,{bindings:n})}))}),[]);return r.createElement(S.mQ,{onClose:e,minimumSize:100,maximumSize:ke,defaultSize:Ge,canvasClass:"cornerstone-canvas",activeViewportElement:i,enableViewport:e=>{if(e){const{renderingEngine:t,viewport:n}=(0,a.getEnabledElement)(i),o={viewportId:$e,element:e,type:n.type,defaultOptions:{background:n.defaultOptions.background,orientation:n.defaultOptions.orientation}};t.enableElement(o)}},disableViewport:e=>{if(e){const{renderingEngine:t}=(0,a.getEnabledElement)(e);return new Promise((e=>{t.disableElement($e)}))}},updateViewportPreview:(e,t,n)=>new Promise((t=>{const o=(0,a.getEnabledElement)(e),{viewport:i,renderingEngine:r}=o;r.resize(),i.render(),e.addEventListener(a.Enums.Events.IMAGE_RENDERED,(function o(i){const r=(0,a.getEnabledElement)(i.target),{viewport:s}=r,{element:l}=s,c=(0,a.getOrCreateCanvas)(l),d="image/"+n,m=c.toDataURL(d,1);let u=l.offsetHeight,p=l.offsetWidth;if(u>Ge||p>Ge){const e=Ge/Math.max(u,p);p*=e,u*=e}t({dataUrl:m,width:u,height:p}),e.removeEventListener(a.Enums.Events.IMAGE_RENDERED,o)}))})),loadImage:(e,t,o,i)=>new Promise((r=>{if(e&&t){const t=(0,a.getEnabledElement)(e);if(!t)return;const{viewport:s}=t,l=n.getRenderingEngine().getViewport($e);if(l instanceof a.StackViewport){const e=s.getCurrentImageId(),t=s.getProperties();l.setStack([e]).then((()=>{l.setProperties(t);const e=Math.min(o||image.width,ke),n=Math.min(i||image.height,ke);r({width:e,height:n})}))}else if(l instanceof a.VolumeViewport){s.getActors().forEach((e=>{l.addActor(e)})),l.setCamera(s.getCamera()),l.render();const e=Math.min(o||image.width,ke),t=Math.min(i||image.height,ke);r({width:e,height:t})}}})),toggleAnnotations:(e,t,n)=>{const o=(0,a.getEnabledElement)(n),i=(0,a.getEnabledElement)(t),{viewportId:r,renderingEngineId:l}=o,{viewportId:c}=i;if(!o||!i)return;const d=s.ToolGroupManager.getToolGroupForViewport(r,l);d.addViewport(c,l),Object.keys(d._toolInstances).forEach((t=>{if(e&&"Crosshairs"!==t)try{d.setToolEnabled(t)}catch(e){console.log(e)}else d.setToolDisabled(t)}))},downloadBlob:(e,t)=>{const n=`${e}.${t}`,o=document.querySelector(`div[data-viewport-uid="${$e}"]`);(0,Le.Z)(o).then((e=>{const o=document.createElement("a");o.download=n,o.href=e.toDataURL(t,1),o.click()}))}})};Be.propTypes={onClose:Se().func,activeViewportIndex:Se().number.isRequired};const je=Be;const ze=e=>{const t=[];for(let n=0;n<e.length;n++)for(let o=n+1;o<e.length;o++)t.push([e[n],e[o]]);return t};let qe=[];function We({toggledState:e,servicesManager:t,getEnabledElement:n}){const{syncGroupService:o,viewportGridService:i,displaySetService:r,cornerstoneViewportService:s}=t.services;if(!e)return void qe.forEach((e=>{const{viewports:t,synchronizerId:n}=e;t.forEach((({viewportId:e,renderingEngineId:t})=>{o.removeViewportFromSyncGroup(e,t,n)}))}));qe=[];let{viewports:l}=i.getState();l=l.filter((e=>e.displaySetInstanceUIDs&&e.displaySetInstanceUIDs.length)),l=l.filter((e=>{const{displaySetInstanceUIDs:t}=e;for(const e of t){const t=r.getDisplaySetByUID(e);return!(!t||!t.isReconstructable)}}));const c=l.reduce(((e,t)=>{const{viewportId:o,viewportType:i}=t.viewportOptions;if("stack"!==i)return console.warn("Viewport is not a stack, cannot sync images yet"),e;const{element:r}=s.getViewportInfo(o),{viewport:a,renderingEngineId:l}=n(r),{viewPlaneNormal:c}=a.getCamera(),d=c.map((e=>Math.round(e))).join(",");return e[d]||(e[d]=[]),e[d].push({viewportId:o,renderingEngineId:l}),e}),{});Object.values(c).map((e=>{let t=e.map((({viewportId:e})=>e)).join(",");t=`imageSync_${t}`,function(e){const t=ze(e);for(const[e,n]of t){const t=(0,a.getRenderingEngine)(e.renderingEngineId),o=(0,a.getRenderingEngine)(n.renderingEngineId),i=t.getViewport(e.viewportId),r=o.getViewport(n.viewportId);a.utilities.calculateViewportsSpatialRegistration(i,r)}}(e),e.forEach((({viewportId:e,renderingEngineId:n})=>{o.addViewportToSyncGroup(e,n,{type:"stackimage",id:t,source:!0,target:!0})})),qe.push({synchronizerId:t,viewports:e})}))}function He(e){return s.annotation.selection.isAnnotationSelected(e)}function Ze(e,t){He(e)!==t&&s.annotation.selection.setAnnotationSelected(e,t)}function Ye(e){const[t]=s.annotation.selection.getAnnotationsSelected()||[];if(t)return s.annotation.state.getAnnotation(t)}const Ke=function({servicesManager:e,commandsManager:t}){const{viewportGridService:n,toolGroupService:o,cineService:i,toolbarService:r,uiDialogService:l,cornerstoneViewportService:c,uiNotificationService:d,measurementService:m,displaySetService:u}=e.services,{measurementServiceSource:p}=this;function g(){return w(n)}const h={showCornerstoneContextMenu:e=>{const n=g()?.viewport?.element,o={...e,element:n},{useSelectedAnnotation:i,nearbyToolData:r,event:a}=o;if(i&&!r){const e=Ye();if(!(!o.allowedSelectedTools||o.allowedSelectedTools.includes(e?.metadata?.toolName)))return;o.nearbyToolData=e}o.defaultPointsPosition=[],o.selectorProps={toolName:o.nearbyToolData?.metadata?.toolName,value:o.nearbyToolData,uid:o.nearbyToolData?.annotationUID,nearbyToolData:o.nearbyToolData,event:a,...o.selectorProps},t.run(e,o)},getNearbyToolData:({nearbyToolData:e,element:t,canvasCoordinates:n})=>e??s.utilities.getAnnotationNearPoint(t,n),getNearbyAnnotation({element:e,canvasCoordinates:t}){const n=h.getNearbyToolData({nearbyToolData:null,element:e,canvasCoordinates:t});return n?.metadata?.toolName&&(t=>{const n=(0,a.getEnabledElement)(e);if(!n)return;const{renderingEngineId:o,viewportId:i}=n,r=s.ToolGroupManager.getToolGroupForViewport(i,o).getToolInstance(t);return r?.constructor?.isAnnotation??!0})(n.metadata.toolName)?n:null},deleteMeasurement:({uid:e})=>{e&&p.remove(e)},setMeasurementLabel:({uid:e})=>{const t=m.getMeasurement(e);f(l,t,((e,n)=>{if("cancel"===n)return;const o=Object.assign({},t,{label:e});m.update(o.uid,o,!0)}),!1)},updateMeasurement:e=>{const{code:t,uid:n,textLabel:o,label:i}=e,r={...m.getMeasurement(n)};if(void 0!==o&&(r.label=o),void 0!==t){const e=t.type||"finding";if(t.ref&&!t.CodeValue){const e=t.ref.indexOf(":");t.CodeValue=t.ref.substring(e+1),t.CodeMeaning=t.text||i,t.CodingSchemeDesignator=t.ref.substring(0,e)}r[e]=t,"finding"!==e&&(r.findingSites?(r.findingSites=r.findingSites.filter((t=>t.type!==e)),r.findingSites.push(t)):r.findingSites=[t])}m.update(r.uid,r,!0)},getActiveViewportEnabledElement:g,setViewportActive:({viewportId:e})=>{const t=c.getViewportInfo(e);if(!t)return void console.warn("No viewport found for viewportId:",e);const o=t.getViewportIndex();n.setActiveViewportIndex(o)},arrowTextCallback:({callback:e,data:t})=>{f(l,t,e)},toggleCine:()=>{const{viewports:e}=n.getState(),{isCineEnabled:t}=i.getState();i.setIsCineEnabled(!t),r.setButton("Cine",{props:{isActive:!t}}),e.forEach(((e,t)=>i.setCine({id:t,isPlaying:!1})))},setWindowLevel({window:e,level:t,toolGroupId:n}){const i=Number(e),r=Number(t),{viewportId:s}=g(),l=o.getToolGroupForViewport(s);if(n&&n!==l)return;const d=c.getRenderingEngine().getViewport(s),{lower:m,upper:u}=a.utilities.windowLevel.toLowHighRange(i,r);d.setProperties({voiRange:{upper:u,lower:m}}),d.render()},toolbarServiceRecordInteraction:e=>{r.recordInteraction(e)},setToolActive:({toolName:e,toolGroupId:t=null})=>{if("Crosshairs"===e){if(!o.getToolGroup(null)._toolInstances.Crosshairs)throw d.show({title:"Crosshairs",message:"You need to be in a MPR view to use Crosshairs. Click on MPR button in the toolbar to activate it.",type:"info",duration:3e3}),new Error("Crosshairs tool is not available in this viewport")}const{viewports:i}=n.getState()||{viewports:[]},r=o.getToolGroup(t),a=r?.getViewportIds?.();if(!a||!a.length)return;if(!i.filter((e=>!!e.viewportOptions&&a.includes(e.viewportOptions.viewportId))).length)return;if(!r.getToolInstance(e))throw d.show({title:`${e} tool`,message:`The ${e} tool is not available in this viewport.`,type:"info",duration:3e3}),new Error(`ToolGroup ${r.id} does not have this tool.`);const l=r.getActivePrimaryMouseButtonTool();l&&("Crosshairs"===l?r.setToolDisabled(l):r.setToolPassive(l)),r.setToolActive(e,{bindings:[{mouseButton:s.Enums.MouseBindings.Primary}]})},showDownloadViewportModal:()=>{const{activeViewportIndex:t}=n.getState();if(!c.getCornerstoneViewportByIndex(t))return void d.show({title:"Download Image",message:"Image cannot be downloaded",type:"error"});const{uiModalService:o}=e.services;o&&o.show({content:je,title:"Download High Quality Image",contentProps:{activeViewportIndex:t,onClose:o.hide,cornerstoneViewportService:c}})},rotateViewport:({rotation:e})=>{const t=g();if(!t)return;const{viewport:n}=t;if(n instanceof a.StackViewport){const{rotation:t}=n.getProperties(),o=(t+e)%360;n.setProperties({rotation:o}),n.render()}},flipViewportHorizontal:()=>{const e=g();if(!e)return;const{viewport:t}=e;if(t instanceof a.StackViewport){const{flipHorizontal:e}=t.getCamera();t.setCamera({flipHorizontal:!e}),t.render()}},flipViewportVertical:()=>{const e=g();if(!e)return;const{viewport:t}=e;if(t instanceof a.StackViewport){const{flipVertical:e}=t.getCamera();t.setCamera({flipVertical:!e}),t.render()}},invertViewport:({element:e})=>{let t;if(t=void 0===e?g():e,!t)return;const{viewport:n}=t;if(n instanceof a.StackViewport){const{invert:e}=n.getProperties();n.setProperties({invert:!e}),n.render()}},resetViewport:()=>{const e=g();if(!e)return;const{viewport:t}=e;t instanceof a.StackViewport?(t.resetProperties(),t.resetCamera()):t.resetCamera(),t.render()},scaleViewport:({direction:e})=>{const t=g(),n=e>0?.9:1.1;if(!t)return;const{viewport:o}=t;if(o instanceof a.StackViewport)if(e){const{parallelScale:e}=o.getCamera();o.setCamera({parallelScale:e*n}),o.render()}else o.resetCamera(),o.render()},jumpToImage:({imageIndex:e,viewport:t})=>{let n;if(t)n=c.getCornerstoneViewport(t.id);else{const e=g();if(!e)return;n=e.viewport}let o=0;if(n instanceof a.StackViewport)o=n.getImageIds().length;else{if(!(n instanceof a.VolumeViewport))throw new Error("Unsupported viewport type");o=a.utilities.getImageSliceDataForVolumeViewport(n).numberOfSlices}const i=e<0?o+e:e;if(i>=o||i<0)throw new Error(`Can't jump to ${e}`);const r={imageIndex:i};s.utilities.jumpToSlice(n.element,r)},scroll:({direction:e})=>{const t=g();if(!t)return;const{viewport:n}=t,o={delta:e};s.utilities.scroll(n,o)},setAllViewportsColorMap:({window:e,level:t,toolGroupId:n})=>{const{viewportId:i}=g(),r=o.getToolGroupForViewport(i);if(n&&n!==r)return;const a=c.getRenderingEngine().getViewport(i);a.setProperties({colormap:"hot_iron"}),a.render()},setViewportColormap:({viewportIndex:e,displaySetInstanceUID:t,colormap:n,immediate:o=!1})=>{const i=c.getCornerstoneViewportByIndex(e),r=i.getActors().find((e=>e.uid.includes(t))),{actor:a,uid:s}=r;i.setProperties({colormap:n,volumeActor:a},s),o&&i.render()},incrementActiveViewport:()=>{const{activeViewportIndex:e,viewports:t}=n.getState(),o=(e+1)%t.length;n.setActiveViewportIndex(o)},decrementActiveViewport:()=>{const{activeViewportIndex:e,viewports:t}=n.getState(),o=(e-1+t.length)%t.length;n.setActiveViewportIndex(o)},toggleStackImageSync:({toggledState:t})=>{We({getEnabledElement:a.getEnabledElement,servicesManager:e,toggledState:t})},toggleReferenceLines:({toggledState:e})=>{const{activeViewportIndex:t}=n.getState(),i=c.getViewportInfoByIndex(t).getViewportId(),r=o.getToolGroupForViewport(i);e||r.setToolDisabled(s.ReferenceLinesTool.toolName),r.setToolConfiguration(s.ReferenceLinesTool.toolName,{sourceViewportId:i},!0),r.setToolEnabled(s.ReferenceLinesTool.toolName)}},I={showCornerstoneContextMenu:{commandFn:h.showCornerstoneContextMenu,storeContexts:[],options:{menuCustomizationId:"measurementsContextMenu",useSelectedAnnotation:!0,commands:[{commandName:"showContextMenu"}]}},getNearbyToolData:{commandFn:h.getNearbyToolData},getNearbyAnnotation:{commandFn:h.getNearbyAnnotation,storeContexts:[],options:{}},deleteMeasurement:{commandFn:h.deleteMeasurement},setMeasurementLabel:{commandFn:h.setMeasurementLabel},updateMeasurement:{commandFn:h.updateMeasurement},setWindowLevel:{commandFn:h.setWindowLevel},toolbarServiceRecordInteraction:{commandFn:h.toolbarServiceRecordInteraction},setToolActive:{commandFn:h.setToolActive},rotateViewportCW:{commandFn:h.rotateViewport,options:{rotation:90}},rotateViewportCCW:{commandFn:h.rotateViewport,options:{rotation:-90}},incrementActiveViewport:{commandFn:h.incrementActiveViewport},decrementActiveViewport:{commandFn:h.decrementActiveViewport},flipViewportHorizontal:{commandFn:h.flipViewportHorizontal},flipViewportVertical:{commandFn:h.flipViewportVertical},invertViewport:{commandFn:h.invertViewport},resetViewport:{commandFn:h.resetViewport},scaleUpViewport:{commandFn:h.scaleViewport,options:{direction:1}},scaleDownViewport:{commandFn:h.scaleViewport,options:{direction:-1}},fitViewportToWindow:{commandFn:h.scaleViewport,options:{direction:0}},nextImage:{commandFn:h.scroll,options:{direction:1}},previousImage:{commandFn:h.scroll,options:{direction:-1}},firstImage:{commandFn:h.jumpToImage,options:{imageIndex:0}},lastImage:{commandFn:h.jumpToImage,options:{imageIndex:-1}},jumpToImage:{commandFn:h.jumpToImage},showDownloadViewportModal:{commandFn:h.showDownloadViewportModal},toggleCine:{commandFn:h.toggleCine},arrowTextCallback:{commandFn:h.arrowTextCallback},setViewportActive:{commandFn:h.setViewportActive},setAllViewportsColorMap:{commandFn:h.setAllViewportsColorMap},setViewportColormap:{commandFn:h.setViewportColormap},toggleStackImageSync:{commandFn:h.toggleStackImageSync},toggleReferenceLines:{commandFn:h.toggleReferenceLines}};return{actions:h,definitions:I,defaultContext:"CORNERSTONE"}},Je={id:"mpr",name:"Multi-Planar Reconstruction",locked:!0,hasUpdatedPriorsInformation:!1,createdDate:"2021-02-23",modifiedDate:"2023-04-03",availableTo:{},editableBy:{},numberOfPriorsReferenced:0,protocolMatchingRules:[],imageLoadStrategy:"nth",callbacks:{onLayoutChange:[{commandName:"toggleHangingProtocol",commandOptions:{protocolId:"mpr"},context:"DEFAULT"}],onProtocolExit:[{commandName:"toolbarServiceRecordInteraction",commandOptions:{interactionType:"tool",commands:[{commandOptions:{toolName:"WindowLevel"},context:"CORNERSTONE"}]}}]},displaySetSelectors:{activeDisplaySet:{seriesMatchingRules:[{weight:1,attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0}]}},stages:[{name:"MPR 1x3",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:3,layoutOptions:[{x:0,y:0,width:1/3,height:1},{x:1/3,y:0,width:1/3,height:1},{x:2/3,y:0,width:1/3,height:1}]}},viewports:[{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"axial",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"activeDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"sagittal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"activeDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"coronal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"activeDisplaySet"}]}]}]},Xe={id:"mprAnd3DVolumeViewport",locked:!0,hasUpdatedPriorsInformation:!1,name:"mpr",createdDate:"2023-03-15T10:29:44.894Z",modifiedDate:"2023-03-15T10:29:44.894Z",availableTo:{},editableBy:{},protocolMatchingRules:[],imageLoadStrategy:"interleaveCenter",displaySetSelectors:{mprDisplaySet:{seriesMatchingRules:[{weight:1,attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0},{attribute:"Modality",constraint:{equals:{value:"CT"}},required:!0},{attribute:"isSeriesUIDFromURL",constraint:{equals:{value:!0}}}]}},stages:[{id:"mpr3Stage",name:"mpr",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"axial",initialImageOptions:{preset:"middle"}},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"volume3d",viewportType:"volume3d",orientation:"coronal",customViewportProps:{hideOverlays:!0}},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"coronal",initialImageOptions:{preset:"middle"}},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"sagittal",initialImageOptions:{preset:"middle"}},displaySets:[{id:"mprDisplaySet"}]}]}]},Qe={id:"panoramicViewport",locked:!0,hasUpdatedPriorsInformation:!1,name:"Panoramic",createdDate:"2023-07-10T16:35:08.894Z",modifiedDate:"2023-07-10",availableTo:{},editableBy:{},protocolMatchingRules:[],displaySetSelectors:{mprAxesDisplaySet:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:{value:"CT"}},required:!0},{attribute:"isReconstructable",constraint:{equals:{value:!0}}},{attribute:"isSeriesUIDFromURL",constraint:{equals:{value:!0}},required:!0}]},contrastedMeanDisplaySet:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{equals:{value:1}},required:!0},{attribute:"Modality",constraint:{equals:{value:"OT"}}},{attribute:"isContrastedDerivedFromSeriesURL",constraint:{equals:{value:!0}},required:!0}]},panoramicDisplaySet:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{equals:{value:1}},required:!0},{attribute:"Modality",constraint:{equals:{value:"OT"}}},{attribute:"isPanoramicDerivedFromSeriesURL",constraint:{equals:{value:!0}},required:!0}]},dentascanDisplaySet:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:1}}},{attribute:"Modality",constraint:{equals:{value:"OT"}}},{attribute:"isDentascanDerivedFromSeriesURL",constraint:{equals:{value:!0}},required:!0}]}},stages:[{id:"panoramicStage",name:"mpr",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"axial",initialImageOptions:{preset:"middle"}},displaySets:[{id:"mprAxesDisplaySet"}]}]},{id:"panoramicStage2",name:"mpr",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{toolGroupId:"mpr",viewportType:"stack",initialImageOptions:{preset:"middle"}},displaySets:[{id:"contrastedMeanDisplaySet"}]}]},{id:"panoramicStage3",name:"mpr",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:5,layoutOptions:[{x:0,y:0,width:.3,height:.5},{x:.3,y:0,width:.7,height:.5},{x:0,y:.5,width:.2,height:.5},{x:.2,y:.5,width:.2,height:.5},{x:.4,y:.5,width:.2,height:.5},{x:.6,y:.5,width:.2,height:.5},{x:.8,y:.5,width:.2,height:.5}]}},viewports:[{viewportOptions:{toolGroupId:"mpr",viewportType:"stack",initialImageOptions:{preset:"middle"}},displaySets:[{id:"contrastedMeanDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"stack",initialImageOptions:{preset:"middle"}},displaySets:[{id:"panoramicDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"stack",initialImageOptions:{preset:"middle"}},displaySets:[{id:"dentascanDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"stack",initialImageOptions:{preset:"middle"}},displaySets:[{id:"dentascanDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"stack",initialImageOptions:{preset:"middle"}},displaySets:[{id:"dentascanDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"stack",initialImageOptions:{preset:"middle"}},displaySets:[{id:"dentascanDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"stack",initialImageOptions:{preset:"middle"}},displaySets:[{id:"dentascanDisplaySet"}]}]}]};const et=function(){return[{name:Je.id,protocol:Je},{name:Xe.id,protocol:Xe},{name:Qe.id,protocol:Qe}]};var tt;const nt={VIEWPORT_ADDED:"event::cornerstone::toolgroupservice:viewportadded",TOOLGROUP_CREATED:"event::cornerstone::toolgroupservice:toolgroupcreated"};class ot{constructor(e){this.serviceManager=void 0,this.toolGroupIds=new Set,this.listeners=void 0,this.EVENTS=void 0;const{cornerstoneViewportService:t,viewportGridService:n}=e.services;this.cornerstoneViewportService=t,this.viewportGridService=n,this.listeners={},this.EVENTS=nt,Object.assign(this,l.KZ)}onModeExit(){this.destroy()}getToolGroup(e){let t=e;if(!t){const e=w(this.viewportGridService);if(!e)return;const{renderingEngineId:n,viewportId:o}=e,i=s.ToolGroupManager.getToolGroupForViewport(o,n);if(!i)return void console.warn("No tool group found for viewportId:",o,"and renderingEngineId:",n);t=i.id}return s.ToolGroupManager.getToolGroup(t)}getToolGroupIds(){return Array.from(this.toolGroupIds)}getToolGroupForViewport(e){const t=this.cornerstoneViewportService.getRenderingEngine();return s.ToolGroupManager.getToolGroupForViewport(e,t.id)}getActiveToolForViewport(e){const t=s.ToolGroupManager.getToolGroupForViewport(e);return t?t.getActivePrimaryMouseButtonTool():null}destroy(){s.ToolGroupManager.destroy(),this.toolGroupIds=new Set}destroyToolGroup(e){s.ToolGroupManager.destroyToolGroup(e),this.toolGroupIds.delete(e)}removeViewportFromToolGroup(e,t,n){const o=s.ToolGroupManager.getToolGroupForViewport(e,t);if(!o)return;o.removeViewports(t,e);0===o.getViewportIds().length&&n&&s.ToolGroupManager.destroyToolGroup(o.id)}addViewportToToolGroup(e,t,n){if(n){let o=s.ToolGroupManager.getToolGroup(n);o||(o=this.createToolGroup(n)),o.addViewport(e,t)}else{s.ToolGroupManager.getAllToolGroups().forEach((n=>{n.addViewport(e,t)}))}this._broadcastEvent(nt.VIEWPORT_ADDED,{viewportId:e,toolGroupId:n})}createToolGroup(e){if(this.getToolGroup(e))throw new Error(`ToolGroup ${e} already exists`);const t=s.ToolGroupManager.createToolGroup(e);return this.toolGroupIds.add(e),this._broadcastEvent(nt.TOOLGROUP_CREATED,{toolGroupId:e}),t}addToolsToToolGroup(e,t,n={}){const o=s.ToolGroupManager.getToolGroup(e);this._addTools(o,t,n),this._setToolsMode(o,t)}createToolGroupAndAddTools(e,t,n={}){const o=this.createToolGroup(e);return this.addToolsToToolGroup(e,t,n),o}getToolConfiguration(e,t){const n=s.ToolGroupManager.getToolGroup(e);if(!n)return null;const o=n.getToolInstance(t);return o?o.configuration:null}setToolConfiguration(e,t,n){s.ToolGroupManager.getToolGroup(e).getToolInstance(t).configuration=n}_getToolNames(e){const t=[];return e.active&&e.active.forEach((e=>{t.push(e.toolName)})),e.passive&&e.passive.forEach((e=>{t.push(e.toolName)})),e.enabled&&e.enabled.forEach((e=>{t.push(e.toolName)})),e.disabled&&e.disabled.forEach((e=>{t.push(e.toolName)})),t}_setToolsMode(e,t){const{active:n,passive:o,enabled:i,disabled:r}=t;n&&n.forEach((({toolName:t,bindings:n})=>{e.setToolActive(t,{bindings:n})})),o&&o.forEach((({toolName:t})=>{e.setToolPassive(t)})),i&&i.forEach((({toolName:t})=>{e.setToolEnabled(t)})),r&&r.forEach((({toolName:t})=>{e.setToolDisabled(t)}))}_addTools(e,t,n){this._getToolNames(t).forEach((t=>{const o=n[t]??{};e.addTool(t,{...o})}))}}tt=ot,ot.REGISTRATION={name:"toolGroupService",altName:"ToolGroupService",create:({servicesManager:e})=>new tt(e)};const it=ot;var rt;const at={TOOL_GROUP_CREATED:"event::cornerstone::syncgroupservice:toolgroupcreated"};class st{constructor(e){this.servicesManager=void 0,this.listeners={},this.EVENTS=void 0,this.synchronizerCreators={cameraposition:s.synchronizers.createCameraPositionSynchronizer,voi:s.synchronizers.createVOISynchronizer,zoompan:s.synchronizers.createZoomPanSynchronizer,stackimage:s.synchronizers.createStackImageSynchronizer},this.servicesManager=e,this.listeners={},this.EVENTS=at,Object.assign(this,l.KZ)}_createSynchronizer(e,t,n){const o=this.synchronizerCreators[e.toLowerCase()];if(o)return o(t,n);console.warn("Unknown synchronizer type",e,t)}setSynchronizer(e,t){this.synchronizerCreators[e.toLowerCase()]=t}_getOrCreateSynchronizer(e,t,n){let o=s.SynchronizerManager.getSynchronizer(t);return o||(o=this._createSynchronizer(e,t,n)),o}addViewportToSyncGroup(e,t,n){if(!n)return;(Array.isArray(n)?n:[n]).forEach((n=>{const o=(e=>"string"==typeof e?{type:e}:e)(n),{type:i,target:r=!0,source:a=!0,options:s={},id:l=i}=o,c=this._getOrCreateSynchronizer(i,l,s);c.setOptions(e,s);const d={viewportId:e,renderingEngineId:t};r&&a?c.add(d):a?c.addSource(d):r&&c.addTarget(d)}))}destroy(){s.SynchronizerManager.destroy()}removeViewportFromSyncGroup(e,t,n){const o=s.SynchronizerManager.getAllSynchronizers();(n?o.filter((e=>e.id===n)):o).forEach((n=>{if(!n)return;n.remove({viewportId:e,renderingEngineId:t});const o=n.getSourceViewports(),i=n.getTargetViewports();o.length||i.length||s.SynchronizerManager.destroySynchronizer(n.id)}))}}rt=st,st.REGISTRATION={name:"syncGroupService",altName:"SyncGroupService",create:({servicesManager:e})=>new rt(e)};const lt=st;var ct,dt=n(71975),mt=n.n(dt),ut=n(68652),pt=n.n(ut);function gt(e,t){const n=1-t;return e<1/4?4*Math.pow(2*e,3)*n+t:e<.5?(1-Math.pow(-4*e+2,3)/2)*n+t:e<3/4?(1-Math.pow(4*e-2,3)/2)*n+t:-4*Math.pow(2*e-2,3)*n+t}const{COLOR_LUT:ht}=s.CONSTANTS,It=s.Enums.SegmentationRepresentations.Labelmap,St=s.Enums.SegmentationRepresentations.Contour,ft={SEGMENTATION_UPDATED:"event::segmentation_updated",SEGMENTATION_DATA_MODIFIED:"event::segmentation_data_modified",SEGMENTATION_ADDED:"event::segmentation_added",SEGMENTATION_REMOVED:"event::segmentation_removed",SEGMENTATION_CONFIGURATION_CHANGED:"event::segmentation_configuration_changed",SEGMENT_LOADING_COMPLETE:"event::segment_loading_complete",SEGMENTATION_LOADING_COMPLETE:"event::segmentation_loading_complete"},vt={opacity:255,isVisible:!0,isLocked:!1};class wt extends l.hC{constructor({servicesManager:e}){super(ft),this.segmentations=void 0,this.servicesManager=void 0,this.highlightIntervalId=null,this.EVENTS=ft,this.destroy=()=>{a.eventTarget.removeEventListener(s.Enums.Events.SEGMENTATION_MODIFIED,this._onSegmentationModifiedFromSource),a.eventTarget.removeEventListener(s.Enums.Events.SEGMENTATION_DATA_MODIFIED,this._onSegmentationDataModified),Object.keys(this.segmentations).forEach((e=>{this._removeSegmentationFromCornerstone(e)})),this.segmentations={},this.listeners={}},this.setSegmentRGBA=(e,t,n,o)=>{const i=this.getSegmentation(e);if(void 0===i)throw new Error(`no segmentation for segmentationId: ${e}`);this._setSegmentOpacity(e,t,n[3],o,true),this._setSegmentColor(e,t,[n[0],n[1],n[2]],o,true),this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:i})},this.createSegmentationForDisplaySet=async(e,t)=>{const{displaySetService:n}=this.servicesManager.services,o=n.getDisplaySetByUID(e),i=It,r=this._getVolumeIdForDisplaySet(o),s=t?.segmentationId??`${a.utilities.uuidv4()}`;await a.volumeLoader.createAndCacheDerivedVolume(r,{volumeId:s,targetBuffer:{type:"Uint8Array",sharedArrayBuffer:!0}});const l={...this._getDefaultSegmentationScheme(),id:s,displaySetInstanceUID:e,label:t?.label,isActive:!0,type:i,representationData:{LABELMAP:{volumeId:s,referencedVolumeId:r}}};return this.addOrUpdateSegmentation(l),s},this.toggleSegmentationVisibility=e=>{this._toggleSegmentationVisibility(e,!1)},this.addSegmentationRepresentationToToolGroup=async(e,t,n=!1,o=s.Enums.SegmentationRepresentations.Labelmap)=>{const i=this.getSegmentation(t);if(!i)throw new Error(`Segmentation with segmentationId ${t} not found.`);n&&(i.hydrated=!0);const{colorLUTIndex:r}=i,a=await s.segmentation.addSegmentationRepresentations(e,[{segmentationId:t,type:o}]);this._setActiveSegmentationForToolGroup(t,e,a[0]),s.segmentation.config.color.setColorLUT(e,a[0],r);for(const n of i.segments){if(null==n)continue;const{segmentIndex:o,color:i,isLocked:r,isVisible:a,opacity:s}=n,l=!0;void 0!==i&&this._setSegmentColor(t,o,i,e,l),void 0!==s&&this._setSegmentOpacity(t,o,s,e,l),void 0!==a&&this._setSegmentVisibility(t,o,a,e,l),void 0!==r&&this._setSegmentLocked(t,o,r,l)}},this.setSegmentRGBAColorForSegmentation=(e,t,n,o)=>{const i=this.getSegmentation(e);if(void 0===i)throw new Error(`no segmentation for segmentationId: ${e}`);this._setSegmentOpacity(e,t,n[3],o,!0),this._setSegmentColor(e,t,[n[0],n[1],n[2]],o,!0),this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:i})},this.getToolGroupIdsWithSegmentation=e=>s.segmentation.state.getToolGroupIdsWithSegmentation(e),this.hydrateSegmentation=(e,t=!1)=>{const n=this.getSegmentation(e);if(!n)throw new Error(`Segmentation with segmentationId ${e} not found.`);n.hydrated=!0,t||this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:n})},this.getConfiguration=e=>{e=e??this._getFirstToolGroupId();const t=this.getSegmentationRepresentationsForToolGroup(e),n=t?.[0]?.type||It,o=s.segmentation.config.getGlobalConfig(),{renderInactiveSegmentations:i}=o,r=o.representations[n],{renderOutline:a,outlineWidthActive:l,renderFill:c,fillAlpha:d,fillAlphaInactive:m,outlineOpacity:u,outlineOpacityInactive:p}=r;return{brushSize:1,brushThresholdGate:1,fillAlpha:d,fillAlphaInactive:m,outlineWidthActive:l,renderFill:c,renderInactiveSegmentations:i,renderOutline:a,outlineOpacity:u,outlineOpacityInactive:p}},this.setConfiguration=e=>{const{brushSize:t,brushThresholdGate:n,fillAlpha:o,fillAlphaInactive:i,outlineWidthActive:r,outlineOpacity:a,renderFill:l,renderInactiveSegmentations:c,renderOutline:d}=e,m=(e,t,n=null)=>{if(void 0!==t){const o=n?n(t):t;this._setSegmentationConfig(e,o)}};if(m("renderOutline",d),m("outlineWidthActive",r),m("outlineOpacity",a,(e=>e/100)),m("fillAlpha",o,(e=>e/100)),m("renderFill",l),m("fillAlphaInactive",i,(e=>e/100)),m("outlineOpacityInactive",i,(e=>Math.max(.75,e/100))),void 0!==c){const e=s.segmentation.config.getGlobalConfig();e.renderInactiveSegmentations=c,s.segmentation.config.setGlobalConfig(e)}this._broadcastEvent(this.EVENTS.SEGMENTATION_CONFIGURATION_CHANGED,this.getConfiguration())},this.getLabelmapVolume=e=>a.cache.getVolume(e),this.getSegmentationRepresentationsForToolGroup=e=>s.segmentation.state.getSegmentationRepresentations(e),this._toggleSegmentationVisibility=(e,t=!1)=>{const n=this.segmentations[e];if(!n)throw new Error(`Segmentation with segmentationId ${e} not found.`);n.isVisible=!n.isVisible,this._updateCornerstoneSegmentationVisibility(e),!1===t&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:n})},this._setSegmentColor=(e,t,n,o,i=!1)=>{const r=this.getSegmentation(e);if(void 0===r)throw new Error(`no segmentation for segmentationId: ${e}`);const a=this._getSegmentInfo(r,t);if(void 0===a)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);o=o??this._getFirstToolGroupId();const l=this._getSegmentationRepresentation(e,o);if(!l)throw new Error("Must add representation to toolgroup before setting segments");const{segmentationRepresentationUID:c}=l,d=s.segmentation.config.color.getColorForSegmentIndex(o,c,t);s.segmentation.config.color.setColorForSegmentIndex(o,c,t,[...n,d[3]]),a.color=n,!1===i&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:r})},this._setSegmentOpacity=(e,t,n,o,i=!1)=>{const r=this.getSegmentation(e);if(void 0===r)throw new Error(`no segmentation for segmentationId: ${e}`);const a=this._getSegmentInfo(r,t);if(void 0===a)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);o=o??this._getFirstToolGroupId();const l=this._getSegmentationRepresentation(e,o);if(!l)throw new Error("Must add representation to toolgroup before setting segments");const{segmentationRepresentationUID:c}=l,d=s.segmentation.config.color.getColorForSegmentIndex(o,c,t);s.segmentation.config.color.setColorForSegmentIndex(o,c,t,[d[0],d[1],d[2],n]),a.opacity=n,!1===i&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:r})},this._setSegmentationConfig=(e,t)=>{const n=this.getSegmentations()[0].type,{cornerstoneViewportService:o}=this.servicesManager.services,i=s.segmentation.config.getGlobalConfig();i.representations[n][e]=t,s.segmentation.config.setGlobalConfig(i);const r=o.getRenderingEngine(),a=o.getViewportIds();r.renderViewports(a)},this._onSegmentationDataModified=e=>{const{segmentationId:t}=e.detail,n=this.getSegmentation(t);void 0!==n&&this._broadcastEvent(this.EVENTS.SEGMENTATION_DATA_MODIFIED,{segmentation:n})},this._onSegmentationModifiedFromSource=e=>{const{segmentationId:t}=e.detail,n=this.segmentations[t];if(void 0===n)return;const o=s.segmentation.state.getSegmentation(t);if(!o)return;const{activeSegmentIndex:i,cachedStats:r,segmentsLocked:a,label:l,type:c}=o;if(![It,St].includes(c))throw new Error(`Unsupported segmentation type: ${c}. Only ${It} and ${St} are supported.`);const d=o.representationData[c],m={...n,activeSegmentIndex:i,cachedStats:r,displayText:[],id:t,label:l,segmentsLocked:a,type:c,representationData:{[c]:{...d}}};try{this.addOrUpdateSegmentation(m)}catch(e){console.warn(`Failed to add/update segmentation ${t}`,e)}},this._updateCornerstoneSegmentationVisibility=e=>{s.segmentation.state.getToolGroupIdsWithSegmentation(e).forEach((t=>{const n=s.segmentation.state.getSegmentationRepresentations(t);if(0===n.length)return;const o=n.find((t=>t.segmentationId===e)),{segmentsHidden:i}=o,r=!(0===i.size);s.segmentation.config.visibility.setSegmentationVisibility(t,o.segmentationRepresentationUID,r);const{segmentation:a}=this._getSegmentationInfo(e,t);a.segments.filter(Boolean).forEach((e=>{e.isVisible=r}))}))},this._getFirstToolGroupId=()=>{const{toolGroupService:e}=this.servicesManager.services;return e.getToolGroupIds()[0]},this.getNextColorLUTIndex=()=>{let e=0;for(;;){if(void 0===s.segmentation.state.getColorLUT(e))return e;e++}},this.arrayOfObjects=e=>Object.entries(e).map((e=>({[e[0]]:e[1]}))),this.segmentations={},this.servicesManager=e,this._initSegmentationService()}addSegment(e,t,n,o,i=!1){if(0===t)throw new Error('Segment index 0 is reserved for "no label"');n=n??this._getFirstToolGroupId();const{segmentationRepresentationUID:r,segmentation:a}=this._getSegmentationInfo(e,n);for(;i&&this._getSegmentInfo(a,t);)console.warn(`Segment ${t} already exists`),t++;const l=s.segmentation.config.color.getColorForSegmentIndex(n,r,t);a.segments[t]={label:o.label,segmentIndex:t,color:[l[0],l[1],l[2]],opacity:l[3],isVisible:!0,isLocked:!1},a.segmentCount=a.segments.length-1;const c=!0;if(void 0!==o){const{color:i,opacity:r,isLocked:a,visibility:s,active:l}=o;void 0!==i&&this._setSegmentColor(e,t,i,n,c),void 0!==r&&this._setSegmentOpacity(e,t,r,n,c),void 0!==s&&this._setSegmentVisibility(e,t,s,n,c),void 0!==l&&this._setActiveSegment(e,t,c),void 0!==a&&this._setSegmentLocked(e,t,a,c)}null===a.activeSegmentIndex&&this._setActiveSegment(e,t,c),this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:a})}removeSegment(e,t){const n=this.getSegmentation(e);if(void 0===n&&console.warn(`no segmentation for segmentationId: ${e}`),0===t)throw new Error('Segment index 0 is reserved for "no label"');if(!this._getSegmentInfo(n,t))return;n.segmentCount--,n.segments[t]=null;const o=this.getLabelmapVolume(e),{dimensions:i}=o,r=o.getScalarData(),a=i[0]*i[1],l=i[2];let c=0;const d=new Set;for(let e=0;e<l;e++)for(let n=0;n<a;n++)r[c]===t&&(r[c]=0,d.add(e)),c++;const m=Array.from(d);if(s.segmentation.triggerSegmentationEvents.triggerSegmentationDataModified(e,m),n.activeSegmentIndex===t){const t=Object.keys(n.segments),o=t.length?Number(t[0]):1;this._setActiveSegment(e,o,!0)}this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:n})}setSegmentVisibility(e,t,n,o,i=!1){this._setSegmentVisibility(e,t,n,o,i)}setSegmentLockedForSegmentation(e,t,n){this._setSegmentLocked(e,t,n,!1)}setSegmentLabel(e,t,n){this._setSegmentLabel(e,t,n)}setSegmentColor(e,t,n,o){this._setSegmentColor(e,t,n,o)}setSegmentOpacity(e,t,n,o){this._setSegmentOpacity(e,t,n,o)}setActiveSegmentationForToolGroup(e,t){t=t??this._getFirstToolGroupId();this._setActiveSegmentationForToolGroup(e,t,!1)}setActiveSegmentForSegmentation(e,t){this._setActiveSegment(e,t,!1)}getSegmentations(e=!0){const t=this._getSegmentations();return t&&t.filter((t=>!e||t.hydrated))}_getSegmentations(){const e=this.arrayOfObjects(this.segmentations);return e&&e.map((e=>this.segmentations[Object.keys(e)[0]]))}getSegmentation(e){return this.segmentations[e]}addOrUpdateSegmentation(e,t=!1,n=!1){const{id:o}=e;let i=this.segmentations[o];if(i)return Object.assign(i,e),this._updateCornerstoneSegmentations({segmentationId:o,notYetUpdatedAtSource:n}),t||this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:i}),o;const r=e.type,a=e.representationData[r];s.segmentation.addSegmentations([{segmentationId:o,representation:{type:r,data:{...a}}}]);const l=this.generateNewColorLUT(),c=this.getNextColorLUTIndex();return s.segmentation.config.color.addColorLUT(l,c),this.segmentations[o]={...e,label:e.label||"",segments:e.segments||[null],activeSegmentIndex:e.activeSegmentIndex??null,segmentCount:e.segmentCount??0,isActive:!1,colorLUTIndex:c,isVisible:!0},i=this.segmentations[o],this._updateCornerstoneSegmentations({segmentationId:o,notYetUpdatedAtSource:!0}),t||this._broadcastEvent(this.EVENTS.SEGMENTATION_ADDED,{segmentation:i}),i.id}async createSegmentationForSEGDisplaySet(e,t,n=!1){const o=It;t=t??e.displaySetInstanceUID;const i={...this._getDefaultSegmentationScheme(),id:t,displaySetInstanceUID:e.displaySetInstanceUID,type:o,representationData:{[It]:{volumeId:t,referencedVolumeId:e.referencedVolumeId}}},r=this.getLabelmapVolume(t),s=this.getSegmentation(t);if(r&&s)return this.addOrUpdateSegmentation(Object.assign(i,s),n);const{segments:l,referencedVolumeId:c}=e;if(!l||!c)throw new Error("To create the segmentation from SEG displaySet, the displaySet should be loaded first, you can perform segDisplaySet.load() before calling this method.");const d=a.cache.getVolume(c);if(!d)throw new Error(`No volume found for referencedVolumeId: ${c}`);const m=await a.volumeLoader.createAndCacheDerivedVolume(c,{volumeId:t,targetBuffer:{type:"Uint8Array",sharedArrayBuffer:!0}}),[u,p]=m.dimensions,g=m.getScalarData(),{imageIds:h}=d,I=h.reduce(((e,t,n)=>{const{sopInstanceUid:o}=a.metaData.get("generalImageModule",t);return e[o]=n,e}),{}),S=Object.keys(l).length;let f=!1;const v=(t,n)=>{const{pixelData:o}=t;let r=0,a=0,s=0,l=0;for(const[e,i]of t.functionalGroups.entries()){const{ReferencedSOPInstanceUID:t}=i.DerivationImageSequence.SourceImageSequence,c=I[t];if(-1===c)return;const d=u*p,m=new Uint8Array(o.buffer,e*d,d),h=(c+1)*d;for(let e=c*d,t=0;e<h;e++,t++)0!==m[t]&&(0!==g[e]&&(f=!0),g[e]=n,r+=e%p,a+=Math.floor(e/p)%u,s+=Math.floor(e/(p*u)),l++)}const c=Math.floor(r/l),d=Math.floor(a/l),h=Math.floor(s/l),v=m.imageData.indexToWorld([c,d,h]);i.cachedStats={...i.cachedStats,segmentCenter:{...i.cachedStats.segmentCenter,[n]:{center:{image:[c,d,h],world:v},modifiedTime:e.SeriesDate}}};const w=Object.keys(i.cachedStats.segmentCenter).length,E=Math.round(w/S*100);this._broadcastEvent(ft.SEGMENT_LOADING_COMPLETE,{percentComplete:E,numSegments:S})},w=[];for(const e in l){const t=l[e],n=new Promise(((n,o)=>{setTimeout((()=>{v(t,e),n()}),0)}));w.push(n)}return await Promise.all(w),i.segmentCount=Object.keys(l).length,i.segments=[null],Object.keys(l).forEach((e=>{const t=l[e],n=Number(e);i.segments[n]={label:t.label||`Segment ${n}`,segmentIndex:Number(e),color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],isVisible:!0,isLocked:!1}})),e.isLoaded=!0,this._broadcastEvent(ft.SEGMENTATION_LOADING_COMPLETE,{segmentationId:t,segDisplaySet:e,overlappingSegments:f}),this.addOrUpdateSegmentation(i,n)}async createSegmentationForRTDisplaySet(e,t,n=!1){const o=St;t=t??e.displaySetInstanceUID;const{structureSet:i}=e;if(!i)throw new Error("To create the contours from RT displaySet, the displaySet should be loaded first, you can perform rtDisplaySet.load() before calling this method.");const r=this._getDefaultSegmentationScheme(),s=e.displaySetInstanceUID,l=function(e,t){return e.ROIContours.map((({contourPoints:e,ROINumber:n,ROIName:o,colorArray:i})=>{const r=o||n;return{data:e.map((({points:e,...t})=>({...t,points:e.map((({x:e,y:t,z:n})=>[e,t,n]))}))),id:r,segmentIndex:n,color:i,geometryId:`${t}:${r}:segmentIndex-${n}`}}))}(i,s);l.sort(((e,t)=>e.segmentIndex-t.segmentIndex));const c=l.map((({geometryId:e})=>e)),d={...r,id:t,displaySetInstanceUID:s,type:o,representationData:{[St]:{geometryIds:c}}},m=this.getSegmentation(t);if(m)return this.addOrUpdateSegmentation(Object.assign(d,m),n);if(!i.ROIContours?.length)throw new Error("The structureSet does not contain any ROIContours. Please ensure the structureSet is loaded first.");const u={},p=async t=>{const{data:n,id:o,color:r,segmentIndex:s,geometryId:c}=t,m=(await a.geometryLoader.createAndCacheGeometry(c,{geometryData:{data:n,id:o,color:r,frameOfReferenceUID:i.frameOfReferenceUID,segmentIndex:s},type:a.Enums.GeometryType.CONTOUR})).data.getCentroid();u[s]={center:{world:m},modifiedTime:e.SeriesDate},d.segments[s]={label:o,segmentIndex:s,color:r,...vt};const p=Object.keys(u).length,g=Math.round(p/l.length*100);this._broadcastEvent(ft.SEGMENT_LOADING_COMPLETE,{percentComplete:g,numSegments:l.length})},g=[];for(let e=0;e<l.length;e++){const t=new Promise(((t,n)=>{setTimeout((()=>{p(l[e]).then((()=>{t()}))}),0)}));g.push(t)}return await Promise.all(g),d.segmentCount=l.length,e.isLoaded=!0,d.cachedStats={...d.cachedStats,segmentCenter:{...d.cachedStats.segmentCenter,...u}},this._broadcastEvent(ft.SEGMENTATION_LOADING_COMPLETE,{segmentationId:t,rtDisplaySet:e}),this.addOrUpdateSegmentation(d,n)}jumpToSegmentCenter(e,t,n,o=.9,i=!0,r=750,l=!1,c="ease-in-out"){const{toolGroupService:d}=this.servicesManager.services,m=this._getSegmentCenter(e,t);if(!m)return;const{world:u}=m;n=n||this._getToolGroupIdsWithSegmentation(e);const p=[];Array.isArray(n)?n.forEach((e=>{p.push(d.getToolGroup(e))})):p.push(d.getToolGroup(n)),p.forEach((n=>{const d=n.getViewportsInfo();for(const{viewportId:e,renderingEngineId:t}of d){const{viewport:n}=(0,a.getEnabledElementByIds)(e,t);s.utilities.viewport.jumpToWorld(n,u)}i&&this.highlightSegment(e,t,n.id,o,r,l,c)}))}highlightSegment(e,t,n,o=.9,i=750,r=!0,a="ease-in-out"){this.highlightIntervalId&&clearInterval(this.highlightIntervalId);const s=this.getSegmentation(e);n=n??this._getFirstToolGroupId();const l=this._getSegmentationRepresentation(e,n),{type:c}=l,{segments:d}=s;(c===It?this._highlightLabelmap.bind(this):this._highlightContour.bind(this))(t,c===It?o:1-o,r,d,n,i,l)}_highlightLabelmap(e,t,n,o,i,r,a){const l={[e]:{LABELMAP:{fillAlpha:t}}};if(n)for(let t=0;t<o.length;t++)t!==e&&(l[t]={LABELMAP:{fillAlpha:0}});const{fillAlpha:c}=this.getConfiguration(i);let d=null;const m=t=>{null===d&&(d=t);const n=t-d,o=Math.min(n/r,1);s.segmentation.config.setSegmentSpecificConfig(i,a.segmentationRepresentationUID,{[e]:{LABELMAP:{fillAlpha:gt(o,c)}}}),o<1?requestAnimationFrame(m):s.segmentation.config.setSegmentSpecificConfig(i,a.segmentationRepresentationUID,{})};requestAnimationFrame(m)}_highlightContour(e,t,n,o,i,r,a){const l=performance.now(),c=t=>{const n=(t-l)/r;if(n>=1)return void s.segmentation.config.setSegmentSpecificConfig(i,a.segmentationRepresentationUID,{});const o=1-gt(n,d=.1)+d;var d;s.segmentation.config.setSegmentSpecificConfig(i,a.segmentationRepresentationUID,{[e]:{CONTOUR:{fillAlpha:o}}}),requestAnimationFrame(c)};requestAnimationFrame(c)}removeSegmentationRepresentationFromToolGroup(e,t){const n=t||[];if(!n.length){const t=s.segmentation.state.getSegmentationRepresentations(e);if(!t||!t.length)return;n.push(...t.map((e=>e.segmentationRepresentationUID)))}s.segmentation.removeSegmentationsFromToolGroup(e,n)}remove(e){const t=this.segmentations[e],n=t.isActive;if(!e||!t)return void console.warn("No segmentationId provided, or unable to find segmentation by id.");const{colorLUTIndex:o}=t;if(this._removeSegmentationFromCornerstone(e),s.segmentation.state.removeColorLUT(o),delete this.segmentations[e],n){const e=this._getSegmentations();if(e.length){const{id:t}=e[0];this._setActiveSegmentationForToolGroup(t,this._getFirstToolGroupId(),!1)}}this._broadcastEvent(this.EVENTS.SEGMENTATION_REMOVED,{segmentationId:e})}setSegmentLabelForSegmentation(e,t,n){this._setSegmentLabelForSegmentation(e,t,n)}_setSegmentLabelForSegmentation(e,t,n,o=!1){const i=this.getSegmentation(e);if(void 0===i)throw new Error(`no segmentation for segmentationId: ${e}`);const r=i.segments[t];if(void 0===r)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);r.label=n,!1===o&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:i})}shouldRenderSegmentation(e,t){if(!e||!e.length)return!1;const{displaySetService:n}=this.servicesManager.services;let o=!1;const i=n.getDisplaySetByUID(t),r=this._getFrameOfReferenceUIDForSeg(i);for(const t of e){const e=n.getDisplaySetByUID(t);if(e.isReconstructable&&e?.images?.[0]?.FrameOfReferenceUID===r){o=!0;break}}return o}_getDefaultSegmentationScheme(){return{activeSegmentIndex:1,cachedStats:{},label:"",segmentsLocked:[],displayText:[],hydrated:!1,segmentCount:0,segments:[],isVisible:!0,isActive:!1,colorLUTIndex:0}}_setActiveSegmentationForToolGroup(e,t,n=!1){const o=this._getSegmentations(),i=this.getSegmentation(e);if(void 0===i)throw new Error(`no segmentation for segmentationId: ${e}`);o.forEach((t=>{t.isActive=t.id===e}));const r=this._getSegmentationRepresentation(e,t);s.segmentation.activeSegmentation.setActiveSegmentationRepresentation(t,r.segmentationRepresentationUID),!1===n&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:i})}_setActiveSegment(e,t,n=!1){const o=this.getSegmentation(e);if(void 0===o)throw new Error(`no segmentation for segmentationId: ${e}`);s.segmentation.segmentIndex.setActiveSegmentIndex(e,t),o.activeSegmentIndex=t,!1===n&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:o})}_getSegmentInfo(e,t){const n=e.segments;if(n)return n&&n.length>0?n[t]:void 0}_getVolumeIdForDisplaySet(e){return`${e.volumeLoaderSchema??"cornerstoneStreamingImageVolume"}:${e.displaySetInstanceUID}`}_getSegmentCenter(e,t){const n=this.getSegmentation(e);if(!n)return;const{cachedStats:o}=n;if(!o)return;const{segmentCenter:i}=o;if(!i)return;const{center:r}=i[t];return r}_setSegmentLocked(e,t,n,o=!1){const i=this.getSegmentation(e);if(void 0===i)throw new Error(`no segmentation for segmentationId: ${e}`);const r=this._getSegmentInfo(i,t);if(void 0===r)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);r.isLocked=n,s.segmentation.segmentLocking.setSegmentIndexLocked(e,t,n),!1===o&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:i})}_setSegmentVisibility(e,t,n,o,i=!1){o=o??this._getFirstToolGroupId();const{segmentationRepresentationUID:r,segmentation:a}=this._getSegmentationInfo(e,o);if(void 0===a)throw new Error(`no segmentation for segmentationId: ${e}`);const l=this._getSegmentInfo(a,t);if(void 0===l)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);l.isVisible=n,s.segmentation.config.visibility.setSegmentVisibility(o,r,t,n),a.isVisible=a.segments.filter(Boolean).every((e=>e.isVisible)),!1===i&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:a})}_setSegmentLabel(e,t,n,o=!1){const i=this.getSegmentation(e);if(void 0===i)throw new Error(`no segmentation for segmentationId: ${e}`);const r=this._getSegmentInfo(i,t);if(void 0===r)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);r.label=n,!1===o&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:i})}_getSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentationsForToolGroup(t);if(0===n.length)return;return n.find((t=>t.segmentationId===e))}_initSegmentationService(){a.eventTarget.addEventListener(s.Enums.Events.SEGMENTATION_MODIFIED,this._onSegmentationModifiedFromSource),a.eventTarget.addEventListener(s.Enums.Events.SEGMENTATION_DATA_MODIFIED,this._onSegmentationDataModified)}_getSegmentationInfo(e,t){const n=this.getSegmentation(e);if(void 0===n)throw new Error(`no segmentation for segmentationId: ${e}`);const o=this._getSegmentationRepresentation(e,t);if(!o)throw new Error("Must add representation to toolgroup before setting segments");const{segmentationRepresentationUID:i}=o;return{segmentationRepresentationUID:i,segmentation:n}}_removeSegmentationFromCornerstone(e){const t=s.segmentation.state;if(!t.getSegmentation(e))return;t.getToolGroupIdsWithSegmentation(e).forEach((n=>{const o=t.getSegmentationRepresentations(n),i=[];o.forEach((t=>{t.segmentationId===e&&i.push(t.segmentationRepresentationUID)})),s.segmentation.removeSegmentationsFromToolGroup(n,i,!0)})),t.removeSegmentation(e),a.cache.getVolumeLoadObject(e)&&a.cache.removeVolumeLoadObject(e)}_updateCornerstoneSegmentations({segmentationId:e,notYetUpdatedAtSource:t}){if(!1===t)return;const n=s.segmentation.state.getSegmentation(e),o=this.segmentations[e],{label:i,cachedStats:r}=o;n.label!==i&&(n.label=i),pt()(n.cachedStats,r)||(n.cachedStats=r)}_getToolGroupIdsWithSegmentation(e){return s.segmentation.state.getToolGroupIdsWithSegmentation(e)}_getFrameOfReferenceUIDForSeg(e){const t=e.instance?.FrameOfReferenceUID;if(t)return t;const n=e.instance?.ReferencedFrameOfReferenceSequence;return n?n.FrameOfReferenceUID:void 0}generateNewColorLUT(){return mt()(ht)}}ct=wt,wt.REGISTRATION={name:"segmentationService",altName:"SegmentationService",create:({servicesManager:e})=>new ct({servicesManager:e})};const Et=wt;function yt(e){const t=e.toLowerCase();if("stack"===t)return a.Enums.ViewportType.STACK;if("volume"===t||"orthographic"===t)return a.Enums.ViewportType.ORTHOGRAPHIC;if("volume3d"===t)return a.Enums.ViewportType.VOLUME_3D;throw new Error(`Invalid viewport type: ${e}. Valid types are: stack, volume`)}var Tt;const Dt="cornerstoneStreamingImageVolume";class bt{constructor(e){this.panoramicStateCache={},this.stackImageIds=new Map,this.volumeImageIds=new Map,this.servicesManager=void 0,this.servicesManager=e}setPanoramicStateCache(e,t){this.panoramicStateCache[t]=e}getPanoramicStateCache(e){return this.panoramicStateCache[e]}getCacheSize(){return a.cache.getCacheSize()}getCacheFreeSpace(){return a.cache.getBytesAvailable()}async createViewportData(e,t,n,o){let i=t.viewportType;this._shouldRenderSegmentation(e)&&(i="volume",t.viewportType=i);const r=yt(i);let s;return r===a.Enums.ViewportType.STACK&&(s=await this._getStackViewportData(n,e,o,r)),r!==a.Enums.ViewportType.ORTHOGRAPHIC&&r!==a.Enums.ViewportType.VOLUME_3D||(s=await this._getVolumeViewportData(n,e,r)),s.viewportType=r,s}async invalidateViewportData(e,t,n,o){if(e.viewportType===a.Enums.ViewportType.STACK)return this._getCornerstoneStackImageIds(o.getDisplaySetByUID(t),n);const i=`${Dt}:${t}`;a.cache.getVolume(i)&&(a.cache.removeVolumeLoadObject(i),this.volumeImageIds.delete(i));const r=e.data.map((({displaySetInstanceUID:e})=>o.getDisplaySetByUID(e)));return await this._getVolumeViewportData(n,r,e.viewportType)}_getStackViewportData(e,t,n,o){const i=t[0];let r=this.stackImageIds.get(i.displaySetInstanceUID);r||(r=this._getCornerstoneStackImageIds(i,e),this.stackImageIds.set(i.displaySetInstanceUID,r));const{displaySetInstanceUID:a,StudyInstanceUID:s,isCompositeStack:l}=i,c={viewportType:o,data:{StudyInstanceUID:s,displaySetInstanceUID:a,isCompositeStack:l,imageIds:r}};return"number"==typeof n&&(c.data.initialImageIndex=n),c}async _getVolumeViewportData(e,t,n){const o=[];for(const n of t){if(n.load&&n.load instanceof Function){const{userAuthenticationService:e}=this.servicesManager.services,t=e.getAuthorizationHeader();await n.load({headers:t}),o.push({studyInstanceUID:n.StudyInstanceUID,displaySetInstanceUID:n.displaySetInstanceUID});continue}const t=`${n.volumeLoaderSchema??Dt}:${n.displaySetInstanceUID}`;let i=this.volumeImageIds.get(n.displaySetInstanceUID),r=a.cache.getVolume(t);i&&r||(i=this._getCornerstoneVolumeImageIds(n,e),r=await a.volumeLoader.createAndCacheVolume(t,{imageIds:i}),this.volumeImageIds.set(n.displaySetInstanceUID,i)),o.push({StudyInstanceUID:n.StudyInstanceUID,displaySetInstanceUID:n.displaySetInstanceUID,volume:r,volumeId:t,imageIds:i})}return{viewportType:n,data:o}}_shouldRenderSegmentation(e){const{segmentationService:t}=this.servicesManager.services,n=e.map((({displaySetInstanceUID:e})=>e)),o=t.getSegmentations();for(const e of o){const o=e.displaySetInstanceUID;if(t.shouldRenderSegmentation(n,o))return!0}}_getCornerstoneStackImageIds(e,t){return e.images.map((e=>e.imageId))}_getCornerstoneVolumeImageIds(e,t){return this._getCornerstoneStackImageIds(e,t)}}Tt=bt,bt.REGISTRATION={name:"cornerstoneCacheService",altName:"CornerstoneCacheService",create:({servicesManager:e})=>new Tt(e)};const Ot=bt,Nt="OHIFCornerstoneRenderingEngine";const Mt="stack",Ct="default",Ut=(e,t,n)=>e.displaySetInstanceUID===t||!!(n&&e.isCompositeStack&&e.imageIds)&&!!e.imageIds.find((e=>e===n));const At=class{constructor(e,t){this.viewportId="",this.viewportIndex=void 0,this.element=void 0,this.viewportOptions=void 0,this.displaySetOptions=void 0,this.viewportData=void 0,this.renderingEngineId=void 0,this.destroy=()=>{this.element=null,this.viewportData=null,this.viewportOptions=null,this.displaySetOptions=null},this.viewportIndex=e,this.viewportId=t,this.setPublicViewportOptions({}),this.setPublicDisplaySetOptions([{}])}contains(e,t){return!!this.viewportData?.data&&(this.viewportData.data.length?!!this.viewportData.data.find((n=>Ut(n,e,t))):Ut(this.viewportData.data,e,t))}setRenderingEngineId(e){this.renderingEngineId=e}getRenderingEngineId(){return this.renderingEngineId}setViewportId(e){this.viewportId=e}setViewportIndex(e){this.viewportIndex=e}setElement(e){this.element=e}setViewportData(e){this.viewportData=e}getViewportData(){return this.viewportData}getViewportIndex(){return this.viewportIndex}getElement(){return this.element}getViewportId(){return this.viewportId}setPublicDisplaySetOptions(e){const t=this.mapDisplaySetOptions(e);this.setDisplaySetOptions(t)}hasDisplaySet(e){let t=this.getViewportData();return t.viewportType===a.Enums.ViewportType.ORTHOGRAPHIC?t.data.some((({displaySetInstanceUID:t})=>t===e)):t.data.displaySetInstanceUID===e}setPublicViewportOptions(e){let t=e.viewportType;const{toolGroupId:n=Ct,presentationIds:o}=e;let i;t=yt(t?e.viewportType:Mt),e.viewportType?.toLowerCase()!==Mt&&(i=function(e){if(e)switch(e.toLowerCase()){case"axial":return a.Enums.OrientationAxis.AXIAL;case"sagittal":return a.Enums.OrientationAxis.SAGITTAL;case"coronal":return a.Enums.OrientationAxis.CORONAL;default:return a.Enums.OrientationAxis.ACQUISITION}return a.Enums.OrientationAxis.ACQUISITION}(e.orientation)),n||(n=Ct),this.setViewportOptions({...e,viewportId:this.viewportId,viewportType:t,orientation:i,toolGroupId:n,presentationIds:o})}setViewportOptions(e){this.viewportOptions=e}getViewportOptions(){return this.viewportOptions}setDisplaySetOptions(e){this.displaySetOptions=e}getSyncGroups(){return this.viewportOptions.syncGroups||=[],this.viewportOptions.syncGroups}getDisplaySetOptions(){return this.displaySetOptions}getViewportType(){return this.viewportOptions.viewportType||a.Enums.ViewportType.STACK}getToolGroupId(){return this.viewportOptions.toolGroupId}getBackground(){return this.viewportOptions.background||[0,0,0]}getOrientation(){return this.viewportOptions.orientation}getInitialImageOptions(){return this.viewportOptions.initialImageOptions}mapDisplaySetOptions(e=[{}]){const t=[];return e.forEach((e=>{let n=e?.options||e;n||(n={blendMode:void 0,slabThickness:void 0,colormap:void 0,voi:{},voiInverted:!1});const o=function(e){if(!e)return a.Enums.BlendModes.COMPOSITE;if("mip"===e.toLowerCase())return a.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND;throw new Error}(n.blendMode);t.push({voi:n.voi,voiInverted:n.voiInverted,colormap:n.colormap,slabThickness:n.slabThickness,blendMode:o,displayPreset:n.displayPreset})})),t}};var Rt=function(e){return e.First="first",e.Last="last",e.Middle="middle",e}(Rt||{});const Vt=Rt;var Pt,_t=n(85598),Ft=n(60330),xt=n(92632),Lt=n(17394);const Gt={VIEWPORT_DATA_CHANGED:"event::cornerstoneViewportService:viewportDataChanged"};class kt extends l.hC{constructor(e){super(Gt),this.renderingEngine=void 0,this.viewportsInfo=new Map,this.viewportsById=new Map,this.viewportGridResizeObserver=void 0,this.viewportsDisplaySets=new Map,this.enableResizeDetector=void 0,this.resizeRefreshRateMs=void 0,this.resizeRefreshMode=void 0,this.servicesManager=null,this.renderingEngine=null,this.viewportGridResizeObserver=null,this.servicesManager=e}enableViewport(e,t,n){t.viewportId||(console.warn("Should provide viewport id externally",t),t.viewportId=this.getViewportId(e)||`viewport-${e}`);const{viewportId:o}=t,i=new At(e,o);if(!i.viewportId)throw new Error("Should have viewport ID afterwards");i.setElement(n),this.viewportsInfo.set(e,i),this.viewportsById.set(o,i)}getViewportIds(){const e=[];return this.viewportsInfo.forEach((t=>{e.push(t.getViewportId())})),e}getViewportId(e){return this.viewportsInfo[e]?.viewportId}getRenderingEngine(){const e=(0,a.getRenderingEngine)(Nt);return e?(this.renderingEngine=e,this.renderingEngine):(e&&!e.hasBeenDestroyed||(this.renderingEngine=new a.RenderingEngine(Nt)),this.renderingEngine)}resize(){this.renderingEngine.resize(!0,!0),this.renderingEngine.render()}destroy(){this._removeResizeObserver(),this.viewportGridResizeObserver=null;try{this.renderingEngine?.destroy?.()}catch(e){console.warn("Rendering engine not destroyed",e)}this.viewportsDisplaySets.clear(),this.renderingEngine=null,a.cache.purgeCache()}disableElement(e){const t=this.viewportsInfo.get(e);if(!t)return;const n=t.getViewportId();this.renderingEngine&&this.renderingEngine.disableElement(n),this.viewportsInfo.get(e).destroy(),this.viewportsInfo.delete(e),this.viewportsById.delete(n)}setPresentations(e,t){const n=t?.lutPresentation?.properties;n&&e.setProperties(n);const o=t?.positionPresentation?.camera;o&&e.setCamera(o)}getPresentation(e){const t=this.viewportsInfo.get(e);if(!t)return;const{viewportType:n,presentationIds:o}=t.getViewportOptions(),i=this.getCornerstoneViewportByIndex(e);if(!i)return;const r=i.getProperties();r.isComputedVOI&&(delete r.voiRange,delete r.VOILUTFunction);return{presentationIds:o,viewportType:n&&"stack"!==n?"volume":"stack",properties:r,initialImageIndex:i.getCurrentImageIdIndex(),camera:i.getCamera()}}setViewportData(e,t,n,o,i){console.log("setViewportData",e,t,n,o,i);const r=this.getRenderingEngine(),a=n.viewportId||this.getViewportId(e);if(!a)throw new Error("Must define viewportId externally");const s=this.viewportsById.get(a);if(console.log("ID",a,e,n.viewportId),!s)throw new Error("Viewport info not defined");s.viewportIndex!==e&&(this.viewportsInfo.delete(s.viewportIndex),this.viewportsInfo.set(e,s),s.viewportIndex=e),s.setRenderingEngineId(r.id);const{viewportOptions:l,displaySetOptions:c}=this._getViewportAndDisplaySetOptions(n,o,s);s.setViewportOptions(l),s.setDisplaySetOptions(c),s.setViewportData(t);const d={viewportId:a,element:s.getElement(),type:s.getViewportType(),defaultOptions:{background:s.getBackground(),orientation:s.getOrientation()}};r.enableElement(d);const m=r.getViewport(a);this._setDisplaySets(m,t,s,i),this._broadcastEvent(this.EVENTS.VIEWPORT_DATA_CHANGED,{viewportData:t,viewportIndex:e,viewportId:a})}getCornerstoneViewport(e){if(!this.getViewportInfo(e)||!this.renderingEngine||this.renderingEngine.hasBeenDestroyed)return null;return this.renderingEngine.getViewport(e)}getCornerstoneViewportByIndex(e){const t=this.getViewportInfoByIndex(e);if(!t||!this.renderingEngine||this.renderingEngine.hasBeenDestroyed)return null;return this.renderingEngine.getViewport(t.getViewportId())}getViewportInfoByIndex(e){return this.viewportsInfo.get(e)}getViewportInfo(e){for(const[t,n]of this.viewportsInfo.entries())if(n.getViewportId()===e)return n;return null}_setStackViewport(e,t,n,o){const i=n.getDisplaySetOptions(),{imageIds:r,initialImageIndex:s,displaySetInstanceUID:l}=t.data;this.viewportsDisplaySets.set(e.id,[l]);let c=o?.positionPresentation?.initialImageIndex??s;null==c&&(c=this._getInitialImageIndexForViewport(n,r)||0);const d={...o.lutPresentation?.properties};if(!o.lutPresentation?.properties){const{voi:e,voiInverted:t}=i[0];if(e&&(e.windowWidth||e.windowCenter)){const{lower:t,upper:n}=a.utilities.windowLevel.toLowHighRange(e.windowWidth,e.windowCenter);d.voiRange={lower:t,upper:n}}void 0!==t&&(d.invert=t)}e.setStack(r,c).then((()=>{e.setProperties(d);const t=o.positionPresentation?.camera;t&&e.setCamera(t)}))}_getInitialImageIndexForViewport(e,t){const n=e.getInitialImageOptions();if(!n)return;const{index:o,preset:i}=n,r=e.getViewportType();let s;if(r===a.Enums.ViewportType.STACK)s=t.length;else{if(r!==a.Enums.ViewportType.ORTHOGRAPHIC)return;{const t=this.getCornerstoneViewport(e.getViewportId()),n=a.utilities.getImageSliceDataForVolumeViewport(t);if(!n)return;({numberOfSlices:s}=n)}}return this._getInitialImageIndex(s,o,i)}_getInitialImageIndex(e,t,n){const o=e-1;return void 0!==t?s.utilities.clip(t,0,o):n===Vt.First?0:n===Vt.Last?o:n===Vt.Middle?o%2==0?o/2:(o+1)/2:0}async _setVolumeViewport(e,t,n,o){const i=[],r=n.getDisplaySetOptions(),{hangingProtocolService:a}=this.servicesManager.services,s=[],l=[];for(const[e,n]of t.data.entries()){const{volume:t,imageIds:o,displaySetInstanceUID:a}=n;if(l.push(a),!t){console.log("Volume display set not found");continue}s.push(t);const c=r[e],{volumeId:d}=t;i.push({imageIds:o,volumeId:d,blendMode:c.blendMode,slabThickness:this._getSlabThickness(c,d)})}return this.viewportsDisplaySets.set(e.id,l),a.hasCustomImageLoadStrategy()&&!a.customImageLoadPerformed?a.runImageLoadStrategy({viewportId:e.id,volumeInputArray:i}):(s.forEach((e=>{e.loadStatus.loaded||e.loadStatus.loading||e.load()})),this.setVolumesForViewport(e,i,o))}async setVolumesForViewport(e,t,n){const{displaySetService:o,toolGroupService:i}=this.servicesManager.services;console.log("SET VOLUMES FOR VIEWPORT",t,e,e.id);const r=this.getViewportInfo(e.id),l=r.getDisplaySetOptions(),c=t.map(((e,t)=>{const{volumeId:n}=e,o=l[t],{voi:i,voiInverted:r,colormap:s,displayPreset:c}=o,d={};if(i&&(i.windowWidth||i.windowCenter)){const{lower:e,upper:t}=a.utilities.windowLevel.toLowHighRange(i.windowWidth,i.windowCenter);d.voiRange={lower:e,upper:t}}return void 0!==r&&(d.invert=r),void 0!==s&&(d.colormap=s),void 0!==c&&(d.preset=c),{properties:d,volumeId:n}}));if("volume3d"===e.type){let n=e.getActors();if(0===n.length){let o=[];e.setVolumes(t).then((()=>{n=e.getActors(),n.forEach((e=>{const t=e.actor.getMapper().getInputData(),n=_t.ZP.newInstance(),i=Ft.ZP.newInstance();i.setInputData(t),i.setSampleDistance(1),n.setMapper(i);const r=xt.ZP.newInstance();r.addRGBPoint(-3024,0,0,0),r.addRGBPoint(-801,0,0,0),r.addRGBPoint(-800,.92,.74,.7),r.addRGBPoint(448,.92,.74,.7),r.addRGBPoint(449,.5,.5,.1),r.addRGBPoint(1224,1,1,1);const a=Lt.ZP.newInstance();a.addPoint(-3024,0),a.addPoint(-801,0),a.addPoint(-800,.05),a.addPoint(449,.05),a.addPoint(450,1),a.addPoint(1299,1),a.addPoint(1300,1),n.getProperty().setRGBTransferFunction(0,r),n.getProperty().setScalarOpacity(0,a),n.getProperty().setScalarOpacityUnitDistance(0,4.5),n.getProperty().setInterpolationTypeToLinear(),n.getProperty().setUseGradientOpacity(0,!0),n.getProperty().setGradientOpacityMinimumValue(0,15),n.getProperty().setGradientOpacityMinimumOpacity(0,0),n.getProperty().setGradientOpacityMaximumValue(0,100),n.getProperty().setGradientOpacityMaximumOpacity(0,.5),n.getProperty().setShade(!0),n.getProperty().setAmbient(.2),n.getProperty().setDiffuse(.7),n.getProperty().setSpecular(.7),n.getProperty().setSpecularPower(8),e.actor=n,o.push(e)})),e.setActors(o)}))}else e.setActors(n)}else await e.setVolumes(t);c.forEach((({properties:t,volumeId:n})=>{e.setProperties(t,n)})),this.setPresentations(e,n);const d=this.viewportsDisplaySets.get(e.id),m=d.map(o.getDisplaySetByUID).find((e=>e?.isOverlayDisplaySet));m?this.addOverlayRepresentationForDisplaySet(m,e):this._addSegmentationRepresentationToToolGroupIfNecessary(d,e);const u=i.getToolGroupForViewport(e.id);s.utilities.segmentation.triggerSegmentationRender(u.id);const p=this._getInitialImageIndexForViewport(r);void 0!==p&&s.utilities.jumpToSlice(e.element,{imageIndex:p}),e.render()}_addSegmentationRepresentationToToolGroupIfNecessary(e,t){const{segmentationService:n,toolGroupService:o}=this.servicesManager.services,i=o.getToolGroupForViewport(t.id),r=n.getSegmentations();for(const t of r){if((n.getSegmentationRepresentationsForToolGroup(i.id)||[]).find((e=>e.segmentationId===t.id)))continue;const{id:o,type:r}=t,a=this._getFrameOfReferenceUID(o);let s=!1;for(const t of e){if(a===this._getFrameOfReferenceUID(t)){s=!0;break}}if(!s)return;n.addSegmentationRepresentationToToolGroup(i.id,t.id,!1,t.type)}}addOverlayRepresentationForDisplaySet(e,t){const{segmentationService:n,toolGroupService:o}=this.servicesManager.services,{referencedVolumeId:i}=e,r=e.displaySetInstanceUID,l=o.getToolGroupForViewport(t.id),c=i&&void 0!==a.cache.getVolume(i)?s.Enums.SegmentationRepresentations.Labelmap:s.Enums.SegmentationRepresentations.Contour;n.addSegmentationRepresentationToToolGroup(l.id,r,!1,c)}updateViewport(e,t,n,o=!1){const i=this.getViewportInfoByIndex(e),r=i.getViewportId(),s=this.getCornerstoneViewport(r),l=s.getCamera();s instanceof a.VolumeViewport?this._setVolumeViewport(s,t,i,n).then((()=>{o&&(s.setCamera(l),s.render())})):s instanceof a.StackViewport&&this._setStackViewport(s,t,i,n)}_setDisplaySetInURL(e){if(!e)return;const t=new URLSearchParams(window.location.search);if(t.get("displaySetInstanceUID")!==e){t.set("displaySetInstanceUID",e);const n=window.location.protocol+"//"+window.location.host+window.location.pathname+"?"+t.toString();window.history.pushState({path:n},"",n)}}_setSeriesUIDInURL(e){if(!e)return;const t=a.metaData.get("generalSeriesModule",e).seriesInstanceUID,n=new URLSearchParams(window.location.search);if(n.get("seriesUID")!==t){n.set("seriesUID",t);const e=window.location.protocol+"//"+window.location.host+window.location.pathname+"?"+n.toString();window.history.pushState({path:e},"",e)}}_setDisplaySets(e,t,n,o={}){if(this._setSeriesUIDInURL(t?.data[0]?.imageIds[0]),e instanceof a.StackViewport)this._setStackViewport(e,t,n,o);else{if(!(e instanceof a.VolumeViewport||e instanceof a.VolumeViewport3D))throw new Error("Unknown viewport type");this._setVolumeViewport(e,t,n,o)}}_removeResizeObserver(){this.viewportGridResizeObserver&&this.viewportGridResizeObserver.disconnect()}_getSlabThickness(e,t){const{blendMode:n}=e;if(void 0!==n&&void 0!==e.slabThickness){if("number"==typeof e.slabThickness)return e.slabThickness;if("fullvolume"===e.slabThickness.toLowerCase()){const e=a.cache.getVolume(t),{dimensions:n}=e;return Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2])}}}_getViewportAndDisplaySetOptions(e,t,n){const o=n.getViewportIndex(),i=new At(o,n.getViewportId());i.setPublicViewportOptions(e),i.setPublicDisplaySetOptions(t);return{viewportOptions:i.getViewportOptions(),displaySetOptions:i.getDisplaySetOptions()}}_getFrameOfReferenceUID(e){const{displaySetService:t}=this.servicesManager.services,n=t.getDisplaySetByUID(e);if(!n)return;if(n.frameOfReferenceUID)return n.frameOfReferenceUID;if("SEG"===n.Modality){const{instance:e}=n;return e.FrameOfReferenceUID}if("RTSTRUCT"===n.Modality){const{instance:e}=n;return e.ReferencedFrameOfReferenceSequence.FrameOfReferenceUID}const{images:o}=n;return o&&o.length?o[0].FrameOfReferenceUID:void 0}getViewportIndexToJump(e,t,n){const o=this.viewportsInfo.get(e),{referencedImageId:i}=n;return o?.contains(t,i)?e:[...this.viewportsById.values()].find((e=>e.contains(t,i)))?.viewportIndex??-1}}Pt=kt,kt.REGISTRATION={name:"cornerstoneViewportService",altName:"CornerstoneViewportService",create:({servicesManager:e})=>new Pt(e)};const $t=kt;var Bt=n(75935);const jt=e=>{if(e)return"function"==typeof e.getImageId?e.getImageId():e.url},zt=e=>(Array.isArray(e)?e:[e]).some((e=>!e)),qt=e=>e&&e.images&&e.images[0],Wt=e=>jt(e),Ht=(e,t=l.DICOMWeb.getAuthorizationHeader())=>fetch(e,t).then((e=>e.arrayBuffer())),Zt=e=>a.imageLoader.loadAndCacheImage(e).then((e=>e&&e.data&&e.data.byteArray.buffer)),Yt=(e,t,n,o,i=l.DICOMWeb.getAuthorizationHeader(),r=l.Po.getHTTPErrorHandler())=>{const a={url:e,headers:i,errorInterceptor:r};return new Bt.api.DICOMwebClient(a).retrieveInstance({studyInstanceUID:t,seriesInstanceUID:n,sopInstanceUID:o})};const Kt=new class{getLocalData(e,t){const n=qt(e),o=(e=>e&&e.instance)(e);if(!n&&!o||!o.imageId.startsWith("dicomfile"))return;let i=Wt(n||o);return zt(i)&&(i=((e,t)=>{const n=e.find((e=>e.displaySets.some((e=>e.displaySetInstanceUID===t)))),{series:o=[]}=n,{instances:i=[]}=o[0]||{},r=i[0];return jt(r)})(t,e.displaySetInstanceUID)),zt(i)?void 0:m().wadouri.loadFileRequest(i)}getDataByImageType(e){const t=qt(e);if(t){const e=Wt(t);let n=Ht;const o=(e=>{const t=/^\w+\:/,n=t.exec(e);return 0===t.lastIndex&&n&&n[0]&&n[0].replace(":","")||""})(e);switch(o){case"dicomfile":n=Zt.bind(this,e);break;case"wadors":const i=t.getData().wadoRoot,r=t.getStudyInstanceUID(),a=t.getSeriesInstanceUID(),s=t.getSOPInstanceUID();if(zt([i,r,a,s]))return;n=Yt.bind(this,i,r,a,s);break;case"wadouri":if(e=e.substring(e.indexOf(":")+1),zt(e))return;n=Ht.bind(this,e);break;default:throw new Error(`Unsupported image type: ${o} for imageId: ${e}`)}return n()}}getDataByDatasetType(e){const{StudyInstanceUID:t,SeriesInstanceUID:n,SOPInstanceUID:o,authorizationHeaders:i,wadoRoot:r,wadoUri:a}=e;return zt(r)?zt(a)?void 0:Ht(a,{headers:i}):Yt(r,t,n,o,i)}*getLoaderIterator(e,t,n){yield this.getLocalData(e,t),yield this.getDataByImageType(e),yield this.getDataByDatasetType(e)}findDicomDataPromise(e,t,n){e.authorizationHeaders=n;const o=this.getLoaderIterator(e,t);for(const e of o)if(e)return e;throw new Error("Invalid dicom data loader")}},Jt=JSON.parse('{"u2":"@ohif/extension-cornerstone"}').u2;function Xt(e){if(e.longAxis&&e.shortAxis){const t={};return t.start=e.longAxis[0],t.end=e.longAxis[1],t.perpendicularStart=e.longAxis[0],t.perpendicularEnd=e.longAxis[1],t}return e.map(((e,t)=>t%10==0?{start:e}:{end:e})).reduce(((e,t)=>Object.assign(e,{...t})),{})}function Qt(){return Qt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},Qt.apply(this,arguments)}const en=r.lazy((()=>Promise.all([n.e(664),n.e(351)]).then(n.bind(n,30351)))),tn=e=>r.createElement(r.Suspense,{fallback:r.createElement("div",null,"Loading...")},r.createElement(en,e)),nn={id:Jt,onModeExit:()=>{Object.values(a.Enums.RequestType).forEach((e=>{a.imageLoadPoolManager.clearRequestStack(e),a.imageRetrievalPoolManager.clearRequestStack(e)})),function(){const e=d.webWorkerManager.webWorkers;for(let t=0;t<e.length;t++)e[t].worker.terminate();e.length=0}(),(0,v.mc)()},preRegistration:function(e){const{servicesManager:t}=e;return t.registerService($t.REGISTRATION),t.registerService(it.REGISTRATION),t.registerService(lt.REGISTRATION),t.registerService(Et.REGISTRATION),t.registerService(Ot.REGISTRATION),pe.call(this,e)},getHangingProtocolModule:et,getViewportModule:({servicesManager:e,commandsManager:t})=>[{name:"cornerstone",component:n=>{const{toolbarService:o}=e.services;return r.createElement(tn,Qt({},n,{toolbarService:o,servicesManager:e,commandsManager:t}))}}],getCommandsModule:Ke,getCustomizationModule:xe,getUtilityModule:({servicesManager:e})=>[{name:"common",exports:{getCornerstoneLibraries:()=>({cornerstone:a,cornerstoneTools:s}),getEnabledElement:v.K8,dicomLoaderService:Kt}},{name:"core",exports:{Enums:a.Enums}},{name:"tools",exports:{toolNames:b,Enums:s.Enums}}]}},21922:(e,t,n)=>{"use strict";n.d(t,{K8:()=>r,Yc:()=>i,mc:()=>a});const o={DEFAULT_CONTEXT:"CORNERSTONE",enabledElements:{}},i=(e,t,n)=>{const i=n||o.DEFAULT_CONTEXT;o.enabledElements[e]={element:t,context:i}},r=e=>o.enabledElements[e],a=()=>{o.enabledElements={}}},63130:(e,t,n)=>{"use strict";n.d(t,{Z:()=>i});var o=n(98386);function i(e){if(e)return function(e){const t=o.metaData.get("instance",e);return console.log("get uid from image id",t),{SOPInstanceUID:t.SOPInstanceUID,SeriesInstanceUID:t.SeriesInstanceUID,StudyInstanceUID:t.StudyInstanceUID,frameNumber:t.frameNumber||1}}(e)}},78753:()=>{}}]);
//# sourceMappingURL=707.bundle.452ba1f06537daabc1e1.js.map