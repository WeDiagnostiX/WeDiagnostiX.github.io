"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[5571],{85571:(e,t,n)=>{n.r(t),n.d(t,{default:()=>y});var s=n(3827),a=n.n(s),r=n(43001),i=n(69190),l=n(84793),o=n(75449),c=n(47316),u=n(83330),d=n(52490),p=n(92522);function m(){return m=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)({}).hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},m.apply(null,arguments)}function S(e){const{children:t,dataSource:n,displaySets:s,viewportOptions:a,servicesManager:l,extensionManager:S}=e,[y]=(0,d.M)(),{displaySetService:g,cornerstoneViewportService:f,measurementService:v,viewportActionCornersService:w}=l.services,E=a.viewportId;if(s.length>1)throw new Error("SR viewport should only have a single display set");const h=s[0],[D,b]=(0,c.O_)(),[k,x]=(0,r.useState)(0),[M,C]=(0,r.useState)(1),[U,O]=(0,r.useState)(null),[T,N]=(0,r.useState)(null),[P,R]=(0,r.useState)(null),{viewports:A,activeViewportId:L}=D,{t:V}=(0,i.$G)("Common");let j,q;if(S.registeredExtensionIds.includes("@ohif/extension-measurement-tracking")){const e=S.getModuleEntry("@ohif/extension-measurement-tracking.contextModule.TrackedMeasurementsContext"),t=(0,r.useContext)(e.context);j=t?.[0],q=t?.[1]}q||(j=null,q=(e,{displaySetInstanceUID:t})=>{v.clearMeasurements();const{SeriesInstanceUIDs:n}=(0,u.Z)({servicesManager:l,extensionManager:S,appConfig:y},t),s=g.getDisplaySetsForSeries(n[0]);s.length&&b.setDisplaySetsForViewports([{viewportId:L,displaySetInstanceUIDs:[s[0].displaySetInstanceUID]}])});const F=(0,r.useCallback)((e=>{const{measurements:t}=h;(0,o.l2)(P,t.map((e=>e.TrackingUniqueIdentifier)),e)}),[P,k,h]),G=(0,r.useCallback)((e=>{const{StudyInstanceUID:t,displaySetInstanceUID:n,sopClassUids:s}=h;t&&n&&(s&&s.length>1&&console.warn("More than one SOPClassUID in the same series is not yet supported."),async function(e,t,n){const{measurements:s}=e,a=s[t],{displaySetInstanceUID:r}=a;e.keyImageDisplaySet||(e.keyImageDisplaySet=(0,p.Z)(n,e));const i=n.getDisplaySetByUID(r),l=i.images[0],o={PatientID:l.PatientID,PatientName:l.PatientName,PatientSex:l.PatientSex,PatientAge:l.PatientAge,SliceThickness:l.SliceThickness,StudyDate:l.StudyDate,SeriesDescription:l.SeriesDescription,SeriesInstanceUID:l.SeriesInstanceUID,SeriesNumber:l.SeriesNumber,ManufacturerModelName:l.ManufacturerModelName,SpacingBetweenSlices:l.SpacingBetweenSlices};return{referencedDisplaySetMetadata:o,referencedDisplaySet:i}}(h,e,g).then((({referencedDisplaySet:t,referencedDisplaySetMetadata:n})=>{if(x(e),O(t),N(n),t.displaySetInstanceUID===U?.displaySetInstanceUID){const{measurements:t}=h,n=f.getCornerstoneViewport(E),s=n.getImageIds().indexOf(t[e].imageId);-1!==s&&n.setImageIdIndex(s)}})))}),[n,h,U,E]),J=(0,r.useCallback)((()=>{if(!U)return null;const{component:t}=S.getModuleEntry("@ohif/extension-cornerstone.viewportModule.cornerstone"),{measurements:n}=h,s=n[k];if(!s)return null;const i=U.images.findIndex((e=>e.imageId===s.imageId));return r.createElement(t,m({},e,{displaySets:[U],viewportOptions:{...a,toolGroupId:"SRToolGroup",viewportType:"stack",positionIds:null},onElementEnabled:t=>{e.onElementEnabled?.(t),(e=>{R(e.detail.element)})(t)},initialImageIndex:i,isJumpToMeasurementDisabled:!0}))}),[U,E,k]),_=(0,r.useCallback)((e=>{let t=k;t+=e,t>=M?t=0:t<0&&(t=M-1),F(t),G(t)}),[k,M,G,F]);(0,r.useEffect)((()=>{const e=g.subscribe(g.EVENTS.DISPLAY_SETS_REMOVED,(({displaySetInstanceUIDs:e})=>{const t=A.get(L);e.includes(t.displaySetInstanceUID)&&b.setDisplaySetsForViewport({viewportId:L,displaySetInstanceUIDs:[]})}));return()=>{e.unsubscribe()}}),[]),(0,r.useEffect)((()=>{(async()=>{h.isLoaded||await h.load();const e=h.measurements.length;C(e),G(k)})()}),[h]),(0,r.useEffect)((()=>{(async()=>{h.isLoaded||await h.load(),P&&h.isLoaded&&F(k)})()}),[k,P,F,h]);const[B,$]=(0,r.useState)(j?.context?.trackedSeries?.length>0);(0,r.useEffect)((()=>{$(j?.context?.trackedSeries?.length>0)}),[j]),(0,r.useEffect)((()=>{w.setComponents([{viewportId:E,id:"viewportStatusComponent",component:I({srDisplaySet:h,viewportId:E,isRehydratable:h.isRehydratable,isLocked:B,sendTrackedMeasurementsEvent:q,t:V}),indexPriority:-100,location:w.LOCATIONS.topLeft},{viewportId:E,id:"viewportActionArrowsComponent",index:0,component:r.createElement(c.PG,{key:"actionArrows",onArrowsClick:_}),indexPriority:0,location:w.LOCATIONS.topRight}])}),[B,_,q,h,V,w,E]);let Y=null;return U&&T?(t&&t.length&&(Y=t.map(((e,t)=>e&&r.cloneElement(e,{viewportId:E,key:t})))),r.createElement(r.Fragment,null,r.createElement("div",{className:"relative flex h-full w-full flex-row overflow-hidden"},J(),Y))):null}function I({srDisplaySet:e,viewportId:t,isRehydratable:n,isLocked:s,sendTrackedMeasurementsEvent:a,t:i}){const l=()=>{a("HYDRATE_SR",{displaySetInstanceUID:e.displaySetInstanceUID,viewportId:t})},o=i("LOAD"),u=n&&!s?3:n&&s?2:1;let d=null,p=null;switch(u){case 1:p=()=>r.createElement(c.JO,{name:"status-alert"}),d=()=>r.createElement("div",null,"This structured report is not compatible",r.createElement("br",null),"with this application.");break;case 2:p=()=>r.createElement(c.JO,{name:"status-locked"}),d=()=>r.createElement("div",null,"This structured report is currently read-only",r.createElement("br",null),"because you are tracking measurements in",r.createElement("br",null),"another viewport.");break;case 3:p=()=>r.createElement(c.JO,{className:"text-aqua-pale",name:"status-untracked"}),d=()=>r.createElement("div",null,`Click ${o} to restore measurements.`)}const m=()=>r.createElement("div",{className:"flex h-6 cursor-default text-sm leading-6 text-white"},r.createElement("div",{className:"bg-customgray-100 flex min-w-[45px] items-center rounded-l-xl rounded-r p-1"},r.createElement(p,null),r.createElement("span",{className:"ml-1"},"SR")),3===u&&r.createElement("div",{className:"bg-primary-main hover:bg-primary-light ml-1 cursor-pointer rounded px-1.5 hover:text-black",onMouseUp:l},o));return r.createElement(r.Fragment,null,d&&r.createElement(c.u,{content:r.createElement(d,null),position:"bottom-left"},r.createElement(m,null)),!d&&r.createElement(m,null))}S.propTypes={displaySets:a().arrayOf(a().object),viewportId:a().string.isRequired,dataSource:a().object,children:a().node,viewportLabel:a().string,viewportOptions:a().object,servicesManager:a().object.isRequired,extensionManager:a().instanceOf(l.W$).isRequired};const y=S}}]);
//# sourceMappingURL=5571.bundle.064000762974bc610d4c.js.map