(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[962],{73432:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>ne});const a=JSON.parse('{"u2":"@ohif/extension-cornerstone-dicom-seg"}').u2,o=`${a}.sopClassHandlerModule.dicom-seg`;var r=n(32735),i=n(92780),l=n(48501),s=n(22737);const{DicomMessage:c,DicomMetaDictionary:m}=s.default.data,p=["1.2.840.10008.5.1.4.1.1.66.4"];let d={};function u(e,t,n){const a=e[0],{StudyInstanceUID:r,SeriesInstanceUID:u,SOPInstanceUID:g,SeriesDescription:E,SeriesNumber:f,SeriesDate:S,SOPClassUID:x,wadoRoot:I,wadoUri:v,wadoUriRoot:h}=a,y={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:l.utils.guid(),SeriesDescription:E,SeriesNumber:f,SeriesDate:S,SOPInstanceUID:g,SeriesInstanceUID:u,StudyInstanceUID:r,SOPClassHandlerId:o,SOPClassUID:x,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:p,instance:a,instances:[a],wadoRoot:I,wadoUriRoot:h,wadoUri:v,isOverlayDisplaySet:!0},N=a.ReferencedSeriesSequence;if(!N)throw new Error("ReferencedSeriesSequence is missing for the SEG");const w=N[0];return y.referencedImages=a.ReferencedSeriesSequence.ReferencedInstanceSequence,y.referencedSeriesInstanceUID=w.SeriesInstanceUID,y.getReferenceDisplaySet=()=>{const{displaySetService:e}=t.services,n=e.getDisplaySetsForSeries(y.referencedSeriesInstanceUID);if(!n||0===n.length)throw new Error("Referenced DisplaySet is missing for the SEG");const a=n[0];y.referencedDisplaySetInstanceUID=a.displaySetInstanceUID,y.referencedVolumeURI=a.displaySetInstanceUID;const o=`cornerstoneStreamingImageVolume:${y.referencedVolumeURI}`;return y.referencedVolumeId=o,a},y.load=async e=>{let{headers:a}=e;return await function(e,t,n,a){const{SOPInstanceUID:o}=e,{segmentationService:r}=t.services;if((e.loading||e.isLoaded)&&d[o]&&function(e,t){return t.getSegmentation(e.displaySetInstanceUID)}(e,r))return d[o];return e.loading=!0,d[o]=new Promise((async(t,o)=>{if(!e.segments||0===Object.keys(e.segments).length){const t=await async function(e,t,n){const a=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{dicomLoaderService:o}=a.exports,r=await o.findDicomDataPromise(t,null,n),l=c.readFile(r),p=m.naturalizeDataset(l.dict);p._meta=m.namifyDataset(l.meta),Array.isArray(p.SegmentSequence)||(p.SegmentSequence=[p.SegmentSequence]);const d=function(e){const t={};return e.SegmentSequence.forEach((e=>{const n=e.RecommendedDisplayCIELabValue,a=s.default.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)));a.push(255);const o=e.SegmentNumber;t[o]={color:a,functionalGroups:[],offset:null,size:null,pixelData:null,label:e.SegmentLabel}})),e.PerFrameFunctionalGroupsSequence.forEach((e=>{const n=e.SegmentIdentificationSequence.ReferencedSegmentNumber;t[n].functionalGroups.push(e)})),function(e,t){let n=Math.ceil(e.Rows*e.Columns/8),a=0;return Object.keys(t).forEach((o=>{const r=t[o];r.numberOfFrames=r.functionalGroups.length,r.size=r.numberOfFrames*n,r.offset=a,a=r.offset+r.size;const l=e.PixelData[0].slice(r.offset,a);r.pixelData=s.default.data.BitArray.unpack(l),r.geometry=function(e,t){let n=e.SharedFunctionalGroupsSequence.PixelMeasuresSequence,a=e.SharedFunctionalGroupsSequence.PlaneOrientationSequence,o=t[0].PlanePositionSequence;const r={};let l=n.SpacingBetweenSlices;l||n.SliceThickness&&(console.log("Using SliceThickness as SpacingBetweenSlices"),l=n.SliceThickness);r.spacing=[n.PixelSpacing[1],n.PixelSpacing[0],l].map(Number),r.dimensions=[e.Columns,e.Rows,t.length].map(Number);let s=a.ImageOrientationPatient.map(Number);const c=s.slice(0,3),m=s.slice(3,6);r.planeNormal=[],i.default.cross(c,m,r.planeNormal);let p=t[0].PlanePositionSequence.ImagePositionPatient.map(Number),d=t[t.length-1].PlanePositionSequence.ImagePositionPatient.map(Number);return r.sliceStep=[],i.default.subtract(d,p,r.sliceStep),i.default.normalize(r.sliceStep),r.direction=c.concat(m).concat(r.sliceStep),r.origin=o.ImagePositionPatient.map(Number),r}(e,r.functionalGroups)})),t}(e,t)}(p);return d}(n,e,a);e.segments=t}const l=!0;r.createSegmentationForSEGDisplaySet(e,null,l).then((()=>{e.loading=!1,t()})).catch((t=>{e.loading=!1,o(t)}))})),d[o]}(y,t,n,a)},[y]}const g=function(e){let{servicesManager:t,extensionManager:n}=e;return[{name:"dicom-seg",sopClassUids:p,getDisplaySetsFromSeries:e=>u(e,t,n)}]};var E=n(60216),f=n.n(E),S=n(22605);const x=function(e,t,n){const a="enter-segment-label",o=t=>{let{action:o,value:r}=t;switch(o.id){case"save":n(r.label,o.id);break;case"cancel":n("",o.id)}e.dismiss({id:a})};e&&e.create({id:a,centralize:!0,isDraggable:!1,showOverlay:!0,content:S.Vq,contentProps:{title:"Segment",value:{label:t},noCloseButton:!0,onClose:()=>e.dismiss({id:a}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Confirm",type:"secondary"}],onSubmit:o,body:e=>{let{value:t,setValue:n}=e;return r.createElement(S.II,{label:"Enter the segment label",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,className:"bg-black border-primary-main",type:"text",value:t.label,onChange:e=>{e.persist(),n((t=>({...t,label:e.target.value})))},onKeyPress:e=>{"Enter"===e.key&&o({value:t,action:{id:"save"}})}})}}})};var I=n(29905),v=n(40841),h=n.n(v),y=n(96665),N=n(20777),w=n(81122);const C=e=>{let{value1:t,value2:n,onChange:a,minValue:o,maxValue:i,step:l=1,unit:s="",containerClassName:c,inputClassName:m,labelClassName:p,labelVariant:d,showLabel:u=!0,labelPosition:g="",trackColor:E}=e;const[f,x]=(0,r.useState)(t),[I,v]=(0,r.useState)(n),y=e=>{const t=Number(e.target.value);t<o||(x(t),t>=I&&v(t),a(t,I))},N=e=>{const t=Number(e.target.value);t>i||(v(t),t<=f&&x(t),a(f,t))},C=l>=1?f.toFixed(0):f.toFixed(1),b=l>=1?I.toFixed(0):I.toFixed(1);return r.createElement("div",{style:{flexDirection:"column"},className:`flex items-center cursor-pointer space-x-1 ${c||""}`},u&&"left"===g&&r.createElement(r.Fragment,null,r.createElement(w.Z,{variant:d??"subtitle",component:"p",className:h()("w-8",p??"text-white")},C,s),r.createElement(w.Z,{variant:d??"subtitle",component:"p",className:h()("w-8",p??"text-white")},b,s)),r.createElement("div",{style:{flexDirection:"row"},className:"flex pb-[5px]"},r.createElement("input",{type:"range",min:o,max:I,value:f,className:`appearance-none h-[3px] rounded-lg input-range-thumb-design ${m||""}`,style:{background:"#3a3f99"},onChange:y,id:"myRange1",step:l}),r.createElement("input",{type:"range",min:f,max:i,value:I,className:`appearance-none h-[3px] rounded-lg input-range-thumb-design ${m||""}`,style:{background:"#3a3f99"},onChange:N,id:"myRange2",step:l})),u&&(!g||"right"===g)&&r.createElement("div",{style:{flexDirection:"row",width:"100%"},className:"flex pb-[5px]"},r.createElement(w.Z,{variant:d??"subtitle",component:"p",className:h()("w-1/2",p??"text-white","flex","justify-center")},"Min : ",C,s),r.createElement(w.Z,{variant:d??"subtitle",component:"p",className:h()("w-1/2",p??"text-white","flex","justify-center")},"Max : ",b,s)),r.createElement("div",{className:"flex",style:{width:"100%"}},r.createElement("div",{className:"flex w-1/2 justify-center"},r.createElement(S.zx,{size:"small",color:"black",onClick:()=>{y({target:{value:f-10}})}},"--"),r.createElement(S.zx,{size:"small",color:"black",onClick:()=>{y({target:{value:f-1}})}},"-"),r.createElement(S.zx,{size:"small",color:"black",onClick:()=>{y({target:{value:f+1}})}},"+"),r.createElement(S.zx,{size:"small",color:"black",onClick:()=>{y({target:{value:f+10}})}},"++")),r.createElement("div",{className:"flex w-1/2 justify-center"},r.createElement(S.zx,{size:"small",color:"black",onClick:()=>{N({target:{value:I-10}})}},"--"),r.createElement(S.zx,{size:"small",color:"black",onClick:()=>{N({target:{value:I-1}})}},"-"),r.createElement(S.zx,{size:"small",color:"black",onClick:()=>{N({target:{value:I+1}})}},"+"),r.createElement(S.zx,{size:"small",color:"black",onClick:()=>{N({target:{value:I+10}})}},"++"))))};var b=function(e){return e.FILL_INSIDE_CIRCLE="FILL_INSIDE_CIRCLE",e.THRESHOLD_INSIDE_CIRCLE="THRESHOLD_INSIDE_CIRCLE",e.THRESHOLD_INSIDE_SPHERE="THRESHOLD_INSIDE_SPHERE",e.ERASE_INSIDE_CIRCLE="ERASE_INSIDE_CIRCLE",e.FILL_INSIDE_SPHERE="FILL_INSIDE_SPHERE",e.ERASE_INSIDE_SPHERE="ERASE_INSIDE_SPHERE",e}(b||{});function D(e){let{cornerstoneViewportService:t}=e;const[n,a]=(0,r.useState)(!1),[{activeViewportIndex:o,viewports:i},l]=(0,S.O_)(),[s,c]=(0,r.useState)(b.FILL_INSIDE_CIRCLE),[m,p]=(0,r.useState)(25),[d,u]=(0,r.useState)([-1e3,5e3]);return(0,r.useEffect)((()=>{const e=I.ToolGroupManager.getToolGroupForViewport(t.getCornerstoneViewportByIndex(o).id,t.getCornerstoneViewportByIndex(o).renderingEngineId).getToolInstance("Brush");c(e.configuration.activeStrategy),p(e.configuration.brushSize),u(e.configuration.strategySpecificConfiguration.THRESHOLD_INSIDE_CIRCLE.threshold)}),[]),(0,r.useEffect)((()=>{I.ToolGroupManager.getToolGroupForViewport(t.getCornerstoneViewportByIndex(o).id,t.getCornerstoneViewportByIndex(o).renderingEngineId).getToolInstance("Brush").setConfiguration({brushSize:m,activeStrategy:s,strategySpecificConfiguration:{THRESHOLD_INSIDE_CIRCLE:{threshold:d}}})}),[m,s,d]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),a(!n)}},r.createElement(y.Z,{name:"panel-group-open-close",className:h()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!n})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Paint Brush Tool Edit")),!n&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Filling mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(S.zx,{fullWidth:!0,size:"small",color:s===b.FILL_INSIDE_CIRCLE?"primary":"secondary",onClick:()=>{c(b.FILL_INSIDE_CIRCLE)}},"Circle"),r.createElement(S.zx,{fullWidth:!0,size:"small",color:s===b.THRESHOLD_INSIDE_CIRCLE?"primary":"secondary",onClick:()=>{c(b.THRESHOLD_INSIDE_CIRCLE)}},"Circle Threshold")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(S.zx,{fullWidth:!0,size:"small",color:s===b.FILL_INSIDE_SPHERE?"primary":"secondary",onClick:()=>{c(b.FILL_INSIDE_SPHERE)}},"Sphere"),r.createElement(S.zx,{fullWidth:!0,size:"small",color:s===b.THRESHOLD_INSIDE_SPHERE?"primary":"secondary",onClick:()=>{c(b.THRESHOLD_INSIDE_SPHERE)}},"Sphere Threshold")),r.createElement("div",{className:"h-[1px] bg-[#212456] mb-[8px] mx-1"}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Erase mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(S.zx,{fullWidth:!0,size:"small",color:s===b.ERASE_INSIDE_CIRCLE?"primary":"secondary",onClick:()=>{c(b.ERASE_INSIDE_CIRCLE)}},"Circle"),r.createElement(S.zx,{fullWidth:!0,size:"small",color:s===b.ERASE_INSIDE_SPHERE?"primary":"secondary",onClick:()=>{c(b.ERASE_INSIDE_SPHERE)}},"Sphere")),r.createElement("div",{className:"h-[1px] bg-[#212456] mb-[8px] mx-1"}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Attributes"),r.createElement("div",{className:"flex items-center col-span-2"},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]"},"Radius"),r.createElement(N.Z,{minValue:0,maxValue:100,value:m,onChange:e=>{p(e)},step:1,containerClassName:"mt-[4px] mb-[4px]",inputClassName:"w-[64px]",labelClassName:"text-white text-[12px]",unit:"px"})),(s===b.THRESHOLD_INSIDE_CIRCLE||s===b.THRESHOLD_INSIDE_SPHERE)&&r.createElement("div",{className:"flex items-center col-span-2",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Threshold values"),r.createElement(C,{minValue:-1e3,maxValue:5e3,value1:d[0],value2:d[1],onChange:(e,t)=>{u([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:""}))),r.createElement("div",{className:"h-[6px] bg-black "})))}var R=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(R||{});function T(e){let{cornerstoneViewportService:t}=e;const[n,a]=(0,r.useState)(!1),[o,i]=(0,r.useState)(R.FILL_INSIDE),[{activeViewportIndex:l,viewports:s},c]=(0,S.O_)();return(0,r.useEffect)((()=>{const e=I.ToolGroupManager.getToolGroupForViewport(t.getCornerstoneViewportByIndex(l).id,t.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("CircleScissor");i(e.configuration.activeStrategy)}),[]),(0,r.useEffect)((()=>{I.ToolGroupManager.getToolGroupForViewport(t.getCornerstoneViewportByIndex(l).id,t.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("CircleScissor").setConfiguration({activeStrategy:o})}),[o]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),a(!n)}},r.createElement(y.Z,{name:"panel-group-open-close",className:h()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!n})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Circle Segmentation Tool Edit")),!n&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(S.zx,{fullWidth:!0,size:"small",color:o===R.FILL_INSIDE?"primary":"secondary",onClick:()=>{i(R.FILL_INSIDE)}},"Fill"),r.createElement(S.zx,{fullWidth:!0,size:"small",color:o===R.ERASE_INSIDE?"primary":"secondary",onClick:()=>{i(R.ERASE_INSIDE)}},"Erase"))),r.createElement("div",{className:"h-[6px] bg-black "})))}function _(e){let{}=e;const[t,n]=(0,r.useState)(!1);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),n(!t)}},r.createElement(y.Z,{name:"panel-group-open-close",className:h()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!t})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Fill Holes Tool Edit")),!t&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"No configurations for this tool")),r.createElement("div",{className:"h-[6px] bg-black "})))}var V=n(36791);function O(e){let{segmentationService:t,cornerstoneViewportService:n,commandsManager:a}=e;const[o,i]=(0,r.useState)(!1),[{activeViewportIndex:l,viewports:s},c]=(0,S.O_)(),[m,p]=(0,r.useState)([-1e3,5e3]),[d,u]=(0,r.useState)(0);(0,r.useEffect)((()=>{const e=I.ToolGroupManager.getToolGroupForViewport(n.getCornerstoneViewportByIndex(l).id,n.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("RectangleROIStartEndThreshold");u(e.configuration.numSlicesToPropagate)}),[]),(0,r.useEffect)((()=>{I.ToolGroupManager.getToolGroupForViewport(n.getCornerstoneViewportByIndex(l).id,n.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("RectangleROIStartEndThreshold").setConfiguration({numSlicesToPropagate:d})}),[d]);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),i(!o)}},r.createElement(y.Z,{name:"panel-group-open-close",className:h()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"3D Rectangle Threshold Segmentation Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"flex items-center col-span-2",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Threshold values"),r.createElement(C,{minValue:-1e3,maxValue:5e3,value1:m[0],value2:m[1],onChange:(e,t)=>{p([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:""})),r.createElement("div",{className:"flex items-center col-span-2",style:{width:"100%",flexDirection:"column"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px]",style:{width:"100%"}},"Slices Propagation"),r.createElement(N.Z,{minValue:0,maxValue:200,value:d,onChange:e=>{u(e)},step:1,containerClassName:"mt-[4px] mb-[4px] w-full",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:""})),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(S.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const e=n.getCornerstoneViewportByIndex(l).getActors().map((e=>{const t=e.referenceId??e.uid;return V.cache.getVolume(t)})).filter((e=>!!e)),a=I.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIStartEndThreshold");if(!a)throw new Error("No annotation selected ");const o=a[0];if(!I.annotation.state.getAnnotation(o))return;const r=e.filter((e=>e.imageIds))[0],i=e.filter((e=>!e.imageIds))[0],s=t.getSegmentations();I.utilities.segmentation.rectangleROIThresholdVolumeByRange(a,i,[{volume:r,lower:m[0],upper:m[1]}],{numSlicesToProject:0,overwrite:!1,overlapType:1,segmentIndex:s[0].activeSegmentIndex})})()}},"Compute Threshold")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(S.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const e=I.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIStartEndThreshold");if(!e)throw new Error("No annotation selected ");console.log("selected annotation uid",e);const t=e[0];console.log("CSTOOLS STATE",I.annotation.state),I.annotation.state.removeAnnotation(t),n.getCornerstoneViewportByIndex(l).render()})()}},"Delete selected region"))),r.createElement("div",{className:"h-[6px] bg-black "})))}function L(e){let{segmentationService:t,cornerstoneViewportService:n,commandsManager:a}=e;const[o,i]=(0,r.useState)(!1),[{activeViewportIndex:l,viewports:s},c]=(0,S.O_)(),[m,p]=(0,r.useState)([-1e3,5e3]);return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),i(!o)}},r.createElement(y.Z,{name:"panel-group-open-close",className:h()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!o})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Rectangle Threshold Segmentation Tool Edit")),!o&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"flex items-center col-span-2 pb-[9px]",style:{flexDirection:"column",width:"100%"}},r.createElement("div",{className:"text-[#ffffff] text-[12px] pr-[9px] pb-[3px]",style:{width:"100%"}},"Threshold values"),r.createElement(C,{minValue:-1e3,maxValue:5e3,value1:m[0],value2:m[1],onChange:(e,t)=>{p([e,t])},step:5,containerClassName:"mt-[4px] mb-[4px] w-full pb-[3px]",inputClassName:"w-full",labelClassName:"text-white text-[12px] w-full",unit:"HU"})),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(S.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const e=n.getCornerstoneViewportByIndex(l).getActors().map((e=>{const t=e.referenceId??e.uid;return V.cache.getVolume(t)})).filter((e=>!!e)),a=I.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIThreshold");if(!a)throw new Error("No annotation selected ");const o=a[0];if(!I.annotation.state.getAnnotation(o))return;const r=e.filter((e=>e.imageIds))[0],i=e.filter((e=>!e.imageIds))[0],s=t.getSegmentations();console.log("SEGMENTATION",s),I.utilities.segmentation.rectangleROIThresholdVolumeByRange(a,i,[{volume:r,lower:m[0],upper:m[1]}],{numSlicesToProject:0,overwrite:!1,overlapType:1,segmentIndex:s[0].activeSegmentIndex})})()}},"Compute Threshold")),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(S.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{(()=>{const e=I.annotation.selection.getAnnotationsSelectedByToolName("RectangleROIThreshold");if(!e)throw new Error("No annotation selected ");console.log("selected annotation uid",e);const t=e[0];console.log("CSTOOLS STATE",I.annotation.state),I.annotation.state.removeAnnotation(t),n.getCornerstoneViewportByIndex(l).render()})()}},"Delete selected region"))),r.createElement("div",{className:"h-[6px] bg-black "})))}var k=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(k||{});function A(e){let{cornerstoneViewportService:t}=e;const[n,a]=(0,r.useState)(!1),[o,i]=(0,r.useState)(k.FILL_INSIDE),[{activeViewportIndex:l,viewports:s},c]=(0,S.O_)();return(0,r.useEffect)((()=>{const e=I.ToolGroupManager.getToolGroupForViewport(t.getCornerstoneViewportByIndex(l).id,t.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("RectangleScissor");i(e.configuration.activeStrategy)}),[]),(0,r.useEffect)((()=>{I.ToolGroupManager.getToolGroupForViewport(t.getCornerstoneViewportByIndex(l).id,t.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("RectangleScissor").setConfiguration({activeStrategy:o})}),[o]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),a(!n)}},r.createElement(y.Z,{name:"panel-group-open-close",className:h()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!n})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Rectangle Scissors Tool Edit")),!n&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(S.zx,{fullWidth:!0,size:"small",color:o===k.FILL_INSIDE?"primary":"secondary",onClick:()=>{i(k.FILL_INSIDE)}},"Fill"),r.createElement(S.zx,{fullWidth:!0,size:"small",color:o===k.ERASE_INSIDE?"primary":"secondary",onClick:()=>{i(k.ERASE_INSIDE)}},"Erase"))),r.createElement("div",{className:"h-[6px] bg-black "})))}var F=function(e){return e.FILL_INSIDE="FILL_INSIDE",e.ERASE_INSIDE="ERASE_INSIDE",e}(F||{});function P(e){let{cornerstoneViewportService:t}=e;const[n,a]=(0,r.useState)(!1),[o,i]=(0,r.useState)(F.FILL_INSIDE),[{activeViewportIndex:l,viewports:s},c]=(0,S.O_)();return(0,r.useEffect)((()=>{const e=I.ToolGroupManager.getToolGroupForViewport(t.getCornerstoneViewportByIndex(l).id,t.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("SphereScissor");i(e.configuration.activeStrategy)}),[]),(0,r.useEffect)((()=>{I.ToolGroupManager.getToolGroupForViewport(t.getCornerstoneViewportByIndex(l).id,t.getCornerstoneViewportByIndex(l).renderingEngineId).getToolInstance("SphereScissor").setConfiguration({activeStrategy:o})}),[o]),r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),a(!n)}},r.createElement(y.Z,{name:"panel-group-open-close",className:h()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!n})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Sphere Scissors Tool Edit")),!n&&r.createElement("div",{className:"pl-2 pb-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]"},"Mode"),r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] pb-[9px]",style:{display:"inline-flex",justifyContent:"space-evenly"}},r.createElement(S.zx,{fullWidth:!0,size:"small",color:o===F.FILL_INSIDE?"primary":"secondary",onClick:()=>{i(F.FILL_INSIDE)}},"Fill"),r.createElement(S.zx,{fullWidth:!0,size:"small",color:o===F.ERASE_INSIDE?"primary":"secondary",onClick:()=>{i(F.ERASE_INSIDE)}},"Erase"))),r.createElement("div",{className:"h-[6px] bg-black "})))}const M=["Brush","CircleScissor","PaintFill","RectangleROIStartEndThreshold","RectangleROIThreshold","RectangleScissor","SphereScissor"];function z(e){let{segmentationService:t,toolbarService:n,toolGroupService:a,cornerstoneViewportService:o,commandsManager:i}=e;const[{activeViewportIndex:l,viewports:s},c]=(0,S.O_)(),[m,p]=(0,r.useState)(null),d=()=>{const e=o.getCornerstoneViewportByIndex(l).id,t=a.getToolGroupForViewport(e).toolOptions,n=Object.keys(t).map((function(e){return[e,t[e]]}));let r=!1;n.forEach((e=>{if(M.includes(e[0])&&"Active"===e[1].mode)return r=!0,void p(e[0])})),r||p(null)};(0,r.useEffect)((()=>{d()}),[]),(0,r.useEffect)((()=>{const{unsubscribe:e}=n.subscribe(n.EVENTS.TOOL_BAR_STATE_MODIFIED,d);return()=>{e()}}),[n]);return(()=>{switch(m){case"Brush":return r.createElement(D,{cornerstoneViewportService:o});case"CircleScissor":return r.createElement(T,{cornerstoneViewportService:o});case"PaintFill":return r.createElement(_,null);case"RectangleROIStartEndThreshold":return r.createElement(O,{segmentationService:t,cornerstoneViewportService:o,commandsManager:i});case"RectangleROIThreshold":return r.createElement(L,{segmentationService:t,cornerstoneViewportService:o,commandsManager:i});case"RectangleScissor":return r.createElement(A,{cornerstoneViewportService:o});case"SphereScissor":return r.createElement(P,{cornerstoneViewportService:o});default:return null}})()}var G=n(45546);function B(e){let{segmentationService:t,segmentations:n}=e;const[a,o]=(0,r.useState)(!1),[{activeViewportIndex:i,viewports:l},s]=(0,S.O_)();return r.createElement("div",{className:"flex flex-col min-h-0 font-inter font-[300]"},r.createElement("div",{className:"bg-primary-dark"},r.createElement("div",{className:"flex cursor-pointer items-center",onClick:e=>{e.stopPropagation(),o(!a)}},r.createElement(S.JO,{name:"panel-group-open-close",className:h()("w-5 h-5 text-white transition duration-300 cursor-pointer",{"transform rotate-90":!a})}),r.createElement("span",{className:"text-[#d8d8d8] text-[12px] font-[300]"},"Segments Configuration I/O")),!a&&r.createElement("div",{className:"pl-2 pb-[9px] pt-[9px]",style:{display:"flex",flexDirection:"column"}},r.createElement("div",{className:"text-[#d8d8d8] text-[12px] font-[300] justify-evenly flex"},r.createElement(S.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{console.log("SEGS AT IMPORT",n);const e=document.createElement("input");e.type="file",e.accept="application/json",e.onchange=a=>{const o=Array.from(e.files)[0],r=new FileReader;r.onload=function(e){try{if("string"==typeof e.target.result){for(let e=1;e<n[0].segments.length;e++)t.removeSegment(n[0].id,e);JSON.parse(e.target.result).forEach((e=>{if(e){const{segmentIndex:a}=e;t.addSegment(n[0].id,a,l[i].viewportOptions.toolGroupId,e,!0)}}))}else console.error("ERROR::JSON_READING::CORRUPTED_CONTENT")}catch(e){console.error("ERROR::JSON_READING",e)}},r.readAsText(o)},e.click()}},"Import File"),r.createElement(S.zx,{fullWidth:!0,size:"small",color:"secondary",onClick:()=>{const e=JSON.stringify(n[0].segments),t=new Blob([e],{type:"text/plain;charset=utf-8"});(0,G.saveAs)(t,"segments_configuration.json")}},"Export File"))),r.createElement("div",{className:"h-[6px] bg-black "})))}B.propTypes={segmentations:f().array.isRequired};const H=B;var U=n(62467),q=n.n(U),j=n(22148);function W(e){let{segmentationService:t,segmentations:n}=e;const[a,o]=(0,r.useState)(!1),[i,l]=(0,r.useState)(0);(0,r.useEffect)((()=>{a&&(l(0),setTimeout(s,500))}),[a]);const s=()=>{const e=t.getLabelmapVolume(n[0].id),{dimensions:a,direction:r,scalarData:i}=e,s=n[0].segments,c=s.map(((e,t)=>{if(e)return t})).filter((e=>e)),m=new Uint32Array(i);console.log("START COMPUTING INDEX ARRAY...");const p=new Array(a[0]-1);for(let e=0;e<m.length;e+=a[1]*a[2]){const t=e/(a[1]*a[2]),n=new Uint8ClampedArray(a[1]*a[2]*4).fill(0).map(((e,t)=>(t-3)%4==0?255:e)),o=m.slice(e,e+a[1]*a[2]);Promise.allSettled(c.map((e=>(e=>o.map(((t,n)=>{if(0!==t&&t===e)return n})).filter((e=>0!==e)))(e)))).then((e=>{e.forEach(((e,t)=>{const a=e.value;if(0!==a.length){const e=c[t],o=[...s[e].color,255];a.forEach((e=>{n[4*e]=o[0],n[4*e+1]=o[1],n[4*e+2]=o[2]}))}}));new Promise(((e,o)=>{const r=document.createElement("canvas"),i=r.getContext("2d");r.width=a[1],r.height=a[2];const l=new ImageData(n,a[1],a[2]);i.putImageData(l,0,0),r.toBlob((n=>{n&&(p[t]=n,e())}),"image/png")})).then((()=>{const e=p.filter((e=>e)).length;l(~~(100*e/a[0]))}))}))}new Promise(((e,t)=>{!function t(){if(p.filter((e=>e)).length===a[0])return e();setTimeout(t,500)}()})).then((()=>{const e=new(q());p.forEach(((t,n)=>{e.file(`layer_${n}.png`,t)}));const t=JSON.stringify(n[0].segments,null,"\t"),a=new Blob([t],{type:"text/plain;charset=utf-8"});e.file("segmentation_informations.json",a),e.generateAsync({type:"blob"}).then((e=>{(0,G.saveAs)(e,"segmentation.zip"),o(!1)}))}))};return r.createElement("div",{className:"flex flex-col w-full h-74 justify-between"},r.createElement(S.zx,{className:"pt-1/10 pb-1/10 w-full",onClick:()=>{o(!0)}},"Export Segmentation"),a&&r.createElement("div",{className:"w-full mt-[9px]"},r.createElement("p",{style:{color:"white"}},"Processing layers..."),r.createElement(j.Z,{className:"w-full mt-[3px]",bgColor:i<100?"#5ACCE6":"#50C878",completed:i,transitionDuration:"0.05s",transitionTimingFunction:"linear"})))}W.propTypes={segmentations:f().array.isRequired};const Z=W;var $=n(21572);const J=I.Enums.SegmentationRepresentations.Labelmap;function X(e){let{servicesManager:t,commandsManager:n}=e;const[{activeViewportIndex:a,viewports:o},i]=(0,S.O_)(),{segmentationService:l,uiDialogService:s,cornerstoneViewportService:c,toolGroupService:m,toolbarService:p,uiNotificationService:d}=t.services,{t:u}=(0,$.$G)("PanelSegmentation"),[g,E]=(0,r.useState)(null),[f,I]=(0,r.useState)(l.getConfiguration()),[v,h]=(0,r.useState)((()=>l.getSegmentations())),[y,N]=(0,r.useState)({}),w=(0,r.useCallback)((e=>{N((t=>({...t,[e]:!t[e]})))}),[N]);(0,r.useEffect)((()=>{const e=v[v.length-1]?.id;e&&N((t=>({...t,[e]:!1})))}),[v,N]),(0,r.useEffect)((()=>{const e=l.EVENTS.SEGMENTATION_ADDED,t=l.EVENTS.SEGMENTATION_UPDATED,n=l.EVENTS.SEGMENTATION_REMOVED,a=[];return[e,t,n].forEach((e=>{const{unsubscribe:t}=l.subscribe(e,(()=>{const e=l.getSegmentations();h(e),I(l.getConfiguration())}));a.push(t)})),()=>{a.forEach((e=>{e()}))}}),[]);const C=e=>l.getToolGroupIdsWithSegmentation(e),b=(0,r.useCallback)(((e,t,n)=>{l.setConfiguration({segmentationId:e,[t]:n})}),[l]);return r.createElement("div",{className:"flex flex-col flex-auto min-h-0F mt-1"},r.createElement(z,{segmentationService:l,cornerstoneViewportService:c,toolGroupService:m,toolbarService:p,commandsManager:n}),v?.length&&r.createElement(H,{segmentationService:l,segmentations:v}),v?.length?r.createElement(S.cX,{title:u("Segmentations"),showAddSegment:!0,segmentations:v,isMinimized:y,activeSegmentationId:g||"",onSegmentationClick:e=>{l.setActiveSegmentationForToolGroup(e)},onSegmentationDelete:e=>{l.remove(e)},onSegmentationEdit:e=>{const t=l.getSegmentation(e),{label:n}=t;x(s,n,((t,n)=>{""!==t&&l.addOrUpdateSegmentation({id:e,label:t},!1,!0)}))},onSegmentClick:(e,t)=>{l.setActiveSegmentForSegmentation(e,t);C(e).forEach((n=>{l.setActiveSegmentationForToolGroup(e,n),l.jumpToSegmentCenter(e,t,n)}))},onSegmentEdit:(e,t)=>{const n=l.getSegmentation(e).segments[t],{label:a}=n;x(s,a,((n,a)=>{""!==n&&l.setSegmentLabelForSegmentation(e,t,n)}))},onSegmentAdd:e=>{const t=l.getSegmentation(e);l.addSegment(e,t.segments.length,o[a].viewportOptions.toolGroupId,{label:`Segmentation ${t.segmentCount+1}`,color:[Math.floor(256*Math.random()),Math.floor(256*Math.random()),Math.floor(256*Math.random())],opacity:255,visibility:!0,isLocked:!1,active:!0})},onSegmentColorChange:(e,t,n)=>{l.setSegmentColor(e,t,n,o[a].viewportOptions.toolGroupId)},onSegmentDelete:(e,t)=>{l.removeSegment(e,t)},onToggleSegmentVisibility:(e,t)=>{const n=!l.getSegmentation(e).segments[t].isVisible;C(e).forEach((a=>{l.setSegmentVisibility(e,t,n,a)}))},onToggleSegmentationVisibility:e=>{l.toggleSegmentationVisibility(e)},onToggleMinimizeSegmentation:w,segmentationConfig:{initialConfig:f},setRenderOutline:e=>b(g,"renderOutline",e),setOutlineOpacityActive:e=>b(g,"outlineOpacity",e),setRenderFill:e=>b(g,"renderFill",e),setRenderInactiveSegmentations:e=>b(g,"renderInactiveSegmentations",e),setOutlineWidthActive:e=>b(g,"outlineWidthActive",e),setFillAlpha:e=>b(g,"fillAlpha",e),setFillAlphaInactive:e=>b(g,"fillAlphaInactive",e)}):null,v.length?r.createElement(Z,{segmentationService:l,segmentations:v}):r.createElement(S.zx,{className:"pt-1/10 pb-1/10",onClick:()=>{o.forEach((e=>{if(e.viewportIndex===a){if("volume3d"===e.viewportOptions.viewportType)return void d.show({title:"Create Segmentation",message:"Can't create segmentation in viewport 3D, select a 2D viewport",type:"error"});console.log("SEG VP",e),l.createSegmentationForDisplaySet(e.displaySetInstanceUIDs[0]).then((t=>{const n=l.getSegmentation(t);console.log("CREATED SEGMENTATION",n),l.addSegmentationRepresentationToToolGroup(e.viewportOptions.toolGroupId,t,!0,J).then((()=>{l.setActiveSegmentationForToolGroup(t,e.viewportOptions.toolGroupId),l.addSegment(t,1,o[a].viewportOptions.toolGroupId,{label:"Segmentation 1",color:[255,0,0],opacity:255,visibility:!0,isLocked:!1,active:!0})}))}))}}))}},"Create Segmentation For Selected Viewport"))}X.propTypes={commandsManager:f().shape({runCommand:f().func.isRequired}),servicesManager:f().shape({services:f().shape({segmentationService:f().shape({getSegmentation:f().func.isRequired,getSegmentations:f().func.isRequired,toggleSegmentationVisibility:f().func.isRequired,subscribe:f().func.isRequired,EVENTS:f().object.isRequired}).isRequired}).isRequired}).isRequired};const K={id:"@ohif/seg",hasUpdatedPriorsInformation:!1,name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId"}]}]}]};const Y=function(){return[{name:K.id,protocol:K}]};function Q(){return Q=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},Q.apply(this,arguments)}const ee=r.lazy((()=>n.e(569).then(n.bind(n,33569)))),te=e=>r.createElement(r.Suspense,{fallback:r.createElement("div",null,"Loading...")},r.createElement(ee,e)),ne={id:a,getPanelModule:e=>{let{servicesManager:t,commandsManager:n,extensionManager:a}=e;return[{name:"panelSegmentation",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:()=>r.createElement(X,{commandsManager:n,servicesManager:t,extensionManager:a})}]},getViewportModule(e){let{servicesManager:t,extensionManager:n}=e;return[{name:"dicom-seg",component:e=>r.createElement(te,Q({servicesManager:t,extensionManager:n},e))}]},getSopClassHandlerModule:g,getHangingProtocolModule:Y}},78753:()=>{}}]);
//# sourceMappingURL=962.bundle.32ea89e7d94d791dd9de.js.map